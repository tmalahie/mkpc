var pause,chatting=!1,aPlayers=new Array,aPlaces=new Array,aScores=new Array,aTeams=new Array,aPseudos=new Array,aControllers=new Array,aTracksHist=new Array,iRaceCount=0,fInfos,formulaire,baseCp,baseCp0,pUnlockMap,customDecorData={},customBgData={},nBasePersos,customPersos,selectedDifficulty,updateCtnFullScreen,isFirstLoad=!0,selectedCc=localStorage.getItem("cc")||"150",selectedMirror=!!localStorage.getItem("mirror"),selectedNbTeams=localStorage.getItem("nbTeams")||"2",selectedFriendlyFire=!!localStorage.getItem("friendlyFire"),selectedTeamOpts=0,selectedDoubleItems=0!=localStorage.getItem("doubleitems"),edittingCircuit,dCircuits;if(void 0===edittingCircuit&&(edittingCircuit=!1),void 0===cupOpts)var cupOpts={};else if(cupOpts.keyid){try{cupOpts=JSON.parse(sessionStorage.getItem("cupopt."+cupOpts.keyid))}catch(e){}cupOpts=cupOpts||{}}void 0===dCircuits&&(dCircuits=lCircuits);var isOnline="OL"==page,isMCups=isCup&&4<NBCIRCUITS,clRuleVars={},clGlobalVars,selectPerso,selectedTeams,challenges,clRewards,cupPayloads;function xhr(t,n,a,o){var i;if(o=o||1e3,window.XMLHttpRequest||window.ActiveXObject)if(window.ActiveXObject)try{i=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){i=new ActiveXObject("Microsoft.XMLHTTP")}else i=new XMLHttpRequest;i.open("POST","api/"+t,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("If-Modified-Since","Wed, 15 Nov 1995 00:00:00 GMT");try{i.onload=function(){200==i.status?a(i.responseText)||setTimeout(function(){xhr(t,n,a,2*o)},o):i.onerror()},i.onerror=function(){setTimeout(function(){xhr(t,n,a,2*o)},o)}}catch(e){i.onreadystatechange=function(){4!=i.readyState||a(i.responseText)||setTimeout(function(){xhr(t,n,a,2*o)},o)}}i.send(n)}void 0===selectedTeams&&(selectedTeams=0),void 0===challenges&&(challenges={mcup:[],cup:[],track:[]},clRewards=[]),void 0===cupPayloads&&(cupPayloads=[]);var cupIDs=cupPayloads.map(function(e){return e.id}),challengesForCircuit,onlineSpectatorId,gamepadMenuEventsHandler,updateVolumeSettings;function MarioKart(){var oMaps=listMaps(),aAvailableMaps=new Array;for(circuits in void 0===Array.isArray&&(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),oMaps){aAvailableMaps.push(circuits);var oMap=oMaps[circuits];oMap.w||(oMap.w=512),oMap.h||(oMap.h=512),oMap.tours||(oMap.tours=3),isCup||oMap.ext||(oMap.ext="png"),oMap.ref=+circuits.replace("map",""),oMap.aipoints&&oMap.aipoints[0]&&oMap.aipoints[0].length&&!Array.isArray(oMap.aipoints[0][0])&&(oMap.aipoints=[oMap.aipoints]),oMap.horspistes||(oMap.horspistes={},oMap.horspiste&&(oMap.horspistes.herbe=oMap.horspiste,delete oMap.horspiste))}isCup&&4<aAvailableMaps.length&&(isMCups=!0);var iWidth=80,iHeight=39,SPF=67,iRendering=baseOptions.quality,iQuality,iSmooth;resetQuality();var bMusic=!!optionOf("music"),iSfx=!!optionOf("sfx"),iFps=+localStorage.getItem("nbFrames")||1,vSfx=1,vMusic=1,vSettings=localStorage.getItem("settings.vol"),gameMenu;vSettings&&(vSettings=JSON.parse(vSettings),null!=vSettings.sfx&&(vSfx=vSettings.sfx),null!=vSettings.music&&(vMusic=vSettings.music));var primaryColor="#FEFF3F",refreshDatas=isOnline,finishing=!1,connecte=1,aIDs=new Array,tnCourse=0,identifiant;"undefined"!=typeof mId&&(identifiant=mId),"undefined"==typeof cShared&&(cShared="AR"==page&&0<nid),"undefined"!=typeof shareLink&&shareLink.options&&shareLink.options.team&&(selectedTeams=1);var $changeRace=document.getElementById("changeRace"),myCircuit=!(null==$changeRace||$changeRace.dataset&&$changeRace.dataset.collab);function setQuality(e){iRendering=e,baseOptions.quality=e,resetQuality(),5==iQuality?localStorage.removeItem("iQuality"):localStorage.setItem("iQuality",e)}function resetQuality(){iSmooth=5==iRendering?!(iQuality=1):(iQuality=iRendering,!0)}function setFps(e){if(-2==e){formulaire.fps.value=iFps;var t=document.createElement("div");t.className="customOptionDialog",t.innerHTML='<form class="customOptionDialog-content"><div class="customOptionDialog-title">'+toLanguage("Custom FPS...","Choix des FPS...")+'</div><input type="range" min="1" max="16" step="1" class="customOptionDialog-cursor" /><div class="customOptionDialog-textValue"></div><div class="customOptionDialog-submit"><input type="submit" value="'+toLanguage("Validate","Valider")+'" /><a href="#null" class="customOptionDialog-cancel">'+toLanguage("Cancel","Annuler")+"</a></div></form>";var n=t.querySelector(".customOptionDialog-cursor"),a=t.querySelector(".customOptionDialog-content");function o(){var e=15*n.value;t.querySelector(".customOptionDialog-textValue").innerHTML=e+" FPS"}function i(){document.body.removeChild(t)}function r(){var e=+n.value;addFpsOption(e),setFps(e),i()}return n.value=iFps,o(),n.oninput=function(){o()},t.onclick=function(e){r()},a.style.bottom="5px",a.onclick=function(e){e.stopPropagation()},a.onsubmit=function(){return r(),!1},t.querySelector(".customOptionDialog-submit a").onclick=function(){return i(),!1},void document.body.appendChild(t)}if(localStorage.setItem("nbFrames",e),formulaire&&formulaire.dataset.disabled)return showParamChangeDisclaimer();iFps=e}function openFullscreen(e){return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():void 0}var $mkScreen=document.getElementById("mariokartcontainer");$mkScreen.dataset||($mkScreen.dataset={}),updateCtnFullScreen=function(e){if($mkScreen.dataset.fs=e?1:"",e){var t=Math.min(screen.width/(iWidth*iScreenScale),screen.height/(iHeight*iScreenScale)),n=Math.round(100*t),a=$mkScreen.scrollWidth,e=$mkScreen.style.zoom;if($mkScreen.style.zoom=n+"%",a!=$mkScreen.scrollWidth||e==$mkScreen.style.zoom||100==n){for(var o=0;o<oContainers.length;o++)oContainers[o].style.left=Math.round((screen.width/t-iScreenScale*iWidth)/2+o*(iWidth*iScreenScale+2))+"px",oContainers[o].style.top=Math.round((screen.height/t-iScreenScale*iHeight)/2)+"px";updateHudFullScreen(),updatePlanFullScreen()}else if($mkScreen.style.zoom="",!formulaire||!formulaire.dataset.disabled){e=window.innerWidth-20,n=window.innerHeight-20,t=Math.round(Math.min(e/iWidth,n/iHeight));$mkScreen.dataset.fakefs=1;for(o=0;o<oContainers.length;o++)oContainers[o].style.left=Math.round((window.innerWidth-t*iWidth)/2+o*(iWidth*iScreenScale+2))+"px",oContainers[o].style.top=Math.round((window.innerHeight-t*iHeight)/2)+"px";updateHudFullScreen(),updatePlanFullScreen(),$mkScreen.dataset.lastsc||($mkScreen.dataset.lastsc=iScreenScale),setScreenScale(t,!0),window.nsevent||(window.nsevent=function(e){27==e.keyCode&&(e.preventDefault(),updateCtnFullScreen(!1))},window.addEventListener("keydown",window.nsevent))}$mkScreen.className="fullscreen"}else if(!($mkScreen.dataset.fakefs&&formulaire&&formulaire.dataset.disabled)){$mkScreen.style.zoom="",$mkScreen.className="",$mkScreen.dataset.fakefs&&(setScreenScale(+$mkScreen.dataset.lastsc,!0),$mkScreen.dataset.lastsc="",$mkScreen.dataset.fakefs="",window.nsevent&&(window.removeEventListener("keydown",window.nsevent),delete window.nsevent));for(o=0;o<oContainers.length;o++)oContainers[o].style.left=10+o*(iWidth*iScreenScale+2)+"px",oContainers[o].style.top="";updateHudFullScreen(),updatePlanFullScreen()}};var hudScreens=new Array,oMusicHandler,muteOnBlur,unmuteOnResume,itemDistribution,ptsDistribution;function updateHudFullScreen(){for(var e=0;e<hudScreens.length;e++)hudScreens[e].style.left=oContainers[e].style.left,hudScreens[e].style.top=oContainers[e].style.top}function removeHUD(){for(var e=0;e<hudScreens.length;e++)$mkScreen.removeChild(hudScreens[e]);hudScreens.length=0}function updatePlanFullScreen(){var e;oPlanDiv2&&((e=$mkScreen.dataset.fs)&&oPlanDiv2.parentNode!==oContainers[0]?(oPlanDiv2.parentNode&&oPlanDiv2.parentNode.removeChild(oPlanDiv2),oPlanDiv2.style.left="",oPlanDiv2.style.right=Math.round(.5*iScreenScale)+"px",oPlanDiv2.style.top=Math.round(iScreenScale*($speedometers.length?4.8:2.5))+"px",oContainers[0].appendChild(oPlanDiv2)):e||oPlanDiv2.parentNode===document.body||(oPlanDiv2.parentNode&&oPlanDiv2.parentNode.removeChild(oPlanDiv2),oPlanDiv2.style.left=15+iScreenScale*iWidth+"px",oPlanDiv2.style.right="",oPlanDiv2.style.top=10+Math.round(iScreenScale/4)+oPlanWidth+"px",document.body.appendChild(oPlanDiv2)))}function setScreenScale(e,t){if(e!==iScreenScale){var n=iScreenScale;if(-1!=e){if(-2==e){formulaire.screenscale.value=n;var a=document.createElement("div");a.className="customOptionDialog",a.innerHTML='<form class="customOptionDialog-content"><div class="customOptionDialog-title">'+toLanguage("Custom size...","Taille personnalis√©e...")+'</div><input type="range" min="2" max="36" step="2" class="customOptionDialog-cursor" /><div class="customOptionDialog-textValue"></div><div class="customOptionDialog-submit"><input type="submit" value="'+toLanguage("Validate","Valider")+'" /><a href="#null" class="customOptionDialog-cancel">'+toLanguage("Cancel","Annuler")+"</a></div></form>";var o=a.querySelector(".customOptionDialog-cursor"),i=a.querySelector(".customOptionDialog-content");function r(){var e=+o.value;a.querySelector(".customOptionDialog-textValue").innerHTML=e*iWidth+"&times;"+e*iHeight}function l(){document.body.removeChild(a)}function s(){var e=+o.value;addScreenScaleOption(e),setScreenScale(e),l()}return o.value=n,r(),o.oninput=function(){var e=+o.value;formulaire.dataset.disabled||previewScreenScale(n,e),r()},a.onclick=function(e){s()},i.style.bottom="80px",i.onclick=function(e){e.stopPropagation()},i.onsubmit=function(){return s(),!1},a.querySelector(".customOptionDialog-submit a").onclick=function(){return formulaire.dataset.disabled||previewScreenScale(n,n),l(),!1},void document.body.appendChild(a)}if(t||localStorage.setItem("iScreenScale",e),formulaire&&formulaire.dataset.disabled)return showParamChangeDisclaimer();iScreenScale=e,bRunning&&resetScreen(),previewScreenScale(n,iScreenScale),setSRest()}else{formulaire.screenscale.value=n;e=openFullscreen($mkScreen);e.then&&e.catch?e.then(function(){updateCtnFullScreen(!0),document.onfullscreenchange=function(){updateCtnFullScreen(document.fullscreenElement===$mkScreen)}}).catch(function(){updateCtnFullScreen(!0)}):updateCtnFullScreen(!0)}}}function addCustomOption(e,t,n,a){var o;a=a||1,e.querySelector('option[value="'+t+'"]')||((o=document.createElement("option")).value=t,o.innerHTML=n,e.insertBefore(o,e.childNodes[e.childNodes.length-a])),e.value=t}function addScreenScaleOption(e){addCustomOption(formulaire.screenscale,e,e*iWidth+"&times;"+e*iHeight,2)}function addFpsOption(e){addCustomOption(formulaire.fps,e,15*e+" FPS")}function previewScreenScale(e,t){for(var n=0;n<oContainers.length;n++){var a=oContainers[n].firstChild;a&&(a.aScreenScale||(a.aScreenScale=e),a.style.width=iWidth*t+"px",a.style.height=iHeight*t+"px",a.style.transformOrigin=a.style.WebkitTransformOrigin=a.style.MozTransformOrigin="top left",a.style.transform=a.style.WebkitTransform=a.style.MozTransform="scale("+t/a.aScreenScale+")")}}function showParamChangeDisclaimer(){var e=document.createElement("div");e.className="modes-change-disclaimer",e.innerHTML=toLanguage("Your settings have been saved.<br />They'll apply to your next race.","Les param√®tres ont √©t√© sauvegard√©s.<br />Ils s'appliqueront √† la prochaine course"),document.body.appendChild(e),setTimeout(function(){e.classList.add("modes-change-fadeout"),setTimeout(function(){document.body.removeChild(e)},1e3)},3e3)}function setMusic(e){if(e?localStorage.setItem("bMusic",1):localStorage.removeItem("bMusic"),formulaire&&formulaire.dataset.disabled){if(e)return showParamChangeDisclaimer();removeMapMusics(),removeIfExists(endingMusic)}bMusic=!!e,-1!=gameMenu&&updateMenuMusic(gameMenu,!0)}function setSfx(e){if(e?localStorage.setItem("iSfx",1):localStorage.removeItem("iSfx"),formulaire&&formulaire.dataset.disabled){if(e)return showParamChangeDisclaimer();removeSoundEffects(),oMusicEmbed&&unpauseMusic(mapMusic),removeGameMusics(listMapMusics().concat([endingMusic]))}iSfx=!!e}function removeMenuMusic(e){clearTimeout(oMusicHandler),oMusicEmbed&&document.body.contains(oMusicEmbed)&&(e?document.body.removeChild(oMusicEmbed):fadeOutMusic(oMusicEmbed,1,.8,null,vMusic),oMusicEmbed=void 0),muteOnBlur&&(window.removeEventListener("blur",muteOnBlur),muteOnBlur=void 0),unmuteOnResume&&(window.removeEventListener("focus",unmuteOnResume),unmuteOnResume=void 0)}function removeIfExists(e){e&&(e.yt&&(e.yt.destroy&&(e.yt.isDetroyed=!0,e.yt.destroy()),delete e.yt,delete e.tasks,delete e.opts),document.body.contains(e)&&document.body.removeChild(e),oMusicEmbed==e&&(oMusicEmbed=void 0))}function removeMapMusics(){removeIfExists(mapMusic),foreachLMap(function(e){removeIfExists(e.mapMusic)}),removeIfExists(lastMapMusic)}function listMapMusics(){var t=[mapMusic];return foreachLMap(function(e){t.push(e.mapMusic)}),t.push(lastMapMusic),t}function removeGameMusics(e){if(bMusic||iSfx){for(var t=document.getElementsByClassName("gamemusic"),n=t.length-1;0<=n;n--){var a=t[n];e&&-1!==e.indexOf(a)||document.body.removeChild(a)}oMusicEmbed=void 0}}function removeSoundEffects(){playingCarEngine=void 0,removeIfExists(carEngine),carEngine=void 0,removeIfExists(carEngine2),carEngine2=void 0,removeIfExists(carEngine3),carEngine3=void 0,removeIfExists(carDrift),carDrift=void 0,removeIfExists(carSpark),carSpark=void 0}function clearResources(){var t;foreachLMap(function(e){e.mapImg!==t&&(t=e.mapImg).clear&&t.clear()})}function resetEvents(){document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,window.removeEventListener("deviceorientation",window.turnOnRotate),window.turnOnRotate=void 0,hideVirtualKeyboard()}function pauseSounds(){if(bMusic||iSfx){clLocalVars.forcePause||(playSoundEffect("musics/events/pause.mp3").className="");for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)muteSound(e[t])}}function unpauseSounds(){(bMusic||iSfx)&&(playSoundEffect("musics/events/pause.mp3").className="",setTimeout(function(){if(!pause)for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)unmuteSound(e[t])},300))}function setMusicVolume(e,t){isOriginalEmbed(e)?e.volume=t*vMusic:onPlayerReady(e,function(e){e.setVolume(Math.round(t*vMusic*100))})}function updateMusicVolume(e,t,n){isOriginalEmbed(e)?e.volume===n&&(e.volume=t):onPlayerReady(e,function(e){Math.round(e.getVolume())===Math.round(100*n)&&e.setVolume(Math.round(100*t))})}function fadeInMusic(e,t,n){e.fadingOut||(e.fadingIn=!0,(t/=n)<1?(setMusicVolume(e,t),e.fadingIn=!1,setTimeout(function(){fadeInMusic(e,t,n)},100)):setMusicVolume(e,1))}function fadeOutMusic(e,t,n,a,o){e.fadingIn||(e.fadingOut=!0,.2<(t*=n)?(setMusicVolume(e,t*o),setTimeout(function(){fadeOutMusic(e,t,n,a,o)},100)):(e.fadingOut=!1)===a?(pauseMusic(e),setMusicVolume(e,o)):-1!==a&&stopMusic(e))}function updateMenuMusic(e,t){var n;e==gameMenu&&!t||(gameMenu=e,removeMenuMusic(!bMusic),bMusic&&(playMusicSmoothly("musics/menu/"+(gameMenu?"selection-remix":"main-remix")+".mp3",t?0:void 0),gameMenu||loopAfterIntro(oMusicEmbed,60.15,54.9),n=oMusicEmbed,muteOnBlur=function(){oMusicEmbed==n&&(clearTimeout(oMusicHandler),n.pause())},window.addEventListener("blur",muteOnBlur),unmuteOnResume=function(){oMusicEmbed==n&&n.play()},window.addEventListener("focus",unmuteOnResume)))}function playMusicSmoothly(e,t){void 0===t&&(t=1e3),(oMusicEmbed=document.createElement("audio")).volume=vMusic,oMusicEmbed.setAttribute("loop",!0),oMusicEmbed.style.position="absolute",oMusicEmbed.style.left="-1000px",oMusicEmbed.style.top="-1000px";var n=document.createElement("source");n.type="audio/mpeg",n.src=e,oMusicEmbed.appendChild(n),clearTimeout(oMusicHandler),t?oMusicHandler=setTimeout(function(){oMusicEmbed.play()},t):oMusicEmbed.setAttribute("autoplay",!0),document.body.appendChild(oMusicEmbed)}function baseCustomPersos(){var e={};if("undefined"!=typeof characterRoster)for(var t=0;t<characterRoster.length;t++){var n=characterRoster[t];baseCp0[n.sprites]||(e[n.sprites]=n)}return e}var oBgLayers=new Array,oPlayers=new Array;if(!pause){if(!baseCp0){baseCp0={},pUnlockMap={};var i=0;for(joueurs in cp)baseCp0[joueurs]=cp[joueurs],pUnlockMap[joueurs]=pUnlocked[i],i++;if("undefined"!=typeof characterRoster){cp={};for(var i=0;i<characterRoster.length;i++){var perso=characterRoster[i];baseCp0[perso.sprites]?cp[perso.sprites]=baseCp0[perso.sprites]:(cp[perso.sprites]=[perso.acceleration,perso.speed,perso.handling,perso.mass],pUnlockMap[perso.sprites]=perso.unlocked)}}}for(joueurs in baseCp&&(cp=baseCp),baseCp={},customPersos=baseCustomPersos(),nBasePersos=0,cp)aPlayers.push(joueurs),baseCp[joueurs]=cp[joueurs],nBasePersos++}var strPlayer=new Array,oMap,lMaps,pMaps,iDificulty=5,iTeamPlay=selectedTeams,fSelectedClass,bSelectedMirror,iRecord,iTrajet,jTrajets,iLapTimes,gPersos=new Array,gRecord,gSelectedPerso,gOverwriteRecord,selectedItemDistrib,selectedPtDistrib,oDoubleItemsEnabled,oPlanDiv,oPlanDiv2,oPlanCtn,oPlanCtn2,oPlanImg,oPlanImg2,oPlanWidth,oPlanSize,oPlanRealSize,oCharWidth,oObjWidth,oCoinWidth,oExpWidth,oExpBWidth,oPlanWidth2,oPlanSize2,oCharWidth2,oObjWidth2,oCoinWidth2,oExpWidth2,oExpBWidth2,oCharRatio,oPlanRatio;function resetGame(e){oMap=oMaps[e],loadMap()}pause&&(strPlayer=fInfos.player,selectedItemDistrib=fInfos.distribution,selectedPtDistrib=fInfos.ptsdistrib,fSelectedClass=fInfos.cc,bSelectedMirror=fInfos.mirror,oDoubleItemsEnabled=!!fInfos.double_items,oMap=oMaps["map"+fInfos.map],clSelected=fInfos.cl,"CM"!=course?iDificulty=fInfos.difficulty:(iTrajet=fInfos.my_route,gPersos=fInfos.perso,jTrajets=fInfos.cpu_route,gRecord=fInfos.my_record,gOverwriteRecord=fInfos.ow_record,2==gOverwriteRecord&&(gOverwriteRecord=1),iRecord=fInfos.record,iLapTimes=fInfos.lap_times,gSelectedPerso=fInfos.selPerso));var oPlanCharacters=new Array,oPlanObjects=new Array,oPlanCoins=new Array,oPlanPoisons=new Array,oPlanDecor={},oPlanAssets={},oPlanSea,oPlanFauxObjets=new Array,oPlanBananes=new Array,oPlanBobOmbs=new Array,oPlanChampis=new Array,oPlanEtoilesDrop=new Array,oPlanCarapaces=new Array,oPlanCarapacesRouges=new Array,oPlanCarapacesBleues=new Array,oPlanCarapacesNoires=new Array,oPlanEtoiles=new Array,oPlanBillballs=new Array,oPlanTeams=new Array,oPlanCharacters2=new Array,oPlanObjects2=new Array,oPlanCoins2=new Array,oPlanDecor2={},oPlanAssets2={},oPlanSea2,oPlanFauxObjets2=new Array,oPlanBananes2=new Array,oPlanBobOmbs2=new Array,oPlanPoisons2=new Array,oPlanChampis2=new Array,oPlanEtoilesDrop2=new Array,oPlanCarapaces2=new Array,oPlanCarapacesRouges2=new Array,oPlanCarapacesBleues2=new Array,oPlanCarapacesNoires2=new Array,oPlanEtoiles2=new Array,oPlanBillballs2=new Array,oPlanTeams2=new Array,customDecorFetchHandlers=[{plan:oPlanDecor,list:{}},{plan:oPlanDecor2,list:{}}];function posImg(e,t,n,a,o,i){bSelectedMirror&&(t=oMap.w-t,a=-a);t/=oPlanRealSize,n/=oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+Math.round(i*t-o/2)+"px, "+Math.round(i*n-o/2)+"px) rotate("+Math.round(180-a)+"deg)",e}function posImgRel(e,t,n,a,o,i,r,l){bSelectedMirror&&(t=oMap.w-t,a=-a);t/=oPlanRealSize,n/=oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+(Math.round(r)+Math.round(i*t-o/2))+"px, "+(Math.round(l)+Math.round(i*n-o/2))+"px) rotate("+Math.round(180-a)+"deg)",e}var oTeamColors={primary:["blue","red","green","#db1","#f80","magenta"],secondary:["#ccf","#fcc","#cfc","#ff8","#fc8","#f9f"],light:["#69f","#f96","#9f6","#ff7","#fa4","#f8f"],dark:["navy","brown","#030","#330","#630","#303"],contrast:["#abf","#fba","#bfa","#eea","#fd9","#ebe"],name:[toLanguage("Blue","Bleue"),toLanguage("Red","Rouge"),toLanguage("Green","Verte"),toLanguage("Yellow","Jaune"),toLanguage("Orange","Orange"),toLanguage("Magenta","Magenta")],name2:[toLanguage("blue","bleu"),toLanguage("red","rouge"),toLanguage("green","vert"),toLanguage("yellow","jaune"),toLanguage("orange","orange"),toLanguage("magenta","magenta")]},cTeamColors=oTeamColors,gameSettings,ctrlSettings,oChallengeCpts;function setPlanPos(h,g){var c=h.players[0];if(oSpecCam&&(c=h.karts[oSpecCam.playerId]),!(3<c.teleport||10<c.tombe)){var l=h.items,p=c;oSpecCam&&(p=oSpecCam.pos);var e=Math.round(p.rotation-180);bSelectedMirror&&(e=-e);var t=direction(1,e),n=direction(0,e),a=p.x/oPlanRealSize,o=p.y/oPlanRealSize;bSelectedMirror&&(a=1-a),oPlanCtn.style.transform=oPlanCtn.style.WebkitTransform=oPlanCtn.style.MozTransform="translate("+-Math.round(oPlanSize*(a*t-o*n)-oPlanWidth/2)+"px, "+-Math.round(oPlanSize*(a*n+o*t)-oPlanWidth/2)+"px) rotate("+e+"deg)",P(oPlanAssets,oPlanCtn,oPlanSize,oPlanObjects),P(oPlanAssets2,oPlanCtn2,oPlanSize2,oPlanObjects2),g.sea&&(k(oPlanSea,oPlanSize),k(oPlanSea2,oPlanSize2)),I(oPlanCharacters,oCharWidth,oPlanSize),I(oPlanCharacters2,oCharWidth2,oPlanSize2),w(oPlanObjects),w(oPlanObjects2),g.coins&&(L(oPlanCoins,oCoinWidth,oPlanCtn,oPlanSize),L(oPlanCoins2,oCoinWidth2,oPlanCtn2,oPlanSize2)),T(oPlanDecor,oObjWidth,oPlanCtn,oPlanSize),T(oPlanDecor2,oObjWidth2,oPlanCtn2,oPlanSize2),M(oPlanFauxObjets,l.fauxobjet,"objet",oObjWidth,oPlanCtn),M(oPlanFauxObjets2,l.fauxobjet,"objet",oObjWidth2,oPlanCtn2);for(var i=0;i<l.fauxobjet.length;i++){var r=l.fauxobjet[i];x(oPlanFauxObjets[i],r.x,r.y,oObjWidth,oPlanSize,r.ref.team,200),x(oPlanFauxObjets2[i],r.x,r.y,oObjWidth2,oPlanSize2,r.ref.team,200),oPlanFauxObjets[i].style.zIndex=oPlanFauxObjets2[i].style.zIndex=2}M(oPlanBananes,l.banane,"banane",oObjWidth,oPlanCtn),M(oPlanBananes2,l.banane,"banane",oObjWidth2,oPlanCtn2);for(i=0;i<l.banane.length;i++){var s=l.banane[i];x(oPlanBananes[i],s.x,s.y,oObjWidth,oPlanSize,s.ref.team,100),x(oPlanBananes2[i],s.x,s.y,oObjWidth2,oPlanSize2,s.ref.team,100),oPlanBananes[i].style.zIndex=oPlanBananes2[i].style.zIndex=2}M(oPlanPoisons,l.poison,"poison",oObjWidth,oPlanCtn),M(oPlanPoisons2,l.poison,"poison",oObjWidth2,oPlanCtn2);for(i=0;i<l.poison.length;i++){var u=l.poison[i];x(oPlanPoisons[i],u.x,u.y,oObjWidth,oPlanSize,u.ref.team,100),x(oPlanPoisons2[i],u.x,u.y,oObjWidth2,oPlanSize2,u.ref.team,100),oPlanPoisons[i].style.zIndex=oPlanPoisons2[i].style.zIndex=2}M(oPlanChampis,l.champi,"champi",oObjWidth,oPlanCtn),M(oPlanChampis2,l.champi,"champi",oObjWidth2,oPlanCtn2);for(i=0;i<l.champi.length;i++){var d=l.champi[i];x(oPlanChampis[i],d.x,d.y,oObjWidth,oPlanSize,-1,100),x(oPlanChampis2[i],d.x,d.y,oObjWidth2,oPlanSize2,-1,100),oPlanChampis[i].style.zIndex=oPlanChampis2[i].style.zIndex=2}M(oPlanEtoilesDrop,l.etoile,"etoile",oObjWidth,oPlanCtn),M(oPlanEtoilesDrop2,l.etoile,"etoile",oObjWidth2,oPlanCtn2);for(i=0;i<l.etoile.length;i++){var m=l.etoile[i];x(oPlanEtoilesDrop[i],m.x,m.y,oObjWidth,oPlanSize,-1,100),x(oPlanEtoilesDrop2[i],m.x,m.y,oObjWidth2,oPlanSize2,-1,100),oPlanEtoilesDrop[i].style.zIndex=oPlanEtoilesDrop2[i].style.zIndex=2}D(oPlanBobOmbs,oObjWidth,oPlanCtn,oPlanSize,oExpWidth),D(oPlanBobOmbs2,oObjWidth2,oPlanCtn2,oPlanSize2,oExpWidth2),M(oPlanCarapaces,l.carapace,"carapace",oObjWidth,oPlanCtn),M(oPlanCarapaces2,l.carapace,"carapace",oObjWidth2,oPlanCtn2);for(i=0;i<l.carapace.length;i++){var y=l.carapace[i];x(oPlanCarapaces[i],y.x,y.y,oObjWidth,oPlanSize,y.ref.team,200),x(oPlanCarapaces2[i],y.x,y.y,oObjWidth2,oPlanSize2,y.ref.team,200).style.zIndex=2}M(oPlanCarapacesRouges,l["carapace-rouge"],"carapace-rouge",oObjWidth,oPlanCtn),M(oPlanCarapacesRouges2,l["carapace-rouge"],"carapace-rouge",oObjWidth2,oPlanCtn2);for(i=0;i<l["carapace-rouge"].length;i++){var f=l["carapace-rouge"][i];x(oPlanCarapacesRouges[i],f.x,f.y,oObjWidth,oPlanSize,f.ref.team,200),x(oPlanCarapacesRouges2[i],f.x,f.y,oObjWidth2,oPlanSize2,f.ref.team,200).style.zIndex=2,f.ref.owner&&(oPlanCarapacesRouges[i].style.zIndex=2)}B(oPlanCarapacesBleues,oObjWidth,oPlanSize,oExpBWidth,oPlanCtn),B(oPlanCarapacesBleues2,oObjWidth2,oPlanSize2,oExpBWidth2,oPlanCtn2),O(oPlanCarapacesNoires,oObjWidth,oPlanSize,oExpBWidth,oPlanCtn),O(oPlanCarapacesNoires2,oObjWidth2,oPlanSize2,oExpBWidth2,oPlanCtn2);for(var S=new Array,v=new Array,i=0;i<h.karts.length;i++){var b=h.karts[i];b.ref.etoile?S.push(b):b.ref.billball&&v.push(b)}M(oPlanEtoiles,S,"etoile",oObjWidth,oPlanCtn),M(oPlanEtoiles2,S,"etoile",oObjWidth2,oPlanCtn2);for(i=0;i<S.length;i++)x(oPlanEtoiles[i],S[i].x,S[i].y,oObjWidth,oPlanSize),x(oPlanEtoiles2[i],S[i].x,S[i].y,oStarWidth2,oPlanSize2).style.width=oStarWidth2+"px",oPlanEtoiles[i].style.zIndex=oPlanEtoiles2[i].style.zIndex=2;M(oPlanBillballs,v,"billball",oObjWidth,oPlanCtn),M(oPlanBillballs2,v,"billball",oObjWidth2,oPlanCtn2);for(i=0;i<v.length;i++)posImg(oPlanBillballs[i],v[i].x,v[i].y,Math.round(p.rotation),oBBWidth,oPlanSize).style.width=oBBWidth+"px",posImg(oPlanBillballs2[i],v[i].x,v[i].y,Math.round(p.rotation),oBBWidth2,oPlanSize2).style.width=oBBWidth2+"px",oPlanBillballs[i].style.zIndex=oPlanBillballs2[i].style.zIndex=2}function C(e,t,n,a){var o=document.createElement("img");return o.src="images/map_icons/"+e+".png",o.style.position="absolute",o.style.width=t+"px",o.className="pixelated",n.insertBefore(o,a||null),o}function x(e,t,n,a,o,i,r){return posImg(e,t,n,p.rotation,a,o),0<=i&&e.team!=i&&(o=cTeamColors.primary[i],e.team=i,e.style.background="radial-gradient(ellipse at center, "+o+" 0%,transparent "+r+"%)"),e}function M(e,t,n,a,o){if(e.length!=t.length){for(;e.length<t.length;)e.push(C(n,a,o));for(;e.length>t.length;)o.removeChild(e[0]),e.shift()}}function P(e,t,i,n){for(var a in e)if(g[a]){if(e[a].length<g[a].length)for(var o=e[a].length;o<g[a].length;o++){var r=(m=g[a][o])[1][2]*i/g.w,l=m[1][3]*i/g.w,s=C(m[0].src,r,t,n[0]),c=m[0].custom;c&&(s.src="images/map_icons/empty.png",function(a,o){getCustomDecorData(c,function(e){var t,n;switch(a.src=e.map,o){case"flippers":case"pointers":n=e.size.hd.h;break;case"oils":t=e.size.hd.w,n=e.size.hd.h;break;default:return}t&&(r=t*i/g.w,a.style.width=r+"px"),n&&(l=n*i/g.w,a.style.height=l+"px")})}(s,a)),s.style.height=l+"px";var p,u=m[2][0],d=m[2][1];bSelectedMirror&&(u=1-u,(p=document.createElement("div")).style.position="absolute",p.style.display="flex",s.style.position="static",s.className="mirrored",p.appendChild(s),t.appendChild(p),s=p),s.style.transformOrigin=s.style.WebkitTransformOrigin=s.style.MozTransformOrigin=Math.round(100*u)+"% "+Math.round(100*d)+"%",e[a].push(s)}for(o=0;o<g[a].length;o++){var m,r=(m=g[a][o])[1][2]*i/g.w;posImg(e[a][o],m[1][0]+m[1][2]*(.5-m[2][0]),m[1][1]+m[1][2]/2-m[1][3]*m[2][1],Math.round(180*(Math.PI-m[2][2])/Math.PI),r,i)}}}function k(e,t){var n=e.getContext("2d");n.clearRect(0,0,e.width,e.height),g.sea.render(n,[0,0],t/g.w)}function I(e,t,n){for(var a=0;a<h.karts.length;a++){var o,i,r,l=h.karts[a],s=!0;l.ref.loose&&(isOnline&&!finishing||l==c?e[a].style.opacity=.25:(e[a].style.display="none",iTeamPlay&&t==oCharWidth&&(oPlanTeams[a].style.display="none",oPlanTeams2[a].style.display="none"),s=!1)),s&&(r=l.ref.billball?1.5:l.size,o=Math.round(t*r),e[a].style.width=o+"px",posImg(e[a],l.x,l.y,l.rotation-360*l.tourne/21,o,n),iTeamPlay&&t==oCharWidth&&(i=Math.round(oCharWidth2*r),s=Math.round(oTeamWidth*r),r=Math.round(oTeamWidth2*r),posImgRel(oPlanTeams[a],l.x,l.y,Math.round(p.rotation),o,oPlanSize,(o-s)/2,(o-s)/2),oPlanTeams[a].style.width=s+"px",oPlanTeams[a].style.height=s+"px",posImgRel(oPlanTeams2[a],l.x,l.y,Math.round(p.rotation),i,oPlanSize2,(i-r)/2,(i-r)/2),oPlanTeams2[a].style.width=r+"px",oPlanTeams2[a].style.height=r+"px"))}}function w(e){for(var t=0;t<g.arme.length;t++)g.arme[t][2].active?e[t].style.display="block":e[t].style.display="none"}function L(e,t,n,a){if(e.length!=g.coins.length){M(e,g.coins,"coin",t,n);for(var o=0;o<e.length;o++)posImg(e[o],g.coins[o].x,g.coins[o].y,Math.round(p.rotation),t,a)}}function T(r,l,s,e){var t=customDecorFetchHandlers.find(function(e){return e.plan===r}).list||{};for(n in decorBehaviors)decorBehaviors[n].ctx.lMap=g;var n,a=h.decor[0];for(n in a){var o=a[n],i=decorBehaviors[n],c=getDecorExtra(i).custom;if(!i.hidden&&(o.length!=r[n].length||i.movable)){var p=l;if(i.size_ratio&&(p*=i.size_ratio.w),M(r[n],o,n,p,s),c&&t[n]!==r[n].length){t[n]=r[n].length;for(var u=0;u<r[n].length;u++)r[n][u].src="images/map_icons/empty.png";!function(a,o,i){getCustomDecorData(c,function(e){p=l*o.size_ratio.w,M(r[a],i,a,p,s);for(var t=0;t<r[a].length;t++){var n=r[a][t];n.src=e.map,n.style.width=p+"px"}})}(n,i,o)}var d,m=i.rotatable;!m||(i=r[n][0])&&i.naturalWidth&&(d=Math.round(p*(i.naturalWidth-i.naturalHeight)/(2*i.naturalWidth)));for(u=0;u<o.length;u++)m?posImgRel(r[n][u],o[u].x,o[u].y,Math.round(o[u].ref[4]),p,e,0,d):x(r[n][u],o[u].x,o[u].y,p,e)}}}function E(e,t,n){return"images/map_icons/"+(e+=-1!=t?t:n)+".png"}function D(e,t,n,a,o){M(e,l.bobomb,"bob-omb",t,n);for(var i=0;i<l.bobomb.length;i++){var r=l.bobomb[i];r.ref.cooldown<=0?(posImg(e[i],r.x,r.y,Math.round(p.rotation),o,a).src=E("explosion",r.ref.team,""),e[i].style.width=o+"px",e[i].style.opacity=Math.max(1+r.ref.cooldown/10,0),e[i].style.background=""):x(e[i],r.x,r.y,t,a,r.ref.team,100).style.zIndex=2}}function B(e,t,n,a,o){M(e,l["carapace-bleue"],"carapace-bleue",t,o);for(var i=0;i<l["carapace-bleue"].length;i++){var r=l["carapace-bleue"][i];r.ref.cooldown<=0?(posImg(e[i],r.x,r.y,Math.round(p.rotation),a,n).src=E("explosion",r.ref.team,"0"),e[i].style.width=a+"px",e[i].style.opacity=Math.max(1+r.ref.cooldown/10,0),e[i].style.background=""):x(e[i],r.x,r.y,t,n,r.ref.team,200).style.zIndex=2}}function O(e,t,n,a,o){M(e,l["carapace-noire"],"carapace-noire",t,o);for(var i=0;i<l["carapace-noire"].length;i++){var r=l["carapace-noire"][i];r.ref.cooldown<=0?(posImg(e[i],r.x,r.y,Math.round(p.rotation),a,n).src=E("explosion",r.ref.team,"D"),e[i].style.width=a+"px",e[i].style.opacity=Math.max(1+r.ref.cooldown/10,0),e[i].style.background=""):x(e[i],r.x,r.y,t,n,r.ref.team,200).style.zIndex=2}}}function initPlan(e){oPlanWidth=Math.round(19.4*iScreenScale),oPlanWidth2=e.w>=e.h?oPlanWidth:oPlanWidth*(e.w/e.h);var t,n=e.w<=e.h?oPlanWidth:oPlanWidth*(e.h/e.w);e.iW&&e.iH&&(t=Math.min(e.w/e.iW,e.h/e.iH),oPlanWidth2*=t,n*=t),oPlanWidth2=Math.round(oPlanWidth2),n=Math.round(n),oPlanSize=59*iScreenScale,oPlanSize2=oPlanWidth2,oPlanRealSize=e.w,oCharRatio=.8,oPlanRatio=.5,(oPlanDiv=document.createElement("div")).className="mkplan mkplanzoom",oPlanDiv.style.backgroundColor="rgb("+e.bgcolor+")",oPlanDiv.style.left=15+iScreenScale*iWidth+"px",oPlanDiv.style.top="9px",oPlanDiv.style.width=oPlanWidth+"px",oPlanDiv.style.height=oPlanWidth+"px",(oPlanDiv2=document.createElement("div")).className="mkplan mkplanfull",oPlanDiv2.style.backgroundColor="rgb("+e.bgcolor+")",oPlanDiv2.style.width=oPlanWidth+"px",oPlanDiv2.style.height=oPlanWidth+"px",(oPlanCtn=document.createElement("div")).style.position="absolute",oPlanCtn.style.transformOrigin=oPlanCtn.style.WebkitTransformOrigin=oPlanCtn.style.MozTransformOrigin="left",(oPlanCtn2=document.createElement("div")).style.position="absolute",oPlanCtn2.style.left=Math.round((oPlanWidth-oPlanWidth2)/2)+"px",oPlanCtn2.style.top=Math.round((oPlanWidth-n)/2)+"px",oPlanCtn2.style.width=oPlanWidth2+"px",oPlanCtn2.style.height=n+"px";var a,o=e.mapImg;if(o.src?((oPlanImg=document.createElement("img")).src=o.src,oPlanImg.style.width=oPlanSize+"px"):(a=Math.round(oPlanSize*e.h/e.w),(oPlanImg=document.createElement("canvas")).width=oPlanSize,oPlanImg.height=a,oPlanImg.getContext("2d").drawImage(o,0,0,oPlanSize,a)),oPlanImg.className="mkplanimg",oPlanCtn.appendChild(oPlanImg),o.src?(oPlanImg2=document.createElement("img")).src=o.src:((oPlanImg2=document.createElement("canvas")).width=oPlanSize,oPlanImg2.height=a,oPlanImg2.getContext("2d").drawImage(o,0,0,oPlanSize,a)),oPlanImg2.className="mkplanimg",oPlanImg2.style.width=oPlanWidth2+"px",oPlanCtn2.appendChild(oPlanImg2),bSelectedMirror&&(oPlanImg.className=oPlanImg2.className="mkplanimg mirrored"),e.decor)for(var i in e.decor)oPlanDecor[i]=new Array,oPlanDecor2[i]=new Array;e.sea&&((oPlanSea=document.createElement("canvas")).style.position="absolute",oPlanSea.style.left="0px",oPlanSea.style.top="0px",oPlanSea.setAttribute("width",oPlanSize+"px"),oPlanSea.setAttribute("height",oPlanSize+"px"),oPlanCtn.appendChild(oPlanSea),(oPlanSea2=document.createElement("canvas")).style.position="absolute",oPlanSea2.style.left="0px",oPlanSea2.style.top="0px",oPlanSea2.setAttribute("width",oPlanWidth2+"px"),oPlanSea2.setAttribute("height",oPlanWidth2+"px"),oPlanCtn2.appendChild(oPlanSea2),bSelectedMirror&&(oPlanSea.className=oPlanSea2.className="mirrored"));for(var r=0;r<assetKeys.length;r++){var l=assetKeys[r];e[l]&&(oPlanAssets[l]=new Array,oPlanAssets2[l]=new Array)}if(oPlanImg.onload=function(){o.seekFrame&&o.seekFrame(2)},oCharWidth=2*iScreenScale,oTeamWidth=Math.round(2.4*iScreenScale),oBBWidth=2*iScreenScale,oStarWidth2=Math.round(1.5*iScreenScale),oObjWidth=Math.round(1.5*iScreenScale),oCoinWidth=Math.round(1.2*iScreenScale),oExpWidth=Math.round(4.2*iScreenScale),oExpBWidth=Math.round(5.6*iScreenScale),oCharWidth2=Math.round(oCharRatio*oCharWidth),oTeamWidth2=Math.round(oCharRatio*oTeamWidth),oBBWidth2=Math.round(oCharRatio*oBBWidth),oObjWidth2=Math.round(oPlanRatio*oObjWidth),oCoinWidth2=Math.round(oPlanRatio*oCoinWidth),oExpWidth2=Math.round(oPlanRatio*oExpWidth),oExpBWidth2=Math.round(oPlanRatio*oExpBWidth),iTeamPlay)for(r=0;r<aTeams.length;r++){var s=document.createElement("div");s.style.position="absolute",s.style.zIndex=1,s.style.width=oTeamWidth+"px",s.style.height=oTeamWidth+"px",s.style.borderRadius=Math.round(oTeamWidth/2)+"px",s.style.opacity=.5,s.style.backgroundColor=cTeamColors.primary[aTeams[r]],oPlanTeams.push(s),oPlanCtn.appendChild(s);s=document.createElement("div");s.style.position="absolute",s.style.zIndex=1,s.style.width=oTeamWidth2+"px",s.style.height=oTeamWidth2+"px",s.style.borderRadius=Math.round(oTeamWidth2/2)+"px",s.style.opacity=.5,s.style.backgroundColor=cTeamColors.primary[aTeams[r]],oPlanTeams2.push(s),oPlanCtn2.appendChild(s)}for(r=0;r<aKarts.length;r++){var c=document.createElement("img");c.style.position="absolute",c.style.zIndex=1,c.style.width=oCharWidth+"px",c.src=getMapIcSrc(aKarts[r].personnage),c.className="pixelated",oPlanCharacters.push(c);c=document.createElement("img");c.style.position="absolute",c.style.zIndex=1,c.style.width=oCharWidth2+"px",c.src=getMapIcSrc(aKarts[r].personnage),c.className="pixelated",oPlanCharacters2.push(c)}if(timeTrialMode()&&1<oPlanCharacters.length){for(r=0;r<oPlanCharacters.length;r++)r&&(oPlanCharacters[r].style.opacity=jTrajets&&iTrajet===jTrajets[r-1]?0:.5),oPlanCtn.appendChild(oPlanCharacters[r]);for(r=0;r<oPlanCharacters2.length;r++)r&&(oPlanCharacters2[r].style.opacity=jTrajets&&iTrajet===jTrajets[r-1]?0:.5),oPlanCtn2.appendChild(oPlanCharacters2[r])}else{for(r=oPlanCharacters.length-1;0<=r;r--)oPlanCtn.appendChild(oPlanCharacters[r]);for(r=oPlanCharacters2.length-1;0<=r;r--)oPlanCtn2.appendChild(oPlanCharacters2[r])}for(r=0;r<e.arme.length;r++){fSprite=e.arme[r];var p=document.createElement("img");p.src="images/map_icons/objet.png",p.style.position="absolute",p.style.display="none",p.style.width=oObjWidth+"px",p.className="pixelated",posImg(p,fSprite[0],fSprite[1],Math.round(oPlayers[0].rotation),oObjWidth,oPlanSize),oPlanCtn.appendChild(p),oPlanObjects.push(p);p=document.createElement("img");p.src="images/map_icons/objet.png",p.style.position="absolute",p.style.display="none",p.style.width=oObjWidth2+"px",p.className="pixelated",posImg(p,fSprite[0],fSprite[1],Math.round(oPlayers[0].rotation),oObjWidth2,oPlanSize2),oPlanCtn2.appendChild(p),oPlanObjects2.push(p)}oPlanDiv.appendChild(oPlanCtn),document.body.appendChild(oPlanDiv),oPlanDiv2.appendChild(oPlanCtn2),updatePlanFullScreen()}function resetPlan(e){oPlanCharacters.length=0,oPlanObjects.length=0,oPlanCoins.length=0,oPlanPoisons.length=0,oPlanDecor={},oPlanAssets={},oPlanFauxObjets.length=0,oPlanBananes.length=0,oPlanBobOmbs.length=0,oPlanChampis.length=0,oPlanEtoilesDrop.length=0,oPlanCarapaces.length=0,oPlanCarapacesRouges.length=0,oPlanCarapacesBleues.length=0,oPlanCarapacesNoires.length=0,oPlanEtoiles.length=0,oPlanBillballs.length=0,oPlanTeams.length=0,oPlanCharacters2.length=0,oPlanObjects2.length=0,oPlanCoins2.length=0,oPlanDecor2={},oPlanAssets2={},oPlanFauxObjets2.length=0,oPlanBananes2.length=0,oPlanBobOmbs2.length=0,oPlanPoisons2.length=0,oPlanChampis2.length=0,oPlanEtoilesDrop2.length=0,oPlanCarapaces2.length=0,oPlanCarapacesRouges2.length=0,oPlanCarapacesBleues2.length=0,oPlanCarapacesNoires2.length=0,oPlanEtoiles2.length=0,oPlanBillballs2.length=0,oPlanTeams2.length=0,customDecorFetchHandlers=[{plan:oPlanDecor,list:{}},{plan:oPlanDecor2,list:{}}],removePlan(),initPlan(e),initCustomDecorsSprites(e)}function removePlan(){try{oPlanDiv.parentNode.removeChild(oPlanDiv)}catch(e){}try{oPlanDiv2.parentNode.removeChild(oPlanDiv2)}catch(e){}}var $speedometers=[],$speedometerVals=[],assetKeys=["oils","pivots","pointers","flippers","bumpers","flowers"];function loadMap(){function t(){var e=(new Date).getTime();(a+=e-n-SPF)<0?a=0:SPF<a&&(a=SPF),n=e,cycleHandler=setTimeout(t,SPF-a),runOneFrame()}var n,a;gameSettings=(gameSettings=localStorage.getItem("settings"))?JSON.parse(gameSettings):{},ctrlSettings=(ctrlSettings=localStorage.getItem("settings.ctrl"))?JSON.parse(ctrlSettings):{},isMobile()&&(void 0===ctrlSettings.autoacc&&(ctrlSettings.autoacc=1),void 0===ctrlSettings.vitem&&(ctrlSettings.vitem=1)),gameSettings.rtime&&(cycle=function(){a=SPF,n=(new Date).getTime(),t()}),1<strPlayer.length&&updateCtnFullScreen(!1),formulaire.dataset.disabled=1,iTeamPlay=isTeamPlay(),aTracksHist.push(1+aAvailableMaps.indexOf("map"+oMap.ref)),iRaceCount++,setSRest(),document.body.style.cursor="progress";for(var e=0;e<strPlayer.length;e++){var o=e*(iWidth*iScreenScale+2),i=document.createElement("div");i.style.position="absolute",i.style.left=oContainers[e].style.left,i.style.top=oContainers[e].style.top,i.style.width=iWidth*iScreenScale+"px",i.style.height=iHeight*iScreenScale+"px";var r=document.createElement("div");r.id="temps"+e,r.style.right=Math.round(.6*iScreenScale+1)+"px",r.style.top=Math.round(.4*iScreenScale+3)+"px",r.style.fontSize=Math.round(2.4*iScreenScale)+"px";var l=Math.round(iScreenScale/8)+"px",s=Math.round(iScreenScale/4)+"px";r.style.textShadow="-"+s+" 0 black, 0 "+s+" black, "+s+" 0 black, 0 -"+s+" black, -"+l+" -"+l+" black, -"+l+" "+l+" black, "+l+" -"+l+" black, "+l+" "+l+" black",i.appendChild(r);var c=document.createElement("div");if(c.id="compteur"+e,c.style.left=Math.round(iScreenScale/2)+"px",c.style.bottom=(course,Math.round(iScreenScale/4)+"px"),c.style.fontSize=Math.round(2.4*iScreenScale)+"px",!pause||!fInfos.replay)if("BB"!=course){c.innerHTML='<div></div><div class="glow"></div>';for(var p=c.querySelectorAll("div"),u=0;u<p.length;u++)p[u].style.height=Math.round(2.4*iScreenScale)+"px",p[u].innerHTML="<div>"+(oMap.sections?"SECTION":toLanguage("LAP","TOUR"))+' <span class="tour">1</span>/'+oMap.tours+"</div>",u||(l=Math.round(iScreenScale/8)+"px",s=Math.round(iScreenScale/4)+"px",p[u].style.textShadow="-"+s+" 0 black, 0 "+s+" black, "+s+" 0 black, 0 -"+s+" black, -"+l+" -"+l+" black, -"+l+" "+l+" black, "+l+" -"+l+" black, "+l+" "+l+" black")}else{var d=aTeams[e];null==d&&(d=-1),updateBalloonHud(c,{reserve:4,team:d})}i.appendChild(c);var m=document.createElement("div");m.id="objet"+e,m.className="itemWheel",pause&&fInfos.replay||(m.style.left=Math.round(iScreenScale)+"px",m.style.top=Math.round(iScreenScale)+"px",m.style.width=Math.round(26*iScreenScale/3)+"px",m.style.height=Math.round(18*iScreenScale/3)+"px",m.style.visibility="visible");d=document.createElement("div");d.id="roulette"+e,d.className="itemChamber",m.appendChild(d);c=document.createElement("div");c.id="countdown"+e,c.style.position="absolute",c.style.opacity=.8,c.style.width=Math.round(6.6*iScreenScale)+"px",c.style.height=Math.round(4.2*iScreenScale)+"px",c.style.border="solid "+Math.round(.75*iScreenScale)+"px "+primaryColor,c.style.borderRadius=Math.round(1.75*iScreenScale)+"px",c.style.display="none",m.appendChild(c),i.appendChild(m);c=document.createElement("div");c.id="reserve"+e,c.className="itemWheel",pause&&fInfos.replay||(c.style.left=Math.round(.75*iScreenScale)+"px",c.style.top=Math.round(iScreenScale)+"px",c.style.width=Math.round(26*iScreenScale/5)+"px",c.style.height=Math.round(18*iScreenScale/5)+"px",c.style.visibility="hidden"),(d=document.createElement("div")).id="roulette2"+e,d.className="itemChamber",c.appendChild(d),i.appendChild(c);d=document.createElement("div");d.id="lakitu"+e,d.className="pixelated",d.innerHTML="<div></div>",d.style.width=9*iScreenScale+"px",d.style.height=Math.round(6.6*iScreenScale)+"px",d.style.fontSize=Math.round(2.3*iScreenScale)+"px",i.appendChild(d);d=document.createElement("div");d.id="infoPlace"+e,d.style.right=Math.round(iScreenScale/2)+"px",d.style.bottom="0px",d.style.fontSize=8*iScreenScale+"px",i.appendChild(d);d=document.getElementById("infos"+e);d||((d=document.getElementById("infos0").cloneNode(!0)).id="infos"+e,$mkScreen.appendChild(d)),d.style.left=10+o+"px",d.style.top=10*iScreenScale+"px",d.style.width=iWidth*iScreenScale+"px",d.style.fontSize=16*iScreenScale+"px",d.style.fontFamily='"NSMBU", Impact',d.style.textAlign="center",d.style.textStroke=d.style.WebkitTextStroke=d.style.MozTextStroke=Math.round(iScreenScale/4)+"px "+primaryColor,d.style.visibility="hidden",d.style.display="",d.style.pointerEvents="none",d.innerHTML='<tr><td id="decompte'+e+'">3</td></tr>';var h=document.getElementById("scroller").cloneNode(!0);h.id="scroller"+e,h.className="itemScroller";h.style.left=iScreenScale+"px",h.style.top=Math.round(iScreenScale+ +iScreenScale)+"px",h.style.width=Math.round(26*iScreenScale/3)+"px",h.style.height=Math.round(18*iScreenScale/3-2*iScreenScale*1)+"px",h.style.lineHeight=iScreenScale+"px";for(var g=Math.round(4*iScreenScale),u=0;u<h.getElementsByClassName("aObjet").length;u++)h.getElementsByClassName("aObjet")[u].style.height=g+"px";i.appendChild(h);var y=document.getElementById("scroller").cloneNode(!0);y.id="scroller2"+e,y.className="itemScroller",y.style.left=Math.round(.75*iScreenScale)+"px",y.style.top=Math.round(iScreenScale+.6*iScreenScale)+"px",y.style.width=Math.round(26*iScreenScale/5)+"px",y.style.height=Math.round(18*iScreenScale/5-2*iScreenScale*.6)+"px",y.style.lineHeight=iScreenScale+"px",g=Math.round(2.5*iScreenScale);for(u=0;u<y.getElementsByClassName("aObjet").length;u++)y.getElementsByClassName("aObjet")[u].style.height=g+"px";i.appendChild(y),$mkScreen.appendChild(i),hudScreens[e]=i,onlineSpectatorId?(r.style.display="none",h.style.display="none",y.style.display="none",m.style.display="none",c.style.display="none"):gameSettings.spd&&((r=document.createElement("div")).className="speedometer",r.style.right=Math.round(.85*iScreenScale)+"px",r.style.top=Math.round(3.2*iScreenScale)+"px",r.style.fontSize=Math.round(1.9*iScreenScale)+"px",r.style.visibility="hidden",(m=document.createElement("span")).innerHTML="-.-",r.appendChild(m),(c=document.createElement("span")).innerHTML=" km/h",r.appendChild(c),i.appendChild(r),$speedometers.push(r),$speedometerVals.push(m))}(oChallengeCpts=document.createElement("div")).id="challenge-cpts",oChallengeCpts.style.right=Math.round(.85*iScreenScale)+"px",oChallengeCpts.style.top=Math.round(iScreenScale*($speedometers.length?5.5:3.2))+"px",oChallengeCpts.style.fontSize=Math.round(1.9*iScreenScale)+"px",oChallengeCpts.style.visibility="hidden",i.appendChild(oChallengeCpts),initMap(),removeMenuMusic(),bMusic&&!isOnline&&loadMapMusic()}function getShapeType(e){return"number"==typeof e[0]?"rectangle":"polygon"}function classifyByShape(e,t){for(var n={rectangle:[],polygon:[]},a=0;a<e.length;a++){var o=getShapeType(e[a]);t&&t(a,n[o].length,o),n[o].push(e[a])}return n}var foreachLMap=function(e){e(oMap,oMap,0)},getCurrentLMap=function(){return oMap},getCurrentLapId=function(){return 0},lapInteractionsDisabled=function(){return!1},itemInteractionsDisabled=function(){return!1},getItemCollisionLap=function(){return 0};function initMap(){if(lMaps=[oMap],pMaps=[oMap],oMap.lapOverrides){for(var i=oMap.lapOverrides,e=0;e<i.length;e++)lMaps.push(Object.assign({},lMaps[e],i[e])),pMaps.push(Object.assign({},i[e]));foreachLMap=function(e){for(var t=0;t<lMaps.length;t++)e(lMaps[t],pMaps[t],t)},getCurrentLMap=function(e){return e>=lMaps.length&&(e=lMaps.length-1),lMaps[e]||oMap};getCurrentLapId=function(e){if(e._lapOverrideCache&&e._lapOverrideCache.tours===e.tours&&e._lapOverrideCache.cp===e.demitours)return e._lapOverrideCache.lapId;var t=function(e){var t=e.tours-1,n=e.demitours;oMap.sections&&n>=oMap.checkpoint.length-1&&(n=-1);for(var a=0;a<i.length;a++){var o=i[a];if(o.lap>t)return a;if(o.lap===t&&o.cp>n)return a}return i.length}(e);return e.sprite&&(e._lapOverrideCache={tours:e.tours,cp:e.demitours,lapId:t}),t};for(var n={},e=0;e<pMaps.length;e++){var t={},a=pMaps[e].lapInteractions;if(a){for(var o=0;o<pMaps.length;o++)t[o]=!0;delete t[e];for(o=0;o<a.length;o++)delete t[a[o]]}n[e]=t}for(e=0;e<pMaps.length;e++)for(var o in n[e])n[o][e]=!0;Object.keys(n).length&&(lapInteractionsDisabled=function(e,t){return n[e]&&n[e][t]},itemInteractionsDisabled=function(e){return lapInteractionsDisabled(collisionLap,getItemCollisionLap(e))},getItemCollisionLap=function(e){return 0<=e.ailap?e.ailap:e.lapId})}if(clSelected)for(var r=listChallengeRules(clSelected.data),o=0;o<r.length;o++){var l=r[o];challengeRules[l.type].preinitSelected&&challengeRules[l.type].preinitSelected(l)}foreachLMap(function(t,e,n){var a,o,i,r=t===oMap;function l(){t.mapImg=o;for(var e=n+1;e<lMaps.length;e++){if(pMaps[e].img)return;lMaps[e].mapImg=o}}t.mapImg=oMap.mapImg,(r||e.img)&&(a=isCup?complete?t.img:"mapcreate.php"+t.map:"images/maps/map"+t.map+"."+t.ext,(t.ext?"gif"===t.ext:a.match(/\.gif$/g))?gameSettings.nogif?((i=new Image).onload=function(){(o=document.createElement("canvas")).width=i.naturalWidth,o.height=i.naturalHeight,o.getContext("2d").drawImage(i,0,0),startGame()},i.src=a):(o=GIF(),r?((t.mapImg=o).onloadone=startGame,o.onloadall=function(){oPlanImg&&(oPlanImg.src=a),oPlanImg2&&(oPlanImg2.src=a)}):o.onloadone=l,o.load(a)):(o=new Image,r?(t.mapImg=o).onload=startGame:o.onload=l,o.src=a))}),oMap.maxCheckpoints=0,oMap.minCheckpoints=1/0,foreachLMap(function(a){var o;if(a.collision&&(o={rectangle:{},polygon:{}},a.collision=classifyByShape(a.collision,a.collisionProps&&function(e,t,n){o[n][t]=a.collisionProps[e]}),a.collisionProps=o),a.pivots)for(var e=0;e<a.pivots.length;e++){var t=a.pivots[e][1],n=t[0],i=t[1],r=Math.round(t[2]/2),l=Math.round(t[3]/2);a.collision.polygon.push([[n-r,i],[n,i-l],[n+r,i],[n,i+l]])}if(a.horspistes){var s,c={};for(s in a.horspistes)c[s]=classifyByShape(a.horspistes[s]);a.horspistes=c}if(a.checkpoint?a.checkpointCoords=a.checkpoint.map(function(e){return getCheckpointCoords(e)}):a.checkpointCoords=[],oMap.maxCheckpoints=Math.max(oMap.maxCheckpoints,a.checkpointCoords.length),oMap.minCheckpoints=Math.min(oMap.minCheckpoints,a.checkpointCoords.length),a.aipoints&&!a.airoutesmeta&&(a.airoutesmeta={cpu:a.aipoints.length}),a.flowers)for(e=0;e<a.flowers.length;e++){var p=a.flowers[e][1],n=p[0],i=p[1],r=Math.round(p[2]/2),l=Math.round(p[3]/2);a.horspistes.herbe.rectangle.push([n-r,i-r,2*r,2*l])}if(a.trous){var u={};for(e in a.trous){for(var d={rectangle:[],polygon:[]},m=0;m<a.trous[e].length;m++){var h=a.trous[e][m];6==h.length&&(h=[[h[0],h[1],h[2],h[3]],[h[4],h[5]]]),d[getShapeType(h[0])].push(h)}u[e]=d}if(a.extraHoles)for(var g in a.extraHoles)u[g]=classifyByShape(a.extraHoles[g]);a.trous=u}if(a.flows){for(var y={rectangle:[],polygon:[]},e=0;e<a.flows.length;e++){var f=a.flows[e];y[getShapeType(f[0])].push(f)}a.flows=y}if(a.accelerateurs){a.accelerateurs=classifyByShape(a.accelerateurs);for(var S=a.accelerateurs.rectangle,e=0;e<S.length;e++)(v=S[e])[2]?(v[2]++,v[3]++):(v[2]=9,v[3]=9)}if(a.sauts){for(var v,b,C={rectangle:[],polygon:[]},e=0;e<a.sauts.length;e++){if(!(v="number"==typeof(v=a.sauts[e])[0]?(b="rectangle",[v.slice(0,4),v[4]]):(b=getShapeType(v[0]),[v[0],v[1]]))[1]){var x,M,P=v[0];switch(b){case"rectangle":x=P[2],M=P[3];break;case"polygon":for(var k=2*a.w,I=-a.w,w=2*a.h,L=-a.h,m=0;m<P.length;m++){var T=P[m];k=Math.min(k,T[0]),I=Math.max(I,T[0]),w=Math.min(w,T[1]),L=Math.max(L,T[1])}x=I-k,M=L-w}v[1]=(x+M)/45+1}C[b].push(v)}a.sauts=C}if(a.cannons){for(var E={rectangle:[],polygon:[]},e=0;e<a.cannons.length;e++){var D=a.cannons[e];E[getShapeType(D[0])].push(D)}a.cannons=E}if(a.teleports){for(var B={rectangle:[],polygon:[]},e=0;e<a.teleports.length;e++){var O=a.teleports[e];B[getShapeType(O[0])].push(O)}a.teleports=B}if(a.elevators){for(var z={rectangle:[],polygon:[]},e=0;e<a.elevators.length;e++){var H=a.elevators[e];z[getShapeType(H[0])].push(H)}a.elevators=z}if(a.sea){var R=a.sea.waves;a.sea.projections=[];for(e=0;e<R.length;e++){for(var A=R[e][0],N=R[e][1],_=[],V=0,F=3+Math.ceil(3*N.length/A.length),m=0;m<N.length;m++){for(var j,K=N[m][0],W=N[m][1],q=1/0,g=0;g<A.length;g++)if((g+A.length-V)%A.length>=F){if(V<g)break;g=V-1}else{var G=g,J=(g+1)%A.length;1<(X=projete(K,W,A[G][0],A[G][1],A[J][0],A[J][1]))&&(X=1),X<0&&(X=0);var $=A[G][0]+X*(A[J][0]-A[G][0]),U=A[G][1]+X*(A[J][1]-A[G][1]),X=($-K)*($-K)+(U-W)*(U-W);X<q&&(q=X,k=$,w=U,j=G)}j<V&&(j+=A.length);for(g=V;g<j;g++){J=(g+1)%A.length;_.push([K,W,A[J][0],A[J][1]])}V=j%A.length,_.push([K,W,k,w])}a.sea.projections.push(_)}function Y(e,t){return[e[2]+(e[0]-e[2])*t,e[3]+(e[1]-e[3])*t]}a.sea.progress=.9999,a.sea.offroad0=a.horspistes.eau.polygon,a.sea.drawPolygon=function(e,t,n,a){e.beginPath();for(var o=0;o<t.length;o++){var i=t[o],i=[(i[0]-n[0])*a,(i[1]-n[1])*a];o?e.lineTo(i[0],i[1]):e.moveTo(i[0],i[1])}e.closePath(),e.fill(),e.stroke()},a.sea.render=function(e,t,n){var a=this.progress,o=this.waves,i=.99*a,r=a-.25*(1-a/2),l=a-.04*(1-a/3);if(e.lineWidth=1,0<r)for(var s=0;s<o.length;s++){var c=this.polygon(s,0,i);e.fillStyle=e.strokeStyle=this.color(s,"water"),this.drawPolygon(e,c,t,n)}else r=0;if(0<l)for(s=0;s<o.length;s++){c=this.polygon(s,r,i);e.fillStyle=e.strokeStyle=this.color(s,"wave"),this.drawPolygon(e,c,t,n)}else l=0;if(.005<a)for(s=0;s<o.length;s++){c=this.polygon(s,l,1.04*a);e.fillStyle=e.strokeStyle=this.color(s,"foam"),this.drawPolygon(e,c,t,n)}},gameSettings.nowater&&(a.sea.render=function(){}),a.sea.color=function(e,t){return(this["colors."+e]||this.colors)[t]},a.sea.polygon=function(e,t,n){var a=this.waves[e][0],o=[],i=this.projections[e];if(t){s=Y(i[0],t),o.push(s);for(var r=0;r<i.length;r++){var l=Y(i[r],t);o.push(l)}o.push(s)}else{s=a[0],o.push(s);for(r=1;r<a.length;r++){l=a[r];o.push(l)}o.push(s)}var e=i.length-1,s=Y(i[e],n);o.push(s);for(r=e-1;0<=r;r--){l=Y(i[r],n);o.push(l)}return o.push(s),o}}})}var timer=0,timerMS,lapTimers=new Array,oLapTimeDiv;iScreenScale=optionOf("screenscale");var fMaxRotInc=6,fTurboDriftCpt=80,fTurboDriftCpt2=160;function throwItem(e,t,n){var a=e.using[n||0];if(a){for(var o in t)a[o]=t[o];isOnline&&syncItems.push(a),e.using.shift()}return a}function loadNewItem(e,t){addNewItem(e,t),e.using.push(t)}function dropNewItem(e,t){switch(t.type){case"carapace":t.vx=0,t.vy=0,t.owner=-1,t.lives=10;break;case"carapace-rouge":t.theta=-1,t.owner=-1,t.aipoint=-2,t.aimap=-1,t.ailap=0,t.target=-1}addNewItem(e,t)}function addNewItem(e,t){var n,a=t.type,o=itemBehaviors[a];if(!1!==o.sprite&&(t.sprite=new Sprite(a),t.size=o.size),e&&(t.lapId=getCurrentLapId(e)),items[a].push(t),isOnline?!e||e.id!=identifiant&&e.controller!=identifiant||syncItems.push(t):e==oPlayers[0]&&clLocalVars.myItems&&clLocalVars.myItems.push(t),-1!=t.team){switch(a){case"champi":case"etoile":break;case"banane":n=50;break;case"poison":n=60;break;case"carapace":case"carapace-rouge":n=60;break;case"fauxobjet":n=65;break;case"carapace-bleue":case"carapace-noire":n=60;break;case"bobomb":n=40;break;default:n=60}if(n){var i=50-n,r=50-n;switch(a){case"banane":case"poison":case"bobomb":r+=5;break;case"fauxobjet":r-=5}for(var l=0;l<oPlayers.length;l++){var s,c=document.createElement("div");c.className="sprite-hallow",c.style.position="absolute",c.style.left=i+"%",c.style.top=r+"%",c.style.width=2*n+"%",c.style.height=2*n+"%",c.style.borderRadius=n+"%",c.style.backgroundColor=cTeamColors.primary[t.team],c.style.opacity=.25,t.sprite&&((s=t.sprite[l].div.firstChild)?t.sprite[l].div.insertBefore(c,s):t.sprite[l].div.appendChild(c))}}}}function setStarState(e,t){for(var n=0;n<strPlayer.length;n++)e.sprite[n].img.src=getStarSrc(e.personnage);e.cpu||e.etoile||(isOnline||(e.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},interruptGame(),bCounting=!0),shouldPlaySound(e)&&!oPlayers[1]&&postStartMusic("musics/events/starman.mp3")),0<e.speedinc&&(e.speedinc*=5),delete e.shift,e.protect=!0,e.etoile=t}var CHAMPI_TYPE_ITEM=1,CHAMPI_TYPE_BOOST=2;function arme(e,t,n){var a=aKarts[e];if(a.using.length){var o=a.x,i=a.y;switch(collisionLap=getCurrentLapId(a),a.using[0].type){case"banane":case"fauxobjet":case"poison":n?(throwItem(a,{x:o,y:i,z:.01,theta:a.rotation,countdown:15}),playDistSound(a,"musics/events/throw.mp3",50)):(y=throwItem(a,{x:o-(p=30/(a.speed+5))*direction(0,a.rotation),y:i-p*direction(1,a.rotation),z:0}),playIfShould(a,"musics/events/put.mp3"),tombe(y.x,y.y)&&detruit(y));break;case"carapace":var r=dirShoot(a,t,3.2),l=angleShoot(a,t),s=r[0],c=r[1],p=(p=Math.hypot(s,c))||1,r=t?7.5:6+p;1<a.using.length&&(r+=5),checkItemLap(c=throwItem(a,{x:o+r*s/p,y:i+r*c/p,z:0,vx:s,vy:c,owner:a.id,lives:10}),{aPos:[o,i],fast:!0}),playDistSound(a,"musics/events/throw.mp3",50);break;case"carapace-rouge":l=angleShoot(a,t),r=7.5;t?1<a.using.length&&(r*=1.5):(r*=1.5,r+=a.speed,1<a.using.length&&(r*=4/3));b=getCurrentLapId(a);checkItemLap(c=t?{x:o+r*direction(0,l),y:i+r*direction(1,l),z:0,theta:l,owner:a.id,aipoint:-2,aimap:-1,ailap:b,ailapt:a.tours,target:-1}:{x:o+r*direction(0,l),y:i+r*direction(1,l),z:0,theta:l,owner:a.id,aipoint:-1,aimap:-1,ailap:b,ailapt:a.tours,ailapc:1,target:-1},{aPos:[o,i],fast:!0}),throwItem(a,c),playDistSound(a,"musics/events/throw.mp3",50);break;case"bobomb":l=angleShoot(a,t);throwItem(a,t?{x:o+5*direction(0,l),y:i+5*direction(1,l),z:0,theta:l,countdown:2,cooldown:42}:{x:o,y:i,z:0,theta:l,countdown:15,cooldown:30}),playDistSound(a,"musics/events/throw.mp3",50)}a.using.length||consumeItemIfDouble(e)}else if(25==a.roulette){a==oPlayers[0]&&(clLocalVars.itemsUsed=!0);var u,d,m=a.arme;switch(a.arme){case"champi":case"champiX2":case"champiX3":m="champi",u=20,a.champiType=CHAMPI_TYPE_ITEM,a.maxspeed=11,a.speed=a.maxspeed*cappedRelSpeed(a),playIfShould(a,"musics/events/boost.mp3");break;case"champior":m="champi",a.champi<12&&(u=20,a.champiType=CHAMPI_TYPE_ITEM,a.maxspeed=11,a.speed=a.maxspeed*cappedRelSpeed(a),playIfShould(a,"musics/events/boost.mp3"),a.champior||(a.champior=70,a.champior0=a.champior));break;case"etoile":setStarState(a,u=80);break;case"billball":if(a.billball)break;u=Math.max(Math.min(Math.round(distanceToFirst(a)/(9*cappedRelSpeed())),120),40),a.billball0=u;for(var h=0;h<strPlayer.length;h++)a.sprite[h].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(a.sprite[h]);a.cpu||isOnline||(a.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},interruptGame(),bCounting=!0),a.rotinc=0,a.size=2.5,a.mini=0,a.z=2,a.heightinc=0,a.protect=!0,a.champi=0,delete a.champiType,delete a.shift,resetPowerup(a),playIfShould(a,"musics/events/boost.mp3"),stopDrifting(e);break;case"megachampi":u=80,a.size=1,a.mini=0,a.protect=!0,a.megachampi||!shouldPlaySound(a)||oPlayers[1]||postStartMusic("musics/events/megamushroom.mp3");break;case"banane":loadNewItem(a,{type:"banane",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z}),playIfShould(a,"musics/events/item_store.mp3");break;case"bananeX3":for(h=0;h<3;h++)loadNewItem(a,{type:"banane",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z});a.rotitem=0,playIfShould(a,"musics/events/item_store.mp3");break;case"fauxobjet":loadNewItem(a,{type:"fauxobjet",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z}),playIfShould(a,"musics/events/item_store.mp3");break;case"poison":loadNewItem(a,{type:"poison",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z}),playIfShould(a,"musics/events/item_store.mp3");break;case"carapace":loadNewItem(a,{type:"carapace",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z,vx:0,vy:0,owner:-1,lives:10}),playIfShould(a,"musics/events/item_store.mp3");break;case"carapaceX3":for(h=0;h<3;h++)loadNewItem(a,{type:"carapace",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z,vx:0,vy:0,owner:-1,lives:10});a.rotitem=0,playIfShould(a,"musics/events/item_store.mp3");break;case"carapacerouge":loadNewItem(a,{type:"carapace-rouge",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z,theta:-1,owner:-1,aipoint:-1,aimap:-1,ailap:-1,target:-1}),playIfShould(a,"musics/events/item_store.mp3");break;case"carapacerougeX3":for(h=0;h<3;h++)loadNewItem(a,{type:"carapace-rouge",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z,theta:-1,owner:-1,aipoint:-1,aimap:-1,ailap:-1,target:-1});a.rotitem=0,playIfShould(a,"musics/events/item_store.mp3");break;case"carapacebleue":var g,y,f=1/0,S=0,v=0,b=0;if("BB"!=course){b=getCurrentLapId(a),g=getCurrentLMap(b),(I=a.demitours+1)>=g.checkpoint.length&&(I=0);for(h=0;h<g.airoutesmeta.cpu;h++)for(var C=g.aipoints[h],x=0;x<C.length;x++){var M=C[x],P=C[(x||C.length)-1],k=Math.hypot(M[0]-a.x,M[1]-a.y);0<(M[0]-a.x)*(M[0]-P[0])+(M[1]-a.y)*(M[1]-P[1])||(k+=g.w+g.h),(w=g.checkpointCoords[I])&&(L=w.O[0],T=w.O[1],(E=Math.hypot(L-a.x,T-a.y)*Math.hypot(M[0]-P[0],M[1]-P[1]))&&(k-=150*((L-a.x)*(M[0]-P[0])+(T-a.y)*(M[1]-P[1]))/E)),k<f&&(v=h,S=x,f=k)}}addNewItem(a,y={type:"carapace-bleue",team:a.team,x:a.x,y:a.y,z:15,target:-1,aipoint:S,aimap:v,ailap:b,ailapt:a.tours,ailapc:1,cooldown:itemBehaviors["carapace-bleue"].cooldown0}),playDistSound(a,"musics/events/throw.mp3",50);break;case"carapacenoire":f=1/0,S=0,v=0;if("BB"!=course)for(h=0;h<oMap.airoutesmeta.cpu;h++)for(C=oMap.aipoints[h],x=0;x<C.length;x++){var I,w,L,T,E,M=C[x],P=C[(x||C.length)-1],k=Math.hypot(M[0]-a.x,M[1]-a.y);0<(M[0]-a.x)*(M[0]-P[0])+(M[1]-a.y)*(M[1]-P[1])||(k+=oMap.w+oMap.h),(I=a.demitours+1)>=oMap.checkpoint.length&&(I=0),(w=oMap.checkpointCoords[I])&&(L=w.O[0],T=w.O[1],(E=Math.hypot(L-a.x,T-a.y)*Math.hypot(M[0]-P[0],M[1]-P[1]))&&(k-=150*((L-a.x)*(M[0]-P[0])+(T-a.y)*(M[1]-P[1]))/E)),k<f&&(v=h,S=x,f=k)}addNewItem(a,{type:"carapace-noire",team:a.team,x:a.x,y:a.y,z:15,target:-1,aipoint:S,aimap:v,cooldown:itemBehaviors["carapace-noire"].cooldown0}),playDistSound(a,"musics/events/throw.mp3",50);break;case"bobomb":loadNewItem(a,{type:"bobomb",team:a.team,x:a.x-5*direction(0,a.rotation),y:a.y-5*direction(1,a.rotation),z:a.z,theta:-1,countdown:15,cooldown:30}),playIfShould(a,"musics/events/item_store.mp3");break;case"eclair":addNewItem(a,{type:"eclair",owner:a.id});break;case"bloops":addNewItem(a,{type:"bloops",owner:a.id});break;case"pow":addNewItem(a,{type:"pow",owner:a.id})}switch(u&&(a[m]=u),a.arme){case"champiX2":d="champi";break;case"champiX3":d="champiX2";break;case"champior":d="champior";break;case"billball":d="billball"}if(d){if(a.arme!==d)a.arme=d,kartIsPlayer(a)&&updateObjHud(e);else if(kartIsPlayer(a))switch(d){case"champior":var D=document.getElementById("roulette"+e).getElementsByTagName("img")[0],B=0;!function e(){var t=(++B-3)/3,t=.8+.2*t*t;1<=t?D.style.transform="":(D.style.transform="scale("+t+")",setTimeout(e,SPF))}(),updateItemCountdownHud(e,a.champior/a.champior0);break;case"billball":updateItemCountdownHud(e,a.billball/a.billball0)}}else a.using.length&&oDoubleItemsEnabled||consumeItem(e)}}var aKarts=new Array,bRunning=!1,bCounting=!1,musicIdInc=0,mapMusic,lastMapMusic,endingMusic,endGPMusic,challengeMusic,carEngine,carEngine2,carEngine3,carDrift,carSpark;function loadMusic(e,t,n){var a,o,i=isOriginalMusic(e);return i?(o=document.createElement("audio")).setAttribute("loop",!0):(n=n||{},a=youtube_parser(e),(o=document.createElement("iframe")).id="youtube-video-"+musicIdInc++,o.src="https://www.youtube.com/embed/"+a+"?"+(t?"autoplay=1&amp;":"")+(n.start?"":"loop=1&amp;")+"enablejsapi=1&amp;allow=autoplay",o.opts=n,o.setAttribute("enablejsapi",1),o.setAttribute("allow","autoplay")),o.className="gamemusic",i&&((i=document.createElement("source")).type="audio/mpeg",o.src=e,n&&null!=n.vSnd?o.volume=n.vSnd:o.volume=vSfx,o.appendChild(i),t&&o.setAttribute("autoplay",!0)),o}function pauseMusic(e){isOriginalEmbed(e)?e.pause():onPlayerReady(e,function(e){e.pauseVideo()}),oMusicEmbed==e&&(oMusicEmbed=void 0)}function bufferMusic(e,t){var n,a;isOriginalEmbed(e)?t&&setTimeout(t,1):(options=e.opts||{},n=options.start||0,a=options.speed,onPlayerReady(e,function(e){e.setVolume(0),n&&e.seekTo(n,!0),e.playVideo(),setTimeout(function(){e.pauseVideo(),a&&e.setPlaybackRate(a),e.seekTo(n,!0),e.setVolume(100*vMusic),t&&t()},1e3)}))}function stopMusic(e){e&&(e.permanent?pauseMusic:removeIfExists)(e)}function unpauseMusic(e){document.body.contains(e)&&(isOriginalEmbed(e)?e.play():onPlayerReady(e,function(e){e.playVideo()}),oMusicEmbed=e)}function muteSound(e){isOriginalEmbed(e)?e.muted=!0:onPlayerReady(e,function(e){e.mute()})}function unmuteSound(e){isOriginalEmbed(e)?e.muted=!1:onPlayerReady(e,function(e){e.unMute()})}function onPlayerReady(t,e){try{var n;t.yt?t.tasks?t.tasks.push(e):e(t.yt):(n=t.opts||{},t.tasks=[e],t.yt=new YT.Player(t.id,{events:{onReady:function(){for(var e=0;e<t.tasks.length;e++)t.tasks[e](t.yt);delete t.tasks},onStateChange:function(e){e.data===YT.PlayerState.ENDED&&n.start&&t.yt.seekTo(n.start,!0)}}}))}catch(e){}}function updateMusic(n,a){n!=oMusicEmbed&&removeIfExists(oMusicEmbed),document.body.contains(n)&&(isOriginalEmbed(n)?(a&&(n.playbackRate=1.2),n.volume=vMusic,n.currentTime=0,n.play()):onPlayerReady(n,function(e){var t=n.opts||{};t.speed?e.setPlaybackRate(t.speed):a&&e.setPlaybackRate(1.25);t=t.start||0;e.seekTo(t,!0),e.setVolume(100*vMusic),e.playVideo()}),oMusicEmbed=n)}function fastenMusic(e){isOriginalEmbed(e)?e.playbackRate=1.2:onPlayerReady(e,function(e){e.setPlaybackRate(1.25)})}function shouldPlaySound(e){return iSfx&&kartIsPlayer(e)&&!finishing&&!e.loose}function shouldPlayMusic(e){return bMusic&&kartIsPlayer(e)&&!finishing&&!e.loose}function playIfShould(e,t){if(shouldPlaySound(e))return playSoundEffect(t)}function playSoundEffect(e){e=loadMusic(e,!0);return e.removeAttribute("loop"),e.onended=function(){document.body.removeChild(this)},document.body.appendChild(e),e}function playDistSound(e,t,n){if(iSfx){e=n/distKart(e);if(1<=e){t=playSoundEffect(t);return t.volume=Math.min(.05*e*e,1)*vSfx,t}}}function startMusic(e,t,n,a){var o,i=loadMusic(e,t,a);return null!=i.volume&&(a&&null!=a.vSnd?i.volume=a.vSnd:i.volume=vMusic),document.body.appendChild(i),n?(pauseMusic(i),o=oMusicEmbed,setTimeout(function(){oMusicEmbed==i&&(stopMusic(o),unpauseMusic(i))},n),oMusicEmbed=i):t&&(stopMusic(oMusicEmbed),oMusicEmbed=i),i}function postStartMusic(e){var t=bMusic?vMusic:vSfx;return oMusicEmbed&&fadeOutMusic(oMusicEmbed,1,.6,!1,t),startMusic(e,!0,200,{vSnd:t})}function postResumeMusic(e,t){var n;oMusicEmbed!=e&&(fadeOutMusic(n=oMusicEmbed,1,t,!0,bMusic?vMusic:vSfx),e&&setTimeout(function(){oMusicEmbed!=n&&oMusicEmbed||(fadeInMusic(e,.2,t),unpauseMusic(e))},500))}function stopStarMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.9)}function stopMegaMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.92)}function resetPowerup(e){e.etoile&&(e.etoile=0,stopStarMusic(e)),e.megachampi&&(e.megachampi=0,stopMegaMusic(e))}function isOriginalMusic(e){return-1!=e.indexOf("mp3")}function isOriginalEmbed(e){return"audio"==e.tagName.toLowerCase()}var willPlayEndMusic=!1,isEndMusicPlayed=!1,forceStartMusic=!1,forcePrepareEnding=!1,playingCarEngine;function loadMapMusic(){var e;startMapMusic(!1),loadEndingMusic(),mapMusic.blur(),endingMusic.blur(),isMobile()||isChatting()||(e=document.createElement("input"),document.body.appendChild(e),e.focus(),e.blur(),document.body.removeChild(e))}function startMapMusic(e){e?(lastMapMusic&&mapMusic!==lastMapMusic&&(removeIfExists(mapMusic),mapMusic=lastMapMusic),e=mapMusic!==lastMapMusic&&!oMap.lastMapSpeed,updateMusic(mapMusic,e)):foreachLMap(function(e,t,n){var a;void 0===t.music&&void 0===t.yt||(a=t.yt_opts||{},e.mapMusic=startMusic(t.music?"musics/maps/map"+t.music+".mp3":t.yt,!1,0,a),e.mapMusic.permanent=1,bufferMusic(e.mapMusic,function(){endingMusic&&t.music&&bufferMusic(endingMusic)}),t.mapMusic=e.mapMusic,n||(mapMusic=e.mapMusic,!n&&a.last&&((lastMapMusic=startMusic(a.last.url,!1,0,a.last)).permanent=1)))})}function loadEndingMusic(){var e=getEndingSrc(strPlayer[0]);(endingMusic=startMusic(e)).permanent=1}function updateMapMusic(t){if(t&&t.mapMusic&&t.mapMusic!==mapMusic){var n=mapMusic;bufferMusic(mapMusic=t.mapMusic),fadeOutMusic(n,1,.8,null,vMusic);var a=t.lap===oMap.tours-1;if(a&&!t.cp)return removeIfExists(n),void(t.yt&&(oMap.lastMapSpeed=1));setTimeout(function(){removeIfExists(n);var e=a&&!t.yt_opts;updateMusic(mapMusic,e)},1e3)}}function loopWithoutGap(){playingCarEngine!=this||this.currentTime>this.duration-.44&&(this.currentTime=0,this.parentNode&&this.play())}function loopAfterIntro(e,t,n){var a;e.looper||(a=t+(n-=.15),e.looper=function(){this.currentTime>=a&&(this.currentTime-=n)},e.addEventListener("timeupdate",e.looper,!1))}function startEngineSound(){iSfx&&(carEngine=loadMusic("musics/events/engine.mp3",!0),carEngine2=loadMusic("musics/events/engine2.mp3",!1),carEngine3=loadMusic("musics/events/engine3.mp3",!1),carDrift=loadMusic("musics/events/drift.mp3",!1),carSpark=loadMusic("musics/events/spark.mp3",!1),(playingCarEngine=carEngine).addEventListener("timeupdate",loopWithoutGap,!1),carEngine2.addEventListener("timeupdate",loopWithoutGap,!1),carEngine.permanent=1,carEngine2.permanent=1,carEngine3.permanent=1,carDrift.permanent=1,carSpark.permanent=1,document.body.appendChild(carEngine),document.body.appendChild(carEngine2),document.body.appendChild(carEngine3),document.body.appendChild(carDrift),document.body.appendChild(carSpark))}function updateEngineSound(e){iSfx&&e!=playingCarEngine&&(playingCarEngine&&playingCarEngine.pause(),(playingCarEngine=e)&&playingCarEngine.play())}function startEndMusic(){bMusic&&(removeMenuMusic(!0),removeMapMusics()),iSfx&&removeSoundEffects(),bMusic&&(willPlayEndMusic=!0,setTimeout(function(){for(var e=document.getElementsByClassName("gamemusic"),t=[],n=0;n<e.length;n++)e[n].permanent||t.push(e[n]);for(n=0;n<t.length;n++)document.body.removeChild(t[n]);willPlayEndMusic&&(isEndMusicPlayed=!(willPlayEndMusic=!1),unpauseMusic(endingMusic),endingMusic.yt&&onPlayerReady(endingMusic,function(e){e.setVolume(100*vMusic)}))},200)),iSfx&&"BB"!=course&&(playSoundEffect("musics/events/goal.mp3").className="")}function handleEndRace(){(bMusic||iSfx)&&startEndMusic();var e=["next_circuit"];challengeCheck("end_game",e),challengeCheck("end_gp",e),clGlobalVars.nbcircuits++}function startGame(){resetScreen();var a=strPlayer.length+aPlayers.length;if(!isOnline)if("BB"==course)for(var e=0;e<a;e++)aPlaces[e]=e+1;else"CM"==course&&(aPlaces=[1]);isTeamPlay()&&setupTeamColors();var t=oMap.sections?oMap.checkpoint.length-1:0,n=null==oMap.startrotation?180:oMap.startrotation,o=oMap.startdirection||0,i=n*Math.PI/180,r=Math.cos(i),l=Math.sin(i),s=27,c=130,p=Math.max(2,Math.round((1+Math.sqrt((c+4*(a-1)*s)/c))/2));function u(e,t){var n=((t+1)%p-(p-1)/2)*s/(p-.5),t=t*Math.min(12,c/a);o||(n=-n),n+=9,e.x-=n*r+t*l,e.y+=n*l-t*r}function d(e){return{acceleration:.2+.8*Math.pow(e[0],2),speed:.875+.25*e[1],handling:.2+.8*e[2],mass:.5+e[3]}}var m=timeTrialMode(),h=strPlayer.length;onlineSpectatorId&&(h=0);for(e=0;e<h;e++){var g=strPlayer[e],y=aPlaces[e],f={id:e,x:oMap.startposition[0],y:oMap.startposition[1],z:0,personnage:g,speed:0,speedinc:0,heightinc:0,stats:d(cp[g]),rotation:n,rotincdir:0,rotinc:0,changeView:0,size:1,sprite:new Sprite(g),cpu:!1,aipoints:oMap.aipoints[0],tourne:0,tombe:0,protect:!1,roulette:0,roulette2:0,arme:!1,stash:!1,maxspeed:5.7,driftinc:0,driftcpt:0,drift:0,turbodrift:0,driftSprite:new Sprite("drift"),jumped:!1,champi:0,etoile:0,megachampi:0,mini:0,using:[]};isOnline&&(f.id=identifiant),isOnline&&(f.nick=aPseudos[e]),f.team=iTeamPlay?aTeams[e]:-1,"BB"!=course?(u(f,m?1:y),f.time=0,f.tours=1,f.demitours=t,f.billball=0):(C=(b=isOnline?y-1:e)%oMap.startposition.length,f.x=oMap.startposition[C][0],f.y=oMap.startposition[C][1],f.rotation=90*oMap.startposition[C][2],f.loose=!1,f.ballons=[createBalloonSprite(f)],f.reserve=4),f.place=y,f.lastcp={x:f.x,y:f.y,rotation:f.rotation},f.initialPlace=f.place,oPlayers.push(f),aKarts.push(f)}for(e=0;e<aPlayers.length;e++){var g=aPlayers[e],S=e+h,y=aPlaces[S],v=2*(iDificulty-4)+Math.round(Math.random());"BB"==course&&(v=2);var b,C,x={id:S,speed:0,speedinc:.5,heightinc:0,stats:d([.5,.5,.5,cp[g][3]]),rotation:n,rotincdir:0,rotinc:0,x:oMap.startposition[0],y:oMap.startposition[1],z:0,size:1,personnage:g,sprite:new Sprite(g),tourne:0,tombe:0,protect:!1,roulette:0,roulette2:0,arme:!1,drift:0,driftinc:0,driftcpt:0,driftSprite:new Sprite("drift"),champi:0,etoile:0,megachampi:0,mini:0,using:[],cpu:!0,aipoint:0,lastAItime:0,aipoints:oMap.aipoints[0],maxspeed:5.7,maxspeed0:5.7};isOnline&&(x.id=aIDs[e],aControllers[e]?x.controller=aControllers[e]:x.cpu=!1),initAiPoints(oMap,x,S),isOnline&&(x.nick=aPseudos[S]),x.team=iTeamPlay?aTeams[S]:-1,-1==x.team&&!x.nick||(x.marker=createMarker(x)),"BB"!=course?(u(x,m?1:y),x.tours=1,x.demitours=t,x.billball=0,isOnline||(x.speed=v<2?0:5.7,x.tourne=v?0:42),x.place=y):(C=(b=isOnline?y-1:S)%oMap.startposition.length,x.x=oMap.startposition[C][0],x.y=oMap.startposition[C][1],x.rotation=90*oMap.startposition[C][2],x.loose=!1,x.aipoint=oMap.startposition[C][3],simplified&&(x.lastAI=oMap.startposition[C][3]+[-6,-1,6,1][oMap.startposition[C][2]]),x.ballons=[createBalloonSprite(x)],x.reserve=4,x.place=b+1,simplified||isOnline||(x.speed=x.maxspeed)),x.initialPlace=x.place,x.lastcp={x:x.x,y:x.y,rotation:x.rotation},aKarts.push(x)}function M(){this.speedinc=this.stats.acceleration*this.size,this.etoile&&(this.speedinc*=5)}function P(e){e*=getMirrorFactor(),clLocalVars.invertDirs&&(e=-e),this.rotincdir=this.stats.handling*e,this.driftinc||this.tourne||this.fell||!this.ctrl||this.cannon||(this.jumped&&(this.driftinc=e),this.driftinc&&(clLocalVars.drifted=!0))}function k(e){this.tourne||(isOnline?playIfShould(this,"musics/events/spin.mp3"):playDistSound(this,"musics/events/spin.mp3","BB"==course?80:50)),this.frminv=10,this.tourne=e,resetWrongWay(this)}function I(){return this.speed*sizeSpeedRatio(this)*fSelectedClass}if(onlineSpectatorId&&(oPlayers.push(aKarts[0]),oSpecCam={playerId:0,pos:{},aim:{},lastReset:0,isSetup:function(){return!isNaN(this.pos.x)},move:function(){this.pos.x=interpolateRaw(this.pos.x,this.aim.x,.3),this.pos.y=interpolateRaw(this.pos.y,this.aim.y,.3),this.pos.rotation=interpolateRaw(nearestAngle(this.pos.rotation,this.aim.rotation,360),this.aim.rotation,.3),this.lastReset++;var e=aKarts[this.playerId],t=2/(1+this.lastReset);this.aim.x=interpolateRaw(this.aim.x,e.x,t),this.aim.y=interpolateRaw(this.aim.y,e.y,t),this.aim.rotation=interpolateRaw(nearestAngle(this.aim.rotation,e.rotation,360),e.rotation,t)},reset:function(e){e=e||{},this.resetAim(),this.lastReset=e.since||0,e.smooth&&this.isSetup()||this.resetPos()},resetAim:function(){var e=aKarts[this.playerId];this.aim.x=e.x,this.aim.y=e.y,this.aim.rotation=e.rotation},resetPos:function(){this.pos.x=this.aim.x,this.pos.y=this.aim.y,this.pos.rotation=this.aim.rotation,lastState&&lastState.cam&&(lastState.cam.x=this.pos.x,lastState.cam.y=this.pos.y,lastState.cam.rotation=this.pos.rotation),oContainers[0].style.opacity=1,resetRenderState()}},getPlayerAtScreen=function(e){return aKarts[oSpecCam.playerId]},getScreenPlayerIndex=function(e){for(var t=aKarts[e],n=0;n<oPlayers.length;n++)if(getPlayerAtScreen(n)===t)return n;return oPlayers.length},(!onlineSpectatorState||tnCourse+3e3>(new Date).getTime())&&oSpecCam.reset()),(itemDistribution=(itemDistribution=selectedItemDistrib)||itemDistributions[getItemMode()][0]).value||(itemDistribution={value:itemDistribution}),ptsDistribution=selectedPtDistrib,m){foreachLMap(function(e,t){delete t.arme,e.arme=[]});for(e=0;e<aKarts.length;e++)aKarts[e].arme="champiX3",aKarts[e].maxspeed0=aKarts[e].maxspeed;if(aKarts[0].roulette=25,"CM"==course)for(e=0;e<gPersos.length;e++){var w=gPersos[e];aKarts.push({speed:v<2?0:5.7,speedinc:.5,heightinc:0,stats:d(cp[w]),rotation:n,rotincdir:0,rotinc:0,x:aKarts[0].x,y:aKarts[0].y,z:0,size:1,personnage:w,sprite:new Sprite(w),tourne:0,tombe:0,protect:!1,roulette:0,roulette2:0,arme:!1,drift:0,driftinc:0,driftcpt:0,driftSprite:new Sprite("drift"),champi:0,etoile:0,megachampi:0,using:[],tours:1,demitours:0,cpu:!1,aipoint:0,aipoints:oMap.aipoints[0],maxspeed:5.7,maxspeed0:5.7,place:1})}for(e=oPlayers.length;e<aKarts.length;e++)for(var L=jTrajets?jTrajets[e-1]:[],T=iTrajet===L?0:.5,E=0;E<oPlayers.length;E++)aKarts[e].sprite[E].div.style.opacity=T,aKarts[e].driftSprite[E].div.style.opacity=T;for(e=0;e<aKarts.length;e++){var D=!1,B=!1,O=!1,z=[iTrajet];!function(c){var t=aKarts[c];t.stopDrifting=function(){t.tourne=0,t.driftcpt=0,t.driftinc=0,resetDriftSprite(t)},t.stopStunt=function(){D&&(D=!1,t.tourne=0);var e=t.sprite[0];e.div.ahallowed&&(e.div.ahallowed=!1,e.div.style.backgroundColor="",e.div.style.backgroundImage="",e.div.style.backgroundRepeat="",e.div.style.backgroundSize="",e.img.style.opacity=1)},t.moveGhost=function(e){var t=aKarts[c];t.tombe&&(t.tombe--,t.tombe||resetFall(t),c||(19===t.tombe&&(t.sprite[c].img.style.opacity=1),oContainers[0].style.opacity=Math.abs(t.tombe-10)/10));var n=t.x,a=t.y,o=t.rotation;t.x=e[0],t.y=e[1],t.z=e[2],t.rotation=e[3];for(var i=(e[4]||"0000").split(""),r=0;r<4;r++)i[r]=+i[r];var l=0;i[2]?l=1:i[3]&&(l=-1),t.rotincdir=t.stats.handling*l;var s=t.tours,e=t.demitours;checkpoint(t,t.x-n,t.y-a)&&(t.tours++,t.demitours=getNextCp(t)),handleCpChange(s,e,c),t.z?(B||(O=B=!0,t.stopDrifting()),1.18<t.z&&(O=!1),O?i[1]&&!t.driftinc&&l&&(t.driftinc=l):D?(t.tourne-=1+Math.round(.5*(11-Math.abs(11-t.tourne))),t.tourne<8&&((l=t.sprite[0]).div.ahallowed||(l.div.ahallowed=!0,l.div.style.backgroundImage="url('images/halo.png')",l.div.style.backgroundRepeat="no-repeat",l.div.style.backgroundSize="contain",l.img.style.opacity=.7),t.tourne<0&&(t.tourne=0))):!i[1]||t.driftinc||t.tombe||(D=!0,t.stopDrifting(),t.tourne=19),i[0]&&(t.tombe=20,t.aX=n,t.aY=a,t.aRotation=o,t.sprite[0].img.style.display="none",t.stopStunt())):B&&(B=!1,t.stopStunt()),t.driftinc&&(i[1]||t.stopDrifting()),handleDriftCpt(c)}}(e)}updateObjHud(0)}else foreachLMap(function(e,t){if(itemDistribution.value.length&&t.arme)for(var n=0;n<e.arme.length;n++)initItemSprite(e.arme[n]);else t.arme&&(delete t.arme,e.arme=[])});for(e=0;e<aKarts.length;e++){var H=aKarts[e];H.accelerate=M,H.turn=P,H.spin=k,H.actualSpeed=I;for(E=0;E<strPlayer.length;E++)!function(e,t){e.nbSprites=24,t.nbSprites=3,t.w=63,t.h=22,t.z=-.544,e.img.onload=function(){e.w=this.naturalWidth/e.nbSprites,e.h=this.naturalHeight,t.z=-.017*e.h,delete this.onload}}(H.sprite[E],H.driftSprite[E])}if("CM"!=course)for(e=0;e<oPlayers.length;e++){document.getElementById("infoPlace"+e).innerHTML=oPlayers[e].place,document.getElementById("infoPlace"+e).style.display="block";var R=-1!=oPlayers[e].team?cTeamColors.light[oPlayers[e].team]:"";document.getElementById("infoPlace"+e).style.color=R,"BB"==course||onlineSpectatorId||(document.getElementById("compteur"+e).style.color=R)}gameControls=getGameControls();for(e=0;e<oPlayers.length;e++)previouslyPressedBtns[e]=new Array;challengesForCircuit={end_game:[],each_frame:[],each_hit:[],each_decor_hit:[],each_kill:[],each_item:[],each_coin:[],end_gp:[]},clGlobalVars=clGlobalVars||{nbcircuits:0};i=getMapId(oMap);if(addCreationChallenges("track",i),isCup)if(isMCups)for(A in addCreationChallenges("cup",A=cupIDs[Math.floor((oMap.ref-1)/4)]),challenges.mcup)addCreationChallenges("mcup",A);else for(var A in challenges.cup)addCreationChallenges("cup",A);var N,_,V,F={};for(N in challengesForCircuit)for(var j=challengesForCircuit[N],e=0;e<j.length;e++)F[j[e].id]=!0;for(_ in clRuleVars)F[_]||delete clRuleVars[_];clSelected&&!F[clSelected.id]&&(clSelected=void 0),reinitLocalVars(),clLocalVars.startPos&&(oPlayers[0].x=clLocalVars.startPos.pos[0],oPlayers[0].y=clLocalVars.startPos.pos[1],oPlayers[0].rotation=90-180*clLocalVars.startPos.angle/Math.PI),foreachLMap(function(l,e){if(e.decor){for(var t in l.decor)decorBehaviors[t]||(decorBehaviors[t]={type:t,ctx:{}});for(var t in decorBehaviors)decorBehaviors[t].ctx.lMap=l;for(var t in l.decor){var n=getDecorExtra(o=decorBehaviors[t]);(r=n.custom)&&(decorBehaviors[r.type]&&(Object.assign(o,decorBehaviors[r.type]),o.type=t),function(i){getCustomDecorData(r,function(e){var t,n,a;if(i.size_ratio||(t={w:e.size.hd.w/e.original_size.hd.w,h:e.size.hd.h/e.original_size.hd.h},1!==(i.size_ratio=t).w&&(n=i.hitbox||DEFAULT_DECOR_HITBOX,a=1,i.hitbox=a+(n-a)*t.w),1!==t.h&&(n=i.hitboxH||DEFAULT_DECOR_HITBOX_H,a=.8,i.hitboxH=a+(n-a)*t.h)),e.options&&(0===e.options.hitbox?i.transparent=!0:1===e.options.hitbox&&delete i.transparent,1!==e.options.spin||i.spin?0===e.options.spin&&delete i.spin:i.spin=20,1===e.options.unbreaking?(i.unbreaking=!0,delete i.breaking):0===e.options.unbreaking&&delete i.unbreaking,1===e.options.breaking?(i.breaking=!0,delete i.unbreaking):0===e.options.breaking&&delete i.breaking,e.options.items)){i.damagingItems={};for(var o=0;o<e.options.items.length;o++)i.damagingItems[e.options.items[o]]=!0}i.initcustom&&(i.ctx.extra=e.extra,setTimeout(function(){i.initcustom(l)}))})}(o)),o.preinit&&o.preinit(l.decor[t],o)}var a={};for(t in l.decor){var o,r,n=getDecorExtra(o=decorBehaviors[t]),i=(r=n.custom)?r.type:t,s=0;a[i]?s=a[i]:a[i]=0;for(var c=l.decor[t],p=0;p<c.length;p++){var u=c[p];u[2]=new Sprite(t),o.init&&o.init(u,p,p+s),gameSettings.ld&&o.hidable?u[2][0].unshow():r&&function(t,n){for(var e=0;e<oPlayers.length;e++)t[2][e].img.src="images/map_icons/empty.png";getCustomDecorData(r,function(e){updateCustomDecorSprites(t,e,n.size_ratio)})}(u,o)}a[i]+=c.length}l.assets=[],foreachDMap(l,e,function(e){e.assets=l.assets});for(p=0;p<assetKeys.length;p++){var d=assetKeys[p];if(e[d]){function m(e){var t=this.canvas.getContext("2d");t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width,this.canvas.height);var n=e[1][2],a=e[1][3],o=Math.hypot(n,a),i=e[2][2];t.translate(o/2,o/2),t.rotate(i),t.translate(-o/2,-o/2);try{t.drawImage(this.img,(o-n)/2,(o-a)/2,n,a)}catch(e){}var r=Math.cos(i),l=Math.sin(i),s=.5-e[2][0],i=.5-e[2][1];this.x=e[1][0]-o/2+s*n*r-i*a*l,this.y=e[1][1]-o/2+i*a*r+s*n*l}for(var h=0;h<l[d].length;h++)!function(t,n){var a=document.createElement("canvas");a.width=a.height=Math.hypot(n[1][2],n[1][3]);var o=new Image,e=n[0],i=getDecorCustomData(e,l),r={img:o,canvas:a,custom:i,redraw:m,x:n[1][0],y:n[1][1],w:n[1][2],h:n[1][3]};i?(r.src=i.type,o.src="images/map_icons/empty.png",getCustomDecorData(i,function(e){switch(o.src=e.hd,t){case"flippers":case"pointers":r.h=e.size.hd.h;break;case"oils":r.w=e.size.hd.w,r.h=e.size.hd.h;break;default:return}n[1][2]=r.w,n[1][3]=r.h,a.width=a.height=Math.hypot(n[1][2],n[1][3])})):(r.src="assets/"+e,o.src="images/map_icons/"+r.src+".png"),o.onload=function(){r.redraw(n)},n[0]=r,"flippers"===t&&(n[3]=[0,16+Math.floor(16*Math.random())]),l.assets.push(r)}(d,l[d][h])}else delete l[d],foreachDMap(l,e,function(e,t){delete e[d],t&&delete t[d]})}}else l.assets||(l.assets=[])}),1!=strPlayer.length||gameSettings.nomap||clLocalVars.noMap||(initPlan(oMap),oPlanDiv.style.opacity=.01,oPlanDiv2.style.opacity=.01),setTimeout(function(){oPlanDiv&&(oPlanDiv.style.opacity=""),oPlanDiv2&&(oPlanDiv2.style.opacity=""),render()},300),bMusic&&!onlineSpectatorState&&((V=playSoundEffect("musics/events/"+("BB"!=course?"start":"startbb")+".mp3")).volume=vMusic,V.pause(),setTimeout(function(){V.play()},300),V.blur()),bCounting=!0;for(var K=new Array,e=0;e<strPlayer.length;e++)K[e]=[document.createElement("div"),new Image],K[e][0].id="oCounts"+e,K[e][0].style.position="absolute",K[e][0].style.width=12*iScreenScale+"px",K[e][0].style.height=12*iScreenScale+"px",K[e][0].style.overflow="hidden",K[e][0].style.top=4*iScreenScale+"px",K[e][0].style.left=8*iScreenScale+"px",K[e][0].style.zIndex=1e4,K[e][1].src="images/lakitu_depart.png",K[e][1].style.position="absolute",K[e][1].style.left="0px",K[e][1].height=12*iScreenScale,K[e][1].className="pixelated",K[e][0].appendChild(K[e][1]),oContainers[e].appendChild(K[e][0]),K[e].scrollLeft=0,onlineSpectatorState&&(K[e][0].style.display="none");var W,q,G,J,$,U=0;if(!bMusic&&!iSfx||onlineSpectatorState||((J=loadMusic("musics/events/countdown.mp3",!(i={vSnd:bMusic?vMusic:vSfx}),i)).removeAttribute("loop"),document.body.appendChild(J),(G=loadMusic("musics/events/go.mp3",!1,i)).removeAttribute("loop"),document.body.appendChild(G),G.blur(),isMobile()||isChatting()||(ne=document.createElement("input"),document.body.appendChild(ne),ne.focus(),ne.blur(),document.body.removeChild(ne))),"CM"!=course&&1<iRaceCount&&isLocalScore()){$=new Array;for(e=0;e<strPlayer.length;e++){var X=document.createElement("div");X.style.position="absolute",X.style.right=Math.round(.6*iScreenScale+1)+"px",X.style.top=Math.round(.4*iScreenScale-3)+"px",X.style.color="white",X.style.fontFamily='"MuseoModerno", Arial',X.style.fontSize=Math.round(2.4*iScreenScale)+"px";var Y=Math.round(iScreenScale/8)+"px",Q=Math.round(iScreenScale/4)+"px";X.style.textShadow="-"+Q+" 0 black, 0 "+Q+" black, "+Q+" 0 black, 0 -"+Q+" black, -"+Y+" -"+Y+" black, -"+Y+" "+Y+" black, "+Y+" -"+Y+" black, "+Y+" "+Y+" black";Y="BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course");X.innerHTML=Y+" "+iRaceCount,hudScreens[e].appendChild(X),$.push(X)}}var Z,ee=fInfos&&fInfos.replay,te=function(){if(U){for(var e=0;e<strPlayer.length;e++)K[e][0].scrollLeft=12*U*iScreenScale;if(!(U<3)){clearTimeout(Z);var a={};0<oPlayers[0].speedinc&&(a.up=!0);for(e=0;e<strPlayer.length;e++)$&&hudScreens[e].removeChild($[e]),document.getElementById("infos"+e).innerHTML="<tr><td>"+toLanguage("GO!","PARTEZ !")+"</td></tr>",document.getElementById("infos"+e).style.fontSize=12*iScreenScale+"px",document.getElementById("infos"+e).style.top=Math.round(12.5*iScreenScale)+"px",1==oPlayers[e].speed?oPlayers[e].speed=11:1<oPlayers[e].speed&&(oPlayers[e].spin(42),oPlayers[e].speed=0);oChallengeCpts.style.visibility="visible";for(var t,n,o,i,r,e=0;e<$speedometers.length;e++)$speedometers[e].style.visibility="visible";if("BB"==course)for(e=0;e<aKarts.length;e++){var l=aKarts[e];l.cpu&&inflateNewBalloons(l)}if((bMusic||iSfx)&&(onlineSpectatorId&&(iSfx=!1),G&&(G.play(),G.onended=function(){document.body.removeChild(J),document.body.removeChild(G)})),forcePrepareEnding=!0,setTimeout(function(){for(var e=(kartIsPlayer(oPlayers[0])&&!oPlayers[0].loose||onlineSpectatorId)&&!finishing||ee,t=0;t<strPlayer.length;t++)oContainers[t].removeChild(K[t][0]),(e||t)&&(document.getElementById("infos"+t).style.display="none");var l=document.getElementById("infos0");l&&(l.style.fontFamily="",l.style.textStroke=l.style.WebkitTextStroke=l.style.MozTextStroke="",l.style.width="",l.style.top=7*iScreenScale+10+"px",l.style.left=Math.round(25*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",l.style.fontSize=4*iScreenScale+"px",l.style.pointerEvents="");var n,a=document.getElementById("virtualbtn-pause");a&&(a.style.display="block"),e&&(a=(n="CM"!=course||isSingle)?3*iScreenScale:Math.round(2.5*iScreenScale),l.innerHTML='<tr><td><input type="button" style="font-size: '+a+'pt; width: 100%;" value=" &nbsp; '+toLanguage("  RESUME  ","REPRENDRE")+' &nbsp; " id="reprendre" /></td></tr><tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" style="font-size: '+a+'pt; width: 100%;" value=" &nbsp; '+toLanguage("  RETRY  ","R√âESSAYER")+' &nbsp; " id="recommencer" /></td></tr>'+(n?"":'<tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" style="font-size: '+a+'pt; width: 100%;" value="'+toLanguage("  CHANGE RACE  ","CHANGER CIRCUIT")+'" id="changecircuit" /></td></tr>')+'<tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" id="quitter" value=" &nbsp; '+toLanguage("QUIT","QUITTER")+' &nbsp; " style="font-size: '+a+'pt; width: 100%;" /></td></tr>',l.onkeydown=function(e){var t,n;switch(e.keyCode){case 38:t=-1;break;case 40:t=1;break;case 13:(n=document.activeElement)&&n.onclick&&l.contains(n)&&iSfx&&setTimeout(function(){document.onkeydown||playSoundEffect("musics/events/select.mp3")})}if(t&&(n=document.activeElement)){var a=Array.prototype.slice.call(document.querySelectorAll("#infos0 input, #infos0 button")),o=n,i=a.indexOf(n);if(-1!=i){var r=i;do{if((r+=t)<0&&(r+=a.length),r>=a.length&&(r=0),(o=a[r])&&"none"!=o.style.display&&"hidden"!=o.style.visibility){o.focus(),iSfx&&playSoundEffect("musics/events/move.mp3");break}}while(r!=i)}}},document.getElementById("reprendre").onclick=reprendre,document.getElementById("recommencer").onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<oContainers.length;e++)$mkScreen.removeChild(oContainers[e]);fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,map:oMap.ref,difficulty:iDificulty,cl:clSelected},"CM"==course&&(fInfos.perso=gPersos,fInfos.cpu_route=jTrajets,fInfos.my_record=gRecord,fInfos.ow_record=gOverwriteRecord,fInfos.lap_times=iLapTimes),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetScores()&&("GP"==course?fInfos.map-=(oMap.ref+3)%4:"CM"!=course&&delete fInfos.map),resetEvents(),resetApp()},n||(document.getElementById("changecircuit").onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,perso:new Array,cl:clSelected},document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()}),document.getElementById("quitter").onclick=quitter,bMusic&&!oMusicEmbed&&(unpauseMusic(mapMusic),forceStartMusic=!0),onlineSpectatorId&&(l.innerHTML='<tbody style="text-align: left; color: white; font-weight: normal; text-shadow: black -1px -1px, black -1px 1px, black 1px -1px, black 1px 1px"><tr><td style="font-weight: bold; text-decoration: underline; font-size: 1.1em; text-shadow: #030 -1px -1px, #030 -1px 1px, #030 1px -1px, #030 1px 1px">'+toLanguage("Spectator mode","Mode spectateur")+"</td></tr><tr><td>"+toLanguage("Switch player:","Changer de joueur :")+' <strong style="font-size: 1.4em; line-height: 1.1em">&larr; &rarr;</strong></td></tr><tr><td>'+toLanguage("Exit: Escape","Quitter : Echap")+"</td></tr></tbody>",l.style.left=10+iScreenScale+"px",l.style.top=10+iScreenScale+"px",l.style.fontSize=Math.round(1.75*iScreenScale)+"px",l.style.display="",l.style.visibility="",document.body.style.cursor="default")),bCounting=!1},onlineSpectatorState?1:1e3),pause&&fInfos.replay){for(pause=!1,e=0;e<aKarts.length;e++)aKarts[e].cpu=!0,aKarts[e].tours=1,aKarts[e].demitours=0;for(e=0;e<gPersos.length;e++)z.push(jTrajets[e]);clearInterval(W),clearInterval(q),function e(){if(!pause){for(var t=0;t<z.length;t++){var n,a,o=aKarts[t],i=z[t][timer];i?(n=o.x,a=o.y,o.moveGhost(i),updateSpeedometer(t,n,a)):(null==o.aipoint&&(o.aipoint=0,o.lastAItime=0,o.arme=!1,o.maxspeed=5.7,t||(o.tourne=0,o.stopDrifting(),o.stopStunt())),void 0===o.demitours&&(n=o.tours,a=o.demitours,o.tours=oMap.tours+1,o.demitours=0,handleCpChange(n,a,t)),ai(o),o=iSfx,iSfx=!1,move(t),iSfx=o)}showTimer(++timer*SPF),oPlayers[0].cpu=!1,moveDecor(),oPlayers[0].cpu=!0,setTimeout(timer!=iTrajet.length?e:function(){var e=aKarts[0],t=e.tours,n=e.demitours;e.tours=oMap.tours+1,handleCpChange(t,n,e.demitours=0),e.aipoint=0,e.changeView=180,e.maxspeed=5.7,e.speed=5.7,e.tourne=0,e.stopDrifting(),e.stopStunt(),$speedometers[0]&&($speedometers[0].style.display="none"),document.onkeyup=void 0,document.getElementById("infos0").style.display="",(e=document.getElementById("infos0").getElementsByTagName("input")[0])&&e.focus(),showTimer(timerMS=iRecord),(bMusic||iSfx)&&startEndMusic(),cycle()},SPF),render()}}(),pause=!1,setTimeout(function(){continuer(),document.querySelector("#enregistrer input").style.display="none"},1e3),document.onkeyup=function(e){e=getGameAction(e);"pause"!=e||bCounting?"quit"==e&&quitter():(document.getElementById("infos0").style.display="none"==document.getElementById("infos0").style.display?"":"none",(e=document.getElementById("infos0").getElementsByTagName("input")[0])&&e.focus())}}else{function s(e){switch(e){case"up":a[e]=!0,oPlayers[0].accelerate();break;case"left":a[e]=!0,oPlayers[0].turn(1);break;case"right":a[e]=!0,oPlayers[0].turn(-1);break;case"down":a[e]=!0,isRdDisabled()&&oPlayers[0].driftinc?oPlayers[0].speedinc=0:(oPlayers[0].speedinc=-.2,oPlayers[0].driftinc&&(clLocalVars.revDrifted=!0));break;case"jump":if(pause)break;if(!isJumpEnabled())break;oPlayers[0].ctrl=!0,oPlayers[0].z||oPlayers[0].heightinc?oPlayers[0].jumped||oPlayers[0].fell||oPlayers[0].ctrled||oPlayers[0].billball||oPlayers[0].tourne||oPlayers[0].figuring||oPlayers[0].figstate||oPlayers[0].driftinc||stuntKart(oPlayers[0]):oPlayers[0].driftinc||oPlayers[0].tourne||(oPlayers[0].z=1,oPlayers[0].heightinc=.5,oPlayers[0].jumped=!0,oPlayers[0].rotincdir&&(oPlayers[0].driftinc=0<oPlayers[0].rotincdir?1:-1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"pause":if(isOnline)break;var t;pause?reprendre(!0):bCounting||(document.getElementById("infos0").style.display="",interruptGame(),pauseSounds(),(t=document.getElementById("recommencer"))&&("CM"==course||clSelected)?t.focus():(t=document.getElementById("reprendre"))&&t.focus());break;case"balloon":if(pause)return;"BB"==course&&oPlayers[0].tourne<5&&oPlayers[0].reserve&&oPlayers[0].ballons.length&&oPlayers[0].ballons.length<3&&!oPlayers[0].sprite[0].div.style.opacity&&(oPlayers[0].ballons[oPlayers[0].ballons.length]=createBalloonSprite(oPlayers[0]),oPlayers[0].reserve--,updateBalloonHud(document.getElementById("compteur0"),oPlayers[0]),clLocalVars.inflatedBalloons++,updateChallengeHud("inflated",clLocalVars.inflatedBalloons),playIfShould(oPlayers[0],"musics/events/balloon.mp3"));break;case"quit":bCounting||quitter();break;case"cheat":isOnline||"GP"==course||"CM"==course||openCheats();break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].accelerate();break;case"left_p2":if(!oPlayers[1])return;oPlayers[1].turn(1);break;case"right_p2":if(!oPlayers[1])return;oPlayers[1].turn(-1);break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=-.2;break;case"jump_p2":if(pause)break;return oPlayers[1]?(oPlayers[1].ctrl=!0,void(oPlayers[1].z||oPlayers[1].heightinc?oPlayers[1].jumped||oPlayers[1].ctrled||oPlayers[1].fell||oPlayers[1].billball||oPlayers[1].tourne||oPlayers[1].figuring||oPlayers[1].figstate||oPlayers[1].driftinc||stuntKart(oPlayers[1]):oPlayers[1].driftinc||oPlayers[1].tourne||(oPlayers[1].z=1,oPlayers[1].heightinc=.5,oPlayers[1].jumped=!0,oPlayers[1].rotincdir&&(oPlayers[1].driftinc=0<oPlayers[1].rotincdir?1:-1)))):void 0;case"balloon_p2":if(pause)return;if(!oPlayers[1])return;"BB"==course&&oPlayers[0].tourne<5&&oPlayers[1].reserve&&oPlayers[1].ballons.length&&oPlayers[1].ballons.length<3&&!oPlayers[1].sprite[0].div.style.opacity&&(oPlayers[1].ballons[oPlayers[1].ballons.length]=createBalloonSprite(oPlayers[1]),oPlayers[1].reserve--,updateBalloonHud(document.getElementById("compteur1"),oPlayers[1]))}}function c(e){a[e]&&s(e)}document.onkeydown=function(e){if(forceStartMusic)try{mapMusic.yt&&mapMusic.yt.playVideo(),forceStartMusic=!1}catch(e){}else if(forcePrepareEnding)try{endingMusic.yt&&(endingMusic.yt.setVolume(0),endingMusic.yt.playVideo(),setTimeout(function(){endingMusic.yt.seekTo(0,!0),endingMusic.yt.setVolume(100*vMusic),endingMusic.yt.pauseVideo()},1e3)),forcePrepareEnding=!1}catch(e){}if(!clLocalVars.fastForward){if(onlineSpectatorId)return handleSpectatorInput(e);var t,n=getGameAction(e);n&&((t=document.activeElement)&&"INPUT"==t.tagName&&"button"!=t.type&&"submit"!=t.type&&e.keyCode||(e.preventDefault&&e.preventDefault(),s(n,e.keyIntensity)))}},document.onkeyup=function(e){var t,n;onlineSpectatorId||(t=getGameAction(e))&&((n=document.activeElement)&&"INPUT"==n.tagName&&"button"!=n.type&&"submit"!=n.type&&e.keyCode||function(e){switch(e){case"item":case"item_back":case"item_fwd":oPlayers[0].tourne||oPlayers[0].cannon||pause||arme(0,"item_back"===e,"item_fwd"===e);break;case"up":a.up=!1,oPlayers[0].speedinc=0,c("down");break;case"left":a.left=!1,oPlayers[0].rotincdir=0,c("right");break;case"right":a.right=!1,oPlayers[0].rotincdir=0,c("left");break;case"down":a.down=!1,oPlayers[0].speedinc=0,c("up");break;case"jump":if(pause)break;var t;delete oPlayers[0].ctrl,oPlayers[0].driftinc&&(oPlayers[0].driftinc=0,oPlayers[0].driftcpt>=fTurboDriftCpt&&(oPlayers[0].turbodrift=15,clLocalVars.miniTurbo++,clSelected&&clRuleVars[clSelected.id]&&(t=clRuleVars[clSelected.id].mini_turbo)&&updateChallengeHud("miniTurbo",clLocalVars.miniTurbo+t.miniTurbo),oPlayers[0].driftcpt>=fTurboDriftCpt2&&(oPlayers[0].turbodrift+=15,clLocalVars.superTurbo++,clSelected&&clRuleVars[clSelected.id]&&(t=clRuleVars[clSelected.id].super_turbo)&&updateChallengeHud("superTurbo",clLocalVars.superTurbo+t.superTurbo)),oPlayers[0].turbodrift0=oPlayers[0].turbodrift,resetDriftSprite(oPlayers[0])),oPlayers[0].driftcpt=0,oPlayers[0].driftSound&&(oPlayers[0].driftSound.pause(),oPlayers[0].driftSound=void 0)),oPlayers[0].ctrled=!1,oPlayers[0].jumped&&(oPlayers[0].z||oPlayers[0].heightinc)&&(oPlayers[0].ctrled=!0);break;case"rear":clLocalVars.rearView||showRearView(0);break;case"item_p2":case"item_back_p2":case"item_fwd_p2":oPlayers[1].tourne||oPlayers[1].cannon||pause||arme(1,"item_back_p2"===e,"item_fwd_p2"===e);break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"left_p2":case"right_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=0;break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"jump_p2":if(pause)break;if(!oPlayers[1])return;delete oPlayers[1].ctrl,oPlayers[1].driftinc&&(oPlayers[1].driftinc=0,oPlayers[1].driftcpt>=fTurboDriftCpt&&(oPlayers[1].turbodrift=15,oPlayers[1].driftcpt>=fTurboDriftCpt2&&(oPlayers[1].turbodrift+=15),oPlayers[1].turbodrift0=oPlayers[1].turbodrift,resetDriftSprite(oPlayers[1])),oPlayers[1].driftcpt=0,oPlayers[1].driftSound&&(oPlayers[1].driftSound.pause(),oPlayers[1].driftSound=void 0)),oPlayers[1].ctrled=!1,oPlayers[1].jumped&&(oPlayers[1].z||oPlayers[1].heightinc)&&(oPlayers[1].ctrled=!0);break;case"rear_p2":if(!oPlayers[1])return;showRearView(1)}}(t))},window.releaseOnBlur=function(){if(!onlineSpectatorId){a={};for(var e=0;e<oPlayers.length;e++)ctrlSettings.autoacc||(oPlayers[e].speedinc=0),oPlayers[e].rotincdir=0,stopDrifting(e)}},window.addEventListener("blur",window.releaseOnBlur),isMobile()&&ctrlSettings.autoacc&&((t=document.getElementById("virtualbtn-accelerate"))&&t.dataset?(t.ontouchend=void 0,t.dataset.pressed||(n=new Event("touchstart"),t.dispatchEvent(n))):doPressKey("up")),window.onbeforeunload||(window.onbeforeunload=logGameTime),pause=!1,"CM"==course&&(iTrajet=new Array),clearInterval(W),clearInterval(q),clLocalVars.delayedStart?(oPlayers[0].speed=0,o=oPlayers[0].speedinc,oPlayers[0].speedinc=0,i=1e3*clLocalVars.delayedStart/67,nbFrames=1,pause=!0,clLocalVars.fastForward=!0,r=reprendre,reprendre=function(){},function e(){pause&&(timer<i?(setTimeout(e,1),runOneFrame()):(delete clLocalVars.fastForward,oPlayers[0].speedinc=o,nbFrames=iFps,(reprendre=r)(!1)))}()):cycle(),bRunning=!0}return void(fInfos=void 0)}for(var e=0;e<strPlayer.length;e++)document.getElementById("decompte"+e).innerHTML--,oPlayers[e].speed+=oPlayers[e].speedinc;(bMusic||iSfx)&&(J.currentTime=0,J.play())}else{for(e=0;e<strPlayer.length;e++)document.getElementById("infos"+e).style.visibility="";(bMusic||iSfx)&&J.play(),document.body.style.cursor="default",Z=setInterval(te,1e3)}U++};if(!iSfx||fInfos.replay||onlineSpectatorId||setTimeout(startEngineSound,bMusic?2600:1100),isOnline){var ne=tnCourse-(new Date).getTime();if(onlineSpectatorState){U=3,ne+=4e3;for(e=0;e<aKarts.length;e++)aKarts[e].speedinc=0;ne<0&&(ne=0)}else iTeamPlay&&!onlineSpectatorId&&function(e){var t=oPlayers[0].team,n=document.createElement("div");n.style.position="absolute",n.style.zIndex=1e4,n.style.left="0px",n.style.top=12*iScreenScale+"px",n.style.width=iScreenScale*iWidth+"px",n.style.textAlign="center",n.style.fontSize=6*iScreenScale+"px",n.style.fontWeight="bold",n.style.color=cTeamColors.light[t],n.innerHTML=toLanguage("You are ","Vous √™tes ")+cTeamColors.name2[t];var a=Math.min(1500,e-1e3);500<a&&setTimeout(function(){oContainers[0].appendChild(n),setTimeout(function(){oContainers[0].removeChild(n)},a)},500)}(ne);setTimeout(te,ne)}else setTimeout(te,bMusic?3e3:1500);if(isMobile())if(onlineSpectatorId)showSpectatorKeyboard();else{switch(ctrlSettings.mode){case"gestures":setupGestureEvents();break;case"external":break;default:showVirtualKeyboard()}setupCommonMobileControls()}gameControls.gamepad&&(q=setInterval(handleGamepadEvents,SPF)),oMap.mapImg.image&&(W=setTimeout(function(){W=setInterval(function(){for(var e=0;e<oPlayers.length;e++)redrawCanvas(e,oPlayers[e],oMap)},100)},100)),(clLocalVars.backwardsStart||clLocalVars.rearView)&&showRearView(0),isOnline||(document.body.style.cursor="default")}function showVirtualKeyboard(){setupVibrate();var e,i=document.getElementById("virtualkeyboard");function t(e){function t(){addButton("I",{key:"item",src:"item"})}function n(){var e=document.createElement("div");e.className="btn-ctn",addButton("‚Üë",{key:"item_fwd",src:"item_fwd",parent:e}),addButton("‚Üì",{key:"item_back",src:"item_back",parent:e}),i.appendChild(e)}function a(){var e=document.createElement("div");e.className="btn-ctn";var t=document.createElement("button");t.id="virtualbtn-accelerate";var n=document.createElement("button");ctrlSettings.autoacc?(addButton("‚Üë",{btn:t,key:"up",src:"up",parent:e,touchstart:o(n),touchend:void 0}),addButton("‚Üì",{btn:n,key:"down",src:"down",parent:e,touchstart:o(t),touchend:void 0})):(addButton("‚Üë",{btn:t,key:"up",src:"up",parent:e}),addButton("‚Üì",{btn:n,key:"down",src:"down",parent:e})),i.appendChild(e)}function o(e){return function(){this.dataset.pressed?onButtonPress.bind(this)():(e.dataset.pressed&&onButtonPress.bind(e)(),onButtonTouch.bind(this)())}}e?(a(),n(),t()):(t(),n(),a())}function n(e){function t(){addButton("J",{key:"jump",src:"jump"})}function n(){addButton("‚Üê",{key:"left",src:"left"}).id="virtualbtn-left"}function a(){addButton("‚Üí",{key:"right",src:"right"}).id="virtualbtn-right"}e?(n(),a(),t()):(t(),n(),a())}switch(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||function(){},ctrlSettings.layout){case"old":e=addButtonLegacy(' <span style="position:absolute;left:8px;top:-5px">‚Üë</span><span style="position:absolute;right:6px;bottom:8px;font-size:10px;text-align:right">'+(language?"+ Jump<br/>Drift":"+ Saut<br/>D√©rapage")+"</span>",["up","jump"],0,0),ctrlSettings.autoacc&&(e.style.display="none"),addButtonLegacy(" ‚Üë ","up",1,0).id="virtualbtn-accelerate",addButtonLegacy("Obj","item",2,0,null,null,25),addButtonLegacy("‚ùö‚ùö","pause",3,0,null,null,25),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),addButtonLegacy(language?"Jump<br/>Drift":"Saut<br/>D√©rapage","jump",0,1,null,null,11),addButtonLegacy(" ‚Üì ","down",1,1),addButtonLegacy(" ‚Üê ","left",2,1).id="virtualbtn-left",addButtonLegacy(" ‚Üí ","right",3,1).id="virtualbtn-right";break;case"h_sym":t(!0),n(!0);break;case"v_sym":n(),t();break;case"vh_sym":n(!0),t(!0);break;default:t(),n()}if(i.ontouchstart=function(e){return e.preventDefault(),!1},i.className="shown","old"===ctrlSettings.layout){i.classList.add("legacy");return i.style.width=Math.round(288)+"px",i.style.height=Math.round(130)+"px",i.style.left=(iScreenScale*iWidth-288)/2+"px",void(i.style.top=40*iScreenScale+"px")}posVirtualKeyboard(i)}function posVirtualKeyboard(e){var t=iScreenScale*iHeight+20;e.style.top=t+"px";var n=e.offsetWidth,a=window.innerHeight-t,a=Math.min(a,Math.round(.45*n)),t=Math.min(window.innerWidth,iWidth*iScreenScale);n<t&&(e.style.left=Math.round((t-n)/2)+"px"),e.style.height=a+"px"}function hideVirtualKeyboard(){var e=document.getElementById("virtualkeyboard");e.innerHTML="",e.className="",e.setAttribute("style","")}updateVolumeSettings=function(e){var t=vSfx,n=vMusic;null!=e.sfx&&(vSfx=e.sfx),null!=e.music&&(vMusic=e.music);for(var a=document.getElementsByClassName("gamemusic"),o=[],i=0;i<a.length;i++)o.push(a[i]);oMusicEmbed&&!o.includes(oMusicEmbed)&&o.push(oMusicEmbed);for(var r=[oMusicEmbed].concat(listMapMusics()).concat([endingMusic]),i=0;i<o.length;i++){var l=o[i];r.includes(l)?updateMusicVolume(l,vMusic,n):updateMusicVolume(l,vSfx,t)}};var $virtualScreens=new Array;function setupGestureEvents(){for(var e=0;e<oContainers.length;e++){var o,n,a=document.createElement("div");a.style.position="fixed",a.style.left="0px",a.style.top="0px",a.style.width="100%",a.style.height="100%",a.style.zIndex=2e4;var i=oPlayers[e];var r,l={t:0},s=ctrlSettings.autoacc?200:500,c=!1;function p(e){var t,n=iScreenScale*iWidth;return $mkScreen.dataset.fs&&(t=a.getBoundingClientRect(),n=window.innerWidth-2*t.x),{x:e[0].pageX/n,y:e[0].clientY/n,t:(new Date).getTime()}}a.ontouchstart=function(e){var t=r;r=p(e.touches),pressKey("up"),(new Date).getTime()-l.t<s&&(t=r.x-t.x,Math.abs(t)<.5&&(pressKey("jump"),.1<=t?pressKey("right"):t<=-.1&&pressKey("left"))),clearTimeout(n)},a.ontouchmove=function(e){clearInterval(o),function(e){e.preventDefault();var t,n=p(e.touches),e=n.x-r.x;if(n.y-r.y>Math.max(.2,3*Math.abs(e)))return releaseKey("up"),pressKey("down"),0<document.body.scrollTop?document.body.scrollTop-=10:0<document.documentElement.scrollTop&&(document.documentElement.scrollTop-=10);function a(){var e=rotateToAngle(i,t);1<=Math.abs(e.targetDir)&&(c=!0)}ctrlSettings.gyroscope||(t=-Math.sign(e)*Math.pow(Math.abs(e),1.4)*120,a(),o=setInterval(a,SPF))}(e)},a.ontouchend=function(e){for(var t in clearInterval(o),o=void 0,i.driftinc&&(c=!0),oPressedKeys)"up"!==t&&releaseKey(t);ctrlSettings.autoacc||(n=setTimeout(function(){releaseKey("up")},300)),c?c=!1:l={t:(new Date).getTime()}};var t=document.createElement("div");t.style.position="absolute",t.style.left=0,t.style.top=0,t.style.width=12*iScreenScale+"px",t.style.height=9*iScreenScale+"px",t.ontouchstart=function(e){e.stopPropagation(),doReleaseKey("item"),c=!0},a.appendChild(t),hudScreens[e].appendChild(a),$virtualScreens.push(a)}}function setupCommonMobileControls(){var e,n,t,a,o,i;ctrlSettings.vitem&&((e=document.createElement("div")).style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.zIndex=2e4,e.style.width=iScreenScale*iWidth+"px",e.style.height=iScreenScale*iHeight+"px",e.ontouchstart=function(e){e.preventDefault(),n={x:e.touches[0].clientX,y:e.touches[0].clientY}},e.ontouchend=function(e){var t=e.changedTouches[0].clientX,e=e.changedTouches[0].clientY,t=t-n.x,e=e-n.y;Math.abs(e)>Math.max(50,3*Math.abs(t))?doReleaseKey(0<e?"item_back":"item_fwd"):doReleaseKey("item")},hudScreens[0].appendChild(e)),isOnline||((t=document.createElement("button")).innerHTML="‚ùö‚ùö",t.style.position="absolute",t.style.zIndex=2e4,t.style.right=22*iScreenScale+"px",t.style.top="5px",t.style.fontSize=Math.round(3*iScreenScale)+"px",t.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",t.ontouchstart=function(e){e.preventDefault(),doPressKey("pause")},t.id="virtualbtn-pause",t.style.display="none",hudScreens[0].appendChild(t)),"BB"==course&&((t=document.createElement("div")).style.position="absolute",t.style.zIndex=2e4,t.style.left="0px",t.style.bottom="-2px",t.style.width=16*iScreenScale+"px",t.style.height=5*iScreenScale+4+"px",t.ontouchstart=function(e){e.preventDefault(),doPressKey("balloon")},hudScreens[0].appendChild(t)),ctrlSettings.gyroscope&&(a=document.getElementById("virtualbtn-left"),o=document.getElementById("virtualbtn-right"),i=window.innerWidth>window.innerHeight,window.turnOnRotate=function(e){var t,n;a&&a.dataset.pressed||o&&o.dataset.pressed||(e=i?(t=e.beta,90<=Math.abs(t)&&(t=Math.sign(t)*(180-Math.abs(t))),n=15,1):(t=e.gamma,90<=e.beta&&(t=-t),n=15,2),n=-Math.sign(t)*Math.pow(Math.abs(t/90),e)*n,rotateToAngle(oPlayers[0],n))},window.addEventListener("deviceorientation",window.turnOnRotate))}function setupVibrate(){navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||function(){}}function showSpectatorKeyboard(){setupVibrate();var e=document.getElementById("virtualkeyboard");addButton("‚Üê",{key:"left",src:"left"}),addButton("‚Üí",{key:"right",src:"right"}),e.className="shown spectator",posVirtualKeyboard(e),e.style.height="40px"}var oPressedKeys={},oMusicEmbed;function pressKey(e){oPressedKeys[e]||doPressKey(e)}function doPressKey(e){oPressedKeys[e]=1,document.onkeydown&&document.onkeydown({keyAction:e})}function releaseKey(e){oPressedKeys[e]&&doReleaseKey(e)}function doReleaseKey(e){oPressedKeys[e]=void 0,document.onkeyup&&document.onkeyup({keyAction:e})}function rotateToAngle(e,t){var n=getMirrorFactor();clLocalVars.invertDirs&&(n=-n);var a,n=(t-angleInc(e)*n)/2;return n>e.stats.handling/2?a="left":n<-e.stats.handling/2&&(a="right"),"left"!==a&&releaseKey("left"),"right"!==a&&releaseKey("right"),a&&pressKey(a),{targetDir:n,action:a}}function youtube_parser(e){e=e.match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/);return!(!e||11!=e[1].length)&&e[1]}var fSpriteScale=0,fLineScale=0,oContainers=[document.createElement("div")],oPrevFrameStates;oContainers[0].className="game-container",oContainers[0].tabindex=1,formulaire=null,updateCtnFullScreen(1==$mkScreen.dataset.fs),function(){for(var e,t=0;t<2;t++)(e=document.getElementById("infos"+t))&&$mkScreen.removeChild(e);(e=document.createElement("table")).id="infos0",e.setAttribute("cellspacing",1),e.setAttribute("cellpadding",0),e.style.display="none",$mkScreen.appendChild(e)}(),$mkScreen.appendChild(oContainers[0]),pause&&fInfos.player[1]&&(oContainers[1]=oContainers[0].cloneNode(!1),oContainers[1].style.left=12+iWidth*iScreenScale+"px",$mkScreen.appendChild(oContainers[1]));var oScreens=new Array,aStrips=new Array,iCamHeight=24,iCamDist=32,iViewHeight=-10,fFocal=1/Math.tan(Math.PI*Math.PI/360);function resetScreen(){fSpriteScale=iScreenScale/4,fLineScale=1/iScreenScale*iQuality,aStrips=[];for(var e=0;e<strPlayer.length;e++){var t=oContainers[e];t.style.width=iWidth*iScreenScale+"px",t.style.height=iHeight*iScreenScale+"px";t=document.createElement("canvas");t.style.position="absolute",oScreens.push(t),oContainers[e].appendChild(t),t.width=iWidth/fLineScale,t.height=iHeight/fLineScale,t.style.width=iWidth*iScreenScale+iScreenScale+"px",t.style.left=-iScreenScale/2+"px",t.style.top=iScreenScale+"px",t.style.height=iHeight*iScreenScale+"px"}var n;nbFrames=iFps,frameHandlers=new Array(nbFrames);var a=getFrameSettings(gameSettings);interpolateFn=a.frameint,prevScreenDelay=a.framerad,n=a.frameblur,prevScreenOpacity=a.frameopacity,prevScreenFade=a.framefade,nbFrames<=1&&(prevScreenDelay=0),oPrevFrameStates=[],resetBgLayers();for(e=0;e<oContainers.length;e++){oPrevFrameStates[e]=[];for(var o=0;o<prevScreenDelay;o++){var i=oContainers[e].cloneNode(!0);i.className="",i.style.position="absolute",i.style.left="0px",i.style.top="0px",i.style.width="100%",i.style.height="100%",i.style.opacity=0,i.style.filter="blur("+n+"px)",oPrevFrameStates[e][o]={container:i,canvas:i.firstChild,layer:[],opacity:0}}}for(var r=0,l=0;l<iHeight;l+=fLineScale){var s=l+iViewHeight,c=s/((iCamHeight-s)/iCamDist),p=fFocal/(fFocal+c),s=Math.floor(iWidth/p);0<p&&s<iViewCanvasWidth&&(0==l&&(r=c-1),aStrips.push({viewy:l,mapz:c,scale:p,stripwidth:s,mapzspan:c-r}),r=c)}foreachLMap(function(n,e){updateBgLayers(e,function(e,t){n===oMap?setupBgLayer(e,t,!0):loadBgLayer(e)})});for(e=0;e<oPrevFrameStates.length;e++)for(o=0;o<prevScreenDelay;o++)oContainers[e].appendChild(oPrevFrameStates[e][o].container);(oViewCanvas=document.createElement("canvas")).width=iViewCanvasWidth,oViewCanvas.height=iViewCanvasHeight}function getFrameSettings(e){var t=e.frameint;t||(3<iFps?t="ease_out_cubic":1<iFps&&(t="ease_out_quad"));var n=Math.floor(iFps/2),a=0<=e.framerad?+e.framerad:n;return{frameint:t,framerad:a,defaultframerad:n,frameblur:e.frameblur||"1",frameopacity:0<=e.frameopacity?+e.frameopacity:.39/(a+1),framefade:0<=e.framefade?+e.framefade:1}}function interruptGame(){pause=!0,clearInterval(cycleHandler),cycleHandler=null}function reprendre(e){pause&&(pause=!1,cycle()),e&&(unpauseSounds(),document.getElementById("infos0").style.display="none")}function quitter(){if(isOnline)document.location.href=isCup?(isBattle?complete?"battle":"arena":complete?"map":"circuit")+".php?"+(isMCups?"mid="+nid:(isSingle?complete?"i":"id":"cid")+"="+nid):"index.php";else{interruptGame(),displayCommands(),removeGameMusics(),removeHUD(),oMap&&clearResources();for(var e=0;e<strPlayer.length;e++){$mkScreen.removeChild(oContainers[e]);var t=document.getElementById("infos"+e);t&&(t.style.display="none")}($mkScreen.style.opacity=1)==strPlayer.length&&removePlan(),resetEvents(),oBgLayers.length=0,aPlayers=[],aScores=[],clRuleVars={},clGlobalVars=void 0,resetApp({onRestart:function(){pause=!1}})}}function resetApp(e){e=e||{},setTimeout(function(){e.onRestart&&e.onRestart(),MarioKart()},e.time||500),window.onbeforeunload=void 0,logGameTime()}function logGameTime(){var e=getActualGameTimeMS();0<e&&xhr("incGameTime.php","time="+e,function(){return!0})}function classement(){for(var e=aKarts.length,t=0;t<e;t++){for(var n=aKarts[t],a=aScores[t],o=1,i=0;i<e;i++){var r=aScores[i];n!=aKarts[i]&&a<=r&&(a<r||i<t)&&o++}n.place=o}for(var l=new Array,t=1;t<=e;t++)for(i=0;i<e;i++)(o=aKarts[i].place)==t&&(l.push(i),i=e);document.getElementById("infos0").style.display="none";strPlayer.length;for(var s,t=0;t<l.length;t++){var c=l[t],p=aKarts[c].personnage;document.getElementById("fJ"+t).style.backgroundColor=rankingColor(c),document.getElementById("fJ"+t).style.opacity=p!=strPlayer?"":.8,document.getElementById("j"+t).innerHTML=toPerso(p),document.getElementById("pts"+t).innerHTML=aScores[c]}if(iTeamPlay){for(var u=new Array(selectedNbTeams).fill(0),t=0;t<aScores.length;t++)u[aTeams[t]]+=aScores[t];s=createTeamTable(u)}document.getElementById("octn").onclick=continuer,setTimeout(function(){document.getElementById("infos0").style.display="",s&&(s.style.visibility="visible");var e=document.body.scrollTop;document.getElementById("octn").focus(),document.body.scrollTop=e},500)}function handleRankingStyle(){for(var e=0;;e++){var t=document.getElementById("j"+e);if(!t)break;t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.maxWidth=20*iScreenScale+"px",t.style.whiteSpace="nowrap",document.getElementById("j"+e)}}function createTeamTable(n){for(var e=[],t=0;t<n.length;t++)e.push(t);e.sort(function(e,t){return n[t]-n[e]});var a=document.createElement("table");a.id="team-table";for(var o='<tr style="font-size: '+1.8*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Team","√âquipe")+"</td><td>Pts</td></tr>",t=0;t<e.length;t++){var i=e[t],r=cTeamColors.name[i];o+='<tr id="fJ'+t+'" style="background-color:'+cTeamColors.primary[i]+'; text-shadow: -1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603"><td>'+toPlace(t+1)+' </td><td id="j'+t+'" style="padding: 0 '+Math.round(iScreenScale/2)+"px; max-width: "+Math.round(12*iScreenScale)+"px; font-size: "+Math.round(Math.max(1,Math.min(14,4.75*iScreenScale/Math.sqrt(r.length))))+'pt; word-wrap: break-word">'+r+'</td><td id="pts'+t+'" style="padding: 0 '+Math.round(iScreenScale/2)+'px">'+n[i]+"</td></tr>"}return a.style.visibility="hidden",a.style.position="absolute",a.style.zIndex=2e4,a.style.left=Math.round(.5*iScreenScale+10)+"px",a.style.top=10*iScreenScale+"px",a.style.backgroundColor="blue",a.style.color=primaryColor,a.style.opacity=.7,a.style.textAlign="center",a.style.fontSize=Math.round(1.5*iScreenScale+2)+"pt",a.style.fontFamily="Courier",a.style.fontWeight="bold",a.style.fontFamily="arial",a.innerHTML=o,$mkScreen.appendChild(a),a}function resetScores(){for(var e=0;e<strPlayer.length;e++)aPlaces[e]=aPlayers.length+e+1;for(e=0;e<aPlayers.length;e++)aPlaces[e+strPlayer.length]=e+1;clGlobalVars=void 0;var t=!(clRuleVars={});aScores.length=aPlaces.length;for(e=0;e<aScores.length;e++)0!==aScores[e]&&(t=!0,aScores[e]=0);return aTracksHist=new Array,iRaceCount=0,t}function continuer(){document.getElementById("infos0").style.border=0,document.getElementById("infos0").style.top=10*iScreenScale+10+"px",document.getElementById("infos0").style.left=Math.round(20*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.background="transparent",document.getElementById("infos0").style.fontSize=4*iScreenScale+"px",document.getElementById("infos0").innerHTML='<tr><td id="continuer"></td></tr><tr><td'+("CM"!=course?' style="font-size: '+3*iScreenScale+'px;">&nbsp;</td></tr>':' id="enregistrer"></td></tr><tr><td id="revoir"></td></tr><tr><td id="classement"></td></tr><tr><td id="changercircuit">')+'</td></tr><tr><td><input type="button" id="quitter" value="'+toLanguage("QUIT","QUITTER")+'" style="font-size: '+3*iScreenScale+'pt; width: 100%;" /></td></tr>';var oTeamTable=document.getElementById("team-table");oTeamTable&&$mkScreen.removeChild(oTeamTable);var oContinue=document.createElement("input"),forceClic3,oQuit,oSave,oReplay,oChangeRace,oClassement;oContinue.type="button",oContinue.style.fontSize=3*iScreenScale+"pt",oContinue.style.width="100%","CM"!=course?oMap.ref%4||"GP"!=course?(isSingle&&!isOnline?oContinue.value="        "+toLanguage("  REPLAY","REJOUER")+"        ":"BB"==course?oContinue.value=toLanguage("      NEXT BATTLE\t   ","BATAILLE SUIVANTE"):oContinue.value=toLanguage("       NEXT RACE\t   ","COURSE SUIVANTE"),forceClic3=!0,oContinue.onclick=function(){forceClic3=!1,nextRace()},isOnline&&setTimeout(function(){forceClic3&&nextRace()},5e3)):(oContinue.value=toLanguage("           NEXT           ","         SUIVANT          "),oContinue.onclick=function(){$mkScreen=document.body,interruptGame();var posX=[29,22,36],posY=[15,17,19],oPlace;document.body.innerHTML=toLanguage("You are","Vous &ecirc;tes")+' <span id="position"></span> !<br /><a href="javascript:location.reload()" style="color: white;">'+toLanguage("Back","Retour")+'</a><img alt="." src="images/podium.gif" style="position: absolute; left: '+20*iScreenScale+"px; top: "+20*iScreenScale+"px; width: "+24*iScreenScale+'px;" />';for(var placement=new Array,i=1;i<=aKarts.length;i++)for(var j=0;j<aKarts.length;j++)if(aKarts[j].place==i){placement.push(aKarts[j]);break}document.body.style.fontSize=2*iScreenScale+"pt";for(var i=0,saveUrl,saveParams;i<placement.length;i++){placement[i]==oPlayers[0]&&(oPlace=i+1);var persoKey=placement[i].personnage;if(i<3)document.body.innerHTML+='<img alt="." src="'+getWinnerSrc(persoKey)+'" style="width: '+4*iScreenScale+"px; position: absolute; left: "+iScreenScale*posX[i]+"px; top: "+iScreenScale*(posY[i]+(isCustomPerso(persoKey)?6:0))+"px;"+(isCustomPerso(persoKey)?"transform:translateY(-100%);-webkit-transform:translateY(-100%);-moz-transform:translateY(-100%);-o-transform:translateY(-100%);-ms-transform:translateY(-100%);":"")+'" />';else if(oPlace)break}document.getElementById("position").innerHTML=toPlace(oPlace),oPlace<=3?(document.body.innerHTML+='<img alt="." src="images/cups/cup'+oPlace+'.png" style="width: '+3*iScreenScale+"px; position: absolute; left: "+30*iScreenScale+"px; top: "+25*iScreenScale+'px;" />',saveParams="pts="+(4-oPlace),"MK"==page?(saveUrl="saveGP.php",saveParams+="&change="+(oMap.map-4)/4):nid&&(saveUrl="cupsave.php",saveParams+=isMCups?"&cup="+cupIDs[oMap.ref/4-1]:"&cup="+nid),saveUrl&&xhr(saveUrl,saveParams,function(reponse){if(reponse){var newPerso,uwPerso,uwPerso;try{newPerso=eval(reponse)}catch(e){return!1}return newPerso&&(uwPerso=toPerso(newPerso),uwPerso=uwPerso.charAt(0).toUpperCase()+uwPerso.substring(1),document.body.innerHTML+='<div style="position: absolute; left: '+16*iScreenScale+"px; top: "+30*iScreenScale+'px; text-align: center">'+toLanguage("You can now play<br />with "+uwPerso+" !","Vous pouvez d&eacute;sormais<br />jouer avec "+uwPerso+" !")+'<br /><img src="'+getWinnerSrc(newPerso)+'" style="width: '+4*iScreenScale+'px" /></div>'),!0}return!1}),bMusic&&(endGPMusic=startMusic("musics/menu/congrats.mp3",!0,700))):bMusic&&(endGPMusic=startMusic("musics/menu/toobad.mp3",!0,700)),reinitChallengeVars(),clLocalVars.endGP=!0,challengeCheck("end_gp")}):(oQuit=document.getElementById("quitter"),oContinue.style.fontSize=oQuit.style.fontSize=3*iScreenScale+"px",oSave=oContinue.cloneNode(!1),oReplay=oContinue.cloneNode(!1),oChangeRace=oContinue.cloneNode(!1),oClassement=oContinue.cloneNode(!1),oContinue.value=gSelectedPerso?toLanguage("        FACE WITH        ","     AFFRONTER     "):toLanguage("          RETRY          ","     R√âESSAYER     "),oContinue.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,map:oMap.ref,difficulty:iDificulty,perso:gPersos,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,lap_times:iLapTimes,cl:clSelected},gSelectedPerso?(fInfos.player=[gSelectedPerso],jTrajets||(fInfos.perso=[strPlayer[0]],fInfos.cpu_route=[iTrajet])):2==gOverwriteRecord&&lapTimers.length==oMap.tours&&(fInfos.cpu_route=[iTrajet],fInfos.perso=strPlayer,fInfos.lap_times=lapTimers),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()},oSave.value="   "+toLanguage("SAVE","ENREGISTRER")+"   ",oSave.onclick=function(){document.getElementById("infos0").style.display="none";var oForm=document.createElement("form"),savedRecord;oForm.style.color="black",oForm.style.position="absolute",oForm.style.left=5*iScreenScale+10+"px",oForm.style.top=5*iScreenScale+10+"px",oForm.style.fontSize=4*iScreenScale+"pt",oForm.style.backgroundColor="#FF6",oForm.style.opacity=.8,oForm.style.border="double 4px black",oForm.style.textAlign="center",oForm.style.width=70*iScreenScale-10+"px",oForm.style.zIndex=2e4,oForm.onsubmit=function(){var nom=this.pseudo.value;if(nom){document.body.style.cursor="progress",oValide.style.visibility="hidden",aPara2.style.visibility="hidden";var params="name="+nom+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS()+"&cc="+getActualCc();switch(page){case"MK":params+="&circuit="+oMap.map;break;case"CI":params+="&creation="+oMap.id;break;case"MA":params+="&map="+oMap.map}function postSaveRecord(reponse){if(reponse){var enregistre;document.body.style.cursor="default";try{enregistre=eval(reponse)}catch(e){return!1}function showBackUi(e){oInput.disabled=!0,oCheckbox.disabled=!0,oValide.parentNode.removeChild(oValide),aPara2.style.fontSize=Math.round(2.5*iScreenScale)+"px",e&&(aPara2.innerHTML=toLanguage("Congratulations "+nom+", your score has been saved successfully ! You placed ","F&eacute;licitations "+nom+", votre score a bien &eacute;t&eacute; enregistr&eacute; ! Vous &ecirc;tes ")+toPlace(enregistre[0])+toLanguage(" out of "+enregistre[1]+" in this race !"," sur "+enregistre[1]+" au classement de ce circuit !"),oSave.style.display="none"),aPara2.style.visibility="",oRetour.focus()}function rollbackUi(){oValide.style.visibility="",oValide.style.marginRight=2*iScreenScale+"px",aPara3.insertBefore(oValide,oRetour),oCheckbox.disabled=!1,oInput.disabled=!1,oInput.select()}if(Array.isArray(enregistre))if(savedRecord=enregistre,oCheckbox.checked){oSave.style.display="none",oValide.style.display="none";var aSmall=document.createElement("span");aSmall.style.fontSize=Math.round(2.5*iScreenScale)+"px",aSmall.innerHTML=toLanguage("Saving ghost...","Enregistrement du fant√¥me..."),aPara2.appendChild(aSmall),aPara2.style.visibility="";var oRequest="map="+getCreationId(oMap)+"&type="+getCreationTable()+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS()+"&times="+JSON.stringify(lapTimers)+"&cc="+getActualCc();for(i=0;i<iTrajet.length;i++)oRequest+="&p"+i+"="+iTrajet[i].toString().replace(/\,/g,"_");xhr("saveghost.php",oRequest,function(e){return 1==e?(gRecord=getActualGameTimeMS(),gOverwriteRecord=gOverwriteRecord&&2,showBackUi(!0),!0):-1==e&&(showBackUi(!1),oValide.style.display="",aPara2.innerHTML=toLanguage('You have exceeded your saved ghosts quota. You can <a href="manageGhosts.php" target="_blank" style="color: orange">delete ghosts</a> to save space','Vous avez d√©pass√© votre quota de fant√¥mes enregistr√©s. Vous pouvez <a href="manageGhosts.php" target="_blank" style="color: orange">supprimer des fant√¥mes</a> pour gagner de l\'espace'),rollbackUi(),!0)})}else showBackUi(!0);else{switch(showBackUi(!1),enregistre){case 0:aPara2.innerHTML=toLanguage("You did a better score on this race before.<br />Your score has not been registered.","Vous avez fait un meilleur score sur ce circuit.<br />Votre temps n'a donc pas &eacute;t&eacute; enregistr&eacute;.");break;case 1:aPara2.innerHTML=toLanguage('This username is already used, please choose another one. If it\'s you, <a href="forum.php" target="_blank" style="color: orange">log-in</a> to your account and try again.','Ce pseudo est d√©j√† utilis√©, veuillez en choisir un autre. S\'il s\'agit de vous, <a href="forum.php" target="_blank" style="color: orange">connectez-vous</a> et r√©essayez.');break;default:aPara2.innerHTML=toLanguage("An unknown error occured, please try again later","Une erreur inconnue est survenue, veuillez r√©essayer ult√©rieurement")}0!=enregistre&&rollbackUi()}return!0}return!1}savedRecord?postSaveRecord(savedRecord):xhr("trackStats.php","stats="+encodeURIComponent(getRecordStats(params)),function(e){return 1==e&&(xhr("records.php",params,postSaveRecord),!0)}),recorder=nom}return!1};var aPara1=document.createElement("p");aPara1.innerHTML=toLanguage("Username: ","Pseudo : "),aPara1.style.margin=iScreenScale+"px";var oInput=document.createElement("input");oInput.type="text",oInput.name="pseudo",oInput.value=recorder,oInput.size=15,oInput.maxlength=18,oInput.style.fontSize=3*iScreenScale+"px",oInput.onkeydown=function(e){e.stopPropagation()},oInput.onkeyup=function(e){e.stopPropagation()},aPara1.appendChild(oInput);var aPara12=aPara1.cloneNode(!1),oCheckLabel=document.createElement("label");oCheckLabel.style.display="inline-block";var oCheckbox=document.createElement("input");oCheckbox.type="checkbox",oCheckbox.name="saveghost",oCheckbox.checked=!0,oCheckbox.style.transform=oCheckbox.style.WebkitTransform=oCheckbox.style.MozTransform="scale("+(iScreenScale/6).toFixed(1)+")",oCheckLabel.appendChild(oCheckbox);var oCheckSpan=document.createElement("span");oCheckSpan.style.fontSize=2*iScreenScale+"px",oCheckSpan.innerHTML=" "+toLanguage("Save ghost","Enregistrer le fant√¥me"),oCheckLabel.appendChild(oCheckSpan),aPara12.appendChild(oCheckLabel),gRecord<=timerMS&&(oCheckbox.checked=!1,aPara12.style.display="none");var aPara2=aPara1.cloneNode(!1),oValide=document.createElement("input");oValide.type="submit",oValide.value="     "+toLanguage("Submit","Valider")+"     ",oValide.style.fontSize=5*iScreenScale+"px",oValide.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oRetour.style.fontSize=4*iScreenScale+"px"},aPara2.appendChild(oValide);var aPara3=aPara1.cloneNode(!1),oRetour=document.createElement("input");oRetour.type="button",oRetour.value="     "+toLanguage("Back","Retour")+"     ",oRetour.style.fontSize=4*iScreenScale+"px",oRetour.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oValide.style.fontSize=4*iScreenScale+"px"},oRetour.onclick=function(){$mkScreen.removeChild(oForm),document.getElementById("infos0").style.display="",oContinue.focus()},aPara3.appendChild(oRetour),oForm.appendChild(aPara1),oForm.appendChild(aPara12),oForm.appendChild(aPara2),oForm.appendChild(aPara3),$mkScreen.appendChild(oForm),oForm.style.height=oForm.scrollHeight+"px",oInput.select()},gSelectedPerso&&(oSave.style.display="none"),document.getElementById("enregistrer").appendChild(oSave),oReplay.value=toLanguage("REPLAY","REVOIR"),oReplay.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),null==(fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,map:oMap.ref,my_route:iTrajet,replay:!0,perso:gPersos,selPerso:gSelectedPerso,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,record:timerMS,lap_times:iLapTimes,cl:clSelected}).record&&(fInfos.record=iRecord),null==fInfos.lap_times&&(fInfos.lap_times=lapTimers),document.getElementById("infos"+e).style.display="none";1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()},document.getElementById("revoir").appendChild(oReplay),oChangeRace.value=toLanguage("     CHANGE RACE     ","   CHANGER CIRCUIT   "),oChangeRace.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,perso:new Array,cl:clSelected},gSelectedPerso&&(fInfos.player=[gSelectedPerso]),1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()},document.getElementById("changercircuit").appendChild(oChangeRace),oClassement.value="RECORDS",oClassement.onclick=function(){open(rankingsLink(oMap))},gSelectedPerso&&(oClassement.style.display="none"),document.getElementById("classement").appendChild(oClassement),isSingle&&(oContinue.style.width=Math.round(36*iScreenScale)+"px",gSelectedPerso&&(oReplay.style.marginTop=oReplay.style.marginBottom=Math.round(2*iScreenScale)+"px"),oChangeRace.style.display="none")),document.getElementById("continuer").appendChild(oContinue),document.getElementById("quitter").onclick=quitter,isChatting()||oContinue.focus()}function nextRace(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,difficulty:iDificulty,cl:clSelected},"GP"==course&&(fInfos.map=oMap.ref+1),($mkScreen.style.opacity=1)==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()}function rankingColor(e){var t=aKarts[e].team,e=getScreenPlayerIndex(e);return-1!=t?(e<oPlayers.length?e?cTeamColors.dark:cTeamColors.light:cTeamColors.primary)[t]:e<oPlayers.length?e?cTeamColors.dark[0]:"#990":"transparent"}var iViewCanvasHeight=240,iViewCanvasWidth=600,iViewYOffset=10,oViewCanvas,prevScreenDelay;function Sprite(e){for(var l=new Array,t=0;t<strPlayer.length;t++){this[t]={};var n=new Image;n.style.position="absolute",n.style.left="200px",n.alt=".",n.className="pixelated",n.src=getSpriteSrc(e);var a=document.createElement("div");a.style.width="32px",a.style.height="32px",a.style.position="absolute",a.style.overflow="hidden",a.style.zIndex=1e4,a.className="pixelated",a.style.display="none",a.appendChild(n),oContainers[t].appendChild(a),this[t].i=t,this[t].w=32,this[t].h=32,this[t].z=0,this[t].draw=function(e,t,n,a){a=a||0;var o=this.i,i=this.w*fSpriteScale*n,r=this.h*fSpriteScale*n,n=t-r*(this.z+1)+i/2;isNaN(n)||n>iHeight*iScreenScale||t+a*iScreenScale<9*iScreenScale?l[o][0].style.display="none":(l[o][0].style.display="block",l[o][0].style.left=Math.round(e-i/2)+"px",l[o][0].style.top=Math.round(n)+"px",this.h!=this.w?l[o][1].style.width=Math.round(i)*this.nbSprites+"px":l[o][1].style.width="",l[o][1].style.height=Math.round(r)+"px",l[o][0].style.width=Math.round(i)+"px",l[o][0].style.height=Math.round(r)+"px",l[o][1].style.left=-(Math.round(i)*l[o][2])+"px")},this[t].render=function(e,t){var n=t.size||1,a=(t.x-e.x)*getMirrorFactor(),o=t.y-e.y,i=e.rotation*Math.PI/180*getMirrorFactor(),e=a*Math.cos(i)-o*Math.sin(i),a=a*Math.sin(i)+o*Math.cos(i),o=-iCamHeight,i=iCamDist+a,t=t.z?correctCamZ(t.z,i):0,i=o/i*iCamDist+iCamHeight-iViewHeight+t,e=-e/(a+iCamDist)*iCamDist;this.div.style.zIndex=Math.round(1e4-a);e=(iWidth/2+e)*iScreenScale,i=(iHeight-i)*iScreenScale,n*=fFocal/(fFocal+a);this.draw(e,i,n,t)},this[t].setState=function(e){l[this.i][2]=e},this[t].getState=function(){return l[this.i][2]},this[t].div=a,this[t].img=n,l.push([a,n,0])}var o=this;this[0].unshow=function(){o[0].suppr(),o[0].unshown=!0},this[0].suppr=function(){if(!o[0].unshown)for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(l[e][0])},this[0].fadein=function(e){var n,a;o[0].unshown||(n=0,a=SPF/e,function e(){1<=n&&(n="");for(var t=0;t<strPlayer.length;t++)l[t][0].style.opacity=n;""!==n?(n+=a,o[0].fadeinhandler=setTimeout(e,SPF)):delete o[0].fadeinhandler}())},this[0].fadeout=function(e){var n,a;o[0].unshown||(n=1,o[0].fadeinhandler&&(clearTimeout(o[0].fadeinhandler),n=0),a=SPF/e,function e(){if((n-=a)<=0)o[0].suppr();else{for(var t=0;t<strPlayer.length;t++)l[t][0].style.opacity=n;setTimeout(e,SPF)}}())}}function BGLayer(t,n,a){var o=new Array;function i(e,t){a?setTimeout(e,t):e()}var r=new Image;r.src=t,iSmooth||(r.className="pixelated");for(var e=0;e<oContainers.length;e++){var l=document.createElement("div");l.style.height=10*iScreenScale+"px",l.style.width=iWidth*iScreenScale+"px",l.style.position="absolute",function(e){i(function(){e.style.backgroundImage="url('"+t+"')"},300)}(l),l.style.backgroundSize="auto 100%",iSmooth||(l.className="pixelated"),oContainers[e].appendChild(l),o[e]=l}return{draw:function(e,t){r.naturalWidth&&(bSelectedMirror&&(e=-e),e=(e-360*Math.ceil(e/360))*(10*iScreenScale*r.naturalWidth/r.naturalHeight*n/360),o[t].style.backgroundPosition=Math.round(e)+"px 0")},clone:function(e,t){var n=o[e].cloneNode(!0);return i(function(){n.style.backgroundImage=o[e].style.backgroundImage},500),t.appendChild(n),{drawCurrentState:function(){n.style.backgroundPosition=o[e].style.backgroundPosition},suppr:function(){t.removeChild(n)}}},suppr:function(){for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(o[e])}}}function GIF(){var n,t,a,o,d,i,h,r=[0,4,2,1],l=[8,8,4,2],s={GCExt:249,COMMENT:254,APPExt:255,UNKNOWN:1,IMAGE:44,EOF:59,EXT:33},c=function(e){this.data=new Uint8ClampedArray(e),this.pos=0;var a=this.data.length;this.getString=function(e){for(var t="";e--;)t+=String.fromCharCode(this.data[this.pos++]);return t},this.readSubBlocks=function(){var e,t,n="";do{for(t=e=this.data[this.pos++];t--;)n+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<a);return n},this.readSubBlocksB=function(){var e,t,n=[];do{for(t=e=this.data[this.pos++];t--;)n.push(this.data[this.pos++])}while(0!==e&&this.pos<a);return n}};function p(e){for(var t=[],n=0;n<e;n++)t.push([a.data[a.pos++],a.data[a.pos++],a.data[a.pos++]]);return t}function u(){var e,t=function(e){var t,n=i/e,a=0;for(o!==i&&(d=new Uint8Array(i),o=i),t=0;t<4;t++)for(toLine=r[t];toLine<n;toLine+=l[t])d.set(h.subArray(a,a+e),toLine*e),a+=e},n={};C.frames.push(n),n.disposalMethod=C.disposalMethod,n.time=C.length,n.delay=10*C.delayTime,C.length+=n.delay,C.transparencyGiven?n.transparencyIndex=C.transparencyIndex:n.transparencyIndex=void 0,n.leftPos=a.data[a.pos++]+(a.data[a.pos++]<<8),n.topPos=a.data[a.pos++]+(a.data[a.pos++]<<8),n.width=a.data[a.pos++]+(a.data[a.pos++]<<8),n.height=a.data[a.pos++]+(a.data[a.pos++]<<8),e=a.data[a.pos++],n.localColourTableFlag=!!(128&e),n.localColourTableFlag&&(n.localColourTable=p(1<<1+(7&e))),i!==n.width*n.height&&(h=new Uint8Array(n.width*n.height),i=n.width*n.height),function(e,t){for(var n,a,o,i,r,l,s=a=0,c=[],p=1<<e,u=1+p,d=e+1,m=!1;!m;){for(i=o,n=o=0;n<d;n++)t[s>>3]&1<<(7&s)&&(o|=1<<n),s++;if(o===p){for(c=[],d=e+1,n=0;n<p;n++)c[n]=[n];c[p]=[],c[u]=null}else{if(o===u)return m=!0;for(o>=c.length?c.push(c[i].concat(c[i][0])):i!==p&&c.push(c[i].concat(c[o][0])),l=(r=c[o]).length,n=0;n<l;n++)h[a++]=r[n];c.length===1<<d&&d<12&&d++}}}(a.data[a.pos++],a.readSubBlocksB()),64&e?(n.interlaced=!0,t(n.width)):n.interlaced=!1,function(e){var t,n,a,o,i,r,l,s,c,p,u;for(e.image=document.createElement("canvas"),e.image.width=C.width,e.image.height=C.height,e.image.ctx=e.image.getContext("2d"),t=e.localColourTableFlag?e.localColourTable:C.globalColourTable,null===C.lastFrame&&(C.lastFrame=e),(r=2===C.lastFrame.disposalMethod||3===C.lastFrame.disposalMethod)||e.image.ctx.drawImage(C.lastFrame.image,0,0,C.width,C.height),n=e.image.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),u=e.transparencyIndex,a=n.data,c=e.interlaced?d:h,o=c.length,l=i=0;l<o;l++)s=c[l],p=t[s],u!==s?(a[i++]=p[0],a[i++]=p[1],a[i++]=p[2],a[i++]=255):(r&&(a[i+3]=0),i+=4);e.image.ctx.putImageData(n,e.leftPos,e.topPos),C.lastFrame=e,C.waitTillDone||"function"!=typeof C.onload||S()}(n)}function m(){C.loading=!1,C.frameCount=C.frames.length,C.lastFrame=null,a=void 0,C.complete=!0,C.disposalMethod=void 0,C.transparencyGiven=void 0,C.delayTime=void 0,C.transparencyIndex=void 0,C.waitTillDone=void 0,d=i=d=h=void 0,(C.currentFrame=0)<C.frames.length&&(C.image=C.frames[0].image,"function"==typeof C.onloadone&&(C.onloadone.bind(C)({type:"load",path:[C]}),delete C.onloadone)),S(),"function"==typeof C.onloadall&&C.onloadall.bind(C)({type:"loadall",path:[C]}),C.playOnLoad&&C.play()}function g(){var e,t=a.data[a.pos++];t===s.GCExt?(a.pos++,e=a.data[a.pos++],C.disposalMethod=(28&e)>>2,C.transparencyGiven=!!(1&e),C.delayTime=a.data[a.pos++]+(a.data[a.pos++]<<8),C.transparencyIndex=a.data[a.pos++],a.pos++):t===s.COMMENT?C.comment+=a.readSubBlocks():t===s.APPExt?(a.pos+=1,"NETSCAPE"===a.getString(8)?a.pos+=8:(a.pos+=3,a.readSubBlocks())):(t===s.UNKNOWN&&(a.pos+=13),a.readSubBlocks())}function y(){if(void 0!==C.cancel&&!0===C.cancel)return m(),void("function"==typeof C.cancelCallback&&C.cancelCallback.bind(C)({type:"canceled",path:[C]}));var e=a.data[a.pos++];if(e===s.IMAGE){if(u(),C.firstFrameOnly)return void m()}else{if(e===s.EOF)return void m();g()}C.frames.length&&"function"==typeof C.onloadone&&(C.image=C.frames[0].image,C.onloadone.bind(C)({type:"load",path:[C]}),delete C.onloadone),"function"==typeof C.onprogress&&C.onprogress({bytesRead:a.pos,totalBytes:a.data.length,frame:C.frames.length}),t=setTimeout(y,0)}function f(e){"function"==typeof C.onerror&&C.onerror.bind(this)({type:e,path:[this]}),C.onload=C.onerror=void 0,C.loading=!1}function S(){C.currentFrame=0,C.nextFrameAt=C.lastFrameAt=(new Date).valueOf(),"function"==typeof C.onload&&C.onload.bind(C)({type:"load",path:[C]}),C.onerror=C.onload=void 0}function v(e){(a=new c(e)).pos+=6,C.width=a.data[a.pos++]+(a.data[a.pos++]<<8),C.height=a.data[a.pos++]+(a.data[a.pos++]<<8),e=a.data[a.pos++],C.colorRes=(112&e)>>4,C.globalColourCount=1<<1+(7&e),C.bgColourIndex=a.data[a.pos++],a.pos++,128&e&&(C.globalColourTable=p(C.globalColourCount)),t=setTimeout(y,0)}function b(){var e;0===C.playSpeed?C.pause():(e=C.playSpeed<0?(--C.currentFrame,C.currentFrame<0&&(C.currentFrame=C.frames.length-1),e=C.currentFrame,--e<0&&(e=C.frames.length-1),-C.frames[e].delay/C.playSpeed):(C.currentFrame+=1,C.currentFrame%=C.frames.length,+C.frames[C.currentFrame].delay/C.playSpeed),C.image=C.frames[C.currentFrame].image,n=setTimeout(b,e))}var C={onload:null,onerror:null,onprogress:null,onloadall:null,paused:!1,playing:!1,waitTillDone:!0,loading:!1,firstFrameOnly:!1,width:null,height:null,frames:[],comment:"",length:0,currentFrame:0,frameCount:0,playSpeed:1,lastFrame:null,image:null,playOnLoad:!0,load:function(e){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.onload=function(e){404===e.target.status?f("File not found"):200<=e.target.status&&e.target.status<300?v(t.response):f("Loading error : "+e.target.status)},t.open("GET",e,!0),t.send(),t.onerror=function(e){f("File error")},this.src=e,this.loading=!0},cancel:function(e){return!C.complete&&(C.cancelCallback=e,C.cancel=!0)},play:function(){C.playing||(C.paused=!1,C.playing=!0,b())},pause:function(){C.paused=!0,C.playing=!1,clearTimeout(n)},seek:function(e){clearTimeout(n),e<0&&(e=0),e*=1e3,e%=C.length;for(var t=0;e>C.frames[t].time+C.frames[t].delay&&t<C.frames.length;)t+=1;C.currentFrame=t,C.playing?b():C.image=C.frames[C.currentFrame].image},seekFrame:function(e){clearTimeout(n),C.currentFrame=e%C.frames.length,C.playing?b():C.image=C.frames[C.currentFrame].image},togglePlay:function(){C.paused||!C.playing?C.play():C.pause()},clear:function(){clearTimeout(n),clearTimeout(t),C.frames.length=0}};return C}function createMarker(r){for(var e={div:new Array},t=0;t<strPlayer.length;t++){var n=document.createElement("div");n.style.display="none",n.style.position="absolute",n.style.opacity=.7;var a=-1==r.team?"#EEE":cTeamColors.primary[r.team],o=12*iScreenScale,i=3*iScreenScale,l=Math.PI/4,s=Math.round(iScreenScale/4),c=Math.cos(l),p=Math.sin(l),u=document.createElement("div");u.style.position="absolute",u.style.width=s+"px",u.style.height=i+"px",u.style.backgroundColor=a,u.style.left="0px",u.style.bottom="0px",u.style.transform=u.style.WebkitTransform=u.style.MozTransform="rotate("+Math.round(180*l/Math.PI)+"deg)",u.style.transformOrigin=u.style.WebkitTransformOrigin=u.style.MozTransformOrigin="bottom left",n.appendChild(u);u=document.createElement("div");u.style.position="absolute",u.style.width=o+"px",u.style.height=s+"px",u.style.backgroundColor=a,u.style.left=Math.round(i*Math.sin(l))+"px",u.style.bottom=Math.round(i*c-s*p)+"px",n.appendChild(u);s=document.createElement("div");s.style.color=-1==r.team?"#555":a,s.style.whiteSpace="nowrap";u=-1==r.team?"#EEE":cTeamColors.secondary[r.team],a=Math.ceil(iScreenScale/4)+"px";s.style.textShadow="-"+a+" 0 "+u+", 0 "+a+" "+u+", "+a+" 0 "+u+", 0 -"+a+" "+u,r.nick?s.innerHTML=r.nick:(s.style.textTransform="capitalize",s.innerHTML=toPerso(r.personnage)),s.style.position="absolute",s.style.left=Math.round(i*p)+"px",s.style.bottom=Math.round(i*c)+"px",s.style.width=Math.round(o-.5*iScreenScale)+"px",s.style.overflow="hidden",s.style.fontSize=Math.round(1.5*iScreenScale)+"px",s.style.textAlign="right",n.appendChild(s),e.div.push(n),oContainers[t].appendChild(n)}return e.draw=function(e,t,n,a,o){o=o||0;var i=this.div[e];n>iHeight*iScreenScale||n+o*iScreenScale<12*iScreenScale?i.style.display="none":(i.style.display="block",a=Math.round(r.sprite[e].h*fSpriteScale*a),i.style.left=Math.round(t)+"px",i.style.top=Math.round(n-a/2)+"px")},e.render=function(e,t,n){var a=n.size||1,o=(n.x-t.x)*getMirrorFactor(),i=n.y-t.y,r=t.rotation*Math.PI/180*getMirrorFactor(),t=o*Math.cos(r)-i*Math.sin(r),o=o*Math.sin(r)+i*Math.cos(r),i=-iCamHeight,r=iCamDist+o,n=correctCamZ(n.z,r),r=i/r*iCamDist+iCamHeight-iViewHeight+n,t=-t/(o+iCamDist)*iCamDist;this.div[e].style.zIndex=Math.round(1e4-o);t=(iWidth/2+t)*iScreenScale,r=(iHeight-r)*iScreenScale,a*=fFocal/(fFocal+o);this.draw(e,t,r,a,n)},e}var prevScreenCur=0,prevScreenOpacity=0,prevScreenFade=0;function clonePreviousScreen(e,t){if(prevScreenDelay){var n=oPrevFrameStates[e];n[prevScreenCur].canvas.getContext("2d").drawImage(oScreens[e],0,0);for(var a=0;a<oBgLayers.length;a++)n[prevScreenCur].layer[a].drawCurrentState();n[prevScreenCur].opacity=Math.max(0,Math.min(prevScreenOpacity,t.speed*prevScreenOpacity/8));for(a=0;a<prevScreenDelay;a++){var o=(prevScreenCur-a+prevScreenDelay)%prevScreenDelay;n[a].container.style.zIndex=prevScreenDelay-o,n[a].container.style.opacity=n[a].opacity*Math.pow(prevScreenFade,o)}prevScreenDelay<=++prevScreenCur&&(prevScreenCur=0)}}function redrawCanvas(e,t,n){var a=oViewCanvas.getContext("2d");a.fillStyle="rgb("+n.bgcolor+")",a.fillRect(0,0,oViewCanvas.width,oViewCanvas.height),a.save(),a.translate(iViewCanvasWidth/2,iViewCanvasHeight-iViewYOffset),bSelectedMirror&&a.scale(-1,1),a.rotate((180+t.rotation)*Math.PI/180);var o=t.x,i=t.y,t=n.mapImg;t.image?a.drawImage(t.image,-o,-i):a.drawImage(t,-o,-i);for(var r=0;r<n.assets.length;r++){var l=n.assets[r];a.drawImage(l.canvas,l.x-o,l.y-i)}n.sea&&n.sea.render(a,[o,i],1),a.restore(),oScreens[e].getContext("2d").imageSmoothingEnabled=iSmooth;for(var s=oScreens[e].getContext("2d"),c=1/fLineScale,p=iViewCanvasHeight-iViewYOffset-1,u=iWidth*c,r=0;r<aStrips.length;r++){var d=aStrips[r];try{s.drawImage(oViewCanvas,(iViewCanvasWidth-d.stripwidth)/2,p-d.mapz,d.stripwidth,d.mapzspan,0,(iHeight-d.viewy)*c,u,1)}catch(e){}}}function byteType(e){return{key:e,type:"byte"}}function shortType(e){return{key:e,type:"short"}}function floatType(e){return{key:e,type:"float"}}function intType(e){return{key:e,type:"int"}}for(var maxItemHitboxZ=5,itemBehaviors={banane:{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown")],fadedelay:100,frminv:!0,move:function(e){e.countdown&&handleSpriteLaunch(e,12,.2)}},fauxobjet:{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown")],fadedelay:100,frminv:!0,move:function(e){e.countdown&&handleSpriteLaunch(e,12,.2)}},poison:{size:.54,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown")],fadedelay:100,frminv:!0,move:function(e){e.countdown&&handleSpriteLaunch(e,12,.2)}},champi:{size:.54,sync:[floatType("x"),floatType("y"),floatType("z")],fadedelay:100},etoile:{size:.54,sync:[floatType("x"),floatType("y"),floatType("z")],fadedelay:100},eclair:{size:1,sync:[intType("owner")],fadedelay:0,sprite:!1,onlineResync:!1,move:function(t){if(void 0===t.countdown){t.countdown=20;var e=aKarts.find(function(e){return e.id==t.owner});if(e){!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/lightning.mp3"),$mkScreen.style.opacity=.7;for(var n=0;n<aKarts.length;n++){var a=aKarts[n];friendlyFire(a,e)||(a.protect?a.megachampi&&!a.etoile&&(a.megachampi=Math.min(a.megachampi,8),a.size=Math.pow(1.05,a.megachampi)):(isOnline&&n&&a.controller!=identifiant||(a.size=.6),a.mini=Math.round(Math.max(a.mini,110-35*(a.place-1)/(aKarts.length-1))),loseUsingItems(a),a.champi=0,delete a.champiType,a.spin(20),stopDrifting(n),dropCurrentItem(a),handleItemHit(a,"eclair")))}}}var o;isOnline&&!t.id||(o=0!=itemDistribution.lightningdelay?-300:-50,t.countdown--,t.countdown<=0&&(t.countdown<o?detruit(t):t.disabled||(t.disabled=!0,$mkScreen.style.opacity=1)))},del:function(e){e.disabled||($mkScreen.style.opacity=1)}},pow:{size:1,sync:[intType("owner")],sprite:!1,countdowns:[2,1,12,1,1,12,1,1,3],onlineResync:!1,move:function(t){if(!t.affect){var n=aKarts.find(function(e){return e.id==t.owner});t.affect=new Array(aKarts.length);for(let e=0;e<aKarts.length;e++){var a=aKarts[e];t.affect[e]=a.place<n.place&&a!=n}}if(!t.sprites){if(1<items.pow.length&&1!=itemDistribution.powx2)return void detruit(t);t.countdown=0,t.countstate=0;var e=aKarts.find(function(e){return e.id==t.owner});if(!e)return!1;t.sprites=new Array(oPlayers.length);for(var o=0;o<aKarts.length;o++){var i,r=aKarts[o];c||!iSfx||finishing||r!==oPlayers[0]||playSoundEffect("musics/events/pow.mp3"),r!==e&&friendlyFire(r,e)||(onlineSpectatorId||(i={pow:{elt:document.createElement("img"),owner:t.owner}},o<oPlayers.length&&((d=i.pow.elt).src="images/sprites/sprite_pow.png",d.className="pixelated",d.style.position="absolute",d.style.width=7*iScreenScale+"px",i.pow.x=36,i.pow.y=14,d.style.zIndex=19003,d.style.transition="left "+SPF/1e3+"s ease-out, top "+SPF/1e3+"s ease-out, transform "+SPF/1e3+"s ease, height "+SPF/1e3+"s ease",d.style.opacity=friendlyFire(r,e)?1:0,oContainers[o].appendChild(d),t.sprites[o]=i)),r.pow=t)}}var l=itemBehaviors.pow,s=l.countdowns[t.countstate],c=t.countdown/s;t.countdown++;var p=t.countdown/s,u=aKarts.find(function(e){return e.id==t.owner});if(!u)return!1;for(o=0;o<t.sprites.length;o++){var d,m=t.sprites[o],r=aKarts[o];if(m&&(t.affect[o]||r==u))if(d=m.pow){switch(t.countstate){case 0:d.elt.style.opacity=p,d.elt.style.transform="scale("+p+")";break;case 1:d.elt.style.transform="scale(1.4)";break;case 2:d.elt.style.transform="scale(1.0)";break;case 3:d.elt.style.transform="scale(1.6)",d.elt.style.height=5*iScreenScale+"px",d.y+=.75;break;case 4:d.elt.style.transform="scale(1.0)",d.elt.style.height=4*iScreenScale+"px",d.y+=.75;break;case 5:break;case 6:d.elt.style.transform="scale(1.8)",d.elt.style.height=3*iScreenScale+"px",d.y+=.75;break;case 7:d.elt.style.height=2*iScreenScale+"px",d.y+=.75;break;case 8:d.elt.style.transform="scale("+(1-p)+")",d.elt.style.opacity=1-p}d.elt.style.left=iScreenScale*d.x+"px",d.elt.style.top=iScreenScale*d.y+"px"}}for(let e=0;e<aKarts.length;e++)t.affect[e]&&playPow(e,aKarts[e],u,t);t.countdown>=s&&(t.countstate++,t.countdown=0,t.countstate>=l.countdowns.length&&detruit(t))},del:function(e){if(0!=itemDistribution.powdelay&&(nextPowCooldown=450),e.sprites){for(var t=0;t<e.sprites.length;t++){var n=e.sprites[t];n&&n.pow&&oContainers[t].removeChild(n.pow.elt)}for(t=0;t<aKarts.length;t++)if(aKarts[t].pow===e){for(var a=0;a<oPlayers.length;a++)aKarts[t].sprite[a].img.style.filter="";delete aKarts[t].pow}}}},bloops:{size:1,sync:[intType("owner")],fadedelay:0,sprite:!1,countdowns:[5,5,15,3,2,3,3,2,2,13,7,5,5,100,15],onlineResync:!1,move:function(t){if(!t.sprites){if(1<items.bloops.length)return void detruit(t);if(t.countdown=0,t.countstate=0,!(u=aKarts.find(function(e){return e.id==t.owner})))return!1;t.sprites=new Array(oPlayers.length);for(var e=0;e<aKarts.length;e++){var n,a,o=aKarts[e];o!==u&&(friendlyFire(o,u)||o.protect)||(e<oPlayers.length&&!onlineSpectatorId&&((c=(n={bloops:{elt:document.createElement("img"),mine:o===u}}).bloops.elt).src="images/sprites/sprite_blooper.png",c.className="pixelated",c.style.position="absolute",c.style.width=7*iScreenScale+"px",n.bloops.x=36,n.bloops.y=n.bloops.mine?18:12,c.style.zIndex=19001,c.style.opacity=n.bloops.mine?1:0,1<nbFrames&&(a=SPF/1e3,c.style.transition="left "+a+"s ease-out, top "+a+"s ease-out"),oContainers[e].appendChild(c),t.sprites[e]=n),o.bloops=t)}t.effective=function(e){return 13==this.countstate&&!e.unbloop&&this.owner!==e.id}}var i=itemBehaviors.bloops,r=i.countdowns[t.countstate],l=t.countdown/r;t.countdown++;for(var s=t.countdown/r,e=0;e<t.sprites.length;e++){var c,p=t.sprites[e],u=aKarts[e];if(p)if(c=p.bloops){switch(t.countstate){case 0:c.mine&&(c.y-=2,l||!iSfx||finishing||playSoundEffect("musics/events/bloops0.mp3"));break;case 1:c.mine&&(c.y-=.5*Math.cos(Math.PI*l/2),c.elt.style.opacity=1-s,t.countdown==r&&(oContainers[e].removeChild(c.elt),delete p.bloops));break;case 3:c.elt.style.opacity=s;break;case 4:l||!iSfx||finishing||e||playSoundEffect("musics/events/bloops.mp3"),c.y+=2;break;case 5:c.y-=2*Math.cos(Math.PI*l/2);break;case 6:c.x+=2,c.y-=2*Math.cos(Math.PI*(.2+l)/1.2);break;case 7:case 8:c.x+=2,c.y+=2;break;case 9:var d=Math.pow(Math.cos(Math.PI*l*.45),1.2);c.x-=6*Math.sin(1.5*Math.PI*l)*d,c.y-=4*Math.cos(1.5*Math.PI*l)*d;break;case 10:c.x+=2,c.y-=2.5*Math.cos(Math.PI*l);break;case 11:c.x-=Math.sin(Math.PI*s/2),--c.y;break;case 12:if(c.elt.style.opacity=1-s,!p.ink){for(var m=[],h=3e3;0<h;){var g=100+400*Math.random();h<g&&(g=h)<100&&(g=100),m.push(g),h-=g}p.ink=[];var d=iWidth/iHeight,y=Math.sqrt(m.length*d),d=y/d,f=Math.ceil(d),S=iWidth/y,v=iHeight/f,b=y*f/m.length;function C(e){return Math.random()-e}for(var x=0;x<m.length;x++){var M=(x+.5)*b,P=M/y,k=M%y*S,I=(Math.floor(P)+.5)*v,w=.5+((w=P%1)-.5)/2,M=.5+((M=(Math.floor(P)+.5)/f)-.5)/2,P=Math.sqrt(m[x]);(E={x:k+.6*P*C(w),y:I+.5*P*C(M),theta:360*Math.random(),w:P*(1+.1*C(.5)),h:P*(1+.1*C(.5)),margin:1.25}).y-=1075/(E.w*E.h),p.ink.push(E)}for(x=0;x<p.ink.length;x++)!function(n){var a,o=document.createElement("canvas");o.style.opacity=.95,(a=document.createElement("img")).src="images/sprites/sprite_ink.png",a.className="pixelated",a.dataset||(this.dataset={}),o.draw=function(e){var t;a.dataset.jTime=e,a.dataset.loaded&&((t=o.getContext("2d")).setTransform(1,0,0,1,0,0),t.clearRect(0,0,o.width,o.height),e=e/n.margin,t.translate(o.width/2,o.height/2),t.rotate(n.theta*Math.PI/180),t.translate(o.width*(1-e)/2,o.height*(1-e)/2),t.drawImage(a,-o.width/2,-o.height/2,o.width*e,o.height*e))},a.onload=function(){this.dataset.loaded=1,this.dataset.jTime&&o.draw(+this.dataset.jTime)},o.style.zIndex=19e3,o.style.position="absolute",o.style.left=Math.round((n.x-(n.w+n.margin-1)/2)*iScreenScale)+"px",o.style.top=Math.round((n.y-(n.h+n.margin-1)/2)*iScreenScale)+"px",o.width=Math.round(n.w*iScreenScale*n.margin),o.height=Math.round(n.h*iScreenScale*n.margin),oContainers[e].appendChild(o),n.elt=o}(p.ink[x])}for(x=0;x<p.ink.length;x++)(E=p.ink[x]).elt.draw(s);break;case 13:for(x=0;x<p.ink.length;x++){var L=(E=p.ink[x]).elt;E.y+=20/(E.w*E.h),L.style.top=Math.round((E.y-E.h/2)*iScreenScale)+"px"}break;case 14:for(x=0;x<p.ink.length;x++){L=(E=p.ink[x]).elt;E.y+=10/(E.w*E.h),L.style.top=Math.round((E.y-E.h/2)*iScreenScale)+"px",u.unbloop||(L.style.opacity=.95*(1-l))}}c.elt.style.left=iScreenScale*c.x+"px",c.elt.style.top=iScreenScale*c.y+"px"}}if(12<=t.countstate)for(e=0;e<aKarts.length;e++){u=aKarts[e];if(!u.unbloop&&(u.protect||u.champi||u.tombe)&&(u.unbloop=12==t.countstate&&u.protect?5:1),u.unbloop&&u.unbloop<=5){var T=u.unbloop/5;if(u.bloops===t&&t.owner!==u.id)for(x=0;x<oPlayers.length;x++)u.sprite[x].img.style.filter="brightness("+(.15+.85*T)+")";if((p=t.sprites[e])&&p.ink)for(var E,x=0;x<p.ink.length;x++)(L=(E=p.ink[x]).elt).style.opacity=.95*(1-T);u.unbloop++}}switch(t.countstate){case 12:for(e=0;e<aKarts.length;e++)if(!(u=aKarts[e]).unbloop&&u.bloops===t&&t.owner!==u.id)for(x=0;x<oPlayers.length;x++)u.sprite[x].img.style.filter="brightness("+(1-.85*s)+")";break;case 14:for(e=0;e<aKarts.length;e++)if(!(u=aKarts[e]).unbloop&&u.bloops===t&&t.owner!==u.id)for(x=0;x<oPlayers.length;x++)u.sprite[x].img.style.filter="brightness("+(.15+.85*s)+")"}t.countdown>=r&&(t.countstate++,t.countdown=0,t.countstate>=i.countdowns.length&&detruit(t))},del:function(e){if(e.sprites){for(var t=0;t<e.sprites.length;t++){var n=e.sprites[t];if(n){n.bloops&&oContainers[t].removeChild(n.bloops.elt);var a=n.ink;if(a)for(var o=0;o<a.length;o++)oContainers[t].removeChild(a[o].elt)}}for(t=0;t<aKarts.length;t++)if(aKarts[t].bloops===e){for(o=0;o<oPlayers.length;o++)aKarts[t].sprite[o].img.style.filter="";delete aKarts[t].bloops,delete aKarts[t].unbloop}}}},carapace:{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("vx"),floatType("vy"),intType("owner"),byteType("lives")],fadedelay:300,frminv:!0,move:function(e,t){for(var n,a,o=cappedRelSpeed(),i=0;i<2;i++){var r=e.vx*o/2,l=e.vy*o/2;if(r||l){if(n=e.x+r,a=e.y+l,!i)for(var s=0;s<oPlayers.length;s++)e.sprite[s].setState(1-e.sprite[s].getState())}else n=e.x,a=e.y;var c,p=e.x,u=e.y,d=n,m=a,h=[e];t&&t.onlineSync&&(h=otherPlayerItems(h),c=otherPlayerItems([])),collisionDecorHit=collisionFloor=null,collisionLap=getItemCollisionLap(collisionItem=e);var g,y=-1!=e.owner;if(y&&(g=inTeleport(p,u))){e.x=g[0],e.y=g[1];var f=g[2]*Math.PI/2,S=Math.hypot(e.vx,e.vy);e.vx=S*Math.sin(f),e.vy=S*Math.cos(f)}else{if(y&&tombe(p,u)||touche_banane(p,u,c)||touche_banane(d,m,c)||touche_crouge(p,u,c)||touche_crouge(d,m,c)||touche_cverte(p,u,h)||touche_cverte(d,m,h)||touche_bobomb(p,u,c,{transparent:!0})||touche_bobomb(d,m,c,{transparent:!0})){detruit(e,!0);break}if(y&&!canMoveTo(e.x,e.y,0,r,l)){e.lives--,collisionDecorHit&&(e.lives=0),0<e.lives?(u=(h=getHorizontality(e.x,e.y,collisionFloor?collisionFloor.z:0,r,l))[0],m=h[1],h=(r=e.vx)*u+(l=e.vy)*m,e.vx=.7*(2*h*u-r),e.vy=.7*(2*h*m-l)):detruit(e);break}if(t&&t.checkCollisions&&(t.checkCollisions(e),e.deleted))break;e.x=n,e.y=a,i||tendsToSpeed(e,12,.2),y&&checkItemLap(e,{aPos:[p,d]})}}},checkCollisions:function(e,t){var n=aKarts[t];n.z<maxItemHitboxZ&&touche_cverte_aux(n.x,n.y,e)&&(friendlyHit(n.team,e.team)||handleHardHit(t))}},bobomb:{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown"),byteType("cooldown")],fadedelay:0,move:function(e){-1!=e.theta&&(e.countdown?handleSpriteLaunch(e,15,.2):(e.z=0,collisionLap=getItemCollisionLap(e),tombe(e.x,e.y)&&detruit(e),30==--e.cooldown&&(e.cooldown-=12),e.cooldown<-10?detruit(e):e.cooldown<0&&handleDecorExplosions(e,touche_bobomb_aux)))},checkCollisions:function(e,t){var n=aKarts[t];touche_bobomb_aux(n.x,n.y,e)&&(friendlyHit(n.team,e.team)||e.cooldown<=0&&handleExplosionHit(t,e.cooldown<-5?42:84))},render:function(e,t){if(e.cooldown<=0){if(!t&&1==e.size){for(var n,a=0;a<strPlayer.length;a++)makeSpriteExplode(e,"",a),"block"==e.sprite[a].div.style.display&&(n=a);isOnline||null==n?(e.size=6,playDistSound({x:e.x,y:e.y},"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,reprendre(!(e.size=6)),playDistSound({x:e.x,y:e.y},"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=1+e.cooldown/10}},drop:function(e,t){e.theta=t.rotation+180,e.cooldown=60,e.countdown=1}},"carapace-rouge":{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),intType("owner"),shortType("aipoint"),byteType("aimap"),byteType("ailap"),byteType("ailapt"),intType("target")],fadedelay:300,frminv:!0,move:function(t,e){for(var n=0;n<5;n++){var a,o=(t.heightinc?15:12)*cappedRelSpeed()/5;if(-1!=t.owner){if(t.cannon){t.z=(3*t.z+4)/4;var i=t.cannon[0]-t.x,r=t.cannon[1]-t.y,l=Math.hypot(i,r);(o=4)<l?(t.x+=i*o/l,t.y+=r*o/l):(t.x=t.cannon[0],t.y=t.cannon[1],delete t.cannon);continue}if(!n)for(var s=0;s<oPlayers.length;s++)t.sprite[s].setState(1-t.sprite[s].getState());if(0<=t.target){var c=aKarts.find(function(e){return e.id==t.target});if((L=Math.pow(c.x-t.x,2)+Math.pow(c.y-t.y,2))<500){if(h=c.x,g=c.y,t.ailap=getCurrentLapId(c),delete t.ailapt,delete t.ailapc,c.using.length&&"fauxobjet"!=c.using[0].type){for(var p=Math.atan2(t.y-g,t.x-h)-(90-c.rotation)*Math.PI/180,u=2*Math.PI;p<0;)p+=u;for(;u<p;)p-=u;if(p>Math.PI&&(p=u-p),Math.abs(p)>Math.PI/2)return h=c.using[0].x,g=c.using[0].y,t.x=h,t.y=g,collisionLap=t.ailap,"bobomb"===c.using[0].type&&touche_bobomb(h,g,onlyThisItems([c.using[0]]))?void 0:(detruit(t),void(c.using[0]&&detruit(c.using[0],!0)));c.using[0].x-=2*direction(0,c.rotation),c.using[0].y-=2*direction(1,c.rotation)}t.x=h,t.y=g,n=4}else{L=Math.sqrt(L);var d=(c.x-t.x)*o/L,m=(c.y-t.y)*o/L,h=t.x+d,g=t.y+m;75<L&&(t.target=-1,t.aipoint=-1,t.aimap=-1)}}else{if(0<=t.aipoint){(x=(d=(M=(b=(S=getCurrentLMap(t.ailap)).aipoints[t.aimap])[t.aipoint])[0]-t.x)*d+(m=M[1]-t.y)*m)<100&&(t.aipoint<b.length-1?t.aipoint++:t.aipoint=0);var y=Math.sqrt(d*d+m*m)/o;d/=y,m/=y}else if(-1==t.aipoint){if("BB"!=course)for(var f=2e3,S=getCurrentLMap(t.ailap),v=0;v<S.airoutesmeta.cpu;v++)for(var b=S.aipoints[v],s=0;s<b.length;s++){var C,x,M=b[s],P=(s+1)%b.length,k=b[P];0<(z=projete(t.x,t.y,M[0],M[1],k[0],k[1]))&&z<1&&(C=M[0]+z*(k[0]-M[0]),k=M[1]+z*(k[1]-M[1]),(x=(C-t.x)*(C-t.x)+(k-t.y)*(k-t.y))<f&&(t.aimap=v,t.aipoint=P,f=x))}d=o*direction(0,t.theta),m=o*direction(1,t.theta)}else d=o/2*direction(0,t.theta),m=o/2*direction(1,t.theta);if(h=t.x+d,g=t.y+m,-2!=t.aipoint){for(var I=4e3,c=null,s=0;s<aKarts.length;s++){var w,L,T,E=aKarts[s];E.id==t.owner||friendlyHit(t.team,E.team)||E.tombe||E.loose||(w=E.x-h,T=E.y-g,(L=Math.pow(w,2)+Math.pow(T,2))<I&&(T=d*w+m*T,.4<(T/=Math.sqrt(L*(d*d+m*m)))&&(T=getCurrentLapId(E),lapInteractionsDisabled(t.ailap,T)||(I=L,c=E))))}c&&(t.target=c.id,isOnline&&(c.id==identifiant||c.controller==identifiant||isControlledByPlayer(t.owner))&&syncItems.push(t))}}}else h=t.x,g=t.y;var D,d=h-t.x,m=g-t.y,r=d||m,l=0<=t.target&&!r,B=[t];if(l)for(var O=0;O<items["carapace-rouge"].length;O++)(M=items["carapace-rouge"][O])!==t&&M.x===t.x&&M.y===t.y&&B.push(M);if(e&&e.onlineSync&&(B=otherPlayerItems(B),D=otherPlayerItems([])),-1!=t.owner){if(handleCannon(t,inCannon(t.x,t.y,h,g)),a=inTeleport(t.x,t.y),a)h=a[0],g=a[1],t.theta=90*a[2],0<=t.aipoint&&((l=(y=(S=getCurrentLMap(t.ailap)).aipoints[t.aimap])[t.aipoint])&&a===inTeleport(l[0],l[1])&&(t.aipoint++,t.aipoint>=y.length&&(t.aipoint=0)));else if(!t.z){if(r&&(0<=t.aipoint||0<=t.target)&&!(50<t.stuckSince))for(var z,s=0;s<4;s++){if(!(z=getHorizontality(t.x,t.y,t.z0||0,d,m,{nullableRes:!0,holes:!0,skipDecor:!0}))){s?(t.stuckSince||(t.stuckSince=0),t.stuckSince++):delete t.stuckSince;break}var H=z[0]*d+z[1]*m,R=1.5-.5*Math.min(Math.abs(H)/o,1);d=z[0]*Math.sign(H)*o*R,m=z[1]*Math.sign(H)*o*R,h=t.x+d,g=t.y+m}handleJump(t,sauts(t.x,t.y,d,m))&&n%2&&handleHeightInc(t)}!t.z&&!t.heightinc||n%2||(t.heightinc||(t.heightinc=0),handleHeightInc(t))}if(collisionFloor=null,collisionLap=(collisionItem=t).ailap,-1!=t.owner&&!a&&(!t.z&&tombe(h,g)||!canMoveTo(t.x,t.y,t.z,d,m))||touche_banane(h,g,D)||touche_banane(t.x,t.y,D)||touche_crouge(h,g,B)||touche_crouge(t.x,t.y,B)||touche_cverte(h,g,D)||touche_cverte(t.x,t.y,D)||touche_bobomb(h,g,D,{transparent:!0})||touche_bobomb(t.x,t.y,D,{transparent:!0}))return void detruit(t);r=[t.x,t.y];t.x=h,t.y=g,-1!=t.owner&&-2!=t.aipoint&&checkItemLap(t,{aPos:r}),collisionFloor?t.z0=collisionFloor.z:delete t.z0}},checkCollisions:function(e,t){var n=aKarts[t];n.z<maxItemHitboxZ&&touche_crouge_aux(n.x,n.y,e)&&(friendlyHit(n.team,e.team)||handleHardHit(t))}},"carapace-bleue":{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),intType("target"),byteType("cooldown"),shortType("aipoint"),byteType("aimap"),byteType("ailap"),byteType("ailapt")],fadedelay:0,cooldown0:15,cooldown1:2,move:function(e){var t=-1;if(-1!=e.target)for(var n=0;n<aKarts.length;n++)if(aKarts[n].id==e.target){t=n;break}var a=cappedRelSpeed(),o=a*a,i=inTeleport(e.x,e.y);i&&(e.x=i[0],e.y=i[1],-1==e.aipoint||(c=(m=getCurrentLMap(e.ailap).aipoints[e.aimap])[e.aipoint])&&i===inTeleport(c[0],c[1])&&(e.aipoint++,e.aipoint>=m.length&&(e.aipoint=0)));var r=[e.x,e.y];if(-1==e.aipoint)if(0<e.cooldown){if(b=aKarts[t]){var l=e.x-b.x,s=e.y-b.y,i=l*l+s*s,c=itemBehaviors["carapace-bleue"];if(e.cooldown==c.cooldown0)if((h=10*a)*h<i){l/=u=Math.sqrt(i)/h,s/=u;for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(1-e.sprite[n].getState())}else e.cooldown--;else{e.cooldown<5&&(p=32,0<b.champi?(b.champi<(b.champior?8:16)||b.champiType!==CHAMPI_TYPE_ITEM)&&(p=200):b.turbodrift&&(p=64),(p*=o*o)<i&&(l/=u=Math.sqrt(i/p),s/=u));i=(e.cooldown-c.cooldown1)/(c.cooldown0-c.cooldown1);i<0&&(i=0);var p=8*i,u=8*i,c=2*Math.PI*i,i=b.rotation*Math.PI/180;e.z=23-u*Math.cos(c),l-=p*Math.sin(c)*Math.cos(i),s+=p*Math.sin(c)*Math.sin(i);for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(Math.round(Math.random()));if(e.cooldown--,!e.cooldown)for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(0)}e.x-=l,e.y-=s,e.ailap=getCurrentLapId(b)}}else{e.z=0,isOnline&&isControlledByPlayer(e.target)&&e.cooldown<-10&&(e.cooldown=0),e.cooldown--;var d=isOnline&&!isControlledByPlayer(e.target)?-120:-10;e.cooldown<d?detruit(e):(collisionLap=getItemCollisionLap(e),handleDecorExplosions(e,touche_cbleue_aux))}else{d="BB"==course;if(!d)for(var m=getCurrentLMap(e.ailap).aipoints[e.aimap],h=15*a,g=e.x,y=e.y;0<h;){var f=m[e.aipoint];if(!f)break;var S=Math.hypot(f[0]-e.x,f[1]-e.y);h<S?(e.x+=(f[0]-e.x)*h/S,e.y+=(f[1]-e.y)*h/S,h=0):(h-=S,e.x=f[0],e.y=f[1],e.aipoint++,e.aipoint===m.length&&(e.aipoint=0))}if(checkItemLap(e,{aPos:r,fast:!0}),-1==t){t=aKarts.length-1;for(var v=1;v<=aKarts.length;v++)for(n=0;n<aKarts.length;n++)if(aKarts[n].place==v){(aKarts[n].tours<=oMap.tours||"BB"==course)&&!friendlyHit(e.team,aKarts[n].team)&&(t=n,v=aKarts.length);break}}var b,r=((b=aKarts[t]).x-e.x)*(b.x-e.x)+(b.y-e.y)*(b.y-e.y);(r<2e4||d)&&((-1!=e.target||isOnline&&b.id!=identifiant&&b.controller!=identifiant)&&!d||(e.target=b.id,isOnline&&syncItems.push(e)),-1!=e.target&&(y=(b.x-g)*(b.x-g)+(b.y-y)*(b.y-y),(r<5e3||y<r||d)&&(e.aipoint=-1)));for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(1-e.sprite[n].getState())}},checkCollisions:function(e,t){var n=aKarts[t];touche_cbleue_aux(n.x,n.y,e)&&(friendlyHit(n.team,e.team)||handleExplosionHit(t,e.cooldown<-5?42:84))},render:function(e,t){if(e.cooldown<=0){if(!t&&1==e.size){for(var n,a=0;a<strPlayer.length;a++)makeSpriteExplode(e,"0",a),"block"==e.sprite[a].div.style.display&&(n=a);for(var o=-1,a=0;a<aKarts.length;a++)if(aKarts[a].id==e.target){o=a;break}isOnline||null==n?(e.size=8,playDistSound(aKarts[o],"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,reprendre(!(e.size=8)),playDistSound(aKarts[o],"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=Math.max(1+e.cooldown/10,0)}},del:function(e){nextBlueShellCooldown=300}},"carapace-noire":{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),intType("target"),byteType("cooldown"),shortType("aipoint"),byteType("aimap")],fadedelay:0,cooldown0:15,cooldown1:2,move:function(e){var t=-1;if(-1!=e.target)for(var n=0;n<aKarts.length;n++)if(aKarts[n].id==e.target){t=n;break}var a=cappedRelSpeed(),o=a*a;if(-1==e.aipoint)if(0<e.cooldown){if(v=aKarts[t]){var i=e.x-v.x,r=e.y-v.y,l=i*i+r*r,s=itemBehaviors["carapace-noire"];if(e.cooldown==s.cooldown0)if((m=10*a)*m<l){i/=p=Math.sqrt(l)/m,r/=p;for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(1-e.sprite[n].getState())}else e.cooldown--;else{e.cooldown<5&&(c=32,0<v.champi?c=200:v.turbodrift&&(c=64),(c*=o*o)<l&&(i/=p=Math.sqrt(l/c),r/=p));l=(e.cooldown-s.cooldown1)/(s.cooldown0-s.cooldown1);l<0&&(l=0);var c=8*l,p=8*l,s=2*Math.PI*l,l=v.rotation*Math.PI/180;e.z=23-p*Math.cos(s),i-=c*Math.sin(s)*Math.cos(l),r+=c*Math.sin(s)*Math.sin(l);for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(Math.round(Math.random()));if(e.cooldown--,!e.cooldown)for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(0)}e.x-=i,e.y-=r}}else{e.z=0,isOnline&&isControlledByPlayer(e.target)&&e.cooldown<-10&&(e.cooldown=0),e.cooldown--;var u=isOnline&&!isControlledByPlayer(e.target)?-70:-10;e.cooldown<u&&detruit(e)}else{u="BB"==course;if(!u)for(var d=oMap.aipoints[e.aimap],m=15*a,h=e.x,g=e.y;0<m;){var y=d[e.aipoint],f=Math.hypot(y[0]-e.x,y[1]-e.y);m<f?(e.x+=(y[0]-e.x)*m/f,e.y+=(y[1]-e.y)*m/f,m=0):(m-=f,e.x=y[0],e.y=y[1],e.aipoint++,e.aipoint===d.length&&(e.aipoint=0))}if(-1==t){t=0;for(var S=aKarts.length;0<S;S--)for(n=0;n<aKarts.length;n++)if(aKarts[n].place==S&&!aKarts[n].loose){friendlyHit(e.team,aKarts[n].team)||(t=n,S=0);break}}var v,a=((v=aKarts[t]).x-e.x)*(v.x-e.x)+(v.y-e.y)*(v.y-e.y);(a<2e4||u)&&((-1!=e.target||isOnline&&v.id!=identifiant&&v.controller!=identifiant)&&!u||(e.target=v.id,isOnline&&syncItems.push(e)),-1!=e.target&&(g=(v.x-h)*(v.x-h)+(v.y-g)*(v.y-g),(a<5e3||g<a||u)&&(e.aipoint=-1)));for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(1-e.sprite[n].getState())}},checkCollisions:function(e,t){var n=aKarts[t];touche_cbleue_aux(n.x,n.y,e)&&(friendlyHit(n.team,e.team)||handleExplosionHit(t,e.cooldown<-5?42:84))},render:function(e,t){if(e.cooldown<=0){if(!t&&1==e.size){for(var n,a=0;a<strPlayer.length;a++)makeSpriteExplode(e,"D",a),"block"==e.sprite[a].div.style.display&&(n=a);for(var o=-1,a=0;a<aKarts.length;a++)if(aKarts[a].id==e.target){o=a;break}isOnline||null==n?(e.size=8,playDistSound(aKarts[o],"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,reprendre(!(e.size=8)),playDistSound(aKarts[o],"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=Math.max(1+e.cooldown/10,0)}},del:function(e){nextBlueShellCooldown=300}}},itemTypes=["banane","fauxobjet","carapace","bobomb","poison","carapace-rouge","carapace-bleue","carapace-noire","eclair","bloops","pow","champi","etoile"],items={},i=0;i<itemTypes.length;i++)items[itemTypes[i]]=[];var decorBehaviors={taupe:{spin:20,init:function(e,t,n){3<e.length||(e[3]=0,e[4]=n%2?9:0)},move:function(e){if(e[4]++,0<=e[4])if(e[4]){if(e[3]+=e[4]<4?2:-1,10==e[4]){e[4]=-20,e[3]=10;for(var t=0;t<oPlayers.length;t++)e[2][t].img.style.display="none"}}else{for(t=0;t<oPlayers.length;t++)e[2][t].img.style.display="block";e[3]=0}}},poisson:{spin:20,movable:!0,preinit:function(e,t){t.scope={limite:new Array};for(var n=0;n<e.length;n++)t.scope.limite[n]=[0,0]},init:function(e,t,n){3<e.length||(e[3]=[3,0][n%2],e[4]=[-1,1][n%2])},move:function(e,t,n,a){if(e[3]+=e[4],e[3]){if(3==e[3]){e[4]=-1;for(var o=0;o<2;o++){var i=oPlayers[0].cpu?Math.random():1e4*Math.abs(Math.sin(timer+o))%1,i=Math.floor(9*i)-4;10<Math.abs(a.limite[t][o]+i)&&(i=-i),a.limite[t][o]+=i,e[o]+=i}}}else e[4]=1}},cheepcheep:{spin:20,movable:!0,preinit:function(e,t){this.preinit=decorBehaviors.poisson.preinit.bind(this),this.init=decorBehaviors.poisson.init.bind(this),this.move_=decorBehaviors.poisson.move.bind(this),this.preinit(e,t)},move:function(e,t,n,a){if(this.move_(e,t,n,a),e[3]%3==0)for(var o=0;o<oPlayers.length;o++)e[2][o].setState(e[3]?1:0)}},plante:{spin:20,init:function(e,t,n){3<e.length||(e[3]=void 0,e[4]=(1+2*n)%8)},move:function(e){if(e[4]++,4==e[4])for(var t=0;t<oPlayers.length;t++)e[2][t].setState(1);else if(8==e[4]){for(t=0;t<oPlayers.length;t++)e[2][t].setState(0);e[4]=0}}},thwomp:{spin:20,init:function(e,t,n){3<e.length||(e[3]=[20,0][n%2],e[4]=[0,10][n%2])},move:function(e){e[4]<0?(e[4]++,e[4]||(e[4]=-1,e[3]<20?e[3]+=2:e[4]=20)):e[4]?e[4]--:(e[3]-=8,e[3]<0&&(e[3]=0,e[4]=-15))}},spectre:{spin:20,init:function(e,t,n){decorBehaviors.thwomp.init(e,t,n)},move:function(e){decorBehaviors.thwomp.move(e)}},tree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=50,e[2][t].h=100,e[2][t].z=.12}},crabe:{spin:20,movable:!0,transparent:!0,preinit:function(e){"BB"==course&&(this.dodgable=!0)},init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=3,e[2][a].h=30,e[2][a].w=16*e[2][a].h/17;null==e[4]&&(e[4]=1e4*Math.sin(n+1)%Math.PI);var o=e[5];for(null==o&&(o=137*n%400),e[5]=0;e[5]!=o;)this.move(e)},hSpeed:.7,handleState:function(e,t){if(0==(t%=16))for(var n=0;n<strPlayer.length;n++)e[2][n].setState(0);else if(4==t||12==t)for(n=0;n<strPlayer.length;n++)e[2][n].setState(1);else if(8==t)for(n=0;n<strPlayer.length;n++)e[2][n].setState(2)},move:function(e){var t,n,a=e[5]+50,o=Math.min(a%100,99-a%100);5<=o&&(t=this.hSpeed*Math.cos(e[4]),n=this.hSpeed*Math.sin(e[4]),o<8&&(t*=.5,n*=.5),this.handleState(e,a),a%200<100?(e[0]+=t,e[1]+=n):(e[0]-=t,e[1]-=n)),e[5]++,400<=e[5]&&(e[5]=0)}},goomba:{spin:20,movable:!0,transparent:!0,dodgable:!0,preinit:function(e){this.init_=decorBehaviors.crabe.init.bind(this),this.move=decorBehaviors.crabe.move.bind(this)},init:function(e,t,n){this.init_(e,t,n);for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=2,e[2][a].w=32,e[2][a].h=36},handleState:function(e,t){if(0==(t%=8))for(var n=0;n<strPlayer.length;n++)e[2][n].setState(0);else if(4==t)for(n=0;n<strPlayer.length;n++)e[2][n].setState(1)},hSpeed:.3},firesnake:{spin:42,minSpeedToSpin:3.2,unbreaking:!0,movable:!0,transparent:!0,dodgable:!0,hitbox:6,hitboxH:7,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=3,e[2][a].img.style.display="none";e[3]=10,e[4]||(e[4]=(1+50*n)%280),e[5]||(e[5]=0),e[6]||(e[6]=0),e[7]=[e[0],e[1]],e[8]=[e[0],e[1]],e[9]=[e[0],e[1]],e[0]=-10,e[1]=-10},move:function(e,t,n){var a=timer+n;switch(oPlayers[0].cpu&&(a=1e4*Math.random()),e[5]){case 0:if(e[4]--,e[4]<=0){for(var o=0;o<strPlayer.length;o++)e[2][o].img.style.display="block";e[0]=e[7][0]+10*Math.sin(a),e[1]=e[7][1]+10*Math.sin(a+1),e[8][0]=e[0],e[8][1]=e[1],e[9][0]=e[0]+10*Math.sin(a+2),e[9][1]=e[1]+10*Math.sin(a+3),e[3]=50,e[5]=1}break;case 1:if(e[3]-=4,e[3]<=0){e[3]=0,e[4]=20,e[5]=2,e[6]=5;for(o=0;o<strPlayer.length;o++)e[2][o].setState(1)}var i=e[3]/40;e[9][0]+=i*(e[8][0]-e[9][0]),e[9][1]+=i*(e[8][1]-e[9][1]),e[0]=e[9][0],e[1]=e[9][1];break;case 2:var r=(18-e[4])/18;if(0<=r){var l=n%2?1:-1;if(e[0]=e[9][0]-4*r*l*Math.cos(4*r)+r*Math.sin(a),e[1]=e[9][1]-4*r*l*Math.sin(4*r)+r*Math.sin(a+1),e[3]=Math.max(1.2*Math.sin(4*r)+.3*r*Math.sin(a+1),0),e[4]%6==3)for(o=0;o<strPlayer.length;o++)e[2][o].setState(3-e[2][o].getState())}e[4]--,e[4]<=0&&(e[5]=3,e[8][0]=e[0],e[8][1]=e[1],e[4]=0,e[9][0]=e[7][0]+10*Math.sin(a),e[9][1]=e[7][1]+10*Math.sin(a+1));break;case 3:e[4]++;i=Math.min(e[4]/20,1);e[0]=e[8][0]+i*(e[9][0]-e[8][0]),e[1]=e[8][1]+i*(e[9][1]-e[8][1]),e[3]=30*i*(1-i),1==i&&(e[6]--,e[6]<=0?(e[5]=4,e[4]=1):(e[5]=2,e[4]=20,e[5]=2));break;case 4:if(e[4]-=.2,e[4]<0){for(o=0;o<strPlayer.length;o++)e[2][o].img.style.display="none",e[2][o].img.style.opacity=1,e[2][o].setState(0);e[0]=-10,e[1]=-10,e[4]=50,e[5]=0,e[6]=0}else for(o=0;o<strPlayer.length;o++)e[2][o].img.style.opacity=e[4]}}},fireplant:{hitbox:7,unbreaking:!0,preinit:function(){var e=this.ctx.lMap;e.decor.fireball||(e.decor.fireball=new Array),this.linkedSprite={type:"fireball",start:e.decor.fireball.length};for(var t=0;t<e.decor[this.type].length;t++)e.decor.fireball.push([-1e4,-1e4]);this.linkedSprite.end=e.decor.fireball.length},init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=4,e[2][a].w=54,e[2][a].h=40*e[2][a].w/24,e[2][a].z=.16;null==e[4]&&(e[4]=1e4*Math.sin(n+1)%(2*Math.PI)),null==e[5]&&(e[5]=17*n%65),e[6]=e[4],e[7]=0},initcustom:function(e){initCustomDecorSprites(this,e)},move:function(e,t){var n=this.ctx.lMap;if(e[5]--,e[4]=e[6]+.5*Math.sin(e[7]),e[7]+=.05,e[7]%=2*Math.PI,-1==e[5])for(var a=0;a<strPlayer.length;a++)e[2][a].setState(e[2][a].getState()+1);else if(-7==e[5]){var o=n.decor.fireball[this.linkedSprite.start+t];o[0]=e[0],o[1]=e[1];for(a=0;a<strPlayer.length;a++)o[2][a].img.style.display="block",o[2][a].setState(0);o[3]=10,o[4]=e[4],o[5]=0,o[6]=35}else if(-9==e[5]){for(a=0;a<strPlayer.length;a++)e[2][a].setState((e[2][a].getState()+1)%4);e[5]=Math.round(60+10*Math.sin(e[7]))}}},fireball:{spin:42,unbreaking:!0,movable:!0,transparent:!0,hitboxH:6,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=4,e[2][n].img.style.display="none"},move:function(e){if(0<=e[6])if(e[0]+=7*Math.cos(e[4]),e[1]+=7*Math.sin(e[4]),e[3]+=e[5],e[3]<0&&(e[3]=0,e[5]=5),e[5]-=3,e[6]--,e[6]<0){e[0]=-1e4,e[1]=-1e4;for(var t=0;t<strPlayer.length;t++)e[2][t].img.style.display="none"}else if(e[6]%2==0)for(t=0;t<strPlayer.length;t++)e[2][t].setState((e[2][t].getState()+3)%4)}},piranhaplant:{spin:20,preinit:function(e){this.init_=decorBehaviors.plante.init.bind(this),this.move=decorBehaviors.plante.move.bind(this)},init:function(e,t,n){this.init_(e,t,n);for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=2,e[2][a].w=32,e[2][a].h=48,e[2][a].z=.1}},firebar:{spin:42,transparent:!0,unbreaking:!0,movable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].w=32,e[2][a].h=192,e[2][a].z=.035;null==e[4]&&(e[4]=[[e[0],e[1],0,40],[e[0],e[1],20,40]]),null==e[5]&&(e[5]=Math.round(1e4*Math.abs(Math.sin(n+3)))%e[4].length),null==e[6]&&(e[6]=2*Math.round(1e4*Math.abs(Math.sin(n+2))%1)-1),null==e[7]&&(e[7]=Math.round(1e4*Math.abs(Math.sin(n+1)))%40)},move:function(e,t){if(e[7])e[7]--;else{var n=e[4][e[5]],a=n[0]-e[0],o=n[1]-e[1],i=n[2]-e[3],r=0<i?4:8,l=Math.hypot(a,o),s=!0;.88<l?(e[0]+=.88*a/l,e[1]+=.88*o/l,s=!1):(e[0]=n[0],e[1]=n[1]);l=e[3];if(r<Math.abs(i)?(e[3]+=Math.sign(i)*r,s=!1):e[3]=n[2],l!=e[3])for(var c=Math.max(0,1-e[3]/20),p=0;p<strPlayer.length;p++){var u=e[2][p].img;u.style.transform=u.style.WebkitTransform=u.style.MozTransform="scale("+c+")"}s&&(e[7]=n[3],e[5]+=e[6],e[5]<0?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1))}}},fire3star:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){var t=this.ctx.lMap;t.decor.fireballs||(t.decor.fireballs=new Array),this.linkedSprite={type:"fireballs",start:t.decor.fireballs.length};for(var n=0;n<e.length;n++){var a,o=e[n];null==o[3]&&(o[3]=18),null==o[4]?(a=getDecorParams(this,n),o[4]=Math.PI/2+a.dir,isNaN(o[4])&&(o[4]=1e4*Math.sin(n+2)%Math.PI),o[5]=.1):null==o[5]&&(o[5]=.1*(n%2?1:-1)),null==o[6]&&(o[6]=1e4*Math.sin(n+1)%Math.PI);for(var i=[],r=0;r<3;r++){for(var l=[],s=0;s<2;s++){var c=[o[0],o[1],void 0,o[3]];t.decor.fireballs.push(c),l.push(c)}i.push(l)}c=[o[0],o[1],void 0,correctZInv(o[3])];t.decor.fireballs.push(c),i.push([c]),o[7]=i}this.linkedSprite.end=t.decor.fireballs.length},init:function(e,t,n){this.move(e,t,n)},initcustom:function(e){initCustomDecorSprites(this,e)},move:function(e,t){for(var n=e[0],a=e[1],o=e[3],i=e[4],r=e[5],l=e[6],s=Math.cos(i),c=Math.sin(i),p=e[7],u=0;u<3;u++)for(var d=l+2*u*Math.PI/3,m=Math.cos(d),h=Math.sin(d),g=p[u],y=0;y<2;y++){var f=g[y],S=7.5*(y+1);f[0]=n+S*s*m,f[1]=a-S*c*m,f[3]=correctZInv(o+S*h)}e[6]+=r,e[6]%=2*Math.PI}},firering:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){var t=this.ctx.lMap;t.decor.fireballs||(t.decor.fireballs=new Array),this.linkedSprite={type:"fireballs",start:t.decor.fireballs.length};for(var n=0;n<e.length;n++){var a,o=e[n];null==o[3]&&(o[3]=18),null==o[4]?(a=getDecorParams(this,n),o[4]=Math.PI/2+a.dir,isNaN(o[4])&&(o[4]=1e4*Math.sin(n+2)%Math.PI),o[5]=.1):null==o[5]&&(o[5]=.1*(n%2?1:-1)),null==o[6]&&(o[6]=1e4*Math.sin(n+1)%Math.PI);for(var i=[],r=0;r<5;r++){var l=[o[0],o[1],void 0,o[3]];t.decor.fireballs.push(l),i.push(l)}o[7]=i}this.linkedSprite.end=t.decor.fireballs.length},init:function(e,t,n){this.move(e,t,n)},initcustom:function(e){initCustomDecorSprites(this,e)},move:function(e,t){for(var n=e[0],a=e[1],o=e[3],i=e[4],r=e[5],l=e[6],s=Math.cos(i),c=Math.sin(i),p=e[7],u=0;u<p.length;u++){var d=l+2*u*Math.PI/5,m=Math.cos(d),h=Math.sin(d),d=p[u];d[0]=n+15*s*m,d[1]=a-15*c*m,d[3]=correctZInv(o+15*h)}e[6]+=r,e[6]%=2*Math.PI}},fireballs:{unbreaking:!0,transparent:!0,spin:42,movable:!0,hitboxH:6,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=1,e[2][n].w=24,e[2][n].h=e[2][n].w}},billball:{hitbox:10,unbreaking:!0,transparent:!0,spin:42,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=this.ctx.lMap,n=0;n<e.length;n++){var a=getDecorParams(this,n);null==(r=e[n])[3]&&(r[3]=3),null==r[4]&&(r[4]=90+180*a.dir/Math.PI,isNaN(r[4])&&(r[4]=180))}for(n=1;n<4;n++){var o=t.decor["billball"+n];if(o){for(var i=0;i<o.length;i++){var r=o[i];e.push([r[0],r[1],null,null,180-90*n])}o.length=0}}var l=getDecorExtra(this,!0),s=0;if(l.nb)for(n=s=e.length;n<l.nb;n++)e.push(e[n%s].slice(0));else s=Math.round(4*e.length/5);for(n=0;n<e.length;n++){a=getDecorParams(this,n);(r=e[n])[6]=[r[0],r[1],r[3],r[4],a.length||460]}this.initPos=[];for(n=0;n<s;n++){var c=e[n][6].slice();c.push(0),this.initPos.push(c)}},init:function(e,t){this.easeInOut=decorBehaviors.truck.easeInOut,null==e[5]&&(e[5]=1+20*t);for(var n=0;n<strPlayer.length;n++)e[2][n].w=80,e[2][n].h=80,e[5]&&(e[0]=-10,e[1]=-10,e[2][n].img.style.display="none")},move:function(e,t){if(!t)for(var n=0;n<this.initPos.length;n++)(o=this.initPos[n])[o.length-1]&&o[o.length-1]--;if(0<e[5]){if(e[5]--,e[5]<=0){e[5]=0,e[0]=e[6][0],e[1]=e[6][1];for(n=0;n<strPlayer.length;n++)e[2][n].img.style.display="block"}}else if(e[5]<0){if(e[5]<=-10){for(var a=1,n=e[5]=0;n<100;n++){var o,i=oPlayers[0].cpu?Math.floor(Math.random()*this.initPos.length):Math.round(1e4*Math.abs(Math.sin(timer+n)))%this.initPos.length;if(!(o=this.initPos[i])[o.length-1])break}var r=this.initPos[i];r[r.length-1]=20;for(n=0;n<5;n++)e[6][n]=this.initPos[i][n];e[0]=e[6][0],e[1]=e[6][1],e[3]=e[6][2],e[4]=e[6][3]}else a=1-e[5]/-10,e[3]=e[6][2]*Math.sqrt(a),e[5]--;for(n=0;n<oPlayers.length;n++)e[2][n].img.style.opacity=a}else{t=(180-e[4])*Math.PI/180,r=e[6][4];e[0]+=5*Math.cos(t),e[1]+=5*Math.sin(t),(e[0]-e[6][0])*(e[0]-e[6][0])+(e[1]-e[6][1])*(e[1]-e[6][1])>r*r&&(e[5]=-1)}for(n=0;n<oPlayers.length;n++){var l=(s=nearestAngleMirrored(getApparentRotation(getPlayerAtScreen(n))+90-e[4],180,360))%180/180,l=this.easeInOut(l),s=180*Math.floor(s/180)+180*l,s=Math.round(11*s/180)%22;21<s&&(s-=22),e[2][n].setState(s)}}},tortitaupe:{spin:20,preinit:function(e){this.init_=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)},init:function(e,t,n){this.init_(e,t,n);for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=1,e[2][a].w=24,e[2][a].h=36}},topitaupe:{spin:20,preinit:function(e){this.init=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)}},coconut:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.36}},palm:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.38}},mountaintree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=64*e[2][t].h/126,e[2][t].z=.15}},mariotree:{hidable:!0,hitbox:3,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=104,e[2][t].w=e[2][t].h/2,e[2][t].z=.12}},fir:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=e[2][t].h,e[2][t].z=.38}},movingtree:{hitbox:11.5,movable:!0,unbreaking:!0,init:function(e,t,n){for(var a,o=0;o<strPlayer.length;o++)e[2][o].nbSprites=1,e[2][o].w=85,e[2][o].h=139*e[2][o].w/115,e[2][o].z=.12,e[3]=0,e[4]||(a=n%2?1:-1,e[4]=[[e[0]+25*a,e[1]],[e[0],e[1]-25*a],[e[0]-25*a,e[1]],[e[0],e[1]+25*a]]),null==e[5]&&(e[5]=n%e[4].length),null==e[6]&&(e[6]=0)},move:function(e){var t,n,a;e[6]?e[6]--:(t=(a=e[4][e[5]])[0]-e[0])*t+(n=a[1]-e[1])*n<1?(e[5]=(e[5]+1)%e[4].length,e[6]=10):(a=Math.hypot(t,n),e[0]+=1.1*t/a,e[1]+=1.1*n/a)}},sinistertree:{hidable:!0,hitbox:9,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=117,e[2][t].h=126,e[2][t].z=.37}},pokey:{spin:42,movable:!0,dodgable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=5,e[2][a].h=82,e[2][a].w=23*e[2][a].h/45,e[2][a].z=.1;e[3]=0,null==e[4]&&(e[4]=[15,15]),2==e[4].length&&e[4].unshift(e[0],e[1]),null==e[5]&&(e[5]=[1e4*Math.sin(n+1)%Math.PI,.025*Math.sign(Math.sin(1+100*n))]),null==e[6]&&(e[6]=Math.floor(1e4*Math.pow(Math.sin(n+1),2))%16),this.repos(e)},repos:function(e){var t=e[5][0],n=e[4];e[0]=n[0]+n[2]*Math.cos(t),e[1]=n[1]+n[3]*Math.sin(t)},move:function(e){e[5][0]=(e[5][0]+e[5][1])%(2*Math.PI),e[6]++;if(e[6]%2==0){var t=e[6]/2,n=[0,1,2,1,0,3,4,3];n.length<=t&&(t=0,e[6]=0);for(var a=0;a<strPlayer.length;a++)e[2][a].setState(n[t])}this.repos(e)}},falltree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=72,e[2][t].h=150*e[2][t].w/100,e[2][t].z=.24}},peachtree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=27,e[2][t].h=4*e[2][t].w,e[2][t].z=.01}},box:{breaking:!0,bonus:!0},snowman:{breaking:!0,spin:42},snowball:{hitbox:7,spin:42,unbreaking:!0,movable:!0,defaultspeed:3.5,boostspeed:8,jumpspeed:function(e){return+e+4},jumpheight:32,spritesize:56,ondie:function(e){return-100<e?"wait":"respawn"},preinit:function(e){e.length&&null==e[0][4]&&(this.init=decorBehaviors.cannonball.init.bind(this),this.move_=decorBehaviors.cannonball.move.bind(this),this.move=function(e,t,n){for(var a=0;a<oPlayers.length;a++)e[2][a].setState((e[2][a].getState()+1)%3);this.move_(e,t,n)},this.setdir=decorBehaviors.cannonball.setdir.bind(this),this.autojump=decorBehaviors.cannonball.autojump.bind(this))},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=3,e[2][t].w=56,e[2][t].h=56,e[2][t].z=.28;e[3]=0,e[4].unshift([e[0],e[1]]),e[5]=[1,0]},move:function(e){for(var t=3.5,n=0;n<oPlayers.length;n++)e[2][n].setState((e[2][n].getState()+1)%3);for(;0<t;)if(e[5][0]<e[4].length){var a=e[4][e[5][0]];a[2]&&3.5==t&&(t=a[2]);var o=a[0],i=a[1],r=o-e[0],l=i-e[1],s=Math.hypot(r,l);e[3]=0,s<t?(e[0]=o,e[1]=i,e[5][0]++,t-=s):(e[0]+=r*t/s,e[1]+=l*t/s,t=0,a[3]&&(l=e[4][e[5][0]-1],(l=(1-s/Math.hypot(o-l[0],i-l[1]))/a[3][1])<1&&(e[3]=4*a[3][0]*l*(1-l))))}else if(t=0,e[5][1]++,e[5][1]<10)for(var c=0;c<oPlayers.length;c++)e[2][c].img.style.opacity=1-e[5][1]/10;else if(10==e[5][1]){e[3]=10,e[0]=-100,e[1]=-100;for(c=0;c<oPlayers.length;c++)e[2][c].img.style.opacity="",e[2][c].img.style.display="none"}else if(104<=e[5][1]){e[5][0]=1,e[5][1]=0,e[0]=e[4][0][0],e[1]=e[4][0][1];for(c=0;c<oPlayers.length;c++)e[2][c].img.style.display="block";e[3]=0}}},cannonball:{hitbox:8,spin:42,unbreaking:!0,movable:!0,defaultspeed:5,jumpspeed:function(e){return 6+1.5*e},jumpheight:48,boostspeed:11,spritesize:60,ondie:function(){return"suppr"},setdir:function(e,t,n,a){var o=this.ctx.lMap;a=a||e;o=o.w+o.h;e[4][0][0]=a[0]+o*t,e[4][0][1]=a[1]+o*n,e[4][1][0]=a[0]-o*t,e[4][1][1]=a[1]-o*n},autojump:function(e,t,n,a){e[6][4]&&a<this.boostspeed&&(t*=this.boostspeed/a,n*=this.boostspeed/a,a=this.boostspeed);var o=Math.hypot(t,n);e[4][2]=[e[0]+t,e[1]+n],e[5][2]={jump:1,loop:[0]},e[6][0]=2,e[6][2]=a,e[6][3]=o,this.setdir(e,t/o,n/o,e[4][2])},init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites||(e[2][a].nbSprites=1,e[2][a].w=this.spritesize,e[2][a].h=this.spritesize,e[2][a].z=.33);e[3]=0,e[4]||(e[4]=[[],[]],t=getDecorParams(this,t).dir,isNaN(t)&&(t=1e4*Math.sin(n+2)%Math.PI),this.setdir(e,Math.sin(t),Math.cos(t)),e[5]||(e[5]={0:{autoDir:!0,pos0:[e[0],e[1]]},1:{autoDir:!0,loop:[0]}})),e[5]||(e[5]={}),e[6]=[0,0,5]},move:function(e,t,n){var a=this.ctx.lMap,o=e[6][2];for(e[6][4]&&(o=Math.max(this.boostspeed,o),e[6][4]--);0<o;){var i,r=e[4][e[6][0]],l=r[0],s=r[1],c=l-e[0],p=s-e[1],u=Math.hypot(c,p),r=e[5][e[6][0]];if(u<o)e[0]=l,e[1]=s,r&&r.loop?(i=r.loop[0],e[6][1]?(e[6][1]--,e[6][1]||(i=e[6][0]+1)):r.loop[1]&&(e[6][1]=r.loop[1]),e[6][0]=i):e[6][0]++,r&&r.speed?e[6][2]=r.speed:e[6][2]=this.defaultspeed,r&&r.jump?(i=e[4][e[6][0]],e[6][3]=Math.hypot(i[0]-l,i[1]-s)):e[6][3]=0,e[3]=0,o-=u;else{var d=c*o/u,m=p*o/u;if(r)if(isNaN(r.flipper)||((y=a.flippers[r.flipper])[3][0]||(y[3][1]=Math.max(0,Math.floor(u/o)-2))),r.autoDir)if(e[6][1]<0){for(var h=Math.max(0,1+e[6][1]/10),g=0;g<oPlayers.length;g++)e[2][g].img.style.opacity=h;if(h)e[6][1]--;else switch(this.ondie(e[6][1])){case"wait":e[0]=3*a.w,e[1]=3*a.h,e[6][1]--;break;case"suppr":a.decor[this.type][t][2][0].suppr(),a.decor[this.type].splice(t,1);break;case"respawn":for(g=0;g<oPlayers.length;g++)e[2][g].img.style.opacity="";e[0]=e[5][0].pos0[0],e[1]=e[5][0].pos0[1],e[4]=null,e[5]=null,this.init(e,t,n)}m=d=0}else{var y=inCannon(e[0],e[1],e[0]+d,e[1]+m);if(y&&(S=17,this.autojump(e,y[0],y[1],S)),r.jump||(e[3]=0,e[6][3]=0),!e[3]){y=a.decor[this.type];a.decor[this.type]=[];var f,r=sauts(e[0],e[1],d,m);if(collisionItem=collisionFloor=null,collisionLap=lMaps.indexOf(a),r){var S=this.jumpspeed(r),v=32*r,b=c*v/u,C=p*v/u;this.autojump(e,b,C,S)}else if(canMoveTo(e[0],e[1],0,d,m))if(f=touche_asset(e[0],e[1],e[0]+d,e[1]+m))switch(f[0]){case"bumpers":var x=d,M=m,P=f[1],k=e[0]+x,I=e[1]+M,w=P[1][0],L=P[1][1],T=e[0]-w,E=e[1]-L,D=Math.hypot(T,E),B=T/D,w=E/D,L=x*B+M*w,T=k-L*B,E=I-L*w;x=e[0]+2*(T-e[0])-k,M=e[1]+2*(E-e[1])-I;D=Math.hypot(x,M);this.setdir(e,x/D,M/D),m=d=0;break;case"flippers":x=d,M=m,P=f[1],k=e[0]+x,I=e[1]+M,B=P[2][2],L=P[2][3],w=P[1][0],T=P[1][1],E=e[0]-w,w=e[1]-T,T=Math.hypot(E,w),w=Math.atan2(w,E)||0,E=T*L,T=-E*Math.sin(w),L=E*Math.cos(w);x-=T,M-=L;E=Math.cos(B),w=Math.sin(B),B=x*E+M*w;x=2*B*E-x+T,M=2*B*w-M+L;D=Math.hypot(x,M);this.setdir(e,x/D,M/D),d=x,m=M}else tombe(e[0]+d,e[1]+m)?e[6][1]=-1:accelere(e[0],e[1],d,m)&&(e[6][4]=20);else{var x,M,p=getHorizontality(e[0],e[1],collisionFloor?collisionFloor.z:0,d,m),v=Math.hypot(p[0],p[1]),v=d*(x=p[0]/v)+m*(M=p[1]/v),b=2*v*x-d,C=2*v*M-m,v=Math.hypot(b,C);this.setdir(e,b/v,C/v),m=d=0}a.decor[this.type]=y}}e[0]+=d,e[1]+=m,e[6][3]&&(u=(u-o)/e[6][3],u=Math.max(Math.min(u,1),0),e[3]=this.jumpheight*u*(1-u)),o=0}}}},truck:{hitbox:8,spin:42,unbreaking:!0,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0;t<e.length;t++){var n,a=e[t];null==a[5]&&(n=getDecorParams(this,t),a[5]=n.traject),null==a[7]&&(n&&null!=n.speed?a[7]=n.speed:a[7]=1)}},init:function(e){for(var t=this.ctx.lMap,n=0;n<strPlayer.length;n++)e[2][n].nbSprites=22,e[2][n].w=118,e[2][n].h=56*e[2][n].w/111,e[2][n].z=.72;var a=getDecorExtra(this,!0);if(a.path||(a.path=t.aipoints.slice(0,t.airoutesmeta.cpu)),null==e[6]){var o=1/0,i=null!=e[5];i||(e[5]=0);for(var r=e[6]=0;r<a.path.length;r++)if(!i||r==e[5])for(var l=a.path[r],n=0;n<l.length;n++){var s=((c=l[n])[0]-e[0])*(c[0]-e[0])+(c[1]-e[1])*(c[1]-e[1]);s<o&&(o=s,e[5]=r,e[6]=n)}}(l=a.path[e[5]]).length<2&&(l.length||(l=[[e[0],e[1]]]),l.push([l[0][0]+.001,l[0][1]+.001]),a.path[e[5]]=l);var c=l[e[6]],p=(e[6]+1)%l.length,t=l[p];(c[0]-e[0])*(t[0]-c[0])+(c[1]-e[1])*(t[1]-c[1])<0&&(e[6]=p,c=t);t=c[0]-e[0];aimY=c[1]-e[1],e[4]=180*Math.atan2(t,aimY)/Math.PI},move:function(e){var t=this.ctx.lMap,n=4*e[7],a=e[0],o=e[1],i=getDecorExtra(this,!0);i.path||(i.path=t.aipoints.slice(0,t.airoutesmeta.cpu));var r=i.path[e[5]];do{var l=r[e[6]],s=l[0]-a,c=l[1]-o,l=Math.hypot(s,c)}while(l<n?(a+=s,o+=c,n-=l,++e[6]>=r.length&&(e[6]=0)):(a+=s*n/l,o+=c*n/l,n=0),0<n);e[0]=a,e[1]=o,(s||c)&&(t=nearestAngle(180*Math.atan2(s,c)/Math.PI,e[4],360),i=8*e[7],e[4]<t-i?e[4]+=i:e[4]>t+i?e[4]-=i:e[4]=t);for(var p=0;p<oPlayers.length;p++){var u=nearestAngleMirrored(getApparentRotation(getPlayerAtScreen(p))-e[4],180,360),a=u%180/180;a=this.easeInOut(a),u=180*Math.floor(u/180)+180*a;u=Math.round(11*u/180)%22;21<u&&(u-=22),e[2][p].setState(u)}},easeInOut:function(e){return(e*=2)<1?e*e/2:-(--e*(e-2)-1)/2}},movingthwomp:{spin:20,hitbox:8,movable:!0,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].w=48,e[2][n].h=64;if(null==e[4]){e[4]=[[e[0],e[1],0,20,20],[e[0],e[1],20,5,30],[e[0],e[1],20,30,5],[e[0],e[1],0,20,20]];var a=getDecorParams(this,t);if(!isNaN(a.dir))for(var o=a.length*Math.sin(a.dir),i=a.length*Math.cos(a.dir),t=2;t<4;t++)e[4][t][0]+=o,e[4][t][1]+=i}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=1),null==e[7]&&(e[7]=0)},move:function(e,t){if(e[7]){if(e[7]--,!e[7])if((p=e[4][e[5]])[2]!=e[3]&&(c=1),null!=c)for(var n=0;n<strPlayer.length;n++)e[2][n].setState(c)}else{var a=(p=e[4][e[5]])[0]-e[0],o=p[1]-e[1],i=p[2]-e[3],r=0<i?2:8,l=Math.hypot(a,o),s=!0;if(2<l?(e[0]+=2*a/l,e[1]+=2*o/l,s=!1):(e[0]=p[0],e[1]=p[1]),r<Math.abs(i)?(e[3]+=Math.sign(i)*r,s=!1):e[3]=p[2],s){e[7]=p[0<e[6]?3:4],e[5]+=e[6],e[5]<0?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1);var c,p=e[4][e[5]];c=!i||0<e[3]?0:2;for(n=0;n<strPlayer.length;n++)e[2][n].setState(c)}}}},chomp:{hitbox:9,spin:42,unbreaking:!0,movable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=8,e[2][a].w=92,e[2][a].h=60*e[2][a].w/70,e[2][a].z=.33;if(null==e[3]&&(e[3]=1e4*Math.abs(Math.sin(n+1))%3),null==e[4]){e[4]=[];for(var o=1e4*Math.sin(n+2)%Math.PI,i=2*Math.PI/6*Math.sign(Math.sin(1+80*n)),a=0;a<6;a++){var r=o+a*i;e[4].push([e[0]+40*Math.cos(r),e[1]+40*Math.sin(r)])}}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=n%2?1:-1)},move:function(e,t){e[3]+=e[6],e[3]<0&&(e[3]=0,e[6]=1.5),e[6]-=.5;for(var n=2.5;0<n;){var a=(s=e[4][e[5]])[0],o=s[1],i=a-e[0],r=o-e[1],l=Math.hypot(i,r);l<n?(e[0]=a,e[1]=o,e[5]++,e[5]>=e[4].length&&(e[5]=0),n-=l):(e[0]+=i*n/l,e[1]+=r*n/l,n=0)}var s=e[4][e[5]],c=e[4][(e[5]||e[4].length)-1],p=180*Math.atan2(s[0]-c[0],s[1]-c[1])/Math.PI;if(!isNaN(p))for(var u=0;u<oPlayers.length;u++){var d=nearestAngleMirrored(getApparentRotation(getPlayerAtScreen(u))-p,180,360),d=Math.round(8*d/360)%8;e[2][u].setState(d)}},easeInOut:function(e){return(e*=2)<1?e*e/2:-(--e*(e-2)-1)/2}},pendulum:{hitbox:8,spin:42,unbreaking:!0,movable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=1,e[2][a].w=60,e[2][a].h=3*e[2][a].w,e[2][a].z=.1,e[2][a].div.style.transformOrigin=e[2][a].div.style.WebkitTransformOrigin=e[2][a].div.style.MozTransformOrigin="50% 83%";e[5]=[e[0],e[1],0,-1],null==e[4]&&(e[4]=1e4*Math.sin(n+1)%(Math.PI/3),t=getDecorParams(this,t).dir,isNaN(t)?(e[5][2]=1e4*Math.sin(n+1)%Math.PI,e[5][3]=0<Math.sin(1200*(n+1)+1)?1:-1):(e[5][2]=t,e[5][3]=1))},move:function(e){var t=Math.PI/3,n=e[4],a=e[5][2],o=.99*t;Math.abs(n)>o&&(n=o*Math.sign(n),e[5][3]=-e[5][3]),n+=Math.sqrt(2*(Math.cos(n)-Math.cos(t)))/16*e[5][3],e[4]=n;e[0]=e[5][0]+30*Math.sin(n)*Math.sin(a),e[1]=e[5][1]+30*Math.sin(n)*Math.cos(a);for(var i=-6*(1-Math.cos(n)),r=0;r<strPlayer.length;r++){var l=getApparentRotation(getPlayerAtScreen(r)),l=-n/5*Math.sin(l*Math.PI/180-a);e[2][r].div.style.transform=e[2][r].div.style.WebkitTransform=e[2][r].div.style.MozTransform="translateY("+i+"%) rotate("+Math.round(l*getMirrorFactor()*180/Math.PI)+"deg)"}}},fullcustom:{hidable:!0,unbreaking:!0,init:function(e,t,n){var a;if(null==e[4]&&(void 0===(a=getDecorParams(this,t).dir)&&(a=1e4*Math.sin(n+2)%Math.PI),e[4]=180*a/Math.PI),bSelectedMirror)for(t=0;t<oPlayers.length;t++)e[2][t].div.style.transform=e[2][t].div.style.WebkitTransform=e[2][t].div.style.MozTransform="scaleX(-1)";this.move(e)},move:function(e){for(var t=0;t<oPlayers.length;t++){var n=(a=nearestAngle(getApparentRotation(getPlayerAtScreen(t))-e[4],180,360))%180/180,a=180*Math.floor(a/180)+180*n,a=Math.round(11*a/180)%22;21<a&&(a-=22),e[2][t].setState(a)}}}},DEFAULT_DECOR_HITBOX=5,DEFAULT_DECOR_HITBOX_H=4,type,lastState,lastStateTime,lastStateChange,interpolateFn;for(type in decorBehaviors)decorBehaviors[type].type=type,decorBehaviors[type].ctx={};function initItemSprite(e){var t=[],n=e[2];n&&oDoubleItemsEnabled||(n=1);for(var a=0;a<n;a++)t[a]=new Sprite("item");e[2]={active:!0,box:t}}function handleSpriteLaunch(e,t,n){e.countdown--,t+=5*(cappedRelSpeed()-1);var a,o,i,r=inTeleport(e.x,e.y);r?(o=r[0],i=r[1],e.theta=90*r[2]):(a=t*direction(0,e.theta),l=t*direction(1,e.theta),o=e.x+a,i=e.y+l);var l=[e.x,e.y];e.x=o,e.y=i,e.z=correctZInv((64-Math.pow(e.countdown-8,2))*n),r||checkItemLap(e,{aPos:l}),!e.countdown&&tombe(o,i)&&detruit(e)}function getDecorParams(e,t){var n=e.type,e=e.ctx.lMap;return e.decorparams&&e.decorparams[n]&&e.decorparams[n][t]?e.decorparams[n][t]:{}}function getDecorExtraParams(e,t){return t.decorparams&&t.decorparams.extra&&t.decorparams.extra[e]?t.decorparams.extra[e]:{}}function getDecorExtra(e,t){e=getDecorExtraParams(e.type,e.ctx.lMap);return t&&e.custom&&(e=getDecorExtra(decorBehaviors[e.custom.type])),e}function getDecorCustomData(e,t){return getDecorExtraParams(e,t).custom}function getDecorActualType(e){var t=getDecorExtra(decorBehaviors[e.type]);return(t.custom||e).type}function initCustomDecorSprites(n,e){if(n.linkedSprite){var a=n.linkedSprite.type,t=n.ctx.extra;if(t&&t[a]){for(var o=t[a],i={w:o.size.hd.w/o.original_size.hd.w,h:o.size.hd.h/o.original_size.hd.h},r=oObjWidth*i.w,l=oObjWidth2*i.w,s=n.linkedSprite.start;s<n.linkedSprite.end;s++){var c=e.decor[a][s];c&&updateCustomDecorSprites(c,o,i)}p(),setTimeout(p,300)}}function p(){for(var e=n.linkedSprite.start;e<n.linkedSprite.end;e++){var t=oPlanDecor[a]&&oPlanDecor[a][e];t&&(t.src=o.map,t.style.width=r+"px"),(t=oPlanDecor2[a]&&oPlanDecor2[a][e])&&(t.src=o.map,t.style.width=l+"px")}}}function updateCustomDecorSprites(e,t,n){for(var a=0;a<oPlayers.length;a++){e[2][a].img.src=t.hd,t.size.nb_sprites&&(e[2][a].nbSprites=t.size.nb_sprites),!bSelectedMirror||1<t.size.nb_sprites||e[2][a].img.classList.add("mirrored"),e[2][a].w=Math.round(e[2][a].w*n.w),e[2][a].h=Math.round(e[2][a].h*n.h);var o=(n.w-n.h)/(n.w+n.h);o*=e[2][a].w/(2*e[2][a].h),e[2][a].z+=o}}function initCustomDecorsSprites(n){n.decor&&setTimeout(function(){for(var e in n.decor){var t=decorBehaviors[e];t.initcustom&&t.initcustom(n)}})}function getRecordStats(e){const t=_0xa155;let n=e+t(245),a=0;for(let e=0;e<n[t(244)];e++){var o=n[t(236)](e);a=(a<<5)-a+o,a|=0}let i=(a>>>0).toString(16),r="";for(let e=0;e<i[t(244)];e++){var l=i.charCodeAt(e);r+=String[t(233)]((l^31*e)%256)}return btoa(r)}function _0xa155(e,t){var n=_0x4683();return(_0xa155=function(e,t){return n[e-=233]})(e,t)}function _0x4683(){var e=["1784007HeyleA","24949815xZofQd","1kmMgRY","length","fg4L5S4oAcWU","28JpLdzP","8GGQJZW","fromCharCode","286179zyMOrl","18yMmHRX","charCodeAt","6441810ISxjfS","1700354RPvVGO","3661469hhDSsa","1569430dSNIjB"];return(_0x4683=function(){return e})()}function getApparentRotation(e){var t=e.rotation,e=e.changeView;return e&&(t+=t<360-e?e:e-360),t}function getLastObj(e,t,n){if(e[t]&&e[t].ref===n.ref)return e[t];for(var a=0;a<e.length;a++)if(e[a].ref===n.ref)return e[a];return n}function interpolateState(e,t,n){if(interpolateFn)switch(interpolateFn){case"ease_out_quad":n=-n*(n-2);break;case"ease_out_cubic":n=--n*n*n+1;break;case"ease_out_quart":n=1- --n*n*n*n;break;case"ease_out_exp":n=1===n?1:1-Math.pow(2,-10*n)}return interpolateRaw(e,t,n)}function interpolateRaw(e,t,n){return e*(1-n)+t*n}function interpolateStateNullable(e,t,n){return null==e?t:null==t?e:interpolateState(e,t,n)}function interpolateStateAngle(e,t,n){return interpolateState(e=nearestAngle(e,t,360),t,n)}function interpolateStateRound(e,t,n){return Math.round(interpolateState(e,t,n))}!function(){const e=_0xa155,t=_0x4683();for(;;)try{if(510758==-parseInt(e(243))*(-parseInt(e(238))/2)+parseInt(e(234))/3*(parseInt(e(246))/4)+-parseInt(e(240))/5*(-parseInt(e(235))/6)+-parseInt(e(239))/7+-parseInt(e(247))/8*(-parseInt(e(241))/9)+parseInt(e(237))/10+-parseInt(e(242))/11)break;t.push(t.shift())}catch(e){t.push(t.shift())}}();var nbFrames=1,frameHandlers,oSpecCam;function handleLapChange(e,t,n){var a=aKarts[n],o=getCurrentLMap(e),i=getCurrentLMap(t);o.aipoints!==i.aipoints&&resetAiPoints(a),refreshUsingItems(a,t);n=getScreenPlayerIndex(n);n>=oPlayers.length||(lastStateChange=!0,clearPendingFrames(),hideLapSprites(o,n),updateBgLayers(n=pMaps[t],function(e,t){resetBgLayers(),setupBgLayer(e,t,!1)}),!onlineSpectatorId&&!a.cpu&&e<t&&updateMapMusic(n),oPlanDiv&&resetPlan(i))}function handleCpChange(e,t,n){if(!oMap.lapOverrides)return collisionLap;var a=aKarts[n],t=getCurrentLapId({tours:e,demitours:t}),a=getCurrentLapId(a);return t===a||handleLapChange(t,a,n),a}function resetRenderState(){lastState=void 0,clearPendingFrames()}function clearPendingFrames(){for(var e=0;e<frameHandlers.length;e++)clearTimeout(frameHandlers[e])}function resetAiPoints(e){e.cpu?(delete e.aishortcut,delete e.aishortcuts,initAiPoints(getCurrentLMap(getCurrentLapId(e)),e,aKarts.indexOf(e)),e.aipoint=0):delete e.aipoint}function initAiPoints(e,t,n){var a=n%e.airoutesmeta.cpu;if(t.aipoints=e.aipoints[a]||[],e.aishortcuts&&e.aishortcuts[a]){for(var o={},i=!1,r=0;r<e.aishortcuts[a].length;r++){var l=e.aishortcuts[a][r],s=l[0];(l=l.slice(1))[2]||(l[2]={});var c=l[2];null==c.items&&(c.items=["champi","champiX2","champiX3","champior","megachampi","etoile"]),null==c.difficulty&&(c.difficulty=1.01),null==c.cc&&(c.cc=150),null==c.ccm&&(c.ccm=1e3);var p=4+.5*c.difficulty,u=getRelSpeedFromCc(c.cc),d=getRelSpeedFromCc(c.ccm);if(p<=iDificulty&&u<=fSelectedClass&&fSelectedClass<=d){if(i=!0,!c.itemsDict){for(var m={},h=0;h<c.items.length;h++)m[c.items[h]]=1;c.itemsDict=m}o[s]=l}}i&&(t.aishortcuts=o)}}function refreshUsingItems(e,t){if(e.using.length)for(var n=0;n<e.using.length;n++)e.using[n].lapId=t}function resetBgLayers(){for(var e=0;e<oBgLayers.length;e++)oBgLayers[e].suppr();for(e=oBgLayers.length=0;e<oPrevFrameStates.length;e++)for(var t=oPrevFrameStates[e].length,n=0;n<t;n++){for(var a=oPrevFrameStates[e][n].layer,o=0;o<a.length;o++)a[o].suppr();a.length=0}}function updateBgLayers(a,e){a&&(a.custombg?customBgData[a.custombg]?void 0!==customBgData[a.custombg].data?e(customBgData[a.custombg].data,!1):customBgData[a.custombg].callbacks.push(e):(customBgData[a.custombg]={callbacks:[e]},xhr("getBgData.php","id="+a.custombg,function(e){if(customBgData[a.custombg].data)return!0;if(!e)return delete customBgData[a.custombg],!0;e=JSON.parse(e),customBgData[a.custombg].data=e.layers.map(function(e){return e.path});for(var t=customBgData[a.custombg].callbacks,n=0;n<t.length;n++)t[n](customBgData[a.custombg].data,!1);return!(t.length=0)})):a.fond&&e(a.fond.map(function(e){return"images/map_bg/"+e+".png"}),2===a.fond.length))}function setupBgLayer(e,t,n){for(var a=0;a<e.length;a++)oBgLayers[a]=new BGLayer(e[a],t?1:a+1,n);for(a=0;a<oPrevFrameStates.length;a++)for(var o=0;o<prevScreenDelay;o++)for(var i=0;i<oBgLayers.length;i++)oPrevFrameStates[a][o].layer.push(oBgLayers[i].clone(a,oPrevFrameStates[a][o].container))}function loadBgLayer(e){for(var t=0;t<e.length;t++)(new Image).src=e[t]}function checkItemLap(e,t){var n,a,o=0<=e.ailap?e.ailap:e.lapId,i=oMap.lapOverrides&&oMap.lapOverrides[o];i&&((a=e.ailapt)||(a=(n=oMap.lapOverrides[o-1])?n.tours:1),n=getCurrentLMap(o),o=getNextCp({tours:a}),e.ailapc||e.aipoint<n.checkpoint.length/2||(e.ailapc=1),e.ailapc&&enteredCheckpoint(n.checkpointCoords[o],e,t)&&(a++,e.ailapt&&(e.ailapt=a)),(a=a-1)>i.lap||a===i.lap&&!i.cp?incItemLap(n,e):e.ailap<i.lap||i.cp&&enteredCheckpoint(n.checkpointCoords[i.cp],e,t)&&incItemLap(n,e))}function incItemLap(e,t){var n;0<=t.ailap?(t.ailap++,(n=getCurrentLMap(t.ailap)).aipoints!==e.aipoints&&(t.ailapc=0)<=t.aipoint&&0<=t.aimap&&(t.aimap%=n.aipoints.length,t.aipoint=0,n.aipoints.length&&n.aipoints[t.aimap].length||(t.aipoint=-1))):0<=t.lapId&&t.lapId++}function render(){var J={karts:[],decor:[],items:{}};if(oSpecCam){if(!oSpecCam.isSetup())return;J.cam={x:oSpecCam.pos.x,y:oSpecCam.pos.y,rotation:oSpecCam.pos.rotation}}for(var e=0;e<aKarts.length;e++){var t=aKarts[e];J.karts.push({ref:t,x:t.x,y:t.y,z:t.z,speed:t.speed,rotation:t.rotation,changeView:t.changeView||0,size:t.size,tourne:t.tourne,figstate:t.figstate||0,time:t.time,roulette:t.roulette,roulette2:t.roulette2,tombe:t.tombe,teleport:t.teleport})}for(var n,a=[],o=0;o<oPlayers.length;o++){var i=getPlayerAtScreen(o),r=getCurrentLMap(getCurrentLapId(i));if(!o||r.decor&&r.decor!==a[0].decor){a[o]={decor:r.decor};var l={};if(r.decor)for(var s in r.decor){l[s]=[];for(e=0;e<r.decor[s].length;e++){var c=r.decor[s][e];l[s].push({ref:c,x:c[0],y:c[1],z:c[3]})}}J.decor[o]=l}}for(n in items){J.items[n]=[];for(e=0;e<items[n].length;e++){var p=items[n][e];J.items[n].push({ref:p,x:p.x,y:p.y,z:p.z,size:p.size})}}function u(e){var t=(new Date).getTime(),n=1/nbFrames,a=e==nbFrames;if(a&&(lastState=J),1==nbFrames)(o=J).players=[];else{if(1<e){if(e+1<=(n+=(t-lastStateTime)/SPF)*nbFrames)return;1<n&&(n=1)}else lastStateTime=t;var o={karts:[],players:[],decor:[],items:{}};J.cam&&(e=lastState.cam,t=J.cam,e=e||t,o.cam={x:interpolateState(e.x,t.x,n),y:interpolateState(e.y,t.y,n),rotation:interpolateStateAngle(e.rotation,t.rotation,n)});for(var i=0;i<J.karts.length;i++){var r=J.karts[i],l=getLastObj(lastState.karts,i,r);r.ref.progressiveView||(l.changeView=r.changeView),r.tombe&&!l.tombe&&(l.tombe=r.tombe),r.figstate&&!l.figstate&&(l.figstate=r.figstate),r.tourne&&!l.tourne&&(l.tourne=r.tourne),o.karts.push({ref:r.ref,x:interpolateState(l.x,r.x,n),y:interpolateState(l.y,r.y,n),z:interpolateState(l.z,r.z,n),speed:interpolateState(l.speed,r.speed,n),rotation:interpolateStateAngle(l.rotation,r.rotation,n),changeView:interpolateStateAngle(l.changeView,r.changeView,n),size:interpolateState(l.size,r.size,n),tourne:interpolateStateRound(l.tourne,r.tourne,n),figstate:interpolateStateRound(l.figstate,r.figstate,n),time:interpolateState(l.time,r.time,n),roulette:interpolateState(l.roulette,r.roulette,n),roulette2:interpolateState(l.roulette2,r.roulette2,n),tombe:interpolateState(l.tombe,r.tombe,n),teleport:interpolateStateNullable(l.teleport,r.teleport,n)})}for(var s=0;s<oPlayers.length;s++){var c=J.decor[s],p=lastState.decor[s];if(c&&p){var u={};for(V in c){u[V]=[];for(i=0;i<c[V].length;i++){r=c[V][i],l=getLastObj(p[V],i,r);u[V].push({ref:r.ref,x:interpolateState(l.x,r.x,n),y:interpolateState(l.y,r.y,n),z:interpolateState(l.z,r.z,n)})}}o.decor[s]=u}}for(V in J.items){o.items[V]=[];for(i=0;i<J.items[V].length;i++){r=J.items[V][i],l=getLastObj(lastState.items[V],i,r);o.items[V].push({ref:r.ref,x:interpolateState(l.x,r.x,n),y:interpolateState(l.y,r.y,n),z:interpolateState(l.z,r.z,n),size:interpolateState(l.size,r.size,n)})}}}for(i=0;i<oPlayers.length;i++)o.players.push(o.karts[i]);for(i=0;i<o.players.length;i++){var d=o.players[i];oSpecCam&&(d=o.karts[oSpecCam.playerId]);var m=getCurrentLapId(d.ref),h=getCurrentLMap(m),g=d.x,y=d.y,f=getApparentRotation(d);o.cam&&(g=o.cam.x,y=o.cam.y,f=o.cam.rotation),d.tombe?(10<d.tombe&&(f=20!=d.tombe||a?(g=d.ref.aX,y=d.ref.aY,getApparentRotation({rotation:d.ref.aRotation,changeView:d.changeView})):(g=interpolateState(lastState.karts[i].x,d.ref.aX,n),y=interpolateState(lastState.karts[i].y,d.ref.aY,n),d.x=g,d.y=y,d.z=0,d.rotation=d.ref.aRotation,d.ref.sprite[i].img.style.opacity=1-n,getApparentRotation(d))),oContainers[i].style.opacity=Math.abs(d.tombe-10)/10):d.teleport&&(3<d.teleport?(g=d.ref.aX,y=d.ref.aY,d.rotation=d.ref.aRotation):(g=d.ref.x,y=d.ref.y,d.rotation=d.ref.rotation),f=getApparentRotation(d),d.ref.teleport&&(oContainers[i].style.opacity=Math.abs(d.teleport-3)/3));var S={x:g,y:y,rotation:f};clonePreviousScreen(i,d),redrawCanvas(i,S,h),!d.time||(y=document.getElementById("lakitu"+i))&&(y.style.left=Math.round(iScreenScale*(20-d.time/5))+"px",y.style.top=Math.round((18-Math.abs(d.time-20))*(iScreenScale-2))+"px");for(var v,b=0;b<oRoulettesPrefixes.length;b++){var C,x,M=oRoulettesPrefixes[b],P=d["roulette"+M];P&&P<25&&(x=+(C=document.getElementById("scroller"+M+i).getElementsByTagName("div")[0]).dataset.h,P=+C.dataset.s,M=+C.dataset.v,0<(M=parseInt(C.style.top)+Math.round(iScreenScale*M/nbFrames))&&(M+=P-x),C.style.top=M+"px")}for(b=0;b<o.karts.length;b++){var k=(v=o.karts[b]).ref,I=getCurrentLapId(k),w=S;lapInteractionsDisabled(m,I)?(k.sprite[i].noInteract=!0,k.sprite[i].div.classList.add("nointeract")):k.sprite[i].noInteract&&(delete k.sprite[i].noInteract,k.sprite[i].div.classList.remove("nointeract"));var L=nearestAngleMirrored(f-v.rotation,180,360),T=Math.round(11*L/180)+v.tourne%21;21<T&&(T-=22);var E,D,B,O,z=v==d&&!oSpecCam;if(v.changeView||(v.figstate?T=(T+21-v.figstate)%21:k.driftinc&&(T<4||18<T)?T=0<k.driftinc*getMirrorFactor()?18:4:z&&(k.rotincdir&&!v.tourne?T=0<k.rotincdir*getMirrorFactor()?23:22:v.tourne||(T=0))),k.sprite[i].setState(T),k.sprite[i].render(S,v),"BB"==course)for(var H=k.ballons.length,R=v.size/2,A=correctZInv(correctZ(v.z)+2*R*(6+(k.sprite[i].h-32)/5)),N=2.5*getMirrorFactor(),_=0;_<H;_++)k.ballons[_][i].render(w,{x:v.x-(_+.75-H/2)*N*v.size*direction(1,f),y:v.y+(_+.75-H/2)*N*v.size*direction(0,f),z:A,size:R});k.driftinc?k.z&&"block"!==k.driftSprite[i].div.style.display||k.driftSprite[i].render(w,{x:v.x,y:v.y,z:v.z,size:v.size/2}):k.driftSprite[i].div.style.display="none",k.wrongWaySprite&&i===b&&(E=interpolateState(-1,0,n),L=k.wrongWaySince+E-10,k.wrongWaySprite[i].setState(Math.floor(L%8/4)),O=L<20?(B=L/20,D=15*(Math.pow(B,.7)-1),40*(1-B)):(B=(L-=20)%30/30,T=Math.cos(2*Math.PI*B),D=5*(L=Math.sin(2*Math.PI*B))/(O=1+T*T),-10*T*L/O),D-=2,k.rightWaySince&&(O+=50*((k.rightWaySince+E)/10)),k.wrongWaySprite[i].render(w,{x:v.x-D*direction(1,f),y:v.y+D*direction(0,f),z:20+O})),z||!k.marker||k.loose||k.tombe||k.marker.render(i,w,v)}for(var V,F,b=0;b<h.arme.length;b++){var j=(v=h.arme[b])[2];if(j.active)for(var _=0;_<j.box.length;_++)j.box[_][i].render(S,{x:v[0],y:v[1],z:4.5*_});else!i&&a&&(j.countdown?j.countdown--:j.active=!0)}if(h.coins)for(b=0;b<h.coins.length;b++){v=h.coins[b];var K=S.rotation*Math.PI/180,K=Math.abs(Math.cos(v.theta-K));v.sprite[i].w=24*K,v.sprite[i].z=.5*(K-1),v.sprite[i].render(S,{x:v.x,y:v.y})}for(V in u=o.decor[i]||o.decor[0])for(b=0;b<u[V].length;b++)(v=u[V][b]).ref[2][0].unshown||v.ref[2][i].render(S,{x:v.x,y:v.y,z:v.z,size:1.2});for(F in o.items)for(b=0;b<o.items[F].length;b++){var W,k=(v=o.items[F][b]).ref;!a||(W=itemBehaviors[F]).render&&W.render(k,i),k.sprite&&(I=getItemCollisionLap(k),lapInteractionsDisabled(m,I)?(k.sprite[i].noInteract=!0,k.sprite[i].div.classList.add("nointeract")):k.sprite[i].noInteract&&(delete k.sprite[i].noInteract,k.sprite[i].div.classList.remove("nointeract")),k.sprite[i].render(S,v))}if(a)for(b=0;b<aKarts.length;b++){var q=aKarts[b],G=q.sprite[i];0<q.figstate&&q.figuring?G.div.hallowed||(G.div.hallowed=!0,G.div.style.backgroundImage="url('images/halo.png')",G.div.style.backgroundRepeat="no-repeat",G.div.style.backgroundSize="contain",G.img.style.opacity=.7):G.div.hallowed&&(G.div.hallowed=!1,G.div.style.backgroundImage="",G.div.style.backgroundRepeat="",G.div.style.backgroundSize="",G.img.style.opacity=1)}for(b=0;b<oBgLayers.length;b++)oBgLayers[b].draw(f,i);oPlanCtn&&setPlanPos(o,h)}}lastStateChange&&(lastStateChange=!1,lastState&&(lastState.decor=J.decor,lastState.items=J.items)),lastState=lastState||J;for(e=1;e<nbFrames;e++)!function(e){frameHandlers[e]=setTimeout(function(){u(e+1)},SPF*e/nbFrames)}(e);u(1)}function hideLapSprites(e,t){for(var n=0;n<e.arme.length;n++)for(var a=e.arme[n][2],o=0;o<a.box.length;o++)a.box[o][t].div.style.display="none";if(e.decor)for(var i in e.decor)for(var r=0;r<e.decor[i].length;r++)e.decor[i][r][2][t].div.style.display="none"}function makeSpriteExplode(e,t,n){var a="explosion";-1!=e.team?a+=e.team:a+=t,e.sprite[n].img.src="images/sprites/sprite_"+a+".png";a=e.sprite[n].div.getElementsByClassName("sprite-hallow");a.length&&e.sprite[n].div.removeChild(a[0])}function correctZ(e){return 7*Math.pow(e/7,.7)}function correctZInv(e){return 7*Math.pow(e/7,1/.7)}function correctCamZ(e,t){return correctZ(e)*iCamDist/t}function direction(e,t){return Math[["sin","cos"][e]](t*Math.PI/180)}function getItemDistributionRange(e){var t=(e.place-1)/aKarts.length,n=e.place/aKarts.length;if("BB"!=course){s=1==e.place?(a=-distanceToSecond(e),l=0,.18*Math.exp(a/150)):(o=distanceToFirst(e),l=Math.pow(o/metaItemRange,.75),.07);var a=Math.min(1,l),o=Math.min(1,l+s),t=getItemAvgRange(a,t),n=getItemAvgRange(o,n)}else{for(var i=0,r=0;r<aKarts.length;r++)i=Math.max(i,aKarts[r].ballons.length+aKarts[r].reserve);var l,s,o=(l=(i-(e.ballons.length+e.reserve))/2.5)+(s=.07);t=getItemAvgRange(a=l,t),n=getItemAvgRange(o,n)}return[t*itemDistribution.value.length,n*itemDistribution.value.length]}function getItemAvgRange(e,t){var n;switch(itemDistribution.algorithm){case"dist":n=e;break;case"rank":n=t;break;default:n=Math.pow(e,1-metaItemPosition)*Math.pow(t,metaItemPosition)}return Math.min(.99999,n)}function randObj(e){var t=getItemDistributionRange(e),e=t[0],t=t[1],e=Math.floor(e+(t-e)*Math.random()),n=itemDistribution.value[e],a=0;for(o in n)a+=n[o];var o,i=Math.floor(Math.random()*a),a=0;for(o in n)if(i<(a+=n[o]))return o}function possibleObjs(e,t){var n=getItemDistributionRange(e),e=Math.floor(n[0]+.005),a=Math.ceil(n[1]-.005),o={};e>=itemDistribution.value.length&&(e=itemDistribution.value.length-1,a=itemDistribution.value.length);for(var i,r=e;r<a;r++)for(i in itemDistribution.value[r])t[i]||(o[i]=!0);return o}function otherObjects(e,t){t=possibleObjs(e,t);return 0<Object.getOwnPropertyNames(t).length}function friendlyFire(e,t){return e==t||iTeamPlay&&!selectedFriendlyFire&&e.team==t.team}function sameTeam(e,t){return-1!=e&&e==t}function friendlyHit(e,t){return!(selectedFriendlyFire||!sameTeam(e,t))}function addNewBalloon(e,t){e.ballons.push(createBalloonSprite(e,t))}function popBalloon(e){var t=e.ballons.length-1;t<0||(e.ballons[t][0].suppr(),e.ballons.pop())}function inflateNewBalloons(e){for(var t=1+Math.round(Math.random()),n=0;n<t&&e.reserve;n++)addNewBalloon(e),e.reserve--}function createBalloonSprite(e,t){return void 0===t&&(t=e.team),new Sprite("ballon"+(-1!=t?t:""))}function balloonSrc(e){return"images/sprites/sprite_"+(-1==e?"ballon":"ballon"+e)+".png"}function updateBalloonHud(e,t){var n=balloonSrc(t.team);e.innerHTML="";for(var a=0;a<t.reserve;a++)e.innerHTML+='<img src="'+n+'" style="width:'+3*iScreenScale+"px;margin:0 "+Math.round(.5*iScreenScale)+"px 0 "+Math.round(.2*iScreenScale)+'px" />'}var syncItems=[];function detruit(e,t){isOnline&&((e=getItemToDestroy(e)).deleted=1,syncItems.push(e)),supprime(e,t)}function supprime(e,t){var n=e.type,a=items[n].indexOf(e);if(-1!=a){var o=itemBehaviors[n];if(e.sprite){for(var i=0;i<oPlayers.length;i++){var r=getPlayerAtScreen(i);r.tombe||(r={x:r.x,y:r.y,rotation:getApparentRotation(r)},e.sprite[i].render(r,e))}e.sprite[0].fadeout(o.fadedelay)}o.del&&o.del(e);for(i=0;i<aKarts.length;i++){var l=aKarts[i].using.indexOf(e);if(-1!=l){aKarts[i].using.splice(l,1),aKarts[i].using.length||consumeItemIfDouble(i),t&&playIfShould(aKarts[i],"musics/events/hit.mp3")&&(t=!1);break}}"object"==typeof t&&playDistSound(t,"musics/events/hit.mp3",80),!clLocalVars.myItems||-1!=(o=clLocalVars.myItems.indexOf(e))&&clLocalVars.myItems.splice(o,1),items[n].splice(a,1)}}function getItemToDestroy(e){for(var t=0;t<aKarts.length;t++)if(-1!=aKarts[t].using.indexOf(e)){var n=aKarts[t].using[0];return n.type===e.type?n:e}return e}function supprArme(e){for(var t=aKarts[e],n=0;n<oRoulettesPrefixes.length;n++)t["roulette"+oRoulettesPrefixes[n]]=0,t[oArmeKeys[n]]=!1;kartIsPlayer(t)&&(updateObjHud(e),updateItemCountdownHud(e,null),removeIfExists(t.rouletteSound))}function consumeItem(e){var t=aKarts[e];t.arme=t.stash,t.stash=!1,t.roulette=t.roulette2,t.roulette2=0,kartIsPlayer(t)&&(updateObjHud(e),updateItemCountdownHud(e,null))}function consumeItemIfDouble(e){oDoubleItemsEnabled&&consumeItem(e)}function loseUsingItems(e){if(e.using.length){for(var t=0;t<e.using.length;t++){var n=e.using[t];n.z&&(n.z=0);var a=itemBehaviors[n.type];a.drop&&a.drop(n,e),isOnline&&syncItems.push(n)}e.using.length=0,consumeItemIfDouble(aKarts.indexOf(e))}}function loseUsingItem(e){void 0===e.rotitem&&loseUsingItems(e)}function dropCurrentItem(e){var t=e.arme;if(t){var n=e.roulette,a=aKarts.indexOf(e);if(consumeItem(a),consumeItemIfDouble(a),delete e.champiType,delete e.champior,delete e.champior0,!(n<25||isOnline&&e.id!=identifiant&&e.controller!=identifiant)){var o,i=1,n=t.match(/^(.+)X(\d+)$/);switch(n&&(t=n[1],i=+n[2]),t){case"champi":case"etoile":case"banane":case"carapace":case"poison":o=t;break;case"carapacerouge":o="carapace-rouge"}if(o)for(var r=0;r<i;r++){var l=e.rotation*Math.PI/180+.9*(Math.random()-.5)*Math.PI,s=9+6*Math.random(),l={type:o,team:e.team,x:e.x-s*Math.sin(l),y:e.y-s*Math.cos(l),z:0};dropNewItem(e,l),l.sprite[0].fadein(200)}}}}function deleteUsingItems(e){for(var t=e.using.length-1;0<=t;t--)detruit(e.using[t])}function moveUsingItems(e,t){if(e.using.length){var n=0,a=5,o=360/e.using.length,i="banane"===e.using[0].type;void 0!==e.rotitem&&(n=e.rotitem,a=i?4:4.5,t||(e.rotitem-=30));for(var r=0;r<e.using.length;r++){var l=e.using[r];i?(l.x=e.x-a*(.7+.35*(e.using.length-r))*direction(0,e.rotation),l.y=e.y-a*(.7+.35*(e.using.length-r))*direction(1,e.rotation)):(l.x=e.x-a*direction(0,e.rotation+n+r*o),l.y=e.y-a*direction(1,e.rotation+n+r*o)),l.z=e.z}}else delete e.rotitem}function hasOnHoldItem(e){return e.using.length&&void 0===e.rotitem}function stopDrifting(e){e=aKarts[e];e.driftinc=0,e.driftcpt=0,e.turbodrift=0,resetDriftSprite(e),e.driftSound&&(e.driftSound.pause(),e.driftSound=void 0),e.sparkSound&&(e.sparkSound.pause(),e.sparkSound=void 0)}function resetDriftSprite(e){for(var t=0;t<oPlayers.length;t++){var n=e.driftSprite[t];n.div.style.display="none",n.setState(0)}}function isJumpEnabled(){return!(isOnline&&shareLink.options&&shareLink.options.noJump)}function isRdDisabled(){return isOnline&&shareLink.options&&shareLink.options.noRd}function isLocalScore(){return!isOnline||shareLink.options&&shareLink.options.localScore}function showRearView(e){var t=oPlayers[e],n=180-t.changeView;t.changeView=n,t.sprite[0].setState(11),!bCounting||(e=document.getElementById("oCounts"+e))&&(e.style.visibility=t.changeView?"hidden":"visible")}function resetSpriteHeight(e){e.lastW=e.w,e.lastH=e.h,e.w=32,e.h=32}function resumeSpriteSize(e){e.lastW&&(e.w=e.lastW,delete e.lastW),e.lastH&&(e.h=e.lastH,delete e.lastH)}function updateProtectFlag(e){e.protect=e.etoile||e.megachampi||e.billball||e.cannon}function colKart(e){for(var t=aKarts[e],n=getCurrentLapId(t),a=0;a<e;a++){var o,i,r,l,s,c,p,u,d,m,h,g=aKarts[a],y=getCurrentLapId(g);lapInteractionsDisabled(n,y)||(o=t.protect?t.etoile||t.billball?2:1:0,u=g.protect?g.etoile||g.billball?2:1:0,m="BB"==course&&!t.champi!=!g.champi,t.cpu&&g.cpu&&o==u&&!m||!friendlyFire(t,g)&&("BB"!=course||t.ballons.length&&g.ballons.length)&&Math.pow(t.x-g.x,2)+Math.pow(t.y-g.y,2)<1e3&&(t.z<=jumpHeight0||t.billball&&!t.cannon)&&(g.z<=jumpHeight0||g.billball&&!g.cannon)&&!t.tourne&&!g.tourne&&(i=kartInstantSpeed(t),l=[(r=kartInstantSpeed(g))[0]-i[0],r[1]-i[1]],h=[t.x-g.x,t.y-g.y],d=5*(g.size+t.size)*(g.size+t.size),(y=projete(0,0,h[0],h[1],h[0]-l[0],h[1]-l[1]))<0&&(y=0),1<y&&(y=1),(y=(y=[h[0]-y*l[0],h[1]-y*l[1]])[0]*y[0]+y[1]*y[1])<=d&&(o||u?o!=u&&y<d/2&&((s=o<u?t:g).loose||s.cannon||s.frminv||(c=o<u?g:t,p=aKarts.indexOf(s),handleHit2(c,s),loseBall(p),stopDrifting(p),s.spin(62),loseUsingItems(s),dropCurrentItem(s))):isOnline&&shareLink.options&&shareLink.options.noBumps||(m&&((s=t.champi?g:t).loose||s.cannon||s.frminv||(c=t.champi?t:g).champiType===CHAMPI_TYPE_ITEM&&(p=aKarts.indexOf(s),handleHit2(c,s),loseBall(p),stopDrifting(p),c.ballons.length<3&&addNewBalloon(c,s.team),s.spin(62))),d<h[0]*h[0]+h[1]*h[1]&&(t.cpu&&g.cpu||(m=(u=[h[1],-h[0]])[0]*h[1]-h[0]*u[1])&&(d=(u[0]*l[1]-u[1]*l[0])/m,m=(h[1]*l[0]-h[0]*l[1])/m,h[0]*=d,h[1]*=d,u[0]*=m,u[1]*=m,m=g.stats.mass*g.size/(t.stats.mass*t.size),h=[h[0]*m,h[1]*m],(!t.pushVector||t.pushVector[0]*t.pushVector[0]+t.pushVector[1]*t.pushVector[1]<h[0]*h[0]+h[1]*h[1])&&(t.pushVector=h),h=[(u[0]+i[0]-r[0])/m,(u[1]+i[1]-r[1])/m],(!g.pushVector||g.pushVector[0]*g.pushVector[0]+g.pushVector[1]*g.pushVector[1]<h[0]*h[0]+h[1]*h[1])&&(g.pushVector=h),g.cpu||g.colSound||(g.colSound=playIfShould(g,"musics/events/colkart.mp3"),g.colSound&&function(e){e.colSound.onended=function(){e.colSound=void 0,document.body.removeChild(this)}}(g))))))))}}function pointInRectangle(e,t,n){return e>n[0]&&e<=n[0]+n[2]&&t>n[1]&&t<=n[1]+n[3]}function pointInPolygon(e,t,n){for(var a=!1,o=0,i=n.length-1;o<n.length;i=o++){var r=n[o][0],l=n[o][1],s=n[i][0],c=n[i][1];t<l!=t<c&&e<(s-r)*(t-l)/(c-l)+r&&(a=!a)}return a}function pointInZone(e,t,n){for(var a=n.rectangle,o=0;o<a.length;o++)if(pointInRectangle(e,t,a[o]))return 1;for(var i=n.polygon,o=0;o<i.length;o++)if(pointInPolygon(e,t,i[o]))return 1}function pointInQuad(e,t,n){var a=projete(e,t,n.A[0],n.A[1],n.B[0],n.B[1]);return 0<a&&a<=1&&0<(a=projete(e,t,n.A[0],n.A[1],n.C[0],n.C[1]))&&a<=1}function pointInAltitude(e,t,n){return n<getZoneHeight(e,t)}function getZoneHeight(e,t){return getPointHeight((e[t]||{z:1}).z)}function getPointHeight(e){return e*jumpHeight1}function pointCrossRectangle(e,t,n,a,o){for(var i=[e,t],r=[n,a],l=[0<n,0<a],s=0;s<2;s++){var c=l[s];if(c?i[s]<=o[s]&&i[s]+r[s]>=o[s]:i[s]>=o[s]+o[s+2]&&i[s]+r[s]<=o[s]+o[s+2]){var p=1-s,c=i[p]+((c?o[s]:o[s]+o[s+2])-i[s])*r[p]/r[s];if(c>=o[p]&&c<=o[p]+o[2+p])return 1}}}function pointCrossPolygon(e,t,n,a,o){for(var i=0;i<o.length;i++){var r=o[i],l=o[(i+1)%o.length];if(secants(e,t,n,a,r[0],r[1],l[0],l[1]))return 1}}var jumpHeight0=1.175,jumpHeight1=jumpHeight0+1e-5;function canMoveTo(e,t,n,a,o,i,r){var l=e+a,s=t+o,c=getCurrentLMap(collisionLap);if(c.decor)for(var p in c.decor)for(var u=decorBehaviors[p],d=u.hitbox||DEFAULT_DECOR_HITBOX,m=u.hitboxH||DEFAULT_DECOR_HITBOX_H,h=0;h<c.decor[p].length;h++){var g=c.decor[p][h];if(l>g[0]-d&&l<g[0]+d&&s>g[1]-d&&s<g[1]+d&&Math.abs((g[3]||0)-n)<m&&!(null==g[3]&&e>g[0]-d&&e<g[0]+d&&t>g[1]-d&&t<g[1]+d)){if(i&&!u.unbreaking){handleDecorHit(h,p,c);break}if(collisionDecor=p,collisionTest==COL_KART?(u.breaking||isBreakingItem(u))&&4<collisionPlayer.speed&&(handleDecorHit(h,p,c),collisionPlayer.turbodrift&&(collisionPlayer.turbodrift=0),u.bonus&&(isOnline&&(collisionPlayer!=oPlayers[0]||onlineSpectatorId)||(g="champi","CM"!=course&&Math.random()<.5&&(g="banane"),addNewItem(collisionPlayer,{type:g,team:collisionPlayer.team,x:l+2.5*a,y:s+2.5*o,z:0})))):collisionTest==COL_OBJ&&collisionItem&&u.damagingItems&&u.damagingItems[collisionItem.type]&&handleDecorHit(h,p,c),!u.transparent)return}}if(jumpHeight0<n&&!c.collisionProps)return 1;if(!c.collision)return 1;if(!isCup)if("BB"==course||c.map<=20){if(e>c.w-5||t>c.h-5||e<4||t<4)return 1}else if(e>=c.w||t>=c.h||e<0||t<0)return 1;for(var y=0,f=c.collision.rectangle,h=0;h<f.length;h++)pointInRectangle(e,t,f[h])&&(y=Math.max(y,getZoneHeight(c.collisionProps.rectangle,h)));for(var S=c.collision.polygon,h=0;h<S.length;h++)pointInPolygon(e,t,S[h])&&(y=Math.max(y,getZoneHeight(c.collisionProps.polygon,h)));if(c.elevators){for(var v=c.elevators.rectangle,h=0;h<v.length;h++){var b=v[h];!pointInRectangle(e,t,b[0])||r<getPointHeight(b[1][0])||(y=Math.max(y,getPointHeight(b[1][1])))}for(var C=c.elevators.polygon,h=0;h<C.length;h++){var x=C[h];!pointInPolygon(e,t,x[0])||r<getPointHeight(x[1][0])||(y=Math.max(y,getPointHeight(x[1][1])))}}if(r&&(n+=r),y){if(!c.collisionProps)return 1;n<y&&(n=y),collisionFloor={z:y}}if(!isCup&&n<=jumpHeight0)if("BB"==course||c.map<=20){if(l>c.w-5||s>c.h-5||l<4||s<4)return}else if(l>=c.w||s>=c.h||l<0||s<0)return;for(h=0;h<f.length;h++)if(pointCrossRectangle(e,t,a,o,f[h])&&pointInAltitude(c.collisionProps.rectangle,h,n))return;for(h=0;h<S.length;h++)if(pointCrossPolygon(e,t,l,s,S[h])&&pointInAltitude(c.collisionProps.polygon,h,n))return;return 1}function getLineHorizontality(e,t,n,a,o){for(var i=null,r=1,l=0;l<o.length;l++){var s=o[l],c=secants(e,t,n,a,s.x1,s.y1,s.x2,s.y2);c&&c[0]<r&&(r=c[0],i={dir:[s.x2-s.x1,s.y2-s.y1],t:r})}return i}function isBreakingItem(e){return e.damagingItems&&(e.damagingItems.megachampi&&collisionPlayer.megachampi||(e.damagingItems.billball&&collisionPlayer.billball||(e.damagingItems.etoile&&collisionPlayer.etoile||!(!e.damagingItems.champi||!collisionPlayer.champi||collisionPlayer.champiType!==CHAMPI_TYPE_ITEM))))}function secants(e,t,n,a,o,i,r,l){var s=-n*l+n*i+e*l-e*i+r*a-r*t-o*a+o*t,l=(-r*t+o*t-e*i+e*l+r*i-o*l)/s;if(0<=l&&l<=1){s=(e*a-n*t+n*i-e*i-o*a+o*t)/s;if(0<=s&&s<=1)return[l,s]}return null}function intersectionLineLine(e,t,n,a,o,i,r,l){var s=-n*l+n*i+e*l-e*i+r*a-r*t-o*a+o*t;return[(-r*t+o*t-e*i+e*l+r*i-o*l)/s,(e*a-n*t+n*i-e*i-o*a+o*t)/s]}function projete(e,t,n,a,o,i){var r=(o-n)*(o-n)+(i-a)*(i-a);return r?(-n*o+n*n+e*o-e*n-a*i+a*a+t*i-t*a)/r:1}function intersectionLineCircle(e,t,n,a,o,i,r){var l=n*n,s=i*i,n=r*r,l=-s*(o*o)+2*s*t*o+2*i*r*a*o-2*i*r*e*o-s*(t*t)-2*i*r*a*t+2*i*r*e*t-n*(a*a)+2*n*e*a-n*(e*e)+l*n+l*s;if(0<=l){n=s+n,e=r*o-r*t+i*a-i*e;return(Math.sqrt(l)-e)/n}return NaN}function followCircleWithAngle(e,t,n,a,o,i){var r=Math.hypot(o,i),l=Math.hypot(n-e,a-t),e=Math.atan2(i,o)-Math.atan2(a-t,n-e),e=Math.sin(e);if(r&&e){e=l/(2*e);return[n-i*e/r,a+o*e/r,e]}return[n,a,l]}function nextAiStop(e,t,n,a,o,i,r,l,s){var c=Math.hypot(n,a),p=Math.hypot(r,l),u=r*a-n*l;if(c&&p&&u)for(var d=-1;d<2;d+=2)for(var m=-1;m<2;m+=2){var h=(n*(-s*m*p+r*(i-t)-l*o)+r*s*d*c+a*r*e)/u,g=(a*(-s*m*p+r*i+l*(e-o))+l*s*d*c-n*l*t)/u,y=l*s*-m/p,f=m*(r*s)/p,S=projete(h+a*s*-d/c,g+d*(n*s)/c,e,t,e+n,t+a),f=projete(h+y,g+f,o,i,o+r,i+l);if(S<=1&&0<=f)return S}return 0<n*r+a*l?1:0}function aiMarginLimitSpeed(e,t,n,a,o,i,r,l,s,c){for(var p=Math.hypot(r,l),u=1/0,d=-1;d<2;d+=2){var m=aiMarginLimitRadius(e,t,n,a,o+d*l*s/p,i-d*r*s/p,r,l);m<u&&(u=m)}return 2*u*c}function aiMarginLimitRadius(e,t,n,a,o,i,r,l){var s=o-e,c=i-t,p=n*n*l*l-2*n*a*r*l+a*a*r*r,u=n*n*(l*l*l*l+r*r*l*l)+n*a*r*l*(-2*l*l-2*r*r)+a*a*r*r*(l*l+r*r);if(p&&u)for(var d=-1;d<2;d+=2){var m=Math.hypot(n,a),h=Math.hypot(r,l),g=(a*(-d*s*m*l*h+d*c*m*r*h+n*(s*r*l-c*r*r))+a*a*(s*l*l-c*r*l))/p,y=-(n*(d*c*m*r*h-d*s*m*l*h)+n*a*(s*l*l-c*r*l)+n*n*(s*r*l-c*r*r))/p,f=(a*l*l*(d*c*m*r*h-d*s*m*l*h)+n*r*l*(d*c*m*r*h-d*s*m*l*h)+a*a*l*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r)+n*n*l*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r))/u,h=-(a*r*l*(d*c*m*r*h-d*s*m*l*h)+n*r*r*(d*c*m*r*h-d*s*m*l*h)+a*a*r*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r)+n*n*(s*r*l*l*l-c*r*r*l*l+s*r*r*r*l-c*r*r*r*r))/u,f=rotateVector(n,a,Math.atan2(h,f)-Math.atan2(y,g));if(0<=f[0]*r-f[1]*l)return Math.hypot(g,y)}return 1/0}function rotateVector(e,t,n){var a=Math.cos(n),n=Math.sin(n);return[e*a-t*n,e*n+t*a]}function getHorizontality(m,h,g,e,t,n){var a=getCurrentLMap(collisionLap);n=n||{};var y={t:1},f=m+e,S=h+t;if(isCup||("BB"==course||a.map<=20?((f>a.w-5||f<4)&&(y.dir=[0,a.h]),(S>a.h-5||S<4)&&(y.dir=[a.w,0])):((f>=a.w||f<0)&&(y.dir=[0,a.h]),(S>=a.h||S<0)&&(y.dir=[a.w,0]))),a.decor&&!n.skipDecor)for(var o in a.decor)for(var i=0;i<a.decor[o].length;i++){var r=a.decor[o][i],l=decorBehaviors[o].hitbox||DEFAULT_DECOR_HITBOX,l=[{x1:r[0]-l,y1:r[1]-l,x2:r[0]+l,y2:r[1]-l},{x1:r[0]-l,y1:r[1]-l,x2:r[0]-l,y2:r[1]+l},{x1:r[0]-l,y1:r[1]+l,x2:r[0]+l,y2:r[1]+l},{x1:r[0]+l,y1:r[1]-l,x2:r[0]+l,y2:r[1]+l}],l=getLineHorizontality(m,h,f,S,l);l&&l.t<y.t&&(y=l)}function s(e,t,n){for(var a=e.rectangle,o=0;o<a.length;o++){var i=t(a[o]),r=[{x1:i[0],y1:i[1],x2:i[0]+i[2],y2:i[1]},{x1:i[0],y1:i[1],x2:i[0],y2:i[1]+i[3]},{x1:i[0]+i[2],y1:i[1],x2:i[0]+i[2],y2:i[1]+i[3]},{x1:i[0],y1:i[1]+i[3],x2:i[0]+i[2],y2:i[1]+i[3]}];(s=getLineHorizontality(m,h,f,S,r))&&s.t<y.t&&n("rectangle",o,g)&&(y=s)}for(var l=e.polygon,o=0;o<l.length;o++){for(var s,r=[],c=t(l[o]),p=0;p<c.length;p++){var u=c[p],d=c[(p+1)%c.length];r.push({x1:u[0],y1:u[1],x2:d[0],y2:d[1]})}(s=getLineHorizontality(m,h,f,S,r))&&s.t<y.t&&n("polygon",o,g)&&(y=s)}}if(a.collision&&s(a.collision,function(e){return e},function(e,t,n){return pointInAltitude(a.collisionProps[e],t,n)}),n.holes&&a.trous)for(var c in a.trous)s(a.trous[c],function(e){return e[0]},function(e){return 1});return y.dir?(t=Math.hypot(y.dir[0],y.dir[1]),y.dir[0]/=t,y.dir[1]/=t):n.nullableRes||(y.dir=[.7,.7]),y.dir}function normalizeAngle(e,t){return e-t*Math.round(e/t)}function nearestAngle(e,t,n){return e+n*Math.round((t-e)/n)}function nearestAngleMirrored(e,t,n){return nearestAngle(e*getMirrorFactor(),t,n)}function getNearestHoleDist(e,t){var n,a=e.x,o=e.y,i=getCurrentLMap(getCurrentLapId(e)),r=t||1/0;if(!i.trous)return r;for(n in collisionItem=null,i.trous){for(var l=i.trous[n].rectangle,s=0;s<l.length;s++){r=getHoleSegmentDist(r,a,o,(p=l[s][0])[0],p[1],p[2],0);if(r=getHoleSegmentDist(r,a,o,p[0],p[1],0,p[3]),r=getHoleSegmentDist(r,a,o,p[0],p[1]+p[3],p[2],0),(r=getHoleSegmentDist(r,a,o,p[0]+p[2],p[1],0,p[3]))<t)return r}for(var c=i.trous[n].polygon,s=0;s<c.length;s++){for(var p=c[s][0],u=0;u<p.length;u++){var d=(u+1)%p.length;r=getHoleSegmentDist(r,a,o,p[u][0],p[u][1],p[d][0],p[d][1])}if(r<t)return r}}return r}function getHoleSegmentDist(e,t,n,a,o,i,r){var l=projete(t,n,a,o,a+i,o+r);l<0&&(l=0),1<l&&(l=1);i=a+l*i-t,l=o+l*r-n,r=i*i+l*l;return!(e<r)&&canMoveTo(t,n,0,i,l)?r:e}function objet(e,t,n,a){for(var o=getCurrentLMap(collisionLap),i=-1,r=0,l=0;l<o.arme.length;l++){var s=o.arme[l],c=[s[0]-7,s[1]-7,14,14];!pointCrossRectangle(e,t,n,a,c)&&!pointInRectangle(e,t,c)||!s[2].active||r<(s=s[2].box.length)&&(i=l,r=s)}if(-1!==i){var p=o.arme[i][2];p.active=!1,p.countdown=20;for(var u=0;u<r;u++)for(var d=p.box[u],m=0;m<strPlayer.length;m++)d[m].div.style.display="none"}return i}function touche_piece(e,t,n,a){var o=getCurrentLMap(collisionLap);if(o.coins)for(var i=0;i<o.coins.length;i++){var r=o.coins[i],l=[r.x-5,r.y-5,10,10];if(pointCrossRectangle(e,t,n,a,l)||pointInRectangle(e,t,l))return r.sprite[0].suppr(),o.coins.splice(i,1),1}}function sauts(e,t,n,a){var o=getCurrentLMap(collisionLap);if(!o.sauts)return!1;for(var i=o.sauts.rectangle,r=0;r<i.length;r++){if(pointInRectangle(e,t,(l=i[r])[0]))return l[1];if(pointCrossRectangle(e,t,n,a,l[0]))return l[1]}for(var l,s=o.sauts.polygon,c=e+n,p=t+a,r=0;r<s.length;r++){if(pointInPolygon(e,t,(l=s[r])[0]))return l[1];if(pointCrossPolygon(e,t,c,p,l[0]))return l[1]}return!1}function sizeSpeedRatio(e){return e.megachampi?Math.pow(e.size,.3):e.size}function handleJump(e,t){if(t&&!e.tourne){t=1.5*t;return e.heightinc=t*Math.pow(cappedRelSpeed(e),-.7),1<fSelectedClass&&.7*e.heightinc*e.heightinc<jumpHeight0&&(e.z=Math.max(e.z,t*t-e.heightinc*e.heightinc)),1}}function handleHeightInc(e){return e.z+=.7*e.heightinc*Math.abs(e.heightinc),e.heightinc-=.5,e.z<=0?(e.heightinc=0,e.z=0,1):void 0}function handleCannon(e,t){return t&&(t[0]||t[1])&&(e.cannon=[e.x+t[0],e.y+t[1],e.x,e.y],e.champi&&5e4<t[0]*t[0]+t[1]*t[1]&&(e.champi=0,delete e.champiType),e.z||(e.z=.001),e.heightinc=0,1)}function ralenti(e,t){var n,a=getCurrentLMap(collisionLap);for(n in a.horspistes){for(var o=a.horspistes[n],i=o.rectangle,r=0;r<i.length;r++)if(pointInRectangle(e,t,i[r]))return n;for(var l=o.polygon,r=0;r<l.length;r++)if(pointInPolygon(e,t,l[r]))return n}return!1}function getOffroadProps(e,t){switch(t){case"herbe":return{speed:1.9+e.speedinc/2};case"glace":return{speed:2.8+e.speedinc/2,sliding:8};case"eau":return{speed:2.7,sliding:5};case"choco":return{speed:2.1,sliding:4}}}function accelere(e,t,n,a){var o=getCurrentLMap(collisionLap);if(o.accelerateurs){for(var i=e+n,r=t+a,l=o.accelerateurs.rectangle,s=0;s<l.length;s++){var c=l[s];if(pointInRectangle(i,r,c))return 1;if(pointCrossRectangle(e,t,n,a,c))return 1}for(var p=o.accelerateurs.polygon,s=0;s<p.length;s++){if(pointInPolygon(i,r,p[s]))return 1;if(pointCrossPolygon(e,t,i,r,p[s]))return 1}}}function flowShift(e,t,n){var a=getCurrentLMap(collisionLap);if(a.flows){for(var o=a.flows.rectangle,i=0;i<o.length;i++)if(pointInRectangle(e,t,(r=o[i])[0])&&(!n||r[2]))return[r[1][0],r[1][1],0];for(var r,l=a.flows.polygon,i=0;i<l.length;i++)if(pointInPolygon(e,t,(r=l[i])[0])&&(!n||r[2]))return[r[1][0],r[1][1],0]}if(a.spinners)for(var s=a.spinners,i=0;i<s.length;i++){var c=s[i],p=e-c[0],u=t-c[1];if(p*p+u*u<c[2]*c[2])return[u*c[3],-p*c[3],c[3]]}return[0,0,0]}function tombe(e,t,n){var a,o=getCurrentLMap(collisionLap);if(e>o.w?(e=o.w-.5,p=!0):e<=0&&(e=.5,p=!0),t>o.h?(t=o.h-.5,p=!0):t<=0&&(t=.5,p=!0),o.trous)for(var i in o.trous){for(var r=o.trous[i].rectangle,l=0;l<r.length;l++)if(pointInRectangle(e,t,(s=r[l])[0])){if(null==n)return!0;if(!s[1])return!0;if(a=[s[1][0],s[1][1],i],i%2-n)return a}for(var s,c=o.trous[i].polygon,l=0;l<c.length;l++)if(pointInPolygon(e,t,(s=c[l])[0])){if(null==n)return!0;if(!s[1])return!0;if(a=[s[1][0],s[1][1],i],i%2-n)return a}}if(a)return a;if(p){if(o.trous&&o.trous.cp)return!0;var p=null!=o.startposition[2]?o.startposition[2]:null!=o.startrotation?o.startrotation/90:2;return"BB"==course||[o.startposition[0],o.startposition[1],p]}return!1}function inCannon(e,t,n,a){var o=getCurrentLMap(collisionLap);if(!o.cannons)return!1;for(var i=o.cannons.rectangle,r=0;r<i.length;r++)if(pointInRectangle(n,a,(p=i[r])[0]))return p[1];for(var l=o.cannons.polygon,r=0;r<l.length;r++)if(pointInPolygon(n,a,(p=l[r])[0]))return p[1];for(var s=n-e,c=a-t,r=0;r<i.length;r++)if(pointCrossRectangle(e,t,s,c,(p=i[r])[0]))return p[1];for(var p,r=0;r<l.length;r++)if(pointCrossPolygon(e,t,n,a,(p=l[r])[0]))return p[1];return!1}function inTeleport(e,t){var n=getCurrentLMap(collisionLap);if(!n.teleports)return!1;for(var a=n.teleports.rectangle,o=0;o<a.length;o++)if(pointInRectangle(e,t,(i=a[o])[0]))return i[1];for(var i,r=n.teleports.polygon,o=0;o<r.length;o++)if(pointInPolygon(e,t,(i=r[o])[0]))return i[1]}function getActualGameTimeMS(){return null!=timerMS?timerMS:(timer-1)*SPF}function getActualGameTime(){return getActualGameTimeMS()/1e3}var lambdaReturnsTrue=function(e){return!0};function addChallengeHud(e,t){var n;clHud[e]||((n=document.createElement("div")).innerHTML="<span>"+t.title+":</span> <span>"+t.value+"</span>"+(null!=t.out_of?"/<span>"+t.out_of+"</span>":""),t=n.getElementsByTagName("span"),oChallengeCpts.appendChild(n),clHud[e]={$cpt:n,$label:t[0],$value:t[1],$outOf:t[2]})}function updateChallengeHud(e,t){clHud[e]&&(clHud[e].$value.innerText=t)}var challengeRules={finish_circuit:{verify:"end_game",is_tt_compatible:!0,reset_on_fail:!0,success:lambdaReturnsTrue},finish_circuit_first:{verify:"end_game",is_tt_compatible:!0,reset_on_fail:!0,success:function(e){return"CM"!=course&&1==oPlayers[0].place}},finish_circuit_time:{verify:"end_game",is_tt_compatible:!0,reset_on_fail:!0,success:function(e){return getActualGameTime()<=e.value}},finish_arena:{verify:"end_game",reset_on_fail:!0,success:lambdaReturnsTrue},finish_arena_first:{verify:"end_game",reset_on_fail:!0,success:function(e){return 1==oPlayers[0].place}},hit:{verify:"each_hit",initLocalVars:function(e){clLocalVars.myItems=[],clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("hits",{title:toLanguage("Hits","Touch√©s"),value:clLocalVars.nbHits,out_of:e.value})},success:function(e){if(clLocalVars.nbHits>=e.value)return!0}},eliminate:{verify:"each_kill",initLocalVars:function(e){clLocalVars.myItems=[],clLocalVars.killed=[],clLocalVars.nbKills=0,clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("kills",{title:toLanguage("Defeated","Elimin√©s"),value:clLocalVars.nbKills,out_of:e.value})},success:function(e){if(clLocalVars.nbKills>=e.value)return!0}},survive:{verify:"each_frame",success:function(e){if(getActualGameTime()>=e.value)return!0}},reach_zone:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value))},success:function(e){for(var e=e.zones,t=oPlayers[0].x,n=oPlayers[0].y,a=e.rectangle,o=0;o<a.length;o++)if(pointInRectangle(t,n,a[o]))return!0;for(var i=e.polygon,o=0;o<i.length;o++)if(pointInPolygon(t,n,i[o]))return!0}},reach_zones:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value)),clLocalVars.reached=[],clLocalVars.reached.length=e.value.length;for(var t=0;t<clLocalVars.reached.length;t++)clLocalVars.reached[t]=!1;clLocalVars.nbPass=0},initSelected:function(e){addChallengeHud("zones",{title:toLanguage("Zones","Zones"),value:clLocalVars.nbPass,out_of:e.value.length})},success:function(e,t,n){for(var a=e.zones,o=e.value,i=oPlayers[0].x,r=oPlayers[0].y,l=a.rectangle,s=[],c=0;c<l.length;c++)pointInRectangle(i,r,l[c])&&s.push(o.indexOf(l[c]));for(var p=a.polygon,c=0;c<p.length;c++)pointInPolygon(i,r,p[c])&&s.push(o.indexOf(p[c]));s.sort();for(c=0;c<s.length;c++){var u=s[c];if(!clLocalVars.reached[u]){if(e.ordered&&u&&!clLocalVars.reached[u-1])break;if(clLocalVars.reached[u]=!0,clLocalVars.nbPass++,iSfx&&n===clSelected&&playSoundEffect("musics/events/clpass.mp3"),updateChallengeHud("zones",clLocalVars.nbPass),clLocalVars.nbPass>=o.length)return!0}}}},hit_items:{verify:"each_item",initLocalVars:function(e){clLocalVars.nbItems=0,clLocalVars.itemsHit={},clLocalVars.totalItems=countInLMap(function(e){return e.arme&&e.arme.length}),setTimeout(function(){for(var e=0,t=[],n=0;n<lMaps.length;n++){var a=pMaps[n];a.arme?((t=[]).length=a.arme.length,clLocalVars.itemsHit[n]=t,e+=a.arme.length):clLocalVars.itemsHit[n]=t}clLocalVars.totalItems=e})},initSelected:function(e){setTimeout(function(){addChallengeHud("items",{title:toLanguage("Items","Objets"),value:clLocalVars.nbItems,out_of:clLocalVars.totalItems})})},success:function(e){if(clLocalVars.nbItems>=clLocalVars.totalItems)return!0}},collect_coins:{verify:"each_coin",initLocalVars:function(e){clLocalVars.nbCoins=0,e.nb||(e.nb=e.value.length)},initSelected:function(e){if(!oMap.coins){for(var t=[],n=0;n<e.value.length;n++){for(var a=e.value[n],o={x:a[0],y:a[1],theta:2*Math.PI*Math.random(),sprite:new Sprite("coin")},i=0;i<oPlayers.length;i++)o.sprite[i].img.style.width="100%",o.sprite[i].w=24,o.sprite[i].h=24;t.push(o)}foreachLMap(function(e){e.coins=t})}addChallengeHud("coins",{title:toLanguage("Coins","Pi√®ces"),value:clLocalVars.nbCoins,out_of:e.nb})},success:function(e){if(clLocalVars.nbCoins>=e.nb)return!0}},destroy_decors:{verify:"each_decor_hit",initLocalVars:function(t){clLocalVars.nbDecorHits||(clLocalVars.nbDecorHits={}),clLocalVars.nbDecorHits[t.value]=0,t.nb||(t.nb=countInLMap(function(e){return e.decor&&e.decor[t.value]&&e.decor[t.value].length}),t.shouldInitToAll=!0),t.shouldInitToAll&&setTimeout(function(){t.nb=countInLMap(function(e){return e.decor&&e.decor[t.value]&&e.decor[t.value].length})})},initSelected:function(e){setTimeout(function(){addChallengeHud("decors",{title:toLanguage("Destroyed","D√©truit"),value:0,out_of:e.nb})})},success:function(e){if(clLocalVars.nbDecorHits[e.value]>=e.nb)return!0}},gold_cup:{verify:"end_gp",initRuleVars:function(){return{nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},next_circuit:function(e){e.nbcircuits++}},gold_cups:{verify:"end_gp",initRuleVars:function(e){return{challenge:e,nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},post_success:function(e,t){var n=(n=getSessionStorage("cl"+t.challenge.id+".gold_cups"))||"{}";if(n=JSON.parse(n),t.challenge.data.constraints.every(e=>"cc"===e.type))for(var a=0;a<ptsGP.length;a++)3==ptsGP.charAt(a)&&(n[cupIDs[a]]=!0);for(var o=n[cupIDs[oMap.ref/4-1]]=!0,a=0;a<cupIDs.length;a++)if(!n[cupIDs[a]]){o=!1;break}return o?(deleteSessionStorage("cl"+t.challenge.id+".gold_cups"),!0):(setSessionStorage("cl"+t.challenge.id+".gold_cups",JSON.stringify(n)),showChallengePartialSuccess(t.challenge,{nb:Object.keys(n).length,total:cupIDs.length}),!1)},next_circuit:function(e){e.nbcircuits++}},gold_cups_n:{verify:"end_gp",initRuleVars:function(e){return{challenge:e,nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},post_success:function(e,t){var n=(n=getSessionStorage("cl"+t.challenge.id+".gold_cups"))||"{}";if(n=JSON.parse(n),t.challenge.data.constraints.every(e=>"cc"===e.type))for(var a=0;a<ptsGP.length;a++)3==ptsGP.charAt(a)&&(n[cupIDs[a]]=!0);n[cupIDs[oMap.ref/4-1]]=!0;for(var o=0,a=0;a<cupIDs.length;a++)n[cupIDs[a]]&&o++;return o>=e.value?(deleteSessionStorage("cl"+t.challenge.id+".gold_cups"),!0):(setSessionStorage("cl"+t.challenge.id+".gold_cups",JSON.stringify(n)),showChallengePartialSuccess(t.challenge,{nb:Object.keys(n).length,total:e.value}),!1)},next_circuit:function(e){e.nbcircuits++}},finish_circuits_first:{verify:"end_game",initRuleVars:function(){return{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:"BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){return 1==oPlayers[0].place&&(t.nbcircuits>=e.value||void 0)},next_circuit:function(e){e.nbcircuits++}},pts_greater:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1,initialscore:0}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:"BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]>=e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},pts_equals:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:"BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]==e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},game_mode:{success:function(e){return course==["VS","CM"][e.value]}},game_mode_cup:{success:function(e){return course==["GP","VS"][e.value]}},difficulty:{success:function(e){return iDificulty==4+.5*(2-e.value)}},no_teams:{success:function(e){return!iTeamPlay}},participants:{success:function(e){return aKarts.length==e.value}},cc:{initRuleVars:function(e,t){return{relSpeed:getRelSpeedFromCc(+t.value)}},success:function(e,t){if(t)return t.relSpeed===fSelectedClass&&(null===e.mirror||!e.mirror==!bSelectedMirror)}},balloons:{success:function(e){return(!oPlayers[0].lost||clLocalVars.gagnant==oPlayers[0])&&oPlayers[0].ballons.length+oPlayers[0].reserve>=e.value}},balloons_lost:{initSelected:function(e,t){addChallengeHud("balloons",{title:toLanguage("Balloons","Ballons"),value:clLocalVars.lostBalloons,out_of:e.value})},success:function(e){return(!oPlayers[0].loose||clLocalVars.gagnant==oPlayers[0])&&clLocalVars.lostBalloons<=e.value}},balloons_inflate:{initSelected:function(e,t){addChallengeHud("inflated",{title:toLanguage("Inflated","Gonfl√©s"),value:clLocalVars.inflatedBalloons,out_of:e.value})},success:function(e){return clLocalVars.inflatedBalloons<=e.value}},balloons_player:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0,oPlayers[0].reserve=e.value-oPlayers[0].ballons.length,updateBalloonHud(document.getElementById("compteur0"),oPlayers[0])},success:function(e,t){return!!t.selected}},balloons_cpu:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n=oPlayers.length;n<aKarts.length;n++){var a=aKarts[n];a.reserve=e.value-a.ballons.length}},success:function(e,t){return!!t.selected}},no_drift:{success:function(e){return!clLocalVars.drifted}},no_rd:{success:function(e){return!clLocalVars.revDrifted}},avoid_items:{success:function(e){return!clLocalVars.itemsGot}},avoid_item:{initLocalVars:function(e){clLocalVars.hitItems||(clLocalVars.hitItems={})},success:function(e){for(var t=0;t<e.value.length;t++){var n=e.value[t];if(clLocalVars.hitItems[n])return!1}return!0}},no_item:{success:function(e){return!clLocalVars.itemsUsed}},no_item_box:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0,foreachLMap(function(e){e.arme=[]})},success:function(e,t){return!!t.selected}},avoid_decors:{initLocalVars:function(e){clLocalVars.decorsHit||(clLocalVars.decorsHit={})},success:function(e){for(var t in e.value)if(clLocalVars.decorsHit[t])return!1;return!0}},avoid_zones:{initRuleVars:function(){return{hit:!1}},initLocalVars:function(e,t){clLocalVars.zonesHit||(clLocalVars.zonesHit=[]),clLocalVars.zonesHit.push({ruleVars:t,floor:e.floor,zones:classifyByShape(e.value)})},success:function(e,t){return!t.hit}},avoid_walls:{success:function(e){return!clLocalVars.touchedWalls}},init_item:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0,e.value?(oPlayers[0].arme=e.value,oPlayers[0].roulette=25,updateObjHud(0)):supprArme(0)},success:function(e,t){return!!t.selected}},item_distribution:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n={},a=0;a<e.value.length;a++)n[e.value[a]]=1;itemDistribution.value=[n],itemDistribution.isSetup=!0},success:function(e,t){return!!t.selected}},custom_music:{preinitSelected:function(e){foreachLMap(function(e,t){delete e.music,delete e.yt,delete e.yt_opts,delete t.music,delete t.yt,delete t.yt_opts}),oMap.music=e.value,oMap.yt=e.yt},success:function(){return!0}},character:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0},success:function(e,t,n){var a=oPlayers[0].personnage;return e.custom_id?t.selected&&n.autoset&&a===n.autoset.selectedPerso:a==e.value}},falls:{initRuleVars:function(){return{falls:0}},initSelected:function(e,t){t&&addChallengeHud("falls",{title:toLanguage("Falls","Chutes"),value:clLocalVars.falls+t.falls,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.falls+t.falls<=e.value},next_circuit:function(e){e&&(e.falls+=clLocalVars.falls)}},max_jumps:{initRuleVars:function(){return{jumps:0}},initSelected:function(e,t){t&&addChallengeHud("jumps",{title:toLanguage("Jumps","Sauts"),value:clLocalVars.jumps+t.jumps,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.jumps+t.jumps<=e.value},next_circuit:function(e){e&&(e.jumps+=clLocalVars.jumps)}},max_cannons:{initRuleVars:function(){return{cannons:0}},initSelected:function(e,t){t&&addChallengeHud("cannons",{title:toLanguage("Cannons","Canons"),value:clLocalVars.cannons+t.cannons,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.cannons+t.cannons<=e.value},next_circuit:function(e){e&&(e.cannons+=clLocalVars.cannons)}},no_stunt:{success:function(e){return!clLocalVars.stunted}},backwards:{initSelected:function(e){clLocalVars.backwardsStart=!0},success:function(e){return!clLocalVars.forwards}},without_turning:{success:function(e){return("right"===e.value||!clLocalVars.leftTurn)&&("left"===e.value||!clLocalVars.rightTurn)}},forwards:{success:function(e){return!clLocalVars.backwards}},auto_accelerate:{initSelected:function(e){clLocalVars.autoAccelerate=!0},success:function(e){return!!clLocalVars.autoAccelerate}},invert_dirs:{initSelected:function(e){clLocalVars.invertDirs=!0},success:function(e){return!!clLocalVars.invertDirs}},rear_view:{initSelected:function(e){clLocalVars.rearView=!0},success:function(e){return!!clLocalVars.rearView}},no_minimap:{initSelected:function(e){clLocalVars.noMap=!0},success:function(e){return!!clLocalVars.noMap}},time:{success:function(e){return getActualGameTime()<=e.value}},time_delay:{initSelected:function(e){clLocalVars.delayedStart=e.value},success:function(e){return!clLocalVars.startedAt||(clLocalVars.startedAt-1)*SPF/1e3>=e.value}},start_pos:{initSelected:function(e){if(clLocalVars.startPos=e.value,clLocalVars.isSetup=!0,e.no_cpu){aKarts.length=strPlayer.length;for(var t=0;t<strPlayer.length;t++)document.getElementById("infoPlace"+t).style.display="none"}},success:function(e){return!!clLocalVars.startPos}},with_opponents:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0},success:function(e,t){return!!t.selected}},extra_items:{initRuleVars:function(){return{}},initSelected:function(r,e){e.selected=!0,clLocalVars.isSetup=!0,foreachLMap(function(e,t){if(t.arme){if(r.clear_other){if(e!==oMap)return delete t.arme,void(e.arme=oMap.arme);for(var n=0;n<e.arme.length;n++)for(var a=e.arme[n][2].box,o=0;o<a.length;o++)a[o][0].suppr();e.arme.length=0}for(n=0;n<r.value.length;n++){var i=r.value[n].slice(0);initItemSprite(i),e.arme.push(i)}}})},success:function(e,t){return!!t.selected}},extra_decors:{initRuleVars:function(){return{}},initSelected:function(c,e){e.selected=!0,clLocalVars.isSetup=!0;var p=c.custom_decors||{};foreachLMap(function(t,e){if(e.decor)for(var n=0;n<c.value.length;n++){var a=c.value[n],o=a.src,i=o,r=p[i];if(r&&(i=r.type,t.decorparams||(t.decorparams={},foreachDMap(t,e,function(e){e.decorparams=t.decorparams})),t.decorparams.extra||(t.decorparams.extra={}),t.decorparams.extra[o]||(t.decorparams.extra[o]={}),t.decorparams.extra[o].custom||(t.decorparams.extra[o].custom=r)),i.startsWith("assets/")){switch(i){case"assets/pivothand":l=["hand",[a.pos[0],a.pos[1],47,8,.5,.5],[0,.5,0,-.038]],s="pointers";break;case"assets/flipper":l=["flipper",[a.pos[0],a.pos[1],40,15,1,.15],[.1875,.5,.59,0,-1.19]],s="flippers";break;case"assets/oil1":case"assets/oil2":var l=[i.substring(7),[a.pos[0],a.pos[1],7,7,.5,.5],[.5,.5,0]],s="oils";break;case"assets/bumper":l=[i.substring(7),[a.pos[0],a.pos[1],24,24],[.5,.5,0]],s="bumpers"}l&&(e[s]||(t[s]=[],foreachDMap(t,e,function(e){e[s]=t[s]})),r&&(l[0]=o),t[s].push(l))}else t.decor[o]||(t.decor[o]=[]),t.decor[o].push(a.pos.slice(0))}})},success:function(e,t){return!!t.selected}},extra_walls:{initRuleVars:function(){return{}},preinitSelected:function(o,e){foreachLMap(function(e){e.collision||(e.collision=[]),e.collisionProps||(e.collisionProps={});for(var t=o.height||1e3,n=0;n<o.value.length;n++){var a=o.value[n];e.collisionProps[e.collision.length]={z:t},e.collision.push(a.slice(0))}})},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0},success:function(e,t){return!!t.selected}},place_items:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n=0;n<e.value.length;n++){var a=e.value[n];dropNewItem(null,{type:a.src,team:-1,x:a.pos[0],y:a.pos[1],z:0})}},success:function(e,t){return!!t.selected}},mini_turbo:{initRuleVars:function(){return{miniTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("miniTurbo",{title:"Mini Turbos",value:clLocalVars.miniTurbo+t.miniTurbo,out_of:e.value})},success:function(e,t){if(t&&t.miniTurbo+clLocalVars.miniTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.miniTurbo+=clLocalVars.miniTurbo)}},super_turbo:{initRuleVars:function(){return{superTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("superTurbo",{title:"Super Turbos",value:clLocalVars.superTurbo+t.superTurbo,out_of:e.value})},success:function(e,t){if(t&&t.superTurbo+clLocalVars.superTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.superTurbo+=clLocalVars.superTurbo)}},stunts:{initRuleVars:function(){return{stunts:0}},initSelected:function(e,t){t&&addChallengeHud("stunts",{title:toLanguage("Tricks","Figures"),value:clLocalVars.stunts+t.stunts,out_of:e.value})},success:function(e,t){if(t&&t.stunts+clLocalVars.stunts>=e.value)return!0},next_circuit:function(e){e&&(e.stunts+=clLocalVars.stunts)}},position:{success:function(e){if(oPlayers[0].place==e.value)return!0}},position_lower:{success:function(e){if(oPlayers[0].place<=e.value)return!0}},with_pts:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{firstAttempt:!0}},success:function(e,t){if(t.firstAttempt&&aScores[0]>=e.value)return!0}},different_circuits:{initRuleVars:function(){return{played_circuits:{}}},success:function(e,t){return!t.played_circuits[oMap.ref]},next_circuit:function(e){e.played_circuits[oMap.ref]=!0}}};function addCreationChallenges(e,t){t=challenges[e][t];if(t)for(var n=t.list,a=0;a<n.length;a++){var o=n[a];if(!o.succeeded||o===clSelected){var i=o.data,r=challengeRules[i.goal.type].verify;challengesForCircuit[r].push(o);for(var l,s=listChallengeRules(i),c=!1,p=0;p<s.length;p++)"cc"===(l=s[p]).type&&(c=!0),initChallengeRule(o,l);c||(l={type:"cc",value:150,mirror:null},i.constraints.push(l),initChallengeRule(o,l))}}}function listChallengeRules(e){var t=e.constraints.slice(0);return t.unshift(e.goal),t}function initChallengeRule(e,t){challengeRules[t.type].initRuleVars&&(clRuleVars[e.id]||(clRuleVars[e.id]={}),clRuleVars[e.id][t.type]||(clRuleVars[e.id][t.type]=challengeRules[t.type].initRuleVars(e,t)))}function reinitChallengeVars(){for(var e in challengesForCircuit)for(var t=challengesForCircuit[e],n=0;n<t.length;n++)for(var a=t[n],o=listChallengeRules(a.data),i=0;i<o.length;i++)initChallengeRule(a,o[i]);reinitLocalVars()}function countInLMap(n){let a=0;return foreachLMap(function(e,t){t=n(t);t&&(a+=t)}),a}function foreachDMap(e,t,n){n(t);for(var a=lMaps.indexOf(e)+1;a<lMaps.length;a++){var o=lMaps[a];if(o!==e){var i=pMaps[a];if(i.decor)break;n(o,i)}}}function isSameDistrib(e,t){if(e.length===t.length){for(var n=0;n<e.length;n++){var a,o=e[n],i=t[n];for(a in o)if(o[a]!==i[a])return;for(a in i)if(o[a]!==i[a])return}return 1}}function reinitLocalVars(){if(clLocalVars={drifted:!1,revDrifted:!1,stunted:!1,itemsGot:!1,itemsUsed:!1,falls:0,jumps:0,cannons:0,miniTurbo:0,superTurbo:0,stunts:0,lostBalloons:0,inflatedBalloons:0,cheated:!1},ptsDistribution.value)clLocalVars.cheated=!0;else if(itemDistribution.value&&!itemDistribution.isSetup){for(var e=itemDistributions[getItemMode()],t=!1,n=0;n<2;n++)if(isSameDistrib(itemDistribution.value,e[n].value)){t=!0;break}t||(clLocalVars.cheated=!0)}for(var a in clHud={},challengesForCircuit)for(var o=challengesForCircuit[a],n=0;n<o.length;n++)for(var i=o[n],r=listChallengeRules(i.data),l=0;l<r.length;l++){var s=r[l],c=clRuleVars[i.id]?clRuleVars[i.id][s.type]:void 0;challengeRules[s.type].initLocalVars&&challengeRules[s.type].initLocalVars(s,c),clSelected===i&&challengeRules[s.type].initSelected&&challengeRules[s.type].initSelected(s,c)}}function challengeCheck(e,t){if(!(clLocalVars.cheated||1<strPlayer.length))for(var n=challengesForCircuit[e],a=0;a<n.length;a++){var o=n[a];if(!clLocalVars.isSetup||o===clSelected){var i=listChallengeRules(o.data),r=challengeRulesSatisfied(o,i);if(r){var l=o.data.goal,s=challengeRules[l.type].post_success;if(s)if(!s(l,clRuleVars[o.id]?clRuleVars[o.id][l.type]:void 0,o))return}!0===r?(challengeSucceeded(o),n.splice(a,1),a--):!1===r||challengeRules[i[0].type].reset_on_fail?(delete clRuleVars[o.id],n.splice(a,1),a--):challengeHandleEvents(o,t)}}}function challengeHandleEvents(e,t){if(t){var n=clRuleVars[e.id];if(n)for(var a=listChallengeRules(e.data),o=0;o<t.length;o++)for(var i=t[o],r=0;r<a.length;r++){var l=a[r];challengeRules[l.type][i]&&challengeRules[l.type][i](n[l.type])}}}challengeRules.different_arenas=challengeRules.different_circuits;var clSelectionFail=!1;function challengeHandleFail(){clSelectionFail||(clSelectionFail=!0,clHud={},oChallengeCpts.innerHTML="",1<timer&&showClFailedPopup())}function challengeRulesSatisfied(e,t){for(var n=!0,a=0;a<t.length;a++){var o=challengeRuleSatisfied(e,t[a]);if(!1===o)return!1;!0!==o&&(n=!1)}return!!n||null}function challengeRuleSatisfied(e,t){var n=clRuleVars[e.id]?clRuleVars[e.id][t.type]:void 0;return challengeRules[t.type].success(t,n,e)}function challengeSucceeded(i){var e,t;i.succeeded&&i!==clSelected||(e=i.succeeded,i.succeeded=!0,clSelected==i&&(clSelected=void 0,clHud={}),"pending_completion"===i.status&&(i.status="pending_publication"),delete clRuleVars[i.id],e?setTimeout(function(){showChallengePopup(i,{})},1):(t="id="+i.id,xhr("trackStats.php","stats="+encodeURIComponent(getRecordStats(t)),function(e){return 1==e&&(xhr("challengeSucceeded.php",t,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}if(showChallengePopup(i,t),t.rewards)for(var n=0;n<t.rewards.length;n++)for(var a=t.rewards[n].id,o=0;o<clRewards.length;o++)if(clRewards[o].id==a){clRewards[o].unlocked=1;break}return!0}),!0)})))}function showChallengePartialSuccess(e,t){var n,a,o,i,r;document.getElementById("challenge-popup-"+e.id)||((n=document.createElement("div")).id="challenge-popup-"+e.id,n.className="challenge-popup challenge-popup-partial",n.style.width=56*iScreenScale+"px",n.style.left=12*iScreenScale+"px",n.style.top=Math.round(4.5*iScreenScale)+"px",n.style.padding=Math.round(1.5*iScreenScale)+"px",n.style.paddingBottom=5*iScreenScale+"px",n.style.border="inset "+Math.round(.5*iScreenScale)+"px #07B",n.style.fontSize=2*iScreenScale+"px",n.style.opacity=0,a=language?"Challenge being completed":"D√©fi en cours de r√©ussite",o=e.description.main,i=language?"Cups completed: "+t.nb+"/"+t.total:"Coupes r√©ussies: "+t.nb+"/"+t.total,t=language?"Close":"Fermer",n.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup2.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+a+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+o+'</div><div class="challenge-popup-award" style="margin:'+iScreenScale+'px 0">'+i+'</div><div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup('+e.id+');">'+t+"</a></div>",(t=document.getElementsByClassName("challenge-popup")).length?$mkScreen.insertBefore(n,t[0]):$mkScreen.appendChild(n),r=0,function e(){r<1?(n.style.opacity=r,r+=.2,setTimeout(e,40)):n.style.opacity=1}(),focusOnChallengeClose())}function showChallengePopup(t,n){if(!document.getElementById("challenge-popup-"+t.id)){var e=n.pts,a=document.createElement("div");a.id="challenge-popup-"+t.id,a.className="challenge-popup",a.style.width=56*iScreenScale+"px",a.style.left=12*iScreenScale+"px",a.style.top=Math.round(4.5*iScreenScale)+"px",a.style.padding=Math.round(1.5*iScreenScale)+"px",a.style.paddingBottom=5*iScreenScale+"px",a.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",a.style.fontSize=2*iScreenScale+"px",a.style.opacity=0;var o=language?"Challenge completed!":"D√©fi r√©ussi !",i=t.description.main,r=(language?"You receive a reward of <strong>"+e+" pt"+(2<=e?"s":"")+"</strong>.":"Vous recevez <strong>"+e+" pt"+(2<=e?"s":"")+"</strong> en r√©compense.")+"<br />",l="";n.pts_advent&&(s=(c=n.pts_advent)+"",n.pts_advent_extra&&(s+="+"+n.pts_advent_extra,c+=n.pts_advent_extra),l='<div class="challenge-popup-award-advent">üéÅ '+(language?"Advent calendar: you receive a bonus reward of <strong>"+s+" pt"+(2<=c?"s":"")+"</strong>!!":"Calendrier de l'avent : vous recevez un bonus de <strong>"+s+" pt"+(2<=c?"s":"")+"</strong> !!")+"</div>",e||(e=!0,r=""));var s=language?"Your challenge points go from <strong>"+n.pts_before+"</strong> to <strong>"+n.pts_after+"</strong>!":"Vos points d√©fis passent de <strong>"+n.pts_before+"</strong> √† <strong>"+n.pts_after+"</strong> !",c=language?"Close":"Fermer";if(a.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup1.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+o+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+i+"</div>"+(e?'<div class="challenge-popup-award" style="margin:'+iScreenScale+'px 0">'+r+l+s+"</div>":"")+(0<=n.rating?'<div class="challenge-rating" style="margin-left:'+Math.round(3.5*iScreenScale)+"px;font-size:"+Math.round(2.5*iScreenScale)+'px">'+toLanguage("Rate this challenge:","Notez ce d√©fi :")+'<div class="challenge-rating-stars"></div><div class="challenge-rated">'+toLanguage("Thanks","Merci")+"</div></div>":"")+(n.publish?'<div class="challenge-publish" style="margin:'+iScreenScale+'px 0">'+toLanguage("You can now","Vous pouvez maintenant")+' <a href="javascript:publishChallenge('+t.id+')">'+toLanguage("publish challenge","publier le d√©fi")+"</a>.</div>":"")+'<div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup('+t.id+');">'+c+"</a></div>",0<=n.rating){var p=a.getElementsByClassName("challenge-rating-stars");(p=p[0]).style.position="relative",p.style.marginLeft=Math.round(.4*iScreenScale)+"px",p.style.marginRight=Math.round(.4*iScreenScale)+"px",p.style.top=Math.round(.4*iScreenScale)+"px";function u(){for(var e=+this.rating,t=0;t<e;t++)g[t].src="images/star1.png";for(t=e;t<5;t++)g[t].src="images/star0.png"}function d(){for(var e=0;e<n.rating;e++)g[e].src="images/star1.png";for(e=n.rating;e<5;e++)g[e].src="images/star0.png"}function m(){var e=+this.rating;n.rating=n.rating==e?0:e,d(),h.style.visibility="hidden",xhr("challengeRate.php","challenge="+t.id+"&rating="+n.rating,function(e){return 1==e&&(h.style.visibility="visible",!0)})}for(var h=(h=a.getElementsByClassName("challenge-rated"))[0],g=[],y=0;y<5;y++){var f=document.createElement("img");f.alt="S",f.src="images/star0.png",f.style.width=3*iScreenScale+"px",f.style.marginLeft=Math.round(.4*iScreenScale)+"px",f.style.marginRight=Math.round(.4*iScreenScale)+"px",f.rating=y+1,f.onmouseover=u,f.onmouseout=d,f.onclick=m,g[y]=f,p.appendChild(f)}d()}c=document.getElementsByClassName("challenge-popup");c.length?$mkScreen.insertBefore(a,c[0]):$mkScreen.appendChild(a);var S=0;if(!function e(){S<1?(a.style.opacity=S,S+=.2,setTimeout(e,40)):a.style.opacity=1}(),!pause&&document.onkeydown&&(clLocalVars.forcePause=!0,doPressKey("pause"),delete clLocalVars.forcePause),(bMusic||iSfx)&&(challengeMusic||((challengeMusic=playSoundEffect("musics/events/challenge.mp3")).className="",endGPMusic?(pauseMusic(endGPMusic),challengeMusic.onended=function(){unpauseMusic(endGPMusic),challengeMusic=null}):willPlayEndMusic?(willPlayEndMusic=!1,challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):isEndMusicPlayed?(pauseMusic(endingMusic),challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):challengeMusic.onended=function(){challengeMusic=null})),n.unlocked)for(y=0;y<n.unlocked.length;y++)showChallengeRewardPopup(n.unlocked[y]);focusOnChallengeClose()}}function showChallengeRewardPopup(e){var t,n,a,o,i,r;document.getElementById("challenge-popup-reward-"+e.id)||((t=document.createElement("div")).id="challenge-popup-reward-"+e.id,t.className="challenge-popup",t.style.width=56*iScreenScale+"px",t.style.left=12*iScreenScale+"px",t.style.top=Math.round(4.5*iScreenScale)+"px",t.style.padding=Math.round(1.5*iScreenScale)+"px",t.style.paddingBottom=5*iScreenScale+"px",t.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",t.style.fontSize=2*iScreenScale+"px",t.style.opacity=0,n=language?"New character unlocked!":"Nouveau perso d√©bloqu√© !",a=language?"You can now play with <strong>"+e.name+"</strong>!":"Vous pouvez d√©sormais jouer avec <strong>"+e.name+"</strong> !",(i=document.createElement("img")).src=getSpriteSrc(e.sprites),i.alt=e.name,i.className="pixelated",i.style.visibility="hidden",o=language?"Close":"Fermer",t.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup1.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+n+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+a+'</div><div class="challenge-popup-reward-ch"></div><div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup(&quot;reward-'+e.id+'&quot;);">'+o+"</a></div>",t.getElementsByClassName("challenge-popup-reward-ch")[0].appendChild(i),i.onload=function(){var e=this.parentNode,t=iScreenScale/8,n=Math.round(t*this.naturalWidth/24),t=Math.round(t*this.naturalHeight);e.style.width=n+"px",e.style.height=t+"px",this.style.width=24*n+"px",this.style.height=t+"px",this.style.visibility=""},(i=document.getElementsByClassName("challenge-popup")).length?$mkScreen.insertBefore(t,i[0]):$mkScreen.appendChild(t),r=0,function e(){r<1?(t.style.opacity=r,r+=.2,setTimeout(e,40)):t.style.opacity=1}())}function focusOnChallengeClose(){var e=document.querySelectorAll(".challenge-popup .challenge-popup-close a");e.length?e[e.length-1].focus():(e=document.getElementById("reprendre"))?e.focus():(e=document.getElementById("octn"))&&e.focus()}function showClSelectedPopup(){var t=document.createElement("div");t.style.fontSize=2*iScreenScale+"px",t.className="clselected-popup",t.style.left=27*iScreenScale+"px",t.style.top=iHeight*iScreenScale+"px",t.innerHTML='<div class="clselected-close"><a href="#null">&times;</a></div><div class="clselected-ctn"><div>‚úî</div><div><strong>'+toLanguage("Challenge selected :","D√©fi s√©lectionn√©:")+"</strong> "+(clSelected.name||clSelected.description.main)+"</div></div>",t.querySelector(".clselected-close a").onclick=function(){return document.body.removeChild(t),!1},document.body.appendChild(t);var n=1;setTimeout(function e(){0<n?(t.style.opacity=n,n-=.04,setTimeout(e,40)):document.body.removeChild(t)},1500)}function showClFailedPopup(){var e=document.createElement("div");e.style.position="absolute",e.style.color="#C00",e.style.right=Math.round(iScreenScale/2)+"px",e.style.top=Math.round(iScreenScale*($speedometers.length?4.8:2.5))+"px",e.style.fontSize=Math.round(1.8*iScreenScale)+"px",e.style.display="flex",e.style.alignItems="center",e.style.fontFamily="Courier New",e.innerHTML='<strong style="color:#800;font-size:1.8em">&times;</strong>&nbsp;'+(language?"Challenge failed...":"D√©fi √©chou√©..."),oChallengeCpts.parentNode.appendChild(e),!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/clfail.mp3")}function getSessionStorage(e){return sessionStorage.getItem(e)}function setSessionStorage(t,n){sessionStorage.setItem(t,n),addUpdatingKey(t),xhr("sessionStorage.php","key="+encodeURIComponent(t)+"&value="+encodeURIComponent(n),function(e){return 1==e&&(deleteUpdatingKey(t,n),!0)})}function deleteSessionStorage(t){sessionStorage.removeItem(t),addUpdatingKey(t),xhr("sessionStorage.php","key="+encodeURIComponent(t)+"&delete",function(e){return 1==e&&(deleteUpdatingKey(t,null),!0)})}function initSessionStorage(){var e=sessionStorage.getItem("updatingKeys");if(e)for(var t in JSON.parse(e)){var n=sessionStorage.getItem(t);let e;e=null!=n?"key="+encodeURIComponent(t)+"&value="+encodeURIComponent(n):"key="+encodeURIComponent(t)+"&delete",xhr("sessionStorage.php",e,function(e){return 1==e&&(deleteUpdatingKey(t,n),!0)})}else xhr("sessionStorage.php","",function(e){var t;try{t=JSON.parse(e)}catch(e){return!1}if(!t)return!1;var n,a=sessionStorage.getItem("updatingKeys");for(n in a||(sessionStorage.setItem("updatingKeys","{}"),a={}),t)a[n]||sessionStorage.setItem(n,t[n]);return!0})}function addUpdatingKey(e){var t=JSON.parse(sessionStorage.getItem("updatingKeys"))||{};t[e]=1,sessionStorage.setItem("updatingKeys",JSON.stringify(t))}function deleteUpdatingKey(e,t){var n=JSON.parse(sessionStorage.getItem("updatingKeys"))||{};sessionStorage.getItem(e)===t?delete n[e]:n[e]=1,sessionStorage.setItem("updatingKeys",JSON.stringify(n))}function showGamePopup(t){var e=document.createElement("form");e.className="game-popup",e.style.fontSize=4*iScreenScale+"px",e.onsubmit=function(e){e.preventDefault(),t.submit(e),s()};var n=document.createElement("div");t.title&&((l=document.createElement("h1")).innerHTML=t.title,n.appendChild(l));var a=document.createElement("div");a.className="game-popup-body";for(var o=0;o<t.elements.length;o++){var i=document.createElement("div");i.innerHTML=t.elements[o],a.appendChild(i)}n.appendChild(a);var r=document.createElement("div");r.className="game-popup-submit";var l=document.createElement("input");function s(){t.container.removeChild(e),window.removeEventListener("keydown",c),t.close&&t.close()}function c(e){27===e.keyCode&&s()}return l.type="submit",l.style.fontSize=4*iScreenScale+"px",l.value=t.submitVal,r.appendChild(l),n.appendChild(r),e.appendChild(n),t.container.appendChild(e),window.addEventListener("keydown",c),e.onclick=function(e){e.target===e.currentTarget&&s()},e}window.closeChallengePopup=function(e){var t,n=document.getElementById("challenge-popup-"+e);n&&(clHud&&0===Object.keys(clHud).length&&oChallengeCpts.firstChild&&(oChallengeCpts.innerHTML=""),t=1,function e(){0<t?(n.style.opacity=t,t-=.2,setTimeout(e,40)):($mkScreen.removeChild(n),focusOnChallengeClose())}())},window.publishChallenge=function(e){for(var t in challenges)for(var n in challenges[t])for(var a=challenges[t][n],o=a.list,i=0;i<o.length;i++)o[i].id==e&&(a.main?openChallengeEditor():document.location.href="challenges.php?cl="+a.id)};var metaItemPosition=.5,metaItemRange=1e3,itemDistributions={BB:[{name:toLanguage("Standard","Classique"),value:[{fauxobjet:4,banane:5,carapacerouge:1,carapace:4},{carapace:4,carapacerouge:7,bobomb:2,bananeX3:1},{carapace:4,bobomb:2,carapaceX3:2,banane:1,fauxobjet:1,carapacerouge:4},{carapacerougeX3:1,carapacerouge:2,megachampi:3,etoile:3,champi:3,champior:1,champiX3:1,bloops:1,pow:1}]},{name:toLanguage("Explosive mode","Mode explosif"),value:[{fauxobjet:1,banane:3,carapacerouge:3,carapace:5},{bananeX3:1,carapacerouge:12,carapace:6,bobomb:4},{carapacerouge:8,carapace:5,bobomb:4,carapaceX3:3},{carapacerouge:7,carapacebleue:4,carapacerougeX3:3,megachampi:5,etoile:5,champi:1,champior:1,champiX3:1,bloops:1,pow:1}]},{name:toLanguage("Shells","Carapaces"),value:[{carapacerouge:1,carapace:4},{carapacerouge:7,carapace:4},{carapacerouge:4,carapace:4,carapaceX3:2},{carapacerouge:6,carapacebleue:1,carapacerougeX3:3}]},{name:toLanguage("Bob-ombs","Bob-ombs"),value:[{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1}]},{name:toLanguage("Mushrooms","Champis"),value:[{champi:1,poison:1},{megachampi:1,champi:3,champiX3:1},{megachampi:2,champi:2,champior:1,champiX3:2},{megachampi:1,champior:1,champiX3:1}]}],VS:[{name:toLanguage("Standard","Classique"),value:[{fauxobjet:10,banane:6,carapace:6,bananeX3:2,carapacerouge:2},{carapace:8,bananeX3:4,carapacerouge:5,champi:3},{carapaceX3:7,carapacerouge:7,poison:5,champi:5,bobomb:3,bloops:3},{champi:6,poison:4,carapaceX3:6,carapacerouge:5,bobomb:3,bloops:2},{champi:8,carapacerouge:6,bobomb:3,champiX3:2},{bobomb:4,champi:5,carapacerouge:4,champiX3:3,carapacerougeX3:3,pow:1},{champi:8,carapacerougeX3:7,champiX3:6,megachampi:3,pow:2},{champiX3:8,carapacerougeX3:8,megachampi:6,etoile:4,champior:2,carapacebleue:5,pow:3},{megachampi:7,champiX3:6,etoile:5,champior:3,carapacebleue:5,pow:2},{megachampi:8,champiX3:6,etoile:6,billball:3,champior:3,carapacebleue:5,pow:2},{etoile:6,megachampi:6,billball:5,champior:4,eclair:5},{billball:4,etoile:3,eclair:6,champior:5}]},{name:toLanguage("Aggressive mode","Mode explosif"),value:[{fauxobjet:5,banane:2,carapace:10,bananeX3:1,carapacerouge:3},{carapace:10,bananeX3:4,carapacerouge:15,carapaceX3:4,champi:1},{carapacerouge:10,carapaceX3:10,champi:2,poison:5,bobomb:10,bloops:3},{carapacerouge:10,carapaceX3:12,champi:3,poison:4,bobomb:8,bloops:2},{carapacerouge:12,champi:4,bobomb:8},{carapacerouge:8,champi:5,bobomb:6,champiX3:1,carapacerougeX3:6,pow:2},{champi:4,champiX3:3,carapacerougeX3:10,megachampi:3,pow:2},{champiX3:4,carapacerougeX3:10,megachampi:6,etoile:4,carapacebleue:12,pow:4},{champiX3:3,megachampi:7,etoile:5,champior:1,carapacebleue:10,pow:3},{champiX3:3,megachampi:8,etoile:6,champior:1,carapacebleue:10,billball:5,pow:2},{megachampi:6,etoile:6,champior:1,billball:5,eclair:8},{etoile:3,champior:2,billball:6,eclair:8}]},{name:toLanguage("Shells","Carapaces"),value:[{carapace:6},{carapace:8,carapacerouge:8},{carapace:6,carapacerouge:5},{carapace:6,carapacerouge:7},{carapace:4,carapacerouge:5},{carapace:4,carapacerouge:6,carapaceX3:2,carapacerougeX3:2},{carapace:2,carapacerouge:4,carapaceX3:2,carapacerougeX3:2,carapacebleue:4},{carapace:2,carapacerouge:2,carapaceX3:4,carapacerougeX3:4,carapacebleue:6},{carapacerouge:2,carapaceX3:4,carapacerougeX3:4,carapacebleue:6},{carapaceX3:6,carapacerougeX3:6,carapacebleue:4},{carapaceX3:6,carapacerougeX3:6},{carapaceX3:8,carapacerougeX3:8}]},{name:toLanguage("Bob-ombs","Bob-ombs"),value:[{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1}]},{name:toLanguage("Mushrooms","Champis"),value:[{champi:1},{champi:1,poison:1},{champi:4,poison:1,megachampi:1},{champi:3,poison:1,megachampi:1},{champi:3,poison:1,champiX3:1,megachampi:2},{champi:2,champiX3:1,megachampi:2},{champi:1,champiX3:2,megachampi:3},{champiX3:2,megachampi:2,champior:1},{champiX3:1,megachampi:1,champior:1},{champiX3:1,champior:1},{champiX3:1,champior:2},{champior:1}]},{name:toLanguage("None","Aucun"),value:[]}]},ptDistributions=[{name:toLanguage("Default","Par d√©faut")}],customItemDistrib=localStorage.getItem("itemsets"),customItemDistrib=customItemDistrib?JSON.parse(customItemDistrib):{VS:[],BB:[]},customPtDistrib=localStorage.getItem("ptsets");function getItemMode(){return"BB"==course?"BB":"VS"}function getPointDistribution(){if(!ptsDistribution.value)return getDefaultPointDistribution(aKarts.length);for(var e=new Array(aKarts.length),t=0;t<aKarts.length;t++)e[t]=ptsDistribution.value[t]||0;return e}function getDefaultPointDistribution(e){if(12==e)return[15,12,10,8,7,6,5,4,3,2,1,0];for(var t=Math.round(1.25*e),n=new Array(e),a=0;a<e;a++){var o=(e-a-1)/(e-1);n[a]=Math.round(t*(Math.exp(o)-1)/(Math.E-1))}return n}customPtDistrib=customPtDistrib?JSON.parse(customPtDistrib):[];var COL_KART=0,COL_OBJ=1,collisionTest,collisionPlayer,collisionTeam,collisionItem,collisionDecor,collisionDecorHit,collisionFloor,collisionLap;function isHitSound(e){return collisionTest==COL_OBJ||collisionTeam==e.team&&{x:e.x,y:e.y}}function handleHit(e){clLocalVars.currentKart&&(clLocalVars.currentKart.tourne||clLocalVars.currentKart.protect||clLocalVars.currentKart.frminv&&itemBehaviors[e.type]&&itemBehaviors[e.type].frminv||(clLocalVars.hitItems&&clLocalVars.currentKart==oPlayers[0]&&incItemHits(e.type),clLocalVars.myItems&&clLocalVars.currentKart&&clLocalVars.currentKart!=oPlayers[0]&&-1!=clLocalVars.myItems.indexOf(e)&&incChallengeHits(clLocalVars.currentKart)))}function handleHit2(e,t){t==oPlayers[0]?clLocalVars.hitItems&&(e.billball&&incItemHits("billball"),e.etoile&&incItemHits("etoile"),e.megachampi&&incItemHits("megachampi"),e.champiType===CHAMPI_TYPE_ITEM&&incItemHits("champi")):e==oPlayers[0]&&incChallengeHits(t)}function handleItemHit(e,t){e===oPlayers[0]&&clLocalVars.hitItems&&incItemHits(t)}function incItemHits(e){var t;switch(e){case"carapace-rouge":t="carapacerouge";break;case"carapace-bleue":t="carapacebleue";break;default:t=e}clLocalVars.hitItems[t]=!0}function incChallengeHits(e){clLocalVars.nbHits++,updateChallengeHud("hits",clLocalVars.nbHits),"BB"==course&&1==e.ballons.length&&clLocalVars.killed&&-1==clLocalVars.killed.indexOf(e)&&(clLocalVars.killed.push(e),clLocalVars.nbKills++,updateChallengeHud("kills",clLocalVars.nbKills)),challengeCheck("each_hit")}function handleDecorHit(e,t,n){collisionDecorHit=!0,n.decor[t][e][2][0].suppr(),n.decor[t].splice(e,1),clLocalVars.nbDecorHits&&null!=clLocalVars.nbDecorHits[t]&&(clLocalVars.nbDecorHits[t]++,updateChallengeHud("decors",clLocalVars.nbDecorHits[t]),challengeCheck("each_decor_hit"))}function touche_banane(e,t,n){n=n||[];for(var a=0;a<items.banane.length;a++){var o=items.banane[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4&&!itemInteractionsDisabled(o))return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_poison(e,t,n){n=n||[];for(var a=0;a<items.poison.length;a++){var o=items.poison[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4&&!itemInteractionsDisabled(o))return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_champi(e,t){for(var n=0;n<items.champi.length;n++){var a=items.champi[n];if(e>a.x-4&&e<a.x+4&&t>a.y-4&&t<a.y+4&&!itemInteractionsDisabled(a))return detruit(a),1}}function touche_etoile(e,t){for(var n=0;n<items.etoile.length;n++){var a=items.etoile[n];if(e>a.x-4&&e<a.x+4&&t>a.y-4&&t<a.y+4&&!itemInteractionsDisabled(a))return detruit(a),1}}function touche_fauxobjet(e,t,n){n=n||[];for(var a=0;a<items.fauxobjet.length;a++){var o=items.fauxobjet[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4&&!itemInteractionsDisabled(o))return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_cverte(e,t,n){n=n||[];for(var a=0;a<items.carapace.length;a++){var o=items.carapace[a];if(-1==n.indexOf(o)&&!o.z&&touche_cverte_aux(e,t,o))return collisionTeam!=o.team}}function touche_cverte_aux(e,t,n){return e>n.x-5&&e<n.x+5&&t>n.y-5&&t<n.y+5&&(!itemInteractionsDisabled(n)&&(handleHit(n),detruit(n,isHitSound(n)),1))}function touche_cverte_future(e,t,n){n=n||[];for(var a=cappedRelSpeed()/2,o=0;o<items.carapace.length;o++){var i=items.carapace[o];if(-1==n.indexOf(i)&&!i.z){var r=i.vx*a,l=i.vy*a,r=i.x+r,l=i.y+l;if(r-5<e&&e<r+5&&l-5<t&&t<l+5&&!itemInteractionsDisabled(i))return handleHit(i),detruit(i,isHitSound(i)),collisionTeam!=i.team}}}function touche_crouge(e,t,n){n=n||[];for(var a=0;a<items["carapace-rouge"].length;a++){var o=items["carapace-rouge"][a];if(-1==n.indexOf(o)&&touche_crouge_aux(e,t,o))return collisionTeam!=o.team}}function touche_crouge_aux(e,t,n){if(!n.z&&(-1==n.owner||-2==n.aipoint?e>n.x-5&&e<n.x+5&&t>n.y-5&&t<n.y+5:e==n.x&&t==n.y))return!itemInteractionsDisabled(n)&&(handleHit(n),detruit(n,isHitSound(n)),1)}function touche_bobomb(e,t,n,a){n=n||[];for(var o=0;o<items.bobomb.length;o++){var i=items.bobomb[o];if(!i.z&&-1==n.indexOf(i))if(-1!=i.theta){if(touche_bobomb_aux(e,t,i,a)){if(i.cooldown<=0){var r=collisionTeam!=i.team&&(i.cooldown<-5?42:84);return r&&handleHit(i),r}i.cooldown=1,isOnline&&syncItems.push(i)}}else if(e>i.x-5&&e<i.x+5&&t>i.y-5&&t<i.y+5)for(j=0;j<aKarts.length;j++){var l=aKarts[j],s=l.using.indexOf(i);if(-1!=s){throwItem(l,{theta:1,countdown:0,cooldown:1},s),l.using.length||consumeItemIfDouble(j);break}}}return!1}function touche_bobomb_aux(e,t,n,a){var o=18;return 38<=n.cooldown?o=0:(30<=n.cooldown||a&&a.transparent)&&(o=5),!n.countdown&&(n.x-e)*(n.x-e)+(n.y-t)*(n.y-t)<o*o&&!itemInteractionsDisabled(n)}function touche_cbleue(e,t){for(var n=0;n<items["carapace-bleue"].length;n++){var a=items["carapace-bleue"][n];if(touche_cbleue_aux(e,t,a))return(o=collisionTeam!=a.team&&(a.cooldown<-5?42:84))&&handleHit(a),o}for(n=0;n<items["carapace-noire"].length;n++){var o,a=items["carapace-noire"][n];if(touche_cbleue_aux(e,t,a))return(o=collisionTeam!=a.team&&(a.cooldown<-5?42:84))&&handleHit(a),o}return!1}function touche_cbleue_aux(e,t,n){if(n.cooldown<=0&&-10<=n.cooldown)if(!n.countdown&&(n.x-e)*(n.x-e)+(n.y-t)*(n.y-t)<576)return!itemInteractionsDisabled(n);return!1}function powCpuDodge(e){let t=e.z;var n;e.jumped||(n=.5*Math.pow(2,-(iDificulty-4)),Math.random()<n||(t=1-n+Math.random()*(iDificulty/12),t<0?t=.1:1<t&&(t=1),e.z=t,e.heightinc=t/2,e.jumped=!0))}function powEffect(e,t,n){var a=0==t.z;let o=a?62:Math.floor(Math.abs(25*(t.z-1.2))+20);o%2==1&&o++,loseUsingItems(t),dropCurrentItem(t),t.spin(o),t.champi=0,delete t.champiType,stopDrifting(e),a&&(t.z=1,t.heightinc=.5,t.jumped=!0,handleItemHit(t,"pow"),"BB"===course&&(clLocalVars.myItems&&-1!=clLocalVars.myItems.indexOf(n)&&incChallengeHits(t),popBalloon(t)))}function playPow(e,t,n,a){5===a.countstate&&10===a.countdown&&t!=n&&t.cpu&&t.z<1.2&&!t.tourne&&!friendlyFire(t,n)&&powCpuDodge(t),6===a.countstate&&1===a.countdown&&(t==n||t.protect||!(t.z<1.2)||friendlyFire(t,n)||isOnline&&e&&t.controller!=identifiant||powEffect(e,t,a))}function touche_asset(e,t,n,a){for(var o,i=getCurrentLMap(collisionLap),r=["pointers","flippers"],l=0;l<r.length;l++)if(i[o=r[l]])for(var s=2*Math.PI,c=0;c<i[o].length;c++){var p=(e-(y=(b=i[o][c])[1][0]))*(e-y)+(t-(f=b[1][1]))*(t-f);if(p<(g=b[1][2]*(1-b[2][0]))*g){var u=b[2][2],d=Math.atan2(t-f,e-y),m=b[2][3];(n-y)*(n-y)+(a-f)*(a-f)<g*g&&(h=Math.atan2(a-f,n-y),m-=(h-=s*Math.round((h-d)/s))-d);var h=Math.sqrt(p),p=h/g,h=(v=b[1][3]*(b[1][4]*(1-p)+b[1][5]*p))/h,d=0<m?(d-=s*Math.floor((d-u)/s))<u+m+h:u+m-h<(d-=s*Math.ceil((d-u)/s));if(d)return[o,b]}}if(i[o="bumpers"])for(var g,l=0;l<i[o].length;l++)if((n-(y=(b=i[o][l])[1][0]))*(n-y)+(a-(f=b[1][1]))*(a-f)<(g=b[1][2]/2)*g){if(!b[2][5])if((e-y)*(e-y)+(t-f)*(t-f)<=(n-y)*(n-y)+(a-f)*(a-f))continue;return[o,b]}if(i[o="oils"])for(l=0;l<i[o].length;l++){var y=(b=i[o][l])[1][0],f=b[1][1],S=Math.max(4,b[1][2]/2),v=Math.max(4,b[1][3]/2);if(Math.abs(n-y)<S&&Math.abs(a-f)<v)return[o,b]}if(i[o="flowers"])for(l=0;l<i[o].length;l++){var b,C=(b=i[o][l])[1],x=C[0],M=C[1],P=Math.round(C[2]/2);if(pointInRectangle(n,a,[x-P,M-P,2*P,2*Math.round(C[3]/2)]))return[o,b]}return!1}function otherPlayerItems(o){return{indexOf:function(e){var t=o.indexOf(e);if(-1!==t)return t;for(var n=1;n<aKarts.length;n++){var a=aKarts[n];if(a.controller!=identifiant&&-1!==a.using.indexOf(e))return o.length}return-1}}}function onlyThisItems(t){return{indexOf:function(e){return-1!==t.indexOf(e)?-1:0}}}function distKart(e){for(var t=1/0,n=0;n<oPlayers.length;n++){var a=oPlayers[n];!kartIsPlayer(a)||finishing||(a=Math.hypot(e.x-a.x,e.y-a.y))<t&&(t=a)}return t}function stuntKart(e){e.figstate=21,e.z+=1,e.heightinc+=.5,e==oPlayers[0]&&(clLocalVars.stunted=!0),playIfShould(e,"musics/events/stunt.mp3")}function getRankScore(e){if("BB"==course)return e.ballons.length?e.ballons.length+e.reserve:0;var t=getCurrentLapId(e),n=getCurrentLMap(t),a=e.demitours+1;a>=n.checkpoint.length&&(a=0);t=n.checkpointCoords[a];if(!t)return 0;n=projete(e.x,e.y,t.A[0],t.A[1],t.B[0],t.B[1]),a=t.A[0]+n*t.u[0],t=t.A[1]+n*t.u[1],t=Math.hypot(a-e.x,t-e.y);return e.tours*oMap.maxCheckpoints+getCpScore(e)-t/1e4}function getRankScores(){return aKarts.map(function(e){return getRankScore(e)})}function places(e,t,n){for(var a=aKarts[e],o=!n,i=0;i<strPlayer.length;i++){var r=getPlayerAtScreen(i);r.tours>oMap.tours||r.loose?onlineSpectatorId&&!finishing&&(document.getElementById("infoPlace"+i).style.visibility="hidden"):o=!1}if(!o){var l=1;if("BB"==course||!(a.tours>oMap.tours)&&oMap.minCheckpoints){for(var s=t[e],i=0;i<aKarts.length;i++){var c=t[i];(aKarts[i]!=a&&s<c||s==c&&a.initialPlace>aKarts[i].initialPlace)&&l++}a.loose||(a.place=l),finishing||(e=getScreenPlayerIndex(e))<oPlayers.length&&(document.getElementById("infoPlace"+e).innerHTML=l)}}}function getLastCp(e){return oMap.sections?1<e.tours&&e.tours<=oMap.tours?oMap.sections[e.tours-2]:oMap.checkpoint.length-1:0}function getNextCp(e){return oMap.sections?e.tours<=oMap.sections.length?oMap.sections[e.tours-1]:oMap.checkpoint.length-1:0}function getCpDiff(e){var t=getLastCp(e),t=getNextCp(e)-t;return t<=0&&(t+=getCurrentLMap(getCurrentLapId(e)).checkpoint.length),t}function getCpScore(e){var t=getLastCp(e),t=e.demitours-t;return t<0&&(t+=oMap.checkpoint.length),t}function distanceToFirst(e){for(var t,n=1/0,a=0;a<aKarts.length;a++)aKarts[a].place<n&&(n=(t=aKarts[a]).place);return distanceToKart(e,t)}function distanceToSecond(e){for(var t,n=1/0,a=0;a<aKarts.length;a++)aKarts[a]!=e&&aKarts[a].place<n&&(n=(t=aKarts[a]).place);return t?distanceToKart(t,e):0}function distanceToKart(e,t){var n=0,a=e.x,o=e.y,i=e.tours,r=e.demitours,l=t.tours,s=t.demitours;for(oMap.sections&&(i=l,r>=oMap.checkpoint.length-1&&(r=-1),s>=oMap.checkpoint.length-1&&(s=-1));i<l||i==l&&r<s;){var c=getCurrentLMap(getCurrentLapId({tours:i,demitours:r}));++r>=c.checkpoint.length&&(r=0,i++);var p=c.checkpointCoords[r],c=p.O[0],p=p.O[1];n+=Math.hypot(c-a,p-o),a=c,o=p}return n+=Math.hypot(t.x-a,t.y-o)}function checkpoint(e,t,n){var a,o=[e.x-t,e.y-n],i=200<t*t+n*n,r=e.demitours;simplified||(a=getNextCp(e));for(var l=getCurrentLMap(getCurrentLapId(e)),s=0;s<l.checkpointCoords.length;s++)if(inCheckpoint(l.checkpointCoords[s],e,{aPos:o,fast:i}))if(simplified){if(0==s&&l.checkpoint.length-r<5)return 1;if(r==s-1||r&&Math.abs(r-s)<5)return void(e.demitours=s)}else{for(var c=!0,p=r+1;p>=l.checkpoint.length&&(p-=l.checkpoint.length),p!=s;p++)if(!l.checkpoint[p][4]){c=!1;break}if(c)return s==a||void(e.demitours=s)}}function getCheckpointCoords(e){var t=e[0],n=e[1],a=e[2];switch(e[3]){case 0:case 1:var o=e[3],i={A:[t,n],u:[o?a:0,o?0:a],v:[o?0:15,o?15:0],O:[t+(o?a/2:8),n+(o?8:a/2)]};break;default:var r=e[3]*Math.PI/2,l=Math.cos(r),s=Math.sin(r),c=t+7.5,p=n+7.5,o=e[2]/2-7.5,r=c+o*s,c=p+o*l,p=a*s,o=15*l,l=-a*l,s=15*s;i={A:[r-(p+o)/2,c-(l+s)/2],u:[p,l],v:[o,s],O:[r,c]}}return i.B=[i.A[0]+i.u[0],i.A[1]+i.u[1]],i.C=[i.A[0]+i.v[0],i.A[1]+i.v[1]],i.D=[i.B[0]+i.v[0],i.B[1]+i.v[1]],i}function inCheckpoint(e,t,n){var a=t.x,t=t.y;if(pointInQuad(a,t,e))return!0;if(!n.fast)return!1;n=n.aPos;return!!secants(n[0],n[1],a,t,e.A[0],e.A[1],e.B[0],e.B[1])||!!secants(n[0],n[1],a,t,e.C[0],e.C[1],e.D[0],e.D[1])}function enteredCheckpoint(e,t,n){return inCheckpoint(e,t,n)&&!inCheckpoint(e,{x:n.aPos[0],y:n.aPos[1]},{})}function int8ToHexString(e){return[].slice.call(e).map(function(e){return e.toString(16).padStart(2,"0")}).join("")}function hexStringToInt8(e){return new Uint8Array(e.match(/../g).map(function(e){return parseInt(e,16)})).buffer}function itemDataToHex(e,t){switch(e){case"double":return int8ToHexString(new Uint8Array(new Float64Array([t]).buffer,0,8));case"float":return int8ToHexString(new Uint8Array(new Float32Array([t]).buffer,0,4));case"int":return int8ToHexString(new Uint8Array(new Int32Array([t]).buffer,0,4));case"short":return int8ToHexString(new Uint8Array(new Int16Array([t]).buffer,0,2));case"byte":return int8ToHexString(new Uint8Array(new Int8Array([t]).buffer,0,1))}}function hexToItemData(e,t){switch(e){case"double":return new Float64Array(hexStringToInt8(t))[0];case"float":return new Float32Array(hexStringToInt8(t))[0];case"int":return new Int32Array(hexStringToInt8(t))[0];case"short":return new Int16Array(hexStringToInt8(t))[0];case"byte":return new Int8Array(hexStringToInt8(t))[0]}}function itemDataLength(e){switch(e){case"double":return 16;case"float":case"int":return 8;case"short":return 4;case"byte":return 2}}function resetDatas(){var e=oPlayers[0],te="BB"!=course?["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","drift","driftinc","driftcpt","size","tourne","tombe","arme","stash","tours","demitours","champi","etoile","megachampi","billball","place"]:["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","drift","driftinc","driftcpt","size","tourne","tombe","arme","stash","ballons","reserve","champi","etoile","megachampi"],t="BB"!=course?["finaltime"]:[],ne=te.concat("aipoint"),n={player:[],extra:{},item:[],lastcon:connecte},a=[{params:n.player,mapping:te,kart:e}];if(onlineSpectatorId)delete n.player;else{for(var o=0;o<aKarts.length;o++)(s=aKarts[o]).controller==identifiant&&(n.cpu||(n.cpu={}),n.cpu[s.id]=[],a.push({params:n.cpu[s.id],mapping:ne,kart:s}));for(var i=0;i<a.length;i++){var r=a[i],l=r.params,s=r.kart,c=r.mapping;l.length=c.length;for(var p,o=0;o<c.length;o++){switch(c[o]){case"demitours":"BB"!=course&&(p=getCpScore(s));break;case"ballons":"BB"==course&&(p=s.ballons.length);break;default:p=s[c[o]]}l[o]=p}for(var u={},o=0;o<t.length;o++)s[t[o]]&&(u[t[o]]=s[t[o]]);Object.keys(u).length&&(n.extra[s.id]=u)}}Object.keys(n.extra).length||delete n.extra;var d=Array.from(new Set(syncItems)),ae=[];if(!onlineSpectatorId)for(o=0;o<d.length;o++){var m=d[o],h="";if(m.deleted){if(!m.id)continue}else for(var g=itemBehaviors[m.type],i=0;i<g.sync.length;i++){var y=g.sync[i];h+=itemDataToHex(y.type,m[y.key]||0)}for(var f={data:h},i=0;i<a.length;i++)if(-1!==(s=a[i].kart).using.indexOf(m)){f.holder=s.id;break}m.id?f.id=m.id:(f.type=itemTypes.indexOf(m.type),ae.push(m)),n.item.push(f)}syncItems.length=0,"BB"==course?n.battle=1:3!=oMap.tours&&(n.laps=oMap.tours),onlineSpectatorId&&(n.spectator=onlineSpectatorId),fetch("api/reload.php",{method:"post",body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(h){if(-1!=h){refreshDatas=!0;for(var e=h[1],t=e[0],n=e[1],a=0;a<t.length;a++){var o=t[a];ae[a]&&(ae[a].id=o)}for(var i=h[0],a=0;a<i.length;a++)for(var r=i[a],l=r[0][0],s=0;s<aKarts.length;s++)if((D=aKarts[s]).id==l){if(r[2]){var c=r[2];if(c.controller&&(D.controller=c.controller,D.controller==identifiant))break}for(var p,u,d=r[1],m=D.x,g=D.y,y=D.rotation,f=D.etoile,S=D.billball,v=D.tombe,b=D.driftcpt,C=D.champi,x=D.arme,M=D.tours,P=D.demitours,k=D.reserve,I=D.controller?ne:te,w=0;w<I.length;w++){var L=I[w],T=d[w];switch(L){case"demitours":p=T;break;case"ballons":if("BB"==course){for(;D.ballons.length<T;)D.ballons.length||(D.sprite[0].div.style.opacity=1,D.sprite[0].img.style.display="",oPlanCharacters[s].style.display="block",oPlanCharacters2[s].style.display="block",D.loose=!1),addNewBalloon(D);for(;D.ballons.length>T;)popBalloon(D)}break;default:D[I[w]]=T}}if(0<=p&&(c=getCurrentLMap(getCurrentLapId(D)),D.demitours=(getLastCp(D)+p)%c.checkpoint.length),25<=D.billball&&!S?(D.sprite[0].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(D.sprite[0]),D.aipoint=void 0):50<=D.etoile&&!f?D.sprite[0].img.src=getStarSrc(D.personnage):(f&&!D.etoile||S&&!D.billball)&&(D.sprite[0].img.src=getSpriteSrc(D.personnage),resumeSpriteSize(D.sprite[0])),x&&x.startsWith("champi")&&(x!==D.arme||"champior"===x)&&D.champi>C?D.champiType=CHAMPI_TYPE_ITEM:D.champi||delete D.champiType,M===D.tours&&P===D.demitours||((u=getScreenPlayerIndex(s))<oPlayers.length&&updateLapHud(u),handleCpChange(M,P,s)),D.aipoint>=D.aipoints.length&&(D.aipoint=0),k!==D.reserve&&(u=getScreenPlayerIndex(s))<oPlayers.length&&updateBalloonHud(document.getElementById("compteur0"),D),updateProtectFlag(D),v&&!D.tombe){if(D.sprite[0].img.style.display="block","BB"==course)for(w=0;w<D.ballons.length;w++)D.ballons[w][0].img.style.display="block";(u=getScreenPlayerIndex(s))<oPlayers.length&&(oContainers[u].style.opacity=1,resetRenderState())}if(!v&&D.tombe&&(D.sprite[0].img.style.display="none",D.frminv=10,2<D.tombe)){if("BB"==course)for(w=0;w<D.ballons.length;w++)D.ballons[w][0].img.style.display="none";D.marker&&(D.marker.div[0].style.display="none"),D.aX=m,D.aY=g,D.aRotation=y}fTurboDriftCpt<=b&&D.driftcpt<fTurboDriftCpt?D.driftinc?D.driftcpt<fTurboDriftCpt-10&&D.driftSprite[0].setState(0):resetDriftSprite(D):(b<fTurboDriftCpt&&D.driftcpt>=fTurboDriftCpt&&D.driftSprite[0].setState(1),b<fTurboDriftCpt2&&D.driftcpt>=fTurboDriftCpt2&&D.driftSprite[0].setState(2)),!D.turnSound&&D.tourne&&(D.turnSound=playDistSound(D,"musics/events/spin.mp3","BB"==course?80:50),D.frminv||(D.frminv=10)),D.turnSound&&!D.tourne&&(D.turnSound=void 0);for(w=r[0][1];w<h[2];w++)move(s,!0);oSpecCam&&oSpecCam.playerId===s&&oSpecCam.reset({smooth:!0,since:h[2]-r[0][1]});break}var E=[];if(!onlineSpectatorId)for(a=0;a<aKarts.length;a++){var D=aKarts[a];a&&D.controller!=identifiant||E.push(a)}for(a=0;a<n.length;a++){var B=(z=n[a])[0];(R=itemTypes[z[1]])&&(_=z[4],(H=items[R].find(function(e){return e.id==B}))&&!_&&(supprime(H,!1),z[2]=0))}for(var O=getCurrentLapId(getPlayerAtScreen(0)),a=0;a<n.length;a++){var z,H,B=(z=n[a])[0],R=itemTypes[z[1]],A=z[2],N=z[3],_=z[4],V=!1;if((H=items[R].find(function(e){return e.id==B}))||_&&(H={id:B,type:R,lapId:0},V=!0),_){for(var F=0,j=itemBehaviors[R],s=0;s<j.sync.length;s++){var K=j.sync[s],W=itemDataLength(K.type),q=_.substr(F,W);q.length==W&&(H[K.key]=hexToItemData(K.type,q)),F+=W}V&&addNewItem(null,H)}for(s=0;s<aKarts.length;s++){var G=(D=aKarts[s]).using.indexOf(H);D.id==A?-1==G&&(D.using.push(H),H.lapId=getCurrentLapId(D),1<D.using.length&&!D.rotitem&&(D.rotitem=0)):-1!=G&&(D.using.splice(G,1),H.lapId=getCurrentLapId(D),D.using.length||consumeItemIfDouble(s)),moveUsingItems(D,!0)}if(_&&0==A){var J=h[2],$=itemBehaviors[R].move;if($&&!1!==itemBehaviors[R].onlineResync){var U=itemBehaviors[R].checkCollisions;function X(e){for(var t=0;t<E.length;t++){var n=E[t],a=aKarts[n];collisionLap=getCurrentLapId(a),a.loose||a.tourne||a.protect||a.fell||U(e,n)}}var Y={onlineSync:!0,checkCollisions:X};collisionTest=COL_OBJ,collisionLap=O;for(w=N;w<J&&!H.deleted;w++)$(H,Y),U&&X(H)}}}if(connecte=h[2],h[3]){function Q(){var e=getPlayerAtScreen(0);"BB"==course&&(e.arme=!1,supprArme(e.speed=0)),e.speedinc=0,e.rotinc=0,e.rotincdir=0,e.sprite[0].setState(0),stopDrifting(0);var p=document.getElementById("infos0");p.innerHTML="",p.style.border="solid 1px black",p.style.opacity=.7,p.style.fontSize=Math.round(1.5*iScreenScale+4)+"pt",p.style.fontFamily="Courier",p.style.top=3*iScreenScale+"px",p.style.left=Math.round(25*iScreenScale+10)+"px",p.style.backgroundColor=iTeamPlay?"blue":"#063",p.style.color=primaryColor;for(var u=new Array,d=new Array,t=0;t<h[3].length;t++){var n=h[3][t],a=document.createElement("tr");d[t]=new Array,n[0]==identifiant?(a.style.backgroundColor=rankingColor(0),document.getElementById("infoPlace0").innerHTML=t+1,document.getElementById("infoPlace0").style.visibility="visible"):-1!=n[4]&&(a.style.backgroundColor=cTeamColors.primary[n[4]]),(r=document.createElement("td")).innerHTML=toPlace(t+1),d[t][0]=document.createElement("td"),shareLink.options&&shareLink.options.timeTrial&&n[5]?d[t][0].innerHTML='<span style="font-size: '+Math.round(+iScreenScale+3)+'pt">'+n[1]+'</span><br /><span style="font-size: '+Math.round(.75*iScreenScale+2)+'pt">'+timeStr(n[5])+"</span>":d[t][0].innerHTML=n[1],d[t][0].id="j"+t,d[t][1]=document.createElement("td"),d[t][1].innerHTML=n[2];var o=document.createElement("small");if(o.innerHTML=(n[3]<0?"":"+")+n[3],a.appendChild(r),a.appendChild(d[t][0]),d[t][1].appendChild(o),a.appendChild(d[t][1]),iTeamPlay){a.style.textShadow="-1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603";for(var i=0;i<d[t].length;i++)d[t][i].style.padding="0 "+Math.round(iScreenScale/2)+"px"}p.appendChild(a),u[t]=a}handleRankingStyle();var r,a=document.createElement("tr");(r=document.createElement("td")).setAttribute("colspan",3);var m=document.createElement("input");m.type="button",m.value=toLanguage("CONTINUE","CONTINUER"),m.style.width="100%",m.style.height="100%",m.style.fontSize=3*iScreenScale+"pt";var l=!0;function s(){p.style.display="none";for(var e=0;e<h[3].length;e++)h[3][e][2]+=h[3][e][3];var t,n=h[3].length-1;for(e=0;e<n;e++){for(var a=0,o=0,i=e;i<h[3].length;i++)h[3][i][2]>=a&&(a=h[3][i][2],o=i);var r=h[3][e];h[3][e]=h[3][o],h[3][o]=r}for(e=0;e<d.length;e++){var l=h[3][e];d[e][0].innerHTML=toPerso(l[1]),d[e][1].innerHTML=l[2],l[0]==identifiant?u[e].style.backgroundColor=rankingColor(0):-1!=l[4]?u[e].style.backgroundColor=cTeamColors.primary[l[4]]:u[e].style.backgroundColor=""}if(iTeamPlay&&shareLink.options&&shareLink.options.localScore){for(var s=new Array(selectedNbTeams).fill(0),e=0;e<h[3].length;e++)s[h[3][e][4]]+=h[3][e][2];t=createTeamTable(s)}var c=!0;setTimeout(function(){p.style.display="",t&&(t.style.visibility="visible"),isChatting()||m.focus()},500),setTimeout(function(){c&&continuer()},5e3),m.onclick=function(){c=!1,continuer()}}m.onclick=function(){l=!1,s()},setTimeout(function(){l&&s()},5e3),r.appendChild(m),a.appendChild(r),p.appendChild(a),p.style.display="",isChatting()||m.focus(),resetEvents(),window.onbeforeunload=logGameTime,supprArme(0),resetWrongWay(e),(bMusic||iSfx)&&startEndMusic(),finishing=!0,document.getElementById("racecountdown").innerHTML=h[4]-("BB"==course?6:5),onlineSpectatorId&&"queuing"!==onlineSpectatorState||(document.getElementById("waitrace").style.visibility="visible",dRest()),document.getElementById("compteur0").innerHTML="";for(var t=0;t<oRoulettesPrefixes.length;t++){var c=oRoulettesPrefixes[t];document.getElementById("roulette"+c+0).innerHTML="",document.getElementById("scroller"+c+0).style.visibility="hidden"}updateItemCountdownHud(0,null);e=document.getElementById("lakitu0");e&&(e.style.display="none"),"queuing"===onlineSpectatorState&&(l=!1,p.style.display="none",xhr("getCourse.php",getOnlineCourseParams({spectator:onlineSpectatorId}),function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}return e.found&&setSpectatorId(void 0),nextRace(),!0}))}if(refreshDatas=!1,"BB"==course){for(var Z=h[3][0][0],ee=h[3][0][4],a=0;a<aKarts.length;a++){D=aKarts[a];if(iTeamPlay?D.team!=ee:D.id!=Z){if(D.ballons.length&&!D.tourne){for(;popBalloon(D),D.ballons.length;);D.spin(20),D!=oPlayers[0]&&playDistSound(D,"musics/events/spin.mp3","BB"==course?80:50)}}else D!=oPlayers[0]&&(D.loose=!0)}setTimeout(Q,1e3)}else Q()}}else iDeco(),interruptGame()}).catch(function(e){if(console.error(e),!refreshDatas){refreshDatas=!0;for(var t=d.length-1;0<=t;t--)syncItems.unshift(d[t])}}),refreshDatas=!1}function resetFall(e){delete e.aX,delete e.aY,delete e.aRotation;for(var t=0;t<oPlayers.length;t++)e==getPlayerAtScreen(t)&&(oContainers[t].style.opacity=1),e.sprite[t].img.style.display="block"}function loseBall(e){var t;"BB"==course&&(t=aKarts[e].ballons.length-1,!aKarts[e].tourne&&aKarts[e].ballons[t]&&(popBalloon(aKarts[e]),aKarts[e].cpu||(clLocalVars.lostBalloons++,updateChallengeHud("balloons",clLocalVars.lostBalloons)),!isOnline||(t=getScreenPlayerIndex(e))<oPlayers.length&&!aKarts[e].ballons.length&&(supprArme(e),document.getElementById("infoPlace"+t).style.visibility="hidden")))}function showTimer(e){for(var t=timeStr(e),n=0;n<strPlayer.length;n++)document.getElementById("temps"+n).innerHTML=t}function move(e,t){var n=aKarts[e];collisionTest=COL_KART,collisionTeam=-1==(collisionPlayer=n).team||selectedFriendlyFire?void 0:n.team,collisionLap=getCurrentLapId(n),clLocalVars.currentKart=n;var a=getCurrentLMap(collisionLap);if(e<strPlayer.length&&(n.cpu||finishing?n.tours==oMap.tours+1&&(n.changeView||(n.changeView=0),n.changeView<180&&(n.changeView+=15),n.progressiveView=!0):(showTimer(timer*SPF),e||timer++,n.time&&(n.time--,n.time&&!oPlayers[e].changeView?document.getElementById("lakitu"+e).style.display="block":document.getElementById("lakitu"+e).style.display="none",oLapTimeDiv&&n.time<25&&(n.time<5?(oContainers[0].removeChild(oLapTimeDiv),oLapTimeDiv=void 0):oLapTimeDiv.style.visibility=n.time%6<4?"visible":"hidden")),handleWrongWay(n)),finishing&&timer++),n.tombe){if(n.tombe--,n.size=1,n.mini=0,19==n.tombe){for(var o=0;o<strPlayer.length;o++){if(n.sprite[o].img.style.display="none",n.sprite[o].img.style.opacity="",n.sprite[o].div.style.backgroundImage="","BB"==course)for(var i=0;i<n.ballons.length;i++)n.ballons[i][o].img.style.display="none";n.marker&&(n.marker.div[o].style.display="none")}playIfShould(n,"musics/events/rescue.mp3")}else if(2==n.tombe){if("BB"==course)for(var o=0;o<strPlayer.length;o++)for(i=0;i<n.ballons.length;i++)n.ballons[i][o].img.style.display="block"}else if(!n.tombe&&(resetFall(n),loseBall(e),"BB"==course&&(n.cpu&&1==n.ballons.length&&(isOnline&&n.controller!=identifiant||inflateNewBalloons(n)),!n.ballons.length&&!n.loose)))for(o=0;o<strPlayer.length;o++)n.sprite[o].div.style.opacity=1}else{if(n.teleport){if(n.teleport--,3==n.teleport){delete n.aX,delete n.aY;for(o=0;o<strPlayer.length;o++)if(n.sprite[o].img.style.display="","BB"==course)for(i=0;i<n.ballons.length;i++)n.ballons[i][o].img.style.display=""}if(2<=n.teleport)return;n.teleport<=0&&(delete n.teleport,-1!==(o=oPlayers.indexOf(n))&&(oContainers[o].style.opacity=""))}if(n.rotincdir?(n.rotinc+=2*n.rotincdir,n.driftinc&&0<n.driftinc!=0<n.rotincdir&&(l=Math.max(1.1,1.6-Math.max(0,(n.driftcpt-20)/80)),0<n.driftinc?n.rotinc=Math.max(n.rotinc,-l):n.rotinc=Math.min(n.rotinc,l))):n.rotinc<0?n.rotinc=Math.min(0,n.rotinc+1):0<n.rotinc&&(n.rotinc=Math.max(0,n.rotinc-1)),handleDriftCpt(e),n.cpu?(n.rotinc=Math.min(n.rotinc,fMaxRotInCp),n.rotinc=Math.max(n.rotinc,-fMaxRotInCp)):(n.rotinc=Math.min(n.rotinc,fMaxRotInc),n.rotinc=Math.max(n.rotinc,-fMaxRotInc)),n.shift&&(n.rotation+=180*n.shift[2]/Math.PI),n.tourne){if(n.figuring=!1,n.figstate=0,n.z||(n.speed=(n.speed-Math.max(0,n.speedinc+.1))/1.5),n.tourne-=2,!n.tourne&&"BB"==course&&(n.cpu&&1==n.ballons.length&&(isOnline&&n.controller!=identifiant||inflateNewBalloons(n)),!n.ballons.length&&!n.loose))for(o=0;o<strPlayer.length;o++)n.sprite[o].div.style.opacity=1}else n.figstate?(n.figstate-=1+Math.round(.5*(11-Math.abs(11-n.figstate))),n.figstate<0&&(n.figstate=0),!n.figuring&&n.figstate<8&&(n.figuring=!0,n==oPlayers[0]&&(clLocalVars.stunts++,clSelected&&clRuleVars[clSelected.id]&&(ne=clRuleVars[clSelected.id].stunts)&&updateChallengeHud("stunts",ne.stunts+clLocalVars.stunts)))):!n.speed||n.billball||n.cannon||(n.rotation+=angleInc(n)),n.frminv&&n.frminv--;n.rotation<0&&(n.rotation+=360),360<n.rotation&&(n.rotation-=360),kartIsPlayer(n)&&(!clLocalVars.startedAt&&1<n.speed&&(clLocalVars.startedAt=timer),clLocalVars.forwards||0<n.speed&&(0<n.speedinc||n.turbodrift)&&(clLocalVars.forwards=!0),clLocalVars.backwards||n.speed<0&&n.speedinc<0&&(clLocalVars.backwards=!0),!clLocalVars.rightTurn&&n.speed&&(h=(n.speedinc||n.speed)<0?-getMirrorFactor():getMirrorFactor(),(n.rotinc*h<0&&n.rotincdir*h<0||n.driftinc*h<0)&&(clLocalVars.rightTurn=!0)),!clLocalVars.leftTurn&&n.speed&&(h=(n.speedinc||n.speed)<0?-getMirrorFactor():getMirrorFactor(),(0<n.rotinc*h&&0<n.rotincdir*h||0<n.driftinc*h)&&(clLocalVars.leftTurn=!0)));var r=n.maxspeed*sizeSpeedRatio(n)*fSelectedClass;n.speed>r&&(n.speed=r),n.speed<-r/4&&(n.speed=-r/4);var l=kartInstantSpeed(n),s=l[0],c=l[1],p=n.x+s,u=n.y+c,d=n.x,m=n.y;n.z||n.heightinc?handleHeightInc(n)&&(delete n.jumped,n.driftinc&&carDrift&&!n.driftSound&&kartIsPlayer(n)&&(carDrift.currentTime=0,carDrift.play(),n.driftSound=carDrift)):(clLocalVars.autoAccelerate&&!n.cpu&&n.accelerate(),n.speed+=n.speedinc,(isCup&&22!=oMap.skin&&30!=oMap.skin||!isCup&&oMap.smartjump)&&n.cpu&&(tombe(p,u)&&!sauts(d,m,s,c)||(J=ralenti(p,u))&&(ie=getOffroadProps(n,J))&&n.speed-1.01*n.speedinc>ie.speed&&!n.protect&&!n.champi)&&(n.z=1,n.heightinc=.5,n.jumped=!0));var h=!(isOnline&&e&&n.controller!=identifiant||onlineSpectatorId);if(h&&!n.loose){var g=n.using;if(n.tourne){g=[];for(o=0;o<aKarts.length;o++)g=g.concat(aKarts[o].using)}var y=touche_bobomb(p,u,g)+touche_cbleue(p,u);if(!y||n.tourne||n.protect||n.fell){if(n.z<maxItemHitboxZ){r=(n.x,0),l=(n.y+u)/2,r=p,l=u;if(!(touche_fauxobjet(p,u,g)||1.5<fSelectedClass&&touche_fauxobjet(r,l,g)||touche_cverte(p,u,g)||touche_cverte(n.x,n.y,g)||1<fSelectedClass&&touche_cverte_future(p,u,g)||1.5<fSelectedClass&&touche_cverte(r,l,g)||touche_crouge(n.x,n.y,g)||1.5<fSelectedClass&&touche_crouge(r,l,g))||n.protect||n.frminv)if(!(touche_banane(p,u,g)||1.5<fSelectedClass&&touche_banane(r,l,g))||n.protect||n.frminv)if(!(touche_poison(p,u,g)||1.5<fSelectedClass&&touche_poison(r,l,g))||n.protect||n.frminv)if((touche_champi(p,u)||1.5<fSelectedClass&&touche_champi(r,l))&&!n.tourne)n.champi=20,n.champiType=CHAMPI_TYPE_ITEM,n.maxspeed=11,n.speed=n.maxspeed*cappedRelSpeed(n),playIfShould(n,"musics/events/boost.mp3");else if(!(touche_etoile(p,u)||1.5<fSelectedClass&&touche_etoile(r,l))||n.tourne||n.billball){if(!n.tourne&&n.z<1.2){var f=!n.protect&&!n.frminv,S=touche_asset(d,m,p,u),v=!0,b=!1;if(S){var C=S[1][0].src,x=S[1][0].custom;switch(x&&(C="custom-"+S[1][0].custom.id),S[0]){case"oils":f&&.5<Math.abs(n.speed)&&!n.tourne&&Math.min(n.z,n.z+n.heightinc)<=0&&(stopDrifting(e),loseBall(e),n.spin(20)),v=!1;break;case"pointers":x||(C="assets/pivothand"),f?(stopDrifting(e),loseBall(e),n.spin(42),n.cpu&&(n.frminv=16)):v=!1;break;case"flippers":f&&(stopDrifting(e),loseBall(e),n.spin(42)),n.speed*=-1;var M=8;switch(S[1][3][0]){case 1:M=12;break;case 2:M=4}n.shift=[-M*direction(0,n.rotation),-M*direction(1,n.rotation),0];break;case"bumpers":f=!1,n.speed*=-1;var M=8,P=s,k=c,I=S[1];I[3]&&(P+=I[3][0]*Math.sin(I[3][1])*I[2][5],k-=I[3][0]*Math.cos(I[3][1])*I[2][5]);var w=d+P,L=m+k,T=d-I[1][0],E=m-I[1][1],I=Math.hypot(T,E),T=T/I,E=E/I,I=P*T+k*E,P=d+2*(w-I*T-d)-w,k=m+2*(L-I*E-m)-L,E=Math.hypot(P,k);n.shift=E?[M*P/E,M*k/E,0]:[-M*direction(0,n.rotation),-M*direction(1,n.rotation),0],n.cpu&&(n.bounced=!0,n.bouncedsince=0);break;case"flowers":b=!(f=v=!1)}v&&(b=!0,stopDrifting(e),p=d,u=m,n.collideSound||(n.collideSound=playIfShould(n,"musics/events/collide.mp3"),n.collideSound&&(n.collideSound.onended=function(){n.collideSound=void 0,document.body.removeChild(this)}))),f&&(b=!0,loseUsingItem(n)),b&&clLocalVars.decorsHit&&!n.cpu&&(clLocalVars.decorsHit[C]=!0)}}}else setStarState(n,80);else handlePoisonHit(e);else handleSoftHit(e);else handleHardHit(e);if(!n.cpu)for(;touche_piece(n.x,n.y,p-n.x,u-n.y);)clLocalVars.nbCoins++,updateChallengeHud("coins",clLocalVars.nbCoins),challengeCheck("each_coin"),playIfShould(n,"musics/events/coin.mp3")}}else handleExplosionHit(e,y)}y=objet(n.x,n.y,p-n.x,u-n.y);if(-1!==y){n.destroySound||(n.destroySound=playDistSound(n,"musics/events/item_destroy.mp3",80),n.destroySound&&(n.destroySound.onended=function(){n.destroySound=void 0,document.body.removeChild(this)}));for(var D,B=a.arme[y][2].box.length,O=0;O<B;O++)if((!n.arme||oDoubleItemsEnabled&&!n.stash&&(O||!n.roulette||7<n.roulette))&&(n.tours<=oMap.tours||"BB"==course)&&!finishing){if("BB"!=course){D=randObj(n);var z={};1==n.tours&&getCpScore(n)<=getCpDiff(n)/2&&(z.bloops=1,z.carapaceX3=1,z.carapacerougeX3=1),timer<375&&(1!=itemDistribution.powstart&&(z.pow=1),1!=itemDistribution.lightningstart&&(z.eclair=1),1!=itemDistribution.blueshellstart&&(z.carapacebleue=1,z.carapacenoire=1)),1==n.place&&(z.carapacebleue=1);var H={carapacebleue:1,carapacenoire:1,eclair:1,bloops:1,pow:1,bananeX3:1};1==itemDistribution.powx2&&delete H.pow,1==itemDistribution.lightningx2&&delete H.eclair,1==itemDistribution.blueshellx2&&(delete H.carapacebleue,delete H.carapacenoire);for(o=0;o<aKarts.length;o++)for(var R=aKarts[o],i=0;i<oArmeKeys.length;i++)H[R[N=oArmeKeys[i]]]&&(z[R[N]]=1);if(items["carapace-bleue"].length&&(z.carapacebleue=1),items["carapace-noire"].length?z.carapacenoire=1:nextBlueShellCooldown&&0!=itemDistribution.blueshelldelay&&(z.carapacebleue=1),(n.place<aKarts.length||items.eclair.length)&&(z.eclair=1),items.bloops.length&&(z.bloops=1),(items.pow.length||0<nextPowCooldown)&&(z.pow=1),n.arme&&1!=itemDistribution.doubleitemx2&&(z[n.arme]=1),z[D]&&otherObjects(n,z))for(;D=randObj(n),z[D];);}else D=n.ballons.length?randObj(n):(j=["fauxobjet","banane","carapace","bobomb"])[Math.floor(Math.random()*j.length)];var A=n.arme?1:0,N=oArmeKeys[A];if(n[N]=D,shouldPlaySound(n)&&!n.rouletteSound&&(n.rouletteSound=playSoundEffect("musics/events/roulette.mp3")),kartIsPlayer(n)){var _=oRoulettesPrefixes[A],V=document.getElementById("scroller"+_+e).getElementsByTagName("div")[0],F=V.offsetHeight,j=7*iScreenScale;switch(V.dataset||(V.dataset={}),V.dataset.h=F,V.dataset.s=j,V.dataset.v=A?1.2:2,document.getElementById("scroller"+_+e).getElementsByTagName("div")[0].style.top=-Math.floor(Math.random()*F)+"px",updateObjHud(e),clLocalVars.itemsGot=!0,D){case"etoile":document.createElement("img").src=getStarSrc(n.personnage);break;case"billball":document.createElement("img").src="images/sprites/sprite_billball.png"}}}clLocalVars.itemsHit&&clLocalVars.itemsHit[collisionLap]&&!n.cpu&&((Y=clLocalVars.itemsHit[collisionLap])[y]||(Y[y]=!0,clLocalVars.nbItems++,updateChallengeHud("items",clLocalVars.nbItems),challengeCheck("each_item")))}for(o=0;o<oRoulettesPrefixes.length;o++){var K=oArmeKeys[o],W="roulette"+(_=oRoulettesPrefixes[o]);n[K]&&n[W]<25&&(n[W]++,25<=n[W]&&(n[W]=25,kartIsPlayer(n)&&(updateObjHud(e),n.rouletteSound&&(removeIfExists(n.rouletteSound),playSoundEffect("musics/events/gotitem.mp3"),n.rouletteSound=void 0))))}collisionItem=collisionFloor=collisionDecor=null;var q,G,J,$,U,X,Y=!1;if(n.cannon||canMoveTo(d,m,n.z,s,c,n.protect,n.z0||0)||n.billball)n.x=p,n.y=u,n.cpu&&delete n.collided;else{n.collideSound||(n.collideSound=playIfShould(n,"musics/events/collide.mp3"),n.collideSound&&(n.collideSound.onended=function(){n.collideSound=void 0,document.body.removeChild(this)}));var Q=getHorizontality(d,m,Math.max(collisionFloor?collisionFloor.z:0,n.z+(n.z0||0)),s,c);n.cpu&&(n.collided=!0,n.horizontality=Q);var y=p-n.x,Z=u-n.y,ee=y*Q[0]+Z*Q[1];n.speed>n.speedinc&&(n.speed=Math.min(.75*n.speed,n.speed+.5-n.speedinc)),collisionDecor||(3<n.speed&&5<=n.driftcpt&&n.driftcpt<fTurboDriftCpt2&&(n.driftcpt<fTurboDriftCpt||n.driftcpt>=fTurboDriftCpt+5)&&(n.driftcpt-=5),n.cpu||(clLocalVars.touchedWalls=!0));for(o=5;0<o&&(n.x+=Q[0]*ee*o/5,n.y+=Q[1]*ee*o/5,!canMoveTo(d,m,n.z,n.x-d,n.y-m,n.protect,n.z0||0));o--)n.x=d,n.y=m;n.speedinc<=0&&(n.speed=Math.hypot(n.x-d,n.y-m))}if(collisionDecor&&(clLocalVars.decorsHit&&!n.cpu&&(clLocalVars.decorsHit[collisionDecor]=!0),!(te=decorBehaviors[collisionDecor].spin)||n.tourne||n.protect||n.frminv||!h||(Z=decorBehaviors[collisionDecor].minSpeedToSpin||2.5,Math.abs(n.speed)>Z&&(loseBall(e),stopDrifting(e),n.spin(te),n.frminv=24,n.speed=2.5*Math.sign(n.speed),loseUsingItems(n)))),collisionFloor&&(q=collisionFloor.z),n.speedinc||(n.speed*=n.sliding?.95:.9),n.cannon||handleCannon(n,inCannon(d,m,n.x,n.y))&&(stopDrifting(e),n.protect=!0,n.jumped=!0,n.tourne&&(n.tourne=2),delete n.shift,n.cpu||(clLocalVars.cannons++,clSelected&&clRuleVars[clSelected.id]&&(ne=clRuleVars[clSelected.id].max_cannons)&&updateChallengeHud("cannons",clLocalVars.cannons+ne.cannons)),n.boostSound||(n.boostSound=playIfShould(n,"musics/events/boost.mp3"),n.boostSound&&(n.boostSound.onended=function(){n.boostSound=void 0,document.body.removeChild(this)}))),!n.teleport&&h){var te=inTeleport(n.x,n.y);if(te){n.aX=n.x,n.aY=n.y,n.aRotation=n.rotation,n.x=te[0],n.y=te[1],n.rotation=90*te[2],n.teleport=5,Y=!0,playIfShould(n,"musics/events/teleport.mp3"),n.speed<0&&(n.speed=0);for(o=0;o<strPlayer.length;o++)if(n.sprite[o].img.style.display="none","BB"==course)for(i=0;i<n.ballons.length;i++)n.ballons[i][o].img.style.display="none";void 0!==n.aipoint&&("BB"==course?n.aipoint=void 0:(Ye=n.aipoints[n.aipoint])&&te===inTeleport(Ye[0],Ye[1])&&(n.aipoint++,n.aipoint>=n.aipoints.length&&(n.aipoint=0)))}}if(n.sliding=void 0,!n.z){if(n.heightinc||(n.ctrled=!1,n.fell=!1,q?n.z0=q:n.z0&&delete n.z0),n.figuring&&(n.turbodrift=15,n.turbodrift0=n.turbodrift,n.driftcpt=0),handleJump(n,sauts(d,m,s,c)))n.speed=11*cappedRelSpeed(n),n.figuring=!1,n.figstate=0,n.cpu||(clLocalVars.jumps++,clSelected&&clRuleVars[clSelected.id]&&(ne=clRuleVars[clSelected.id].max_jumps)&&updateChallengeHud("jumps",clLocalVars.jumps+ne.jumps)),n.bounceSound||(n.bounceSound=playIfShould(n,"musics/events/jump.mp3"),n.bounceSound&&(n.bounceSound.onended=function(){n.bounceSound=void 0,document.body.removeChild(this)}));else{if(h&&($=0,a.checkpoint&&n.demitours&&($=a.checkpoint[(n.demitours+1)%a.checkpoint.length][3]),$=tombe(n.x,n.y,$)),$){1==$?isBattle&&simplified?($=[n.x,n.y,n.rotation],n.x>oMap.w-1?($[0]=oMap.w-50,n.y>oMap.h-1?($[1]=oMap.h-50,$[2]=225):n.y<0?($[1]=50,$[2]=315):($[1]=n.y-n.y%100+50,$[2]=270)):n.y>oMap.h-1?($[1]=oMap.h-50,n.x<0?($[0]=50,$[2]=135):($[0]=n.x-n.x%100+50,$[2]=180)):n.x<0?($[0]=50,n.y<0?($[1]=50,$[2]=45):($[1]=n.y-n.y%100+50,$[2]=90)):($[1]=50,$[0]=n.x-n.x%100+50,$[2]=0)):$=[(le=n.lastcp).x,le.y,le.rotation/90]:isNaN($[0])&&($=oMap.startposition[(n.initialPlace-1)%oMap.startposition.length]),n.aX=n.x,n.aY=n.y,n.aRotation=n.rotation,n.x=$[0],n.y=$[1],n.rotation=90*$[2],n.speed=0,n.protect=!1,n.figuring=!1,n.figstate=0,n.fell=!0,n.champi=0,delete n.champiType,delete n.champior,delete n.champior0,n.cpu&&(le&&le.aipoints===n.aipoints?n.aipoint=le.aipoint:n.aipoint=void 0),n.tombe=20,n.frminv=10,n.ctrled=!0,n.z=10,n.tourne=0,stopDrifting(e),supprArme(e),deleteUsingItems(n);for(var ne,ae=getScreenPlayerIndex(o),o=0;o<oPlayers.length;o++){if(o!=ae&&(n.sprite[o].img.style.display="none",n.sprite[o].div.style.backgroundImage="","BB"==course))for(var oe=0;oe<n.ballons.length;oe++)n.ballons[oe][0].img.style.display="none";n.etoile&&(n.sprite[o].img.src=getSpriteSrc(n.personnage))}resetPowerup(n),resetWrongWay(n),n.cpu||(clLocalVars.falls++,clSelected&&clRuleVars[clSelected.id]&&(ne=clRuleVars[clSelected.id].falls)&&updateChallengeHud("falls",clLocalVars.falls+ne.falls)),playIfShould(n,"musics/events/fall.mp3")}else n.protect||n.champi||n.figuring||!(1.5<n.speed)||n.turbodrift>.8*n.turbodrift0||!(J=ralenti(p,u))||((ie=getOffroadProps(n,J)).speed*=cappedRelSpeed(),ie.sliding&&(n.sliding=ie.sliding),n.speed>ie.speed&&(n.speed=ie.speed),stopDrifting(e)),n.tourne||(G=flowShift(p,u,n.protect)),G&&n.cpu&&100<=G[0]*G[0]+G[1]*G[1]&&(s+G[0])*s+(c+G[1])*c<0&&(n.collided=!0,n.horizontality=[G[1],-G[0]]);n.figuring=!1,n.figstate=0}if(G){n.shift||(n.shift=[0,0,0]);for(o=0;o<3;o++)n.shift[o]=.7*n.shift[o]+.3*G[o];n.shift[0]*n.shift[0]+n.shift[1]*n.shift[1]+300*n.shift[2]*n.shift[2]<.01&&delete n.shift}else delete n.shift}if(n.cpu||Y||updateSpeedometer(e,d,m),moveUsingItems(n,t),"BB"!=course){var ie=n.demitours;if(checkpoint(n,s,c)){var re=aKarts.length;n.demitours=getNextCp(n);Y=n.tours;n.tours++,collisionLap=handleCpChange(Y,ie,e);var le=a.checkpointCoords[0];a.sections&&(le=a.checkpointCoords[a.checkpointCoords.length-1]);t=1,Y=intersectionLineLine(d,m,d+s,m+c,le.A[0],le.A[1],le.B[0],le.B[1]);0<=Y[0]&&Y[0]<t&&(t=Y[0]),0<=(Y=intersectionLineLine(d,m,d+s,m+c,le.C[0],le.C[1],le.D[0],le.D[1]))[0]&&Y[0]<t&&(t=Y[0]);le=Math.round((timer+t-1)*SPF);if(n==oPlayers[0]&&!n.cpu){for(var se=0,o=0;o<lapTimers.length;o++)se+=lapTimers[o];lapTimers.push(le-se)}a=getCurrentLMap(collisionLap);ae=getScreenPlayerIndex(e);if(n.tours==oMap.tours+1){for(o=n.place=0;o<re;o++)aKarts[o].tours>oMap.tours&&n.place++;if(isOnline&&!n.finaltime&&(n.finaltime=timeTrialMode()?le:(new Date).getTime()-tnCourse),kartIsPlayer(n)&&!finishing){for(showTimer(timerMS=le),"CM"!=course&&(document.getElementById("infoPlace"+e).innerHTML=n.place);n.using.length;){var ce=bMusic,pe=iSfx;iSfx=bMusic=!1,arme(e),bMusic=ce,iSfx=pe}if(n.arme=!1,stopDrifting(e),supprArme(e),resetWrongWay(n),n.billball&&(n.billball=1),n.cpu=!0,$speedometers[e]&&($speedometers[e].style.display="none"),n.aipoint=0,n.aipoints=a.aipoints[0],n.lastAItime=0,n.maxspeed=5.7,n.maxspeed0=n.maxspeed,!oPlayers[1-e]||oPlayers[1-e].cpu){if(isOnline){var ue=document.getElementById("infos0");ue.style.left=15*iScreenScale+"px",ue.innerHTML="";Y=document.createElement("tr"),t=document.createElement("td");t.style.fontSize=8*iScreenScale+"px",t.style.color="#F80",t.innerHTML=toLanguage("&nbsp; &nbsp; FINISH !","TERMIN&Eacute; !"),Y.appendChild(t);le=document.createElement("tr"),t=document.createElement("td");t.style.fontSize=Math.round(4.5*iScreenScale+10)+"px",t.style.color="#FF0",t.innerHTML=toLanguage("&nbsp; &nbsp; &nbsp; Please wait...","Veuillez patienter..."),le.appendChild(t),ue.appendChild(Y),ue.appendChild(le),ue.style.display="",document.getElementById("infoPlace0").style.visibility="hidden",finishing=!0}else{if("CM"!=course){for(var de=getRankScores(),o=0;o<re;o++)places(o,de,!0);var me=aKarts.slice(0);me.sort(function(e,t){return e.place-t.place});for(o=0;o<re;o++)me[o].place=o+1;aPlaces=new Array;for(o=0;o<re;o++)aPlaces[o]=aKarts[o].place;var he='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",ge=(Math.round(1.25*aKarts.length),""),ye="";iTeamPlay&&(ge="; text-shadow: -1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603",ye=' style="padding: 0 '+Math.round(iScreenScale/2)+'px"');for(var fe=getPointDistribution(),o=0;o<re;o++)for(i=0;i<re;i++){var Se=aKarts[i].personnage;aKarts[i].place==o+1&&(-1===(Be=aKarts[i].team)&&(Be=0),Oe=fe[o],he+='<tr id="fJ'+o+'" style="background-color: '+rankingColor(i)+ge+'"><td>'+toPlace(o+1)+' </td><td id="j'+o+'"'+ye+">"+toPerso(Se)+'</td><td id="pts'+o+'"'+ye+">"+aScores[i]+"<small>+"+Oe+"</small></td></tr>",aScores[i]+=Oe,i=re)}he+='<tr><td colspan="3" id="continuer"></td></tr>',document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color=primaryColor,document.getElementById("infos0").innerHTML=he,handleRankingStyle(),(Ve=document.createElement("input")).type="button",Ve.id="octn",Ve.value=toLanguage("CONTINUE","CONTINUER"),Ve.style.width="100%",Ve.style.height="100%",Ve.style.fontSize=3*iScreenScale+"pt",Ve.onclick=classement,document.getElementById("continuer").appendChild(Ve),document.getElementById("infos0").style.display="";var ve=document.body.scrollTop;Ve.focus(),document.body.scrollTop=ve}else{document.getElementById("infos0").style.fontSize=5*iScreenScale+"px",document.getElementById("infos0").style.fontWeight="bold",document.getElementById("infos0").style.color="white";var be=Math.ceil(iScreenScale/4)+"px";sShadow="-"+be+" 0 "+(Ie="black")+", 0 "+be+" "+Ie+", "+be+" 0 "+Ie+", 0 -"+be+" "+Ie;for(var Ce="",xe=lapTimers[0],o=1;o<lapTimers.length;o++)xe=Math.min(xe,lapTimers[o]);for(o=0;o<lapTimers.length;o++){var Me="-"+(be=Math.ceil(iScreenScale/8)+"px")+" 0 "+(Ie=lapTimers[o]==xe?"#e99c00":"black")+", 0 "+be+" "+Ie+", "+be+" 0 "+Ie+", 0 -"+be+" "+Ie;Ce+='<div style="color:'+(lapTimers[o]==xe?"#fffdbe":"#DDD")+";text-shadow:"+Me+'">'+(o+1)+". "+timeStr(lapTimers[o])+"</div>"}document.getElementById("infos0").style.top=7*iScreenScale+10+"px",document.getElementById("infos0").innerHTML='<tr><td style="text-decoration: blink;font-family:Courier New;font-size:'+Math.round(4*iScreenScale)+"px;text-shadow:"+sShadow+'">'+document.getElementById("temps0").innerHTML+'</td></tr><tr><td id="continuer"></td></tr><tr><td style="padding-top:'+iScreenScale+";font-size:"+Math.round(2.5*iScreenScale)+'px">'+Ce+"</td></tr>",document.getElementById("infos0").style.display="",(Ve=document.createElement("input")).type="button",Ve.id="octn",Ve.value=toLanguage("CONTINUE","CONTINUER"),Ve.style.width="100%",Ve.style.height="100%",Ve.style.fontSize=3*iScreenScale+"pt",Ve.onclick=function(){document.getElementById("infos0").style.display="none";var e=document.createElement("div");e.style.color="black",e.style.position="absolute",e.style.left=5*iScreenScale+10+"px",e.style.top=5*iScreenScale+10+"px",e.style.fontSize=4*iScreenScale+"pt",e.style.backgroundColor="#FF6",e.style.opacity=.8,e.style.border="double 4px black",e.style.textAlign="center",e.style.width=70*iScreenScale-10+"px",e.style.height=25*iScreenScale-10+"px",e.style.zIndex=2e4;var t=document.createElement("p");t.innerHTML=toLanguage('Save the time to the <a href="'+rankingsLink(oMap)+'" target="_blank" style="color: orange">record list</a> ?','Enregistrer le temps dans la <a href="'+rankingsLink(oMap)+'" target="_blank" style="color: orange">liste des records</a> ?'),t.style.margin=iScreenScale+"px";var n=t.cloneNode(!1),a=document.createElement("input");a.type="button",a.value="  "+toLanguage("Yes","Oui")+"  ",a.style.marginRight=iScreenScale+"px",a.style.fontSize=4*iScreenScale+"px",a.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",o.style.fontSize=4*iScreenScale+"px"},a.onclick=function(){$mkScreen.removeChild(e),continuer(),document.getElementById("enregistrer").getElementsByTagName("input")[0].onclick()},n.appendChild(a);var o=document.createElement("input");o.type="button",o.value="  "+toLanguage("No","Non")+"  ",o.style.fontSize=4*iScreenScale+"px",o.style.marginLeft=iScreenScale+"px",o.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",a.style.fontSize=4*iScreenScale+"px"},o.onclick=function(){$mkScreen.removeChild(e),document.getElementById("infos0").style.display="",continuer()},n.appendChild(o),e.appendChild(t),e.appendChild(n),$mkScreen.appendChild(e),(gRecord<=timerMS?o:a).focus()},document.getElementById("continuer").appendChild(Ve),document.getElementById("infos0").style.display="",Ve.focus()}handleEndRace()}resetEvents(),window.onbeforeunload=logGameTime}}else onlineSpectatorId&&!finishing&&ae<oPlayers.length&&(document.getElementById("infoPlace0").style.visibility="hidden");oMap.sections&&1<n.billball&&(n.billball=1)}else if(!(isOnline?ae||finishing:n.cpu)&&(updateLapHud(ae),!onlineSpectatorId)){if(document.getElementById("lakitu"+ae).getElementsByTagName("div")[0].innerHTML=(oMap.sections?"Sec":toLanguage("Lap","Tour"))+"<small>&nbsp;</small>"+n.tours,n.time=40,bMusic||iSfx)if(n.tours==oMap.tours){for(var Pe,ke=!0,o=0;o<oPlayers.length;o++)if(oPlayers[o]!=n&&3<=oPlayers[o].tours){ke=!1;break}ke&&(Pe=postStartMusic("musics/events/lastlap.mp3"),iSfx&&(fadeOutMusic(carEngine,1,.6,-1,vSfx),fadeOutMusic(carEngine2,1,.6,-1,vSfx)),Pe.removeAttribute("loop"),setTimeout(function(){if(bMusic){if(willPlayEndMusic||isEndMusicPlayed)return;document.body.contains(Pe)?(document.body.removeChild(Pe),startMapMusic(!0)):lastMapMusic?(startMapMusic(!0),forceStartMusic=!0):oMap.lastMapSpeed||fastenMusic(mapMusic)}iSfx&&(carEngine.volume=vSfx,carEngine2.volume=vSfx)},2700),lastMapMusic&&(mapMusic!==lastMapMusic&&(removeIfExists(mapMusic),mapMusic=lastMapMusic),bufferMusic(lastMapMusic)))}else iSfx&&playSoundEffect("musics/events/nextlap.mp3");if(timeTrialMode()){oLapTimeDiv&&oContainers[0].removeChild(oLapTimeDiv),(oLapTimeDiv=document.createElement("div")).style.position="absolute",oLapTimeDiv.style.zIndex=2e4,oLapTimeDiv.style.left=Math.round(iScreenScale*iWidth/2)+"px",oLapTimeDiv.style.top=Math.round(iScreenScale*iHeight/2)+"px",oLapTimeDiv.style.textAlign="center",oLapTimeDiv.style.transform=oLapTimeDiv.style.WebkitTransform=oLapTimeDiv.style.MozTransform="translate(-50%, -100%)";ue=document.createElement("div");ue.className="lap-time",ue.innerHTML=timeStr(lapTimers[lapTimers.length-1]),ue.style.fontSize=4*iScreenScale+"px",ue.style.fontFamily="Courier New",ue.style.color="#DDD";var be=Math.ceil(iScreenScale/4)+"px",Ie="black";if(ue.style.textShadow="-"+be+" 0 "+Ie+", 0 "+be+" "+Ie+", "+be+" 0 "+Ie+", 0 -"+be+" "+Ie,oLapTimeDiv.appendChild(ue),iLapTimes){for(var we=0,o=0;o<lapTimers.length;o++)we+=lapTimers[o]-iLapTimes[o];ue=document.createElement("div");ue.innerHTML=(0<=we?"+":"-")+" "+timeStr(Math.abs(we)),ue.style.fontSize=Math.round(2.5*iScreenScale)+"px",ue.style.fontFamily="Courier New",ue.style.color=0<=we?"#FDD":"#DFD",be=Math.ceil(iScreenScale/8)+"px",Ie=0<=we?"#C00":"#0A0",ue.style.textShadow="-"+be+" 0 "+Ie+", 0 "+be+" "+Ie+", "+be+" 0 "+Ie+", 0 -"+be+" "+Ie,oLapTimeDiv.appendChild(ue)}oContainers[0].appendChild(oLapTimeDiv)}}}else n.demitours!==ie&&(collisionLap=handleCpChange(n.tours,ie,e),a=getCurrentLMap(collisionLap));n.demitours===ie||tombe(n.x,n.y)||(n.lastcp={x:n.x,y:n.y,rotation:n.rotation,aipoint:n.aipoint,aipoints:n.aipoints})}else if(!isOnline){if(!oPlayers[0].loose||oPlayers[1]&&!oPlayers[1].loose)if(1<aKarts.length)if(iTeamPlay){var Le=new Array(selectedNbTeams).fill(!1),Te=0;for(o=0;o<aKarts.length;o++)aKarts[o].loose||(aKarts[o].cpu||(U=aKarts[o]),Le[Be=aKarts[o].team]||(Le[Be]=!0,Te++));1<Te&&(U=void 0)}else{Le=!1;for(o=0;o<aKarts.length;o++)aKarts[o].loose||(Le?(U=void 0,o=aKarts[o].length):(Le=!0,U=aKarts[o]))}else oPlayers[0].losing&&delete(U=oPlayers[0]).losing;else{for(i=0;i<1e4&&(U=aKarts[Math.floor(Math.random()*(aKarts.length-strPlayer.length))+strPlayer.length]).loose;i++);for(o=strPlayer.length;o<aKarts.length;o++)aKarts[o].loose=!0}if(U){for(clLocalVars.gagnant=U,o=0;o<strPlayer.length;o++)stopDrifting(o),supprArme(o);var he='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",Ee="",De=1,ge="",ye="";iTeamPlay&&(ge="; text-shadow: -1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603",ye=' style="padding: 0 '+Math.round(iScreenScale/2)+'px"');for(var Be,o=0;o<aKarts.length;o++){-1===(Be=aKarts[o].team)&&(Be=0);var Oe=aKarts[o]==U,Se=aKarts[o].personnage,ze=Oe?0:De,ze='<tr id="fJ'+ze+'" style="background-color:'+rankingColor(o)+ge+'"><td>'+toPlace(ze+1)+' </td><td id="j'+ze+'"'+ye+">"+toPerso(Se)+'</td><td id="pts'+ze+'"'+ye+">"+aScores[o]+(Oe?"<small>+1</small>":"")+"</td></tr>";Oe?Ee=ze+Ee:(Ee+=ze,De++),aScores[o]+=Oe}he+=Ee,he+='<tr><td colspan="3" id="continuer"></td></tr>',document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color=primaryColor,document.getElementById("infos0").innerHTML=he,handleRankingStyle(),(Ve=document.createElement("input")).type="button",Ve.id="octn",Ve.value=toLanguage("CONTINUE","CONTINUER"),Ve.style.width="100%",Ve.style.height="100%",Ve.style.fontSize=3*iScreenScale+"pt",Ve.onclick=classement,document.getElementById("continuer").appendChild(Ve),document.getElementById("infos0").style.display="";ve=document.body.scrollTop;for(Ve.focus(),document.body.scrollTop=ve,o=0;o<aKarts.length;o++)aKarts[o].loose=!0;handleEndRace(),resetEvents(),window.onbeforeunload=logGameTime}}if(n.cpu){if("BB"==course)n.maxspeed=5.7;else{var He=oPlayers[0].place,Re=oPlayers.length,Ae=aKarts.length-1-Re,Ne=e-Re,_e=aKarts[Re];if(isOnline){Ae=-1,_e=null;for(o=Ne=Re=0;o<aKarts.length;o++)aKarts[o].controller?(o<e&&Ne++,_e=_e||aKarts[o],Ae++):(Re++,aKarts[o].place<He&&(He=aKarts[o].place))}var Ve=iDificulty,ve=1;0<Ae&&(_e.place<n.place&&_e.place<He?((Fe=n.distToFirstCache)?(n.distToFirstTtl--,n.distToFirstTtl<=0&&(n.distToFirstCache=0)):(Fe=distanceToKart(n,_e),n.distToFirstCache=Fe,n.distToFirstTtl=15+Math.floor(15*Math.random())),Ne=1/(1+Fe/(42*Ae))*(1+Ne)-1):n.distToFirstCache=0,ve=Math.pow(.96,6*(Ne/Ae-.5))),Ve*=ve*iDificulty/5;var Fe=1.25;4.75<iDificulty&&8<aKarts.length&&(Fe*=Math.log(1+100*aKarts.length/8)/5.5),n.maxspeed0>Ve*Fe?n.maxspeed0=Ve*Fe:n.maxspeed0<Ve&&(n.maxspeed0=Ve),n.place<=He?n.maxspeed0-=(n.maxspeed0*ve-Ve*sizeSpeedRatio(n)*fSelectedClass)/100:n.maxspeed0+=(Ve*Fe*1.12*sizeSpeedRatio(n)*fSelectedClass-n.maxspeed0*ve)/100}n.maxspeed=n.maxspeed0}else n.maxspeed=5.4*n.stats.speed;if(n.turbodrift&&(Xe=8,15<n.turbodrift&&(Xe+=Math.pow(2*(n.turbodrift-15)/(15*sizeSpeedRatio(n)),2),n.turbodrift--,n.turbodrift0--),n.speed>-Xe&&(n.maxspeed=Xe,n.speed=Math.max(Xe*cappedRelSpeed(n),n.speed)),n.turbodrift--),n.champi&&(n.maxspeed=11,n.champi--,n.champi||delete n.champiType),n.billball){if(n.z=2,n.heightinc=0,n.speed=Math.min(30,13*cappedRelSpeed()),null!=n.aipoint)(Ye=n.aipoints[n.aipoint])?(X=Ye[0]-n.x)*X+(Ke=Ye[1]-n.y)*Ke<2e3&&(inTeleport(Ye[0],Ye[1])||(n.aipoint++,n.aipoint>=n.aipoints.length&&(n.aipoint=0))):Ke=X=0;else{var je=n.demitours+1;je>=a.checkpoint.length&&(je=0);var Ke=(Ge=a.checkpointCoords[je])?(X=Ge.O[0]-n.x,Ge.O[1]-n.y):X=0,We=a.aipoints;a.airoutesmeta.cpu<We.length&&(We=We.slice(a.airoutesmeta.cpu));e:for(o=0;o<We.length;o++)for(var qe=We[o],i=0;i<qe.length;i++){var Ge=qe[i];if(n.x>Ge[0]-35&&n.x<Ge[0]+35&&n.y>Ge[1]-35&&n.y<Ge[1]+35){var Je=i+1;Je==qe.length&&(Je=0);var w=qe[Je][0],L=qe[Je][1],$e=n.rotation*Math.PI/180,Ue=Math.abs(normalizeAngle(Math.atan2(w-n.x,L-n.y)-$e,2*Math.PI)),$e=Math.abs(normalizeAngle(Math.atan2(X,Ke)-$e,2*Math.PI));if(Ue<Math.max($e,Math.PI/4)){n.aipoints=qe,n.aipoint=Je,X=w-n.x,Ke=L-n.y;break e}}}}var Xe=X*direction(1,n.rotation)-Ke*direction(0,n.rotation),Ye=X*direction(0,n.rotation)+Ke*direction(1,n.rotation),je=Math.atan2(Xe,Ye)/Math.PI*180,Xe=Math.abs(je),Ye=Math.max(15,15/cappedRelSpeed());Ye<Xe&&(je=60<Xe?(n.speed=Math.min(n.speed,200/Xe),0<je?30:-30):0<je?Ye:-Ye),n.rotation+=je,n.rotation=n.rotation%360,n.billball--;var Qe;if((n.billjump?n.billjump<4&&n.billball<6:n.billball<12)&&(s=n.speed*direction(0,n.rotation),c=n.speed*direction(1,n.rotation),Qe=!n.cpu&&a.airoutesmeta.cpu<a.aipoints.length,(sauts(n.x,n.y,s,c)||n.billball<6&&(tombe(n.x,n.y)||tombe(n.x+s,n.y+c)||Qe&&ralenti(n.x,n.y)))&&(n.cannon||(n.billball0=Math.floor(12*n.billball0/n.billball),n.billball=12,n.billjump=(n.billjump||0)+1))),!n.billball){for(o=0;o<strPlayer.length;o++)n.sprite[o].img.src=getSpriteSrc(n.personnage),resumeSpriteSize(n.sprite[o]);n.size=1,n.mini=0,n.cannon||(n.z=0),n.jumped=!1,delete n.billjump,delete n.billball0,consumeItem(e),updateProtectFlag(n),n.cpu||delete n.aipoint}updateItemCountdownHud(e,n.billball/n.billball0)}if(n.champior&&(n.champior--,n.champior<=0&&(delete n.champior,delete n.champior0,consumeItem(e)),updateItemCountdownHud(e,n.champior/n.champior0)),n.etoile&&(n.maxspeed+=2,n.etoile--,n.etoile<15)){for(var Ze,o=0;o<strPlayer.length;o++)n.sprite[o].img.src=(n.etoile%2?getStarSrc:getSpriteSrc)(n.personnage);n.etoile||(updateProtectFlag(n),Ze=n.cpu?1:n.stats.acceleration*n.size*fSelectedClass,n.speedinc=Math.min(n.speedinc,Ze),stopStarMusic(n))}if(n.megachampi&&(n.megachampi--,71<n.megachampi?n.size*=1.05:n.megachampi<8&&(n.size/=1.05,n.megachampi||(updateProtectFlag(n),stopMegaMusic(n)))),n.mini&&(n.mini--,n.mini<1&&(n.mini=0,h&&(n.size=1))),n.cannon&&(Qe=3*Math.pow(cappedRelSpeed(n),-2),n.speed=(n.speed*Qe+20)/(1+Qe),n.billball&&(n.speed=20),n.maxspeed=n.speed/(sizeSpeedRatio(n)*fSelectedClass),n.speedinc||(n.speedinc=.01),n.z=(3*n.z+4)/4,n.heightinc=0,n.rotinc=0,Ze=n.cannon[2]-n.x,h=n.cannon[3]-n.y,tt=n.cannon[0]-n.cannon[2],Qe=n.cannon[1]-n.cannon[3],tt=Math.hypot(tt,Qe),(Qe=Math.hypot(Ze,h)/tt)<.2?(Ze=n.cannon[0]-n.x,h=n.cannon[1]-n.y,n.rotation=nearestAngle(180*Math.atan2(Ze,h)/Math.PI,n.rotation,360)):tt-40<=Qe*tt&&(Math.abs(n.speedinc)<=.01&&(n.speedinc=0),delete n.cannon,n.fell=!0,updateProtectFlag(n))),!n.z&&(!n.heightinc||fSelectedClass<=1)&&accelere(d,m,s,c)&&(n.champi||(n.champiType=CHAMPI_TYPE_BOOST),n.champi=20,n.maxspeed=11,n.speed=n.maxspeed*cappedRelSpeed(n),n.boostSound||(n.boostSound=playIfShould(n,"musics/events/boost.mp3"),n.boostSound&&(n.boostSound.onended=function(){n.boostSound=void 0,document.body.removeChild(this)}))),!iSfx||n!=oPlayers[0]||finishing||n.cpu||n.loose&&!isOnline||(bMusic&&(n.etoile||n.megachampi)||n.tombe||n.turbodrift||n.turboSound?(updateEngineSound(),n.turbodrift==n.turbodrift0-1&&(carEngine3.currentTime=0,carEngine3.volume=vSfx,carEngine3.play(),n.turboSound=carEngine3,clearTimeout(n.turboHandler),n.turboHandler=setTimeout(function(){n.turboSound&&(n.turboSound.pause(),n.turboSound=void 0)},2e3),n.sparkSound&&(fadeOutMusic(n.sparkSound,1,.8,!1,vSfx),n.sparkSound=void 0)),bMusic&&n.protect&&n.turboSound&&(n.turboSound.volume=0)):updateEngineSound(3<n.speed?carEngine2:carEngine)),"BB"==course&&!n.ballons.length&&!n.tourne&&!n.loose){for(var et=n.sprite[0].div.style.opacity-.1,o=0;o<strPlayer.length;o++)n.sprite[o].div.style.opacity=et,n.driftSprite[o].div.style.opacity=et;var tt=isOnline&&(n==oPlayers[0]||onlineSpectatorId);if(et<(tt?.4:.01)){if(tt){if(onlineSpectatorId&&n.marker)for(o=0;o<strPlayer.length;o++)n.marker.div[o].style.display="none"}else for(o=0;o<strPlayer.length;o++)n.sprite[o].img.style.display="none",n.driftSprite[o].img.style.display="none",n.marker&&(n.marker.div[o].style.display="none");1<aKarts.length?n.loose=!0:n.losing=!0,challengeCheck("each_kill")}}}}function kartIsPlayer(e){return isOnline?!onlineSpectatorId&&e==oPlayers[0]:!e.cpu}Math.hypot||(Math.hypot=function(e,t){return Math.sqrt(e*e+t*t)});var getPlayerAtScreen=function(e){return oPlayers[e]},getScreenPlayerIndex=function(e){return e};function isControlledByPlayer(t){var e=aKarts.find(function(e){return e.id==t});return e&&(e.id==identifiant||e.controller==identifiant)}function timeTrialMode(){return"CM"==course||!!(isOnline&&shareLink.options&&shareLink.options.timeTrial)}function handleDriftCpt(e){var t=aKarts[e];if(t.driftinc){if(t.rotincdir&&(0<t.rotincdir==0<t.driftinc?(t.drift+=t.driftinc,0<t.driftinc?6<t.drift?t.drift=6:t.drift<0&&(t.drift=Math.ceil(t.drift/2)):t.drift<-6?t.drift=-6:0<t.drift&&(t.drift=Math.floor(t.drift/2))):0<t.rotincdir?(t.drift++,0<t.drift&&(t.drift=0)):(t.drift--,t.drift<0&&(t.drift=0))),t.driftcpt<fTurboDriftCpt2){e=t.driftcpt;if(t.rotincdir?0<t.rotincdir==0<t.driftinc?t.driftcpt+=6*Math.max(.7,Math.pow(Math.abs(t.rotincdir)/.6,.8)):t.driftcpt++:t.driftcpt+=2,t.driftcpt>=fTurboDriftCpt2){for(var n=0;n<oPlayers.length;n++)t.driftSprite[n].setState(2);carSpark&&t===oPlayers[0]&&(carSpark.currentTime=0,carSpark.volume=vSfx,carSpark.play(),t.sparkSound=carSpark)}else if(e<fTurboDriftCpt&&t.driftcpt>=fTurboDriftCpt){for(n=0;n<oPlayers.length;n++)t.driftSprite[n].setState(1);carSpark&&t===oPlayers[0]&&(carSpark.currentTime=0,carSpark.volume=.7*vSfx,carSpark.play(),t.sparkSound=carSpark)}}}else t.drift&&(t.drift<0?t.drift=Math.min(0,t.drift+1):0<t.drift&&(t.drift=Math.max(0,t.drift-1)))}function angleDrift(e){return e.sliding&&kartIsPlayer(e)?e.rotinc*e.sliding:6*e.drift}function angleInc(e){return(e.rotinc+1.5*(e.driftinc||0))*(e.speedinc<0||0==e.speedinc&&e.speed<0?-1:1)*Math.abs(Math.cos(angleDrift(e)*Math.PI/180))}function angleShoot(e,t){e=e.rotation;return t&&(e+=180),e}function dirShoot(e,t,n){var a=t?[0,0]:kartInstantSpeed(e),t=angleShoot(e,t);return a[0]+=n*direction(0,t),a[1]+=n*direction(1,t),a}function tendsToSpeed(e,t,n){var a=Math.hypot(e.vx,e.vy);a&&(n=a*(1-n)+t*n,e.vx*=n/a,e.vy*=n/a)}function kartInstantSpeed(e){var t=e.rotation-angleDrift(e),n=e.speed*direction(0,t),t=e.speed*direction(1,t);return e.shift&&(n+=e.shift[0],t+=e.shift[1]),[n,t]}function handleExplosionHit(e,t){var n=aKarts[e];loseBall(e),n.spin(t),loseUsingItems(n),stopDrifting(e),84<=t&&(n.champi=0,delete n.champiType,n.speed=0,n.heightinc=3,supprArme(aKarts.indexOf(n)))}function handleHardHit(e){var t=aKarts[e];loseBall(e),stopDrifting(e),t.spin(42),loseUsingItem(t)}function handleSoftHit(e){var t=aKarts[e];loseBall(e),stopDrifting(e),t.spin(20),loseUsingItem(t)}function handlePoisonHit(e){var t=aKarts[e];loseBall(e),stopDrifting(e),t.spin(20),loseUsingItems(t),t.size=.6,t.mini=Math.max(t.mini,60)}function handleDecorExplosions(r,l){foreachLMap(function(e,t){if(t.decor)for(var n in e.decor){var a=decorBehaviors[n];if(a.damagingItems&&a.damagingItems[r.type])for(var o=0;o<e.decor[n].length;o++){var i=e.decor[n][o];l(i[0],i[1],r)&&handleDecorHit(o,n)}}})}var oRoulettesPrefixes=["","2"],oArmeKeys=["arme","stash"],clLocalVars,clHud,clSelected;function updateObjHud(e){for(var t=aKarts[e],n=0;n<oRoulettesPrefixes.length;n++){var a=oRoulettesPrefixes[n],o=t[oArmeKeys[n]],i=!1,r=!1;o&&(t["roulette"+a]<25?r=!0:i=!0);var l=n?2.5:4;document.getElementById("scroller"+a+e).style.visibility=r?"visible":"hidden",document.getElementById("roulette"+a+e).innerHTML=i?'<img alt="'+o+'" class="pixelated" src="images/items/'+o+'.png" style="height: '+Math.round(iScreenScale*l)+'px;" />':""}var s=document.getElementById("scroller"+e),c=document.getElementById("objet"+e);t.stash?(document.getElementById("reserve"+e).style.visibility="visible",c.style.left=Math.round(3*iScreenScale)+"px",c.style.top=Math.round(3*iScreenScale)+"px",s.style.left=Math.round(3*iScreenScale)+"px",s.style.top=Math.round(3*iScreenScale+ +iScreenScale)+"px"):(document.getElementById("reserve"+e).style.visibility="hidden",c.style.left=Math.round(iScreenScale)+"px",c.style.top=Math.round(iScreenScale)+"px",s.style.left=iScreenScale+"px",s.style.top=Math.round(iScreenScale+ +iScreenScale)+"px")}function updateItemCountdownHud(e,t){var n,a,o,i,r,l=document.getElementById("countdown"+e);l&&(0<t?(l.style.display="block",n=8.5*iScreenScale,a=6.25*iScreenScale,o=Math.atan2(a,n),r=.2+t*((i=2*Math.PI)-.2)+o,e=n/2-n*Math.cos(r),t=a/2-a*Math.sin(r),t=[[0,0],[iScreenScale,0],[Math.round(2.5*iScreenScale),2*iScreenScale],[n/2,a/2],[e,t]],i-o<r&&t.push([0,a]),r>i-Math.PI+o&&t.push([n,a]),r>i-Math.PI-o&&t.push([n,0]),l.style.clipPath="polygon("+t.map(function(e){return e[0]+"px "+e[1]+"px"}).join(", ")):(l.style.display="none",l.style.clipPath=""))}function updateLapHud(e){for(var t=getPlayerAtScreen(e),n=document.querySelectorAll("#compteur"+e+" .tour"),a=0;a<n.length;a++)n[a].innerHTML=Math.min(t.tours,oMap.tours)}function timeStr(e){var t=Math.floor(e/6e4);e-=6e4*t,t+="";var n=Math.floor(e/1e3);for(e-=1e3*n,(n+="").length<2&&(n="0"+n),e+="";e.length<3;)e="0"+e;return t+"'"+n+"&quot;"+e}function updateSpeedometer(e,t,n){var a;$speedometerVals[e]&&(a=aKarts[e],n=10*Math.hypot(a.x-t,a.y-n),a.speed<0&&(n=-n),a.tombe&&(n=0),$speedometerVals[e].innerHTML=n.toFixed(1))}function handleWrongWay(e){var t=getCurrentLMap(collisionLap);if(t.checkpoint&&!isCup&&!onlineSpectatorId){for(var n=!0,a=!1,o=1;o<=t.checkpointCoords.length;o++){var i=(e.demitours+o)%t.checkpointCoords.length,r=t.checkpointCoords[i],l=projete(e.x,e.y,r.O[0],r.O[1],r.O[0]+r.u[0],r.O[1]+r.u[1]),s=r.O[0]+l*r.u[0],l=r.O[1]+l*r.u[1],s=Math.atan2(s-e.x,l-e.y),l=Math.atan2(r.O[0]-e.x,r.O[1]-e.y),r=e.rotation*Math.PI/180,r=(Math.abs(nearestAngle(s-r,0,2*Math.PI))+Math.abs(nearestAngle(l-r,0,2*Math.PI)))/2;if(r<.6*Math.PI&&(n=!1,r<.45*Math.PI)){a=!0;break}if(!t.checkpoint[i][4])break}if(e.wrongWaySince)if(e.rightWaySince)e.rightWaySince++,10<e.rightWaySince&&resetWrongWay(e);else{if(e.wrongWaySince++,10<e.wrongWaySince&&!e.wrongWaySprite){e.wrongWaySprite=new Sprite("wrongway");for(var c=0;c<oPlayers.length;c++){var p=e.wrongWaySprite[c];p.nbSprites=2,p.w=36,p.h=32}!e.wrongWaySound&&shouldPlaySound(e)&&(e.wrongWaySound=loadMusic("musics/events/wrongway.mp3",!0),document.body.appendChild(e.wrongWaySound))}a&&(e.rightWaySince=1,removeIfExists(e.wrongWaySound))}else!n||e.tombe||e.tourne||(e.wrongWaySince=1)}}function resetWrongWay(e){delete e.wrongWaySince,delete e.rightWaySince,e.wrongWaySprite&&(e.wrongWaySprite[0].suppr(),delete e.wrongWaySprite),removeIfExists(e.wrongWaySound),delete e.wrongWaySound}function openCheats(){var e=prompt("MKPC Console command");e&&(processCode(e)?(clLocalVars.cheated=!0,clSelected&&challengeHandleFail()):alert("Invalid command"))}function processCode(e){if("/"==e.charAt(0)){e=e.substring(1);var t=oPlayers[0],n=/^give (\w+)$/g.exec(e);if(n){var a=n[1],o=!1,i=getItemMode(),r=itemDistributions[i].concat(customItemDistrib[i]);e:for(var l=0;l<r.length;l++)for(var s=r[l],c=0;c<s.value.length;c++)if(null!=s.value[c][a]){o=!0;break e}return o?(t.billball?(t.stash=a,t.roulette2=25):(t.arme=a,t.roulette=25),updateObjHud(0),1):void 0}i=/^tp ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e);if(i=i||/^tp ([\d\-+\.]+) ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e)){var p=parseFloat(i[1]),u=parseFloat(i[2]);if(isNaN(p)||isNaN(u))return;var d=parseFloat(i[3]);return t.x=p,t.y=u,isNaN(d)||(t.rotation=d),resetRenderState(),1}i=/^lap(?: ([1-3]|c))?(?: (\d+|c))?$/g.exec(e);if(i){p=parseInt(i[1]),u=parseInt(i[2]);if("c"==i[1]&&(p=t.tours),i[1]||(p=oMap.tours,u=(m=getCurrentLMap({tours:p,demitours:0})).checkpoint.length),0<u&&u--,"c"==i[2]&&(u=t.demitours),i[2]||(u=(m=getCurrentLMap(getCurrentLapId(t))).checkpoint.length-1),isNaN(p)||isNaN(u))return;d=t.tours,i=t.demitours;t.tours=p,t.demitours=u;var m,p=(m=getCurrentLMap(t)).checkpointCoords[u];return p&&"lap"!==e&&(m=m.checkpointCoords[(u+1)%m.checkpointCoords.length],t.x=p.O[0],t.y=p.O[1],t.rotation=180*Math.atan2(m.O[0]-p.O[0],m.O[1]-p.O[1])/Math.PI),updateLapHud(0),handleCpChange(d,i,0),1}if("pos"==e)return alert("x: "+Math.round(t.x)+"\ny: "+Math.round(t.y)+"\ntheta: "+Math.round(t.rotation)),1;if("xs"==e)return t.size=.6,t.mini=0,1;if("md"==e)return t.size=1,t.mini=0,1;if("xl"==e)return t.size=Math.pow(1.05,8),t.mini=0,1;if("BB"==course){"balloon"==e&&(e+=" 1");e=/^balloon (\d+)$/g.exec(e);if(e){e=parseInt(e[1]);if(e)return t.reserve+=e,updateBalloonHud(document.getElementById("compteur0"),t),1}}}}function distToAiPoints(e,t,n){for(var a=1/0,o=0;o<n.length;o++){var i=(o+1)%n.length,r=n[o][0],l=n[o][1],s=n[i][0],c=n[i][1],i=projete(e,t,r,l,s,c);i<0&&(i=0),1<i&&(i=1);r=r+(s-r)*i,i=l+(c-l)*i,a=Math.min(a,(r-e)*(r-e)+(i-t)*(i-t))}return a}function distToNextShortcut(e){var t=e.aipoint,n=e.aipoints[t];if(!n)return 1/0;for(var a=Math.hypot(n[0]-e.x,n[1]-e.y);;){if(e.aishortcuts[t]&&hasShortcutItem(e,e.aishortcuts[t])&&!hasExtraShortcutItem(e,e.aishortcuts[t]))return a;var o=t+1;if(o>=e.aipoints.length){if(oMap.sections||e.tours>=oMap.tours)return 1/0;o=0}var i=e.aipoints[o];if(a+=Math.hypot(i[0]-n[0],i[1]-n[1]),t=o,n=e.aipoints[t],t==e.aipoint)return 1/0}}function hasShortcutItem(e,t){return!e.using.length&&(25==e.roulette&&isShortcutItem(e.arme,t))}function isShortcutItem(e,t){return isShortcutItemKey(e,t)}function isShortcutItemKey(e,t){return!!e&&(!t||t[2].itemsDict[e])}function hasExtraShortcutItem(e,t){if(25==e.roulette2&&isShortcutItem(e.stash,t))return 1;if(isShortcutItemKey("champi",t))switch(e.arme){case"champiX2":case"champiX3":return 1;case"champior":if(e.champior)return 1}}var fMaxRotInCp=10,nextBlueShellCooldown,nextPowCooldown;function ai(d){var e=isBattle&&simplified,t=isBattle&&complete,n=!isBattle&&complete;if(null==d.aipoint)if(delete d.aishortcut,"BB"!=course)for(var a=1/0,o=0;o<d.aipoints.length;o++){var i=(M=d.aipoints[o])[0]-d.x,r=M[1]-d.y;(x=2*(C=Math.sqrt(i*i+r*r))+C*Math.abs(nearestAngle(Math.atan2(i,r)-d.rotation*Math.PI/180,0,2*Math.PI)))<a&&(d.aipoint=o,d.lastAItime=0,a=x)}else e&&(d.aipoint=Math.floor(d.x/100)+6*Math.floor(d.y/100),d.lastAItime=0,d.lastAI=-1);if(!d.billball&&!d.tombe){if(oMap.sections&&d.tours>oMap.tours||d.ballons&&!d.ballons.length&&!d.loose)return d.speedinc=0,d.rotinc=0,void(d.rotincdir=0);if(d.tourne)return d.speedinc=!d.z&&1<d.speed?1:0,d.rotinc=0,void(d.rotincdir=0);if(d.aipoints.length){var l=0,s=2*Math.PI,c=0;collisionLap=getCurrentLapId(d);for(var p=0;p<d.aipoints.length;p++){var u,m,h,g,y=d.aipoint;if("BB"!=course)null==d.aishortcut||d.aishortcuts[d.aipoint]||delete d.aishortcut,null!=d.aishortcut?(B=(D=d.aishortcuts[d.aipoint])[0],h=0<d.aishortcut&&d.aishortcut<=B.length?B[d.aishortcut-1]:d.aipoints[y],d.aishortcut<B.length?(u=B[d.aishortcut],d.aishortcut+1<B.length?m=B[d.aishortcut+1]:g=D[1]):(y=D[1],u=d.aipoints[y],g=y+1),null!=g&&(g>=d.aipoints.length&&(g=0),m=d.aipoints[g])):((T=y-1)<0&&(T+=d.aipoints.length),(g=y+1)>=d.aipoints.length&&(g=0),h=d.aipoints[T],u=d.aipoints[y],m=d.aipoints[g]);else if(e){h=[d.lastAI%6*100+50,100*Math.floor(d.lastAI/6)+50],u=[d.aipoint%6*100+50,100*Math.floor(d.aipoint/6)+50],m=[h[0]+2*(u[0]-h[0]),h[1]+2*(u[1]-h[1])];var f=Math.floor(d.x/100)+6*Math.floor(d.y/100);if(f!=d.lastAI){var S=!0;if(0<=d.speed&&!d.tombe){var v=(u[0]-d.x)*(u[0]-d.x)+(u[1]-d.y)*(u[1]-d.y);switch(oMap.skin){case 27:S=v<1500;break;case 48:S=v<900}}if(S){(P=d.aipoints[f])&&P.length||(P=[],f%6&&P.push(f-1),f%6<5&&P.push(f+1),6<=f&&P.push(f-6),f<30&&P.push(f+6),-1!=(E=P.indexOf(d.lastAI))&&P.splice(E,1));var b=d.lastAI;for(d.lastAI=f;d.aipoint=P[Math.floor(Math.random()*P.length)],b==d.aipoint&&1<P.length;);}d.nextAiStop=void 0,d.randShift=void 0}}else{if(null==d.aipoint){d.lastAI=void 0,d.nextAI=void 0;for(var C,x,a=1/0,o=0;o<d.aipoints.length;o++)o!=d.lastAI&&0==(M=d.aipoints[o])[0]&&(i=M[1]-d.x,r=M[2]-d.y,(x=2*(C=Math.sqrt(i*i+r*r))+C*Math.abs(nearestAngle(Math.atan2(i,r)-d.rotation*Math.PI/180,0,2*Math.PI)))<a&&(d.aipoint=o,d.lastAItime=0,a=x))}if(u=d.aipoints[d.aipoint].slice(1),h=d.lastAI?d.aipoints[d.lastAI].slice(1):(d.lastAIpt||(d.lastAIpt=[d.x,d.y]),d.lastAIpt),void 0===d.nextAI){for(var M,P=new Array,o=0;o<d.aipoints.length;o++)1==(M=d.aipoints[o])[0]&&(M[1]==d.aipoint?P.push(M[2]):M[3]||M[2]!=d.aipoint||P.push(M[1]));if(P.length)for(;d.nextAI=P[Math.floor(Math.random()*P.length)],d.lastAI==d.nextAI&&1<P.length;);else d.nextAI=-1}m=-1!=d.nextAI?d.aipoints[d.nextAI].slice(1):h}d.speedinc=1,d.lastAItime++;var k=u[0]-h[0],I=u[1]-h[1],w=Math.hypot(k,I),L=m[0]-u[0],T=m[1]-u[1],y=fMaxRotInCp*Math.PI/180,E=t?15:20;d.nextAiStop||(d.nextAiStop=nextAiStop(h[0],h[1],k,I,u[0],u[1],L,T,d.maxspeed/y),O=1-50/w,d.nextAiStop<O&&(d.nextAiStop=O)),d.randShift||(d.randShift=10*Math.random()-5,null!=oMap.randshift&&(d.randShift*=oMap.randshift),t?d.randShift/=1.5:!n&&null==d.aishortcut||(N=w/10,Math.abs(d.randShift)>N&&(d.randShift=N*Math.sign(d.randShift))));var D,B,f=projete(d.x,d.y,h[0],h[1],u[0],u[1]),L=h[0]+f*(u[0]-h[0]),T=h[1]+f*(u[1]-h[1]),O=Math.hypot(d.x-L,d.y-T);if(k||I||(O=0,d.nextAiStop=0,f=1),!(f>=d.nextAiStop&&O<E)||e){var z,H,R,A,N=!1;if(d.bounced)d.bouncedsince?d.rotinc=0:d.rotinc=fMaxRotInCp*Math.random(),d.bouncedsince++,10==d.bouncedsince&&(delete d.bouncedsince,delete d.bounced),N=!0;else if(d.collided)delete d.recovering,delete d.minDecor,d.recovertime||(d.recovertime=21+Math.floor(10*Math.random())),d.collidesince?d.collidesince>d.recovertime&&(d.randShift=Math.random()*d.recovertime/2-d.recovertime/4,d.recovertime+=30,d.decision=-d.decision,d.collidesince=1,e&&(d.lastAI=d.aipoint)):(d.collidesince=1,d.decision||(z=direction(0,d.rotation),H=direction(1,d.rotation),R=d.horizontality[0],A=d.horizontality[1],d.decision=0<z*R+H*A!=0<z*A-H*R?1:-1)),d.collidesince++,d.horizontality?(z=direction(0,d.rotation),H=direction(1,d.rotation),R=d.horizontality[0],A=d.horizontality[1],(.1<Math.abs(z*A-H*R)||150<d.lastAItime)&&(d.rotinc=d.decision*fMaxRotInCp)):d.rotinc=d.decision*fMaxRotInCp,N=!0;else{var _,V,F,l=(d.nextAiStop-f)*w;d.collidesince&&(d.recovering||(d.recovering=1),d.recovering++,N=!0,20<=d.recovering&&(delete d.recovering,delete d.recovertime,delete d.decision,delete d.collidesince)),O<E?(V=u[0]+d.randShift*I/w,F=u[1]-d.randShift*k/w,_=Math.atan2(V-d.x,F-d.y)):(ue=followCircleWithAngle(d.x,d.y,u[0],u[1],k,I),$=h[0]+(d.x-L)*E/O,K=h[1]+(d.y-T)*E/O,V=$+(W=intersectionLineCircle(ue[0],ue[1],ue[2],$,K,k,I))*k,F=K+W*I,$=ue[1]-d.y,K=d.x-ue[0],$*(L-d.x)+K*(T-d.y)<0&&($=-$,K=-K),ue=normalizeAngle((_=Math.atan2($,K))-(W=Math.atan2(u[0]-d.x,u[1]-d.y)),2*Math.PI),.3<Math.abs(ue)&&(_=W+.3*Math.sign(ue)));var j,K,W,q,G=d.x,J=d.y,L=V,T=F,$=Math.hypot(L-G,T-J),U=(L-G)*d.speed/$,X=(T-J)*d.speed/$,Y=1;if(!isCup){var Q,Z=decorPos[collisionLap];for(Q in Z){var ee=decorBehaviors[Q].hitbox||DEFAULT_DECOR_HITBOX;ee*=1.1;for(o=0;o<Z[Q].length;o++)for(var te=Z[Q][o],ne=[[te.x-ee,te.y-ee,2*ee,0],[te.x-ee,te.y-ee,0,2*ee],[te.x-ee,te.y+ee,2*ee,0],[te.x+ee,te.y-ee,0,2*ee]],ae=U-te.vX,oe=X-te.vY,ie=0;ie<ne.length;ie++){var re=ne[ie],le=secants(G,J,G+16*ae,J+16*oe,re[0],re[1],re[0]+re[2],re[1]+re[3]);le&&le[0]<Y&&(j={type:Q,i:o,line:re,inter:le,box:[re[0]+16*te.vX*le[1],re[1]+16*te.vY*le[1],re[2],re[3]]},Y=le[0])}}}j?(K=j.box[0],W=j.box[1],L=j.box[0]+j.box[2],q=j.box[1]+j.box[3],T=distToAiPoints(K,W,d.aipoints),$=distToAiPoints(L,q,d.aipoints),K-=j.box[2]/1.5,W-=j.box[3]/1.5,L+=j.box[2]/1.5,q+=j.box[3]/1.5,F=T<$?(V=K,W):(V=L,q),_=Math.atan2(V-d.x,F-d.y),d.minDecor={x:V,y:F,t:10}):d.minDecor&&(pe=d.minDecor.x,se=d.minDecor.y,d.minDecor.t--,d.minDecor.t<0||(d.x-pe)*(d.x-pe)+(d.y-se)*(d.y-se)<300?delete d.minDecor:(q=direction(0,d.rotation),ce=direction(1,d.rotation),(pe-d.x)*q+(se-d.y)*ce<0&&delete d.minDecor),d.minDecor&&(V=pe,F=se));var se,ce=d.rotation,pe=d.speed;!d.shift||isCup||(de=flowShift(d.x,d.y,d.protect))&&(se=kartInstantSpeed(d),de[2]?pe=Math.min(pe,Math.hypot(se[0],se[1])):(ce=180*Math.atan2(se[0],se[1])/Math.PI,he=Math.pow(cappedRelSpeed(d),-2),de[0]*de[0]+de[1]*de[1]>=10*he&&(ce+=.15*(ce-d.rotation)*he)),isNaN(ce)&&(ce=d.rotation)),_=nearestAngle(180*_/Math.PI,ce,360),isNaN(_)&&(_=ce),isNaN(V)&&(V=u[0]),isNaN(F)&&(F=u[1]);var ue=_-ce;d.rotinc=Math.max(Math.min(ue,fMaxRotInCp),-fMaxRotInCp);var de=Math.abs(ue),s=de;isBattle&&(de*=Math.pow(de/10,1.5)),l=Math.hypot(V-d.x,F-d.y);var me,he=Math.atan2(V-h[0],F-h[1])-d.rotation,ce=(Math.abs(Math.sin(he))+de*Math.PI/180/2)/y,c=l/ce;"BB"!=course||(he=Math.max(5,ce/1.57))<ce&&(c=getNearestHoleDist(d,1600)<1600?l/Math.pow(he*Math.tan(ce/he),1.5):l/Math.pow(ce,1.2)),fMaxRotInCp<de&&(O<E&&((me=aiMarginLimitSpeed(d.x,d.y,direction(0,d.rotation),direction(1,d.rotation),u[0],u[1],k,I,2*E,y))<c&&(c=me)),me=c,d.bloops&&d.bloops.effective(d)&&(me=Math.min(me,3)),me=(me/=.9)||.01,32==oMap.skin&&6<pe&&me<pe-1?(d.speed=Math.max(me,d.speed-2),d.speedinc=0):d.speedinc=Math.max(Math.min(me-pe,1),-1),d.speedinc<0&&(d.rotinc=-d.rotinc))}N&&d.lastAItime>250+50*Math.random()&&!e&&(d.aipoint=void 0);break}"BB"!=course?inTeleport(u[0],u[1])||(null!=d.aishortcut&&d.aishortcuts[d.aipoint]?(B=(D=d.aishortcuts[d.aipoint])[0],d.aishortcut<B.length?d.aishortcut++:d.aipoint=D[1]):d.aishortcuts&&d.aishortcuts[d.aipoint]&&hasShortcutItem(d,d.aishortcuts[d.aipoint])?d.aishortcut=0:(d.aipoint++,d.aipoint>=d.aipoints.length&&(d.aipoint=0))):(d.lastAI=d.aipoint,delete d.lastAIpt,-1!=d.nextAI?d.aipoint=d.nextAI:d.aipoint=void 0,d.nextAI=void 0),d.nextAiStop=void 0,d.randShift=void 0,d.lastAItime=0}if((25==d.roulette||d.using[0])&&!d.tourne&&!d.cannon){var ge=!1;function ye(e,t,n,a,o){for(var i=e*e,r=t*t,l=(isOnline?aKarts:strPlayer).length,s=0;s<l;s++){var c=aKarts[s],p=a*Math.max(.2,Math.min(Math.abs(c.speed)/5,1));if(!c.loose&&!c.protect&&!c.cpu){var u=(c.x-d.x)*(c.x-d.x)+(c.y-d.y)*(c.y-d.y);if(i<=u&&u<r){c=180*Math.atan2(c.x-d.x,c.y-d.y)/Math.PI;o&&(c+=180);c=Math.abs(nearestAngle(c-d.rotation,0,360));if(n<=c&&c<p)return 1}}}}if(!isOnline||d.controller==identifiant)if(d.using.length)switch(d.using[0].type){case"carapace-rouge":"BB"==course&&d.using.length<2?ye(15,100,0,30)&&arme(aKarts.indexOf(d)):ge=!0;break;case"carapace":"BB"==course&&d.using.length<2?((ye(0,20,0,30)||ye(0,150,0,15))&&arme(aKarts.indexOf(d)),(ye(0,20,0,30,!0)||ye(0,80,0,15,!0))&&arme(aKarts.indexOf(d),!0)):ge=!0;break;default:ge=!0}else{var fe,Se,ve=!1,be=!1;if(d.aishortcuts&&(hasShortcutItem(d)&&(null!=d.aishortcut?(be=!0,!d.champi&&(8<=c||5<=c-d.speed)&&s<=10&&arme(aKarts.indexOf(d))):((Se=d.shouldWaitItemCache)&&Se.isValid()||(Se=distToNextShortcut(d)<1e3?{value:!0,isValid:function(){return!0}}:(fe=d.aipoint,{value:!1,isValid:function(){return d.aipoint===fe}})),ve=Se.value)),d.shouldWaitItemCache=Se),!ve&&!be)switch(d.arme){case"megachampi":case"etoile":11<=c&&100<=l&&s<=10&&arme(aKarts.indexOf(d));break;case"champi":case"champiX2":case"champiX3":!d.champi&&11<=c&&100<=l&&s<=10&&arme(aKarts.indexOf(d));break;case"champior":d.champior?(8<=c||5<=c-d.speed)&&s<=10&&arme(aKarts.indexOf(d)):11<=c&&100<=l&&s<=10&&arme(aKarts.indexOf(d));break;default:ge=!0}}if(ge&&.98<Math.random()){var Ce=!0;if(d.using.length)switch(d.using[0].type){case"banane":case"fauxobjet":case"poison":Ce=!1}ve=((Ce?d.place<oPlayers[0].place:d.place>oPlayers[0].place)||"BB"==course)&&.5<Math.random(),be=ve&&Ce,ve=ve&&!Ce;arme(aKarts.indexOf(d),be,ve)}}oMap.jumpable&&4<iDificulty&&(!d.z||d.jumped||d.billball||d.figstate||d.figuring||d.tourne||!(0<d.heightinc)||8<=c&&(oMap.jumpexc&&-1!=oMap.jumpexc.indexOf(d.aipoint)||(d.figstate=21)))}}}function moveItems(){collisionTest=COL_OBJ,collisionTeam=void 0,clLocalVars.currentKart=void 0,nextBlueShellCooldown&&nextBlueShellCooldown--,nextPowCooldown&&nextPowCooldown--;var e,t=getCurrentLapId(getPlayerAtScreen(0));for(e in itemBehaviors){var n=itemBehaviors[e].move;if(n){collisionLap=t;for(var a=items[e],o=a.length-1;0<=o;o--)a[o]&&n(a[o])}}}function moveDecor(){decorPos=[];var b=2*Math.PI;if(foreachLMap(function(e,t,n){var a={};if(t.decor){for(var o in e.decor)if(decorBehaviors[o].dodgable){a[o]=[];for(var i=e.decor[o],r=0;r<i.length;r++)a[o].push({aX:i[r][0],aY:i[r][1],x:i[r][0],y:i[r][1],vX:0,vY:0})}for(var o in decorBehaviors)decorBehaviors[o].ctx.lMap=e;var l={};for(o in e.decor){var i=e.decor[o],s=decorBehaviors[o];if(s.move){var c=getDecorActualType(s),p=0;l[c]?p=l[c]:l[c]=0;for(r=0;r<i.length;r++)s.move(i[r],r,r+p,s.scope);l[c]+=i.length}}for(o in a)for(i=e.decor[o],r=0;r<i.length;r++)a[o][r].x=i[r][0],a[o][r].y=i[r][1],a[o][r].vX=a[o][r].x-a[o][r].aX,a[o][r].vY=a[o][r].y-a[o][r].aY}if(decorPos[n]=a,t.pointers)for(r=0;r<e.pointers.length;r++){var u=e.pointers[r];u[2][2]+=u[2][3],u[2][2]%=b,u[0].redraw(u)}if(t.flippers)for(r=0;r<e.flippers.length;r++){var d=e.flippers[r],m=d[3][0];switch(m){case 0:--d[3][1]<=0&&(d[3][0]=1,d[3][1]=d[2][2],d[2][3]=.13*d[2][4]);break;case 1:case 2:var h=1==m?d[3][1]+d[2][4]:d[3][1];d[2][2]+=d[2][3],d[2][2]*d[2][3]>=h*d[2][3]&&(d[2][2]=h,1==m?(d[3][0]=2,d[2][3]=-d[2][3]):(d[3][0]=0,d[2][3]=0,d[3][1]=1+Math.floor(50*Math.random())))}m&&d[0].redraw(d)}if(t.bumpers)for(r=0;r<e.bumpers.length;r++){var g,y,f=e.bumpers[r];f[2][5]&&(f[3]||(g=Math.hypot(f[1][0]-f[2][3],f[1][1]-f[2][4]),y=Math.atan2(f[1][1]-f[2][4],f[1][0]-f[2][3]),f[3]=[g,y]),f[3][1]+=f[2][5],f[3][1]%=b,f[1][0]=f[2][3]+f[3][0]*Math.cos(f[3][1]),f[1][1]=f[2][4]+f[3][0]*Math.sin(f[3][1]),f[0].redraw(f))}if(t.sea){var S=e.sea,n=S.progress,t=(timer+60)%300;if(S.progress=t<120?1:t<150?.5-.5*Math.sin(Math.PI*((t-120)/30-.5)):t<270?0:.5+.5*Math.sin(Math.PI*((t-120-120-30)/30-.5)),S.progress!==n&&(e.horspistes.eau.polygon=S.offroad0.slice(),S.progress))for(var v=.99*S.progress,r=0;r<S.waves.length;r++)e.horspistes.eau.polygon.push(S.polygon(r,0,v))}}),oMap.coins)for(var e=0;e<oMap.coins.length;e++){var t=oMap.coins[e];t.theta+=.25,t.theta>=b&&(t.theta-=b)}}var previouslyPressedBtns=[],cycleHandler;function handleGamepadEvents(){if(gameControls.gamepad)for(var e=0;e<gameControls.gamepad.length;e++){var t=getGamepadInputsData(e,previouslyPressedBtns[e]);if(t){for(var n=t.pressedActions,a=t.pressActions,o=t.releaseActions,i=e?"_p2":"",r=oPlayers[e],l=0;l<a.length;l++){var s=a[l],c=(p=s.key)+i;switch(p){case"down":n.up?doReleaseKey("up"):doPressKey(c);break;case"up":doPressKey(c);break;case"item":case"item_fwd":case"item_back":s.wasPressed||hasOnHoldItem(r)||doReleaseKey(c);break;case"rear":r.changeView||doReleaseKey(c);break;case"pause":pressKey(p);break;default:s.wasPressed||doPressKey(c)}}for(l=0;l<o.length;l++){var p,c=(p=o[l].key)+i;switch(p){case"item":case"item_fwd":case"item_back":hasOnHoldItem(r)&&doReleaseKey(c);break;case"rear":r.changeView&&doReleaseKey(c);break;default:doReleaseKey(c)}}}}}function getGamepadInputsData(e,t){var n=gameControls.gamepad[e],e=findGamePadById(n);if(e){for(var a=getGamepadPressedBtns(e),o={},i=0;i<a.length;i++)o[a[i].key]=a[i];for(var r=[],l={},s={},c=[],p=[],i=0;i<n.controls.length;i++){var u=n.controls[i],d=u.inputs.every(function(e){var t=o[e.key];return t&&e.isPressed(t)}),m=t[i];if(d){for(var h,g=!1,y=0;y<r.length;y++)if(isGamepadControlSubset(u.inputs,r[y].inputs)){g=!0;break}g||(r.push(u),h=u.key,t[i]=!0,c.push({key:h,wasPressed:m}),l[h]=!0)}else m&&u.inputs.every(function(e){e=o[e.key];return!e||"stick"===e.type})&&(h=u.key,t[i]=void 0,p.push({key:h}),s[h]=!0)}return{pressedBtnsRaw:a,pressedBtns:r,pressedActions:l,releasedActions:s,pressActions:c,releaseActions:p}}}function handleAudio(){var e,t;mapMusic&&mapMusic.opts&&mapMusic.yt&&mapMusic.yt.getCurrentTime&&(e=mapMusic.yt.getCurrentTime(),!(mapMusic.opts.end?e>mapMusic.opts.end:0===mapMusic.yt.getPlayerState()&&e>mapMusic.yt.getDuration()-1)||(t=mapMusic.opts.start||0)<e&&mapMusic.yt.seekTo(t,!0))}function handleChallengeEvents(){var e=oPlayers[0],t=0<e.z;if(clLocalVars.zonesHit)for(var n=e.x,a=e.y,o=0;o<clLocalVars.zonesHit.length;o++){var i=clLocalVars.zonesHit[o];t&&i.floor||pointInZone(n,a,i.zones)&&(i.ruleVars.hit=!0)}clSelected&&!clSelectionFail&&!1===challengeRulesSatisfied(clSelected,clSelected.data.constraints)&&challengeHandleFail(),challengeCheck("each_frame")}function cycle(){cycleHandler=setInterval(runOneFrame,SPF),runOneFrame()}var decorPos=[],lastErrorTs=0;function runOneFrame(){try{if(handleGamepadEvents(),!timeTrialMode())for(var e=0;e<aKarts.length;e++)colKart(e);for(var t,n,e=0;e<aKarts.length;e++)(a=aKarts[e]).pushVector&&((t=6*cappedRelSpeed())*t<(n=a.pushVector[0]*a.pushVector[0]+a.pushVector[1]*a.pushVector[1])&&(n=Math.sqrt(n),a.pushVector[0]*=t/n,a.pushVector[1]*=t/n),a.shift||(a.shift=[0,0,0]),a.shift[0]+=a.pushVector[0],a.shift[1]+=a.pushVector[1],delete a.pushVector);for(e=0;e<aKarts.length;e++){var a=aKarts[e];if(e&&"CM"==course&&!a.cpu){var o=jTrajets[e-1];if(timer<=o.length){var i=o[timer-1];a.moveGhost(i);continue}a.cpu=!0,a.aipoint=0;var o=getCurrentLMap(lMaps.length);a.aipoints=o.aipoints[0],a.tours=oMap.tours+1,a.demitours=0,a.lastAItime=0,a.arme=!1,a.stopDrifting(),a.stopStunt()}a.loose&&(!isOnline||finishing)||(a.cpu&&ai(a),move(e),"CM"!=course||a.cpu||(i=[Math.round(a.x),Math.round(a.y),a.z,Math.round(a.rotation)],o="0000".split(""),20==a.tombe&&(o[0]="1"),a.ctrl&&(o[1]="1",0<a.rotincdir?o[2]="1":a.rotincdir<0&&(o[3]="1")),-1!=o.indexOf("1")&&i.push(o.join("")),iTrajet.push(i)))}if("CM"!=course)for(var r=getRankScores(),e=0;e<aKarts.length;e++)places(e,r);moveItems(),moveDecor(),oSpecCam&&oSpecCam.move(),oPlayers[0].cpu||oPlayers[0].loose||handleChallengeEvents(),refreshDatas&&resetDatas(),handleAudio(),render()}catch(e){console.error(e);var l=(new Date).getTime();1e4<l-lastErrorTs&&(o_xhr("logGameCrash.php","error="+encodeURIComponent(e.stack),function(){return!0}),lastErrorTs=l)}}var gameControls={keyboard:{}},selectedOscrElt,focusIndicator,myPersosCache;function getGameAction(e){return e.keyAction||gameControls.keyboard[e.keyCode]}function handleSpectatorInput(e){switch(e.keyCode){case 37:e.keyAction="left";break;case 39:e.keyAction="right";break;case 27:e.keyAction="quit"}switch(e.keyAction){case"left":var t=aKarts[oSpecCam.playerId].tours,n=aKarts[oSpecCam.playerId].demitours;oSpecCam.playerId--,oSpecCam.playerId<0&&(oSpecCam.playerId+=aKarts.length),handleCpChange(t,n,oSpecCam.playerId);break;case"right":t=aKarts[oSpecCam.playerId].tours,n=aKarts[oSpecCam.playerId].demitours;oSpecCam.playerId++,oSpecCam.playerId>=aKarts.length&&(oSpecCam.playerId=0),handleCpChange(t,n,oSpecCam.playerId);break;case"quit":return document.location.reload(),!1;default:return!0}oSpecCam.reset();var a,o=getPlayerAtScreen(0);return(isBattle?!o.loose:o.tours<=oMap.tours)&&((a=document.getElementById("infoPlace0")).style.visibility="",a.innerHTML=o.place,-1!=o.team&&(a.style.color=cTeamColors.light[o.team])),isBattle?updateBalloonHud(document.getElementById("compteur0"),o):updateLapHud(0),!1}function releaseOverEvents(){for(var e=document.querySelectorAll(":hover"),t=0;t<e.length;t++){var n=e[t];n.onmouseout&&n.onmouseout()}}function showFocusIndicator(e,t){var n=(selectedOscrElt=t).getBoundingClientRect(),a=e.getBoundingClientRect();focusIndicator||((focusIndicator=document.createElement("div")).style.position="absolute",focusIndicator.style.zIndex=1,focusIndicator.style.backgroundColor=primaryColor,focusIndicator.style.opacity=.4,focusIndicator.style.pointerEvents="none"),e.appendChild(focusIndicator);t=iScreenScale,e=Math.round(iScreenScale/2);focusIndicator.style.left=n.left-a.left-t+"px",focusIndicator.style.top=n.top-a.top-e+"px",focusIndicator.style.width=n.width+2*t+"px",focusIndicator.style.height=n.height+2*e+"px",focusIndicator.style.borderRadius=e+"px",iSfx&&playSoundEffect("musics/events/move.mp3")}function addButton(e,t){var n,a=t.btn||document.createElement("button");return a.style.textAlign="center",a.style.padding="0px",a.dataset.key=t.key,t.src?(a.className="btn-img",(n=document.createElement("img")).src="images/vkeyboard/"+t.src+".png",n.alt=e,a.appendChild(n)):a.innerHTML=e,"touchstart"in t?a.ontouchstart=t.touchstart:a.ontouchstart=onButtonTouch,"touchend"in t?a.ontouchend=t.touchend:a.ontouchend=onButtonPress,t.parent||(t.parent=document.getElementById("virtualkeyboard")),t.parent.appendChild(a),a}function addButtonLegacy(e,t,n,a,o,i,r){o=60*(o||1),i=50*(i||1);var l=document.createElement("button");return l.style.position="absolute",l.style.left=Math.round(60*n*1.2)+"px",l.style.top=Math.round(50*a*1.3)+"px",l.style.width=o+"px",l.style.height=i+"px",l.style.textAlign="center",l.style.padding="0px",r&&(l.style.fontSize=r+"px"),l.innerHTML=e,l.dataset.key=t,l.ontouchstart=onButtonTouch,l.ontouchend=onButtonPress,document.getElementById("virtualkeyboard").appendChild(l),l}function isCustomPerso(n,a){var e;return a=a||{},n.startsWith("cp-")&&(!customPersos[n]||a.forceReload?(cp[n]=[.5,.5,.5,.5],e=PERSOS_DIR+n+"-ld.png",customPersos[n]={name:language?"Deleted character":"Perso supprim√©",map:e,podium:e,music:"mario"},xhr("getCP.php","perso="+n,function(e){if(-1==e)return a.callback&&a.callback(t),!0;if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return cp[n][0]=t.acceleration,cp[n][1]=t.speed,cp[n][2]=t.handling,cp[n][3]=t.mass,customPersos[n]=t,a.callback&&a.callback(t),!0})):a.callback&&a.callback(perso),1)}function getWinnerSrc(e){return isCustomPerso(e)?customPersos[e].podium:"images/winners/w_"+e+".png"}function getEndingSrc(e){return isCustomPerso(e)&&(e=customPersos[e].music),baseCp0[e]?"musics/endings/ending_"+e+".mp3":e}function getStarSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+"-star.png":"images/star/star_"+e+".png"}function getSpriteSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+".png":"images/sprites/sprite_"+e+".png"}function getCustomDecorData(e,t){var o=e.id,i=e.type,e=!1;if(customDecorData[o]){if(void 0!==customDecorData[o].data)return void t(customDecorData[o].data);e=!0}else customDecorData[o]={callbacks:[]};customDecorData[o].callbacks.push(t),e||xhr("getDecorData.php?id="+o+"&full",null,function(e){var t;try{t=JSON.parse(e)}catch(e){t={id:o,hd:"images/sprites/sprite_"+i+".png",map:"images/map_icons/"+i+".png",size:{hd:{w:32,h:32}},original_size:{hd:{w:32,h:32}}},i.startsWith("assets/")&&(t.hd=t.map)}customDecorData[o].data=t;for(var n=customDecorData[o].callbacks,a=0;a<n.length;a++)customDecorData[o].callbacks[a](t);return!(n.length=0)})}function getMapIcSrc(e){return isCustomPerso(e)?customPersos[e].map:"images/map_icons/"+e+".png"}function getMapSelectorSrc(e){return isCup?oMaps[aAvailableMaps[e]].icon:"images/selectors/select_"+aAvailableMaps[e]+".png"}function getMapId(e){e=simplified?e.id:e.map;return null==e&&(e=-1),e}function privateGame(t){var e=document.createElement("div"),n=e.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",e.appendChild(toTitle(toLanguage("Private game","Partie priv√©e"),0));n=document.createElement("div");n.style.position="absolute",n.style.left=6*iScreenScale+"px",n.style.top=12*iScreenScale+"px",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.color="#DFC",n.innerHTML=language?"The &quot;private game&quot; option allows you to play only with people you want.<br />The principle is simple: a private link is generated, you send this link to the concerned members, and you can start playing.":"L'option &quot;partie priv√©e&quot; vous permet de jouer uniquement avec les personnes de votre choix.<br />Le principe est simple : un lien priv√© est g√©n√©r√©, vous envoyez ce lien aux membres concern√©s, et vous pouvez commencer √† jouer.",e.appendChild(n);n=document.createElement("input");n.type="button",n.value=toLanguage("Generate private link","G√©n√©rer un lien priv√©"),n.style.fontSize=3*iScreenScale+"px",n.style.position="absolute",n.style.width=35*iScreenScale+"px",n.style.left=23*iScreenScale+"px",n.style.top=28*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateLink(t)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),shareLink.options=null,selectPlayerScreen(0)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("Private game options...","Options de la partie priv√©e..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=52*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateGameOptions(shareLink.options,function(e){e&&(shareLink.options=e,t=e),privateGame(t)})},e.appendChild(n),oContainers[0].appendChild(e)}function privateGameOptions(e,M){var P=document.createElement("div"),t=P.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",(g=toTitle(isOnline?toLanguage("Private game options","Options partie priv√©e"):toLanguage("Online game options","Options mode en ligne"),0)).style.fontSize=7*iScreenScale+"px",P.appendChild(g);var n=document.createElement("form");n.style.position="absolute",n.style.left="0px",n.style.top=8*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px",n.onsubmit=function(e){e.preventDefault();var t=this.elements["option-teams"].checked?1:0,n=this.elements["option-manualTeams"].checked?1:0,a=this.elements["option-friendlyFire"].checked?1:0,o=+this.elements["option-nbTeams"].value,i=JSON.parse(this.elements["option-teamOpts"].value),r=this.elements["option-friendly"].checked?1:0,l=+this.elements["option-localScore"].checked?1:0;r||(l=0);var s=+this.elements["option-minPlayers"].value,c=+this.elements["option-maxPlayers"].value,p=parseInt(this.elements["option-cc"].value),u=this.elements["option-cc"].value.endsWith("m"),d=JSON.parse(this.elements["option-itemDistrib"].value),m=JSON.parse(this.elements["option-ptDistrib"].value),h=this.elements["option-cpu"].checked?1:0,g=+this.elements["option-cpuCount"].value,y=+this.elements["option-cpuLevel"].value,f=(f=this.elements["option-cpuNames"].dataset.value)&&JSON.parse(f),S=(S=this.elements["option-cpuChars"].dataset.value)&&JSON.parse(S),v=this.elements["option-timeTrial"].checked?1:0,b=this.elements["option-noBumps"].checked?1:0,C=this.elements["option-noJump"].checked?1:0,x=this.elements["option-noRd"].checked?1:0,e=this.elements["option-doubleItems"].checked?0:1;t||(a=i=n=0),v&&(b=0),h||(g=defaultGameOptions.cpuCount,y=defaultGameOptions.cpuLevel,f=defaultGameOptions.cpuNames,S=defaultGameOptions.cpuChars),M({team:t,manualTeams:n,friendlyFire:a,nbTeams:o,teamOpts:i,friendly:r,localScore:l,minPlayers:s,maxPlayers:c,cc:p,mirror:u,itemDistrib:d,ptDistrib:m,cpu:h,cpuCount:g,cpuLevel:y,cpuNames:f,cpuChars:S,timeTrial:v,noBumps:b,noJump:C,noRd:x,doubleItems:e}),P.innerHTML="",oContainers[0].removeChild(P)};var a=document.createElement("div");a.style.height=Math.round(21*iScreenScale+18)+"px",a.style.overflow="auto";var o=document.createElement("table");o.style.marginLeft="auto",o.style.marginRight="auto";var i=document.createElement("tr");(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px";var r=document.createElement("input");r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-teams",r.name="option-teams",r.type="checkbox",e&&e.team&&(r.checked=!0),r.onchange=function(){this.checked?(document.getElementById("option-manualTeams-ctn").style.display="",isOnline&&(document.getElementById("option-nbTeams-ctn").style.display="",document.getElementById("option-friendlyFire-ctn").style.display="")):(document.getElementById("option-manualTeams-ctn").style.display="none",document.getElementById("option-nbTeams-ctn").style.display="none",document.getElementById("option-friendlyFire-ctn").style.display="none")},l.appendChild(r),i.appendChild(l);var l=document.createElement("td"),s=document.createElement("label");s.style.cursor="pointer",s.setAttribute("for","option-teams");var c=document.createElement("h1");c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Team games","Parties par √©quipe"),s.appendChild(c);var p=document.createElement("div");p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, 2 teams are selected in each game. Your objective: defeat the opposing team.","Si activ√©, 2 √©quipes sont s√©lectionn√©es √† chaque partie. Votre objectif : vaincre l'√©quipe adverse."),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-manualTeams-ctn",e&&e.team||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.position="relative",r.style.left=Math.round(1.5*iScreenScale)+"px",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-manualTeams",r.name="option-manualTeams",r.type="checkbox",e&&e.team&&e.manualTeams&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");if((s=document.createElement("label")).style.cursor="pointer",s.style.display="inline-block",s.setAttribute("for","option-manualTeams"),(c=document.createElement("h1")).style.marginTop=0,c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Manual selection","S√©lection manuelle"),s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, teams are selected manually at each game.","Si activ√©, les √©quipes sont s√©lectionn√©es manuellement √† chaque partie. Sinon, les √©quipes sont form√©es automatiquement en fonction du niveau de chaque joueur."),s.appendChild(p),l.appendChild(s),i.appendChild(l),!isOnline)for(var u=i.getElementsByTagName("td"),d=0;d<u.length;d++)u[d].style.paddingBottom=Math.round(2*iScreenScale)+"px";o.appendChild(i),(i=document.createElement("tr")).id="option-nbTeams-ctn",e&&e.team&&isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),l.style.paddingLeft=iScreenScale+"px",l.style.paddingTop=Math.round(.5*iScreenScale)+"px",l.style.paddingBottom=iScreenScale+"px";var m=document.createElement("div");m.style.display="flex",m.style.flexDirection="row",m.style.alignItems="center";var h=document.createElement("div");h.style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-nbTeams"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Number of teams","Nombre d'√©quipes"),c.style.marginTop="0px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block";t=document.createElement("input");t.id="option-nbTeams",t.name="option-nbTeams",t.type="number",t.setAttribute("min",2),t.setAttribute("max",6),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.nbTeams?t.value=e.nbTeams:t.value=defaultGameOptions.nbTeams,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(.5*iScreenScale)+"px",t.onchange=function(){var e=parseInt(this.value);e<this.getAttribute("min")?(e=this.getAttribute("min"),this.value=e):e>this.getAttribute("max")&&(e=this.getAttribute("max"),this.value=e);var t=JSON.parse(document.getElementById("option-teamOpts").value);if(t){t.length=e;for(var n=[],a=0;a<t.length;a++)n.push(a);for(a=0;a<t.length;a++)t[a]?n.splice(n.indexOf(t[a].color),1):t[a]={color:n.shift()}}document.getElementById("option-teamOpts").value=JSON.stringify(t)},h.appendChild(t);var g=document.createElement("input");g.type="hidden",g.id="option-teamOpts",g.name="option-teamOpts",e&&e.teamOpts?g.value=JSON.stringify(e.teamOpts):g.value=JSON.stringify(defaultGameOptions.teamOpts),h.appendChild(g),(g=document.createElement("a")).innerHTML=toLanguage("Set teams color &amp; name...","Couleur &amp; nom des √©quipes..."),g.style.fontSize=2*iScreenScale+"px",g.style.marginLeft=Math.round(2.5*iScreenScale)+"px",g.style.color="white",g.style.position="relative",g.style.top=Math.round(-iScreenScale/2)+"px",g.href="#null",g.onclick=function(){var l=parseInt(document.getElementById("option-nbTeams").value),s=JSON.parse(document.getElementById("option-teamOpts").value),c=document.createElement("form");c.style.position="absolute",c.style.width="100%",c.style.height="100%",c.style.left="0px",c.style.top="0px",c.style.zIndex=2,c.style.backgroundColor="#000",c.onsubmit=function(){for(var e=[],t=!0,n=0;n<l;n++){var a={color:+this.elements["color"+n].value,name:this.elements["name"+n].value};a.color!==n&&(t=!1),a.name===oTeamColors.name[a.color]?delete a.name:t=!1,e.push(a)}return t&&(e=0),document.getElementById("option-teamOpts").value=JSON.stringify(e),P.removeChild(c),!1},c.appendChild(toTitle(toLanguage("Team options","Option des √©quipes"),0));var e=document.createElement("div");e.style.position="absolute",e.style.width="100%",e.style.top=iScreenScale*(13-l)+"px",e.style.textAlign="center";var p=document.createElement("div");p.style.display="inline-grid",p.style.fontSize=3*iScreenScale+"px",p.style.gridTemplateColumns=12*iScreenScale+"px "+12*iScreenScale+"px "+18*iScreenScale+"px",p.style.gridColumnGap=3*iScreenScale+"px",p.style.gridRowGap=Math.round(iScreenScale*(3-.5*l))+"px",p.style.marginTop=2*iScreenScale+"px";var t=document.createElement("div");p.appendChild(t),(t=document.createElement("div")).style.color="white",t.innerHTML=toLanguage("Color","Couleur"),p.appendChild(t),(t=document.createElement("div")).style.color="white",t.innerHTML=toLanguage("Name","Nom"),p.appendChild(t);for(var n=0;n<l;n++)!function(e){var t=document.createElement("div");t.innerHTML=toLanguage("Team "+(e+1),"√âquipe "+(e+1)),p.appendChild(t);var n=(n=s[e])||{color:e},a=document.createElement("select");a.name="color"+e;for(var o=0;o<oTeamColors.name.length;o++){var i=document.createElement("option");i.value=o,i.innerHTML=oTeamColors.name[o],i.style.color=oTeamColors.light[o],n.color===o&&(i.selected=!0),a.appendChild(i)}a.currentValue=a.value,a.onchange=function(){r.value===oTeamColors.name[a.currentValue]&&(r.value=oTeamColors.name[a.value]),a.currentValue=a.value;for(var e=!0,t=0;t<l;t++){var n=c.elements["color"+t];if(n!==a&&n.value===a.value){e=!1;break}}e?(u.disabled=!1,u.style.opacity=1,u.style.cursor=""):(u.disabled=!0,u.style.opacity=.4,u.style.cursor="not-allowed")},a.style.fontSize=2*iScreenScale+"px",p.appendChild(a);var r=document.createElement("input");r.name="name"+e,r.type="text",r.value=n.name||oTeamColors.name[a.value],r.style.fontSize=2*iScreenScale+"px",r.required=!0,p.appendChild(r)}(n);e.appendChild(p),c.appendChild(e);e=document.createElement("input");e.type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=35*iScreenScale+"px",e.onclick=function(){P.removeChild(c)},c.appendChild(e);var u=document.createElement("input");return u.style.position="absolute",u.style.right=6*iScreenScale+"px",u.style.top=34*iScreenScale+4+"px",u.type="submit",u.style.fontSize=3*iScreenScale+"px",u.value=toLanguage("Validate","Valider"),u.style.marginLeft=iScreenScale+"px",c.appendChild(u),P.appendChild(c),!1},h.appendChild(g),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-friendlyFire-ctn",e&&e.team||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.position="relative",r.style.left=Math.round(1.5*iScreenScale)+"px",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-friendlyFire",r.name="option-friendlyFire",r.type="checkbox",e&&e.team&&e.friendlyFire&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.style.display="inline-block",s.setAttribute("for","option-friendlyFire"),(c=document.createElement("h1")).style.marginTop=0,c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Friendly fire","Friendly fire"),s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, your items can hit your teammates","Si activ√©, vos objets peuvent toucher les joueurs de votre √©quipe"),s.appendChild(p),l.appendChild(s),i.appendChild(l);for(u=i.getElementsByTagName("td"),d=0;d<u.length;d++)u[d].style.paddingBottom=Math.round(2*iScreenScale)+"px";o.appendChild(i);i=document.createElement("tr");(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).id="option-friendly",r.name="option-friendly",r.type="checkbox",e&&e.friendly&&(r.checked=!0),r.onchange=function(){this.checked&&isOnline?document.getElementById("option-localScore-ctn").style.display="":document.getElementById("option-localScore-ctn").style.display="none"},r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-friendly"),l.appendChild(s),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Friendly game","Matchs amicaux"),c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, games won't make you win or lose points in the online mode.","Si activ√©, les parties ne vous feront pas gagner ou perdre de points dans le mode en ligne."),s.appendChild(p),l.appendChild(s),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-localScore-ctn",e&&e.friendly||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.position="relative",r.style.left=Math.round(1.5*iScreenScale)+"px",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-localScore",r.name="option-localScore",r.type="checkbox",e&&e.friendly&&e.localScore&&isOnline&&(r.checked=!0),r.onchange=function(){this.checked?document.getElementById("option-ptDistrib-ctn").style.display="":document.getElementById("option-ptDistrib-ctn").style.display="none"},l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.style.display="inline-block",s.setAttribute("for","option-localScore"),(c=document.createElement("h1")).style.marginTop=0,c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Local scoring","Classement local"),s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, an ranking internal to this room will be calculated instead of the classic online mode ranking.","Si activ√©, un classement interne √† la partie priv√©e sera calcul√© √† la place du classement en ligne classique."),s.appendChild(p),l.appendChild(s),l.style.paddingBottom=Math.round(1.5*iScreenScale)+"px",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-ptDistrib-ctn",e&&e.localScore||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),l.style.paddingBottom=Math.round(2*iScreenScale)+"px",(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignPts="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-ptDistrib"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Point distribution","Distribution des points"),c.style.marginTop="0px",c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block";var y=document.createElement("select");y.id="option-ptDistrib",y.name="option-ptDistrib",y.style.backgroundColor="black",y.style.width=24*iScreenScale+"px",y.style.fontSize=Math.round(2.5*iScreenScale)+"px";for(d=0;d<ptDistributions.length;d++)(E=document.createElement("option")).value=d,E.innerHTML=ptDistributions[d].name,y.appendChild(E);for(d=0;d<customPtDistrib.length;d++)(E=document.createElement("option")).value=JSON.stringify(customPtDistrib[d]),E.innerHTML=customPtDistrib[d].name,y.appendChild(E);e&&e.ptDistrib&&(T=JSON.stringify(e.ptDistrib),y.value=T,y.value!==T&&((E=document.createElement("option")).value=T,E.innerHTML=toLanguage("Custom","Personnalis√©"),y.insertBefore(E,y.firstChild),y.selectedIndex=0)),(E=document.createElement("option")).value=-1,E.innerHTML=toLanguage("Custom...","Personnalis√©..."),y.appendChild(E),y.currentValue=y.value,y.onchange=function(){var n;-1==this.value?(this.value=this.currentValue,selectedPtDistrib=isNaN(this.currentValue)?JSON.parse(this.currentValue):ptDistributions[this.currentValue],n=this,selectPtScreen(P,function(e){var t=n.querySelector("option");isNaN(t.value)||((t=document.createElement("option")).innerHTML=toLanguage("Custom","Personnalis√©"),n.insertBefore(t,n.firstChild)),t.value=JSON.stringify(e),n.selectedIndex=0,n.currentValue=n.value},{value:getDefaultPointDistribution(6),untitled:!0})):this.currentValue=this.value},h.appendChild(y),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-minPlayers"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Minimum number of players","Nombre de joueurs minimum"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("Minimum number of players before the game begins.","Nombre minimum de joueurs pour que la partie commence"),s.appendChild(p),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(t=document.createElement("input")).id="option-minPlayers",t.name="option-minPlayers",t.type="number",t.setAttribute("min",2),t.setAttribute("max",99),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.minPlayers?t.value=e.minPlayers:t.value=defaultGameOptions.minPlayers,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",h.appendChild(t),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-maxPlayers"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Maximum number of players","Nombre de joueurs maximum"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("Maximum number of players that can join the game.","Nombre maximum de joueurs qui peuvent rejoindre la partie"),s.appendChild(p),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(t=document.createElement("input")).id="option-maxPlayers",t.name="option-maxPlayers",t.type="number",t.setAttribute("min",2),t.setAttribute("max",99),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.maxPlayers?t.value=e.maxPlayers:t.value=defaultGameOptions.maxPlayers,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",h.appendChild(t),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");function f(e){return parseFloat(e.replace("m",".5"))}function S(e,t,n){var a=document.createElement("option"),o=t+(n?"m":""),i=f(a.value=o);a.innerHTML=t+"cc"+(n?toLanguage(" mirror"," miroir"):"");for(var r=e.getElementsByTagName("option"),l=0;l<r.length;l++){var s=r[l];if(f(s.value)>i){e.insertBefore(a,s);break}if(s.value==a.value){a=s;break}}a.parentNode||e.insertBefore(a,r[r.length-1]),e.value=o}(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cc"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Class","Cylindr√©e"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(y=document.createElement("select")).id="option-cc",y.name="option-cc",y.style.backgroundColor="black",y.style.width=12*iScreenScale+"px",y.style.fontSize=Math.round(2.5*iScreenScale)+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px";var v=[50,100,150,150,200],b=[!1,!1,!1,!0,!1];isOnline||(b=[!(v=[150,150,200]),!0,!1]);var C=!1,x=150;e&&e.cc&&(x=e.cc);var k=!1;e&&e.mirror&&(k=!0);for(d=0;d<v.length;d++){var I=v[d],w=b[d];(E=document.createElement("option")).value=I+(w?"m":""),E.innerHTML=I+"cc"+(w?toLanguage(" mirror"," miroir"):""),x==I&&k==w&&(E.setAttribute("selected",!0),C=!0),y.appendChild(E)}isOnline&&((E=document.createElement("option")).value=-1,E.innerHTML=toLanguage("More...","Plus..."),y.appendChild(E),C||S(y,x,k),y.currentValue=y.value,y.onchange=function(){handleCcSelectChange(this,P,function(e,t,n){S(e,t,n)})}),h.appendChild(y),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-itemDistrib"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Item distribution","Distribution des objets"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(y=document.createElement("select")).id="option-itemDistrib",y.name="option-itemDistrib",y.style.backgroundColor="black",y.style.width=24*iScreenScale+"px",y.style.fontSize=Math.round(2.5*iScreenScale)+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var L=getItemMode(),d=0;d<itemDistributions[L].length;d++)(E=document.createElement("option")).value=d,E.innerHTML=itemDistributions[L][d].name,y.appendChild(E);for(var T,d=0;d<customItemDistrib[L].length;d++)(E=document.createElement("option")).value=JSON.stringify(customItemDistrib[L][d]),E.innerHTML=customItemDistrib[L][d].name,y.appendChild(E);e&&e.itemDistrib&&(T=JSON.stringify(e.itemDistrib),y.value=T,y.value!==T&&((E=document.createElement("option")).value=T,E.innerHTML=toLanguage("Custom","Personnalis√©"),y.insertBefore(E,y.firstChild),y.selectedIndex=0)),(E=document.createElement("option")).value=-1,E.innerHTML=toLanguage("Custom...","Personnalis√©..."),y.appendChild(E),y.currentValue=y.value,y.onchange=function(){var e,n;-1==this.value?(this.value=this.currentValue,(selectedItemDistrib=isNaN(this.currentValue)?JSON.parse(this.currentValue):itemDistributions[L][this.currentValue]).value&&(e=Object.assign({},selectedItemDistrib,{untitled:!0})),n=this,selectItemScreen(P,function(e){var t=n.querySelector("option");isNaN(t.value)||((t=document.createElement("option")).innerHTML=toLanguage("Custom","Personnalis√©"),n.insertBefore(t,n.firstChild)),t.value=JSON.stringify(e),n.selectedIndex=0,n.currentValue=n.value},e)):this.currentValue=this.value},h.appendChild(y),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-doubleItems-ctn",isOnline||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-doubleItems",r.name="option-doubleItems",r.type="checkbox",e&&0==e.doubleItems&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-doubleItems"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Disable double items","D√©sactiver les double objets"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If checked, you can only hold one item in reserve","Si coch√©, vous ne pouvez garder qu'un seul objet en r√©serve"),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-cpu",r.name="option-cpu",r.type="checkbox",e&&e.cpu&&(r.checked=!0),r.onchange=function(){var e,t;this.checked?(document.getElementById("option-cpuCount-ctn").style.display="",isBattle||(document.getElementById("option-cpuLevel-ctn").style.display=""),document.getElementById("option-cpuNames-ctn").style.display="",document.getElementById("option-cpuChars-ctn").style.display="",(e=document.getElementById("option-cpuCount")).value=Math.max(e.value,3),t=this.parentNode.parentNode,setTimeout(function(){e.select(),a.scrollTop=t.offsetTop},1)):(document.getElementById("option-cpuCount-ctn").style.display="none",document.getElementById("option-cpuLevel-ctn").style.display="none",document.getElementById("option-cpuNames-ctn").style.display="none",document.getElementById("option-cpuChars-ctn").style.display="none")},l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpu"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Add CPUs","Ajouter des ordis"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, bots will be added to the game if there is not enough players","Si activ√©, des bots seront ajout√©s √† la partie s'il n'y a pas assez de joueurs"),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuCount-ctn",e&&e.cpu||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuCount"),(c=document.createElement("h1")).style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Total number of participants","Nombre total de participants"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If there isn't enough players, bots will be added to match the specified number of participants","S'il n'y a pas assez de joueurs, des bots seront ajout√©s pour matcher le nombre de participants sp√©cifi√©"),s.appendChild(p),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",h.style.marginRight=3*iScreenScale+"px",(t=document.createElement("input")).id="option-cpuCount",t.name="option-cpuCount",t.type="number",t.setAttribute("min",2),t.setAttribute("max",12),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.cpuCount?t.value=e.cpuCount:t.value=defaultGameOptions.cpuCount,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",h.appendChild(t),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuLevel-ctn",e&&e.cpu&&!isBattle||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuLevel"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("CPU difficulty","Difficult√© des ordis"),c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(y=document.createElement("select")).id="option-cpuLevel",y.name="option-cpuLevel",y.style.backgroundColor="black",y.style.width=14*iScreenScale+"px",y.style.fontSize=Math.round(2.5*iScreenScale)+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var E,D=[toLanguage("Impossible","Impossible"),toLanguage("Extreme","Extr√™me"),toLanguage("Difficult","Difficile"),toLanguage("Medium","Moyen"),toLanguage("Easy","Facile")],d=0;d<D.length;d++)(E=document.createElement("option")).value=d-2,E.innerHTML=D[d],y.appendChild(E);e&&e.cpuLevel?y.value=e.cpuLevel:y.value=0,h.appendChild(y),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuNames-ctn",e&&e.cpu||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuNames"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("CPU names","Noms des ordis"),c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block";t=document.createElement("input");t.type="button",t.id="option-cpuNames",t.name="option-cpuNames",t.value=toLanguage("Set...","Sp√©cifier..."),t.style.backgroundColor="black",t.style.width=14*iScreenScale+"px",t.style.padding=Math.round(.2*iScreenScale)+"px "+Math.round(+iScreenScale)+"px",t.style.fontSize=Math.round(2*iScreenScale)+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",e&&e.cpuNames&&(t.dataset.value=JSON.stringify(e.cpuNames)),t.onclick=function(){var t,e,n=+this.form.elements["option-cpuCount"].value;2<n&&(e=(t=this).dataset.value?JSON.parse(this.dataset.value):[],selectCpuNamesScreen(P,function(e){t.dataset.value=JSON.stringify(e)},{names:e,count:n-2}))},h.appendChild(t),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuChars-ctn",e&&e.cpu||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuChars"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("CPU characters","Persos des ordis"),c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),m.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(t=document.createElement("input")).type="button",t.id="option-cpuChars",t.name="option-cpuChars",t.value=toLanguage("Set...","Sp√©cifier..."),t.style.backgroundColor="black",t.style.width=14*iScreenScale+"px",t.style.padding=Math.round(.2*iScreenScale)+"px "+Math.round(+iScreenScale)+"px",t.style.fontSize=Math.round(2*iScreenScale)+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",e&&e.cpuChars&&(t.dataset.value=JSON.stringify(e.cpuChars)),t.loadCpuChars=function(e){e&&(this.dataset.value=JSON.stringify(e)),P.style.visibility=""},t.onclick=function(){var e=+this.form.elements["option-cpuCount"].value;2<e&&(this.dataset.cpuChars=1,selectPlayerScreen(2,!(P.style.visibility="hidden"),e))},h.appendChild(t),m.appendChild(h),l.appendChild(m),i.appendChild(l),o.appendChild(i);var B,i=document.createElement("tr");(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-timeTrial",r.name="option-timeTrial",r.type="checkbox",e&&e.timeTrial&&(r.checked=!0),!isOnline||isBattle?i.style.display="none":(r.onclick=function(){document.getElementById("option-noBumps-ctn").style.display=this.checked?"none":""},B=r,setTimeout(function(){B.onclick()},1)),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-timeTrial"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Time Trial mode","Mode Contre-la-montre"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, the game is played like a time trial: no item boxes, no collisions with other players (they are ghosts), and you start with 3 shrooms.","Si activ√©, la partie se d√©roule comme en CLM : pas de bo√Ætes √† objets, pas de collisions avec les autres joueurs (ce sont des fant√¥mes), et vous commencez avec 3 champis."),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-noBumps-ctn",isOnline||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-noBumps",r.name="option-noBumps",r.type="checkbox",e&&e.noBumps&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-noBumps"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Disable kart bumps","D√©sactiver la collisions entre karts"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If checked, karts are not impacted when they hit each other (bumps)","Si coch√©, les karts ne sont pas impact√©s lorsqu'ils se rentrent dedans (bumps)"),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-noJump-ctn",isOnline||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-noJump",r.name="option-noJump",r.type="checkbox",e&&e.noJump&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-noJump"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Disable jumps","D√©sactiver les sauts"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If checked, it becomes impossible to jump, drift or make tricks","Si coch√©, il est impossible de faire des sauts, d√©rapages ou figures"),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-noRd-ctn",isOnline||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-noRd",r.name="option-noRd",r.type="checkbox",e&&e.noRd&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-noRd"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Disable Reverse Drift","D√©sactiver le Reverse Drift"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If checked, the famous MKPC drifting technique is blocked","Si coch√©, la fameuse technique de d√©rapage de MKPC est bloqu√©e"),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),a.appendChild(o),n.appendChild(a),(p=document.createElement("div")).style.textAlign="center",p.style.marginTop=2*iScreenScale+"px";o=document.createElement("input");o.type="submit",o.value=toLanguage("Validate","Valider"),o.style.fontSize=3*iScreenScale+"px",o.style.width=18*iScreenScale+"px",p.appendChild(o),n.appendChild(p),P.appendChild(n);n=document.createElement("input");n.type="button",n.value=toLanguage("Cancel","Annuler"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){P.innerHTML="",oContainers[0].removeChild(P),M(null)},P.appendChild(n);g=document.createElement("a");isOnline||(g.style.display="none"),g.href="#null",g.style.color="#CCF",g.innerHTML=toLanguage("Load options...","Charger des options..."),g.style.fontSize=Math.round(1.6*iScreenScale)+"px",g.style.position="absolute",g.style.right=3*iScreenScale+"px",g.style.top=35*iScreenScale+4+"px",g.onclick=function(e){e.preventDefault();var a=document.createElement("div");function o(e){var t;try{t=new URLSearchParams(new URL(e).search).get("key")}catch(e){}null!=t?(a.innerHTML="",xhr("getPrivGameOptions.php","key="+t,function(e){if(P.removeChild(a),!e)return alert(toLanguage("Invalid link","Lien invalide")),!0;try{e=JSON.parse(e)}catch(e){}return P.innerHTML="",oContainers[0].removeChild(P),privateGameOptions(e,M),!0})):alert(toLanguage("Invalid URL","URL invalide"))}a.className="fsmask options-load-screen",a.style.fontSize=2*iScreenScale+"px",a.innerHTML='<div><a class="close" href="#null">&times;</a><h1>'+toLanguage("Load private game options","Charger options partie priv√©e")+"</h1><div>"+toLanguage("This menu lets you import options from a previous private game.","Ce menu vous permet d'importer des options d'une partie priv√©e pr√©c√©dente.")+'</div><form class="private-link-form"><input type="url" required="required" name="private-link" placeholder="'+document.location.origin+'/online.php?key=20100620" /><input type="submit" value="Ok" /></form><div class="saved-links-ctn"><h2>'+toLanguage("Saved options","Options sauvegard√©es")+'</h2><div class="saved-links"></div><div class="saved-links-add">‚òÜ <a href="#null">'+toLanguage("Save current private link options","Sauvegarder les options actuelles")+"</a></div></div></div>",a.querySelector(".private-link-form").onsubmit=function(e){e.preventDefault(),o(e.target.elements["private-link"].value)};var i=a.querySelector(".saved-links"),r=loadOptionLinks();function t(){for(var e=0;e<r.length;e++){var t=r[e],n=document.createElement("div");n.className="saved-link",n.innerHTML='<div class="saved-link-data"><div class="saved-link-name">'+t.name+'</div><div class="saved-link-url">'+t.url+'</div></div><div class="saved-link-options"><button class="saved-link-edit">‚úé</button><button class="saved-link-del">&times;</button></div>',function(t){n.onclick=function(){o(t.url)},n.querySelector(".saved-link-edit").onclick=function(){var e=prompt(toLanguage("New options name:","Renommer ces options :"),t.name);e&&e!==t.name&&(t.name=e,l())},n.querySelector(".saved-link-del").onclick=function(){confirm(toLanguage('Delete options set "'+t.name+'"?',"Supprimer le jeu d'options \""+t.name+'" ?'))&&(r.splice(r.indexOf(t),1),l())},n.querySelector(".saved-link-options").onclick=function(e){e.stopPropagation()}}(t),i.appendChild(n)}r.length?shareLink.key||(a.querySelector(".saved-links-add").style.display="none"):(i.innerHTML='<div class="no-link">'+toLanguage("No saved options","Aucune option sauvegard√©e")+"</div>",shareLink.key||(a.querySelector(".saved-links-ctn").style.display="none"))}function l(){storeOptionLinks(r),i.innerHTML="",t()}t();e=a.querySelector(".close");e.style.left=(iWidth-9)*iScreenScale+5+"px",e.onclick=function(e){e.preventDefault(),P.removeChild(a)},a.querySelector(".saved-links-add a").onclick=function(e){e.preventDefault();e=prompt(toLanguage("Name for your options set:","Nom pour le jeu d'options :"));e&&(r.push({name:e,url:document.location.href}),a.querySelector(".saved-links-add").style.display="none",l())},P.appendChild(a)},P.appendChild(g),oContainers[0].appendChild(P)}function loadOptionLinks(){var e=localStorage.getItem("privgameopts");return e?JSON.parse(e):[]}function storeOptionLinks(e){e.sort(function(e,t){return e.name.localeCompare(t.name)}),localStorage.setItem("privgameopts",JSON.stringify(e))}function privateLink(e){var l=document.createElement("div"),t=l.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",l.appendChild(toTitle(toLanguage("Private game","Partie priv√©e"),0));var s=isCustomOptions(e);xhr("privateGame.php",s?"options="+encodeURIComponent(JSON.stringify(e)):null,function(e){if(e){var t=shareLink.url,n=shareLink.params.slice(0);n.push("key="+e);var a,o,i,r=t+"?"+n.join("&"),n=document.createElement("div");return n.style.position="absolute",n.style.left="0px",n.style.top=12*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px",n.style.textAlign="center",n.style.fontSize=3*iScreenScale+"px",n.style.color="#CFC",n.innerHTML=language?'The following private link has been generated:<br /><a href="'+r+'" style="color:AAF">'+r+"</a><br /><br />Enjoy game :)":'Le lien priv√© suivant a √©t√© g√©n√©r√© :<br /><a href="'+r+'" style="color:AAF">'+r+"</a><br /><br />Bonne partie :)",l.appendChild(n),s&&((a=document.createElement("input")).type="button",a.style.position="absolute",a.style.right=+iScreenScale+"px",a.style.top=33*iScreenScale+"px",a.style.fontSize=Math.round(1.7*iScreenScale)+"px",a.value="‚òÜ "+toLanguage("Save game options...","Sauvegarder options partie priv√©e"),a.onclick=function(){var t,n,e=prompt(toLanguage("Options name:","Nom des options :"));e&&(t=loadOptionLinks(),n={name:e,url:r},t.push(n),storeOptionLinks(t),l.removeChild(a),l.appendChild(o),i.onclick=function(e){e.preventDefault(),t.splice(t.indexOf(n),1),storeOptionLinks(t),l.removeChild(o),l.appendChild(a)})},l.appendChild(a),(o=document.createElement("div")).style.color="white",o.style.position="absolute",o.style.left=+iScreenScale+"px",o.style.width=iScreenScale*(iWidth-2)+"px",o.style.top=33*iScreenScale+"px",o.style.textAlign="center",o.style.fontSize=2*iScreenScale+"px",o.innerHTML=toLanguage("Options saved, you can access them by clicking on &quot;Load options...&quot; in private game options screen ","Options sauvegard√©es, vous pourrez y acc√©der en cliquannt sur &quot;Charger des options...&quot; dans les options de partie priv√©e "),(i=document.createElement("a")).href="#null",i.style.color="#ccf",i.style.textDecoration="none",i.innerHTML=toLanguage("[Undo]","[Annuler]"),o.appendChild(i)),!0}return!1}),oContainers[0].appendChild(l)}function selectTypeScreen(){var e=document.createElement("div"),t=e.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black";var n=new Image;if(n.src="images/mariokart.png",n.style.position="absolute",n.style.width=Math.round(42.5*iScreenScale)+"px",n.style.height=5*iScreenScale+"px",n.style.left=Math.round((iWidth-42.5)/2*iScreenScale)+"px",n.style.top=2*iScreenScale+"px",e.appendChild(n),(t=e.style).width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",oContainers[0].appendChild(e),"MK"==page){var a=11;(r=document.createElement("input")).type="button",r.value="Grand Prix",r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=10*iScreenScale+"px",r.style.top=a*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="GP",e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Time trial","Contre-la-montre"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=41*iScreenScale+"px",r.style.top=a*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="CM",e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("VS","Course VS"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=iScreenScale+"px",r.style.top=(a+8)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="VS",e.innerHTML="",oContainers[0].removeChild(e),selectNbJoueurs()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Battle","Bataille"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=50*iScreenScale+"px",r.style.top=(a+8)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="BB",e.innerHTML="",oContainers[0].removeChild(e),selectNbJoueurs()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Track builder","√âditeur de circuit"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=10*iScreenScale+"px",r.style.top=(a+16)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeCreate()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Online race","Course en ligne"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=41*iScreenScale+"px",r.style.top=(a+16)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="VS",e.innerHTML="",oContainers[0].removeChild(e),selectOnlineScreen()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Home","Accueil"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=35*iScreenScale+2+"px",r.onclick=function(){document.location.href="index.php"},e.appendChild(r)}else{var o,r,a=12,l=[toLanguage("VS","Course VS")],s=["VS"];for(isSingle||(l.unshift("Grand Prix"),s.unshift("GP")),(hasChallenges()||myCircuit)&&(l.push(toLanguage("Challenges","D√©fis")),s.push("CH")),!nid&&isSingle||(l.push(toLanguage("Time Trial","Contre-la-montre")),s.push("CM")),!nid||isSingle&&complete&&!cShared||(l.push(toLanguage("Online race","Course en ligne")),s.push("CL")),!isSingle&&cupScore&&((p=new Image).src="images/cups/cup"+(4-cupScore)+".png",p.style.width=Math.round(4*iScreenScale)+"px",p.style.height=Math.round(4*iScreenScale)+"px",p.style.position="absolute",l.length<5?(p.style.left=3*iScreenScale+"px",p.style.top=Math.round((a+4)*iScreenScale)+"px"):(p.style.left=5*iScreenScale+"px",p.style.top=Math.round((a-1)*iScreenScale)+"px"),p.className="pixelated",e.appendChild(p)),i=0;i<l.length;i++)(r=document.createElement("input")).type="button",r.value=l[i],r.style.position="absolute",l.length<4?(n.style.top=3*iScreenScale+"px",r.style.left=20*iScreenScale+"px",r.style.top=Math.round((a+6.5*i)*iScreenScale)+"px",r.style.width=38*iScreenScale+"px",r.style.fontSize=Math.round(3.5*iScreenScale)+"px"):4==l.length?(n.style.top=4*iScreenScale+"px",r.style.left=(8+i%2*36)*iScreenScale+"px",r.style.top=(a+4+8*Math.floor(i/2))*iScreenScale+"px",r.style.width=28*iScreenScale+"px",r.style.fontSize=3*iScreenScale+"px"):(o=[[10,a-1],[40,a-1],[25,a+7],[10,a+15],[40,a+15]][i],r.style.left=o[0]*iScreenScale+"px",r.style.top=o[1]*iScreenScale+"px",r.style.fontSize=3*iScreenScale+"px",r.style.width=29*iScreenScale+"px"),r.dataset||(r.dataset={}),r.dataset.course=s[i],r.onclick=function(){course=this.dataset.course,"CL"==course?document.location.href=onlineModeLink():(e.innerHTML="",oContainers[0].removeChild(e),"VS"==course?selectNbJoueurs():"CH"==course?selectChallengesScreen():selectPlayerScreen(0))},e.appendChild(r);(r=document.createElement("input")).type="button",r.value=toLanguage("Back","Retour"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=35*iScreenScale+"px",r.onclick=function(){exitCircuit()},e.appendChild(r)}var c=document.createElement("img");c.src="images/english.png",c.alt="En",c.style.position="absolute",c.style.left=68*iScreenScale+"px",c.style.top=35*iScreenScale+"px",c.style.width=4*iScreenScale+"px",c.style.height=Math.round(8*iScreenScale/3)+"px";t=document.createElement("img");t.src="images/french.png",c.alt="Fr",t.style.position="absolute",t.style.left=74*iScreenScale+"px",t.style.top=35*iScreenScale+"px",t.style.width=4*iScreenScale+"px",t.style.height=Math.round(8*iScreenScale/3)+"px";var p=language?c:t,u=language?t:c;p.style.border="solid 1px "+primaryColor,u.style.border="solid 1px transparent",u.style.cursor="pointer",u.onmouseover=function(){u.style.border="solid 1px "+primaryColor},u.onmouseout=function(){u.style.border="solid 1px transparent"},u.onclick=function(){language=!language,xhr("setLanguage.php","nLanguage="+ +language,function(e){return 1==e&&(location.reload(),!0)})},e.appendChild(c),e.appendChild(t),updateMenuMusic(0)}function selectMainPage(){switch(page){case"OL":mId?selectPlayerScreen(0):connexion();break;case"MK":selectTypeScreen();break;case"CI":case"MA":nid?selectTypeScreen():(course="VS",selectNbJoueurs());break;case"BA":case"AR":course="BB",selectNbJoueurs()}}function selectNbJoueurs(e){if(!clSelected||e){var t=document.createElement("div"),e=t.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",t.appendChild(toTitle(toLanguage("Number of players","Nombre de joueurs"),.5));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){isBattle||isCup&&!nid?exitCircuit():(t.innerHTML="",oContainers[0].removeChild(t),selectTypeScreen())},t.appendChild(n);var a=isBattle&&cShared;for(i=1;i<=2;i++)(n=document.createElement("input")).type="button",n.id="select-nbj-"+i,n.value=i+(i<2?"  ":" ")+toLanguage("player","joueur")+(i<2?" ":"s"),n.style.fontSize=4*iScreenScale+"px",n.style.position="absolute",n.style.left=(a?26:27)*iScreenScale+"px",n.style.top=((a?7:10)+i*(a?7:8))*iScreenScale+"px",a&&(n.style.width=22*iScreenScale+"px"),n.onclick=function(){var e;t.innerHTML="",oContainers[0].removeChild(t),"2"==this.value.charAt(0)&&(clSelected=null,(e=oContainers[0].cloneNode(!1)).style.left=12+iWidth*iScreenScale+"px",oContainers.push(e)),selectPlayerScreen(0)},t.appendChild(n);a&&((n=document.createElement("input")).type="button",n.value=toLanguage(" Online mode ","Mode en ligne"),n.style.fontSize=3*iScreenScale+"px",n.style.position="absolute",n.style.left=26*iScreenScale+"px",n.style.top=30*iScreenScale+"px",n.style.width=22*iScreenScale+"px",n.style.paddingTop=Math.round(.5*iScreenScale)+"px",n.style.paddingBottom=Math.round(.5*iScreenScale)+"px",n.onclick=function(){document.location.href=onlineModeLink()},t.appendChild(n)),oContainers[0].appendChild(t),!myCircuit&&!hasChallenges()||nid&&!isBattle||((n=document.createElement("input")).type="button",n.value=toLanguage("Challenges...","D√©fis..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.right=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectChallengesScreen()},t.appendChild(n)),updateMenuMusic(0)}else selectPlayerScreen(0)}function selectOnlineScreen(t){var e=document.createElement("div"),n=e.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",e.appendChild(toTitle(toLanguage("Online mode","Mode en ligne"),2));n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeScreen()},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("More options...","Plus d'options..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=60*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateGameOptions(t,function(e){e&&(isCustomOptions(t=e)||(t=null)),selectOnlineScreen(t)})},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=language?"VS mode":"Course VS",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=17*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),openOnlineMode(!1,t)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=language?"Battle mode":"Bataille de ballons",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=25*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),openOnlineMode(!0,t)},e.appendChild(n),oContainers[0].appendChild(e),updateMenuMusic(0)}function onlineModeLink(){return"online.php?"+(isMCups?"mid="+nid:(isSingle?complete?"i":"id":complete?"cid":"sid")+"="+nid)+(isBattle?"&battle":"")}function openOnlineMode(t,e){e?xhr("onlineOptions.php","options="+encodeURIComponent(JSON.stringify(e)),function(e){return!!e&&(document.location.href="online.php?"+(t?"battle&":"")+"key="+e,!0)}):document.location.href="online.php"+(t?"?battle":"")}function openChallengeEditor(){clId&&!edittingCircuit?document.location.href="challenges.php?cl="+clId:document.location.href=document.location.href.replace(/\/(\w+)\.php\?(.+)$/g,"/challenges.php?page=$1&$2")}function getCreationId(e){switch(page){case"CI":case"AR":return e.id}return e.map}function getCreationTable(){switch(page){case"CI":case"AR":return"mkcircuits";case"MA":return"circuits";case"BA":return"arenes"}return""}function selectTypeCreate(){var t=document.createElement("div"),e=t.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",t.appendChild(toTitle(toLanguage("Track builder","√âditeur de circuit")));var n=[{name:toLanguage("Quick mode","Mode simplifi√©"),description:toLanguage("Create a track in a few clicks thanks to ready-made pieces","Cr√©ez un circuit en quelques clics gr√¢ce √† des pi√®ces toutes faites"),thumbnail:"help/mode-simple.png"},{name:toLanguage("Complete mode","Mode complet"),description:toLanguage("Create the track entirely from an image you drew yourself","Cr√©ez enti√®rement le circuit √† partir d'une image dessin√©e par vous-m√™me"),thumbnail:"help/mode-complete.png"}],a=document.createElement("div");a.style.position="absolute",a.style.left=4*iScreenScale+"px",a.style.top=9*iScreenScale+"px",a.style.width=72*iScreenScale+"px";for(let e=0;e<n.length;e++){var o=n[e],i=document.createElement("div");i.innerHTML='<img src="images/'+o.thumbnail+'" alt="'+o.name+'" style="height: '+10*iScreenScale+'px" /><div style="padding: '+iScreenScale+"px "+Math.round(1.5*iScreenScale)+'px"><h2 style="font-size: 1.5em; margin: 0">'+o.name+'</h2><div style="color: white">'+o.description+"</div></div>",i.style.display="flex",i.style.direction="column",i.style.alignItems="center",i.style.width="100%",i.style.fontSize=Math.round(1.9*iScreenScale)+"px",i.style.margin=Math.round(1.5*iScreenScale)+"px 0",i.className="fakebtn",i.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectTrackCreate(e)},a.appendChild(i)}t.appendChild(a);e=document.createElement("a");e.style.color="#CCF",e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=toLanguage(30,29)*iScreenScale+"px",e.style.top=35*iScreenScale+"px",e.href="creations.php",e.onclick=function(){},e.innerHTML=toLanguage("List of creations","Liste des cr√©ations"),t.appendChild(e),oContainers[0].appendChild(t);e=document.createElement("input");e.type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=35*iScreenScale+"px",e.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectTypeScreen()},t.appendChild(e),updateMenuMusic(0)}function selectTrackCreate(e){var t=document.createElement("div"),n=t.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black";n=toTitle(e?toLanguage("Complete track builder","√âditeur complet"):toLanguage("Quick track builder","√âditeur simplifi√©"),0);n.style.fontSize=Math.round(7*iScreenScale)+"px",t.appendChild(n);var a=[{name:toLanguage("Circuit","Circuit"),url:e?"draw.php":"create.php",thumbnail:"help/build-circuit.png"},{name:toLanguage("Cup - Circuits","Coupe - Circuits"),url:e?"completecup.php":"simplecup.php",thumbnail:"help/build-cup-circuit.png"},{name:toLanguage("Multicup - Circuits","Multicoupe - Circuits"),url:e?"completecups.php":"simplecups.php",thumbnail:"help/build-multicup-circuit.png"},{name:toLanguage("Arena","Ar√®ne"),url:e?"course.php":"arene.php",thumbnail:"help/build-arena.png"},{name:toLanguage("Cup - Arenas","Coupe - Ar√®nes"),url:e?"completecup.php?battle":"simplecup.php?battle",thumbnail:"help/build-cup-arena.png"},{name:toLanguage("Multicup - Arenas","Multicoupe - Ar√®nes"),url:e?"completecups.php?battle":"simplecups.php?battle",thumbnail:"help/build-multicup-arena.png"}],o=document.createElement("div");o.style.display="grid",o.style.position="absolute",o.style.left=14*iScreenScale+"px",o.style.top=9*iScreenScale+"px",o.style.width=60*iScreenScale+"px",o.style.display="grid",o.style.gridTemplateColumns=14*iScreenScale+"px "+18*iScreenScale+"px "+20*iScreenScale+"px",o.style.columnGap=2*iScreenScale+"px",o.style.fontSize=2*iScreenScale+"px",o.style.textAlign="center",o.style.backgroundColor="#000C",o.style.paddingBottom="1px",o.style.zIndex=1;for(e=0;e<a.length;e++){var i=a[e],r=document.createElement("a");r.href=i.url,r.onclick=function(){},r.style.display="block",r.style.paddingTop=Math.round(iScreenScale/2)+"px",r.style.paddingBottom=Math.round(iScreenScale/4)+"px",r.style.marginBottom=Math.round(iScreenScale/4)+"px",r.style.color="#EEE",r.style.textDecoration="none",r.style.borderRadius=Math.round(iScreenScale/2)+"px",r.innerHTML='<img src="images/'+i.thumbnail+'" style="width: '+10*iScreenScale+"px; height: "+9*iScreenScale+'px" alt="'+i.name+'" /><div style="margin-top: '+Math.round(iScreenScale/2)+'px">'+i.name+"</div>",r.onmouseover=function(){this.style.backgroundColor="rgb(38 85 177)"},r.onmouseout=function(){this.style.backgroundColor=""},r.style.cursor="pointer",o.appendChild(r)}t.appendChild(o);n=document.createElement("a");n.style.color="#CCF",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=toLanguage(30,29)*iScreenScale+"px",n.style.top=36*iScreenScale+"px",n.href="creations.php",n.onclick=function(){},n.innerHTML=toLanguage("List of creations","Liste des cr√©ations"),t.appendChild(n),oContainers[0].appendChild(t);n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=36*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectTypeCreate()},t.appendChild(n),oContainers[0].appendChild(t),updateMenuMusic(0)}function selectPlayerScreen(IdJ,newP,nbSels,additionalOptions){var isCustomSel=void 0!==nbSels,force=-1===IdJ;if(force&&(IdJ=0),!IdJ){for(joueurs in strPlayer=[],aPlayers=[],cp)aPlayers.push(joueurs);updateCommandSheet()}var itemMode=getItemMode(),modeItemDistributions=itemDistributions[itemMode].concat(customItemDistrib[itemMode]),modePtDistributions=ptDistributions.concat(customPtDistrib),selectedOpponents;fInfos=fInfos||{};var oScr=document.createElement("div");newP&&(oScr.style.visibility="hidden");var oStyle=oScr.style;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black";var shrinkAll=("VS"==course||"BB"==course)&&!clSelected,oTitle,oMsg,oMsg,oTitle;isCustomSel?(oMsg=isOnline?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ-1):IdJ>=oContainers.length?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ+1-oContainers.length):1==oContainers.length?toLanguage("Choose player","Choisissez joueur"):toLanguage("Choose player ","Choisissez joueur ")+(IdJ+1),oTitle=toTitle(oMsg,-1),oTitle.style.color="#F90"):oTitle=toTitle(toLanguage("Select a player","Choisissez un joueur"),-1),shrinkAll&&(oTitle.style.fontSize=Math.round(7.5*iScreenScale)+"px"),oScr.appendChild(oTitle);var baseY=shrinkAll?8:10,customCharsEnabled=0!==cupOpts.customchars,cTable=document.createElement("table");cTable.style.display="none",cTable.style.position="absolute",cTable.style.zIndex=2,cTable.style.top=36*iScreenScale+16+"px",cTable.style.left=25*iScreenScale-60+"px",cTable.style.textAlign="left",cTable.style.fontSize=2*iScreenScale+"px",cTable.style.color="white",cTable.style.backgroundColor="black",cTable.style.backgroundColor="rgba(0,0,0, 0.8)",cTable.setAttribute("cellpadding",2),cTable.setAttribute("cellspacing",2),document.body.appendChild(cTable);var hTr=document.createElement("tr"),hTd1=document.createElement("td");hTd1.innerHTML="&nbsp;",hTr.appendChild(hTd1);var hTd2=document.createElement("td");hTd2.innerHTML="&nbsp;",hTd2.style.fontWeight="bold",hTr.appendChild(hTd2),cTable.appendChild(hTr);for(var sCaracteristiques=[toLanguage("Acceleration","Acc√©l√©ration"),toLanguage("Max speed","Vitesse max"),toLanguage("Handling","Maniabilit√©"),toLanguage("Weight","Poids")],dCaracteristiques=new Array,i=0,rotateHandler;i<sCaracteristiques.length;i++){var oTr=document.createElement("tr"),oTd1=document.createElement("td");oTd1.className="rgt",oTd1.innerHTML=sCaracteristiques[i]+" :",oTr.appendChild(oTd1);var oTd2=document.createElement("td");dCaracteristiques[i]=document.createElement("div"),dCaracteristiques[i].style.backgroundColor="#838057",dCaracteristiques[i].style.border="solid 1px silver",dCaracteristiques[i].style.height=2*iScreenScale+"px",dCaracteristiques[i].innerHTML="&nbsp;",oTd2.appendChild(dCaracteristiques[i]),oTr.appendChild(oTd2),cTable.appendChild(oTr)}var jScreenScale=iScreenScale,oItemSelect,oPointSelect,oClassSelect,oDoubleItemCheckbox;function tourner(e){var t=Math.round(5*jScreenScale*(e.naturalWidth/768)),n=parseFloat(e.style.left);-21*t<n?e.style.left=n-t+"px":e.naturalWidth?(t=Math.min(5*e.naturalWidth/768,5.8),e.style.left=-Math.round(jScreenScale*(5*e.naturalWidth/768-t)/2)+"px"):e.style.left="0px",rotateHandler=setTimeout(function(){tourner(e)},100)}function createPersoSelector(e){var d=document.createElement("div");d.style.backgroundColor="#78D0F8",d.style.position="absolute",d.style.width=5*jScreenScale+"px",d.style.height=5*jScreenScale+"px",d.style.borderTop="double 4px black",d.style.borderLeft="double 4px #F8F8F8",d.style.borderRight="double 4px #F8F8F8",d.style.borderBottom="solid 5px #00B800",d.style.cursor="pointer",d.id="perso-selector-"+e;var n=document.createElement("div");n.style.position="absolute",n.style.display="inline-block",n.style.width=5*jScreenScale+"px",n.style.height=5*jScreenScale+"px",n.style.overflow="hidden";var t=new Image;if(t.style.height=5*jScreenScale+"px",t.style.position="absolute",t.className="pixelated",pUnlockMap[e]){for(var a=!0,o=0;o<strPlayer.length;o++)if(strPlayer[o]==e){a=!1;break}t.src=(a?getSpriteSrc:getStarSrc)(e),t.alt=e,t.style.left=-30*jScreenScale+"px",t.j=IdJ,t.onload=function(){var e=Math.min(5*this.naturalWidth/768,5.8),t=Math.min(5*this.naturalHeight/32,5.8);n.style.width=Math.round(e*jScreenScale)+"px",n.style.height=Math.round(t*jScreenScale)+"px",this.style.width=24*Math.round(5*this.naturalWidth/768*jScreenScale)+"px",this.style.height=Math.round(5*this.naturalHeight/32*jScreenScale)+"px",this.style.left=-Math.round(6*Math.round(5*jScreenScale*this.naturalWidth/768)+jScreenScale*(5*this.naturalWidth/768-e)/2)+"px",this.style.top=Math.round((t-5*this.naturalHeight/32)*jScreenScale/2)+"px",n.style.left=Math.round((5-e)/2*jScreenScale)+"px",n.style.top=Math.round(1+(5-t)/2*jScreenScale)+"px"},d.onmouseover=function(){cTable.style.display="block";var e=n.firstChild;hTd2.innerHTML=toPerso(e.alt);for(var t=0;t<dCaracteristiques.length;t++)dCaracteristiques[t].style.width=5*iScreenScale*(8*cp[e.alt][t]+1)+"px";clearTimeout(rotateHandler),tourner(e)},d.onmouseout=function(){cTable.style.display="none";var e,t=n.firstChild;t.naturalWidth?(e=Math.min(5*t.naturalWidth/768,5.8),t.style.left=-Math.round(6*Math.round(5*jScreenScale*t.naturalWidth/768)+jScreenScale*(5*t.naturalWidth/768-e)/2)+"px"):t.style.left=-30*jScreenScale+"px",clearTimeout(rotateHandler)},d.onclick=function(){clearTimeout(rotateHandler);var e=d.firstChild.firstChild;strPlayer[e.j]=e.alt;var t,n="";if(isOnline||(n="VS"==course?(iDificulty=4+.5*selectedDifficulty,"difficulty="+selectedDifficulty+"&players="+fInfos.nbPlayers+"&team="+fInfos.teams):"players="+fInfos.nbPlayers+"&team="+fInfos.teams),oScr.innerHTML="",e.j++,oContainers[0].removeChild(oScr),document.body.removeChild(cTable),addMyPersos=function(){},oItemSelect?(selectedItemDistrib=modeItemDistributions[oItemSelect.value],localStorage.setItem("itemset."+itemMode,+oItemSelect.value)):selectedItemDistrib=modeItemDistributions[0],oPointSelect?(selectedPtDistrib=modePtDistributions[oPointSelect.value],localStorage.setItem("ptset",+oPointSelect.value)):selectedPtDistrib=modePtDistributions[0],oDoubleItemCheckbox?(oDoubleItemsEnabled=!oDoubleItemCheckbox.checked,(selectedDoubleItems=oDoubleItemsEnabled)?localStorage.removeItem("doubleitems"):localStorage.setItem("doubleitems","0")):oDoubleItemsEnabled=!0,oClassSelect?(selectedCc=parseInt(oClassSelect.value),selectedMirror=oClassSelect.value.endsWith("m"),fSelectedClass=getRelSpeedFromCc(+selectedCc),bSelectedMirror=selectedMirror,"hidden"!==oClassSelect.type&&(localStorage.setItem("cc",selectedCc),selectedMirror?localStorage.setItem("mirror",1):localStorage.removeItem("mirror"))):bSelectedMirror=!(fSelectedClass=1),e.j==(isCustomSel?nbSels:oContainers.length)){if(isOnline){if(isCustomSel){var a=document.querySelector("[data-cpu-chars]");return strPlayer.splice(0,2),a.loadCpuChars(strPlayer),void(strPlayer.length=0)}aPlayers=[strPlayer[0]],iRaceCount=0}else if("CM"==course)aPlayers=[];else{if(aPlayers=[],isCustomSel){for(var o=strPlayer.length-1;o>=oContainers.length;o--)aPlayers.push(strPlayer[o]);strPlayer.splice(oContainers.length)}else if(selectedOpponents){for(o=0;o<selectedOpponents.length;o++)aPlayers.push(selectedOpponents[o]);t=function(e){function t(){!n&&a&&e(),n--}for(var n=0,a=!1,o=0;o<selectedOpponents.length;o++){var i=selectedOpponents[o];isCustomPerso(i,{callback:t})?n++:!cp[i]&&baseCp0[i]&&(cp[i]=baseCp0[i])}a=!0,t()}}else{o=0;for(joueurs in cp)pUnlockMap[joueurs]&&(aPlayers.push(joueurs),o++);aPlayers.sort(function(){return.5-Math.random()});a="GP"!=course?fInfos.nbPlayers:8;if(aPlayers.length<a){var i=aPlayers.length;aPlayers.length=aPlayers.length*Math.ceil(a/aPlayers.length);for(o=i;o<aPlayers.length;o++)aPlayers[o]=aPlayers[o%i]}else for(o=0;o<aPlayers.length;o++)for(var r=aPlayers[o],l=0;l<strPlayer.length;l++)if(strPlayer[l]==r){aPlayers.splice(o,1),o--;break}a=aPlayers.length-a+strPlayer.length;aPlayers.splice(0,a)}aPlaces=[],aTeams=[],resetScores(),"GP"!=course&&(selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,xhr("updateCourseOptions.php",n,function(e){return 1==e}))}if(isOnline){var s,c={},p={nbTeams:1,minPlayers:1,maxPlayers:1,localScore:1,ptDistrib:1,friendly:1,cpu:1,cpuLevel:1,cpuNames:1,cpuChars:1,doubleItems:1};for(s in shareLink.options)p[s]||(c[s]=shareLink.options[s]);enableSpectatorMode||!isCustomOptions(c)||shareLink.accepted||shareLink.player==identifiant?searchCourse({enableSpectatorMode:enableSpectatorMode}):acceptRulesScreen()}else{function u(){isTeamPlay()?selectTeamScreen(0):selectTrackScreen()}t?t(u):u()}}else selectPlayerScreen(e.j,void 0,nbSels);e=/^cp-\w+-(\d+)$/g.exec(e.alt);e&&!d.dataset.autoset&&xhr("selectPerso.php","id="+e[1],function(){return!0})}}else t.src="images/kart_locked.png";return n.appendChild(t),d.appendChild(n),d}var maxCharsPerPage=24,charsPerLine=8,maxShownChars=Math.min(nBasePersos,maxCharsPerPage),minPersoX=8,maxPersoX=58.4,shiftX;customCharsEnabled||(shiftX=5,minPersoX+=shiftX,maxPersoX+=shiftX),maxCharsPerPage<nBasePersos&&(minPersoX+=3,maxPersoX+=3);var minPersoY=baseY,maxPersoY=baseY+14,midPersoX=(minPersoX+maxPersoX)/2,midPersoY=(minPersoY+maxPersoY)/2,lines=Math.ceil(maxShownChars/charsPerLine),charsPerLine=Math.ceil(maxShownChars/lines),tilePersoX=Math.min(9,(maxPersoX-minPersoX)/(charsPerLine-1)),tilePersoY=Math.min(8,(maxPersoY-minPersoY)/(lines-1)),tilePersoX=Math.min(tilePersoX,1.2*tilePersoY),charSelectors=[],curPage=0,myPersosOffset=maxCharsPerPage<nBasePersos?73:67,pages=Math.ceil(nBasePersos/24),pDiv,pPImg,aDeconnexion,eClassement,oPInput,oPInput;function showCharacters(e){for(var t=0;t<charSelectors.length;t++)charSelectors[t].remove();charSelectors=[];for(var n=Math.min(nBasePersos-e*maxCharsPerPage,maxCharsPerPage),t=0;t<n;t++){var a=t%charsPerLine,o=Math.floor(t/charsPerLine);a-=o<lines-1?(charsPerLine-1)/2:(n-1)%charsPerLine/2,o-=(lines-1)/2;var i=createPersoSelector(aPlayers[t+e*maxCharsPerPage]);i.style.left=Math.round((midPersoX+a*tilePersoX)*iScreenScale)+"px",i.style.top=Math.round((midPersoY+o*tilePersoY)*iScreenScale-8)+"px",charSelectors.push(i),oScr.appendChild(i)}}showCharacters(curPage),customCharsEnabled&&(pDiv=document.createElement("div"),pDiv.style.backgroundColor="#78D0F8",pDiv.style.position="absolute",pDiv.style.width=5*iScreenScale+"px",pDiv.style.height=5*iScreenScale+"px",pDiv.style.left=myPersosOffset*iScreenScale+"px",pDiv.style.top=(baseY+14)*iScreenScale-8+"px",pDiv.style.borderTop="double 4px black",pDiv.style.borderLeft="double 4px #F8F8F8",pDiv.style.borderRight="double 4px #F8F8F8",pDiv.style.borderBottom="solid 5px #00B800",pDiv.style.overflow="hidden",pPImg=new Image,pPImg.style.height=5*iScreenScale+"px",pPImg.style.position="absolute",pPImg.src="images/kart_persos.png",pPImg.style.cursor="pointer",pPImg.title=language?"Character editor":"√âditeur de personnages",pPImg.className="pixelated",pPImg.onclick=function(){window.open("choosePerso.php","chose","scrollbars=1, resizable=1, width=500, height=500")},pDiv.appendChild(pPImg),oScr.appendChild(pDiv)),oContainers[0].appendChild(oScr),isOnline&&(isCustomSel||(aDeconnexion=document.createElement("a"),aDeconnexion.style.color="white",aDeconnexion.style.fontSize=2*iScreenScale+"px",aDeconnexion.style.position="absolute",aDeconnexion.style.left=24*iScreenScale+"px",aDeconnexion.style.top=34*iScreenScale+"px",aDeconnexion.innerHTML=toLanguage("Log out","D√©connexion"),aDeconnexion.href="#null",aDeconnexion.onclick=function(){return oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),displayCommands(),mPseudo="",mCode="",connexion(),xhr("deco.php",null,function(){return!0}),!1},oScr.appendChild(aDeconnexion),eClassement=document.createElement("a"),eClassement.style.fontSize=2*iScreenScale+"px",eClassement.style.position="absolute",eClassement.style.left=41*iScreenScale+"px",eClassement.style.top=34*iScreenScale+"px",eClassement.innerHTML=toLanguage("Rankings","Classement"),shareLink.options&&shareLink.options.localScore?(eClassement.title=toLanguage("Private game ranking","Classement partie priv√©e"),eClassement.style.color="#CF8",eClassement.setAttribute("href","localscores.php"+window.location.search)):(eClassement.style.color="white",eClassement.setAttribute("href","bestscores.php"+("BB"==course?"?battle":""))),eClassement.onclick=function(){},oScr.appendChild(eClassement),shareLink.key?shareLink.player==identifiant&&(oPInput=document.createElement("input"),oPInput.type="button",oPInput.value=toLanguage("Private game options...","Options partie priv√©e..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=56*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGameOptions(shareLink.options,function(t){t&&(isCustomOptions(t)||isCustomOptions(shareLink.options))?xhr("privateGameOptions.php","key="+shareLink.key+"&options="+encodeURIComponent(JSON.stringify(t)),function(e){return 1==e&&(shareLink.options||(shareLink.options={}),shareLink.options.team=t.team,shareLink.options.manualTeams=t.manualTeams,shareLink.options.friendlyFire=t.friendlyFire,shareLink.options.nbTeams=t.nbTeams,shareLink.options.teamOpts=t.teamOpts,shareLink.options.localScore=t.localScore,shareLink.options.friendly=t.friendly,shareLink.options.minPlayers=t.minPlayers,shareLink.options.maxPlayers=t.maxPlayers,shareLink.options.cc=t.cc,shareLink.options.mirror=t.mirror,shareLink.options.itemDistrib=t.itemDistrib,shareLink.options.ptDistrib=t.ptDistrib,shareLink.options.cpu=t.cpu,shareLink.options.cpuCount=t.cpuCount,shareLink.options.cpuLevel=t.cpuLevel,shareLink.options.cpuNames=t.cpuNames,shareLink.options.cpuChars=t.cpuChars,shareLink.options.timeTrial=t.timeTrial,shareLink.options.noBumps=t.noBumps,shareLink.options.noJump=t.noJump,shareLink.options.noRd=t.noRd,shareLink.options.doubleItems=t.doubleItems,selectedTeams=t.team,selectPlayerScreen(0),!0)}):selectPlayerScreen(0)})},oScr.appendChild(oPInput)):(oPInput=document.createElement("input"),oPInput.type="button",oPInput.value=toLanguage("Private game...","Partie priv√©e..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=62*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGame()},oScr.appendChild(oPInput))));var enableSpectatorMode=!1,oTeamsDiv,oParticipantsDiv,oClassement,oStepCtn,oStepBack,progress,lastProgress,oStepValue,lastPageButton,nextPageButton;if(isOnline&&!isCustomSel){additionalOptions&&additionalOptions.enableSpectatorMode&&(enableSpectatorMode=!0);var $spectatorModeCtn=document.createElement("div");$spectatorModeCtn.style.position="absolute",$spectatorModeCtn.style.left=toLanguage(24,21)*iScreenScale+"px",$spectatorModeCtn.style.top=29*iScreenScale+"px",$spectatorModeCtn.style.fontSize=Math.round(2*iScreenScale)+"px",$spectatorModeCtn.style.display="flex",$spectatorModeCtn.style.alignItems="center";var $spectatorModeLabel=document.createElement("label");$spectatorModeLabel.style.display="inline-flex",$spectatorModeLabel.style.alignItems="center",$spectatorModeLabel.style.cursor="pointer",$spectatorModeLabel.style.gap=Math.round(.5*iScreenScale)+"px",$spectatorModeLabel.style.marginRight=iScreenScale+"px";var $spectatorModeCheckbox=document.createElement("input");$spectatorModeCheckbox.type="checkbox",$spectatorModeCheckbox.checked=enableSpectatorMode,$spectatorModeCheckbox.style.transform="scale("+iScreenScale/8+")",$spectatorModeCheckbox.style.transformOrigin="center",$spectatorModeCheckbox.style.marginRight=iScreenScale-5+"px",$spectatorModeCheckbox.onclick=function(){enableSpectatorMode=this.checked},$spectatorModeLabel.appendChild($spectatorModeCheckbox);var $spectatorModeCheckboxText=document.createElement("span");$spectatorModeCheckboxText.innerHTML=toLanguage("Join in spectator mode","Rejoindre en mode spectateur"),$spectatorModeLabel.appendChild($spectatorModeCheckboxText),$spectatorModeCtn.appendChild($spectatorModeLabel);var $spectatorModeHelp=document.createElement("a");$spectatorModeHelp.href="#null",$spectatorModeHelp.style.color="#CCF",$spectatorModeHelp.innerHTML="[?]",$spectatorModeHelp.style.cursor="help",$spectatorModeHelp.onclick=function(){return!1},$spectatorModeHelp.dataset.noselect="1",$spectatorModeCtn.appendChild($spectatorModeHelp),addFancyTitle({elt:$spectatorModeHelp,title:toLanguage("Check this to see races<br />without playing on them","Cochez cette case pour voir<br />les courses sans y participer"),style:function(e){return{left:e.left-10*iScreenScale+"px",top:e.top+4*iScreenScale+"px",backgroundColor:"rgba(51,51,160, 0.95)"}}}),oScr.appendChild($spectatorModeCtn)}else if("VS"==course||"BB"==course){var oForm=document.createElement("form");if(oForm.onsubmit=function(){return!1},oForm.style.position="absolute",oForm.style.top=(baseY+21)*iScreenScale-5+"px",oForm.style.left=18*iScreenScale+"px",oForm.style.fontSize=2*iScreenScale+"px",oForm.style.zIndex=2,IdJ||newP||(iDificulty=selectedDifficulty,fInfos.nbPlayers=selectedPlayers,fInfos.teams=selectedTeams,fInfos.nbteams=+selectedNbTeams,fInfos.friendlyFire=!!selectedFriendlyFire),"VS"==course){var oDiffDiv=document.createElement("label");oDiffDiv.appendChild(document.createTextNode(toLanguage("Difficulty: ","Difficult√© : ")));var iDifficulties=[toLanguage("Easy","Facile"),toLanguage("Medium","Moyen"),toLanguage("Difficult","Difficile"),toLanguage("Extreme","Extr√™me"),toLanguage("Impossible","Impossible")],oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width="auto",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.style.marginRight="10px",oSelect.onchange=function(){selectedDifficulty=this.selectedIndex};for(var i=0;i<iDifficulties.length;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=iDifficulties[i],selectedDifficulty==i&&(oOption.selected="selected"),oSelect.appendChild(oOption)}oDiffDiv.appendChild(oSelect),oForm.appendChild(oDiffDiv)}else iDificulty=4.5;oTeamsDiv=document.createElement("label"),oTeamsDiv.appendChild(document.createTextNode(toLanguage("Teams: ","√âquipes : ")));var oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width=15*iScreenScale+15+"px",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.onchange=function(){fInfos.teams=this.selectedIndex};for(var iTeams=[toLanguage("No teams","Chacun pour soi"),toLanguage("Team Game","Match par √©quipes")],i=0;i<iTeams.length;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=iTeams[i],selectedTeams==i&&(oOption.selected="selected"),oSelect.appendChild(oOption)}oTeamsDiv.appendChild(oSelect),oForm.appendChild(oTeamsDiv),oParticipantsDiv=document.createElement("label"),oParticipantsDiv.style.display="block",oParticipantsDiv.appendChild(document.createTextNode(toLanguage("Number of participants","Nombre de participants ")+": "));var oSelect=document.createElement("select");function setCustomValue(e,t,n){void 0===n&&(n=t);for(var a=e.getElementsByTagName("option"),o=0;o<a.length;o++){var i=a[o].value;if(i==t){e.selectedIndex=o;break}if(-1==i||parseInt(i)>parseInt(t)){i=document.createElement("option");i.value=t,i.innerHTML=n,e.insertBefore(i,a[o]),e.selectedIndex=o;break}}e.value=t}oSelect.name="nbj",oSelect.style.width=3*iScreenScale+20+"px",oSelect.style.fontSize=2*iScreenScale+"px";for(var i=2;i<=8;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=i,oSelect.appendChild(oOption)}var oOption=document.createElement("option");oOption.value=-1,oOption.innerHTML=toLanguage("More...","Plus..."),oSelect.appendChild(oOption),setCustomValue(oSelect,fInfos.nbPlayers),oSelect.onchange=function(){var e;-1==this.value&&(e=parseInt(prompt(toLanguage("Number of players:","Nombre de joueurs :"))),!isNaN(e)&&1<e?setCustomValue(this,Math.min(e,999)):(isNaN(e)||alert(toLanguage("Invalid value","Valeur invalide")),setCustomValue(this,fInfos.nbPlayers))),fInfos.nbPlayers=parseInt(this.value)},oParticipantsDiv.appendChild(oSelect);var oChoosePerso=document.createElement("a");if(oChoosePerso.innerHTML=toLanguage("Choose characters...","Choix des persos..."),oChoosePerso.href="#null",oChoosePerso.style.display="inline-block",oChoosePerso.style.marginLeft=2*iScreenScale+"px",oChoosePerso.style.color="white",oChoosePerso.onclick=function(){return iDificulty=selectedDifficulty,selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,oItemSelect&&localStorage.setItem("itemset."+itemMode,+oItemSelect.value),clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,!1,fInfos.nbPlayers),!1},oParticipantsDiv.appendChild(oChoosePerso),oForm.appendChild(oParticipantsDiv),clSelected){var ccConstraint=getCcConstraint(clSelected);ccConstraint&&(oClassSelect=document.createElement("input"),oClassSelect.type="hidden",oClassSelect.value=ccConstraint)}else{var oClassDiv=document.createElement("label");oClassDiv.style.display="block",oClassDiv.appendChild(document.createTextNode(toLanguage("Class","Cylindr√©e ")+": ")),oClassSelect=document.createElement("select"),oClassSelect.name="cc",oClassSelect.style.width=10*iScreenScale+"px",oClassSelect.style.fontSize=2*iScreenScale+"px";for(var oClasses=[50,100,150,150,200],oMirrors=[!1,!1,!1,!0,!1],isSelectedCc=!1,i=0;i<oClasses.length;i++){var oClass=oClasses[i],oMirror=oMirrors[i],oClassOption=document.createElement("option");oClassOption.value=oClass+(oMirror?"m":""),oClassOption.innerHTML=oClass+"cc"+(oMirror?toLanguage(" mirror"," miroir"):""),selectedCc==oClass&&selectedMirror==oMirror&&(oClassOption.setAttribute("selected",!0),isSelectedCc=!0),oClassSelect.appendChild(oClassOption)}oClassSelect.style.marginRight="10px";var oClassOption=document.createElement("option");function setCustomCcValue(e,t,n){setCustomValue(e,t+(n?"m":""),t+"cc"+(n?toLanguage(" mirror"," miroir"):""))}oClassOption.value=-1,oClassOption.innerHTML=toLanguage("More...","Plus..."),oClassSelect.appendChild(oClassOption),oClassSelect.onchange=function(){handleCcSelectChange(this,oScr,function(e,t,n){setCustomCcValue(e,t,n)})},isSelectedCc||setCustomCcValue(oClassSelect,selectedCc,selectedMirror),oClassSelect.currentValue=oClassSelect.value,oClassDiv.appendChild(oClassSelect);var moreOptions=document.createElement("a");moreOptions.href="#null",moreOptions.style.color="white",moreOptions.innerHTML=toLanguage("More options...","Plus d'options..."),moreOptions.style.marginLeft=+iScreenScale+"px",moreOptions.onclick=function(e){return!(oMoreOptionsScreen.style.display="block")},oClassDiv.appendChild(moreOptions),oForm.appendChild(oClassDiv);var oMoreOptionsScreen=document.createElement("div");oMoreOptionsScreen.style.position="absolute",oMoreOptionsScreen.style.width="100%",oMoreOptionsScreen.style.height="100%",oMoreOptionsScreen.style.left="0px",oMoreOptionsScreen.style.top="0px",oMoreOptionsScreen.style.backgroundColor="#000",additionalOptions&&additionalOptions.openOptions||(oMoreOptionsScreen.style.display="none"),oMoreOptionsScreen.style.zIndex=3;var oMoreOptionsTitle=toTitle(toLanguage("More options","Plus d'options"),2);oMoreOptionsScreen.appendChild(oMoreOptionsTitle),oScr.appendChild(oMoreOptionsScreen);var oScroll=document.createElement("div");oScroll.style.maxHeight=24*iScreenScale+"px",oScroll.style.overflow="auto",oScroll.style.position="absolute",oScroll.style.left="0px",oScroll.style.top=12*iScreenScale+"px",oScroll.style.width=iWidth*iScreenScale+"px";var oTable=document.createElement("table");oTable.style.marginLeft="auto",oTable.style.marginRight="auto",oScroll.appendChild(oTable);var oTr=document.createElement("tr"),oTd=document.createElement("td");oTd.setAttribute("colspan",2);var cDiv=document.createElement("div");cDiv.style.display="flex",cDiv.style.flexDirection="row",cDiv.style.alignItems="center";var tDiv=document.createElement("div");tDiv.style.paddingLeft=3*iScreenScale+"px",tDiv.style.paddingRight=3*iScreenScale+"px";var oLabel=document.createElement("label");oLabel.style.cursor="pointer",oLabel.setAttribute("for","option-itemDistrib");var oH1=document.createElement("h1");oH1.style.fontSize=3*iScreenScale+"px",oH1.innerHTML=toLanguage("Item distribution :","Distribution des objets :"),oH1.style.marginTop=iScreenScale+"px",oH1.style.marginBottom="0px",oLabel.appendChild(oH1),tDiv.appendChild(oLabel),cDiv.appendChild(tDiv);var tDiv=document.createElement("div");tDiv.style.display="inline-block",oItemSelect=document.createElement("select"),oItemSelect.id="option-itemDistrib",oItemSelect.name="option-itemDistrib",oItemSelect.style.backgroundColor="black",oItemSelect.style.width=24*iScreenScale+"px",oItemSelect.style.fontSize=Math.round(2.5*iScreenScale)+"px",oItemSelect.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var i=0;i<modeItemDistributions.length;i++){var oItemOption=document.createElement("option");oItemOption.value=i,oItemOption.innerHTML=modeItemDistributions[i].name,oItemSelect.appendChild(oItemOption)}var oItemOption=document.createElement("option");oItemOption.value=-1,oItemOption.innerHTML=toLanguage("Custom...","Personnalis√©..."),oItemSelect.appendChild(oItemOption),oItemSelect.currentValue=oItemSelect.value,oItemSelect.onchange=function(){-1==this.value?(this.value=this.currentValue,selectedItemDistrib=modeItemDistributions[this.currentValue],selectItemScreen(oScr,function(e){customItemDistrib[itemMode].push(e),localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,modeItemDistributions.length),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})})):(this.currentValue=this.value,selectedItemDistrib=modeItemDistributions[this.value],oItemCustomActions.style.display=this.value>=itemDistributions[itemMode].length?"inline-block":"none")},tDiv.appendChild(oItemSelect);var oItemCustomActions=document.createElement("div");oItemCustomActions.style.display="none",oItemCustomActions.style.marginLeft=+iScreenScale+"px";var oItemCustomEdit=document.createElement("input");oItemCustomEdit.type="button",oItemCustomEdit.style.backgroundColor="rgb(51, 160, 51)",oItemCustomEdit.style.color="white",oItemCustomEdit.style.fontSize=Math.round(2.5*iScreenScale)+"px",oItemCustomEdit.value="‚úé",oItemCustomEdit.onclick=function(){selectItemScreen(oScr,function(e){customItemDistrib[itemMode][oItemSelect.value-itemDistributions[itemMode].length]=e,localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,+oItemSelect.value),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})},modeItemDistributions[oItemSelect.value])},oItemCustomActions.appendChild(oItemCustomEdit);var oItemCustomDel=document.createElement("input");oItemCustomDel.type="button",oItemCustomDel.style.marginLeft=Math.round(.5*iScreenScale)+"px",oItemCustomDel.style.backgroundColor="rgb(204, 51, 51)",oItemCustomDel.style.color="white",oItemCustomDel.value="√ó",oItemCustomDel.style.fontSize=Math.round(2.5*iScreenScale)+"px",oItemCustomDel.onclick=function(){var e=modeItemDistributions[oItemSelect.value].name;confirm(toLanguage('Delete item set "'+e+'"?','Supprimer le set "'+e+'" ?'))&&(customItemDistrib[itemMode].splice(oItemSelect.value-itemDistributions[itemMode].length,1),localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,0),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0}))},oItemCustomActions.appendChild(oItemCustomDel),tDiv.appendChild(oItemCustomActions);var selectedItemSetId=localStorage.getItem("itemset."+itemMode);selectedItemSetId&&(oItemSelect.selectedIndex=selectedItemSetId,oItemSelect.onchange()),cDiv.appendChild(tDiv),oTd.appendChild(cDiv),oTr.appendChild(oTd),oTable.appendChild(oTr);var oTable=document.createElement("table");if(oTable.style.marginLeft="auto",oTable.style.marginRight="auto",oScroll.appendChild(oTable),"BB"!=course){var oTr=document.createElement("tr"),oTd=document.createElement("td");oTd.setAttribute("colspan",2);var cDiv=document.createElement("div");cDiv.style.display="flex",cDiv.style.flexDirection="row",cDiv.style.alignItems="center";var tDiv=document.createElement("div");tDiv.style.paddingLeft=3*iScreenScale+"px",tDiv.style.paddingRight=3*iScreenScale+"px";var oLabel=document.createElement("label");oLabel.style.cursor="pointer",oLabel.setAttribute("for","option-ptDistrib");var oH1=document.createElement("h1");oH1.style.fontSize=3*iScreenScale+"px",oH1.innerHTML=toLanguage("Point distribution :","Distribution des points :"),oH1.style.marginTop=iScreenScale+"px",oH1.style.marginBottom="0px",oLabel.appendChild(oH1),tDiv.appendChild(oLabel),cDiv.appendChild(tDiv);var tDiv=document.createElement("div");tDiv.style.display="inline-block",oPointSelect=document.createElement("select"),oPointSelect.id="option-ptDistrib",oPointSelect.name="option-ptDistrib",oPointSelect.style.backgroundColor="black",oPointSelect.style.width=24*iScreenScale+"px",oPointSelect.style.fontSize=Math.round(2.5*iScreenScale)+"px",oPointSelect.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var i=0;i<modePtDistributions.length;i++){var oPtOption=document.createElement("option");oPtOption.value=i,oPtOption.innerHTML=modePtDistributions[i].name,oPointSelect.appendChild(oPtOption)}var oPtOption=document.createElement("option");oPtOption.value=-1,oPtOption.innerHTML=toLanguage("Custom...","Personnalis√©..."),oPointSelect.appendChild(oPtOption),oPointSelect.currentValue=oPointSelect.value,oPointSelect.onchange=function(){-1==this.value?(this.value=this.currentValue,selectedPtDistrib=modePtDistributions[this.currentValue],selectPtScreen(oScr,function(e){customPtDistrib.push(e),localStorage.setItem("ptsets",JSON.stringify(customPtDistrib)),localStorage.setItem("ptset",modePtDistributions.length),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectedPlayers=e.value.length,selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})},{value:getDefaultPointDistribution(fInfos.nbPlayers)})):(this.currentValue=this.value,selectedPtDistrib=modePtDistributions[this.value],oPtCustomActions.style.display=this.value>=ptDistributions.length?"inline-block":"none")},tDiv.appendChild(oPointSelect);var oPtCustomActions=document.createElement("div");oPtCustomActions.style.display="none",oPtCustomActions.style.marginLeft=+iScreenScale+"px";var oPtCustomEdit=document.createElement("input");oPtCustomEdit.type="button",oPtCustomEdit.style.backgroundColor="rgb(51, 160, 51)",oPtCustomEdit.style.color="white",oPtCustomEdit.style.fontSize=Math.round(2.5*iScreenScale)+"px",oPtCustomEdit.value="‚úé",oPtCustomEdit.onclick=function(){selectPtScreen(oScr,function(e){customPtDistrib[oPointSelect.value-ptDistributions.length]=e,localStorage.setItem("ptsets",JSON.stringify(customPtDistrib)),localStorage.setItem("ptset",+oPointSelect.value),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})},modePtDistributions[oPointSelect.value])},oPtCustomActions.appendChild(oPtCustomEdit);var oPtCustomDel=document.createElement("input");oPtCustomDel.type="button",oPtCustomDel.style.marginLeft=Math.round(.5*iScreenScale)+"px",oPtCustomDel.style.backgroundColor="rgb(204, 51, 51)",oPtCustomDel.style.color="white",oPtCustomDel.value="√ó",oPtCustomDel.style.fontSize=Math.round(2.5*iScreenScale)+"px",oPtCustomDel.onclick=function(){var e=modePtDistributions[oPointSelect.value].name;confirm(toLanguage('Delete point set "'+e+'"?','Supprimer le set "'+e+'" ?'))&&(customPtDistrib.splice(oPointSelect.value-ptDistributions.length,1),localStorage.setItem("ptsets",JSON.stringify(customPtDistrib)),localStorage.setItem("ptset",0),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0}))},oPtCustomActions.appendChild(oPtCustomDel),tDiv.appendChild(oPtCustomActions);var selectedPtSetId=localStorage.getItem("ptset");selectedPtSetId&&(oPointSelect.selectedIndex=selectedPtSetId,oPointSelect.onchange()),cDiv.appendChild(tDiv),oTd.appendChild(cDiv),oTr.appendChild(oTd),oTable.appendChild(oTr)}var oTr=document.createElement("tr"),oTd=document.createElement("td");oTd.style.textAlign="center",oTd.style.width=8*iScreenScale+"px",oTd.style.paddingLeft=2*iScreenScale+"px";var oDoubleItemCheckbox=document.createElement("input");oDoubleItemCheckbox.style.transform=oDoubleItemCheckbox.style.WebkitTransform=oDoubleItemCheckbox.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",oDoubleItemCheckbox.id="option-doubleItems",oDoubleItemCheckbox.name="option-doubleItems",oDoubleItemCheckbox.type="checkbox",oDoubleItemCheckbox.checked=!selectedDoubleItems,oTd.appendChild(oDoubleItemCheckbox),oTr.appendChild(oTd);var oTd=document.createElement("td"),oLabel=document.createElement("label");oLabel.style.cursor="pointer",oLabel.setAttribute("for","option-doubleItems");var oH1=document.createElement("h1");oH1.style.fontSize=3*iScreenScale+"px",oH1.style.margin=Math.round(.5*iScreenScale)+"px auto",oH1.innerHTML=toLanguage("Disable double items","D√©sactiver les double objets"),oLabel.appendChild(oH1),oTd.appendChild(oLabel),oTd.style.padding=Math.round(1.5*iScreenScale)+"px 0",oTr.appendChild(oTd),oTable.appendChild(oTr),oMoreOptionsScreen.appendChild(oScroll);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=4*iScreenScale+"px",oPInput.style.top=32*iScreenScale+"px",oPInput.onclick=function(){oMoreOptionsScreen.style.display="none"},oMoreOptionsScreen.appendChild(oPInput)}oScr.appendChild(oForm),isCustomSel&&(oForm.style.display="none")}else if("CM"==course){if(clSelected){var ccConstraint=getCcConstraint(clSelected);150!=ccConstraint&&200!=ccConstraint||(oClassSelect=document.createElement("input"),oClassSelect.type="hidden",oClassSelect.value=ccConstraint)}else{var oDiv=document.createElement("div");oDiv.style.position="absolute",oDiv.style.left=10*iScreenScale-10+"px",oDiv.style.top=32*iScreenScale+"px",oDiv.style.width=60*iScreenScale+"px",oDiv.style.fontSize=3*iScreenScale+"px",oDiv.style.textAlign="center";var oLabel=document.createElement("label");oLabel.innerHTML=toLanguage("Class: ","Cylindr√©e : "),oClassSelect=document.createElement("select"),oClassSelect.name="cc",oClassSelect.style.width=12*iScreenScale+"px",oClassSelect.style.fontSize=3*iScreenScale+"px";for(var oClasses=[150,200],i=0;i<oClasses.length;i++){var oClass=oClasses[i],oClassOption=document.createElement("option");oClassOption.value=oClass,oClassOption.innerHTML=oClass+"cc",selectedCc==oClass&&oClassOption.setAttribute("selected",!0),oClassSelect.appendChild(oClassOption)}oLabel.appendChild(oClassSelect),oDiv.appendChild(oLabel),oScr.appendChild(oDiv)}isSingle&&(oClassement=document.createElement("input"),oClassement.type="button",oClassement.value=toLanguage("Rankings","Classement"),oClassement.style.position="absolute",oClassement.style.left=57*iScreenScale+"px",oClassement.style.top=Math.round(32.25*iScreenScale)+"px",oClassement.style.fontSize=Math.round(2.5*iScreenScale)+"px",oClassement.style.position="absolute",oClassement.style.width=18*iScreenScale+"px",oClassement.onclick=function(){fSelectedClass=getRelSpeedFromCc(+oClassSelect.value),openRankings()},oScr.appendChild(oClassement))}isCustomSel&&(oStepCtn=document.createElement("div"),oStepCtn.style.position="absolute",oStepCtn.style.left="0px",oStepCtn.style.width=iWidth*iScreenScale+"px",oStepCtn.style.textAlign="center",oStepCtn.style.top=(baseY+22)*iScreenScale+"px",oStepBack=document.createElement("input"),oStepBack.type="button",oStepBack.style.fontSize=3*iScreenScale+"px",progress=IdJ,lastProgress=nbSels,isOnline&&(progress-=2,lastProgress-=2),progress?(oStepBack.value="‚óÑ",oStepBack.style.marginRight=3*iScreenScale+"px"):(oStepBack.style.width="0px",oStepBack.value="¬†",oStepBack.style.visibility="hidden"),oStepBack.onclick=function(){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),strPlayer.pop(),selectPlayerScreen(IdJ-1,!1,nbSels)},oStepCtn.appendChild(oStepBack),oStepValue=document.createElement("span"),oStepValue.style.fontSize=3*iScreenScale+"px",oStepValue.innerHTML=toLanguage("Character","Perso")+" "+(progress+1)+"/"+lastProgress,oStepCtn.appendChild(oStepValue),oStepBack.style.color=oStepValue.style.color="#F90",oScr.appendChild(oStepCtn)),maxCharsPerPage<nBasePersos&&(lastPageButton=document.createElement("input"),lastPageButton.type="button",lastPageButton.value="‚óÑ",lastPageButton.style.position="absolute",lastPageButton.style.padding=0,lastPageButton.style.left=Math.round((minPersoX-4)*iScreenScale)+"px",lastPageButton.style.top=Math.round(midPersoY*iScreenScale-8)+"px",lastPageButton.style.width=Math.round(3*iScreenScale)+"px",lastPageButton.style.height=Math.round(5*jScreenScale)+8+"px",lastPageButton.style.fontSize=Math.round(2.5*iScreenScale-4)+"px",lastPageButton.style.textAlign="center",oScr.appendChild(lastPageButton),lastPageButton.onclick=function(){(curPage=(curPage-1)%pages)<0&&(curPage+=pages),showCharacters(curPage)},nextPageButton=document.createElement("input"),nextPageButton.type="button",nextPageButton.value="‚ñ∫",nextPageButton.style.position="absolute",nextPageButton.style.padding=0,nextPageButton.style.left=Math.round((maxPersoX+6)*iScreenScale)+8+"px",nextPageButton.style.top=Math.round(midPersoY*iScreenScale-8)+"px",nextPageButton.style.width=Math.round(3*iScreenScale)+"px",nextPageButton.style.height=Math.round(5*jScreenScale)+8+"px",nextPageButton.style.fontSize=Math.round(2.5*iScreenScale-4)+"px",nextPageButton.style.textAlign="center",oScr.appendChild(nextPageButton),nextPageButton.onclick=function(){showCharacters(curPage=(curPage+1)%pages)});var oPInput=document.createElement("input");function goBack(){if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),isCustomSel)isOnline?(strPlayer.length=0,document.querySelector("[data-cpu-chars]").loadCpuChars(null)):selectPlayerScreen(0);else if(displayCommands(),isOnline)quitter();else if("VS"==course||"BB"==course){for(var e=1;e<oContainers.length;e++)oContainers.splice(e,1);selectNbJoueurs(!0)}else selectTypeScreen()}if(oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=35*iScreenScale+"px",isOnline&&(oPInput.style.top=34*iScreenScale+"px"),oPInput.onclick=goBack,isCustomSel&&(oPInput.style.color="#F90"),oScr.appendChild(oPInput),clSelected&&clSelected.autoset&&(clSelected.autoset.selectedOpponents&&(selectedOpponents=clSelected.autoset.selectedOpponents,oParticipantsDiv&&(oParticipantsDiv.style.display="none")),0===clSelected.autoset.selectedTeams&&oTeamsDiv&&(oTeamsDiv.style.display="none"),clSelected.autoset.selectedPerso)){if(force)return void goBack();var customCharCb,persoKey=clSelected.autoset.selectedPerso;if(isCustomPerso(persoKey,{forceReload:!0,callback:function(){customCharCb()}}))return customCharCb=function(){pUnlockMap[persoKey]=1;var e=createPersoSelector(persoKey);e.dataset.autoset=1,e.onclick()},void(oScr.style.visibility="hidden");var persoSelector=document.getElementById("perso-selector-"+persoKey);if(persoSelector&&persoSelector.onclick)return void persoSelector.onclick()}function addMyPersos(e){var t=cp;for(n in cp={},baseCp)cp[n]=baseCp[n];customPersos=baseCustomPersos();for(var n,a=0;a<e.length;a++){var o=e[a],i=o.sprites;cp[i]||(cp[i]=[]),cp[i][0]=o.acceleration,cp[i][1]=o.speed,cp[i][2]=o.handling,cp[i][3]=o.mass,customPersos[i]=o}for(n in aPlayers=[],cp)aPlayers.push(n);for(n in t)cp[n]||(cp[n]=t[n]);for(a=0;a<e.length;a++){i=e[a].sprites;pUnlockMap[i]=1;var r=createPersoSelector(i);if(newP&&!a&&r.onclick)return void r.onclick();r.style.left=myPersosOffset*iScreenScale+"px",r.style.top=(baseY+7*a)*iScreenScale-8+"px",oScr.insertBefore(r,pDiv)}oScr.style.visibility="visible"}newP&&(myPersosCache=void 0),customCharsEnabled&&(myPersosCache?addMyPersos(myPersosCache):xhr("myPersos.php",null,function(res){var newPersos=[];try{newPersos=eval(res)}catch(e){}return newPersos.length?(addMyPersos(newPersos),myPersosCache=newPersos,!0):(oScr.style.visibility="visible",!0)})),selectPerso=function(e){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),xhr("selectPerso.php","id="+e,function(e){return selectPlayerScreen(IdJ,!0,nbSels),!0})},updateMenuMusic(isOnline?0:1)}function handleCcSelectChange(n,e,a){-1==n.value?showGamePopup({container:e,elements:["<label>"+toLanguage("Class","Cylindr√©e&nbsp;")+': <input type="number" style="font-size: '+Math.round(2.5*iScreenScale)+'px" name="cc" value="'+parseInt(n.currentValue)+'" style="width: 3em" required min="1" max="999" /></label>','<label><input type="checkbox" style="transform: scale('+Math.round(iScreenScale/4)+')" name="mirror" '+(n.currentValue.endsWith("m")?' checked="checked"':"")+" />&nbsp;"+toLanguage("Mirror","Miroir")+"</label>"],submitVal:toLanguage("Validate","Valider"),submit:function(e){var t=+e.target.elements.cc.value,e=+e.target.elements.mirror.checked;a(n,t,e),n.currentValue=n.value},close:function(){n.value=n.currentValue}}).querySelector('input[name="cc"]').select():n.currentValue=n.value}function selectItemScreen(r,l,s){s=s||{};var c=document.createElement("div");c.style.position="absolute",c.style.width="100%",c.style.height="100%",c.style.left="0px",c.style.top="0px",c.style.zIndex=4,c.style.backgroundColor="#000";var p=document.createElement("table");p.style.color="white",p.style.textAlign="center",p.style.position="absolute",p.style.left=5*iScreenScale+"px",p.setAttribute("cellpadding",0),p.setAttribute("cellspacing",0);var u=getItemMode(),d={},e=itemDistributions[u].concat(customItemDistrib[u]);selectedItemDistrib.value&&-1==e.indexOf(selectedItemDistrib)&&e.push(selectedItemDistrib);for(var t=0;t<e.length;t++)for(var n=e[t],a=0;a<n.value.length;a++)for(var o in n.value[a])d[o]=1;d=Object.keys(d);var m=e[0].value,h=selectedItemDistrib;h.value&&(h=h.value),h.length||(h=m);var i=document.createElement("tr");i.appendChild(document.createElement("td"));for(t=0;t<d.length;t++){var g=document.createElement("td"),y=document.createElement("img");y.src="images/items/"+d[t]+".png",y.alt=d[t],y.style.width=2*iScreenScale+"px",g.appendChild(y),i.appendChild(g)}i.appendChild(document.createElement("td")),p.appendChild(i);var f=p.getElementsByClassName("item-distrib");function S(e){var t=document.createElement("tr");t.className="item-distrib",(o=document.createElement("td")).style.paddingRight=iScreenScale+"px",o.style.fontSize=2*iScreenScale+"px",o.innerHTML="#"+(e+1),t.appendChild(o);for(var n=(n=h[e])||m[e],a=0;a<d.length;a++){var o,i=d[a];(o=document.createElement("td")).style.padding="0px";var r=document.createElement("input");r.type="number",r.value=n[i]||"",r.style.width=Math.round(3.4*iScreenScale)+"px",r.className="noarrow",r.style.backgroundColor="black",r.style.color="white",r.style.textAlign="center",r.style.border="solid 1px white",r.style.fontSize=Math.round(1.8*iScreenScale)+"px",r.style.maxHeight=Math.round(2.5*iScreenScale+1)+"px",r.setAttribute("min",0),r.setAttribute("max",99),r.setAttribute("step",1),r.setAttribute("form","iten-distribution-form"),r.disabled=s.readOnly,o.style.padding="0px",o.appendChild(r),t.appendChild(o)}(o=document.createElement("td")).style.paddingRight=iScreenScale+"px";e=document.createElement("input");return e.type="button",e.value="√ó",e.style.fontSize=2*iScreenScale+"px",e.style.lineHeight=2*iScreenScale+"px",e.style.padding=Math.round(iScreenScale/4-1)+" "+Math.round(iScreenScale/2+2)+"px",e.onclick=function(){if(!(f.length<=1)){p.removeChild(t);for(var e=0;e<f.length;e++)f[e].querySelector("td").innerHTML="#"+(e+1);v.style.display=""}},s.readOnly&&(e.style.display="none"),o.appendChild(e),t.appendChild(o),t}for(t=0;t<h.length;t++)p.appendChild(S(t));var v=document.createElement("tr");f.length>=m.length&&(v.style.display="none"),(g=document.createElement("td")).setAttribute("colspan",d.length+1),v.appendChild(g),(g=document.createElement("td")).style.paddingRight=iScreenScale+"px";var b=document.createElement("input");b.type="button",b.value="+",b.style.fontSize=2*iScreenScale+"px",b.style.lineHeight=2*iScreenScale+"px",b.style.padding=Math.round(iScreenScale/4-1)+" "+Math.round(iScreenScale/2+2)+"px",b.onclick=function(){p.insertBefore(S(f.length),v),f.length>=m.length&&(v.style.display="none")},s.readOnly&&(b.style.display="none"),g.appendChild(b),v.appendChild(g),p.appendChild(v),c.appendChild(p);b=document.createElement("input");function C(e){var t=[];if(e&&!f.length)return alert(toLanguage("You must have at least 1 row in your table","Votre table doit comporter au moins 1 ligne")),null;for(var n=0;n<f.length;n++){for(var a={},o=!1,i=f[n].querySelectorAll('.item-distrib input[type="number"]'),r=0;r<d.length;r++){var l=i[r];0<l.value&&(a[d[r]]=+l.value,o=!0)}if(e&&!o)return alert(toLanguage("You must enter at least 1 item for rank #"+(n+1),"Vous devez sp√©cifier au moins 1 objet pour la position #"+(n+1))),null;t.push(a)}return t}b.type="button",s.readOnly?b.value=toLanguage("Back","Retour"):(b.style.color="#f90",b.value=toLanguage("Cancel","Annuler")),b.style.position="absolute",b.style.left=2*iScreenScale+"px",b.style.top=36*iScreenScale+"px",b.style.fontSize=2*iScreenScale+"px",b.onclick=function(){r.removeChild(c)},c.appendChild(b);b=document.createElement("form");b.style.position="absolute",b.id="iten-distribution-form",b.style.right=5*iScreenScale+"px",b.style.top=35*iScreenScale+4+"px",b.style.fontSize=Math.round(2.5*iScreenScale)+"px",b.onsubmit=function(){var e,t={value:C(!0)};if(!t.value)return!1;if(!s.untitled){if(s.name)e=s.name;else{for(var n,a={},o=customItemDistrib[u],i=0;i<o.length;i++)a[o[i].name]=1;for(n=1;a["Distribution "+n];n++);e="Distribution "+n}if(t.name=prompt(toLanguage("Set name","Nom du set"),e),!t.name)return!1}I(t),r.removeChild(c);try{l(t)}catch(e){console.error(e)}return!1};var x,M,P,k={algorithm:s.algorithm||"","prevent-pow-x2":1!=s.powx2,"prevent-blueshell-x2":1!=s.blueshellx2,"prevent-lightning-x2":1!=s.lightningx2,"pow-cooldown":0!=s.powdelay,"blueshell-cooldown":0!=s.blueshelldelay,"lightning-cooldown":0!=s.lightningdelay,"pow-start":1!=s.powstart,"blueshell-start":1!=s.blueshellstart,"lightning-start":1!=s.lightningstart,"prevent-doubleitem-x2":1!=s.doubleitemx2};function I(e){k.algorithm&&(e.algorithm=k.algorithm),k["prevent-pow-x2"]||(e.powx2=1),k["prevent-blueshell-x2"]||(e.blueshellx2=1),k["prevent-lightning-x2"]||(e.lightningx2=1),k["pow-cooldown"]||(e.powdelay=0),k["blueshell-cooldown"]||(e.blueshelldelay=0),k["lightning-cooldown"]||(e.lightningdelay=0),k["pow-start"]||(e.powstart=1),k["blueshell-start"]||(e.blueshellstart=1),k["lightning-start"]||(e.lightningstart=1),k["prevent-doubleitem-x2"]||(e.doubleitemx2=1)}s.readOnly&&!function(){var e,t={};for(e in I(t),t)return 1}()||((x=document.createElement("a")).innerHTML=s.readOnly?toLanguage("Advanced options...","Options avanc√©es..."):toLanguage("More options...","Plus d'options..."),x.href="#null",x.style.color="white",x.style.position="relative",x.style.marginRight=6*iScreenScale+"px",x.style.top=-Math.round(iScreenScale/4)+"px",x.style.fontSize=Math.round(2*iScreenScale)+"px",x.onclick=function(e){e.preventDefault();var a=document.createElement("div");a.className="fsmask item-options-screen",a.style.fontSize=2*iScreenScale+"px",a.innerHTML='<form><div class="item-options"><div class="item-optgroup"><div class="item-option"><label for="item-options-algorithm">'+toLanguage("Distribution based on","Distribution bas√©e sur")+'</label><div><select id="item-options-algorithm" name="algorithm"><option value="rank">'+toLanguage("Player rank","Position du joueur")+'</option><option value="dist">'+toLanguage("Distance to 1st","Distance au 1er")+'</option><option value="">'+toLanguage("Rank+distance","Position+distance")+'</option></select></div></div></div><div class="item-optgroup"><h2>'+toLanguage("Concurrent items","Objets simultan√©s")+'</h2><div class="item-option"><div><input type="checkbox" id="item-options-pow" name="prevent-pow-x2" /></div><label for="item-options-pow">'+toLanguage("Prevent 2 players from having a POW block","Emp√™cher 2 joueurs d'avoir un block POW")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-blueshell" name="prevent-blueshell-x2" /></div><label for="item-options-blueshell">'+toLanguage("Prevent 2 players from having a blue shell","Emp√™cher 2 joueurs d'avoir une carapace bleue")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-lightning" name="prevent-lightning-x2" /></div><label for="item-options-lightning">'+toLanguage("Prevent 2 players from having a lightning item","Emp√™cher 2 joueurs d'avoir un √©clair")+'</label></div></div><div class="item-optgroup"><h2>'+toLanguage("Cooldown","Cooldown")+'</h2><div class="item-option"><div><input type="checkbox" id="item-options-pow2" name="pow-cooldown" /></div><label for="item-options-pow2">'+toLanguage("Min time frame of 30s between 2 POW blocks","Emp√™cher 2 blocks POW √† moins de 30s d'intervalle")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-blueshell2" name="blueshell-cooldown" /></div><label for="item-options-blueshell2">'+toLanguage("Min time frame of 30s between 2 blue shells","Emp√™cher 2 carapaces bleues √† moins de 30s d'intervalle")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-lightning2" name="lightning-cooldown" /></div><label for="item-options-lightning2">'+toLanguage("Min time frame of 30s between 2 lightnings","Emp√™cher 2 √©clairs √† moins de 30s d'intervalle")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-pow0" name="pow-start" /></div><label for="item-options-pow0">'+toLanguage("No POW block before 25s of race","Pas de block POW avant 25s de course")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-blueshell0" name="blueshell-start" /></div><label for="item-options-blueshell0">'+toLanguage("No blue shell before 25s of race","Pas de carapace bleue avant 25s de course")+'</label></div><div class="item-option"><div><input type="checkbox" id="item-options-lightning0" name="lightning-start" /></div><label for="item-options-lightning0">'+toLanguage("No lightning item before 25s of race","Pas d'√©clair avant 25s de course")+'</label></div></div><div class="item-optgroup"><h2>'+toLanguage("Double items","Double objets")+'</h2><div class="item-option"><div><input type="checkbox" id="item-options-doubleitem" name="prevent-doubleitem-x2" /></div><label for="item-options-doubleitem">'+toLanguage("Prevent a player from having twice the same item","Emp√™cher un joueur d'avoir le m√™me objet en double")+'</label></div></div></div><div class="item-submit"><a href="#null">'+toLanguage("Back","Retour")+'</a><input type="submit" value="'+toLanguage("Validate","Valider")+'" /></siv></form>',a.querySelector(".item-submit a").onclick=function(){return c.removeChild(a),!1};var t,o=a.querySelector("form");for(t in o.onsubmit=function(e){for(var t in e.preventDefault(),k){var n=o.elements[t];"checkbox"===n.type?k[t]=n.checked:k[t]=n.value}c.removeChild(a)},k){var n=o.elements[t];s.readOnly&&(n.disabled=!0),"checkbox"===n.type?n.checked=!!k[t]:n.value=k[t]}s.readOnly&&(a.querySelector('.item-submit input[type="submit"]').style.display="none"),c.appendChild(a)},b.appendChild(x)),s.readOnly||((x=document.createElement("input")).type="submit",x.style.fontSize=2*iScreenScale+"px",x.value=toLanguage("Validate!","Valider !"),x.style.marginLeft=iScreenScale+"px",b.appendChild(x),(x=document.createElement("a")).href="#null",x.style.color="#CCF",x.innerHTML=toLanguage("Export/Import...","Exporter/importer"),x.style.fontSize=Math.round(1.6*iScreenScale)+"px",x.style.marginLeft=Math.round(2.5*iScreenScale)+"px",x.style.position="relative",x.style.top=-Math.round(iScreenScale/2)+"px",x.onclick=function(e){e.preventDefault();var r=document.createElement("div");r.className="fsmask item-export-screen",r.style.fontSize=2*iScreenScale+"px",r.innerHTML='<div><div class="tab-buttons"><div class="tab-button tab-button-selected">'+toLanguage("Export","Exporter")+'</div><div class="tab-button">'+toLanguage("Import","Importer")+'</div></div><div class="tabs"><form class="tab tab-export tab-selected"><div class="tab-export-desc">'+toLanguage("<strong>Export:</strong> Copy this text to share this distribution with other players.","<strong>Exporter :</strong> Copiez ce texte pour partager cette distribution avec d'autres joueurs.")+'</div><div class="tab-export-input"><textarea disabled>'+JSON.stringify(C())+'</textarea></div><div class="tab-export-submit"><a href="#null">'+toLanguage("Back","Retour")+'</a><input type="submit" value="'+toLanguage("Copy","Copier")+'" /></div></form><form class="tab tab-import"><div class="tab-export-desc">'+toLanguage("<strong>Import:</strong> Paste a new text to import distribution shared by another player.","<strong>Importer :</strong> Collez un texte pour importer la distribution d'un autre joueur.")+'</div><div class="tab-export-input"><textarea></textarea></div><div class="tab-export-submit"><a href="#null">'+toLanguage("Back","Retour")+'</a><input type="submit" value="'+toLanguage("Validate","Valider")+'" /></div></form></div></div>';for(var t=r.querySelectorAll(".tab-buttons .tab-button"),n=r.querySelectorAll(".tabs .tab"),a=0;a<t.length;a++)!function(e){t[e].onclick=function(){r.querySelector(".tab-buttons .tab-button-selected").classList.remove("tab-button-selected"),t[e].classList.add("tab-button-selected"),r.querySelector(".tabs .tab-selected").classList.remove("tab-selected"),n[e].classList.add("tab-selected")}}(a);r.querySelector(".tab-export .tab-export-submit a").onclick=function(e){e.preventDefault(),c.removeChild(r)},r.querySelector(".tab-import .tab-export-submit a").onclick=function(e){e.preventDefault(),c.removeChild(r)},r.querySelector(".tab.tab-export").onsubmit=function(e){e.preventDefault();var t=e.currentTarget,e=t.querySelector("textarea");e.disabled=!1,e.select(),document.execCommand("copy"),e.disabled=!0;var n=t.querySelector('input[type="submit"]'),a=n.value;n.disabled=!0,n.value=toLanguage("Copied","Copi√© ‚úî"),setTimeout(function(){n.value=a,n.disabled=!1},500)},r.querySelector(".tab.tab-import").onsubmit=function(e){e.preventDefault();e=e.currentTarget.querySelector("textarea");importedDistrib=JSON.parse(e.value),c.removeChild(r);for(var t=0;t<importedDistrib.length;t++){t>=f.length&&p.insertBefore(S(f.length),v);for(var n=importedDistrib[t],a=f[t].querySelectorAll('.item-distrib input[type="number"]'),o=0;o<d.length;o++){var i=d[o];a[o].value=n[i]||""}}for(;f.length>importedDistrib.length;)p.removeChild(f[f.length-1]);f.length>=m.length?v.style.display="none":v.style.display=""},c.appendChild(r)},b.appendChild(x),-1===d.indexOf("carapacenoire")&&(c.tabIndex=0,c.style.outline="none",M="darkshell",P="",c.onkeydown=function(e){e=e.key;if(1===e.length){if(e=e.toLowerCase(),!M.startsWith(P+=e))return P="",void(M.startsWith(e)&&(P=e));P===M&&confirm("Enable dark shell item?")&&(m[m.length-1].carapacenoire=0,r.removeChild(c),selectItemScreen(r,l,s))}},setTimeout(function(){c.focus()},1))),c.appendChild(b),r.appendChild(c)}function selectPtScreen(l,s,c){c=c||{};var p=document.createElement("div");p.style.position="absolute",p.style.width="100%",p.style.height="100%",p.style.left="0px",p.style.top="0px",p.style.zIndex=4,p.style.backgroundColor="#000";var e=document.createElement("form");e.onsubmit=function(){var e=this.elements["pt[]"];e.length||(e=[e]);for(var t=[],n=0;n<e.length;n++)t.push(+e[n].value);var a,o={value:t};if(!c.untitled){if(c.name)a=c.name;else{for(var i,r={},n=0;n<customPtDistrib.length;n++)r[customPtDistrib[n].name]=1;for(i=1;r["Distribution "+i];i++);a="Distribution "+i}if(o.name=prompt(toLanguage("Set name","Nom du set"),a),!o.name)return!1}return l.removeChild(p),s(o),!1},e.style.textAlign="center";var t=document.createElement("label");t.style.display="block",t.style.marginTop=Math.round(.5*iScreenScale)+"px",t.style.marginBottom=iScreenScale+"px";var n=document.createElement("span");n.innerHTML=toLanguage("Number of participants:","Nombre de participants :"),n.style.marginRight=iScreenScale+"px",n.style.fontSize=Math.round(2.25*iScreenScale)+"px",t.appendChild(n);n=document.createElement("input");n.type="number",n.setAttribute("max",999),n.setAttribute("min",2),n.style.fontSize=2*iScreenScale+"px",n.style.width=5*iScreenScale+8+"px",n.value=c.value.length,n.onchange=function(){for(var e=+this.value,t=o.childNodes;e>t.length;)a(t.length);for(;e<t.length;)o.removeChild(t[t.length-1])},t.appendChild(n),e.appendChild(t);n=document.createElement("div");n.style.maxHeight=30*iScreenScale+"px",n.style.overflowX="hidden",n.style.overflowY="auto",n.style.fontSize=Math.round(2*iScreenScale)+"px";var o=document.createElement("div");function a(e){var t=document.createElement("label");t.style.display="table-row";var n=document.createElement("div");n.innerHTML=toLanguage("Rank #"+(e+1),"Position #"+(e+1)),n.style.display="table-cell",n.style.verticalAlign="middle",n.style.textAlign="right",t.appendChild(n);var a=document.createElement("div");a.style.display="table-cell",a.style.verticalAlign="middle";n=document.createElement("input");n.style.fontSize=Math.round(1.5*iScreenScale)+"px",n.name="pt[]",n.type="number",n.style.width=8*iScreenScale+"px",n.setAttribute("max",9999),n.setAttribute("min",0),null!=c.value[e]?n.value=c.value[e]:n.value=0,n.setAttribute("required","required"),a.appendChild(n),t.appendChild(a),o.appendChild(t)}o.style.display="table",o.style.marginTop=Math.round(.5*iScreenScale)+"px",o.style.marginBottom=Math.round(.5*iScreenScale)+"px",o.style.marginLeft=o.style.marginRight="auto",o.style.borderSpacing=iScreenScale+"px";for(var i=0;i<c.value.length;i++)a(i);n.appendChild(o),e.appendChild(n);t=document.createElement("input");t.type="submit",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.marginTop=iScreenScale+"px",t.value=toLanguage("Validate","Valider"),e.appendChild(t),p.appendChild(e);e=document.createElement("input");e.type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=35*iScreenScale+"px",e.onclick=function(){l.removeChild(p)},p.appendChild(e),l.appendChild(p),n.querySelector('[name="pt[]"]').select()}function selectCpuNamesScreen(a,o,e){e=e||{};var i=document.createElement("div");i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.left="0px",i.style.top="0px",i.style.zIndex=2,i.style.backgroundColor="#000";var t=document.createElement("form");t.style.height=35*iScreenScale+"px",t.style.overflowX="hidden",t.style.overflowY="auto",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.textAlign="center",t.onsubmit=function(){a.removeChild(i);var e=this.elements["cpu[]"];e.length||(e=[e]);for(var t=[],n=0;n<e.length;n++)t.push(e[n].value);return o(t),!1};var n=document.createElement("div");n.style.display="table",n.style.marginTop=Math.round(.5*iScreenScale)+"px",n.style.marginBottom=Math.round(.5*iScreenScale)+"px",n.style.marginLeft=n.style.marginRight="auto",n.style.borderSpacing=iScreenScale+"px";for(var r=0;r<e.count;r++){var l=document.createElement("label");l.style.display="table-row";var s=document.createElement("div");s.innerHTML=toLanguage("CPU "+(r+1)+" name","Nom ordi "+(r+1)),s.style.display="table-cell",s.style.verticalAlign="middle",s.style.textAlign="right",l.appendChild(s);var c=document.createElement("div");c.style.display="table-cell",c.style.verticalAlign="middle";s=document.createElement("input");s.style.fontSize=2*iScreenScale+"px",s.name="cpu[]",s.type="text",s.setAttribute("size",10),s.setAttribute("maxlength",30),null!=e.names[r]?s.value=e.names[r]:s.value="CPU "+(r+1),s.setAttribute("required","required"),c.appendChild(s),l.appendChild(c),n.appendChild(l)}t.appendChild(n);var p=document.createElement("input");p.type="submit",p.style.fontSize=3*iScreenScale+"px",p.value=toLanguage("Validate","Valider"),t.appendChild(p),i.appendChild(t);p=document.createElement("input");p.type="button",p.value=toLanguage("Back","Retour"),p.style.fontSize=2*iScreenScale+"px",p.style.position="absolute",p.style.left=2*iScreenScale+"px",p.style.top=35*iScreenScale+"px",p.onclick=function(){a.removeChild(i)},i.appendChild(p),a.appendChild(i),t.querySelector('[name="cpu[]"]').select()}document.onkeydown=function(e){if(!oPlayers.length){var t,n=oContainers[0].childNodes[0];if(!n)return;if(document.activeElement&&0<=document.activeElement.tabIndex&&!n.contains(document.activeElement))return;switch(e.key){case"Enter":selectedOscrElt&&(focusIndicator.parentNode===n&&n.removeChild(focusIndicator),t=selectedOscrElt.value===toLanguage("Back","Retour"),releaseOverEvents(),selectedOscrElt.click(),iSfx&&playSoundEffect("musics/events/"+(t?"back":"select")+".mp3"));break;case"_Back":for(var a=n.querySelectorAll('input[type="Button"][value="'+toLanguage("Back","Retour")+'"]:not(:disabled)'),o=0;o<a.length;o++){var i=a[o],r=i.getBoundingClientRect();if(0<r.width&&0<r.height){releaseOverEvents(),i.click(),iSfx&&playSoundEffect("musics/events/back.mp3");break}}}if(-1===["ArrowUp","ArrowLeft","ArrowRight","ArrowDown"].indexOf(e.key))return;e.preventDefault&&e.preventDefault(),selectedOscrElt&&!n.contains(selectedOscrElt)&&(selectedOscrElt=void 0);var l,s,c,p,u,d=[...n.querySelectorAll("*")].filter(e=>e.onclick).filter(e=>!e.disabled).filter(e=>!e.dataset.noselect).filter(e=>{e=e.getBoundingClientRect();return 0<e.width&&0<e.height});switch(e.key){case"ArrowUp":l="top",s="bottom",p="left",u="right",c=-1;break;case"ArrowDown":l="bottom",s="top",p="left",u="right",c=1;break;case"ArrowLeft":l="left",s="right",p="top",u="bottom",c=-1;break;case"ArrowRight":l="right",s="left",p="top",u="bottom",c=1}if(selectedOscrElt){for(var m,h,g,y=selectedOscrElt.getBoundingClientRect(),f=n.getBoundingClientRect(),S=1/0,o=0;o<d.length;o++)(b=d[o])!==selectedOscrElt&&(h=((C=b.getBoundingClientRect())[s]-y[l])*c,g=Math.max(C[p],y[p])-Math.min(C[u],y[u]),h<0&&(h+=f.width),g<0&&(g=0),(g=h+3*g)<S&&(S=g,m=b));m&&showFocusIndicator(n,m)}else{for(var v,b,C,x=1/0*c,o=0;o<d.length;o++)(C=(b=d[o]).getBoundingClientRect())[s]*c<x*c&&(x=C[s],v=b);v&&showFocusIndicator(n,v)}}if(onlineSpectatorId){var M=handleSpectatorInput(e);return!1===M&&render(),M}e=getGameAction(e);if(oPlayers[0])switch(e){case"up":return(oPlayers[0].speedinc=1)<document.getElementById("decompte0").innerHTML&&updateEngineSound(carEngine2),!1;case"left":return oPlayers[0].rotincdir=getMirrorFactor(),!1;case"right":return oPlayers[0].rotincdir=-getMirrorFactor(),!1}if(oPlayers[1])switch(e){case"up_p2":oPlayers[1].speedinc=1;break;case"left_p2":oPlayers[1].rotincdir=getMirrorFactor();break;case"right_p2":oPlayers[1].rotincdir=-getMirrorFactor()}},document.onkeyup=function(e){if(!onlineSpectatorId){e=getGameAction(e);if(oPlayers[0])switch(e){case"up":oPlayers[0].speedinc=0,updateEngineSound(carEngine);break;case"left":case"right":oPlayers[0].rotincdir=0}if(oPlayers[1])switch(e){case"up_p2":oPlayers[1].speedinc=0;break;case"left_p2":oPlayers[1].rotincdir=0;break;case"right_p2":oPlayers[1].rotincdir=0}}},String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t});var defaultGameOptions={team:!1,manualTeams:!1,friendlyFire:!1,nbTeams:2,teamOpts:0,localScore:!1,friendly:!1,minPlayers:2,maxPlayers:12,cc:150,mirror:!1,itemDistrib:0,ptDistrib:0,cpu:!1,cpuCount:2,cpuLevel:0,cpuNames:null,cpuChars:null,timeTrial:!1,noBumps:!1,noJump:!1,noRd:!1,doubleItems:!0};function isCustomOptions(e){if(e)for(var t in defaultGameOptions)if(void 0!==e[t]&&e[t]!=defaultGameOptions[t])return!0;return!1}function hasChallenges(){for(var e in challenges)for(var t in challenges[e])return!0}function isTeamPlay(){switch(course){case"BB":case"VS":return selectedTeams}return 0}function setupTeamColors(){selectedTeamOpts=selectedTeamOpts||[];for(var e,t=0;t<selectedNbTeams;t++)selectedTeamOpts[t]||(selectedTeamOpts[t]={color:t});for(e in cTeamColors={},oTeamColors){cTeamColors[e]=[];for(t=0;t<selectedTeamOpts.length;t++)cTeamColors[e][t]=oTeamColors[e][selectedTeamOpts[t].color]}for(t=0;t<selectedTeamOpts.length;t++)selectedTeamOpts[t].name&&(cTeamColors.name[t]=escapeSpecialChars(selectedTeamOpts[t].name))}var ccInterpolations=[[0,0],[50,.7],[100,.85],[150,1],[200,1.5],[1e3,10]],startMusicHandler,onlineSpectatorState;function getRelSpeedFromCc(e){for(var t=0;t<ccInterpolations.length;t++)if(e<ccInterpolations[t][0])return ccInterpolations[t-1][1]+(ccInterpolations[t][1]-ccInterpolations[t-1][1])*(e-ccInterpolations[t-1][0])/(ccInterpolations[t][0]-ccInterpolations[t-1][0]);return ccInterpolations[ccInterpolations.length-1][1]}function getCcConstraint(e){for(var t=e.data.constraints,n=0;n<t.length;n++){var a=t[n];if("cc"===a.type)return a.value+(a.mirror?"m":"")}}function getActualCc(){for(var e=0;e<ccInterpolations.length;e++)if(fSelectedClass<ccInterpolations[e][1])return Math.round(ccInterpolations[e-1][0]+(ccInterpolations[e][0]-ccInterpolations[e-1][0])*(fSelectedClass-ccInterpolations[e-1][1])/(ccInterpolations[e][1]-ccInterpolations[e-1][1]));return ccInterpolations[ccInterpolations.length-1][0]}function cappedRelSpeed(e){e=e&&void 0!==e.size?sizeSpeedRatio(e):1;return Math.min(Math.max(fSelectedClass*e,.37),2.7)}function getMirrorFactor(){return bSelectedMirror?-1:1}function selectTeamScreen(i){i||(aTeams.length=0);var r=document.createElement("div"),e=r.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=toLanguage("Select team","S√©lectionner √©quipe");1<strPlayer.length&&(t+=" ("+toLanguage("P","J")+(i+1)+")");e=toTitle(t,.5);1<strPlayer.length&&(e.style.fontSize=Math.round(7*iScreenScale)+"px"),r.appendChild(e);var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){r.innerHTML="",oContainers[0].removeChild(r),selectPlayerScreen(-1)},r.appendChild(n);for(var a=oTeamColors.name.map(function(e){return toLanguage(e+" team","√âquipe "+e.toLowerCase())}),o=Math.max(2,Math.round(fInfos.nbteams/2)),l=Math.ceil(fInfos.nbteams/o),s=0;s<fInfos.nbteams;s++){(n=document.createElement("input")).type="button",n.value=a[s],n.style.color=oTeamColors.light[s],n.i=s,n.style.fontSize=(o<=2?4:3)*iScreenScale+"px",n.style.position="absolute";var c=s%l,p=Math.floor(s/l),u=Math.min(s+l-s%l,fInfos.nbteams)-(s-s%l);n.style.left=(25+32*(c-(u-1)/2))*iScreenScale+"px",n.style.top=(o<=2?12+8*p:11+6*p)*iScreenScale+"px",n.style.width=30*iScreenScale+"px",n.onclick=function(){r.innerHTML="",oContainers[0].removeChild(r);var e=+this.i;if(aTeams.push(e),selectedNbTeams=fInfos.nbteams,selectedFriendlyFire=fInfos.friendlyFire,localStorage.setItem("nbTeams",selectedNbTeams),selectedFriendlyFire?localStorage.setItem("friendlyFire",selectedFriendlyFire):localStorage.removeItem("friendlyFire"),aTeams.length>=strPlayer.length){for(var t=new Array(selectedNbTeams).fill(0),e=0;e<strPlayer.length;e++)t[aTeams[e]]++;for(;;){var n=Math.min(...t);if(n===Math.max(...t))break;n=t.indexOf(n);aTeams.push(n),t[n]++}var a=aTeams.length;aTeams.length=strPlayer.length+aPlayers.length;for(var o=a;o<aTeams.length;o++)aTeams[o]=(o+e+aPlayers.length)%selectedNbTeams;selectTrackScreen()}else selectTeamScreen(i+1)},r.appendChild(n)}t=document.createElement("label");t.style.position="absolute",t.style.left=5*iScreenScale+"px",t.style.top=29*iScreenScale+"px",t.style.width=70*iScreenScale+"px",t.style.textAlign="center",t.style.fontSize=Math.round(2.2*iScreenScale)+"px",t.innerHTML=toLanguage("Number of teams: ","Nombre d'√©quipes : ");var d=document.createElement("select");d.style.width=5*iScreenScale+"px",d.style.fontSize=Math.round(2.2*iScreenScale)+"px";for(var s=2;s<=a.length;s++){var m=document.createElement("option");m.value=s,m.innerHTML=s,d.appendChild(m)}d.value=fInfos.nbteams,d.onchange=function(){fInfos.nbteams=+this.value,r.innerHTML="",oContainers[0].removeChild(r),selectTeamScreen(0)},t.appendChild(d),r.appendChild(t),(t=document.createElement("label")).style.position="absolute",t.style.left=5*iScreenScale+"px",t.style.top=Math.round(32.5*iScreenScale)+"px",t.style.width=70*iScreenScale+"px",t.style.textAlign="center",t.style.fontSize=Math.round(2.2*iScreenScale)+"px";e=document.createElement("input");e.type="checkbox",e.checked=fInfos.friendlyFire,e.onchange=function(){fInfos.friendlyFire=this.checked},e.style.width=Math.round(2.2*iScreenScale)+"px",e.style.height=Math.round(2.2*iScreenScale)+"px",e.style.position="relative",e.style.top=Math.round(.35*iScreenScale)+"px",e.style.marginRight=iScreenScale+"px",t.appendChild(e);e=document.createElement("span");e.innerHTML=toLanguage("Friendly fire ","Friendly fire "),t.appendChild(e);e=document.createElement("a");e.href="#null",e.style.textDecoration="none",e.style.color="white",e.innerHTML="[?]",e.onclick=function(){return alert(toLanguage("If enabled, your items can hit your teammates","Si activ√©, vos objets peuvent toucher les joueurs de votre √©quipe")),!1},t.appendChild(e),r.appendChild(t),oContainers[0].appendChild(r),updateMenuMusic(1)}function selectTrackScreen(){selectMapScreen()}function selectGamersScreen(){!isOnline&&isTeamPlay()?selectTeamScreen(0):selectPlayerScreen(-1)}function acceptRulesScreen(){var e=document.createElement("div"),t=e.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",(i=shareLink.options.public?toTitle(toLanguage("Game rules","R√®gles parties"),0):toTitle(toLanguage("Private game rules","R√®gles partie priv√©e"),0)).style.fontSize=7*iScreenScale+"px",e.appendChild(i);var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=9*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px";var a=document.createElement("div");a.style.maxHeight=24*iScreenScale+"px",a.style.overflow="auto";var o=document.createElement("div");o.style.textAlign="center",o.style.color="#F90",o.style.fontSize=2*iScreenScale+"px",o.style.lineHeight=3*iScreenScale+"px",shareLink.options.public?o.innerHTML="‚ö† "+toLanguage("Games from this mode have special rules","Les parties de ce mode utilisent des r√®gles sp√©cifiques"):o.innerHTML="‚ö† "+toLanguage("Games from this private link have special rules","Les parties de ce lien priv√© utilisent des r√®gles sp√©cifiques"),a.appendChild(o);var i,r,l,s,c,p,u,t=document.createElement("table");t.style.marginLeft="auto",t.style.marginRight="auto",shareLink.options.team&&(s=document.createElement("tr"),c=document.createElement("td"),(p=document.createElement("label")).setAttribute("for","option-teams"),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.style.marginTop="0px",u.style.marginBottom="0px",u.innerHTML=toLanguage("Team games","Parties par √©quipe"),p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",i=shareLink.options.nbTeams||defaultGameOptions.nbTeams,o.innerHTML=toLanguage(i+" teams are selected in each game. You object: defeat the opposing team"+(2<i?"s":"")+".",i+" √©quipes sont s√©lectionn√©es √† chaque partie. Votre objectif : vaincre "+(2<i?"les √©quipes adverses":"l'√©quipe adverse")+"."),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.manualTeams&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("Manual selection","S√©lection manuelle"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Teams are selected manually by one of the players.","Les √©quipes sont s√©lectionn√©es manuellement par l'un des joueurs."),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.friendlyFire&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("Friendly fire","Friendly fire"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Your items can hit your teammates","Vos objets peuvent toucher les joueurs de votre √©quipe"),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),(shareLink.options.cc||shareLink.options.mirror)&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("Class","Cylindr√©e"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=(shareLink.options.cc||150)+"cc"+(shareLink.options.mirror?toLanguage(" mirror"," miroir"):""),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.itemDistrib&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("Item distribution","Distribution des objets"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",isNaN(shareLink.options.itemDistrib)?((l=shareLink.options.itemDistrib).value||(l={value:l}),o.innerHTML=toLanguage('Custom distribution <a href="#null">[Show]</a>','Distribution personnalis√©e <a href="#null">[Voir]</a>'),(r=o.querySelector("a")).style.color="#CCF",r.onclick=function(){return selectedItemDistrib=l,selectItemScreen(e,function(){},Object.assign({},l,{readOnly:!0})),!1}):(r=getItemMode(),(l=itemDistributions[r][shareLink.options.itemDistrib]).value.length?o.innerHTML=l.name:o.innerHTML=toLanguage("No item","Aucun objet")),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.cpuCount&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("Possible addition of bots","Ajout possible de bots"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("If there are not enough players, some bots will be added to the game so that there are at least <strong>"+shareLink.options.cpuCount+"</strong> participants.","S'il n'y a pas assez de joueurs, des bots seront ajout√©s √† la partie pour qu'il y ait au minimum <strong>"+shareLink.options.cpuCount+"</strong> participants"),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.timeTrial&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("Time trial mode","Mode Contre-le-montre"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Games are played like in time trial: no item boxes, no collisions with other players (they are ghosts), and you start with 3 shrooms.","Les parties se d√©roulent comme en CLM : pas de bo√Ætes √† objets, pas de collisions avec les autres joueurs (ce sont des fant√¥mes), et vous commencez avec 3 champis."),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.noBumps&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("No collisions between karts","Pas de collisions entre les karts"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Karts are not impacted when they hit each other","Les karts ne sont pas impact√©s lorsqu'ils se rentrent dedans"),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.noJump&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("No kart jumps","Sauts d√©sactiv√©s"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("It's impossible to perform a jump, drift or trick","Il est impossible de faire des sauts, d√©rapages ou figures"),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),shareLink.options.noRd&&(s=document.createElement("tr"),c=document.createElement("td"),p=document.createElement("label"),c.appendChild(p),(u=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",u.innerHTML=toLanguage("No Reverse Drift","Pas de Reverse Drift"),u.style.marginBottom="0px",p.appendChild(u),(o=document.createElement("div")).style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("The famous MKPC drifting technique is blocked","La fameuse technique de d√©rapage de MKPC est bloqu√©e"),p.appendChild(o),c.appendChild(p),s.appendChild(c),t.appendChild(s)),a.appendChild(t),n.appendChild(a),(o=document.createElement("div")).style.textAlign="center",o.style.marginTop=2*iScreenScale+"px";a=document.createElement("input");a.type="button",a.value=toLanguage("Accept and play","Accepter et jouer"),a.style.fontSize=3*iScreenScale+"px",a.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),shareLink.accepted=!0,searchCourse()},o.appendChild(a),n.appendChild(o),e.appendChild(n);n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(n),oContainers[0].appendChild(e)}function selectChallengesScreen(){var a=document.createElement("div"),e=a.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=toTitle(toLanguage("Challenges","D√©fis"),0);t.style.fontSize=7*iScreenScale+"px",a.appendChild(t);var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=9*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px";var o,e=document.createElement("div");e.style.maxHeight=24*iScreenScale+"px",e.style.overflowX="hidden",e.style.overflowY="auto";t=hasChallenges();if(t){document.getElementById("comment-connect")&&((L=document.createElement("div")).style.width=(iWidth-5)*iScreenScale+"px",L.style.marginLeft="auto",L.style.marginRight="auto",L.style.marginBottom=Math.round(1.5*iScreenScale)+"px",L.style.textAlign="center",L.innerHTML=language?'You are not connected. The challenges you complete will not be saved. <a href="forum.php" target="_blank" style="color:white">Click here</a> to log in or register.':'Vous n\'√™tes pas connect√©. Les d√©fis r√©ussis ne seront pas sauvegard√©s. <a href="forum.php" target="_blank" style="color:white">Cliquez ici</a> pour vous connecter ou vous inscrire.',L.style.fontSize=Math.round(1.8*iScreenScale)+"px",e.appendChild(L));var i=document.createElement("table");i.style.width=(iWidth-3)*iScreenScale+"px",i.style.marginLeft="auto",i.style.marginRight="auto",i.style.borderCollapse="collapse";var r=[],l=[];for(m in challenges)for(var s in challenges[m])for(var c=(d=challenges[m][s]).list,p=0;p<c.length;p++){var u={creation:d,challenge:h=c[p],type:m,cid:s};(null!=h.order?r:l).push(u)}r.sort(function(e,t){return e.challenge.order-t.challenge.order}),r=r.concat(l);for(p=0;p<r.length;p++){var d=(u=r[p]).creation,m=u.type,s=u.cid,h=u.challenge;if(d.main&&!g)o=d.id;else if(d!==g){var g=d;(S=document.createElement("tr")).style.border="solid 1px white",(C=document.createElement("td")).setAttribute("colspan",2);var y=document.createElement("h1"),f="";switch(m){case"mcup":f=toLanguage("Multicup","Multicoupe");break;case"cup":f=toLanguage("Cup","Coupe");break;case"track":f=isBattle?toLanguage("Arena","Ar√®ne"):toLanguage("Track","Circuit")}y.innerHTML=f+' <span style="color:#FDB">'+escapeSpecialChars(d.name)+"</span>",y.style.textAlign="center",y.style.margin="0px",y.style.fontSize=Math.round(4*iScreenScale)+"px",y.style.paddingTop=Math.round(.5*iScreenScale)+"px",y.style.paddingBottom=Math.round(.5*iScreenScale)+"px",y.style.backgroundColor="#fa7c1b",y.style.color="white",C.appendChild(y),S.appendChild(C),i.appendChild(S)}var S,v="active"==h.status&&h.succeeded,b=v?"#9E9":"white";(S=document.createElement("tr")).style.border="solid 1px "+b,v&&(S.style.backgroundColor="#031"),(C=document.createElement("td")).style.padding=iScreenScale+" "+iScreenScale+"px",h.name&&((y=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",y.style.marginTop="0px",y.style.marginBottom="0px",y.innerText=h.name,C.appendChild(y));var C,x=document.createElement("div");if(h.name||h.description.extra?x.style.fontSize=2*iScreenScale+"px":x.style.fontSize=Math.round(2.5*iScreenScale)+"px",x.style.color=b,x.style.fontWeight="bold",x.innerHTML=h.description.main,C.appendChild(x),h.description.extra&&((x=document.createElement("div")).style.fontSize=Math.round(1.6*iScreenScale)+"px",x.style.color=b,x.innerHTML=h.description.extra,C.appendChild(x)),"active"!=h.status){switch((x=document.createElement("div")).style.fontSize=Math.round(1.6*iScreenScale)+"px",x.style.color="#FC0",h.status){case"pending_completion":x.innerHTML=toLanguage("This challenge is pending completion. Succeed it to publish it.","Ce d√©fi est en attente de r√©ussite. R√©ussissez-le pour le publier.");break;case"pending_publication":x.innerHTML=toLanguage("This challenge is pending publication. Click on &quot;Manage challenges&quot; to publish it.","Ce d√©fi est en attente de publication. Cliquez sur &quot;G√©rer les d√©fis&quot; pour le publier.");break;case"pending_moderation":x.innerHTML=toLanguage("This challenge is pending moderation. It will be published once a validator validates it.","Ce d√©fi est en attente de mod√©ration. Il sera publi√© d√®s qu'un mod√©rateur l'aura valid√©.")}x.style.fontWeight="bold",C.appendChild(x)}S.appendChild(C),(C=document.createElement("td")).style.padding=iScreenScale+" "+iScreenScale+"px",C.style.width=12*iScreenScale+"px",C.style.textAlign="center",h.succeeded&&((P=document.createElement("div")).innerHTML='<span style="color:#CFC;display:inline-block;margin-right:2px">‚úî</span>'+toLanguage("Completed","R√©ussi"),P.style.whiteSpace="nowrap",P.style.fontSize=Math.round(iScreenScale*(language?2:2.2))+"px",P.style.backgroundColor="#33A033",P.style.display="inline-block",P.style.padding="0px "+Math.round(.8*iScreenScale)+"px",P.style.borderRadius=Math.round(.6*iScreenScale)+"px",P.style.color="white",P.style.marginBottom=Math.round(.5*iScreenScale)+"px",P.style.marginTop=Math.round(.5*iScreenScale)+"px",C.appendChild(P));var M,v=document.createElement("div"),b=document.createElement("img");if(b.src="images/challenges/difficulty"+h.difficulty.level+".png",b.alt="D",b.style.width=2*iScreenScale+"px",v.appendChild(b),(P=document.createElement("span")).style.color=h.difficulty.color,P.style.fontSize=Math.round(1.7*iScreenScale)+"px",P.style.position="relative",P.style.top="-1px",P.innerHTML=" "+h.difficulty.name,v.appendChild(P),C.appendChild(v),h.winners.length){(v=document.createElement("div")).style.cursor="help";var P,b=document.createElement("img");h.succeeded||(v.style.marginBottom=Math.round(.5*iScreenScale)+"px"),b.src="images/cups/cup1.png",b.alt="W",b.style.width=2*iScreenScale+"px",v.appendChild(b),(P=document.createElement("span")).style.color="white",P.style.fontSize=Math.round(1.7*iScreenScale)+"px",P.style.position="relative",P.style.top="-2px",P.innerHTML=" "+h.winners.length;for(var k='<small style="color:#CFC">'+toLanguage("Succeeded by:","R√©ussi par :")+"</small>",I=0;I<h.winners.length;I++)k+='<br /><span style="color:#CFC;display:inline-block;margin-right:2px">‚úî</span>'+h.winners[I].nick;v.dataset||(v.dataset={}),v.dataset.title=k,v.appendChild(P),v.onmouseover=function(e){var t;D||((D=document.createElement("div")).className="ranking_activeplayertitle",D.innerHTML=this.dataset.title,D.style.position="fixed",D.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",D.style.borderRadius=iScreenScale+"px",D.style.zIndex=10,D.style.backgroundColor="rgba(51,160,51, 0.95)",D.style.color="white",D.style.fontSize=Math.round(1.8*iScreenScale)+"px",D.style.lineHeight=Math.round(2*iScreenScale)+"px",D.style.visibility="hidden",$mkScreen.appendChild(D),t=this.getBoundingClientRect(),D.style.left=Math.round(t.left+(this.scrollWidth-D.scrollWidth)/2)+"px",D.style.top=t.top+this.scrollHeight+5+"px",D.style.visibility="visible")},v.onmouseout=function(){D&&($mkScreen.removeChild(D),D=void 0)},C.appendChild(v)}function w(e,t,n){a.innerHTML="",oContainers[0].removeChild(a),(clSelected=e).trackId=t,clSelected.trackType=n,localStorage.removeItem("itemset."+getItemMode()),xhr("challengeTry.php","challenge="+e.id,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}for(var t in clSelected.autoset=e,course="",e)window[t]=e[t];return course?selectPlayerScreen(0):selectMainPage(),delete window.selectedPerso,showClSelectedPopup(),!0})}h.succeeded?((T=document.createElement("a")).href="#null",T.innerHTML=toLanguage("Replay","Rejouer"),T.style.color="white",T.style.fontSize=Math.round(1.7*iScreenScale)+"px",function(e,t,n){T.onclick=function(){return w(e,t,n),!1}}(h,s,m),C.appendChild(T)):((M=document.createElement("input")).type="button",M.value=toLanguage("Take up","Relever"),M.style.width=11*iScreenScale+"px",M.style.fontSize=Math.round(2.4*iScreenScale)+"px",function(e,t,n){M.onclick=function(){w(e,t,n)}}(h,s,m),C.appendChild(M)),S.appendChild(C),i.appendChild(S)}e.appendChild(i)}else{e.style.textAlign="center",(x=document.createElement("div")).style.fontSize=3*iScreenScale+"px",x.style.marginTop=3*iScreenScale+"px",x.style.marginBottom=2*iScreenScale+"px",x.style.marginLeft="auto",x.style.marginRight="auto",x.style.width=60*iScreenScale+"px",x.style.color="white",x.innerHTML=toLanguage("This circuit has no challenges. Create some right now, it's fast and easy!","Ce circuit ne comporte aucun d√©fi. Cr√©ez-en d√®s maintenant, c'est facile et rapide !"),e.appendChild(x);var L=document.createElement("input");L.type="button",L.style.fontSize=3*iScreenScale+"px",L.style.paddingLeft=2*iScreenScale+"px",L.style.paddingRight=2*iScreenScale+"px",L.value=toLanguage("Go to challenge editor","Acc√©der √† l'√©diteur de d√©fis"),L.onclick=function(){openChallengeEditor()},e.appendChild(L)}n.appendChild(e),a.appendChild(n);n=document.createElement("input");if((n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){a.innerHTML="",oContainers[0].removeChild(a),selectMainPage()},a.appendChild(n),t)&&(myCircuit&&((n=document.createElement("input")).type="button",n.value=toLanguage("Manage challenges...","G√©rer les d√©fis..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.right=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){openChallengeEditor()},a.appendChild(n)),clRewards.length)){var T=document.createElement("a");o?T.href="persoLocked.php?cl="+o:"undefined"!=typeof commentType&&"undefined"!=typeof commentCircuit&&(T.href="persoLocked.php?cltype="+commentType+"&clrace="+commentCircuit),T.target="_blank",T.style.color="white",T.style.textDecoration="none",T.onclick=function(){return window.open(this.href,"persoLock","scrollbars=1, resizable=1, width=500, height=500"),!1};t=document.createElement("img");t.src="images/challenges/unlocking.png",t.alt=toLanguage("Unlocking characters","Persos √† d√©bloquer"),t.style.height=2*iScreenScale+"px",t.style.marginRight=Math.round(.55*iScreenScale)+"px",t.style.position="relative",t.style.top=Math.round(.2*iScreenScale)+"px",T.appendChild(t);var E=0;if(myCircuit)T.innerHTML+=clRewards.length;else{for(p=0;p<clRewards.length;p++)clRewards[p].unlocked&&E++;T.innerHTML+=E+"/"+clRewards.length}T.style.fontSize=2*iScreenScale+"px",T.style.position="absolute",T.style.right=(myCircuit?22:2)*iScreenScale+"px",T.style.top=35*iScreenScale+"px",T.dataset||(T.dataset={});var D,n=clRewards.length-E,t=1<n?"s":"";n<=0?(T.dataset.title=toLanguage("All characters unlocked,<br />congratulations!","Tous les persos ont √©t√©<br />d√©bloqu√©s, f√©licitations !"),T.style.color="#0F8",T.style.fontWeight="bold"):T.dataset.title=E?toLanguage(n,"Plus que "+n)+" "+toLanguage("character"+t+" left to unlock","perso"+t+" √† d√©bloquer"):n+" "+toLanguage("character"+t+" to unlock","perso"+t+" √† d√©bloquer"),T.onmouseover=function(){var e;this.style.opacity=.7,D||((D=document.createElement("div")).className="ranking_activeplayertitle",D.style.textAlign="center",D.innerHTML=this.dataset.title,D.style.position="fixed",D.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",D.style.borderRadius=iScreenScale+"px",D.style.zIndex=10,D.style.backgroundColor="rgba(102,153,160, 0.95)",D.style.color="white",D.style.fontSize=Math.round(1.8*iScreenScale)+"px",D.style.lineHeight=Math.round(2*iScreenScale)+"px",D.style.visibility="hidden",$mkScreen.appendChild(D),e=this.getBoundingClientRect(),D.style.left=Math.round(e.left+(this.scrollWidth-D.scrollWidth)/2)+"px",D.style.top=e.top-D.scrollHeight-5+"px",D.style.visibility="visible")},T.onmouseout=function(){this.style.opacity="",D&&($mkScreen.removeChild(D),D=void 0)},a.appendChild(T)}oContainers[0].appendChild(a)}function searchCourse(e){e=e||{};var a=document.createElement("div"),t=a.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black";var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=4*iScreenScale+"px",n.style.width=iScreenScale*iWidth+"px",n.style.fontSize=4*iScreenScale+"",n.style.textAlign="center",n.innerHTML=toLanguage("Searching for other players<br />Please wait...","Recherche d'autres joueurs<br />Veuillez patienter..."),a.appendChild(n);t=document.createElement("label");t.style.position="absolute",t.style.left="0px",t.style.top=15*iScreenScale-9+"px",t.style.width=iScreenScale*iWidth+"px",t.style.textAlign="center";var o=document.createElement("input");o.type="checkbox",o.id="iAlert",o.style.transform=o.style.WebkitTransform=o.style.MozTransform="scale("+iScreenScale/6+") translateY(8%)",o.style.transformOrigin=o.style.WebkitTransformOrigin=o.style.MozTransformOrigin="bottom right",t.appendChild(o);n=document.createElement("span");n.setAttribute("for","iAlert"),n.style.fontSize=2*iScreenScale+"pt",n.style.marginLeft="5px",n.innerHTML=toLanguage("Notify me when opponents have been found","M'alerter lorsque des adversaires ont √©t√© trouv√©s"),t.appendChild(n),a.appendChild(t);var i=0,r=document.createElement("div");r.style.position="absolute",r.style.left="0px",r.style.top=21*iScreenScale+"px",r.style.width=41*iScreenScale*2+"px",r.style.height=Math.round(8.5*iScreenScale)+"px",r.style.overflow="hidden";for(var l=0;l<41;l++){var s=document.createElement("img");s.src="images/cLoading.png",s.className="pixelated",s.style.width=2*iScreenScale+"px",s.style.position="absolute",s.style.left=l*iScreenScale*2+"px",s.style.top="0px",r.appendChild(s)}a.appendChild(r);var c=document.createElement("div");c.style.position="absolute",c.style.left="0px",c.style.top=Math.round(17.5*iScreenScale)+"px",c.style.width=iScreenScale*iWidth+"px",c.style.textAlign="center",c.style.fontSize=2*iScreenScale+"px",c.style.color="#0B0",c.style.display="none",c.style.backgroundColor="rgba(0,0,0, 0.7)",c.innerHTML=toLanguage('<span id="nb-active-players" style="color:#0E0;text-decoration:underline;cursor:pointer"></span> currently online. You\'ll join them as soon as they finish their '+(isBattle?"battle":"race"),'<span id="nb-active-players" style="color:#0E0;text-decoration:underline;cursor:pointer"></span> actuellement en ligne. Vous les rejoindrez une fois leur partie termin√©e'),a.appendChild(c);var p=document.createElement("div");p.style.position="absolute",p.style.left="0px",p.style.top=Math.round(17.5*iScreenScale)+"px",p.style.width=iScreenScale*iWidth+"px",p.style.textAlign="center",p.style.fontSize=2*iScreenScale+"px",p.style.color="#0B0",p.style.display="none",p.style.backgroundColor="rgba(0,0,0, 0.7)",p.innerHTML=toLanguage('<span id="nb-pending-players" style="color:#0E0;text-decoration:underline;cursor:pointer"></span> currently waiting, <span id="nb-missing-players" style="color:#0E0"></span> left before the game begins...','<span id="nb-pending-players" style="color:#0E0;text-decoration:underline;cursor:pointer"></span> actuellement en attente. Plus que <span id="nb-missing-players" style="color:#0E0"></span> pour que la partie commence'),a.appendChild(p);var u=1,d=iScreenScale/2,m=getOnlineCourseParams(e),h=m+(m?"&":"")+"nojoin",g=!!e.enableSpectatorMode;function y(){u&&(--u||xhr("getCourse.php",g?h:m,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}var t,n;return e.found?(t=o.checked,a.innerHTML="",oContainers[0].removeChild(a),t&&((n=document.createElement("embed")).src="musics/mkalert.wav",n.setAttribute("loop",!1),n.setAttribute("autostart",!0),n.style.position="absolute",n.style.left="-1000px",n.style.top="-1000px",document.body.appendChild(n),t=(new Date).getTime(),alert(toLanguage("Opponents have been found !\nGood luck !","Des adversaires ont √©t√© trouv√©s !\nBonne chance !")),e.time-=Math.round(((new Date).getTime()-t)/1e3),document.body.removeChild(n)),handleMatchmakingSuccess(e)):(u=10,e.nb_players?(e.nb_players<2&&(e.nb_players=2),document.getElementById("nb-active-players").innerHTML=e.nb_players+" "+toLanguage("players","joueurs"),p.style.display="none",c.style.display="block"):e.pending_players?((n=document.getElementById("nb-pending-players")).dataset.pendingCourse=e.pending_course,n.innerHTML=e.pending_players+" "+toLanguage("player","joueur")+(1<e.pending_players?"s":""),(n=e.min_players-e.pending_players)<1&&(n=1),document.getElementById("nb-missing-players").innerHTML=n+" "+toLanguage("player","joueur")+(1<n?"s":""),c.style.display="none",p.style.display="block"):(c.style.display="none",p.style.display="none")),!0})),--i<=-4&&(i=0),r.style.left=Math.round(i*d)+"px",setTimeout(y,100)}function f(n,a){var o;n.dataset||(n.dataset={}),addFancyTitle({elt:n,title:"...",style:function(e){return{left:(o=e).left+iScreenScale+"px",top:e.bottom+iScreenScale+"px",backgroundColor:"rgba(51,160,51, 0.95)"}},onShow:function(t){var e=m;n.dataset.pendingCourse&&(e+=(e?"&":"")+"&course="+n.dataset.pendingCourse),xhr("getCourseDetails.php",e,function(e){if(!$mkScreen.contains(t))return!0;e=JSON.parse(e)[a].map(function(e){return e.name});return e.length?(e=e.join("<br />"),t.innerHTML=e,t.style.left=Math.max(iScreenScale,Math.round(o.left+(o.width-t.scrollWidth)/2))+"px"):t.style.visibility="hidden",!0})}})}y(),f(c.querySelector("#nb-active-players"),"active_players"),f(p.querySelector("#nb-pending-players"),"pending_players"),shareLink.key||xhr("sendCourseNotifs.php",null,function(e){return!0});n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){y=function(){},a.innerHTML="",oContainers[0].removeChild(a),selectPlayerScreen(0,void 0,void 0,{enableSpectatorMode:g})},a.appendChild(n),oContainers[0].appendChild(a);t=document.createElement("div");t.style.position="absolute",t.style.left=28*iScreenScale+"px",t.style.top=34*iScreenScale+"px",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.display="flex",t.style.alignItems="center";e=document.createElement("label");e.style.display="inline-flex",e.style.alignItems="center",e.style.cursor="pointer",e.style.gap=Math.round(.5*iScreenScale)+"px",e.style.marginRight=iScreenScale+"px";n=document.createElement("input");n.type="checkbox",n.checked=g,n.style.transform="scale("+iScreenScale/6+")",n.style.transformOrigin="center",n.style.marginRight=Math.round(1.5*iScreenScale-6)+"px",n.onclick=function(){g=this.checked},e.appendChild(n);n=document.createElement("span");n.innerHTML=toLanguage("Spectator mode","Mode spectateur"),e.appendChild(n),t.appendChild(e);e=document.createElement("a");e.href="#null",e.style.color="#CCF",e.innerHTML="[?]",e.style.cursor="help",e.onclick=function(){return!1},e.dataset.noselect="1",t.appendChild(e),addFancyTitle({elt:e,title:toLanguage("Check this to see races<br />without playing on them","Cochez cette case pour voir<br />les courses sans y participer"),style:function(e){return{left:e.left-10*iScreenScale+"px",top:e.top-6*iScreenScale+"px",backgroundColor:"rgba(51,51,160, 0.95)"}}}),a.appendChild(t),updateMenuMusic(0)}function getOnlineCourseParams(e){var t="";return isCup?isMCups?t+="mid="+nid:isSingle?t+=(complete?"i":"id")+"="+nid+(isBattle?"&battle":""):t+=(complete?"c":"s")+"id="+nid:isBattle&&(t+="battle"),shareLink.key&&(t+=(t?"&":"")+"key="+shareLink.key),e.spectator?t+=(t?"&":"")+"spectator="+e.spectator:e.course&&(t+=(t?"&":"")+"course="+e.course),t}function handleMatchmakingSuccess(e){e.time<1&&(e.time=1),e.spectator&&(setSpectatorId(e.spectator),e.spectatorState&&(onlineSpectatorState=e.spectatorState)),selectMapScreen({racecountdown:e.time-5}),dRest(),setTimeout(setChat,1)}function addFancyTitle(t){var n,a,o=t.elt;o.onmouseover=function(){var e;n||(o.style.opacity=.9,(n=document.createElement("div")).className="ranking_activeplayertitle",n.innerHTML=t.title,n.style.position="fixed",n.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",n.style.borderRadius=iScreenScale+"px",n.style.zIndex=10,n.style.color="white",n.style.fontSize=Math.round(1.8*iScreenScale)+"px",n.style.lineHeight=Math.round(2*iScreenScale)+"px",n.style.visibility="hidden",$mkScreen.appendChild(n),t.style&&(e=o.getBoundingClientRect(),Object.assign(n.style,t.style(e))),n.style.visibility="visible",clearInterval(a),a=setInterval(function(){n&&(document.body.contains(o)||($mkScreen.removeChild(n),clearInterval(a),n=void 0))},1e3),t.onShow&&t.onShow(n))},o.onmouseout=function(){n&&(o.style.opacity="",$mkScreen.removeChild(n),clearInterval(a),n=void 0)}}function chooseRandMap(){"MK"==page?"BB"!=course?chooseWithin(0,NBCIRCUITS):chooseWithin(NBCIRCUITS,12):isSingle?choose(1):isBattle?isCup?chooseWithin(0,aAvailableMaps.length):chooseWithin(NBCIRCUITS,12):chooseWithin(0,NBCIRCUITS)}function chooseWithin(e,t){for(var n=e+t,a={},o=e+1;o<=n;o++)a[o]=1;for(o=0;o<aTracksHist.length;o++)delete a[aTracksHist[o]];return!(a=Object.keys(a)).length&&aTracksHist.length?(aTracksHist=aTracksHist.slice(aTracksHist.length-Math.floor(t/2)),chooseWithin(e,t)):choose(a[Math.floor(Math.random()*a.length)],!0)}function selectMapScreen(e){if(e=e||{},"undefined"!=typeof shareLink&&(bSelectedMirror=shareLink.options&&shareLink.options.mirror),isOnline&&(setSRest(),document.getElementById("waitrace").style.visibility="visible",null!=e.racecountdown&&(document.getElementById("racecountdown").innerHTML=e.racecountdown)),!isCup||isMCups){if(clSelected&&!e.force)switch(clSelected.trackType){case"cup":if(-1!==(n=cupIDs.indexOf(clSelected.trackId)))return void selectRaceScreen(4*n);break;case"track":var t=aAvailableMaps.find(function(e){e=oMaps[e];return("CI"===page?e.id:e.map)==clSelected.trackId});if(t){var n,t=oMaps[t];return void selectRaceScreen(4*(n=Math.floor((t.ref-1)/4)))}}var a=document.createElement("div"),o=a.style,i=!0;o.width=iWidth*iScreenScale+"px",o.height=iHeight*iScreenScale+"px",o.border="solid 1px black",o.backgroundColor="black","BB"!=course?a.appendChild(toTitle(toLanguage("Choose cup","Choisissez la coupe"),.5)):a.appendChild(toTitle(toLanguage("Choose stage","Choisissez une ar√®ne"),.5));var r=document.createElement("input");r.type="button",r.value=toLanguage("Back","Retour"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",r.onclick=function(){pause&&!isOnline?(removeMenuMusic(!1),quitter()):(i=!1,A(),isOnline&&(document.getElementById("waitrace").style.visibility="hidden"),chatting=!1,hideSpectatorLink(),selectGamersScreen())};var l=document.createElement("div");l.style.position="absolute",l.style.zIndex=20002,l.style.top=Math.round(35.5*iScreenScale-6)+"px",l.style.left=25*iScreenScale-5+"px",l.style.width=25*iScreenScale+6+"px",l.style.height=Math.round(3.9*iScreenScale)+"px",l.style.border="solid 1px white",l.style.color="white",l.style.backgroundColor="black",l.style.borderBottom="none",l.style.textAlign="center",l.style.display="none",l.style.flexDirection="column",l.style.justifyContent="center";var s=document.createElement("div");s.style.maxHeight=Math.round(3.9*iScreenScale)+"px",s.style.overflow="hidden",l.appendChild(s),a.appendChild(l),a.appendChild(r),"GP"!=course&&oContainers[0].appendChild(a),document.getElementById("dMaps").style.top=40*iScreenScale+"px",document.getElementById("dMaps").style.left=7+25*iScreenScale+"px",document.getElementById("dMaps").style.width=25*iScreenScale+"px",document.getElementById("dMaps").style.height=10*iScreenScale+"px";var c,p,u=["champi","etoile","carapace","carapacebleue","speciale","carapacerouge","banane","feuille","megachampi","eclair","upchampi","fireflower","bobomb","minichampi","egg","iceflower","plume","cloudchampi"];"BB"==course?(c=(aAvailableMaps.length-NBCIRCUITS)/4,isCup||(u=["snes","gba","ds"])):c=NBCIRCUITS/4;var d=Math.ceil(c/6),m=c,h=0,g=d,y=cupOpts.lines;if(y){if(cupOpts.pages){if(!e.page&&(e.page=0,e.cup)){e.cup/=4;for(var f=0,S=0;S+y[f]<=e.cup;)S+=y[f],f++;for(;cupOpts.pages[e.page]<=f;)e.page++;delete e.cup}for(var o=e.page,h=0<o?cupOpts.pages[o-1]:0,g=o<cupOpts.pages.length?cupOpts.pages[o]:y.length,m=0,v=h;v<g;v++)m+=y[v]}else g=y.length;d=g-h}var b=p=Math.ceil(m/d);if(y)for(v=b=0;v<y.length;v++)b=Math.max(b,y[v]);var C=Math.min(Math.round(10.5/Math.pow(Math.max(m/5,d,.5),.6)),16/d,60/b),x=Math.min(4,20/b),M=4/d,P=38;isCup||"BB"!=course||(C=Math.round(1.5*C),x=Math.round(2*x),P-=3);for(var k,I,w,L,T,E,D,B,O,z,H=0,R=0,v=0;v<c;v++){if(y?(w=y[R],k=H,++H>=y[I=R]&&(H=0,R++)):(w=Math.min(p,c-(v-v%p)),k=v%p,I=Math.floor(v/p)),g<=I)break;(I-=h)<0||((L=document.createElement("img")).className="pixelated",L.style.width=C*iScreenScale+"px",L.style.height=C*iScreenScale+"px",L.style.cursor="pointer",L.style.position="absolute",T=(iWidth+x+1)/2+(k-w/2)*(C+x),z=(M+P)/2+(I-d/2)*(C+M),L.style.left=Math.round(T*iScreenScale)+"px",L.style.top=Math.round(z*iScreenScale)+"px",cupOpts.icons?"number"==typeof cupOpts.icons[v]?L.src="images/cups/"+u[cupOpts.icons[v]]+".gif":function(e,t){L.onload=function(){this.naturalWidth>this.naturalHeight?(this.style.width=C*iScreenScale+"px",this.style.top=Math.round((t+C*(1-this.naturalHeight/this.naturalWidth)/2)*iScreenScale)+"px",this.style.height="auto"):(this.style.width="auto",this.style.height=C*iScreenScale+"px",this.style.left=Math.round((e+C*(1-this.naturalWidth/this.naturalHeight)/2)*iScreenScale)+"px")},L.src=cupOpts.icons[v]}(T,z):L.src="images/cups/"+u[v%u.length]+".gif","BB"==course?L.alt=v+NBCIRCUITS/4:L.alt=v,E=iScreenScale,L.onmouseover=function(){var e=new Image;e.src=getMapSelectorSrc(v),e.alt=4*this.alt+4,e.style.border="double 4px white",e.style.width="100%",e.style.height="100%",e.className="pixelated",bSelectedMirror&&(e.className+=" mirrored"),e.id="maps",document.getElementById("dMaps").appendChild(e),document.getElementById("dMaps").style.display="block",function e(t,n){var a,o;document.getElementById("maps")&&document.getElementById("maps").alt==n&&(n%4!=0?n++:n-=3,a=document.getElementById("dMaps"),o=mapNameOf(t,n-1),a.appendChild(o),document.getElementById("maps").alt=n,document.getElementById("maps").src=getMapSelectorSrc(n-1),setTimeout(function(){try{a.removeChild(o)}catch(e){return}e(t,n)},1e3))}(E,4*this.alt+4);var t,n=cupPayloads[this.alt];n&&(s.innerHTML="",(e=n.name)&&((n=n.prefix)&&((t=document.createElement("span")).innerText=n,t.style.fontSize="0.7em",s.appendChild(t)),(t=document.createElement("span")).innerText=e,s.appendChild(t),e=n?n+e:e,e=Math.min(Math.max(8/Math.sqrt(e.length),1.45),3),l.style.fontSize=Math.round(e*iScreenScale)+"px",l.style.display="flex",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.gap="0.25em"))},L.onmouseout=function(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",l.style.display="none"},L.onclick=function(){A(),selectRaceScreen(4*this.alt)},isCup||"BB"!=course||(D=[toLanguage("SNES Stages","Ar√®nes SNES"),toLanguage("GBA Stages","Ar√®nes GBA"),toLanguage("DS Stages","Ar√®nes DS")],(B=document.createElement("div")).style.position="absolute",B.style.left=Math.round((T-x/2)*iScreenScale)+"px",B.style.top=Math.round((z+.9*C)*iScreenScale)+"px",B.style.width=(C+x)*iScreenScale+"px",B.style.fontSize=3*iScreenScale+"px",B.style.color="white",B.style.textAlign="center",B.innerHTML=D[v],a.appendChild(B)),a.appendChild(L),"GP"==course?(B=+ptsGP.charAt(v))&&((O=new Image).src="images/cups/cup"+(4-B)+".png",O.style.width=Math.round(4*iScreenScale*C/7)+"px",O.style.height=Math.round(4*iScreenScale*C/7)+"px",O.style.position="absolute",O.style.left=Math.round((T+4*C/7)*iScreenScale)+"px",O.style.top=Math.round((z+4*C/7)*iScreenScale)+"px",O.className="pixelated",a.appendChild(O)):isMCups&&!isOnline&&((O=document.createElement("a")).style.position="absolute",O.style.left=Math.round((T+5*C/7)*iScreenScale)+"px",O.style.top=Math.round((z+5*C/7)*iScreenScale)+"px",O.style.backgroundColor="rgba(0,50,128, 0.5)",O.style.padding="4px",O.style.borderRadius="50%",O.href="?cid="+cupIDs[v],O.title=toLanguage("Link to this cup","Lien vers cette coupe"),O.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},O.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},(z=document.createElement("img")).src="images/clink.png",z.style.width=Math.round(C*iScreenScale*2/7)+"px",O.appendChild(z),a.appendChild(O)))}"VS"==course||"BB"==course?((r=document.createElement("input")).type="button",r.value=toLanguage("Random","Al√©atoire"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=34*iScreenScale-10+"px",r.style.top=30*iScreenScale+"px",r.onclick=function(){i=!1,A(),chooseRandMap()},a.appendChild(r)):"GP"==course?oContainers[0].appendChild(a):"CM"==course&&((r=document.createElement("input")).type="button",r.value=toLanguage("Rankings","Classement"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=33*iScreenScale-10+"px",r.style.top=30*iScreenScale+"px",r.onclick=openRankings,a.appendChild(r)),showRaceCountIfRelevant(a),cupOpts.pages&&cupOpts.pages.length&&((r=document.createElement("input")).type="button",r.value="‚óÑ",r.style.fontSize=Math.round(2.5*iScreenScale)+"px",r.style.position="absolute",r.style.left=72*iScreenScale+"px",r.style.top=(isOnline?31:34)*iScreenScale+"px",r.className="disablable",r.onclick=function(){e.page--,A(),selectMapScreen(e)},r.disabled=e.page<=0,a.appendChild(r),(r=document.createElement("input")).type="button",r.value="‚ñ∫",r.style.fontSize=Math.round(2.5*iScreenScale)+"px",r.style.position="absolute",r.style.left=76*iScreenScale+"px",r.style.top=(isOnline?31:34)*iScreenScale+"px",r.className="disablable",r.onclick=function(){e.page++,A(),selectMapScreen(e)},r.disabled=e.page>=cupOpts.pages.length,a.appendChild(r)),isOnline&&(handleSpectatorLink(function(){i=!1,A()}),setTimeout(function(){i&&(A(),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)),updateMenuMusic(1)}else selectRaceScreen(0);function A(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",a.innerHTML="",oContainers[0].removeChild(a)}}function setMapSrc(e,t,n,a){isCup?setTimeout(function(){e.src=a},100*(n-t)):e.src=a}function rankingsLink(e){var t=getActualCc();switch(page){case"MK":return"classement.php?map="+e.map+"&cc="+t;case"CI":return"classement.php?circuit="+e.id+"&cc="+t;case"MA":return"classement.php?draw="+e.map+"&cc="+t}}function globalRankingsLink(){var e=getActualCc();if(isMCups)return"classement.php?mcup="+nid+"&cc="+e;switch(page){case"MK":return"classement.php?cc="+e;case"CI":return"classement.php"+(isSingle?"?circuit="+nid:"?scup="+nid)+"&cc="+e;case"MA":return"classement.php"+(isSingle?"?draw="+nid:"?ccup="+nid)+"&cc="+e}}function openRankings(){open(globalRankingsLink())}function exitCircuit(){var e=document.getElementById("changeRace"),t=document.getElementById("supprRace");e&&!t?e.click():document.location.href="index.php"}function showRaceCountIfRelevant(e){var t,n;"CM"!=course&&iRaceCount&&isLocalScore()&&(t=document.createElement("div"),n="BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),t.innerHTML=n+" "+(iRaceCount+1),t.style.fontSize=2*iScreenScale+"px",t.style.position="absolute",t.style.color="#ccc",t.style.right=3*iScreenScale+"px",t.style.top=(isOnline?isSingle||isMCups||!isCup?31:27:35)*iScreenScale+"px",e.appendChild(t))}function appendContainers(){for(var e=1;e<oContainers.length;e++)$mkScreen.appendChild(oContainers[e])}function selectRaceScreen(e){if(!isOnline&&(isSingle||"GP"==course))return"GP"==course&&(iDificulty="MK"!=page?5:(n=Math.floor(e/4)%5,e<40?Math.min(4.5+n/7,5):Math.min(4.6+n/7,5))),strMap="map"+ ++e,"CM"==course?void loadGhostScreen(strMap):(appendContainers(),void resetGame(strMap));var t=document.createElement("div"),n=t.style,a=!0;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",oContainers[0].appendChild(t),"BB"!=course?t.appendChild(toTitle(toLanguage("Choose track","Choisissez un circuit"),isSingle?2.5:.5)):t.appendChild(toTitle(toLanguage("Choose stage","Choisissez une ar√®ne"),isSingle?2.5:.5));n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",n.onclick=function(){a=!1,t.innerHTML="",oContainers[0].removeChild(t),isOnline&&isCup&&!isMCups?(document.getElementById("waitrace").style.visibility="hidden",chatting=!1,hideSpectatorLink(),selectPlayerScreen(0)):"BB"!=course?isCup&&!isMCups?pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():selectMapScreen({force:!0,cup:e}):!isCup||isMCups?selectMapScreen({force:!0,cup:e}):pause?(removeMenuMusic(!1),quitter()):selectGamersScreen()},t.appendChild(n);for(var o,i=iScreenScale,r=clSelected&&"track"===clSelected.trackType?clSelected.trackId:null,l=isSingle?e+1:e+4,s=e;s<l;s++){var c=document.createElement("div");c.style.width=25*iScreenScale+"px",c.style.height=10*iScreenScale+"px",c.style.cursor="pointer",c.style.position="absolute";var p=s-e;isSingle?(c.style.left=27*iScreenScale+"px",c.style.top=15*iScreenScale+"px"):(c.style.left=((iWidth-113)/2+25*(p-2*Math.floor(p/2))+(p-2*Math.floor(p/2)))*iScreenScale+30*iScreenScale+"px",c.style.top=10*iScreenScale+11*iScreenScale*Math.floor(p/2)+"px"),c.map=aAvailableMaps[s],c.ref=s+1;p=new Image;setMapSrc(p,e,s,getMapSelectorSrc(s)),p.style.width="100%",p.style.height="100%",p.style.border="double 4px silver",p.className="pixelated",bSelectedMirror&&(p.className+=" mirrored"),c.appendChild(p),c.appendChild(mapNameOf(i,s)),isCup&&!isOnline&&((u=document.createElement("a")).style.position="absolute",u.style.right="-3px",u.style.top="5px",u.style.backgroundColor="rgba(0,50,128, 0.5)",u.style.padding="4px",u.style.borderRadius="50%",p=oMaps[aAvailableMaps[s]],u.href=complete?"?i="+p.map:"?id="+p.id,u.title=toLanguage("Link to this "+(isBattle?"arena":"circuit"),"Lien vers "+(isBattle?"cette ar√®ne":"ce circuit")),u.onclick=function(e){e.stopPropagation()},u.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},u.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},u.dataset.noselect="1",(p=document.createElement("img")).src="images/clink.png",p.style.width=2*iScreenScale+"px",u.appendChild(p),c.appendChild(u)),c.onclick=function(){a=!1,t.innerHTML="",oContainers[0].removeChild(t),isOnline?choose(this.ref):"CM"!=course?(appendContainers(),resetGame(this.map)):loadGhostScreen(this.map)};var u=oMaps[c.map];("CI"===page?u.id:u.map)==r&&(o=c),t.appendChild(c)}!isCup||isSingle||isMCups||((n=document.createElement("input")).type="button","CM"!=course?n.value=toLanguage("Random","Al√©atoire"):n.value=toLanguage("Rankings","Classement"),n.style.position="absolute",isOnline?(n.style.fontSize=2*iScreenScale+"px",n.style.left=67*iScreenScale+"px",n.style.top=30*iScreenScale+"px"):(n.style.fontSize=3*iScreenScale+"px",n.style.left=34*iScreenScale-10+"px",n.style.top=34*iScreenScale+"px"),n.onclick=function(){"CM"!=course?(a=!1,t.innerHTML="",oContainers[0].removeChild(t),chooseRandMap()):openRankings()},t.appendChild(n)),showRaceCountIfRelevant(t),isOnline&&(setSRest(),handleSpectatorLink(function(){a=!1,t.innerHTML="",oContainers[0].removeChild(t)}),setTimeout(function(){a&&(t.innerHTML="",oContainers[0].removeChild(t),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)),o?o.click():updateMenuMusic(1)}function choose(map,rand){if(!isOnline)return appendContainers(),void resetGame("map"+map);var choixJoueurs=[],oTable=document.createElement("table");oTable.className="online-track-sel",oTable.border=1,oTable.setAttribute("cellspacing",2),oTable.setAttribute("cellpadding",2),oTable.style.position="absolute",oTable.style.fontSize=2*iScreenScale+"pt",oTable.style.textAlign="center",oTable.style.left=25*iScreenScale+"px",oTable.style.top=2*iScreenScale+"px",oTable.style.width=30*iScreenScale+"px",onlineSpectatorState&&(oTable.style.display="none");var oTBody=document.createElement("tbody");function refreshTab(reponse){if(null!=waitHandler){if(reponse){if(-1!=reponse){var rCode;try{rCode=eval(reponse)}catch(e){return!1}choixJoueurs=rCode[0];for(var trs=oTBody.getElementsByTagName("tr");trs.length;)oTBody.removeChild(trs[0]);var nbChoices=0,oTr,oTd,isChoix,isRandom;for(i=0;i<choixJoueurs.length;i++){choixJoueurs[i][7]||(oTr=document.createElement("tr"),oTd=document.createElement("td"),isChoix=choixJoueurs[i][2],isRandom=choixJoueurs[i][3],oTd.innerHTML=isChoix?isRandom?"???":dCircuits[isChoix-1]:toLanguage("Not chosen","Non choisi"),onlineSpectatorId&&choixJoueurs[i][0]==identifiant&&(isChoix?(setSpectatorId(void 0),hideSpectatorLink()):oTd.style.display="none"),oTr.appendChild(oTd),oTBody.appendChild(oTr),nbChoices++)}function backToSearch(){$mkScreen.removeChild(oTable),leaveRaceWheelScreen()}if(-1==rCode[1]){if(onlineSpectatorState)return setSpectatorId(void 0),backToSearch(),!0;rePosSpectatorLink(),waitHandler=setTimeout(waitForChoice,1e3)}else{hideSpectatorLink();var gameRules=rCode[4],cpuLevel,cpuLevel,itemMode;if(nbChoices>=gameRules.minPlayers){for(aPlayers=new Array,aIDs=new Array,aPlaces=new Array,aPseudos=new Array,aControllers=new Array,shareLink.options&&shareLink.options.cpu&&(cpuLevel=shareLink.options.cpuLevel||0,cpuLevel=2-cpuLevel,iDificulty=4+.5*cpuLevel,isBattle&&(iDificulty=4.5)),fSelectedClass=gameRules.cc?getRelSpeedFromCc(gameRules.cc):1,bSelectedMirror=!!gameRules.mirror,0<=gameRules.raceCount&&(iRaceCount=gameRules.raceCount),aTeams=new Array,i=0;i<choixJoueurs.length;i++){var aID=choixJoueurs[i][0],sPlayerName;aID!=identifiant?(aIDs.push(aID),sPlayerName=choixJoueurs[i][1],aPlayers.push(sPlayerName),isCustomPerso(sPlayerName),cp[sPlayerName]||(cp[sPlayerName]=[.5,.5,.5,.5]),aPlaces.push(choixJoueurs[i][4]),aPseudos.push(choixJoueurs[i][5]),aTeams.push(choixJoueurs[i][6]),aControllers.push(choixJoueurs[i][7])):(aPlaces.unshift(choixJoueurs[i][4]),aPseudos.unshift(choixJoueurs[i][5]),aTeams.unshift(choixJoueurs[i][6]))}selectedTeams=-1==aTeams.indexOf(-1),selectedTeams||(aTeams.length=0),shareLink.options&&shareLink.options.itemDistrib&&(selectedItemDistrib=isNaN(shareLink.options.itemDistrib)?shareLink.options.itemDistrib:(itemMode=getItemMode(),itemDistributions[itemMode][shareLink.options.itemDistrib].value)),selectedPtDistrib=shareLink.options&&shareLink.options.ptDistrib?shareLink.options.ptDistrib:ptDistributions[0],oDoubleItemsEnabled=!shareLink.options||0!=shareLink.options.doubleItems;var tNow=(new Date).getTime();tnCourse=tNow+rCode[2],isSingle?rCode[2]=0:gameRules.manualTeams?playerIsSelecter()?rCode[2]=0:rCode[2]-=gameRules.selectionTime:tnCourse+=5e3;var tThen=tNow+rCode[2];connecte=rCode[3]+1;var cCursor=0,cTime=50;function moveCursor(){var e=!0;if(cCursor==rCode[1]){for(var t=0,n=cTime,a=0;a<nbChoices;a++)t+=n=Math.round(1.05*n);t>=tThen-(new Date).getTime()&&(e=!1)}e?(trs[cCursor].style.backgroundColor="",trs[cCursor].style.color="",++cCursor==nbChoices&&(cCursor=0),trs[cCursor].style.backgroundColor="#F80",trs[cCursor].style.color="white",cTime=Math.round(1.05*cTime),setTimeout(moveCursor,cTime)):clignote(0)}function clignote(e){trs[cCursor].style.backgroundColor=e%2?"":"#F80",trs[cCursor].style.color=e%2?"":"white",e<4?setTimeout(function(){clignote(e+1)},100):setTimeout(function(){$mkScreen.removeChild(oTable),proceedOnlineRaceSelection(rCode)},500),1==e&&(trs[cCursor].getElementsByTagName("td")[0].innerHTML=dCircuits[choixJoueurs[cCursor][2]-1])}oMap=oMaps[aAvailableMaps[choixJoueurs[rCode[1]][2]-1]],onlineSpectatorState?($mkScreen.removeChild(oTable),setTimeout(function(){proceedOnlineRaceSelection(rCode)},500)):moveCursor()}else{if(onlineSpectatorState)return setSpectatorId(void 0),backToSearch(),!0;var oDiv=document.createElement("div");oDiv.style.position="absolute",oDiv.style.left=10*iScreenScale+10+"px",oDiv.style.top=20*iScreenScale+10+"px",oDiv.style.fontSize=2*iScreenScale+"pt",oDiv.innerHTML=1<nbChoices||onlineSpectatorId?toLanguage("Sorry, there are not enough players to begin the race...","D&eacute;sol&eacute;, il n'y a pas assez de joueurs pour commencer la course..."):toLanguage("Sorry, all your opponents have left the race...","D&eacute;sol&eacute;, tous vos adversaires ont quitt&eacute; la course..."),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),nSearch.setAttribute("href","#null"),nSearch.onclick=function(){return $mkScreen.removeChild(oDiv),backToSearch(),!1},oDiv.appendChild(nSearch),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Back to Mario Kart PC","Retour √† Mario Kart PC"),nSearch.setAttribute("href","index.php"),oDiv.appendChild(nSearch),$mkScreen.appendChild(oDiv),choixJoueurs.length<=1&&(chatting=!1,stopVocChat()),clearInterval(startMusicHandler),window.onbeforeunload=void 0}}}else iDeco();return!0}return!1}}function playerIsSelecter(){for(var e,t=0;t<choixJoueurs.length;t++)if(choixJoueurs[t][0]==shareLink.player){e=choixJoueurs[t];break}return(e=e||choixJoueurs[0])[0]==identifiant}function proceedOnlineRaceSelection(e){var t=e[4],e=aAvailableMaps[choixJoueurs[e[1]][2]-1];selectedNbTeams=t.nbTeams||defaultGameOptions.nbTeams,selectedTeamOpts=t.teamOpts||defaultGameOptions.teamOpts,selectedFriendlyFire=!!t.friendlyFire,selectedNbTeams>choixJoueurs.length&&(selectedNbTeams=choixJoueurs.length,selectedTeamOpts&&(selectedTeamOpts.length=selectedNbTeams)),t.manualTeams?(setupTeamColors(),selectOnlineTeams(e,choixJoueurs,playerIsSelecter())):resetGame(e)}function rePosSpectatorLink(){var e,t,n=document.getElementById("spectatormode");n&&(e=oTable.getBoundingClientRect(),t=window.scrollY||0,n.style.top=Math.max(e.bottom+t+5,38*iScreenScale+15)+"px")}onlineSpectatorId?(waitHandler=setTimeout(waitForChoice,1),onlineSpectatorState||showSpectatorLink({toggled:!0,click:function(){clearTimeout(waitHandler),waitHandler=null,$mkScreen.removeChild(oTable)}})):(xhr("chooseMap.php","joueur="+strPlayer+"&map="+map+("BB"==course?"&battle":"")+(rand?"&rand":""),refreshTab),hideSpectatorLink(),window.onbeforeunload=function(){return language?"Caution, if you leave the game, you are considered loser":"Attention, si vous quittez la partie, vous √™tes consid√©r√© comme perdant"});var waitHandler=0;function waitForChoice(){var e=[];onlineSpectatorId&&e.push("spectator="+onlineSpectatorId),"BB"==course&&e.push("battle"),xhr("getMap.php",e.join("&"),refreshTab)}oTable.appendChild(oTBody),$mkScreen.appendChild(oTable),document.getElementById("waitrace").style.visibility="hidden",updateMenuMusic(1),formulaire.dataset.disabled=1,bMusic&&(startMusicHandler=setInterval(function(){oMap&&oMap.mapImg&&(loadMapMusic(),clearInterval(startMusicHandler))},onlineSpectatorState?10:500))}function leaveRaceWheelScreen(){clearRaceWheenScreen(),removeMenuMusic(),removeGameMusics(),chatting=!1;var e={enableSpectatorMode:!!onlineSpectatorId};setSpectatorId(void(iRaceCount=0)),searchCourse(e)}function clearRaceWheenScreen(){clearInterval(startMusicHandler),formulaire.dataset.disabled="",hideSpectatorLink()}function setSpectatorId(e){(onlineSpectatorId=e)||(onlineSpectatorState=void 0),rtcService&&rtcService.setSpectatorId(onlineSpectatorId)}function selectOnlineTeams(s,e,t){var y=document.createElement("div"),n=y.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black";var a=selectedTeamOpts&&selectedTeamOpts.some(function(e){return e.name}),n=toTitle(toLanguage("Team selection","S√©lection des √©quipes"),.5);a?(n.style.top="0px",n.style.fontSize=Math.round(5*iScreenScale)+"px"):n.style.fontSize=Math.round(7*iScreenScale)+"px",y.appendChild(n);var c=document.createElement("div");if(c.style.display="none",c.style.position="absolute",c.style.zIndex=5e4,c.style.left=iScreenScale+"px",c.style.top=10*iScreenScale+"px",c.style.width=(iWidth-2)*iScreenScale+"px",c.style.height=iScreenScale*(iHeight-10)+"px",c.style.overflow="auto",c.style.textAlign="center",a){c.style.top=7.5*iScreenScale+"px",c.style.paddingTop=2.5*iScreenScale+"px",(C=document.createElement("div")).style.position="absolute",C.style.left=iScreenScale+"px",C.style.top="0px",C.style.width=(iWidth-2)*iScreenScale+"px",C.style.textAlign="center",C.style.fontSize=2*iScreenScale+"px",C.style.whiteSpace="nowrap",C.style.color="white";for(var o=0;o<selectedNbTeams;o++){var i=document.createElement("div");i.style.width=2<selectedNbTeams?Math.round(18.5*iScreenScale)+"px":22*iScreenScale+"px",i.style.display="inline-block",i.style.overflow="hidden",i.style.whiteSpace="nowrap",i.style.textOverflow="ellipsis",i.style.textAlign="center",i.innerHTML=cTeamColors.name[o],C.appendChild(i)}c.appendChild(C)}var f=document.createElement("table");f.style.marginLeft="auto",f.style.marginRight="auto",f.style.fontSize=2<selectedNbTeams?2*iScreenScale+"px":Math.round(2.4*iScreenScale)+"px";var p=document.createElement("div");p.style.zIndex=50002,p.style.display="none",p.style.position="absolute",p.style.right=3*iScreenScale+"px",p.style.bottom=5*iScreenScale+"px";a=document.createElement("input");a.type="button",a.style.display="block",a.style.marginTop=Math.round(iScreenScale/2)+"px",a.value=toLanguage("No teams","Chacun pour soi"),a.style.fontSize=2*iScreenScale+"px",a.style.width=18*iScreenScale+"px",a.style.textAlign="center",a.onclick=function(){r(toLanguage("No teams?","Jouer sans √©quipes ?"),toLanguage("Please confirm that you want to play without teams","Confirmez que vous souhaitez jouer en mode <em>chacun pour soi</em>."),function(){clearTimeout(h);var e="noteams";isBattle&&(e+="&battle"),isSingle&&(e+="&single"),m(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return l(t),!0})})},p.appendChild(a);a=document.createElement("input");function r(e,t,n){var a=document.createElement("div");a.id="online-teams-confirm",a.style.position="absolute",a.style.left=0,a.style.top=0,a.style.width=iWidth*iScreenScale+"px",a.style.height=iHeight*iScreenScale+"px",a.style.backgroundColor="rgba(0,0,0, 0.5)",a.style.zIndex=6e4;var o=document.createElement("div");o.style.position="absolute",o.style.zIndex=6e4,o.style.left=Math.round(iScreenScale*iWidth/2)+"px",o.style.top=Math.round(iScreenScale*iHeight/2)+"px",o.style.width=40*iScreenScale+"px",o.style.transform=o.style.WebkitTransform=o.style.MozTransform="translate(-50%, -50%)",o.style.backgroundColor="gray",o.style.border="solid 1px silver",o.onclick=function(e){e.stopPropagation()};var i=document.createElement("div");i.style.marginTop=iScreenScale+"px",i.style.marginBottom=Math.round(iScreenScale/2)+"px",i.style.fontSize=Math.round(2.5*iScreenScale)+"px",i.style.textAlign="center",i.style.marginLeft=2*iScreenScale+"px",i.style.marginRight=2*iScreenScale+"px",i.style.color="#FE9",i.innerHTML=e,o.appendChild(i);i=document.createElement("div");i.style.marginBottom=iScreenScale+"px",i.style.textAlign="center",i.style.marginLeft=Math.round(1.5*iScreenScale)+"px",i.style.marginRight=Math.round(1.5*iScreenScale)+"px",i.style.fontSize=Math.round(1.8*iScreenScale)+"px",i.style.color="white",i.innerHTML=t,o.appendChild(i);t=document.createElement("div");t.style.textAlign="center",t.style.marginBottom=iScreenScale+"px";var r=document.createElement("input");r.type="button",r.style.marginRight=Math.round(iScreenScale/2)+"px",r.value="Ok",r.style.fontSize=Math.round(2*iScreenScale)+"px",r.onclick=function(){return y.removeChild(a),n(),!1},t.appendChild(r);i=document.createElement("input");return i.type="button",i.value=toLanguage("Cancel","Annuler"),i.style.marginLeft=Math.round(iScreenScale/2)+"px",i.style.fontSize=Math.round(2*iScreenScale)+"px",i.onclick=a.onclick=function(){return y.removeChild(a),!1},t.appendChild(i),o.appendChild(t),a.appendChild(o),y.appendChild(a),setTimeout(function(){r.focus()},1),a}function S(e){f.innerHTML="";for(var t=v.reduce(function(e,t){return Math.max(e,t.length)},0),n=0;n<t;n++){for(var a=document.createElement("tr"),o=0;o<selectedNbTeams;o++){var i=document.createElement("td"),r=v[o][n];if(r){selectedTeams?(i.style.backgroundColor=cTeamColors.contrast[o],i.style.color=cTeamColors.primary[o]):(i.style.backgroundColor="#ccc",i.style.color="#222"),2<selectedNbTeams?(i.style.paddingLeft=Math.round(2.5*iScreenScale)+"px",i.style.paddingRight=Math.round(2.5*iScreenScale)+"px"):(i.style.paddingLeft=3*iScreenScale+"px",i.style.paddingRight=3*iScreenScale+"px"),i.style.position="relative",i.style.textAlign="center",i.style.userSelect="none";var l=document.createElement("span");if(l.style.display="block",l.style.top="1px",l.style.position="relative",l.innerHTML=r[5],l.style.whiteSpace="nowrap",l.style.textOverflow="ellipsis",l.style.overflow="hidden",l.style.width=2<selectedNbTeams?Math.round(13.5*iScreenScale)+"px":16*iScreenScale+"px",i.appendChild(l),e)for(var s=0;s<2;s++){var c=document.createElement("span");c.innerHTML=s?"‚óÄ":"‚ñ∂",c.style.position="absolute",s?c.style.left="0px":c.style.right="0px",c.style.top="48%",c.style.color="#F80",c.style.padding=Math.round(iScreenScale/2)+"px",c.style.transform=c.style.WebkitTransform=c.style.MozTransform="translateY(-50%)",c.style.cursor="pointer",c.style.opacity=.9,c.onmouseover=function(){this.style.opacity=.45},c.onmouseout=function(){this.style.opacity=.9},c.dataset||(c.dataset={}),c.dataset.i=n,c.dataset.j=o,c.dataset.k=s,c.onclick=u,i.appendChild(c)}}else{l=document.createElement("div");l.style.width=20*iScreenScale+"px",i.appendChild(l)}a.appendChild(i)}f.appendChild(a)}var p=v.reduce(function(e,t){return e+(t.length?1:0)},0);selectedNbTeams<=p?(g.style.opacity=1,g.disabled=!1,g.style.cursor=""):(g.style.opacity=.4,g.disabled=!0,g.style.cursor="not-allowed")}function u(){var p=document.createElement("div");p.style.position="absolute",p.style.left="0px",p.style.top="0px",p.style.width=iScreenScale*iWidth+"px",p.style.height=iScreenScale*iWidth+"px",p.style.zIndex=5e4,y.appendChild(p);var u=+this.dataset.i,d=+this.dataset.j,m=+this.dataset.k?-1:1,e=v[d][u];v[d].splice(u,1);var h=(d+m+selectedNbTeams)%selectedNbTeams;v[h].splice(Math.min(u,v[h].length),0,e);var g=this.parentNode;g.style.backgroundColor="#ccc",function e(t,n,a){var o=t;if(n<(t+=a))y.removeChild(p),S(!0);else{g.style.left=Math.round(20*iScreenScale*t/n*m)+"px";var i=n/2;o<i&&i<=t&&(g.style.backgroundColor=cTeamColors.contrast[h],g.style.color=cTeamColors.primary[h]);for(var r=f.getElementsByTagName("tr"),l=0;l<selectedNbTeams;l++)if(l===d||l===h)for(var s=l==d,c=s?u+1:u;c<r.length;c++)r[c].getElementsByTagName("td")[l].style.top=Math.round(3*iScreenScale*t/n*(s?-1:1))+"px";b=setTimeout(function(){e(t,n,a)},a)}}(0,150,20)}function l(e){tnCourse=(new Date).getTime()+e.time;for(var t=e.teams,n={},a=0;a<selectedNbTeams;a++)for(var o=0;o<v[a].length;o++)n[v[a][o][0]]=v[a][o];for(a=0;a<t.length;a++)n[t[a].id][6]=t[a].team;var i=strPlayer.length;onlineSpectatorId&&(i=0);for(a=0;a<i;a++)aTeams[a]=n[identifiant][6];for(a=0;a<aPlayers.length;a++){var r=aIDs[a];aTeams[a+i]=n[r][6]}selectedTeams=-1==aTeams.indexOf(-1);for(a=0;a<selectedNbTeams;a++)v[a].length=0;if(selectedTeams)for(a=0;a<t.length;a++)v[t[a].team].push(n[t[a].id]);else for(a=0;a<t.length;a++)v[a%selectedNbTeams].push(n[t[a].id]);S(!1),c.removeChild(g),y.removeChild(p);var l=document.createElement("div");l.style.textAlign="center",l.style.fontSize=3*iScreenScale+"px",l.style.marginTop=iScreenScale+"px",l.style.color="#DFC",l.innerHTML=selectedTeams?toLanguage("Teams have been selected !","Les √©quipes ont √©t√© s√©lectionn√©es !"):toLanguage("Mode &quot;no teams&quot; selected. In this game, you're playing for yourself!","Mode &quot;Chacun pour soi&quot; s√©lectionn√©. Cette partie se d√©roulera sans √©quipes"),c.appendChild(l),c.style.display="block",connecte=e.connect+1;l=tnCourse-(new Date).getTime();setTimeout(function(){y.innerHTML="",oContainers[0].removeChild(y),resetGame(s)},onlineSpectatorState?0:Math.min(e.previewTime,l-1e3))}function d(){oContainers[0].removeChild(y),y.innerHTML="";var e=document.createElement("div");e.style.position="absolute",e.style.left=10*iScreenScale+10+"px",e.style.top=15*iScreenScale+10+"px",e.style.fontSize=2*iScreenScale+"pt",e.innerHTML=toLanguage("The game has been cancelled by the teams selector.","Partie annul√©e par le s√©lectionneur des √©quipes."),e.appendChild(document.createElement("br"));var t=document.createElement("a");t.style.color="white",t.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),t.setAttribute("href","#null"),t.onclick=function(){return $mkScreen.removeChild(e),leaveRaceWheelScreen(),!1},e.appendChild(t),e.appendChild(document.createElement("br")),(t=document.createElement("a")).style.color="white",t.innerHTML=toLanguage("Back to Mario Kart PC","Retour √† Mario Kart PC"),t.setAttribute("href","index.php"),e.appendChild(t),$mkScreen.appendChild(e),clearInterval(startMusicHandler),window.onbeforeunload=void 0}function m(){c.style.display="none",p.style.display="none";var e=document.getElementById("online-teams-confirm");e&&y.removeChild(e),document.getElementById("waitteam").style.visibility="hidden"}a.type="button",a.style.display="block",a.style.marginTop=Math.round(iScreenScale/2)+"px",a.value=toLanguage("Cancel game","Annuler la partie"),a.style.fontSize=2*iScreenScale+"px",a.style.width=18*iScreenScale+"px",a.style.color="#F60",a.style.textAlign="center",a.onclick=function(){r(toLanguage("Cancel game?","Annuler la partie ?"),toLanguage("Caution, you're about to cancel the game <strong style=\"color:#FEB\">for all players</strong>. Use this option if you're waiting for more players for example.",'Attention, vous √™tes sur le point d\'annuler la partie <strong style="color:#FEB">pour tous les joueurs</strong>. Utilisez cette option si vous attendez plus de joueurs par exemple.'),function(){clearTimeout(h);var e="cancel";isBattle&&(e+="&battle"),m(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;try{JSON.parse(e)}catch(e){return!1}return d(),!0})})},p.appendChild(a),y.appendChild(p);for(var v=new Array(selectedNbTeams),o=0;o<selectedNbTeams;o++)v[o]=[];for(o=0;o<e.length;o++)v[e[o][6]].push(e[o]);var h,b,g=document.createElement("input");g.type="button",g.style.fontSize=3*iScreenScale+"px",g.style.marginTop=iScreenScale+"px",g.value=toLanguage("Validate","Valider"),g.onclick=function(){clearTimeout(h);for(var e="",t=0,n=0;n<selectedNbTeams;n++)for(var a=0;a<v[n].length;a++)t&&(e+="&"),e+="j"+v[n][a][0]+"="+n,t++;isBattle&&(e+="&battle"),isSingle&&(e+="&single"),m(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return l(t),!0})},c.appendChild(f),c.appendChild(g),y.appendChild(c);var C,x=(new Date).getTime(),M=tnCourse-x-2e3;if(t)setSRest("team"),document.getElementById("teamcountdown").innerHTML=Math.round(M/1e3),document.getElementById("waitteam").style.visibility="visible",dRest("team"),h=setTimeout(function(){clearTimeout(b);var e="";isBattle&&(e="battle"),m(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return l(t),!0})},1e3*document.getElementById("teamcountdown").innerHTML),S(!0),c.style.display="block",p.style.display="block";else{y.style.visibility="hidden",(C=document.createElement("div")).style.position="absolute",C.style.left=6*iScreenScale+"px",C.style.top=12*iScreenScale+"px",C.style.fontSize=Math.round(2.5*iScreenScale)+"px",C.style.color="#DFC",C.innerHTML=language?" &nbsp; Teams are being selected... Please don't leave the game":"Les √©quipes sont en cours de s√©lection... Ne pas quitter la partie.",y.appendChild(C);var P=41,k=document.createElement("div");k.style.position="absolute",k.style.left="0px",k.style.top=19*iScreenScale+"px",k.style.width=iScreenScale*P*2+"px",k.style.height=Math.round(8.5*iScreenScale)+"px",k.style.overflow="hidden";for(o=0;o<P;o++){var I=document.createElement("img");I.src="images/cLoading.png",I.className="pixelated",I.style.width=2*iScreenScale+"px",I.style.position="absolute",I.style.left=o*iScreenScale*2+"px",I.style.top="0px",I.style.opacity=.5,k.appendChild(I)}y.appendChild(k);var w=0;function L(){xhr("getTeams.php",onlineSpectatorId?"spectator="+onlineSpectatorId:"",function(e){if(y.style.visibility="",!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}switch(t.state){case"selecting_teams":!function(){for(var e=k.getElementsByTagName("img"),t=(new Date).getTime(),n=Math.round(P*Math.min((t-x)/M,1));w<n;)e[w].style.opacity=1,w++}(),setTimeout(L,1e3);break;case"teams_selected":y.removeChild(C),y.removeChild(k),l(t);break;default:y.removeChild(C),y.removeChild(k),d()}return!0})}L()}onlineSpectatorState&&(y.style.opacity=0,setTimeout(function(){y.style.opacity=""},1e3)),oContainers[0].appendChild(y)}function iDeco(){var e=document.createElement("div");e.style.position="absolute",e.style.left=15*iScreenScale+"px",e.style.top=8*iScreenScale+"px",e.style.width=50*iScreenScale+"px",e.style.height=15*iScreenScale+"px",e.style.fontSize=3*iScreenScale+"px",e.style.backgroundColor="gray",e.style.color="white",e.style.border="solid 1px silver",e.style.fontWeight="bold",e.style.textAlign="center",e.style.paddingTop=5*iScreenScale+"px",e.style.zIndex=2e4,e.innerHTML=toLanguage("You have been disconnected","Vous avez &eacute;t&eacute; d&eacute;connect&eacute;");for(var t=0;t<2;t++)e.appendChild(document.createElement("br"));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=3*iScreenScale+"px",n.onclick=function(){location.reload()},e.appendChild(n),$mkScreen.appendChild(e),chatting=!1,hideSpectatorLink();var a=document.getElementById("waitrace");a&&(a.style.visibility="hidden"),window.onbeforeunload=void 0,n.focus()}var dRestHandlers={},pollingGamepadsHandler;function dRest(e){if(e=e||"race",isOnline){var t=document.getElementById(e+"countdown").innerHTML-1;if((document.getElementById(e+"countdown").innerHTML=t)&&"visible"==document.getElementById("wait"+e).style.visibility)return void(dRestHandlers[e]||(dRestHandlers[e]=setInterval(function(){dRest(e)},1e3)))}dRestHandlers[e]&&(clearTimeout(dRestHandlers[e]),delete dRestHandlers[e])}function setSRest(e){var t,n;e=e||"race",isOnline&&((n=document.getElementById("wait"+e))||(t={race:toLanguage('There are <strong id="racecountdown">30</strong> seconds left to choose the next race','Il vous reste <span id="racecountdown">30</span> secondes pour choisir la prochaine course'),team:toLanguage('There are <strong id="teamcountdown">10</strong> seconds left to choose the teams','Il vous reste <span id="teamcountdown">10</span> secondes pour choisir les √©quipes')},(n=document.createElement("div")).id="wait"+e,n.className="wait",n.innerHTML=t[e],document.getElementById("mariokartcontainer").appendChild(n)),n.style.left=2*iScreenScale+10+"px",n.style.top=35*iScreenScale+10+"px",n.style.minWidth=iScreenScale*(iWidth-4)+"px",n.style.fontSize=3*iScreenScale+"px")}function showSpectatorLink(t){hideSpectatorLink();var e=document.createElement("div");e.id="spectatormode",e.style.left=2*iScreenScale+10+"px",e.style.top=38*iScreenScale+15+"px",e.style.width=iScreenScale*(iWidth-4)+"px",e.style.fontSize=Math.round(2.25*iScreenScale)+"px";var n=document.createElement("img");n.src="images/ic_spectator.png",n.alt="Toggle",n.style.height=Math.round(1.75*iScreenScale)+"px",n.style.marginRight=Math.round(iScreenScale/4)+"px",e.appendChild(n);var n=document.createElement("a"),a=!(n.href="#null");t.toggled?(n.innerHTML=toLanguage("Exit spectator mode","Quitter le mode spectateur"),n.onclick=function(e){e.preventDefault(),a||(a=!0,t.click(),xhr("getCourse.php",getOnlineCourseParams({spectator:onlineSpectatorId}),function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}return e.found?(clearRaceWheenScreen(),setSpectatorId(void 0),handleMatchmakingSuccess(e)):(choose(),hideSpectatorLink(),showExitSpectatorFailMessage()),!0}))}):(n.title=toLanguage("You'll see games but not play on it","Vous verrez les parties mais ne jouerez pas dedans"),n.innerHTML=toLanguage("Switch to spectator mode","Passer en mode spectateur"),n.onclick=function(e){e.preventDefault(),a||(a=!0,t.click(),xhr("spectatorMode.php","",function(e){return 0<e?(setSpectatorId(+e),a=!1,choose()):iDeco(),!0}))}),e.appendChild(n),document.getElementById("mariokartcontainer").appendChild(e)}function hideSpectatorLink(){var e=document.getElementById("spectatormode");e&&document.getElementById("mariokartcontainer").removeChild(e)}function handleSpectatorLink(e){if(onlineSpectatorId)return e(),document.getElementById("waitrace").style.visibility="hidden",void xhr("spectatorMode.php","spectator="+onlineSpectatorId+(onlineSpectatorState?"&state="+onlineSpectatorState:""),function(e){return choose(),!0});showSpectatorLink({click:e})}function showExitSpectatorFailMessage(){var t=document.createElement("div");t.style.position="absolute",t.style.left=10+2*iScreenScale+"px",t.style.width=(iWidth-4)*iScreenScale+"px",t.style.top=38*iScreenScale+15+"px",t.style.fontSize=2*iScreenScale+"px",t.style.textAlign="center";var e=document.createElement("div");e.style.color="#dc7",e.style.backgroundColor="#430",e.style.display="inline-block",e.style.padding=Math.round(.5*iScreenScale)+" "+iScreenScale+"px",e.style.borderRadius=iScreenScale+"px",e.innerHTML=toLanguage("Sorry, it's too late to join the race","D√©sol√©, il est trop tard pour rejoindre la course"),t.appendChild(e),document.body.appendChild(t);var n=1;setTimeout(function e(){(n-=.05)<=0?document.body.removeChild(t):(t.style.opacity=n,setTimeout(e,100))},1500)}function connexion(){var t,n=document.createElement("div"),e=n.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",n.appendChild(toTitle(toLanguage("Connection","Connexion"),-.5));var a=document.createElement("form");a.style.position="absolute",a.style.left=16*iScreenScale+"px",a.style.top=10*iScreenScale+"px",a.onsubmit=function(){return p.style.visibility="hidden",t.disabled=!0,xhr("testcode.php","pseudo="+s.value+"&code="+c.value,function(e){if(!e||isNaN(e))return!1;e=+e;return e?(mId=identifiant=e,mPseudo=s.value,mCode=c.value,n.innerHTML="",oContainers[0].removeChild(n),selectPlayerScreen(0)):(p.style.visibility="visible",t.disabled=!1),!0}),!1};var o=document.createElement("table");o.border=2,o.setAttribute("cellpadding",1),o.setAttribute("cellspacing",2);var i=document.createElement("tr"),r=document.createElement("td");r.style.textAlign="right";var l=document.createElement("label");l.style.fontSize=3*iScreenScale+"px",l.setAttribute("for","iPseudo"),l.innerHTML=toLanguage("&nbsp; Username:","&nbsp; Pseudo :"),r.appendChild(l);var s,e=document.createElement("td");(s=document.createElement("input")).type="text",s.name="iPseudo",s.id="iPseudo",s.value=mPseudo,s.style.fontSize=3*iScreenScale+"px",s.style.backgroundColor="#FE7",e.appendChild(s),i.appendChild(r),i.appendChild(e);l=document.createElement("tr"),r=document.createElement("td");r.style.textAlign="right";e=document.createElement("label");e.style.fontSize=3*iScreenScale+"px",e.setAttribute("for","iCode"),e.innerHTML=toLanguage("Password:","Code :"),r.appendChild(e);var c,e=document.createElement("td");(c=document.createElement("input")).type="password",c.name="iCode",c.id="iCode",c.value=mCode,c.style.fontSize=3*iScreenScale+"px",c.style.backgroundColor="#FE7",e.appendChild(c),l.appendChild(r),l.appendChild(e);r=document.createElement("tr"),e=document.createElement("td");e.setAttribute("colspan",2),e.style.textAlign="center",(t=document.createElement("input")).type="submit",t.style.fontSize=4*iScreenScale+"px",t.value=toLanguage("Submit","Valider"),e.appendChild(t),r.appendChild(e),o.appendChild(i),o.appendChild(l),o.appendChild(r),a.appendChild(o),n.appendChild(a);var p=document.createElement("div");p.style.color="red",p.style.fontSize=2*iScreenScale+"pt",p.style.position="absolute",p.style.left=21*iScreenScale+"px",p.style.top=31*iScreenScale+"px",p.innerHTML=toLanguage("Incorrect username or password","Pseudo ou mot de passe incorrect"),p.style.visibility="hidden",n.appendChild(p);a=document.createElement("a");a.style.color="white",a.style.fontSize=2*iScreenScale+"pt",a.style.position="absolute",a.style.left=20*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.innerHTML=toLanguage("Register","Inscription"),a.setAttribute("href","inscription.php"+("BB"==course?"?battle":"")),n.appendChild(a);a=document.createElement("a");a.style.color="white",a.style.fontSize=2*iScreenScale+"pt",a.style.position="absolute",a.style.left=45*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.innerHTML=toLanguage("Rankings","Classement"),a.setAttribute("href","bestscores.php"+("BB"==course?"?battle":"")),n.appendChild(a);a=document.createElement("input");a.type="button",a.value=toLanguage("Back","Retour"),a.style.fontSize=2*iScreenScale+"px",a.style.position="absolute",a.style.left=2*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.onclick=quitter,n.appendChild(a),oContainers[0].appendChild(n),updateMenuMusic(0)}function loadGhostScreen(map){var oMap=oMaps[map];if(!isChallengeTtCompatible())return gPersos.length=0,void resetGame(aAvailableMaps[oMap.ref-1]);document.body.style.cursor="progress",xhr("ghostsave.php","map="+getCreationId(oMap)+"&type="+getCreationTable()+"&cc="+getActualCc(),function(reponse){var ghostSaves;try{ghostSaves=eval(reponse)}catch(e){return!1}return selectFantomeScreen(ghostSaves||void 0,oMap.ref-1),!0})}function selectFantomeScreen(ghostsData,map,otherGhostsData){var oScr=document.createElement("div"),oStyle=oScr.style;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black";var oTitle=toTitle(lCircuits[map],.5);oTitle.style.fontSize=Math.round(7*iScreenScale)+"px",oTitle.style.left=2*iScreenScale+"px",oTitle.style.width=iScreenScale*(iWidth-2)+"px",oTitle.style.whiteSpace="nowrap",oTitle.style.overflow="hidden",oTitle.style.textOverflow="ellipsis",oScr.appendChild(oTitle);var oTable=document.createElement("table");oTable.setAttribute("border","4px"),oTable.style.borderStyle="double",oTable.style.borderColor="gray",oTable.style.height=8*iScreenScale+"px",oTable.style.position="absolute",oTable.style.left=22*iScreenScale+"px",oTable.style.top=10*iScreenScale+"px",oTable.style.width=35*iScreenScale+"px";var oGhost=document.createElement("tr"),oPersoImage=document.createElement("td");oPersoImage.style.width=5*iScreenScale+"px",oPersoImage.style.paddingRight="6px";var cDiv=document.createElement("div");cDiv.style.textAlign="center";var oDiv=document.createElement("div");oDiv.style.position="relative",oDiv.style.width=5*iScreenScale+"px",oDiv.style.height=5*iScreenScale+"px",oDiv.style.marginLeft="auto",oDiv.style.marginRight="auto",oDiv.style.overflow="hidden";var oPImg=new Image;oPImg.style.height=5*iScreenScale+"px",oPImg.style.position="absolute",oPImg.className="pixelated",ghostsData&&(oPImg.alt=ghostsData[1]),oPImg.nb=i,oPImg.style.left=-30*iScreenScale+"px",oPImg.onload=function(){var e=this.scrollWidth/24;this.parentNode.style.width=Math.round(e)+"px",this.style.left=-Math.round(6*e)+"px"},oPImg.style.top="0px",oDiv.appendChild(oPImg),cDiv.appendChild(oDiv);var oSpan=document.createElement("span");oSpan.style.display="inline-block",oSpan.style.color="white",oSpan.style.minWidth=10*iScreenScale+"px",oSpan.style.maxWidth=Math.round(13.5*iScreenScale)+"px",oSpan.style.fontSize=Math.round(1.8*iScreenScale)+"px",oSpan.style.overflow="hidden",oSpan.style.textOverflow="ellipsis",oSpan.style.whiteSpace="nowrap",cDiv.appendChild(oSpan),oPersoImage.appendChild(cDiv),oGhost.appendChild(oPersoImage);var oTimeTd=document.createElement("td");oTimeTd.style.textAlign="center",oTimeTd.style.whiteSpace="nowrap";var oPersoTime=document.createElement("span");oPersoTime.style.fontSize=Math.round(5.5*iScreenScale)+"px",oPersoTime.style.color="white",oPersoTime.style.marginLeft=2*iScreenScale+"px",oTimeTd.appendChild(oPersoTime);var oPersoLapTimes=document.createElement("img"),$fancyTitle,gTimes;function writeTime(e,t,n,a,o,i){if(i=i||oPersoTime,(o=o||oPImg).src=getSpriteSrc(e),i.innerHTML=timeStr(n),oSpan.innerText=t,oSpan.title=t,oTable.style.left=Math.round((iScreenScale*iWidth+20-oTable.offsetWidth)/2)+"px",oTable.style.top=Math.round((28*iScreenScale-oTable.offsetHeight)/2)+"px",i==oPersoTime){for(var r='<small style="color:#CCF">'+toLanguage("Lap times:","Temps au tour :")+"</small>",l=0;l<a.length;l++)r+='<br /><span style="color:#CCF;display:inline-block">'+(l+1)+".</span> "+timeStr(a[l]);oPersoLapTimes.dataset.title=r}}function multiGhosts(a){oScr.innerHTML="";var e=gID-3,t=gID+4;e<0?t-=e:t>a.length&&(e-=t-a.length),e=Math.max(e,0),t=Math.min(t,a.length),(gIDs=new Array).length=t-e;for(var n=0,o=e;o<t;o++){gIDs[n]=o;var i=document.createElement("div");i.className="igScr",i.style.position="absolute",i.style.left=e+6<=o?20*iScreenScale+"px":n%2*iScreenScale*40+"px",i.style.top=(1+7*Math.floor(n/2))*iScreenScale+"px",i.style.width=40*iScreenScale+"px";var r=document.createElement("table");r.setAttribute("border","2px"),r.style.marginLeft="auto",r.style.marginRight="auto",r.style.borderStyle="double",r.style.borderColor="gray",r.style.width=24*iScreenScale+"px",r.style.height=4*iScreenScale+"px";var l=document.createElement("tr"),s=document.createElement("td");s.style.width=3*iScreenScale+"px",s.style.paddingRight="5px";var c=document.createElement("div");c.style.position="relative",c.style.width=3*iScreenScale+"px",c.style.height=3*iScreenScale+"px",c.style.margin="0px auto",c.style.overflow="hidden";var p=new Image;p.style.height=3*iScreenScale+"px",p.onload=function(){var e=this.scrollWidth/24;this.parentNode.style.width=Math.round(e)+"px",this.style.left=-Math.round(6*e)+"px"},p.style.position="absolute",p.className="pixelated",ghostsData&&(p.alt=ghostsData[1]),p.nb=o,p.style.left=-18*iScreenScale+"px",p.style.top="0px",c.appendChild(p),s.appendChild(c),l.appendChild(s);s=document.createElement("td");s.style.textAlign="center",s.style.fontSize=Math.round(3.5*iScreenScale)+"px",s.style.color="white",writeTime(a[gIDs[n]][1],a[gIDs[n]][2],a[gIDs[n]][3],a[gIDs[n]][4],p,s);var u=document.createElement("input");u.type="button",u.value="‚Üê",u.style.fontSize=4*iScreenScale+"px",u.style.position="absolute",u.style.left=Math.round(2.5*iScreenScale-8)+"px",u.style.top=Math.round(.25*iScreenScale)+"px",function(e,t,n){u.onclick=function(){gIDs[e]--,gIDs[e]<0&&(gIDs[e]=a.length-1),writeTime(a[gIDs[e]][1],a[gIDs[e]][2],a[gIDs[e]][3],a[gIDs[e]][4],t,n)}}(n,p,s),i.appendChild(u);var d=document.createElement("input");d.type="button",d.value="‚Üí",d.style.fontSize=4*iScreenScale+"px",d.style.position="absolute",d.style.left=32.5*iScreenScale+"px",d.style.top=Math.round(.25*iScreenScale)+"px",function(e,t,n){d.onclick=function(){gIDs[e]++,gIDs[e]>=a.length&&(gIDs[e]=0),writeTime(a[gIDs[e]][1],a[gIDs[e]][2],a[gIDs[e]][3],a[gIDs[e]][4],t,n)}}(n,p,s),i.appendChild(d),l.appendChild(s),r.appendChild(l),i.appendChild(r),oScr.appendChild(i),n++}var m=gIDs.length,h=document.createElement("div");h.style.textAlign="center",h.style.position="absolute",h.style.left=2*iScreenScale+"px",h.style.top=29*iScreenScale+"px",h.style.width=76*iScreenScale+"px",h.style.color="white";var g=document.createElement("span");g.style.fontSize=Math.round(2.5*iScreenScale)+"px",g.innerHTML=toLanguage("Number of ghosts:","Nombre de fant√¥mes :"),g.style.marginRight=Math.round(1.2*iScreenScale)+"px",h.appendChild(g);var y=document.createElement("input");y.type="button",y.value="-",y.style.fontSize=3*iScreenScale+"px",y.onclick=function(){m--,oScr.querySelectorAll(".igScr")[m].style.visibility="hidden",b()};var f=document.createElement("span");f.style.fontSize=Math.round(2.5*iScreenScale)+"px",f.style.marginLeft=f.style.marginRight=Math.round(1.5*iScreenScale)+"px";var S=document.createElement("input");S.type="button",S.value="+",S.onclick=function(){oScr.querySelectorAll(".igScr")[m].style.visibility="visible",m++,b()},y.className=S.className="disablable",y.style.borderRadius=S.style.borderRadius="50%",y.style.fontSize=y.style.lineHeight=S.style.fontSize=S.style.lineHeight=3*iScreenScale+"px",y.style.width=y.style.height=S.style.width=S.style.height=4*iScreenScale+"px",h.appendChild(y),h.appendChild(f),h.appendChild(S),oScr.appendChild(h);h=document.createElement("input");h.type="button",h.value=toLanguage("Back","Retour"),h.style.fontSize=2*iScreenScale+"px",h.style.position="absolute",h.style.left=2*iScreenScale+"px",h.style.top=36*iScreenScale+"px",h.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),selectFantomeScreen(ghostsData,map,{times:a,id:gID})},oScr.appendChild(h);var v=document.createElement("input");function b(){f.innerHTML=m,v.value=toLanguage("Face with "+m+" ghost"+(1<m?"s":""),"Affronter "+m+" fant√¥me"+(1<m?"s":"")),y.disabled=m<=1,S.disabled=m>=gIDs.length}v.type="button",b(),v.style.fontSize=Math.round(2.5*iScreenScale)+"px",v.style.position="absolute",v.style.right=5*iScreenScale-10+"px",v.style.top=35*iScreenScale+"px",v.onclick=function(){gIDs.length=m,seeGhost(!1)},oScr.appendChild(v);h=document.createElement("input");h.type="button",h.value=toLanguage("See race","Voir la course"),h.style.fontSize=Math.round(2.5*iScreenScale)+"px",h.style.position="absolute",h.style.right=33*iScreenScale-10+"px",h.style.top=35*iScreenScale+"px",h.onclick=function(){gIDs.length=m,seeGhost(!0)},oScr.appendChild(h)}function showGhosts(){if(gTimes.length){for(i=0;i<gTimes.length-1;i++){var e=i;for(j=i+1;j<gTimes.length;j++)gTimes[j][3]<gTimes[e][3]&&(e=j);var t=gTimes[e];gTimes[e]=gTimes[i],gTimes[i]=t}if(-1==gID)if(ghostsData){for(gID=gTimes.length-1;gID&&gTimes[gID][3]>=ghostsData[3];)gID--;!gID&&1<gTimes.length&&gTimes[gID][0]===ghostsData[0]&&gID++}else gID=0;var n=Math.round(11.5*iScreenScale),a=Math.round(5*iScreenScale),o=document.createElement("input");o.id="fGauche",o.type="button",o.value="‚Üê",o.style.fontSize=4*iScreenScale+"px",o.style.position="absolute",o.style.left=13*iScreenScale+"px",o.style.top=n+"px",o.style.height=a+"px",o.onclick=function(){for(var e=0;e<2&&(--gID<0&&(gID=gTimes.length-1),ghostsData)&&gTimes[gID][0]===ghostsData[0];e++);writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(o);o=document.createElement("input");o.id="ffGauche",o.type="button",o.value="‚èÆ",o.style.fontSize=4*iScreenScale+"px",o.style.position="absolute",o.style.left=5*iScreenScale+"px",o.style.top=n+"px",o.style.height=a+"px",o.onclick=function(){writeTime(gTimes[gID=0][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(o);o=document.createElement("input");o.id="fDroite",o.type="button",o.value="‚Üí",o.style.fontSize=4*iScreenScale+"px",o.style.position="absolute",o.style.left=64*iScreenScale+"px",o.style.top=n+"px",o.style.height=a+"px",o.onclick=function(){for(var e=0;e<2&&(++gID>=gTimes.length&&(gID=0),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4]),ghostsData)&&gTimes[gID][0]===ghostsData[0];e++);},oScr.appendChild(o);var r,o=document.createElement("input");o.id="ffDroite",o.type="button",o.value="‚è≠",o.style.fontSize=4*iScreenScale+"px",o.style.position="absolute",o.style.left=72*iScreenScale+"px",o.style.top=n+"px",o.style.height=a+"px",o.onclick=function(){gID=gTimes.length-1,writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(o),ghostsData?oScr.style.visibility="visible":oContainers[0].appendChild(oScr),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4]),OPFace&&(OPFace.style.display="none"),document.body.style.cursor="default",(OPFace7=document.createElement("input")).type="button",OPFace7.value=toLanguage("7 ghosts...","7 fant√¥mes..."),OPFace7.style.fontSize=2*iScreenScale+"px",OPFace7.style.position="absolute",OPFace7.style.right=2*iScreenScale+"px",OPFace7.style.top=36*iScreenScale+"px",OPFace7.onmouseover=function(){r||((r=document.createElement("div")).style.position="absolute",r.style.textAlign="center",r.style.fontSize=2*iScreenScale+"px",r.style.width=30*iScreenScale+"px",r.style.right=2*iScreenScale+"px",r.style.bottom=4*iScreenScale+"px",r.style.backgroundColor="rgba(204,192,178,0.95)",r.style.padding=Math.round(iScreenScale/2)+" "+iScreenScale+"px",r.style.color="#363330",r.innerHTML=toLanguage("Play with 7 ghosts with the same level as the ghost above","Affronter 7 fant√¥mes du m√™me niveau que le fant√¥me ci-dessus"),r.style.borderBottomLeftRadius=iScreenScale+"px",r.style.borderTopRightRadius=iScreenScale+"px",oScr.appendChild(r))},OPFace7.onmouseout=function(){r&&(oScr.removeChild(r),r=null)},OPFace7.onclick=function(){r&&(oScr.removeChild(r),r=null),multiGhosts(gTimes)},oScr.appendChild(OPFace7)}else if(ghostsData)alert(language?"No other record for this circuit yet":"Aucun autre record pour ce circuit"),oScr.style.visibility="visible",gID=-1,document.body.style.cursor="default";else{oScr.innerHTML="";try{oContainers[0].removeChild(oScr)}catch(e){}document.body.style.cursor="default",gPersos.length=0,resetGame(aAvailableMaps[map])}}function otherGhosts(){document.body.style.cursor="progress",ghostsData&&(oScr.style.visibility="hidden"),xhr("otherghosts.php","map="+getCreationId(oMaps[aAvailableMaps[map]])+"&type="+getCreationTable()+"&cc="+getActualCc(),function(reponse){if(reponse){try{gTimes=eval(reponse)}catch(e){return!1}return showGhosts(),!0}return!1})}function seeGhost(replay){if(replay&&(pause=!0,fInfos.replay=!0,gSelectedPerso=strPlayer[0]),-1==gID)oScr.innerHTML="",oContainers[0].removeChild(oScr),gOverwriteRecord=1,replay?(strPlayer[0]=ghostsData[1],iRecord=ghostsData[3],iLapTimes=ghostsData[4],iTrajet=ghostsData[5]):(gPersos=[ghostsData[1]],iLapTimes=ghostsData[4],jTrajets=[ghostsData[5]]),resetGame(aAvailableMaps[map]);else{var xhrUrl,xhrData;if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.style.cursor="progress",gIDs){xhrUrl="ghostsrace.php",xhrData="";for(var i=0;i<gIDs.length;i++)i&&(xhrData+="&"),xhrData+="id"+i+"="+gTimes[gIDs[i]][0]}else xhrUrl="ghostrace.php",xhrData="id="+gTimes[gID][0];xhr(xhrUrl,xhrData,function(reponse){if(reponse){var gCourse;try{gCourse=eval(reponse)}catch(e){return!1}if(gIDs){replay&&(strPlayer[0]=gTimes[gIDs[0]][1],iRecord=gTimes[gIDs[0]][3],iLapTimes=gTimes[gIDs[0]][4],iTrajet=gCourse[0]),gPersos=[];for(var i=0;i<gIDs.length;i++)gPersos.push(gTimes[gIDs[i]][1]);jTrajets=gCourse}else replay?(strPlayer[0]=gTimes[gID][1],iRecord=gTimes[gID][3],iLapTimes=gTimes[gID][4],iTrajet=gCourse):(gPersos=[gTimes[gID][1]],iLapTimes=gTimes[gID][4],jTrajets=[gCourse]);return resetGame(aAvailableMaps[map]),!0}return!1})}}oPersoLapTimes.src="images/about.png",oPersoLapTimes.style.position="relative",oPersoLapTimes.style.top=-Math.round(.5*iScreenScale)+"px",oPersoLapTimes.style.width=Math.round(2.5*iScreenScale)+"px",oPersoLapTimes.style.marginLeft=iScreenScale+"px",oPersoLapTimes.style.marginRight=2*iScreenScale+"px",oPersoLapTimes.dataset||(oPersoLapTimes.dataset={}),oTimeTd.appendChild(oPersoLapTimes),oPersoLapTimes.onmouseover=function(e){var t;$fancyTitle||(($fancyTitle=document.createElement("div")).className="ranking_activeplayertitle",$fancyTitle.innerHTML=this.dataset.title,$fancyTitle.style.position="absolute",$fancyTitle.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",$fancyTitle.style.borderRadius=iScreenScale+"px",$fancyTitle.style.zIndex=10,$fancyTitle.style.backgroundColor="rgba(60,109,165, 0.95)",$fancyTitle.style.color="white",$fancyTitle.style.fontSize=Math.round(1.8*iScreenScale)+"px",$fancyTitle.style.lineHeight=Math.round(2*iScreenScale)+"px",$fancyTitle.style.visibility="hidden",$mkScreen.appendChild($fancyTitle),t=this.getBoundingClientRect(),$fancyTitle.style.left=Math.round(t.left+(this.scrollWidth-$fancyTitle.scrollWidth)/2)+"px",$fancyTitle.style.top=t.top+this.scrollHeight+5+"px",$fancyTitle.style.visibility="visible")},oPersoLapTimes.onmouseout=function(){$fancyTitle&&($mkScreen.removeChild($fancyTitle),$fancyTitle=void 0)},gRecord=ghostsData?ghostsData[3]:void 0;var gID=-1,gIDs;oGhost.appendChild(oTimeTd),oTable.appendChild(oGhost),oScr.appendChild(oTable);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Face with this ghost","Affronter ce fant√¥me"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=20*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!1)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("See race","Voir la course"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=25*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!0)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Play alone","Jouer seul"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=30*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),gPersos.length=0,resetGame(aAvailableMaps[map])},oScr.appendChild(oPInput);var oPInput=document.createElement("input"),OPFace,OPFace7,OPFace;oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=36*iScreenScale+"px",oPInput.onclick=function(){-1!=gID&&ghostsData?(writeTime(ghostsData[1],ghostsData[2],ghostsData[3],ghostsData[4]),oScr.removeChild(document.getElementById("fGauche")),oScr.removeChild(document.getElementById("ffGauche")),oScr.removeChild(document.getElementById("fDroite")),oScr.removeChild(document.getElementById("ffDroite")),oScr.removeChild(OPFace7),OPFace.style.display="",gID=-1):(oScr.innerHTML="",oContainers[0].removeChild(oScr),isSingle?selectPlayerScreen(0):selectRaceScreen(map-map%4))},oScr.appendChild(oPInput),ghostsData?(OPFace=document.createElement("input"),OPFace.type="button",OPFace.value=toLanguage("Face with another player...","Affronter un autre joueur..."),OPFace.style.fontSize=2*iScreenScale+"px",OPFace.style.position="absolute",OPFace.style.right=2*iScreenScale+"px",OPFace.style.top=36*iScreenScale+"px",OPFace.onclick=otherGhosts,oScr.appendChild(OPFace),oContainers[0].appendChild(oScr),ghostsData&&writeTime(ghostsData[1],ghostsData[2],ghostsData[3],ghostsData[4]),document.body.style.cursor="default",otherGhostsData&&(gID=otherGhostsData.id,gTimes=otherGhostsData.times,showGhosts())):otherGhosts(),updateMenuMusic(1)}function isChallengeTtCompatible(){return!clSelected||challengeRules[clSelected.data.goal.type].is_tt_compatible}function escapeSpecialChars(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function stripSpecialChars(e){return e.replace(/&[#\w]+;/g,"_").replace(/<\w+>(.+?)<\/\w+>/g,"$1")}function mapNameOf(e,t){var n=document.createElement("div"),a=isCup?Math.min(Math.max(9/Math.sqrt(stripSpecialChars(lCircuits[t]).length),1.4),4):2.1;n.style.fontSize=Math.round(e*a)+"px",n.className="mapname",n.style.textAlign="center",n.innerHTML=dCircuits[t];t=n.querySelector("small");return t&&(t.style.fontSize=2*iScreenScale+"px"),n}function addOption(e,t,n,a,o,i){document.getElementById(e).innerHTML=t.replace(/ /g,"&nbsp;"),document.getElementById(n).innerHTML="";var r,l=document.createElement("select");l.name=a;for(var s=0;s<o.length;s++){var c=document.createElement("option"),p=o[s][0];c.value=p,c.innerHTML=o[s][1],p==i&&(r=s),l.appendChild(c)}l.selectedIndex=r,document.getElementById(n).appendChild(l)}function optionOf(e){return formulaire?+formulaire.elements[e].value:baseOptions[e]}function displayCommands(e){var t=document.getElementById("commandes");if(t){if(isMobile()){if(document.getElementById("commandes-edit"))return;e=""}var n=!e;t.innerHTML=(n?"":'<div class="commandes-list">'+e+"</div>")+'<img src="images/edit-controls.png" alt="Edit" id="commandes-edit"'+(n?' class="nocommand"':"")+' title="'+toLanguage("More settings","Plus de param√®tres")+'" />',document.getElementById("commandes-edit").onclick=function(){editCommands()}}}function updateCommandSheet(){var n=getCommands(null,2),a=navigator.platform&&0<=navigator.platform.toUpperCase().indexOf("MAC");function e(e,t){var n=language?"P":"J";return 1==oContainers.length?e:n+"1 : "+e+"; "+n+"2 : "+t}function t(e){var t=n[e],e=t[0];return t[1]&&a&&(e=t[1]),getKeyName(e)}displayCommands("<strong>"+toLanguage("Move","Se diriger")+"</strong> : "+e(t("up")+t("left")+t("down")+t("right"),t("up_p2")+t("left_p2")+t("down_p2")+t("right_p2"))+'<br /><span style="line-height:13px"><strong>'+toLanguage("Use item","Utiliser un objet")+"</strong> : "+e(t("item"),t("item_p2"))+"<br /><strong>"+toLanguage("Item backwards","Objet en arri√®re")+"</strong> : "+e(t("item_back"),t("item_back_p2"))+"<br />"+("BB"==course?"":"<strong>"+toLanguage("Item forwards","Objet en avant")+"</strong> : "+e(t("item_fwd"),t("item_fwd_p2"))+"</span><br />")+"<strong>"+toLanguage("Jump/drift","Sauter/d√©raper")+"</strong> : "+e(t("jump"),t("jump_p2"))+("BB"==course?"<br /><strong>"+toLanguage("Inflate a balloon","Gonfler un ballon")+"</strong> : "+e(t("balloon"),t("balloon_p2")):"")+"<br /><strong>"+toLanguage("Rear/Front view","Vue arri&egrave;re/avant")+"</strong> : "+e(t("rear"),t("rear_p2"))+"<br /><strong>"+toLanguage("Pause","Mettre en pause")+"</strong> : "+t("pause")+"<br /><strong>"+toLanguage("Quit","Quitter")+"</strong> : "+t("quit"))}function editCommands(a){clearInterval(pollingGamepadsHandler);var e=!!a,n=(a=a||{}).currentTab||0,d=a.selectedPlayer||0,m=a.selectedDevice||"keyboard",t=d+1,o=document.getElementById("control-editor-mask");if(!o||(document.body.removeChild(o),e)){(o=document.createElement("div")).id="control-editor-mask",o.onclick=function(){editCommands()};var i=document.createElement("div");i.className="control-editor",i.onclick=function(e){e.stopPropagation()};var r=document.createElement("div");r.className="control-header";e=document.createElement("div");e.innerHTML=toLanguage("Game settings","Param√®tres du jeu"),r.appendChild(e);e=document.createElement("button");e.className="control-close",e.innerHTML="&times;",e.onclick=function(){editCommands()},r.appendChild(e),i.appendChild(r);var l=document.createElement("div");l.className="control-tabs";for(var s=[toLanguage("Edit controls","Modifier les contr√¥les"),toLanguage("Advanced settings","Param√®tres avanc√©s")],c=0;c<s.length;c++)!function(e){var t=document.createElement("div");e||(t.className="control-tab-active"),t.innerHTML=s[e],t.onclick=function(){document.querySelector(".control-tabs .control-tab-active").classList.remove("control-tab-active"),this.classList.add("control-tab-active"),document.querySelector(".control-window .control-window-active").classList.remove("control-window-active"),document.querySelectorAll(".control-window > div")[e].classList.add("control-window-active"),n=e,a.currentTab=n},l.appendChild(t)}(c);i.appendChild(l);e=document.createElement("div");e.className="control-window";r=document.createElement("div");if(r.className="control-window-active",!a.pc&&isMobile()){var p=(p=localStorage.getItem("settings.ctrl"))?JSON.parse(p):{},u=document.createElement("div");u.className="control-main-title",u.innerHTML=toLanguage("Command interface","Interface de commandes"),r.appendChild(u);var h=document.createElement("div");h.className="control-type-values";for(var g=[{id:"keyboard",name:toLanguage("Virtual Keyboard","Clavier virtuel"),description:toLanguage("Shows buttons that behave like keys in a keyboard","Affiche des boutons pour simuler les touches d'un clavier"),dropdown:function(e){var t=document.createElement("label"),n=document.createElement("span");n.innerHTML=toLanguage("Keyboard layout:","Disposition des touches :"),t.appendChild(n);var a,o=document.createElement("select"),i={"":toLanguage("Default","Par d√©faut"),h_sym:toLanguage("Horizontal symmetry","Sym√©trie horizontale"),v_sym:toLanguage("Vertical symmetry","Sym√©trie verticale"),vh_sym:toLanguage("Both symmetries","Sym√©trie mixte"),old:toLanguage("Old version","Ancienne version")},r=p.layout||"";for(a in i){var l=document.createElement("option");(l.value=a)===r&&(l.selected="selected"),l.innerHTML=i[a],o.appendChild(l)}t.appendChild(o),o.onchange=function(){this.value?p.layout=this.value:delete p.layout,localStorage.setItem("settings.ctrl",JSON.stringify(p))},e.appendChild(t)}},{id:"gestures",name:toLanguage("Touch controls","Contr√¥les tactiles"),description:toLanguage("Swipe the screen to go in the desired direction. Controls similar to Mario Kart Tour","Balayez l'√©cran pour vous diriger dans la direction souhait√©e. Contr√¥les similaires √† Mario Kart Tour"),dropdown:function(e){var t=document.createElement("a");t.className="control-touch-help",t.href="#null",t.innerHTML=toLanguage("How touch controls work...","Aide sur les contr√¥les tactiles..."),t.onclick=function(){return window.open("helpTouchCtrls.php","help","scrollbars=1, resizable=1, width=500, height=500"),!1},e.appendChild(t)}},{id:"external",name:toLanguage("External controller","Contr√¥leur externe"),description:toLanguage("Connect an external keyboard or gamepad","Connetez un clavier ou une manette externe"),dropdown:function(e){var t=document.createElement("a");t.className="control-ext-settings",t.href="#null",t.innerHTML=toLanguage("Controller settings...","Param√®tres du contr√¥lleur..."),t.onclick=function(){return a.pc=!0,editCommands(a),!1},e.appendChild(t)}}],y=p.mode||"keyboard",c=0;c<g.length;c++)!function(t){var n=document.createElement("div");n.className="control-type-value";var e=document.createElement("label"),a=document.createElement("div");a.className="control-type-input";var o=document.createElement("input");o.type="radio",o.name="control-type",a.appendChild(o),o.onclick=function(){var e;for(p.mode=t.id,localStorage.setItem("settings.ctrl",JSON.stringify(p));e=document.querySelector(".control-type-value.selected");)e.classList.remove("selected");n.classList.add("selected")},t.id===y&&o.click(),e.appendChild(a),(o=document.createElement("div")).className="control-type-explain",(a=document.createElement("div")).className="control-type-name",a.innerHTML=t.name,o.appendChild(a),(a=document.createElement("div")).className="control-type-desc",a.innerHTML=t.description,o.appendChild(a),e.appendChild(o),n.appendChild(e),(e=document.createElement("div")).className="control-type-extra",t.dropdown&&t.dropdown(e),n.appendChild(e),h.appendChild(n)}(g[c]);r.appendChild(h);var f=document.createElement("div");f.className="control-main-title",f.innerHTML=toLanguage("Other options","Autres options"),r.appendChild(f);var S=document.createElement("div");S.className="control-misc-values",[{key:"autoacc",label:toLanguage("Auto-accelerate","Acc√©l√©rer automatiquement"),defaultVal:1},{key:"vitem",label:toLanguage("Touch game screen to send an item","Toucher l'√©cran de jeu pour lancer un objet"),defaultVal:1},{key:"gyroscope",label:toLanguage("Rotate the screen to turn, like with a steering wheel","Pivotez l'√©cran pour tourner, comme avec un volant"),defaultVal:0,onCheck:function(e){e&&"DeviceOrientationEvent"in window&&DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission()}}].forEach(function(t){var e=document.createElement("label"),n=document.createElement("input");n.type="checkbox";var a=t.key;a in p?n.checked=p[a]:n.checked=t.defaultVal,e.appendChild(n);var o=document.createElement("span");o.innerHTML=t.label,e.appendChild(o),n.onclick=function(){var e=+this.checked;e===t.defaultVal?delete p[a]:p[a]=e,localStorage.setItem("settings.ctrl",JSON.stringify(p)),t.onCheck&&t.onCheck(e)},S.appendChild(e)}),r.appendChild(S),(A=document.createElement("div")).className="control-reset",(u=document.createElement("a")).href="#null",u.innerHTML=toLanguage("Reset settings","R√©tablir les param√®tres par d√©faut"),u.onclick=function(){return confirm(toLanguage("Reset settings to default?","R√©initiliser les param√®tres √† ceux par d√©faut ?"))&&(localStorage.removeItem("settings.ctrl"),editCommands(a)),!1},A.appendChild(u),r.appendChild(A)}else{f=document.createElement("div");f.className="control-command-tabs";var v=document.createElement("div");v.className="control-players";for(c=0;c<2;c++)!function(e){var t=document.createElement("a");t.href="#null",t.className="control-command-tab "+(e===d?"control-command-tab-selected":""),t.innerHTML=toLanguage("Player ","Joueur ")+(e+1),t.onclick=function(){return d===e||(a.selectedPlayer=e,editCommands(a)),!1},v.appendChild(t)}(c);f.appendChild(v);var b=document.createElement("div");b.className="control-input-devices";for(var C=[{id:"keyboard",label:toLanguage("Keyboard","Clavier")},{id:"gamepad",label:toLanguage("Gamepad","Manette")}],c=0;c<C.length;c++)!function(e){var t=document.createElement("a");t.href="#null",t.className="control-command-tab "+(e.id===m?"control-command-tab-selected":""),t.innerHTML=e.label,t.onclick=function(){return m===e.id||(a.selectedDevice=e.id,editCommands(a)),!1},b.appendChild(t)}(C[c]);f.appendChild(b),r.appendChild(f);var x=[{name:toLanguage("Move forward","Avancer"),key:"up"},{name:toLanguage("Move back","Reculer"),key:"down"},{name:toLanguage("Turn left","Tourner √† gauche"),key:"left"},{name:toLanguage("Turn right","Tourner √† droite"),key:"right"},{name:toLanguage("Use item","Utiliser un objet"),key:"item"},{name:toLanguage("Item backwards","Objet en arri√®re"),key:"item_back"},{name:toLanguage("Item forwards","Objet en avant"),key:"item_fwd"},{name:toLanguage("Jump/drift","Sauter/d√©raper"),key:"jump"},{name:toLanguage("Inflate balloon","Gonfler un ballon"),key:"balloon"},{name:toLanguage("Rear view","Vue arri√®re"),key:"rear"},{name:toLanguage("Pause","Pause"),key:"pause"},{name:toLanguage("Quit","Quitter"),key:"quit"}],M=getCommands(m,t),P="";if(d){P="_p2";for(c=0;c<x.length;c++){var k=x[c].key+P;M[k]&&(x[c].key=k)}}var I=JSON.parse(localStorage.getItem(getLocalControlKey(m))||"{}"),w=navigator.platform&&0<=navigator.platform.toUpperCase().indexOf("MAC"),L="keyboard"===m,T="gamepad"===m;if(T&&void 0===I["_id"+P]){t=document.createElement("div");t.className="control-editor-empty",t.innerHTML='<div class="control-editor-empty-title">üéÆ</div>',t.innerHTML+="<div>"+toLanguage("Connect a gamepad and press any button to continue","Connectez une manette et appuyez sur n'importe quel bouton pour continuer")+"</div>",r.appendChild(t),clearInterval(pollingGamepadsHandler),pollingGamepadsHandler=setInterval(function(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++){var n=e[t];n&&getGamepadPressedBtns(n).length&&(I["_id"+P]=n.index,I["_name"+P]=n.id,localStorage.setItem(getLocalControlKey(m),JSON.stringify(I)),refreshGameControls(),editCommands(a))}},100)}else{T&&((q=document.createElement("div")).className="control-gamepad-reset",(K=document.createElement("span")).innerHTML="<strong>"+toLanguage("Selected:","S√©l√©ctionn√© :")+"</strong> "+I["_name"+P],q.appendChild(K),(W=document.createElement("a")).href="#null",W.innerHTML=toLanguage("[Reset]","[R√©initiliser]"),W.onclick=function(){if(confirm(toLanguage("Reset controller selection?","R√©initialiser la s√©lection de la manette ?"))){delete I["_id"+P],delete I["_name"+P];for(var e=0;e<x.length;e++)delete I[x[e].key];localStorage.setItem(getLocalControlKey(m),JSON.stringify(I)),refreshGameControls(),editCommands(a)}return!1},q.appendChild(W),r.appendChild(q));var E=document.createElement("div");E.className="control-editor-grid";for(c=0;c<x.length;c++)!function(c){var e=M[c.key],p=e;L&&(p=e[0],e[1]&&w&&(p=e[1]));var t=document.createElement("div");(e=document.createElement("div")).className="control-label",e.innerHTML=c.name,t.appendChild(e);var u=document.createElement("button");u.className="control-input",u.innerHTML=getKeyName(p,m),u.onfocus=function(){var l,s;this.innerHTML="...",T&&(s=!(l={}),clearInterval(pollingGamepadsHandler),pollingGamepadsHandler=setInterval(function(){var e=findGamePadById(I,d);if(e){for(var t=getGamepadPressedBtns(e),n=0;n<t.length;n++){var a=t[n];l[a.key]=a}if(t.length)s=!0;else if(s){clearInterval(pollingGamepadsHandler);var o,i,r=[];for(o in l)switch((a=l[o]).type){case"stick":for(i||(i=[],r.push(i));i.length<a.id;)i.push(0);i[a.id]=a.value;break;case"button":r.push(a.id)}p=r,I[c.key]=p,localStorage.setItem(getLocalControlKey(m),JSON.stringify(I)),refreshGameControls(),u.blur()}}},SPF))},u.onblur=function(){clearInterval(pollingGamepadsHandler),this.innerHTML=getKeyName(p,m)},u.onclick=function(){this.focus()},"keyboard"===m&&(u.onkeydown=function(e){e.preventDefault(),e.stopPropagation(),p=e.keyCode,I[c.key]=p,localStorage.setItem(getLocalControlKey(m),JSON.stringify(I)),refreshGameControls(),this.blur()}),t.appendChild(u),E.appendChild(t)}(x[c]);r.appendChild(E),(A=document.createElement("div")).className="control-reset",(u=document.createElement("a")).href="#null",u.innerHTML=toLanguage("Reset controls","R√©tablir les contr√¥les par d√©faut"),u.onclick=function(){return confirm(toLanguage("Reset to default controls?","Confirmer la r√©initialisation des contr√¥les ?"))&&(localStorage.removeItem(getLocalControlKey(m)),refreshGameControls(),editCommands(a)),!1},A.appendChild(u),r.appendChild(A)}}e.appendChild(r);var D=document.createElement("div");D.className="control-settings",(K=document.createElement("div")).className="control-settings-info",K.innerHTML=toLanguage("Graphics settings","Param√®tres graphiques"),D.appendChild(K);var B=(B=localStorage.getItem("settings"))?JSON.parse(B):{},O={ld:toLanguage("Don't display heavy elements (trees, decors)","D√©sactiver l'affichage des √©l√©ments lourds (arbres, d√©cors)"),nogif:toLanguage("Disable animation in gif-format tracks","D√©sactiver les animations des circuits au format gif"),nowater:toLanguage("Disable water animation (Palm Shore Arena)","D√©sactiver l'animation de l'eau (DS Feuille de Palmier)"),nomap:toLanguage("Disable mini-map display","D√©sactiver l'affichage de la mini-map")};for(R in O)$(R,O[R]);(W=document.createElement("label")).style.marginLeft="5px",(q=document.createElement("span")).innerHTML=toLanguage("Quality:","Qualit√© :"),W.appendChild(q),(G=document.createElement("select")).style.width="auto",G.style.marginLeft="6px",G.onchange=function(){MarioKartControl.setQuality(+this.value)};for(var z=[[5,toLanguage("Pixelated","Pixelis√©")],[4,toLanguage("Low","Inf√©rieure")],[2,toLanguage("Medium","Moyenne")],[1,toLanguage("High","Sup√©rieure")]],c=0;c<z.length;c++){var H=z[c];(J=document.createElement("option")).value=H[0],J.innerHTML=H[1],G.appendChild(J)}localStorage.getItem("iQuality")&&(G.value=localStorage.getItem("iQuality")),W.appendChild(G),D.appendChild(W),$("spd",toLanguage("Enable speedometer","Activer le compteur de vitesse")),(K=document.createElement("div")).className="control-settings-info",K.innerHTML=toLanguage("Sound settings","Param√®tres sonores"),D.appendChild(K);var R,A,N={music:toLanguage("Music volume","Volume musique"),sfx:toLanguage("SFX volume","Volume bruitages")},_=(_=localStorage.getItem("settings.vol"))?JSON.parse(_):{};for(R in N)!function(e){var t=document.createElement("label");t.className="control-setting-range";var n=document.createElement("span");n.innerHTML=N[e],t.appendChild(n);var a=document.createElement("input");a.type="range",a.min=0,a.max=1,a.step=.05,null==(n=_[e])&&(n=1),a.value=n,t.appendChild(a);var o=document.createElement("span");o.innerHTML=Math.round(100*n)+"%",o.style.width="2em",t.appendChild(o),a.onchange=function(){_[e]=+this.value,localStorage.setItem("settings.vol",JSON.stringify(_)),o.innerHTML=Math.round(100*_[e])+"%",updateVolumeSettings(_)},D.appendChild(t)}(R);if(1<iFps){var V,r=getFrameSettings(B);function F(){V.style.display=0!=B.framerad?"block":"none"}(K=document.createElement("div")).className="control-settings-info",K.innerHTML=toLanguage("Framerate settings","Param√®tres FPS"),D.appendChild(K);var j=r.framerad||r.defaultframerad;(W=document.createElement("label")).style.display="inline-block";var K=document.createElement("input");K.type="checkbox",K.checked=0!=B.framerad,W.appendChild(K),(q=document.createElement("span")).innerHTML=toLanguage("Enable motion trail","Activer le motion trail"),W.appendChild(q),K.onclick=function(){this.checked?j?B.framerad=j:delete B.framerad:B.framerad=0,localStorage.setItem("settings",JSON.stringify(B)),F()},D.appendChild(W),(V=document.createElement("div")).className="motion-trail-settings";var W=document.createElement("label");(q=document.createElement("span")).innerHTML=toLanguage("Frame&nbsp;count:","Nb&nbsp;frames&nbsp;:"),W.appendChild(q),(G=document.createElement("select")).style.width="auto",G.style.marginLeft="6px",G.onchange=function(){B.framerad=this.value,localStorage.setItem("settings",JSON.stringify(B))};for(c=1;c<10;c++){H=z[c];(J=document.createElement("option")).value=c,J.innerHTML=c,G.appendChild(J)}G.value=j,W.appendChild(G),V.appendChild(W);W=document.createElement("label");(q=document.createElement("span")).innerHTML=toLanguage("Opacity:","Opacit√©&nbsp;:"),W.appendChild(q),(K=document.createElement("input")).type="number",K.setAttribute("step","0.01"),K.style.width="50px",K.style.marginLeft="6px",K.onchange=function(){B.frameopacity=Math.min(1,Math.max(0,this.value)),this.value=B.frameopacity,localStorage.setItem("settings",JSON.stringify(B))},K.value=r.frameopacity,W.appendChild(K),V.appendChild(W);var q,G,W=document.createElement("label");(q=document.createElement("span")).innerHTML=toLanguage("Blur:","Flou&nbsp;:"),W.appendChild(q),(K=document.createElement("input")).type="number",K.setAttribute("step","0.1"),K.style.width="42px",K.style.marginLeft="6px",K.onchange=function(){B.frameblur=Math.min(10,Math.max(0,this.value)),this.value=B.frameblur,localStorage.setItem("settings",JSON.stringify(B))},K.value=r.frameblur,W.appendChild(K),(q=document.createElement("span")).innerHTML=toLanguage("&nbsp;px","&nbsp;px"),W.appendChild(q),V.appendChild(W),D.appendChild(V),F(),(W=document.createElement("label")).style.marginLeft="5px",(q=document.createElement("span")).innerHTML=toLanguage("Interframe interpolation:","Interpolation inter-frames :"),W.appendChild(q),(G=document.createElement("select")).style.width="85px",G.style.marginLeft="6px",G.onchange=function(){B.frameint=this.value,localStorage.setItem("settings",JSON.stringify(B))};for(z=[["ease_out_linear",toLanguage("Linear &nbsp; &nbsp; &nbsp; (Smoothest)","Lin√©aire &nbsp; (Tr√®s fluide)")],["ease_out_quad",toLanguage("Quadratic (Smooth)","Quadratique (Fluide)")],["ease_out_cubic",toLanguage("Cubic &nbsp; &nbsp; &nbsp; &nbsp; (Medium)","Cubique &nbsp; &nbsp; (Moyen)")],["ease_out_quart",toLanguage("Quartic &nbsp; &nbsp; (Sharp)","Quartique &nbsp; (Saccad√©)")],["ease_out_exp",toLanguage("Exponential (Sharpest)","Exponentiel (Tr√®s saccad√©)")]],c=0;c<z.length;c++){var J,H=z[c];(J=document.createElement("option")).value=H[0],J.innerHTML=H[1],G.appendChild(J)}G.value=r.frameint,W.appendChild(G),D.appendChild(W)}(A=document.createElement("div")).className="control-reset",(u=document.createElement("a")).href="#null",u.innerHTML=toLanguage("Reset settings","R√©tablir les param√®tres par d√©faut"),u.onclick=function(){return confirm(toLanguage("Reset settings to default?","R√©initiliser les param√®tres √† ceux par d√©faut ?"))&&(localStorage.removeItem("settings"),localStorage.removeItem("settings.vol"),localStorage.removeItem("iQuality"),editCommands(a)),!1},A.appendChild(u),D.appendChild(A),e.appendChild(D),i.appendChild(e),o.appendChild(i),document.body.appendChild(o),e.style.width=e.scrollWidth+"px",n&&document.querySelectorAll(".control-tabs > div")[n].click()}else document.querySelector("#commandes strong")&&updateCommandSheet();function $(e,t){var n=document.createElement("label"),a=document.createElement("input");a.type="checkbox",a.checked=!!B[e],n.appendChild(a);var o=document.createElement("span");o.innerHTML=t,n.appendChild(o),a.onclick=function(){this.checked?B[e]=1:delete B[e],localStorage.setItem("settings",JSON.stringify(B))},D.appendChild(n)}}function getKeyName(e,t){if("gamepad"!==t)return this.keyMatching||(this.keyMatching=["","","","Break","","","","","Backspace","Tab","","","Clear","Enter","","","Shift","Ctrl","Alt","Pause","CapsLock","Hangul","","","","Hanja","",toLanguage("Escape","√âchap"),"Conversion","Non-conversion","","",toLanguage("Spacebar","Espace"),"PageUp","PageDown","End","Home","&larr;","&uarr;","&rarr;","&darr;","Select","Print","Execute",toLanguage("Print Screen","ImpEcr"),"Inser",toLanguage("Delete","Suppr"),"Help","0","1","2","3","4","5","6","7","8","9",":","=","&lt;","=","","SS","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Meta","Meta","Meta","","Sleep","0","1","2","3","4","5","6","7","8","9","&times;","+",".","-",".","/","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NumLock","ScrollLock","","","","","","","","","","","","","","","^","!","ÿõ","#","$","√ô","PageDown","PageUp","Refresh",")","*","~","Home","-","Vol. down","Vol. up","Next","Previous","Stop","Play/pause","@","Mute","Vol. down","Vol. up","","","√ë","=",",","#",".","/","%","¬∞",",","","","","","","","","","","","","","","","","","","","","","","","","","{","\\","}","'","`","Meta","AltGr","&lt;","","","","Compose","√á","","Forward","Back","Non-conversion","","","","","Alphanumeric","","Hiragana","Half-width","Kanji","","","","","","","Unlock Trackpad","","","","Toggle Touchpad"]),this.keyMatching[e]||"#"+e;for(var n=[],a=0;a<e.length;a++){var o=e[a];if("object"==typeof o&&o.length)for(var i=0;i<o.length;i++)0<o[i]?n.push(i%2?"‚Üì":"‚Üí"):o[i]<0&&n.push(i%2?"‚Üë":"‚Üê");else"number"==typeof o&&n.push("("+o+")")}return n.join("+")}function getGamepadPressedBtns(e){var t=[];if(e.axes)for(var n=0;n<e.axes.length;n++).75<=Math.abs(e.axes[n])&&t.push({key:"stick."+n,type:"stick",id:n,value:e.axes[n]});if(e.buttons)for(n=0;n<e.buttons.length;n++)e.buttons[n]&&e.buttons[n].pressed&&t.push({key:"button."+n,type:"button",id:n});return t}function isGamepadControlSubset(e,t){for(var n=0;n<e.length;n++){var a=e[n];if(t.every(function(e){return e.key!==a.key||e.value!==a.value}))return}return 1}function getLocalControlKey(e){return e&&"keyboard"!==e?"controls."+e:"controls"}function findGamePadById(e,t){if(e){var n=navigator.getGamepads(),a="";t&&(a="_p2");for(var o=0;o<n.length;o++)if((i=n[o])&&i.id===e["_name"+a]&&i.index===e["_id"+a])return i;for(o=0;o<n.length;o++)if((i=n[o])&&i.id===e["_name"+a])return i;for(var i,o=0;o<n.length;o++)if((i=n[o])&&i.index===e["_id"+a])return i}}function getCommands(e,t){var n;if(t=t||strPlayer.length,"gamepad"===e){if(n={up:[1],down:[0],left:[[-1]],right:[[1]],item:[6],item_back:[[0,1],6],item_fwd:[[0,-1],6],jump:[7],balloon:[2],rear:[3],pause:[9],quit:[16]},1<t)for(var a=["up","down","left","right","item","item_back","item_fwd","jump","balloon","rear"],o=0;o<a.length;o++){var i=a[o];n[i+"_p2"]=JSON.parse(JSON.stringify(n[i]))}}else n={up:[38],down:[40],left:[37],right:[39],item:[32],item_back:[67],item_fwd:[86],jump:[17,18],balloon:[16],rear:[88],pause:[80],quit:[27],cheat:[120,33,57,105]},1<t&&(n.up_p2=[69],n.down_p2=[68],n.left_p2=[83],n.right_p2=[70],n.item_p2=[toLanguage(65,81)],n.item_back_p2=[toLanguage(87,65)],n.item_fwd_p2=[82],n.jump_p2=[71],n.balloon_p2=[84],n.rear_p2=[toLanguage(87,90)]);var r=n,l=localStorage.getItem(getLocalControlKey(e));if(l){var s,c=!e||"keyboard"===e;for(s in l=JSON.parse(l))r[s]=l[s],c&&(r[s]=[r[s]])}return r}function getGameControls(){var e={keyboard:{}},n=getCommands("keyboard");for(i in n)for(var t=0;t<n[i].length;t++){var a=n[i][t];e.keyboard[a]||(e.keyboard[a]=i)}if("_id"in(n=getCommands("gamepad"))||oPlayers[1]&&"_id_p2"in n){for(var o=[[]],t=0;t<oPlayers.length;t++)o[t]=[];var i,r=Object.values(n).length;for(i in n)if(!i.startsWith("_")){var l=0;if(i.endsWith("_p2")&&(l=1,i=i.substring(0,i.length-3)),o[l]){for(var s=[],t=0;t<n[i].length;t++){var c=n[i][t];if("object"==typeof c&&c.length)for(var p=0;p<c.length;p++)0<Math.abs(c[p])&&s.push({key:"stick."+p,type:"stick",id:p,value:c[p],isPressed:function(e){return Math.sign(e.value)===Math.sign(this.value)}});else"number"==typeof c&&s.push({key:"button."+c,type:"button",id:c,isPressed:function(){return!0}})}o[l].push({priority:s.length-o[l].length/r,key:i,value:s})}}for(t=0;t<o.length;t++)o[t].sort(function(e,t){return t.priority-e.priority});e.gamepad=o.map(function(e,t){t=t?"_p2":"";return{_id:n["_id"+t],_name:n["_name"+t],controls:e.map(function(e){return{key:e.key,inputs:e.value}})}})}return e}function initGamepadMenuEvents(){if(gamepadMenuEventsHandler)return!1;if(!gameControls.gamepad)return!1;if(!navigator.getGamepads().some(Boolean))return!1;var c={};function p(e,t){if(t[e]=!0,!c[e])if(oPlayers.length){var n=document.getElementById("infos0");if(n&&n.onkeydown&&n.contains(document.activeElement))switch(e){case"ArrowUp":n.onkeydown({keyCode:38});break;case"ArrowDown":n.onkeydown({keyCode:40});break;case"Enter":document.activeElement.click(),n.onkeydown({keyCode:13})}}else document.onkeydown({key:e})}var u=[];return gamepadMenuEventsHandler=setInterval(function(){var e=getGamepadInputsData(0,u);if(e){for(var t=e.pressedBtnsRaw,n=e.pressActions,a={},o=0;o<t.length;o++){var i=t[o];"stick"===i.type&&(s=null,p(s=i.id%2?0<i.value?"ArrowDown":"ArrowUp":0<i.value?"ArrowRight":"ArrowLeft",a))}for(var r=0;r<n.length;r++){var l=n[r].key;if(!c[l]){var s=null;switch(l){case"up":s="Enter";break;case"down":s="_Back"}s&&p(s,a)}}c=a}},SPF),window.gamePadEventListener&&(window.removeEventListener("gamepadconnected",window.gamePadEventListener),window.gamePadEventListener=void 0),!0}function refreshGameControls(){return gameControls=getGameControls(),initGamepadMenuEvents()}function toLanguage(e,t){return language?e:t}function toPlace(e){var t;if(language){var n=e%100;if(10<=n&&n<20)t="th";else switch(e%10){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th"}}else t=1!=e?"e":"er";return e+"<sup>"+t+"</sup>"}function toTitle(e,t){var n=document.createElement("div");return n.style.width=iWidth*iScreenScale+"px",n.style.fontSize=Math.round(8*iScreenScale)+"px",n.style.fontWeight="normal",n.style.position="absolute",n.style.left="0px",n.style.top=Math.round(t*iScreenScale)+"px",n.style.textAlign="center",n.style.color=primaryColor,n.innerHTML=e,n.style.fontFamily="Tahoma",n}function ucwords(e){return e.replace(/(^([a-zA-Z\p{M}]))|([ -][a-zA-Z\p{M}])/g,function(e){return e.toUpperCase()})}function toPerso(e){if(isCustomPerso(e))return customPersos[e].name;var t=e;return language?"maskass"==e?t="shy guy":"skelerex"==e?t="dry bones":"harmonie"==e?t="rosalina":"roi_boo"==e?t="king boo":"frere_marto"==e?t="hammer bro":"bowser_skelet"==e?t="dry bowser":"flora_piranha"==e&&(t="petey piranha"):"frere_marto"==e&&(t="fr√®re marto"),t=ucwords(t=t.replace(/_/g," "))}var isMobileCache=!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)),$commandes;function isMobile(){return isMobileCache}function isChatting(){if(isOnline){var e=document.querySelector('form.online-chat-answer input[name="rMessage"]');return e?document.activeElement==e:void 0}}function onButtonTouch(e){e&&e.preventDefault(),this.style.backgroundColor="#603",this.dataset.pressed="1",navigator.vibrate(30);for(var t=this.dataset.key.split(","),n=0;n<t.length;n++)doPressKey(t[n]);return!1}function onButtonPress(e){this.style.backgroundColor="",this.dataset.pressed="";for(var t=this.dataset.key.split(","),n=0;n<t.length;n++)doReleaseKey(t[n])}function setChat(){if(!chatting){chatting=!0;for(var oChats=document.getElementsByClassName("online-chat");oChats.length;)document.body.removeChild(oChats[0]);var oChat=document.createElement("div");oChat.className="online-chat";var oConnectes=document.createElement("p");oConnectes.className="online-chat-connecteds";var oPlayersListCtn=document.createElement("div");oPlayersListCtn.className="online-chat-playerlistctn";var iConnectes=document.createElement("span");iConnectes.innerHTML=toLanguage("Currently online: ","Actuellement en ligne : "),oPlayersListCtn.appendChild(iConnectes);var jConnectes=document.createElement("span");jConnectes.style.color="white",oPlayersListCtn.appendChild(jConnectes),oConnectes.appendChild(oPlayersListCtn);var oChatActions=document.createElement("div");oChatActions.className="online-chat-actions";var vConnectes=document.createElement("button");vConnectes.className="disablable",vConnectes.title=language?"Join voice chat":"Rejoindre salon vocal";var viConnectes=document.createElement("img");viConnectes.alt="Voc",viConnectes.src="images/ic_voc.png",vConnectes.appendChild(viConnectes),vConnectes.onclick=function(){function t(){vtConnectes.nodeValue=language?"Voice chat":"Chat vocal",vConnectes.disabled=!1}rtcService.joinVocChat({success:function(){vConnectes.style.display="none",vChatActions.style.display="inline-block",vcLoading.style.display="";var e=++vcLoading.dataset.lastUpdate;setTimeout(function(){vcLoading.dataset.lastUpdate==e&&(vcLoading.style.display="none")},1e3),t()},error:function(e){alert((language?"Unable to join voice chat:":"Impossible de rejoindre le chat vocal : ")+e),t()},muted:!!vcaMute.dataset.muted}),vConnectes.disabled=!0,vtConnectes.nodeValue=language?"Joining...":"Chargement..."},vConnectes.onmouseover=function(){viConnectes.src="images/ic_voc_h.png"},vConnectes.onmouseout=function(){viConnectes.src="images/ic_voc.png"};var vtConnectes=document.createTextNode(language?"Voice chat":"Chat vocal");vConnectes.appendChild(vtConnectes),vConnectes.style.marginRight="10px",oChatActions.appendChild(vConnectes);var vChatActions=document.createElement("div");vChatActions.className="vocal-chat-actions",vChatActions.style.display="none";var vcaMute=document.createElement("button");vcaMute.title=language?"Mute":"Muet";var vcaiMute=document.createElement("img");vcaiMute.src="images/ic_mic.png",vcaMute.appendChild(vcaiMute),vcaMute.onmouseover=function(){vcaMute.dataset.muted?vcaiMute.src="images/ic_muted_h.png":vcaiMute.src="images/ic_mic_h.png"},vcaMute.onmouseout=function(){vcaMute.dataset.muted?vcaiMute.src="images/ic_muted.png":vcaiMute.src="images/ic_mic.png"},vcaMute.onclick=function(){function e(){vcaMute.disabled=!1}vcaMute.disabled=!0,vcaMute.dataset.muted?(vcaMute.dataset.muted="",rtcService.toggleMute(!1,e),vcaiMute.src="images/ic_mic.png"):(vcaMute.dataset.muted=1,rtcService.toggleMute(!0,e),vcaiMute.src="images/ic_muted.png")},vChatActions.appendChild(vcaMute);var vcaHangup=document.createElement("button");vcaHangup.title=language?"Hang up":"Raccrocher";var vcaiHangup=document.createElement("img");vcaiHangup.src="images/ic_hangup.png",vcaHangup.appendChild(vcaiHangup),vcaHangup.onmouseover=function(){vcaiHangup.src="images/ic_hangup_h.png"},vcaHangup.onmouseout=function(){vcaiHangup.src="images/ic_hangup.png"},vcaHangup.onclick=function(){cPlayerPeers={},rtcService.quitVocChat({callback:function(){vConnectes.style.display=""}}),vChatActions.style.display="none"},vChatActions.appendChild(vcaHangup);var vcLoading=document.createElement("span");vcLoading.className="vocal-chat-loading",vcLoading.style.display="none",vcLoading.dataset||(vcLoading.dataset={}),vcLoading.dataset.lastUpdate=0;var vciLoading=document.createElement("img");vciLoading.src="images/ic_loading.png",vcLoading.appendChild(vciLoading),vChatActions.appendChild(vcLoading),oChatActions.appendChild(vChatActions);var bConnectes=document.createElement("button"),oBlockDialog;bConnectes.title=language?"Ignore player...":"Ignorer un joueur...",bConnectes.onmouseover=function(){biConnectes.src="images/ic_block_h.png"},bConnectes.onmouseout=function(){biConnectes.src="images/ic_block.png"},oChatActions.appendChild(bConnectes),bConnectes.onclick=function(){return showMemberList(language?"Ignore member":"Ignorer un membre",function(e){return e[2]},function(e,t,n){xhr(t?"ignore.php":"unignore.php","member="+e,function(e){return 1==e}),n()}),!1};var biConnectes=document.createElement("img"),mConnectes,miConnectes;biConnectes.alt="Block",biConnectes.src="images/ic_block.png",bConnectes.appendChild(biConnectes),bConnectes.appendChild(document.createTextNode(language?"Ignore...":"Ignorer...")),oChatActions.appendChild(bConnectes),mIsModerator&&(mConnectes=document.createElement("button"),mConnectes.title=language?"Mute player (admin)":"Muter un joueur (admin)",mConnectes.onmouseover=function(){miConnectes.src="images/ic_mute_h.png"},mConnectes.onmouseout=function(){miConnectes.src="images/ic_mute.png"},mConnectes.onclick=function(){return showMemberList(language?"Mute member":"Muter un membre",function(e){return e[3]},function(e,t,n){var a=1;t&&(a=prompt(language?"Mute for (minutes):":"Muter pendant (minutes) :",10)),0<a&&(xhr(t?"mute.php":"unmute.php","member="+e+"&duration="+a,function(e){return 1==e}),n())}),!1},miConnectes=document.createElement("img"),miConnectes.alt="Mute",miConnectes.src="images/ic_mute.png",mConnectes.appendChild(miConnectes),mConnectes.appendChild(document.createTextNode(language?"Mute...":"Muter...")),oChatActions.appendChild(mConnectes)),oConnectes.appendChild(oChatActions);var oCloseChatCtn=document.createElement("div");oCloseChatCtn.className="online-chat-closectn";var oCloseChat=document.createElement("button");oCloseChat.className="online-chat-close",oCloseChat.innerHTML="&times",oCloseChat.onclick=function(){oChat.classList.add("online-chat-closed")},oCloseChatCtn.appendChild(oCloseChat);var oOpenChat=document.createElement("button");oOpenChat.className="online-chat-open",oOpenChat.innerHTML="‚ñ°",oOpenChat.onclick=function(){oChat.classList.remove("online-chat-closed")},oCloseChatCtn.appendChild(oOpenChat),oChat.appendChild(oCloseChatCtn);var oMessages=document.createElement("div");oMessages.className="online-chat-messages";var oRepondre=document.createElement("form");oRepondre.className="online-chat-answer";var rMessage=document.createElement("input");rMessage.type="text",rMessage.name="rMessage",rMessage.onkeydown=function(e){38==e.keyCode?this.blur():e.stopPropagation()},rMessage.onkeyup=function(e){e.stopPropagation()};var rEnvoi=document.createElement("input");rEnvoi.type="submit",rEnvoi.value=toLanguage("Send","Envoyer"),oRepondre.appendChild(rMessage),oRepondre.appendChild(rEnvoi),oRepondre.onsubmit=function(){var n;return rMessage.value&&(n=rMessage.value,xhr("parler.php","msg="+encodeURIComponent(n).replace(/\+/g,"%2B")+(onlineSpectatorId?"&spectator="+onlineSpectatorId:""),function(e){var t;switch(+e){case-1:t=toLanguage("inappropriate words","mots inappropri√©s");break;case-2:t=toLanguage("spam","spam");break;case-3:t=toLanguage("too long","trop long");break;case-4:addMsgToChat(mPseudo,n)}return t&&((e=document.createElement("p")).className="chatlog",e.innerHTML="<em>"+toLanguage("Message not sent (reason: "+t+")","Message non envoy√© (raison : "+t+")")+"</em>",oMessages.appendChild(e),oMessages.scrollTop=oMessages.scrollHeight-oMessages.clientHeight),!0}),rMessage.value=""),!1},oChat.appendChild(oConnectes),oChat.appendChild(oMessages),oChat.appendChild(oRepondre);var iChatLastMsg=0;rtcService=rtcService||RTCService({spectatorId:onlineSpectatorId}),refreshChat(),vConnectes.disabled=!0,rtcService.getVocChat({callback:function(e){e&&(vConnectes.style.display="none",vChatActions.style.display="inline-block"),vConnectes.disabled=!1}}),document.body.insertBefore(oChat,$mkScreen);try{handleChatPos()}catch(e){console.error(e)}}function removeBlockDialog(){return oBlockDialog&&(oChat.removeChild(oBlockDialog),oBlockDialog=null,1)}function showMemberList(title,blockedFn,onSelect){var oBlockTitle,oBlockClose,oBlockMembers;removeBlockDialog()||(oBlockDialog=document.createElement("div"),oBlockDialog.className="online-chat-blockdialog",oBlockDialog.style.position="absolute",oBlockDialog.style.left="85px",oBlockDialog.style.top="8%",oBlockDialog.style.width="200px",oBlockDialog.style.border="double 4px silver",oBlockDialog.style.backgroundColor="#222",oBlockTitle=document.createElement("h1"),oBlockTitle.innerHTML=title,oBlockDialog.appendChild(oBlockTitle),oBlockClose=document.createElement("input"),oBlockClose.type="button",oBlockClose.onclick=function(){removeBlockDialog()},oBlockClose.value="√ó",oBlockDialog.appendChild(oBlockClose),oBlockMembers=document.createElement("div"),oBlockMembers.className="online-chat-blockdialog-members",xhr("listCoursePlayers.php",onlineSpectatorId?"spectator="+onlineSpectatorId:"",function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(e){return!1}for(var i=0;i<rCode.length;i++){var memberId=rCode[i][0],memberPseudo=rCode[i][1],memberBlocked=blockedFn(rCode[i]),oBlockMember=document.createElement("div");oBlockMember.dataset||(oBlockMember.dataset={}),oBlockMember.dataset.id=memberId,oBlockMember.dataset.blocked=memberBlocked?"1":"",oBlockMember.innerHTML=memberPseudo,oBlockMember.onclick=function(){var e=this;onSelect(this.dataset.id,!this.dataset.blocked,function(){e.dataset.blocked=e.dataset.blocked?"":"1"})},oBlockMembers.appendChild(oBlockMember)}return!0}return!1}),oBlockDialog.appendChild(oBlockMembers),oChat.appendChild(oBlockDialog))}function refreshChat(){chatting?xhr("chat.php","lastmsg="+iChatLastMsg+(onlineSpectatorId?"&spectator="+onlineSpectatorId:""),function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(e){return!1}if(-1!=rCode){for(var cPlayers=rCode[0],currentConnectedPlayers={},msgScrolledToBottom=oMessages.scrollHeight-oMessages.clientHeight<=oMessages.scrollTop+1,i=0,cPlayerId;i<cPlayers.length;i++){var cPlayer=cPlayers[i],sNom,isIcon,cPeer,lastUpdate;currentConnectedPlayers[cPlayer.id]=1,cPlayer.id!==identifiant?(sNom=jConnectes.querySelector("[data-player='"+cPlayer.id+"']"),sNom||(sNom=document.createElement("div"),sNom.dataset||(sNom.dataset={}),sNom.dataset.player=cPlayer.id,sNom.className="online-chat-playerlistelt",sNom.innerHTML='<span class="online-chat-playerlistname"></span><div class="online-chat-playerlisticon"><img class="online-chat-spectator" alt="Spectator" title="'+toLanguage("Spectator mode","Mode spectateur")+'" src="images/ic_spectator.png" /><div class="online-chat-playerlisticonwrapper"><div class="online-chat-playerlistvolume"></div><img alt="Voc" /></div></div>',jConnectes.appendChild(sNom)),isIcon=!1,sNom.querySelector(".online-chat-playerlistname").innerText=cPlayer.name,cPlayer.spectator?(sNom.querySelector(".online-chat-spectator").style.display="",isIcon=!0):sNom.querySelector(".online-chat-spectator").style.display="none",cPlayer.peer?(isIcon=!0,sNom.querySelector(".online-chat-playerlisticonwrapper").style.display="",sNom.querySelector(".online-chat-playerlisticonwrapper img").src="images/"+(cPlayer.muted?"ic_muted":"ic_voc")+".png",cPeer=rtcService.getPeer(cPlayer.peer),cPeer&&cPeer.audio&&(cPeer.recorderHandler||function(o,i){var e,r,l;i&&(e=new AudioContext,r=e.createAnalyser(),e.createMediaStreamSource(o.audio.srcObject).connect(r),l=new Uint8Array(r.fftSize),o.recorderHandler=setInterval(function(){if(!o.audio.parentNode||!document.body.contains(i)||!cPlayerPeers[identifiant])return clearInterval(o.recorderHandler),delete o.recorderHandler,r.disconnect(),i.style.width="",i.style.height="",i.style.left="",void(i.style.top="");r.getByteTimeDomainData(l);for(var e=0,t=0;t<l.length;t++)e+=Math.abs(l[t]-128);e/=l.length;var n=6+18*Math.pow(e/128,.15);n<14&&(n=0);var a=(16-n)/2;i.style.width=Math.round(n)+"px",i.style.height=Math.round(n)+"px",i.style.left=Math.round(a-1)+"px",i.style.top=Math.round(1+a)+"px"},300))}(cPeer,sNom.querySelector(".online-chat-playerlistvolume"))),cPlayerPeers[cPlayer.id]=cPlayer.peer,cPlayer.ignored?rtcService.removePeer(cPlayer.peer):rtcService.addPeer(cPlayer.peer,{loading:function(){vcLoading.style.display="",lastUpdate=++vcLoading.dataset.lastUpdate},success:function(){vcLoading.dataset.lastUpdate==lastUpdate&&(vcLoading.style.display="none")},error:function(){vcLoading.dataset.lastUpdate==lastUpdate&&(vcLoading.style.display="none")}})):(sNom.querySelector(".online-chat-playerlisticonwrapper").style.display="none",rtcService.removePeer(cPlayerPeers[cPlayer.id]),delete cPlayerPeers[cPlayer.id]),sNom.querySelector(".online-chat-playerlisticon").style.display=isIcon?"":"none"):cPlayerPeers[cPlayer.id]!==cPlayer.peer&&"inline-block"===vChatActions.style.display&&(cPlayerPeers[cPlayer.id]&&function(e){vChatActions.style.display="none",rtcService.quitVocChat({callback:function(){delete cPlayerPeers[e],rtcService.joinVocChat({success:function(){vChatActions.style.display="inline-block"},error:function(e){vConnectes.style.display=""},muted:!!vcaMute.dataset.muted})}})}(cPlayer.id),cPlayerPeers[cPlayer.id]=cPlayer.peer)}for(cPlayerId in cPlayerPeers)currentConnectedPlayers[cPlayerId]||(rtcService.removePeer(cPlayerPeers[cPlayerId],{disconnectReceiver:!0}),delete cPlayerPeers[cPlayerId]);for(var sNoms=jConnectes.querySelectorAll("[data-player]"),i=0;i<sNoms.length;i++){var sNom=sNoms[i];currentConnectedPlayers[sNom.dataset.player]||jConnectes.removeChild(sNom)}var messages=rCode[1];if(messages.length){var lastMsgId=messages.length-1;iChatLastMsg=messages[lastMsgId][2];for(var i=0;i<=lastMsgId;i++)addMsgToChat(messages[i][0],messages[i][1]);for(var pMessages=oMessages.getElementsByTagName("p"),cMessages=oMessages.getElementsByClassName("online-chat-message");40<pMessages.length+cMessages.length;)oMessages.removeChild(pMessages[0])}msgScrolledToBottom&&(oMessages.scrollTop=oMessages.scrollHeight-oMessages.clientHeight),setTimeout(refreshChat,1e3)}else chatting=!1,stopVocChat();return!0}return!1}):document.body.removeChild(oChat)}function addMsgToChat(e,t){var n,a=oMessages.children[oMessages.children.length-1];(!a||a.dataset.pseudo!==e||a.dataset.lastts<Date.now()-4e4)&&((n=document.createElement("p")).dataset.pseudo=e,n.dataset.lastts=Date.now(),(o=document.createElement("div")).className="online-chat-pseudo",o.innerHTML=e,n.appendChild(o));var o=document.createElement("div");o.style.color="white",o.className="online-chat-message",o.style.fontWeight="normal",o.innerHTML=t,n&&n.appendChild(o);t=oMessages.scrollHeight-oMessages.clientHeight<=oMessages.scrollTop+1;n?oMessages.appendChild(n):(a.dataset.lastts=Date.now(),a.appendChild(o)),t&&(oMessages.scrollTop=oMessages.scrollHeight-oMessages.clientHeight)}}function stopVocChat(){rtcService&&(cPlayerPeers={},rtcService.quitVocChat())}function handleChatPos(){var e,t;document.getElementById("chat-offset-style")||(e=document.getElementById("vPub")).querySelector("ins.adsbygoogle[data-ad-status='filled']")&&((t=document.createElement("style")).id="chat-offset-style",t.setAttribute("type","text/css"),t.innerHTML="@media screen and (max-width: 849px) {.online-chat {margin-top: "+(e.offsetHeight+10)+"px;}}",document.getElementsByTagName("head")[0].appendChild(t))}formulaire=document.forms.modes,formulaire.dataset?formulaire.dataset.disabled="":formulaire.dataset={},window.gamePadEventListener&&(window.removeEventListener("gamepadconnected",window.gamePadEventListener),window.gamePadEventListener=void 0),clearInterval(gamepadMenuEventsHandler),gamepadMenuEventsHandler=void 0,refreshGameControls()||(window.gamePadEventListener=refreshGameControls,window.addEventListener("gamepadconnected",window.gamePadEventListener)),pause?isSingle&&!isOnline?choose(1):(null!=fInfos.map?loadMap:selectMapScreen)():(addOption("pSize",toLanguage("Screen Size","Taille de l'&eacute;cran"),"vSize","screenscale",[[4,toLanguage("Very small","Tr&egrave;s petite")],[6,toLanguage("Small","Petite")],[8,toLanguage("Medium","Moyenne")],[10,toLanguage("Large","Large")],[12,toLanguage("Very large","Tr&egrave;s large")],[-1,toLanguage("Full (F11)","Plein (F11)")],[-2,toLanguage("Custom...","Personnalis√©...")]],+$mkScreen.dataset.lastsc||iScreenScale),addScreenScaleOption(iScreenScale),addOption("pMusic",toLanguage("Music","Musique"),"vMusic","music",[[0,toLanguage("Off","D&eacute;sactiv&eacute;e")],[1,toLanguage("On","Activ&eacute;e")]],bMusic),addOption("pSfx",toLanguage("Sound effects","Bruitages"),"vSfx","sfx",[[0,toLanguage("Off","D&eacute;sactiv&eacute;s")],[1,toLanguage("On","Activ&eacute;s")]],iSfx),addOption("pFps",toLanguage("Framerate","FPS"),"vFps","fps",[[1,"15 FPS"],[2,"30 FPS"],[4,"60 FPS"],[-2,toLanguage("More...","Plus...")]],iFps),addFpsOption(iFps),selectMainPage(),formulaire.screenscale.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setScreenScale(e)},formulaire.music.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setMusic(e)},formulaire.sfx.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setSfx(e)},formulaire.fps.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setFps(e)},window.fsevent||(window.fsevent=function(e){if(122==e.keyCode){e.preventDefault();e=iScreenScale;return iScreenScale=+formulaire.screenscale.value,formulaire.screenscale.value=-1,formulaire.screenscale.onchange(),formulaire.dataset.disabled&&(iScreenScale=e),!1}},window.addEventListener("keydown",window.fsevent)),"undefined"==typeof course&&(course=""),$commandes=document.getElementById("commandes"),$commandes&&($commandes.dataset||($commandes.dataset={}),$commandes.innerHTML.length<10&&($commandes.dataset.hasCommands=1),$commandes.dataset.hasCommands&&displayCommands()),isFirstLoad&&(isFirstLoad=!1,hasChallenges()&&(initSessionStorage(),xhr("getClSelected.php",null,function(e){if(!e)return!0;try{e=JSON.parse(e)}catch(e){return!0}if(e.id)for(var t in challenges)for(var n in challenges[t])for(var a=challenges[t][n].list,o=0;o<a.length;o++){var i=a[o];if(i.id==e.id)return clSelected||i.succeeded||((clSelected=i).trackType=t,clSelected.trackId=n,clSelected.autoset=e.autoset,localStorage.removeItem("itemset."+getItemMode()),course||!clSelected.autoset.course||(i=oContainers[0].childNodes[0])&&(i.innerHTML="",oContainers[0].removeChild(i),course=clSelected.autoset.course,selectPlayerScreen(0)),showClSelectedPopup()),!0}return!0})))),window.MarioKartControl={setQuality:function(e){setQuality(e)},setScreenScale:function(e){setScreenScale(e)},setMusic:function(e){setMusic(e)},setSfx:function(e){setSfx(e)},setFps:function(e){setFps(e)}}}var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);