var pause,chatting=!1,aPlayers=new Array,aPlaces=new Array,aScores=new Array,aTeams=new Array,aPseudos=new Array,aControllers=new Array,fInfos,formulaire,baseCp,customDecorData={},nBasePersos,customPersos,selectedDifficulty,updateCtnFullScreen,isFirstLoad=!0,edittingCircuit,noDS,cupOpts,bListMaps;void 0===edittingCircuit&&(edittingCircuit=!1),void 0===noDS&&(noDS=!1),void 0===cupOpts&&(cupOpts={}),noDS&&(bListMaps=listMaps,listMaps=function(){NBCIRCUITS=40;for(var e=bListMaps(),t={},n=1;n<=NBCIRCUITS;n++)t["map"+n]=e["map"+n];return t});var isOnline="OL"==page,isMCups=isCup&&4<NBCIRCUITS,clRuleVars={},clGlobalVars,selectPerso,selectedTeams,challenges,clRewards,cupNames,challengesForCircuit;function xhr(t,n,a,o){var i;if(o=o||1e3,window.XMLHttpRequest||window.ActiveXObject)if(window.ActiveXObject)try{i=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){i=new ActiveXObject("Microsoft.XMLHTTP")}else i=new XMLHttpRequest;i.open("POST",t,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("If-Modified-Since","Wed, 15 Nov 1995 00:00:00 GMT");try{i.onload=function(){200==i.status?a(i.responseText)||setTimeout(function(){xhr(t,n,a,2*o)},o):i.onerror()},i.onerror=function(){setTimeout(function(){xhr(t,n,a,2*o)},o)}}catch(e){i.onreadystatechange=function(){4!=i.readyState||a(i.responseText)||setTimeout(function(){xhr(t,n,a,2*o)},o)}}i.send(n)}function MarioKart(){var oMaps=listMaps(),aAvailableMaps=new Array;for(circuits in void 0===Array.isArray&&(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),oMaps){aAvailableMaps.push(circuits);var oMap=oMaps[circuits];oMap.w||(oMap.w=512),oMap.h||(oMap.h=512),oMap.tours||(oMap.tours=3),isCup||oMap.ext||(oMap.ext="png"),oMap.ref=+circuits.replace("map",""),oMap.aipoints&&oMap.aipoints[0]&&oMap.aipoints[0].length&&!Array.isArray(oMap.aipoints[0][0])&&(oMap.aipoints=[oMap.aipoints]),oMap.horspistes||(oMap.horspistes={},oMap.horspiste&&(oMap.horspistes.herbe=oMap.horspiste,delete oMap.horspiste))}var iWidth=80,iHeight=39,SPF=67,iRendering=optionOf("quality"),iQuality,iSmooth;resetQuality();var bMusic=!!optionOf("music"),iSfx=!!optionOf("sfx"),gameMenu,primaryColor="#FEFF3F",refreshDatas=isOnline,finishing=!1,connecte=1,aIDs=new Array,tnCourse=0,identifiant;"undefined"!=typeof mId&&(identifiant=mId),"undefined"==typeof cShared&&(cShared="AR"==page&&0<nid),"undefined"!=typeof shareLink&&shareLink.options&&shareLink.options.team&&(selectedTeams=1);var myCircuit=null!=document.getElementById("changeRace");function setQuality(e){iRendering=e,resetQuality(),bRunning&&resetScreen(),xhr("changeParam.php","param=0&value="+e,function(e){return 1==e})}function resetQuality(){iSmooth=5==iRendering?!(iQuality=1):(iQuality=iRendering,!0)}function openFullscreen(e){return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():void 0}var $mkScreen=document.getElementById("mariokartcontainer");$mkScreen.dataset||($mkScreen.dataset={}),updateCtnFullScreen=function(e){if($mkScreen.dataset.fs=e?1:"",e){var t=Math.min(screen.width/(iWidth*iScreenScale),screen.height/(iHeight*iScreenScale)),n=Math.round(100*t),a=$mkScreen.scrollWidth,e=$mkScreen.style.zoom;if($mkScreen.style.zoom=n+"%",a!=$mkScreen.scrollWidth||e==$mkScreen.style.zoom||100==n){for(var o=0;o<oContainers.length;o++)oContainers[o].style.left=Math.round((screen.width/t-iScreenScale*iWidth)/2+o*(iWidth*iScreenScale+2))+"px",oContainers[o].style.top=Math.round((screen.height/t-iScreenScale*iHeight)/2)+"px";updateHudFullScreen()}else if($mkScreen.style.zoom="",!formulaire||!formulaire.screenscale.disabled){e=window.innerWidth-20,n=window.innerHeight-20,t=Math.round(Math.min(e/iWidth,n/iHeight));$mkScreen.dataset.fakefs=1;for(o=0;o<oContainers.length;o++)oContainers[o].style.left=Math.round((window.innerWidth-t*iWidth)/2+o*(iWidth*iScreenScale+2))+"px",oContainers[o].style.top=Math.round((window.innerHeight-t*iHeight)/2)+"px";updateHudFullScreen(),$mkScreen.dataset.lastsc||($mkScreen.dataset.lastsc=iScreenScale),setScreenScale(t,!0),window.nsevent||(window.nsevent=function(e){27==e.keyCode&&(e.preventDefault(),updateCtnFullScreen(!1))},window.addEventListener("keydown",window.nsevent))}$mkScreen.className="fullscreen"}else if(!($mkScreen.dataset.fakefs&&formulaire&&formulaire.screenscale.disabled)){$mkScreen.style.zoom="",$mkScreen.className="",$mkScreen.dataset.fakefs&&(setScreenScale(+$mkScreen.dataset.lastsc,!0),$mkScreen.dataset.lastsc="",$mkScreen.dataset.fakefs="",window.nsevent&&(window.removeEventListener("keydown",window.nsevent),delete window.nsevent));for(o=0;o<oContainers.length;o++)oContainers[o].style.left=10+o*(iWidth*iScreenScale+2)+"px",oContainers[o].style.top="";updateHudFullScreen()}};var hudScreens=new Array,oMusicHandler,muteOnBlur,unmuteOnResume,itemDistribution;function updateHudFullScreen(){for(var e=0;e<hudScreens.length;e++)hudScreens[e].style.left=oContainers[e].style.left,hudScreens[e].style.top=oContainers[e].style.top}function removeHUD(){for(var e=0;e<hudScreens.length;e++)$mkScreen.removeChild(hudScreens[e]);hudScreens.length=0}function setScreenScale(e,t){if(e!==iScreenScale){var n=iScreenScale;if(-1!=e){iScreenScale=e,t||xhr("changeParam.php","param=1&value="+e,function(e){return 1==e}),bRunning&&resetScreen();for(var a=0;a<oContainers.length;a++){var o=oContainers[a].firstChild;o&&(o.aScreenScale||(o.aScreenScale=n),o.style.width=iWidth*iScreenScale+"px",o.style.height=iHeight*iScreenScale+"px",o.style.transformOrigin=o.style.WebkitTransformOrigin=o.style.MozTransformOrigin="top left",o.style.transform=o.style.WebkitTransform=o.style.MozTransform="scale("+iScreenScale/o.aScreenScale+")")}reposKeyboard(),setSRest()}else{formulaire.screenscale.value=n;e=openFullscreen($mkScreen);e.then&&e.catch?e.then(function(){updateCtnFullScreen(!0),document.onfullscreenchange=function(){updateCtnFullScreen(document.fullscreenElement===$mkScreen)}}).catch(function(){updateCtnFullScreen(!0)}):updateCtnFullScreen(!0)}}}function reposKeyboard(){var e=4.8*virtualButtonW,t=2.6*virtualButtonH;document.getElementById("virtualkeyboard").style.width=Math.round(e)+"px",document.getElementById("virtualkeyboard").style.height=Math.round(t)+"px",document.getElementById("virtualkeyboard").style.left=(iScreenScale*iWidth-e)/2+"px",document.getElementById("virtualkeyboard").style.top=40*iScreenScale+"px"}function setMusic(e){bMusic=!!e,-1!=gameMenu&&updateMenuMusic(gameMenu,!0),xhr("changeParam.php","param=2&value="+e,function(e){return 1==e})}function setSfx(e){iSfx=!!e,xhr("changeParam.php","param=3&value="+e,function(e){return 1==e})}function removeMenuMusic(e){clearTimeout(oMusicHandler),oMusicEmbed&&document.body.contains(oMusicEmbed)&&(e?document.body.removeChild(oMusicEmbed):fadeOutMusic(oMusicEmbed,1,.8),oMusicEmbed=void 0),muteOnBlur&&(window.removeEventListener("blur",muteOnBlur),muteOnBlur=void 0),unmuteOnResume&&(window.removeEventListener("focus",unmuteOnResume),unmuteOnResume=void 0)}function removeIfExists(e){document.body.contains(e)&&document.body.removeChild(e),oMusicEmbed==e&&(oMusicEmbed=void 0)}function removeGameMusics(){if(bMusic||iSfx){for(var e=document.getElementsByClassName("gamemusic");e.length;)document.body.removeChild(e[0]);oMusicEmbed=void 0}}function clearResources(){oMapImg&&oMapImg.clear&&oMapImg.clear()}function pauseSounds(){if(bMusic||iSfx){clLocalVars.forcePause||(playSoundEffect("musics/events/pause.mp3").className="");for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)muteSound(e[t])}}function unpauseSounds(){(bMusic||iSfx)&&(playSoundEffect("musics/events/pause.mp3").className="",setTimeout(function(){if(!pause)for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)unmuteSound(e[t])},300))}function setMusicVolume(e,t){isOriginalEmbed(e)?e.volume=t:onPlayerReady(e,function(e){e.setVolume(Math.round(100*t))})}function fadeInMusic(e,t,n){e.fadingOut||(e.fadingIn=!0,(t/=n)<1?(setMusicVolume(e,t),e.fadingIn=!1,setTimeout(function(){fadeInMusic(e,t,n)},100)):setMusicVolume(e,1))}function fadeOutMusic(e,t,n,a){e.fadingIn||(e.fadingOut=!0,.2<(t*=n)?(setMusicVolume(e,t),setTimeout(function(){fadeOutMusic(e,t,n,a)},100)):(e.fadingOut=!1)===a?(pauseMusic(e),setMusicVolume(e,1)):-1!==a&&stopMusic(e))}function updateMenuMusic(e,t){var n;e==gameMenu&&!t||(gameMenu=e,removeMenuMusic(!bMusic),bMusic&&(playMusicSmoothly("musics/menu/"+(gameMenu?"selection-remix":"main-remix")+".mp3",t?0:void 0),gameMenu||loopAfterIntro(oMusicEmbed,60.15,54.9),n=oMusicEmbed,muteOnBlur=function(){oMusicEmbed==n&&(clearTimeout(oMusicHandler),n.pause())},window.addEventListener("blur",muteOnBlur),unmuteOnResume=function(){oMusicEmbed==n&&n.play()},window.addEventListener("focus",unmuteOnResume)))}function playMusicSmoothly(e,t){void 0===t&&(t=1e3),(oMusicEmbed=document.createElement("audio")).setAttribute("loop",!0),oMusicEmbed.style.position="absolute",oMusicEmbed.style.left="-1000px",oMusicEmbed.style.top="-1000px";var n=document.createElement("source");n.type="audio/mpeg",n.src=e,oMusicEmbed.appendChild(n),clearTimeout(oMusicHandler),t?oMusicHandler=setTimeout(function(){oMusicEmbed.play()},t):oMusicEmbed.setAttribute("autoplay",!0),document.body.appendChild(oMusicEmbed)}var oBgLayers=new Array,oPlayers=new Array;if(!pause)for(joueurs in baseCp&&(cp=baseCp),baseCp={},customPersos={},nBasePersos=0,cp)aPlayers.push(joueurs),baseCp[joueurs]=cp[joueurs],nBasePersos++;var strPlayer=new Array,oMap,iDificulty=5,iTeamPlay=selectedTeams,iRecord,iTrajet,jTrajets,iLapTimes,gPersos=new Array,gRecord,gSelectedPerso,gOverwriteRecord,selectedItemDistrib,oMapImg,oPlanDiv,oPlanDiv2,oPlanCtn,oPlanCtn2,oPlanImg,oPlanImg2,oPlanWidth,oPlanSize,oPlanRealSize,oCharWidth,oObjWidth,oCoinWidth,oExpWidth,oExpBWidth,oPlanWidth2,oPlanSize2,oCharWidth2,oObjWidth2,oCoinWidth2,oExpWidth2,oExpBWidth2,oCharRatio,oPlanRatio;function resetGame(e){oMap=oMaps[e],loadMap()}pause&&(strPlayer=fInfos.player,selectedItemDistrib=fInfos.distribution,oMap=oMaps["map"+fInfos.map],clSelected=fInfos.cl,"CM"!=course?iDificulty=fInfos.difficulty:(iTrajet=fInfos.my_route,gPersos=fInfos.perso,jTrajets=fInfos.cpu_route,gRecord=fInfos.my_record,gOverwriteRecord=fInfos.ow_record,2==gOverwriteRecord&&(gOverwriteRecord=1),iRecord=fInfos.record,iLapTimes=fInfos.lap_times,gSelectedPerso=fInfos.selPerso));var oPlanCharacters=new Array,oPlanObjects=new Array,oPlanCoins=new Array,oPlanPoisons=new Array,oPlanDecor={},oPlanAssets={},oPlanSea,oPlanFauxObjets=new Array,oPlanBananes=new Array,oPlanBobOmbs=new Array,oPlanChampis=new Array,oPlanCarapaces=new Array,oPlanCarapacesRouges=new Array,oPlanCarapacesBleues=new Array,oPlanEtoiles=new Array,oPlanBillballs=new Array,oPlanTeams=new Array,oPlanCharacters2=new Array,oPlanObjects2=new Array,oPlanCoins2=new Array,oPlanDecor2={},oPlanAssets2={},oPlanSea2,oPlanFauxObjets2=new Array,oPlanBananes2=new Array,oPlanBobOmbs2=new Array,oPlanPoisons2=new Array,oPlanChampis2=new Array,oPlanCarapaces2=new Array,oPlanCarapacesRouges2=new Array,oPlanCarapacesBleues2=new Array,oPlanEtoiles2=new Array,oPlanBillballs2=new Array,oPlanTeams2=new Array,gameSettings,oChallengeCpts;function posImg(e,t,n,a,o,i){t=-t/oPlanRealSize,n=-n/oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+-Math.round(i*t+o/2)+"px, "+-Math.round(i*n+o/2)+"px) rotate("+Math.round(180-a)+"deg)",e}function posImgRel(e,t,n,a,o,i,r,l){t=-t/oPlanRealSize,n=-n/oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+(Math.round(r)-Math.round(i*t+o/2))+"px, "+(Math.round(l)-Math.round(i*n+o/2))+"px) rotate("+Math.round(180-a)+"deg)",e}function setPlanPos(){var s=oPlayers[0],e=Math.round(s.rotation-180),t=direction(1,e),n=direction(0,e);function c(e,t,n){var a=document.createElement("img");return a.src="images/map_icons/"+e+".png",a.style.position="absolute",a.style.width=t+"px",a.className="pixelated",n.appendChild(a),a}function d(e,t,n,a,o,i,r){return posImg(e,t,n,s.rotation,a,o),0<=i&&e.team!=i&&(o=i?"red":"blue",e.team=i,e.style.background="radial-gradient(ellipse at center, "+o+" 0%,transparent "+r+"%)"),e}function m(e,t,n,a,o){if(e.length!=t.length){for(;e.length<t.length;)e.push(c(n,a,o));for(;e.length>t.length;)o.removeChild(e[0]),e.shift()}}var a=s.x/oPlanRealSize,o=s.y/oPlanRealSize;function i(e,t,n){for(var a in e)if(oMap[a]){if(e[a].length<oMap[a].length)for(var o=e[a].length;o<oMap[a].length;o++){var i=(s=oMap[a][o])[1][2]*n/oMap.w,r=s[1][3]*n/oMap.w,l=c(s[0].src,i,t);l.style.height=r+"px",l.style.transformOrigin=l.style.WebkitTransformOrigin=l.style.MozTransformOrigin=Math.round(100*s[2][0])+"% "+Math.round(100*s[2][1])+"%",e[a].push(l)}for(o=0;o<oMap[a].length;o++){var s,i=(s=oMap[a][o])[1][2]*n/oMap.w;posImg(e[a][o],s[1][0]+s[1][2]*(.5-s[2][0]),s[1][1]+s[1][2]/2-s[1][3]*s[2][1],Math.round(180*(Math.PI-s[2][2])/Math.PI),i,n)}}}function r(e,t){var n=e.getContext("2d");n.clearRect(0,0,e.width,e.height),oMap.sea.render(n,[0,0],t/oMap.w)}function l(e,t,n){for(var a=0;a<aKarts.length;a++){var o,i,r,l=!0;aKarts[a].loose&&(isOnline&&!finishing||aKarts[a]==s?e[a].style.opacity=.25:(e[a].style.display="none",iTeamPlay&&t==oCharWidth&&(oPlanTeams[a].style.display="none",oPlanTeams2[a].style.display="none"),l=!1)),l&&(r=aKarts[a].billball?1.5:aKarts[a].size,o=Math.round(t*r),e[a].style.width=o+"px",posImg(e[a],aKarts[a].x,aKarts[a].y,aKarts[a].rotation-360*aKarts[a].tourne/21,o,n),iTeamPlay&&t==oCharWidth&&(i=Math.round(oCharWidth2*r),l=Math.round(oTeamWidth*r),r=Math.round(oTeamWidth2*r),posImgRel(oPlanTeams[a],aKarts[a].x,aKarts[a].y,Math.round(s.rotation),o,oPlanSize,(o-l)/2,(o-l)/2),oPlanTeams[a].style.width=l+"px",oPlanTeams[a].style.height=l+"px",posImgRel(oPlanTeams2[a],aKarts[a].x,aKarts[a].y,Math.round(s.rotation),i,oPlanSize2,(i-r)/2,(i-r)/2),oPlanTeams2[a].style.width=r+"px",oPlanTeams2[a].style.height=r+"px"))}}function p(e){for(var t=0;t<oMap.arme.length;t++)isNaN(oMap.arme[t][2])?e[t].style.display="block":e[t].style.display="none"}function u(e,t,n,a){if(e.length!=oMap.coins.length){m(e,oMap.coins,"coin",t,n);for(var o=0;o<e.length;o++)posImg(e[o],oMap.coins[o].x,oMap.coins[o].y,Math.round(s.rotation),t,a)}}function h(i,r,l,e){if(oMap.decor)for(var t in oMap.decor){var n=!i[t].length,a=decorBehaviors[t],s=getDecorExtra(a).custom;if(!a.hidden&&(oMap.decor[t].length!=i[t].length||a.movable)){var c=r;if(a.size_ratio&&(c*=a.size_ratio.w),m(i[t],oMap.decor[t],t,c,l),n&&s){for(var o=0;o<i[t].length;o++)i[t][o].src="images/map_icons/empty.png";!function(a,o){getCustomDecorData(s,function(e){c=r*o.size_ratio.w;for(var t=0;t<i[a].length;t++){var n=i[a][t];n.src=e.map,n.style.width=c+"px"}m(i[a],oMap.decor[a],a,c,l)})}(t,a)}var p,u=a.rotatable;!u||(a=i[t][0])&&a.naturalWidth&&(p=Math.round(c*(a.naturalWidth-a.naturalHeight)/(2*a.naturalWidth)));for(o=0;o<oMap.decor[t].length;o++)u?posImgRel(i[t][o],oMap.decor[t][o][0],oMap.decor[t][o][1],Math.round(oMap.decor[t][o][4]),c,e,0,p):d(i[t][o],oMap.decor[t][o][0],oMap.decor[t][o][1],c,e)}}}oPlanCtn.style.transform=oPlanCtn.style.WebkitTransform=oPlanCtn.style.MozTransform="translate("+-Math.round(oPlanSize*(a*t-o*n)-oPlanWidth/2)+"px, "+-Math.round(oPlanSize*(a*n+o*t)-oPlanWidth/2)+"px) rotate("+e+"deg)",i(oPlanAssets,oPlanCtn,oPlanSize),i(oPlanAssets2,oPlanCtn2,oPlanSize2),oMap.sea&&(r(oPlanSea,oPlanSize),r(oPlanSea2,oPlanSize2)),l(oPlanCharacters,oCharWidth,oPlanSize),l(oPlanCharacters2,oCharWidth2,oPlanSize2),p(oPlanObjects),p(oPlanObjects2),oMap.coins&&(u(oPlanCoins,oCoinWidth,oPlanCtn,oPlanSize),u(oPlanCoins2,oCoinWidth2,oPlanCtn2,oPlanSize2)),h(oPlanDecor,oObjWidth,oPlanCtn,oPlanSize),h(oPlanDecor2,oObjWidth2,oPlanCtn2,oPlanSize2),m(oPlanFauxObjets,items.fauxobjet,"objet",oObjWidth,oPlanCtn),m(oPlanFauxObjets2,items.fauxobjet,"objet",oObjWidth2,oPlanCtn2);for(var y=0;y<items.fauxobjet.length;y++){var g=items.fauxobjet[y];d(oPlanFauxObjets[y],g.x,g.y,oObjWidth,oPlanSize,g.team,200),d(oPlanFauxObjets2[y],g.x,g.y,oObjWidth2,oPlanSize2,g.team,200),oPlanFauxObjets[y].style.zIndex=oPlanFauxObjets2[y].style.zIndex=2}m(oPlanBananes,items.banane,"banane",oObjWidth,oPlanCtn),m(oPlanBananes2,items.banane,"banane",oObjWidth2,oPlanCtn2);for(y=0;y<items.banane.length;y++){var f=items.banane[y];d(oPlanBananes[y],f.x,f.y,oObjWidth,oPlanSize,f.team,100),d(oPlanBananes2[y],f.x,f.y,oObjWidth2,oPlanSize2,f.team,100),oPlanBananes[y].style.zIndex=oPlanBananes2[y].style.zIndex=2}m(oPlanPoisons,items.poison,"poison",oObjWidth,oPlanCtn),m(oPlanPoisons2,items.poison,"poison",oObjWidth2,oPlanCtn2);for(y=0;y<items.poison.length;y++){var S=items.poison[y];d(oPlanPoisons[y],S.x,S.y,oObjWidth,oPlanSize,S.team,100),d(oPlanPoisons2[y],S.x,S.y,oObjWidth2,oPlanSize2,S.team,100),oPlanPoisons[y].style.zIndex=oPlanPoisons2[y].style.zIndex=2}m(oPlanChampis,items.champi,"champi",oObjWidth,oPlanCtn),m(oPlanChampis2,items.champi,"champi",oObjWidth2,oPlanCtn2);for(y=0;y<items.champi.length;y++){var v=items.champi[y];d(oPlanChampis[y],v.x,v.y,oObjWidth,oPlanSize,-1,100),d(oPlanChampis2[y],v.x,v.y,oObjWidth2,oPlanSize2,-1,100),oPlanChampis[y].style.zIndex=oPlanChampis2[y].style.zIndex=2}function b(e,t){switch(t){case 0:e="explosionB";break;case 1:e="explosionR"}return"images/map_icons/"+e+".png"}function M(e,t,n,a,o){m(e,items.bobomb,"bob-omb",t,n);for(var i=0;i<items.bobomb.length;i++){var r=items.bobomb[i];r.cooldown<=0?(posImg(e[i],r.x,r.y,Math.round(s.rotation),o,a).src=b("explosion",r.team),e[i].style.width=o+"px",e[i].style.opacity=Math.max(1+r.cooldown/10,0),e[i].style.background=""):d(e[i],r.x,r.y,t,a,r.team,100).style.zIndex=2}}M(oPlanBobOmbs,oObjWidth,oPlanCtn,oPlanSize,oExpWidth),M(oPlanBobOmbs2,oObjWidth2,oPlanCtn2,oPlanSize2,oExpWidth2),m(oPlanCarapaces,items.carapace,"carapace",oObjWidth,oPlanCtn),m(oPlanCarapaces2,items.carapace,"carapace",oObjWidth2,oPlanCtn2);for(y=0;y<items.carapace.length;y++){var x=items.carapace[y];d(oPlanCarapaces[y],x.x,x.y,oObjWidth,oPlanSize,x.team,200),d(oPlanCarapaces2[y],x.x,x.y,oObjWidth2,oPlanSize2,x.team,200).style.zIndex=2}m(oPlanCarapacesRouges,items["carapace-rouge"],"carapace-rouge",oObjWidth,oPlanCtn),m(oPlanCarapacesRouges2,items["carapace-rouge"],"carapace-rouge",oObjWidth2,oPlanCtn2);for(y=0;y<items["carapace-rouge"].length;y++){var C=items["carapace-rouge"][y];d(oPlanCarapacesRouges[y],C.x,C.y,oObjWidth,oPlanSize,C.team,200),d(oPlanCarapacesRouges2[y],C.x,C.y,oObjWidth2,oPlanSize2,C.team,200).style.zIndex=2,C.owner&&(oPlanCarapacesRouges[y].style.zIndex=2)}function P(e,t,n,a,o){m(e,items["carapace-bleue"],"carapace-bleue",t,o);for(var i=0;i<items["carapace-bleue"].length;i++){var r=items["carapace-bleue"][i];r.cooldown<=0?(posImg(e[i],r.x,r.y,Math.round(s.rotation),a,n).src=b("explosionB",r.team),e[i].style.width=a+"px",e[i].style.opacity=Math.max(1+r.cooldown/10,0),e[i].style.background=""):d(e[i],r.x,r.y,t,n,r.team,200).style.zIndex=2}}P(oPlanCarapacesBleues,oObjWidth,oPlanSize,oExpBWidth,oPlanCtn),P(oPlanCarapacesBleues2,oObjWidth2,oPlanSize2,oExpBWidth2,oPlanCtn2);for(var k=new Array,w=new Array,y=0;y<aKarts.length;y++)aKarts[y].etoile?k.push(aKarts[y]):aKarts[y].billball&&w.push(aKarts[y]);m(oPlanEtoiles,k,"etoile",oObjWidth,oPlanCtn),m(oPlanEtoiles2,k,"etoile",oObjWidth2,oPlanCtn2);for(y=0;y<k.length;y++)d(oPlanEtoiles[y],k[y].x,k[y].y,oObjWidth,oPlanSize),d(oPlanEtoiles2[y],k[y].x,k[y].y,oStarWidth2,oPlanSize2).style.width=oStarWidth2+"px",oPlanEtoiles[y].style.zIndex=oPlanEtoiles2[y].style.zIndex=2;m(oPlanBillballs,w,"billball",oObjWidth,oPlanCtn),m(oPlanBillballs2,w,"billball",oObjWidth2,oPlanCtn2);for(y=0;y<w.length;y++)posImg(oPlanBillballs[y],w[y].x,w[y].y,Math.round(s.rotation),oBBWidth,oPlanSize).style.width=oBBWidth+"px",posImg(oPlanBillballs2[y],w[y].x,w[y].y,Math.round(s.rotation),oBBWidth2,oPlanSize2).style.width=oBBWidth2+"px",oPlanBillballs[y].style.zIndex=oPlanBillballs2[y].style.zIndex=2}function removePlan(){try{document.body.removeChild(oPlanDiv)}catch(e){}try{document.body.removeChild(oPlanDiv2)}catch(e){}}function loadMap(){var e,t=isCup?complete?oMap.img:"mapcreate.php"+oMap.map:"images/maps/map"+oMap.map+"."+oMap.ext;(gameSettings=(gameSettings=localStorage.getItem("settings"))?JSON.parse(gameSettings):{}).rtime&&(cycle=function(){cycleHandler=setTimeout(cycle,SPF),runOneFrame()}),(oMap.ext?"gif"===oMap.ext:t.match(/\.gif$/g))?gameSettings.nogif?((e=new Image).onload=function(){(oMapImg=document.createElement("canvas")).width=e.naturalWidth,oMapImg.height=e.naturalHeight,oMapImg.getContext("2d").drawImage(e,0,0),startGame()},e.src=t):((oMapImg=GIF()).onloadone=startGame,oMapImg.onloadall=function(){oPlanImg&&(oPlanImg.src=t),oPlanImg2&&(oPlanImg2.src=t)},oMapImg.load(t)):((oMapImg=new Image).onload=startGame,oMapImg.src=t),oMap.assets=[];for(var n=["oils","pivots","pointers","flippers","bumpers","flowers"],a=0;a<n.length;a++){var o=n[a];if(oMap[o]){function r(e){var t=this.canvas.getContext("2d");t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width,this.canvas.height);var n=e[1][2],a=e[1][3],o=Math.max(n,a),i=e[2][2];t.translate(o/2,o/2),t.rotate(i),t.translate(-o/2,-o/2);try{t.drawImage(this.img,(o-n)/2,(o-a)/2,n,a)}catch(e){}var r=Math.cos(i),l=Math.sin(i),s=.5-e[2][0],i=.5-e[2][1];this.x=e[1][0]-o/2+s*n*r-i*a*l,this.y=e[1][1]-o/2+i*a*r+s*n*l}for(var i=0;i<oMap[o].length;i++)!function(e,t){var n=document.createElement("canvas");n.width=n.height=Math.max(t[1][2],t[1][3]);var a=new Image,o="assets/"+t[0];a.src="images/map_icons/"+o+".png";var i={img:a,canvas:n,src:o,redraw:r,x:t[1][0],y:t[1][1],w:t[1][2],h:t[1][3]};a.onload=function(){i.redraw(t)},t[0]=i,"flippers"===e&&(t[3]=[0,16+Math.floor(16*Math.random())]),oMap.assets.push(i)}(o,oMap[o][i])}}1<strPlayer.length&&updateCtnFullScreen(!1),formulaire.screenscale.disabled=!0,formulaire.quality.disabled=!0,formulaire.music.disabled=!0,formulaire.sfx.disabled=!0,iTeamPlay=isTeamPlay(),setSRest(),document.body.style.cursor="progress";for(a=0;a<strPlayer.length;a++){var l=a*(iWidth*iScreenScale+2),s=document.createElement("div");s.style.position="absolute",s.style.left=oContainers[a].style.left,s.style.top=oContainers[a].style.top,s.style.width=iWidth*iScreenScale+"px",s.style.height=iHeight*iScreenScale+"px";var c=document.createElement("div");c.id="temps"+a,c.style.right=Math.round(.6*iScreenScale+1)+"px",c.style.top=Math.round(.4*iScreenScale+3)+"px",c.style.fontSize=Math.round(2.4*iScreenScale)+"px";var p=Math.round(iScreenScale/8)+"px",u=Math.round(iScreenScale/4)+"px";c.style.textShadow="-"+u+" 0 black, 0 "+u+" black, "+u+" 0 black, 0 -"+u+" black, -"+p+" -"+p+" black, -"+p+" "+p+" black, "+p+" -"+p+" black, "+p+" "+p+" black",s.appendChild(c);var d=document.createElement("div");if(d.id="compteur"+a,d.style.left=Math.round(iScreenScale/2)+"px",d.style.bottom=(course,Math.round(iScreenScale/4)+"px"),d.style.fontSize=Math.round(2.4*iScreenScale)+"px",!pause||!fInfos.replay)if("BB"!=course){d.innerHTML='<div></div><div class="glow"></div>';for(var m=d.querySelectorAll("div"),i=0;i<m.length;i++)m[i].style.height=Math.round(2.4*iScreenScale)+"px",m[i].innerHTML="<div>"+(oMap.sections?"SECTION":toLanguage("LAP","TOUR"))+' <span class="tour">1</span>/'+oMap.tours+"</div>",i||(p=Math.round(iScreenScale/8)+"px",u=Math.round(iScreenScale/4)+"px",m[i].style.textShadow="-"+u+" 0 black, 0 "+u+" black, "+u+" 0 black, 0 -"+u+" black, -"+p+" -"+p+" black, -"+p+" "+p+" black, "+p+" -"+p+" black, "+p+" "+p+" black")}else updateBalloonHud(d,{reserve:4,team:aTeams[a]});s.appendChild(d);var h=document.createElement("div");h.id="drift"+a;var y=document.createElement("img");y.alt=".",y.src="images/drift.png",y.className="driftimg pixelated",h.appendChild(y),s.appendChild(h);c=document.createElement("div");c.id="objet"+a,pause&&fInfos.replay||(c.style.left=Math.round(iScreenScale)+"px",c.style.top=Math.round(iScreenScale)+"px",c.style.width=Math.round(26*iScreenScale/3)+"px",c.style.height=Math.round(18*iScreenScale/3)+"px",c.style.visibility="visible");d=document.createElement("div");d.id="roulette"+a,c.appendChild(d),s.appendChild(c);c=document.createElement("div");c.id="lakitu"+a,c.className="pixelated",c.innerHTML="<div></div>",c.style.width=9*iScreenScale+"px",c.style.height=Math.round(6.6*iScreenScale)+"px",c.style.fontSize=Math.round(2.3*iScreenScale)+"px",s.appendChild(c),y.style.width=8*iScreenScale+"px",h.style.left=36*iScreenScale+"px",h.style.top=Math.round(32*iScreenScale)+"px",y.style.left="0px",y.style.top="0px";y=document.createElement("div");y.id="infoPlace"+a,y.style.right=Math.round(iScreenScale/2)+"px",y.style.bottom="0px",y.style.fontSize=8*iScreenScale+"px",s.appendChild(y);y=document.getElementById("infos"+a);y||((y=document.getElementById("infos0").cloneNode(!0)).id="infos"+a,$mkScreen.appendChild(y)),y.style.left=10+l+"px",y.style.top=10*iScreenScale+"px",y.style.width=iWidth*iScreenScale+"px",y.style.fontSize=16*iScreenScale+"px",y.style.fontFamily='"NSMBU", Impact',y.style.textAlign="center",y.style.textStroke=y.style.WebkitTextStroke=y.style.MozTextStroke=Math.round(iScreenScale/4)+"px "+primaryColor,y.style.visibility="hidden",y.style.display="",y.innerHTML='<tr><td id="decompte'+a+'">3</td></tr>';y=document.getElementById("scroller").cloneNode(!0);y.id="scroller"+a;y.style.left=Math.round(iScreenScale)+"px",y.style.top=Math.round(iScreenScale+ +iScreenScale)+"px",y.style.width=Math.round(26*iScreenScale/3)+"px",y.style.height=Math.round(18*iScreenScale/3-2*iScreenScale*1)+"px",y.style.lineHeight=iScreenScale+"px",s.appendChild(y),$mkScreen.appendChild(s),hudScreens[a]=s}(oChallengeCpts=document.createElement("div")).id="challenge-cpts",oChallengeCpts.style.right=Math.round(.85*iScreenScale)+"px",oChallengeCpts.style.top=Math.round(3.2*iScreenScale)+"px",oChallengeCpts.style.fontSize=Math.round(1.9*iScreenScale)+"px",oChallengeCpts.style.visibility="hidden",s.appendChild(oChallengeCpts),initMap();for(var g=Math.round(4*iScreenScale),i=0;i<document.getElementsByClassName("aObjet").length;i++)document.getElementsByClassName("aObjet")[i].style.height=g+"px";removeMenuMusic(),bMusic&&!isOnline&&loadMapMusic()}function getShapeType(e){return"number"==typeof e[0]?"rectangle":"polygon"}function classifyByShape(e){for(var t={rectangle:[],polygon:[]},n=0;n<e.length;n++)t[getShapeType(e[n])].push(e[n]);return t}function initMap(){if(oMap.collision&&(oMap.collision=classifyByShape(oMap.collision)),oMap.pivots)for(var e=0;e<oMap.pivots.length;e++){var t=oMap.pivots[e][1],n=t[0],a=t[1],o=Math.round(t[2]/2),i=Math.round(t[3]/2);oMap.collision.polygon.push([[n-o,a],[n,a-i],[n+o,a],[n,a+i]])}if(oMap.horspistes)for(var r in oMap.horspistes)oMap.horspistes[r]=classifyByShape(oMap.horspistes[r]);if(oMap.flowers)for(e=0;e<oMap.flowers.length;e++){var l=oMap.flowers[e][1],n=l[0],a=l[1],o=Math.round(l[2]/2),i=Math.round(l[3]/2);oMap.horspistes.herbe.rectangle.push([n-o,a-o,2*o,2*i])}if(oMap.trous)for(e=0;e<4;e++){for(var s={rectangle:[],polygon:[]},c=0;c<oMap.trous[e].length;c++){var p=oMap.trous[e][c];6==p.length&&(p=[[p[0],p[1],p[2],p[3]],[p[4],p[5]]]),s[getShapeType(p[0])].push(p)}oMap.trous[e]=s}if(oMap.flows){for(var u={rectangle:[],polygon:[]},e=0;e<oMap.flows.length;e++){var d=oMap.flows[e];u[getShapeType(d[0])].push(d)}oMap.flows=u}if(oMap.accelerateurs)for(e=0;e<oMap.accelerateurs.length;e++)(m=oMap.accelerateurs[e])[2]?(m[2]++,m[3]++):(m[2]=9,m[3]=9);if(oMap.sauts)for(var m,e=0;e<oMap.sauts.length;e++)(m=oMap.sauts[e]).length<5&&(m[4]=(m[2]+m[3])/45+1);if(oMap.cannons){for(var h={rectangle:[],polygon:[]},e=0;e<oMap.cannons.length;e++){var y=oMap.cannons[e];h[getShapeType(y[0])].push(y)}oMap.cannons=h}if(oMap.sea){var g=oMap.sea.waves;oMap.sea.projections=[];for(e=0;e<g.length;e++){for(var f=g[e][0],S=g[e][1],v=[],b=0,c=0;c<S.length;c++){for(var M,x,C,P=S[c][0],k=S[c][1],w=1/0,I=0;I<f.length;I++){var T=I,E=(I+1)%f.length;1<(z=projete(P,k,f[T][0],f[T][1],f[E][0],f[E][1]))&&(z=1),z<0&&(z=0);var L=f[T][0]+z*(f[E][0]-f[T][0]),B=f[T][1]+z*(f[E][1]-f[T][1]),z=(L-P)*(L-P)+(B-k)*(B-k);z<w&&(w=z,M=L,x=B,C=T)}C<b&&(C+=f.length);for(I=b;I<C;I++){E=(I+1)%f.length;v.push([P,k,f[E][0],f[E][1]])}b=C%f.length,v.push([P,k,M,x])}oMap.sea.projections.push(v)}function D(e,t){return[e[2]+(e[0]-e[2])*t,e[3]+(e[1]-e[3])*t]}oMap.sea.progress=.9999,oMap.sea.offroad0=oMap.horspistes.eau.polygon,oMap.sea.drawPolygon=function(e,t,n,a){e.beginPath();for(var o=0;o<t.length;o++){var i=t[o],i=[(i[0]-n[0])*a,(i[1]-n[1])*a];o?e.lineTo(i[0],i[1]):e.moveTo(i[0],i[1])}e.closePath(),e.fill(),e.stroke()},oMap.sea.render=function(e,t,n){var a=this.progress,o=this.waves,i=.99*a,r=a-.25*(1-a/2),l=a-.04*(1-a/3);if(e.lineWidth=1,0<r){e.fillStyle=e.strokeStyle=this.colors.water;for(var s=0;s<o.length;s++){var c=this.polygon(s,0,i);this.drawPolygon(e,c,t,n)}}else r=0;if(0<l){e.fillStyle=e.strokeStyle=this.colors.wave;for(s=0;s<o.length;s++){c=this.polygon(s,r,i);this.drawPolygon(e,c,t,n)}}else l=0;if(.005<a){e.fillStyle=e.strokeStyle=this.colors.foam;for(s=0;s<o.length;s++){c=this.polygon(s,l,1.04*a);this.drawPolygon(e,c,t,n)}}},oMap.sea.polygon=function(e,t,n){var a=this.waves[e][0],o=[],i=this.projections[e];if(t){s=D(i[0],t),o.push(s);for(var r=0;r<i.length;r++){var l=D(i[r],t);o.push(l)}o.push(s)}else{s=a[0],o.push(s);for(r=1;r<a.length;r++){l=a[r];o.push(l)}o.push(s)}var e=i.length-1,s=D(i[e],n);o.push(s);for(r=e-1;0<=r;r--){l=D(i[r],n);o.push(l)}return o.push(s),o}}}var timer=0,timerMS,lapTimers=new Array,oLapTimeDiv;iScreenScale=optionOf("screenscale");var fMaxRotInc=6,fTurboDriftCpt=80,fTurboDriftCpt2=160;function throwItem(e,t,n){var a=e.using[n||0];if(a){for(var o in t)a[o]=t[o];isOnline&&syncItems.push(a),e.using.shift()}}function loadNewItem(e,t){addNewItem(e,t),e.using.push(t)}function addNewItem(e,t){var n,a=t.type,o=itemBehaviors[a];if(!1!==o.sprite&&(t.sprite=new Sprite(a),t.size=o.size),items[a].push(t),isOnline?!e||e.id!=identifiant&&e.controller!=identifiant||syncItems.push(t):e==oPlayers[0]&&clLocalVars.myItems&&clLocalVars.myItems.push(t),-1!=t.team){switch(a){case"champi":break;case"banane":n=50;break;case"poison":n=60;break;case"carapace":case"carapace-rouge":n=60;break;case"fauxobjet":n=65;break;case"carapace-bleue":n=60;break;case"bobomb":n=40;break;default:n=60}if(n){var i=50-n,r=50-n;switch(a){case"banane":case"poison":case"bobomb":r+=5;break;case"fauxobjet":r-=5}for(var l=0;l<oPlayers.length;l++){var s,c=document.createElement("div");c.className="sprite-hallow",c.style.position="absolute",c.style.left=i+"%",c.style.top=r+"%",c.style.width=2*n+"%",c.style.height=2*n+"%",c.style.borderRadius=n+"%",c.style.backgroundColor=t.team?"red":"blue",c.style.opacity=.25,t.sprite&&((s=t.sprite[l].div.firstChild)?t.sprite[l].div.insertBefore(c,s):t.sprite[l].div.appendChild(c))}}}}function arme(e,t){var n=aKarts[e];if(n.using.length){var a=n.x,o=n.y;switch(n.using[0].type){case"banane":tombe(s=a-(l=30/(n.speed+5))*direction(0,n.rotation),c=o-l*direction(1,n.rotation))||throwItem(n,{x:s,y:c,z:0}),playIfShould(n,"musics/events/put.mp3");break;case"fauxobjet":throwItem(n,{x:a-(l=30/(n.speed+5))*direction(0,n.rotation),y:o-l*direction(1,n.rotation),z:0}),playIfShould(n,"musics/events/put.mp3");break;case"poison":tombe(s=a-(l=30/(n.speed+5))*direction(0,n.rotation),c=o-l*direction(1,n.rotation))||throwItem(n,{x:s,y:c,z:0}),playIfShould(n,"musics/events/put.mp3");break;case"carapace":var i=dirShoot(n,t,3.2),r=angleShoot(n,t),l=i[0],s=i[1],c=(c=Math.hypot(l,s))||1,i=t?7.5:6+c;1<n.using.length&&(i+=5),throwItem(n,{x:a+i*l/c,y:o+i*s/c,z:0,vx:l,vy:s,owner:n.id,lives:10}),playDistSound(n,"musics/events/throw.mp3",50);break;case"carapace-rouge":r=angleShoot(n,t),i=7.5;t?1<n.using.length&&(i*=1.5):(i*=1.5,i+=n.speed,1<n.using.length&&(i*=4/3)),throwItem(n,t?{x:a+i*direction(0,r),y:o+i*direction(1,r),z:0,theta:r,owner:n.id,aipoint:-2,aimap:-1,target:-1}:{x:a+i*direction(0,r),y:o+i*direction(1,r),z:0,theta:r,owner:n.id,aipoint:-1,aimap:-1,target:-1}),playDistSound(n,"musics/events/throw.mp3",50);break;case"bobomb":r=angleShoot(n,t);throwItem(n,t?{x:a+5*direction(0,r),y:o+5*direction(1,r),z:0,theta:r,countdown:2,cooldown:42}:{x:a,y:o,z:0,theta:r,countdown:15,cooldown:30}),playDistSound(n,"musics/events/throw.mp3",50);break;default:return}}else if(25==n.roulette){n==oPlayers[0]&&(clLocalVars.itemsUsed=!0);var p,u,d,m,h=n.arme;switch(n.arme){case"champi":case"champiX2":case"champiX3":h="champi",p=20,n.maxspeed=11,n.speed=11,playIfShould(n,"musics/events/boost.mp3");break;case"champior":h="champi",n.champi<12&&(p=20,n.maxspeed=11,n.speed=11,playIfShould(n,"musics/events/boost.mp3"),n.champior||(n.champior=70));break;case"etoile":p=80;for(var y=0;y<strPlayer.length;y++)n.sprite[y].img.src=getStarSrc(n.personnage);n.cpu||n.etoile||(isOnline||(n.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},interruptGame(),bCounting=!0),shouldPlaySound(n)&&!oPlayers[1]&&postStartMusic("musics/events/starman.mp3")),0<n.speedinc&&(n.speedinc*=5),delete n.shift,n.protect=!0;break;case"billball":p=Math.max(Math.min(Math.round(distanceToFirst(n)/9),120),40);for(y=0;y<strPlayer.length;y++)n.sprite[y].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(n.sprite[y]);n.cpu||isOnline||(n.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},interruptGame(),bCounting=!0),n.rotinc=0,n.size=2.5,n.mini=0,n.z=2,n.protect=!0,n.champi=0,delete n.shift,resetPowerup(n),playIfShould(n,"musics/events/boost.mp3"),stopDrifting(e);break;case"megachampi":p=80,n.size=1,n.mini=0,updateDriftSize(e),n.protect=!0,n.megachampi||!shouldPlaySound(n)||oPlayers[1]||postStartMusic("musics/events/megamushroom.mp3");break;case"banane":loadNewItem(n,{type:"banane",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z}),playIfShould(n,"musics/events/item_store.mp3");break;case"bananeX3":for(y=0;y<3;y++)loadNewItem(n,{type:"banane",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z});n.rotitem=0,playIfShould(n,"musics/events/item_store.mp3");break;case"fauxobjet":loadNewItem(n,{type:"fauxobjet",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z}),playIfShould(n,"musics/events/item_store.mp3");break;case"poison":loadNewItem(n,{type:"poison",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z}),playIfShould(n,"musics/events/item_store.mp3");break;case"carapace":loadNewItem(n,{type:"carapace",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z,vx:0,vy:0,owner:-1,lives:10}),playIfShould(n,"musics/events/item_store.mp3");break;case"carapaceX3":for(y=0;y<3;y++)loadNewItem(n,{type:"carapace",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z,vx:0,vy:0,owner:-1,lives:10});n.rotitem=0,playIfShould(n,"musics/events/item_store.mp3");break;case"carapacerouge":loadNewItem(n,{type:"carapace-rouge",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z,theta:-1,owner:-1,aipoint:-1,aimap:-1,target:-1}),playIfShould(n,"musics/events/item_store.mp3");break;case"carapacerougeX3":for(y=0;y<3;y++)loadNewItem(n,{type:"carapace-rouge",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z,theta:-1,owner:-1,aipoint:-1,aimap:-1,target:-1});n.rotitem=0,playIfShould(n,"musics/events/item_store.mp3");break;case"carapacebleue":var g=1/0,f=0,S=0;if("BB"!=course)for(y=0;y<oMap.aipoints.length;y++)for(var v=oMap.aipoints[y],b=0;b<v.length;b++){var M=v[b],x=v[(b||v.length)-1],C=Math.hypot(M[0]-n.x,M[1]-n.y);0<(M[0]-n.x)*(M[0]-x[0])+(M[1]-n.y)*(M[1]-x[1])||(C+=oMap.w+oMap.h);var P=n.demitours+1;P>=oMap.checkpoint.length&&(P=0);var k,w=oMap.checkpoint[P];w&&(k=w[0]+(w[3]?Math.round(w[2]/2):8),P=w[1]+(w[3]?8:Math.round(w[2]/2)),(w=Math.hypot(k-n.x,P-n.y)*Math.hypot(M[0]-x[0],M[1]-x[1]))&&(C-=150*((k-n.x)*(M[0]-x[0])+(P-n.y)*(M[1]-x[1]))/w)),C<g&&(S=y,f=b,g=C)}addNewItem(n,{type:"carapace-bleue",team:n.team,x:n.x,y:n.y,z:15,target:-1,aipoint:f,aimap:S,cooldown:itemBehaviors["carapace-bleue"].cooldown0}),playDistSound(n,"musics/events/throw.mp3",50);break;case"bobomb":loadNewItem(n,{type:"bobomb",team:n.team,x:n.x-5*direction(0,n.rotation),y:n.y-5*direction(1,n.rotation),z:n.z,theta:-1,countdown:15,cooldown:30}),playIfShould(n,"musics/events/item_store.mp3");break;case"eclair":addNewItem(n,{type:"eclair",owner:n.id});break;case"bloops":addNewItem(n,{type:"bloops",owner:n.id})}switch(p&&(n[h]=p),n.arme){case"champiX2":u="champi";break;case"champiX3":u="champiX2";break;case"champior":u="champior"}u?n.arme!==u?(n.arme=u,kartIsPlayer(n)&&updateObjHud(e)):kartIsPlayer(n)&&"champior"===u&&(d=document.getElementById("roulette"+e).getElementsByTagName("img")[0],m=0,function e(){var t=(++m-3)/3,t=.8+.2*t*t;1<=t?d.style.transform="":(d.style.transform="scale("+t+")",setTimeout(e,SPF))}()):supprArme(e)}}var aKarts=new Array,bRunning=!1,bCounting=!1,musicIdInc=0,mapMusic,endingMusic,endGPMusic,challengeMusic,carEngine,carEngine2,carEngine3,carDrift,carSpark;function loadMusic(e,t){var n,a,o=isOriginalMusic(e);return o?(a=document.createElement("audio")).setAttribute("loop",!0):(n=youtube_parser(e),(a=document.createElement("iframe")).id="youtube-video-"+musicIdInc++,a.src="https://www.youtube.com/embed/"+n+"?"+(t?"autoplay=1&amp;":"")+"loop=1&amp;playlist="+n+"&amp;enablejsapi=1&amp;allow=autoplay",a.setAttribute("enablejsapi",1),a.setAttribute("allow","autoplay")),a.className="gamemusic",o&&((o=document.createElement("source")).type="audio/mpeg",a.src=e,a.appendChild(o),t&&a.setAttribute("autoplay",!0)),a}function pauseMusic(e){isOriginalEmbed(e)?e.pause():onPlayerReady(e,function(e){e.pauseVideo()}),oMusicEmbed==e&&(oMusicEmbed=void 0)}function bufferMusic(e){isOriginalEmbed(e)||onPlayerReady(e,function(e){e.setVolume(0),e.playVideo(),setTimeout(function(){e.seekTo(0,!0),e.setVolume(100),e.pauseVideo()},1e3)})}function stopMusic(e){e&&(e.permanent?pauseMusic:removeIfExists)(e)}function unpauseMusic(e){document.body.contains(e)&&(isOriginalEmbed(e)?e.play():onPlayerReady(e,function(e){e.playVideo()}),oMusicEmbed=e)}function muteSound(e){isOriginalEmbed(e)?e.muted=!0:onPlayerReady(e,function(e){e.mute()})}function unmuteSound(e){isOriginalEmbed(e)?e.muted=!1:onPlayerReady(e,function(e){e.unMute()})}function onPlayerReady(t,e){try{t.yt?t.tasks?t.tasks.push(e):e(t.yt):(t.tasks=[e],t.yt=new YT.Player(t.id,{events:{onReady:function(){for(var e=0;e<t.tasks.length;e++)t.tasks[e](t.yt);t.tasks=void 0}}}))}catch(e){}}function updateMusic(e,t){e!=oMusicEmbed&&removeIfExists(oMusicEmbed),document.body.contains(e)&&(isOriginalEmbed(e)?t&&(e.volume=1,e.currentTime=0,e.play(),e.playbackRate=1.2):onPlayerReady(e,function(e){t&&(e.setPlaybackRate(1.25),e.seekTo(0,!0),e.setVolume(100),e.playVideo())}),oMusicEmbed=e)}function fastenMusic(e){isOriginalEmbed(e)?e.playbackRate=1.2:onPlayerReady(e,function(e){e.setPlaybackRate(1.25)})}function shouldPlaySound(e){return iSfx&&kartIsPlayer(e)&&!finishing&&!e.loose}function shouldPlayMusic(e){return bMusic&&kartIsPlayer(e)&&!finishing&&!e.loose}function playIfShould(e,t){if(shouldPlaySound(e))return playSoundEffect(t)}function playSoundEffect(e){e=loadMusic(e,!0);return e.removeAttribute("loop"),e.onended=function(){document.body.removeChild(this)},document.body.appendChild(e),e}function playDistSound(e,t,n){if(iSfx){e=n/distKart(e);if(1<=e){t=playSoundEffect(t);return t.volume=Math.min(.05*e*e,1),t}}}function startMusic(e,t,n){var a,o=loadMusic(e,t);return document.body.appendChild(o),n?(pauseMusic(o),a=oMusicEmbed,setTimeout(function(){oMusicEmbed==o&&(stopMusic(a),unpauseMusic(o))},n),oMusicEmbed=o):t&&(stopMusic(oMusicEmbed),oMusicEmbed=o),o}function postStartMusic(e){return oMusicEmbed&&fadeOutMusic(oMusicEmbed,1,.6,!1),startMusic(e,!0,200)}function postResumeMusic(e,t){var n;oMusicEmbed!=e&&(fadeOutMusic(n=oMusicEmbed,1,t,!0),e&&setTimeout(function(){oMusicEmbed!=n&&oMusicEmbed||(fadeInMusic(e,.2,t),unpauseMusic(e))},500))}function stopStarMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.9)}function stopMegaMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.92)}function resetPowerup(e){e.etoile&&(e.etoile=0,stopStarMusic(e)),e.megachampi&&(e.megachampi=0,stopMegaMusic(e))}function isOriginalMusic(e){return-1!=e.indexOf("mp3")}function isOriginalEmbed(e){return"audio"==e.tagName.toLowerCase()}var willPlayEndMusic=!1,isEndMusicPlayed=!1,forceStartMusic=!1,forcePrepareEnding=!1,playingCarEngine,oMusicEmbed;function loadMapMusic(){var e;startMapMusic(!1),loadEndingMusic(),mapMusic.blur(),endingMusic.blur(),isMobile()||isChatting()||(e=document.createElement("input"),document.body.appendChild(e),e.focus(),e.blur(),document.body.removeChild(e))}function startMapMusic(e){e?updateMusic(mapMusic,!0):((mapMusic=startMusic(oMap.music?"musics/maps/map"+oMap.music+".mp3":oMap.yt)).permanent=1,bufferMusic(mapMusic))}function loadEndingMusic(){var e=getEndingSrc(strPlayer[0]);(endingMusic=startMusic(e)).permanent=1,bufferMusic(endingMusic)}function loopWithoutGap(){playingCarEngine!=this||this.currentTime>this.duration-.44&&(this.currentTime=0,this.play())}function loopAfterIntro(e,t,n){var a;e.looper||(a=t+(n-=.15),e.looper=function(){this.currentTime>=a&&(this.currentTime-=n)},e.addEventListener("timeupdate",e.looper,!1))}function startEngineSound(){carEngine=loadMusic("musics/events/engine.mp3",!0),carEngine2=loadMusic("musics/events/engine2.mp3",!1),carEngine3=loadMusic("musics/events/engine3.mp3",!1),carDrift=loadMusic("musics/events/drift.mp3",!1),carSpark=loadMusic("musics/events/spark.mp3",!1),(playingCarEngine=carEngine).addEventListener("timeupdate",loopWithoutGap,!1),carEngine2.addEventListener("timeupdate",loopWithoutGap,!1),carEngine.permanent=1,carEngine2.permanent=1,carEngine3.permanent=1,carDrift.permanent=1,carSpark.permanent=1,document.body.appendChild(carEngine),document.body.appendChild(carEngine2),document.body.appendChild(carEngine3),document.body.appendChild(carDrift),document.body.appendChild(carSpark)}function updateEngineSound(e){iSfx&&e!=playingCarEngine&&(playingCarEngine&&playingCarEngine.pause(),(playingCarEngine=e)&&playingCarEngine.play())}function startEndMusic(){bMusic&&(removeMenuMusic(!0),removeIfExists(mapMusic)),iSfx&&(playingCarEngine=void 0,removeIfExists(carEngine),removeIfExists(carEngine2),removeIfExists(carEngine3),removeIfExists(carDrift),removeIfExists(carSpark)),bMusic&&(willPlayEndMusic=!0,setTimeout(function(){for(var e=document.getElementsByClassName("gamemusic"),t=[],n=0;n<e.length;n++)e[n].permanent||t.push(e[n]);for(n=0;n<t.length;n++)document.body.removeChild(t[n]);willPlayEndMusic&&(isEndMusicPlayed=!(willPlayEndMusic=!1),unpauseMusic(endingMusic))},200)),iSfx&&"BB"!=course&&(playSoundEffect("musics/events/goal.mp3").className="")}function handleEndRace(){(bMusic||iSfx)&&startEndMusic();var e=["next_circuit"];challengeCheck("end_game",e),challengeCheck("end_gp",e),clGlobalVars.nbcircuits++}function startGame(){resetScreen();var a=strPlayer.length+aPlayers.length;if(!isOnline)if("BB"==course)for(var e=0;e<a;e++)aPlaces[e]=e+1;else"CM"==course&&(aPlaces=[1]);var t=oMap.sections?oMap.checkpoint.length-1:0,n=null==oMap.startrotation?180:oMap.startrotation,o=oMap.startdirection||0,i=n*Math.PI/180,r=Math.cos(i),l=Math.sin(i),s=27,c=130,p=Math.max(2,Math.round((1+Math.sqrt((c+4*(a-1)*s)/c))/2));function u(e,t){var n=((t+1)%p-(p-1)/2)*s/(p-.5),t=t*Math.min(12,c/a);o||(n=-n),n+=9,e.x-=n*r+t*l,e.y+=n*l-t*r}function d(e){return{acceleration:.2+.8*Math.pow(e[0],2),speed:.875+.25*e[1],handling:.2+.8*e[2],mass:.5+e[3]}}for(e=0;e<strPlayer.length;e++){var m=aPlaces[e],h={id:e,x:oMap.startposition[0],y:oMap.startposition[1],z:0,personnage:strPlayer[e],speed:0,speedinc:0,heightinc:0,stats:d(cp[strPlayer[e]]),rotation:n,rotincdir:0,rotinc:0,changeView:0,size:1,sprite:new Sprite(strPlayer[e]),cpu:!1,aipoints:oMap.aipoints[0],tourne:0,tombe:0,protect:!1,roulette:0,arme:!1,maxspeed:5.7,driftinc:0,driftcpt:0,drift:0,turbodrift:0,jumped:!1,champi:0,etoile:0,megachampi:0,mini:0,using:[]};isOnline&&(h.id=identifiant),isOnline&&(h.nick=aPseudos[e]),h.team=iTeamPlay?aTeams[e]:-1,"BB"!=course?(u(h,m),h.time=0,h.tours=1,h.demitours=t,h.billball=0):(v=(S=isOnline?m-1:e)%oMap.startposition.length,h.x=oMap.startposition[v][0],h.y=oMap.startposition[v][1],h.rotation=90*oMap.startposition[v][2],h.loose=!1,h.ballons=[createBalloonSprite(h)],h.reserve=4),h.place=m,h.initialPlace=h.place,oPlayers.push(h),aKarts.push(h)}for(e=0;e<aPlayers.length;e++){var y=aPlayers[e],g=e+strPlayer.length,m=aPlaces[g],f=2*(iDificulty-4)+Math.round(Math.random());"BB"==course&&(f=2);var S,v,y={id:g,speed:0,speedinc:.5,heightinc:0,stats:d([.5,.5,.5,cp[y][3]]),rotation:n,rotincdir:0,rotinc:0,x:oMap.startposition[0],y:oMap.startposition[1],z:0,size:1,personnage:y,sprite:new Sprite(y),tourne:0,tombe:0,protect:!1,roulette:0,arme:!1,champi:0,etoile:0,megachampi:0,mini:0,using:[],cpu:!0,aipoint:0,lastAItime:0,aipoints:oMap.aipoints[0],maxspeed:5.7};isOnline?(y.id=aIDs[e],aControllers[e]?y.controller=aControllers[e]:y.cpu=!1):y.aipoints=oMap.aipoints[g%oMap.aipoints.length]||[],isOnline&&(y.nick=aPseudos[g]),y.team=iTeamPlay?aTeams[g]:-1,-1==y.team&&!y.nick||(y.marker=createMarker(y)),"BB"!=course?(u(y,m),y.tours=1,y.demitours=t,y.billball=0,isOnline||(y.speed=f<2?0:5.7,y.tourne=f?0:42),y.place=m):(v=(S=isOnline?m-1:g)%oMap.startposition.length,y.x=oMap.startposition[v][0],y.y=oMap.startposition[v][1],y.rotation=90*oMap.startposition[v][2],y.loose=!1,y.aipoint=oMap.startposition[v][3],simplified&&(y.lastAI=oMap.startposition[v][3]+[-6,-1,6,1][oMap.startposition[v][2]]),y.ballons=[createBalloonSprite(y)],y.reserve=4,y.place=S+1,simplified||(y.speed=y.maxspeed)),y.initialPlace=y.place,aKarts.push(y)}if(oMap.decor){for(var b in oMap.decor){decorBehaviors[b]||(decorBehaviors[b]={type:b});var M=getDecorExtra(C=decorBehaviors[b]);(P=M.custom)&&(decorBehaviors[P.type]&&(Object.assign(C,decorBehaviors[P.type]),C.type=b),function(a){getCustomDecorData(P,function(e){var t,n,e={w:e.size.hd.w/e.original_size.hd.w,h:e.size.hd.h/e.original_size.hd.h};1!==(a.size_ratio=e).w&&(t=a.hitbox||DEFAULT_DECOR_HITBOX,n=1,a.hitbox=n+(t-n)*e.w),1!==e.h&&(t=a.hitboxH||DEFAULT_DECOR_HITBOX_H,n=.8,a.hitboxH=n+(t-n)*e.h)})}(C)),C.preinit&&C.preinit(oMap.decor[b])}var x={};for(b in oMap.decor){var C,P,M=getDecorExtra(C=decorBehaviors[b]),k=(P=M.custom)?P.type:b,g=0;x[k]?g=x[k]:x[k]=0;for(var w=oMap.decor[b],e=0;e<w.length;e++){var I=w[e];I[2]=new Sprite(b),C.init&&C.init(I,e,e+g),gameSettings.ld&&C.hidable?I[2][0].unshow():P&&function(a,o){for(var e=0;e<oPlayers.length;e++)a[2][e].img.src="images/map_icons/empty.png";getCustomDecorData(P,function(e){for(var t=0;t<oPlayers.length;t++){a[2][t].img.src=e.hd,e.size.nb_sprites&&(a[2][t].nbSprites=e.size.nb_sprites),a[2][t].w=Math.round(a[2][t].w*o.size_ratio.w),a[2][t].h=Math.round(a[2][t].h*o.size_ratio.h);var n=(o.size_ratio.w-o.size_ratio.h)/(o.size_ratio.w+o.size_ratio.h);n*=a[2][t].w/(2*a[2][t].h),a[2][t].z+=n}})}(I,C)}x[k]+=w.length}}function T(e){this.tourne||(isOnline?playIfShould(this,"musics/events/spin.mp3"):playDistSound(this,"musics/events/spin.mp3","BB"==course?80:50)),this.frminv=10,this.tourne=e}function E(){return tombe(this.x+this.speed*direction(0,this.rotation),this.y+this.speed*direction(1,this.rotation))}function L(){return ralenti(this.x+this.speed*direction(0,this.rotation),this.y+this.speed*direction(1,this.rotation))}for(e=0;e<aKarts.length;e++){aKarts[e].spin=T,aKarts[e].falling=E,aKarts[e].exiting=L;for(var B=0;B<strPlayer.length;B++)!function(e){e.nbSprites=24,e.img.onload=function(){e.w=this.naturalWidth/e.nbSprites,e.h=this.naturalHeight,delete this.onload}}(aKarts[e].sprite[B])}if(itemDistribution=(itemDistribution=selectedItemDistrib)||itemDistributions[getItemMode()][0].value,"CM"!=course){if(itemDistribution.length)for(e=0;e<oMap.arme.length;e++)oMap.arme[e][2]=0;else oMap.arme=[];for(e=0;e<oPlayers.length;e++){document.getElementById("infoPlace"+e).innerHTML=oPlayers[e].place,document.getElementById("infoPlace"+e).style.display="block";var z=-1!=oPlayers[e].team?oPlayers[e].team?"#F96":"#69F":"";document.getElementById("infoPlace"+e).style.color=z,"BB"!=course&&(document.getElementById("compteur"+e).style.color=z)}}else{oMap.arme=[],aKarts[0].arme="champiX3",aKarts[0].roulette=25;for(e=0;e<gPersos.length;e++){var D=gPersos[e];aKarts.push({speed:f<2?0:5.7,speedinc:.5,heightinc:0,stats:d(cp[D]),rotation:n,rotincdir:0,rotinc:0,x:aKarts[0].x,y:aKarts[0].y,z:0,size:1,personnage:D,sprite:new Sprite(D),tourne:0,tombe:0,protect:!1,roulette:0,arme:!1,champi:0,etoile:0,megachampi:0,using:[],cpu:!1,aipoint:0,aipoints:oMap.aipoints[0],maxspeed:5.7,place:1}),aKarts[aKarts.length-1].sprite[0].div.style.opacity=.5}updateObjHud(0)}gameControls=getGameControls(),challengesForCircuit={end_game:[],each_frame:[],each_hit:[],each_kill:[],each_item:[],each_coin:[],end_gp:[]},clGlobalVars=clGlobalVars||{nbcircuits:0};var H=getMapId(oMap);if(addCreationChallenges("track",H),isCup)if(isMCups)for(O in addCreationChallenges("cup",O=cupIDs[Math.floor((oMap.ref-1)/4)]),challenges.mcup)addCreationChallenges("mcup",O);else for(var O in challenges.cup)addCreationChallenges("cup",O);var A,R,N,V={};for(A in challengesForCircuit)for(var F=challengesForCircuit[A],e=0;e<F.length;e++)V[F[e].id]=!0;for(R in clRuleVars)V[R]||delete clRuleVars[R];if(clSelected&&!V[clSelected.id]&&(clSelected=void 0),reinitLocalVars(),1==strPlayer.length&&!gameSettings.nomap){oPlanWidth=Math.round(19.4*iScreenScale),oPlanWidth2=oMap.w>=oMap.h?oPlanWidth:oPlanWidth*(oMap.w/oMap.h);var j,i=oMap.w<=oMap.h?oPlanWidth:oPlanWidth*(oMap.h/oMap.w);if(oMap.iW&&oMap.iH&&(H=Math.min(oMap.w/oMap.iW,oMap.h/oMap.iH),oPlanWidth2*=H,i*=H),oPlanWidth2=Math.round(oPlanWidth2),i=Math.round(i),oPlanSize=59*iScreenScale,oPlanSize2=oPlanWidth2,oPlanRealSize=oMap.w,oCharRatio=.8,oPlanRatio=.5,(oPlanDiv=document.createElement("div")).style.backgroundColor="rgb("+oMap.bgcolor+")",oPlanDiv.style.position="absolute",oPlanDiv.style.left=15+iScreenScale*iWidth+"px",oPlanDiv.style.top="9px",oPlanDiv.style.width=oPlanWidth+"px",oPlanDiv.style.height=oPlanWidth+"px",oPlanDiv.style.overflow="hidden",(oPlanDiv2=document.createElement("div")).style.backgroundColor="rgb("+oMap.bgcolor+")",oPlanDiv2.style.position="absolute",oPlanDiv2.style.left=15+iScreenScale*iWidth+"px",oPlanDiv2.style.top=10+Math.round(iScreenScale/4)+oPlanWidth+"px",oPlanDiv2.style.width=oPlanWidth+"px",oPlanDiv2.style.height=oPlanWidth+"px",oPlanDiv2.style.overflow="hidden",(oPlanCtn=document.createElement("div")).style.position="absolute",oPlanCtn.style.transformOrigin=oPlanCtn.style.WebkitTransformOrigin=oPlanCtn.style.MozTransformOrigin="left",(oPlanCtn2=document.createElement("div")).style.position="absolute",oPlanCtn2.style.left=Math.round((oPlanWidth-oPlanWidth2)/2)+"px",oPlanCtn2.style.top=Math.round((oPlanWidth-i)/2)+"px",oPlanCtn2.style.width=oPlanWidth2+"px",oPlanCtn2.style.height=i+"px",oMapImg.src?((oPlanImg=document.createElement("img")).src=oMapImg.src,oPlanImg.style.width=oPlanSize+"px"):(j=Math.round(oPlanSize*oMap.h/oMap.w),(oPlanImg=document.createElement("canvas")).width=oPlanSize,oPlanImg.height=j,oPlanImg.getContext("2d").drawImage(oMapImg,0,0,oPlanSize,j)),oPlanImg.style.position="absolute",oPlanImg.style.left="0px",oPlanImg.style.top="0px",oPlanCtn.appendChild(oPlanImg),oMapImg.src?(oPlanImg2=document.createElement("img")).src=oMapImg.src:((oPlanImg2=document.createElement("canvas")).width=oPlanSize,oPlanImg2.height=j,oPlanImg2.getContext("2d").drawImage(oMapImg,0,0,oPlanSize,j)),oPlanImg2.style.position="absolute",oPlanImg2.style.left="0px",oPlanImg2.style.top="0px",oPlanImg2.style.width=oPlanWidth2+"px",oPlanCtn2.appendChild(oPlanImg2),oMap.decor)for(var b in oMap.decor)oPlanDecor[b]=new Array,oPlanDecor2[b]=new Array;oMap.sea&&((oPlanSea=document.createElement("canvas")).style.position="absolute",oPlanSea.style.left="0px",oPlanSea.style.top="0px",oPlanSea.setAttribute("width",oPlanSize+"px"),oPlanSea.setAttribute("height",oPlanSize+"px"),oPlanCtn.appendChild(oPlanSea),(oPlanSea2=document.createElement("canvas")).style.position="absolute",oPlanSea2.style.left="0px",oPlanSea2.style.top="0px",oPlanSea2.setAttribute("width",oPlanWidth2+"px"),oPlanSea2.setAttribute("height",oPlanWidth2+"px"),oPlanCtn2.appendChild(oPlanSea2));for(var _=["oils","pivots","pointers","flippers","bumpers","flowers"],e=0;e<_.length;e++){var W=_[e];oMap[W]&&(oPlanAssets[W]=new Array,oPlanAssets2[W]=new Array)}if(oPlanImg.onload=function(){oMapImg.seekFrame&&oMapImg.seekFrame(2)},oCharWidth=2*iScreenScale,oTeamWidth=Math.round(2.4*iScreenScale),oBBWidth=2*iScreenScale,oStarWidth2=Math.round(1.5*iScreenScale),oObjWidth=Math.round(1.5*iScreenScale),oCoinWidth=Math.round(1.2*iScreenScale),oExpWidth=Math.round(4.2*iScreenScale),oExpBWidth=Math.round(5.6*iScreenScale),oCharWidth2=Math.round(oCharRatio*oCharWidth),oTeamWidth2=Math.round(oCharRatio*oTeamWidth),oBBWidth2=Math.round(oCharRatio*oBBWidth),oObjWidth2=Math.round(oPlanRatio*oObjWidth),oCoinWidth2=Math.round(oPlanRatio*oCoinWidth),oExpWidth2=Math.round(oPlanRatio*oExpWidth),oExpBWidth2=Math.round(oPlanRatio*oExpBWidth),iTeamPlay)for(e=0;e<aTeams.length;e++){var K=document.createElement("div");K.style.position="absolute",K.style.zIndex=1,K.style.width=oTeamWidth+"px",K.style.height=oTeamWidth+"px",K.style.borderRadius=Math.round(oTeamWidth/2)+"px",K.style.opacity=.5,K.style.backgroundColor=aTeams[e]?"red":"blue",oPlanTeams.push(K),oPlanCtn.appendChild(K);K=document.createElement("div");K.style.position="absolute",K.style.zIndex=1,K.style.width=oTeamWidth2+"px",K.style.height=oTeamWidth2+"px",K.style.borderRadius=Math.round(oTeamWidth2/2)+"px",K.style.opacity=.5,K.style.backgroundColor=aTeams[e]?"red":"blue",oPlanTeams2.push(K),oPlanCtn2.appendChild(K)}for(e=0;e<aKarts.length;e++){var G=document.createElement("img");G.style.position="absolute",G.style.zIndex=1,G.style.width=oCharWidth+"px",G.src=getMapIcSrc(aKarts[e].personnage),G.className="pixelated",oPlanCharacters.push(G);G=document.createElement("img");G.style.position="absolute",G.style.zIndex=1,G.style.width=oCharWidth2+"px",G.src=getMapIcSrc(aKarts[e].personnage),G.className="pixelated",oPlanCharacters2.push(G)}if("CM"==course&&1<oPlanCharacters.length){for(e=0;e<oPlanCharacters.length;e++)e&&(oPlanCharacters[e].style.opacity=.5),oPlanCtn.appendChild(oPlanCharacters[e]);for(e=0;e<oPlanCharacters2.length;e++)e&&(oPlanCharacters2[e].style.opacity=.5),oPlanCtn2.appendChild(oPlanCharacters2[e])}else{for(e=oPlanCharacters.length-1;0<=e;e--)oPlanCtn.appendChild(oPlanCharacters[e]);for(e=oPlanCharacters2.length-1;0<=e;e--)oPlanCtn2.appendChild(oPlanCharacters2[e])}for(e=0;e<oMap.arme.length;e++){fSprite=oMap.arme[e],fSprite[2]=new Sprite("item");var q=document.createElement("img");q.src="images/map_icons/objet.png",q.style.position="absolute",q.style.display="none",q.style.width=oObjWidth,q.className="pixelated",posImg(q,fSprite[0],fSprite[1],Math.round(h.rotation),oObjWidth,oPlanSize),oPlanCtn.appendChild(q),oPlanObjects.push(q);q=document.createElement("img");q.src="images/map_icons/objet.png",q.style.position="absolute",q.style.display="none",q.style.width=oObjWidth2,q.className="pixelated",posImg(q,fSprite[0],fSprite[1],Math.round(h.rotation),oObjWidth2,oPlanSize2),oPlanCtn2.appendChild(q),oPlanObjects2.push(q)}oPlanDiv.appendChild(oPlanCtn),document.body.appendChild(oPlanDiv),oPlanDiv2.appendChild(oPlanCtn2),document.body.appendChild(oPlanDiv2),setPlanPos()}setTimeout(render,500),bMusic&&((N=playSoundEffect("musics/events/"+("BB"!=course?"start":"startbb")+".mp3")).pause(),setTimeout(function(){N.play()},300),N.blur()),bCounting=!0;for(var U=new Array,e=0;e<strPlayer.length;e++)U[e]=[document.createElement("div"),new Image],U[e][0].id="oCounts"+e,U[e][0].style.position="absolute",U[e][0].style.width=12*iScreenScale+"px",U[e][0].style.height=12*iScreenScale+"px",U[e][0].style.overflow="hidden",U[e][0].style.top=4*iScreenScale+"px",U[e][0].style.left=8*iScreenScale+"px",U[e][0].style.zIndex=1e4,U[e][1].src="images/lakitu_depart.png",U[e][1].style.position="absolute",U[e][1].style.left="0px",U[e][1].height=12*iScreenScale,U[e][1].className="pixelated",U[e][0].appendChild(U[e][1]),oContainers[e].appendChild(U[e][0]),U[e].scrollLeft=0;var $,J,X,Y=0;(bMusic||iSfx)&&((X=loadMusic("musics/events/countdown.mp3")).removeAttribute("loop"),document.body.appendChild(X),(J=loadMusic("musics/events/go.mp3")).removeAttribute("loop"),document.body.appendChild(J),J.blur(),isMobile()||isChatting()||(Q=document.createElement("input"),document.body.appendChild(Q),Q.focus(),Q.blur(),document.body.removeChild(Q)));var Q,Z=fInfos&&fInfos.replay,ee=function(){if(Y){for(var e=0;e<strPlayer.length;e++)U[e][0].scrollLeft=12*Y*iScreenScale;if(!(Y<3)){for(var t,n,a,e=0;e<strPlayer.length;e++)document.getElementById("infos"+e).innerHTML="<tr><td>"+toLanguage("GO!","PARTEZ !")+"</td></tr>",document.getElementById("infos"+e).style.fontSize=12*iScreenScale+"px",document.getElementById("infos"+e).style.top=Math.round(12.5*iScreenScale)+"px",1==oPlayers[e].speed?oPlayers[e].speed=11:1<oPlayers[e].speed&&(oPlayers[e].spin(42),oPlayers[e].speed=0,oPlayers[e].speedinc=0);if(oChallengeCpts.style.visibility="visible","BB"==course)for(e=0;e<aKarts.length;e++){var o=aKarts[e];if(o.cpu){var i=1+Math.round(Math.random());for(B=0;B<i;B++)addNewBalloon(o),o.reserve--}}if((bMusic||iSfx)&&(J.play(),J.onended=function(){document.body.removeChild(X),document.body.removeChild(J)}),forcePrepareEnding=!0,setTimeout(function(){for(var e=kartIsPlayer(oPlayers[0])&&!oPlayers[0].loose&&!finishing||Z,t=0;t<strPlayer.length;t++)oContainers[t].removeChild(U[t][0]),(e||t)&&(document.getElementById("infos"+t).style.display="none");var n,a=document.getElementById("infos0");a&&(a.style.fontFamily="",a.style.textStroke=a.style.WebkitTextStroke=a.style.MozTextStroke="",a.style.width="",a.style.top=7*iScreenScale+10+"px",a.style.left=Math.round(25*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",a.style.fontSize=4*iScreenScale+"pt"),e&&(n="CM"!=course?3*iScreenScale:Math.round(2.5*iScreenScale),a.innerHTML='<tr><td><input type="button" style="font-size: '+n+'pt; width: 100%;" value=" &nbsp; '+toLanguage("  RESUME  ","REPRENDRE")+' &nbsp; " id="reprendre" /></td></tr><tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" style="font-size: '+n+'pt; width: 100%;" value=" &nbsp; '+toLanguage("  RETRY  ","RESSAYER")+' &nbsp; " id="recommencer" /></td></tr>'+("CM"!=course?"":'<tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" style="font-size: '+n+'pt; width: 100%;" value="'+toLanguage("  CHANGE RACE  ","CHANGER CIRCUIT")+'" id="changecircuit" /></td></tr>')+'<tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" id="quitter" value=" &nbsp; '+toLanguage("QUIT","QUITTER")+' &nbsp; " style="font-size: '+n+'pt; width: 100%;" /></td></tr>',a.onkeydown=function(e){var t;switch(e.keyCode){case 38:t=-1;break;case 40:t=1}if(t){e=document.activeElement;if(e){var n=Array.prototype.slice.call(document.querySelectorAll("#infos0 input, #infos0 button")),a=e,o=n.indexOf(e);if(-1!=o){var i=o;do{if((i+=t)<0&&(i+=n.length),i>=n.length&&(i=0),(a=n[i])&&"none"!=a.style.display&&"hidden"!=a.style.visibility){a.focus();break}}while(i!=o)}}}},document.getElementById("reprendre").onclick=reprendre,document.getElementById("recommencer").onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,map:oMap.ref,difficulty:iDificulty,cl:clSelected},"CM"==course&&(fInfos.perso=gPersos,fInfos.cpu_route=jTrajets,fInfos.my_record=gRecord,fInfos.ow_record=gOverwriteRecord,fInfos.lap_times=iLapTimes),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetScores()&&("GP"==course?fInfos.map-=(oMap.ref+3)%4:"CM"!=course&&delete fInfos.map),document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,setTimeout(MarioKart,500)},"CM"==course&&(document.getElementById("changecircuit").onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,perso:new Array,cl:clSelected},document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,setTimeout(MarioKart,500)}),document.getElementById("quitter").onclick=quitter,bMusic&&!oMusicEmbed&&(unpauseMusic(mapMusic),forceStartMusic=!0)),bCounting=!1},1e3),pause&&fInfos.replay){var c=pause=!1,p=!1,u=!1,d=[iTrajet];function m(){var e=aKarts[0];e.tourne=0,e.driftcpt=0,getDriftImg(e.driftinc=0).src="images/drift.png",document.getElementById("drift0").style.display="none",aDriftInc=0}function h(){c&&(c=!1,aKarts[0].tourne=0);var e=aKarts[0].sprite[0];e.div.ahallowed&&(e.div.ahallowed=!1,e.div.style.backgroundColor="",e.div.style.backgroundImage="",e.div.style.backgroundRepeat="",e.div.style.backgroundSize="",e.img.style.opacity=1)}for(e=0;e<aKarts.length;e++)aKarts[e].cpu=!0;for(e=0;e<gPersos.length;e++)d.push(jTrajets[e]);clearInterval($),function e(){if(!pause){for(var t=0;t<d.length;t++){var n=aKarts[t],a=d[t][timer];if(a){n.tombe&&(n.tombe--,n.tombe||resetFall(n),t||(oContainers[0].style.opacity=Math.abs(n.tombe-10)/10));var o=n.x,i=n.y,r=n.rotation;n.x=a[0],n.y=a[1],n.z=a[2],n.rotation=a[3];for(var l=(a[4]||"0000").split(""),s=0;s<4;s++)l[s]=+l[s];a=0,l[2]?a=1:l[3]&&(a=-1),n.rotincdir=n.stats.handling*a,n.z?(t||(p||(u=p=!0,m()),1.18<n.z&&(u=!1),u?l[1]&&!n.driftinc&&a&&(n.driftinc=a,n.tourne=0<a?18:4):c?(n.tourne-=1+Math.round(.5*(11-Math.abs(11-n.tourne))),n.tourne<8&&((a=n.sprite[0]).div.ahallowed||(a.div.ahallowed=!0,a.div.style.backgroundImage="url('images/halo.png')",a.div.style.backgroundRepeat="no-repeat",a.div.style.backgroundSize="contain",a.img.style.opacity=.7),n.tourne<0&&(n.tourne=0))):!l[1]||n.driftinc||n.tombe||(c=!0,m(),n.tourne=19)),l[0]&&(n.tombe=20,n.aX=o,n.aY=i,n.aRotation=r,n.sprite[0].img.style.display="none",h())):t||p&&(p=!1,n.driftinc&&(document.getElementById("drift"+t).style.display="block"),h()),n.driftinc&&(t||(l[1]?document.getElementById("drift"+t).style.top=Math.round(iScreenScale*(32-correctZ(n.z))+(n.sprite[t].h-32)*fSpriteScale*.15)+"px":m())),t||handleDriftCpt(t)}else null==n.aipoint&&(n.aipoint=0,n.lastAItime=0,n.arme=!1,n.maxspeed=5.7,t||(n.tourne=0,m(),h())),ai(n),n=iSfx,iSfx=!1,move(t),iSfx=n}showTimer(++timer*SPF),oPlayers[0].cpu=!1,moveDecor(),oPlayers[0].cpu=!0,setTimeout(timer!=iTrajet.length?e:function(){var e=aKarts[0];e.tours=oMap.tours+1,e.demitours=0,e.aipoint=0,e.changeView=180,e.maxspeed=5.7,e.speed=5.7,e.tourne=0,m(),h(),document.onkeyup=void 0,document.getElementById("infos0").style.display="",(e=document.getElementById("infos0").getElementsByTagName("input")[0])&&e.focus(),showTimer(timerMS=iRecord),(bMusic||iSfx)&&startEndMusic(),cycle()},SPF),render()}}(),pause=!1,setTimeout(function(){continuer(),document.querySelector("#enregistrer input").style.display="none"},1e3),document.onkeyup=function(e){e=gameControls[e.keyCode];"pause"!=e||bCounting?"quit"==e&&quitter():(document.getElementById("infos0").style.display="none"==document.getElementById("infos0").style.display?"":"none",(e=document.getElementById("infos0").getElementsByTagName("input")[0])&&e.focus())}}else document.onkeydown=function(e){if(forceStartMusic)try{mapMusic.yt&&mapMusic.yt.playVideo(),forceStartMusic=!1}catch(e){}else if(forcePrepareEnding)try{endingMusic.yt&&(endingMusic.yt.setVolume(0),endingMusic.yt.playVideo(),setTimeout(function(){endingMusic.yt.seekTo(0,!0),endingMusic.yt.setVolume(100),endingMusic.yt.pauseVideo()},1e3)),forcePrepareEnding=!1}catch(e){}if(!clLocalVars.fastForward){var t=gameControls[e.keyCode];if(t){var n,a=document.activeElement;if(!a||"INPUT"!=a.tagName||"button"==a.type||"submit"==a.type)switch(e.preventDefault&&e.preventDefault(),t){case"up":oPlayers[0].speedinc=oPlayers[0].stats.acceleration*oPlayers[0].size,oPlayers[0].etoile&&(oPlayers[0].speedinc*=5);break;case"left":oPlayers[0].rotincdir=oPlayers[0].stats.handling,oPlayers[0].driftinc||oPlayers[0].tourne||oPlayers[0].fell||!oPlayers[0].ctrl||oPlayers[0].cannon||(oPlayers[0].jumped&&(oPlayers[0].driftinc=1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"right":oPlayers[0].rotincdir=-oPlayers[0].stats.handling,oPlayers[0].driftinc||oPlayers[0].tourne||oPlayers[0].fell||!oPlayers[0].ctrl||oPlayers[0].cannon||(oPlayers[0].jumped&&(oPlayers[0].driftinc=-1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"down":oPlayers[0].speedinc-=.2;break;case"jump":if(pause)break;oPlayers[0].ctrl=!0,oPlayers[0].z||oPlayers[0].heightinc?oPlayers[0].jumped||oPlayers[0].fell||oPlayers[0].ctrled||oPlayers[0].billball||oPlayers[0].tourne||oPlayers[0].figuring||oPlayers[0].figstate||oPlayers[0].driftinc||stuntKart(oPlayers[0]):oPlayers[0].driftinc||oPlayers[0].tourne||(oPlayers[0].z=1,oPlayers[0].heightinc=.5,oPlayers[0].jumped=!0,oPlayers[0].rotincdir&&(oPlayers[0].driftinc=0<oPlayers[0].rotincdir?1:-1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"pause":if(isOnline)break;pause?reprendre(!0):bCounting||(document.getElementById("infos0").style.display="",interruptGame(),pauseSounds(),(n=document.getElementById("recommencer"))&&("CM"==course||clSelected)?n.focus():(n=document.getElementById("reprendre"))&&n.focus());break;case"balloon":if(pause)return;"BB"==course&&oPlayers[0].tourne<5&&oPlayers[0].reserve&&oPlayers[0].ballons.length&&oPlayers[0].ballons.length<3&&!oPlayers[0].sprite[0].div.style.opacity&&(oPlayers[0].ballons[oPlayers[0].ballons.length]=createBalloonSprite(oPlayers[0]),oPlayers[0].reserve--,updateBalloonHud(document.getElementById("compteur0"),oPlayers[0]),playIfShould(oPlayers[0],"musics/events/balloon.mp3"));break;case"quit":bCounting||quitter();break;case"cheat":isOnline||"GP"==course||"CM"==course||openCheats();break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=oPlayers[1].stats.acceleration*oPlayers[1].size,oPlayers[1].etoile&&(oPlayers[1].speedinc*=5);break;case"left_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=oPlayers[1].stats.handling,oPlayers[1].driftinc||oPlayers[1].tourne||oPlayers[1].fell||!oPlayers[1].ctrl||oPlayers[1].cannon||oPlayers[1].jumped&&(oPlayers[1].driftinc=1);break;case"right_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=-oPlayers[1].stats.handling,oPlayers[1].driftinc||oPlayers[1].tourne||oPlayers[1].fell||!oPlayers[1].ctrl||oPlayers[1].cannon||oPlayers[1].jumped&&(oPlayers[1].driftinc=-1);break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc-=.2;break;case"jump_p2":if(pause)break;return oPlayers[1]?(oPlayers[1].ctrl=!0,oPlayers[1].z||oPlayers[1].heightinc?oPlayers[1].jumped||oPlayers[1].ctrled||oPlayers[1].fell||oPlayers[1].billball||oPlayers[1].tourne||oPlayers[1].figuring||oPlayers[1].figstate||oPlayers[1].driftinc||stuntKart(oPlayers[1]):oPlayers[1].driftinc||oPlayers[1].tourne||(oPlayers[1].z=1,oPlayers[1].heightinc=.5,oPlayers[1].jumped=!0,oPlayers[1].rotincdir&&(oPlayers[1].driftinc=0<oPlayers[1].rotincdir?1:-1)),!1):void 0;case"balloon_p2":if(pause)return;if(!oPlayers[1])return;"BB"==course&&oPlayers[0].tourne<5&&oPlayers[1].reserve&&oPlayers[1].ballons.length&&oPlayers[1].ballons.length<3&&!oPlayers[1].sprite[0].div.style.opacity&&(oPlayers[1].ballons[oPlayers[1].ballons.length]=createBalloonSprite(oPlayers[1]),oPlayers[1].reserve--,updateBalloonHud(document.getElementById("compteur1"),oPlayers[1]))}}}},document.onkeyup=function(e){var t=gameControls[e.keyCode];if(t){var n,e=document.activeElement;if(!e||"INPUT"!=e.tagName||"button"==e.type||"submit"==e.type)switch(t){case"item":case"item_back":oPlayers[0].tourne||oPlayers[0].cannon||pause||arme(0,"item_back"===t);break;case"up":oPlayers[0].speedinc=0;break;case"left":case"right":oPlayers[0].rotincdir=0;break;case"down":oPlayers[0].speedinc=0;break;case"jump":if(pause)break;delete oPlayers[0].ctrl,oPlayers[0].driftinc&&(oPlayers[0].driftinc=0,oPlayers[0].driftcpt>=fTurboDriftCpt&&(oPlayers[0].turbodrift=15,clLocalVars.miniTurbo++,clSelected&&clRuleVars[clSelected.id]&&(n=clRuleVars[clSelected.id].mini_turbo)&&updateChallengeHud("miniTurbo",clLocalVars.miniTurbo+n.miniTurbo),oPlayers[0].driftcpt>=fTurboDriftCpt2&&(oPlayers[0].turbodrift+=15,clLocalVars.superTurbo++,clSelected&&clRuleVars[clSelected.id]&&(n=clRuleVars[clSelected.id].super_turbo)&&updateChallengeHud("superTurbo",clLocalVars.superTurbo+n.superTurbo)),oPlayers[0].turbodrift0=oPlayers[0].turbodrift,getDriftImg(0).src="images/drift.png"),oPlayers[0].driftcpt=0,document.getElementById("drift0").style.display="none",oPlayers[0].driftSound&&(oPlayers[0].driftSound.pause(),oPlayers[0].driftSound=void 0)),oPlayers[0].ctrled=!1,oPlayers[0].jumped&&(oPlayers[0].z||oPlayers[0].heightinc)&&(oPlayers[0].ctrled=!0);break;case"rear":showRearView(0);break;case"item_p2":case"item_back_p2":oPlayers[1].tourne||oPlayers[1].cannon||pause||arme(1,"item_back_p2"===t);break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"left_p2":case"right_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=0;break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"jump_p2":if(pause)break;if(!oPlayers[1])return;delete oPlayers[1].ctrl,oPlayers[1].driftinc&&(oPlayers[1].driftinc=0,oPlayers[1].driftcpt>=fTurboDriftCpt&&(oPlayers[1].turbodrift=15,oPlayers[1].driftcpt>=fTurboDriftCpt2&&(oPlayers[1].turbodrift+=15),oPlayers[1].turbodrift0=oPlayers[1].turbodrift,getDriftImg(1).src="images/drift.png"),oPlayers[1].driftcpt=0,document.getElementById("drift1").style.display="none",oPlayers[1].driftSound&&(oPlayers[1].driftSound.pause(),oPlayers[1].driftSound=void 0)),oPlayers[1].ctrled=!1,oPlayers[1].jumped&&(oPlayers[1].z||oPlayers[1].heightinc)&&(oPlayers[1].ctrled=!0);break;case"rear_p2":if(!oPlayers[1])return;showRearView(1)}}},window.releaseOnBlur=function(){for(var e=0;e<oPlayers.length;e++)oPlayers[e].speedinc=0,oPlayers[e].rotincdir=0,stopDrifting(e)},window.addEventListener("blur",window.releaseOnBlur),isMobile()&&(document.onmousedown=function(e){return!!pause||(!(!oPlayers[0].tourne&&!oPlayers[0].cannon)||("BB"==course?(document.onkeydown({keyCode:findKeyCode("balloon")}),!1):!oPlayers[0].arme&&!oPlayers[0].using.length||(arme(0),!1)))}),isOnline&&(window.onbeforeunload=function(){return language?"Caution, if you leave the game, you are considered loser":"Attention, si vous quittez la partie, vous tes considr comme perdant"}),pause=!1,"CM"==course&&(iTrajet=new Array),clearInterval($),clLocalVars.delayedStart?(oPlayers[0].speed=0,t=oPlayers[0].speedinc,oPlayers[0].speedinc=0,n=1e3*clLocalVars.delayedStart/67,pause=!0,clLocalVars.fastForward=!0,a=reprendre,reprendre=function(){},function e(){pause&&(timer<n?(setTimeout(e,1),runOneFrame()):(delete clLocalVars.fastForward,oPlayers[0].speedinc=t,(reprendre=a)(!1)))}()):cycle(),bRunning=!0;return void(fInfos=void 0)}for(var e=0;e<strPlayer.length;e++)document.getElementById("decompte"+e).innerHTML--,oPlayers[e].speed+=oPlayers[e].speedinc;(bMusic||iSfx)&&(X.currentTime=0,X.play())}else{for(e=0;e<strPlayer.length;e++)document.getElementById("infos"+e).style.visibility="";(bMusic||iSfx)&&X.play(),document.body.style.cursor="default"}Y++,setTimeout(ee,1e3)};iSfx&&!fInfos.replay&&setTimeout(startEngineSound,bMusic?2600:1100),isOnline?(Q=tnCourse-(new Date).getTime(),setTimeout(ee,Q),iTeamPlay&&function(e){var t=oPlayers[0].team,n=document.createElement("div");n.style.position="absolute",n.style.zIndex=1e4,n.style.left="0px",n.style.top=12*iScreenScale+"px",n.style.width=iScreenScale*iWidth+"px",n.style.textAlign="center",n.style.fontSize=6*iScreenScale+"px",n.style.fontWeight="bold",n.style.color=t?"#F96":"#69F",n.innerHTML=toLanguage("You are ","Vous tes ")+(t?toLanguage("red","rouge"):toLanguage("blue","bleu"));var a=Math.min(1500,e-1e3);500<a&&setTimeout(function(){oContainers[0].appendChild(n),setTimeout(function(){oContainers[0].removeChild(n)},a)},500)}(Q)):setTimeout(ee,bMusic?3e3:1500),oMapImg.image&&($=setTimeout(function(){$=setInterval(function(){for(var e=0;e<oPlayers.length;e++)redrawCanvas(e,oPlayers[e])},100)},100)),clLocalVars.backwardsStart&&showRearView(0),isOnline||(document.body.style.cursor="default")}function youtube_parser(e){e=e.match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/);return!(!e||11!=e[1].length)&&e[1]}var fSpriteScale=0,fLineScale=0,oContainers=[document.createElement("div")];oContainers[0].className="game-container",oContainers[0].tabindex=1,formulaire=null,updateCtnFullScreen(1==$mkScreen.dataset.fs),function(){for(var e,t=0;t<2;t++)(e=document.getElementById("infos"+t))&&$mkScreen.removeChild(e);(e=document.createElement("table")).id="infos0",e.setAttribute("cellspacing",1),e.setAttribute("cellpadding",0),e.style.display="none",$mkScreen.appendChild(e)}(),$mkScreen.appendChild(oContainers[0]),pause&&fInfos.player[1]&&(oContainers[1]=oContainers[0].cloneNode(!1),oContainers[1].style.left=12+iWidth*iScreenScale+"px",$mkScreen.appendChild(oContainers[1]));var oScreens=new Array,aStrips=new Array,iCamHeight=24,iCamDist=32,iViewHeight=-10,fFocal=1/Math.tan(Math.PI*Math.PI/360);function resetScreen(){fSpriteScale=iScreenScale/4,fLineScale=1/iScreenScale*iQuality,aStrips=[];for(var e=0;e<strPlayer.length;e++){var t=oContainers[e];t.style.width=iWidth*iScreenScale+"px",t.style.height=iHeight*iScreenScale+"px";t=document.createElement("canvas");t.style.position="absolute",oScreens.push(t),oContainers[e].appendChild(t),t.width=iWidth/fLineScale,t.height=iHeight/fLineScale,t.style.width=iWidth*iScreenScale+iScreenScale+"px",t.style.left=-iScreenScale/2+"px",t.style.top=iScreenScale+"px",t.style.height=iHeight*iScreenScale+"px"}for(e=0;e<oBgLayers.length;e++)oBgLayers[e].suppr();for(var n=0,a=0;a<iHeight;a+=fLineScale){var o=a+iViewHeight,i=o/((iCamHeight-o)/iCamDist),r=fFocal/(fFocal+i),o=Math.floor(iWidth/r);0<r&&o<iViewCanvasWidth&&(0==a&&(n=i-1),aStrips.push({viewy:a,mapz:i,scale:r,stripwidth:o,mapzspan:i-n}),n=i)}for(e=0;e<oMap.fond.length;e++)oBgLayers[e]=new BGLayer(oMap.fond[e],2==oMap.fond.length?1:e+1);(oViewCanvas=document.createElement("canvas")).width=iViewCanvasWidth,oViewCanvas.height=iViewCanvasHeight}function interruptGame(){pause=!0,clearInterval(cycleHandler),cycleHandler=null}function reprendre(e){pause&&(pause=!1,cycle()),e&&(unpauseSounds(),document.getElementById("infos0").style.display="none")}function quitter(){if(isOnline)document.location.href=isMCups?(complete?"map":"circuit")+".php?mid="+nid:isCup?complete?(isBattle?"battle":"map")+".php?"+(isSingle?"i":"cid")+"="+nid:(isBattle?"arena":"circuit")+".php?"+(isSingle?"id":"cid")+"="+nid:"index.php";else{interruptGame(),displayCommands(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++){$mkScreen.removeChild(oContainers[e]);var t=document.getElementById("infos"+e);t&&(t.style.display="none")}($mkScreen.style.opacity=1)==strPlayer.length&&removePlan(),document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,oBgLayers.length=0,aPlayers=[],aScores=[],clRuleVars={},clGlobalVars=void 0,setTimeout(function(){pause=!1,MarioKart()},500)}}function classement(){for(var e=aKarts.length,t=0;t<e;t++){for(var n=aKarts[t],a=aScores[t],o=1,i=0;i<e;i++){var r=aScores[i];n!=aKarts[i]&&a<=r&&(a<r||i<t)&&o++}n.place=o}for(var l=new Array,t=1;t<=e;t++)for(i=0;i<e;i++)(o=aKarts[i].place)==t&&(l.push(i),i=e);document.getElementById("infos0").style.display="none";for(var s,c=strPlayer.length-1,t=0;t<l.length;t++){var p=l[t],u=aKarts[p].personnage,d=1==aKarts[p].team?1:0;document.getElementById("fJ"+t).style.backgroundColor=0!=p?p!=c?d?"red":"":d?"brown":"navy":rankingColor(aKarts[p].team),document.getElementById("fJ"+t).style.opacity=u!=strPlayer?"":.8,document.getElementById("j"+t).innerHTML=toPerso(u),document.getElementById("pts"+t).innerHTML=aScores[p]}if(iTeamPlay){for(var m=[0,0],t=0;t<aScores.length;t++)m[aTeams[t]]+=aScores[t];s=createTeamTable(m)}document.getElementById("octn").onclick=continuer,setTimeout(function(){document.getElementById("infos0").style.display="",s&&(s.style.visibility="visible");var e=document.body.scrollTop;document.getElementById("octn").focus(),document.body.scrollTop=e},500)}function createTeamTable(e){var t=e[0]>e[1]||e[0]==e[1]&&e[0]==oPlayers[0].team?[0,1]:[1,0],n=document.createElement("table");n.id="team-table";for(var a='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Team","quipe")+"</td><td>Pts</td></tr>",o=0;o<t.length;o++){var i=t[o];a+='<tr id="fJ'+o+'" style="background-color:'+(i?"red":"blue")+'"><td>'+toPlace(o+1)+' </td><td class="maj" id="j'+o+'">'+(i?toLanguage("Red","Rouge"):toLanguage("Blue","Bleue"))+'</td><td id="pts'+o+'">'+e[i]+"</td></tr>"}return n.style.visibility="hidden",n.style.position="absolute",n.style.zIndex=2e4,n.style.left=3*iScreenScale+10+"px",n.style.top=10*iScreenScale+"px",n.style.backgroundColor="blue",n.style.color=primaryColor,n.style.opacity=.7,n.style.textAlign="center",n.style.fontSize=Math.round(1.5*iScreenScale+4)+"pt",n.style.fontFamily="Courier",n.style.fontWeight="bold",n.style.fontFamily="arial",n.innerHTML=a,$mkScreen.appendChild(n),n}function resetScores(){for(var e=0;e<strPlayer.length;e++)aPlaces[e]=aPlayers.length+e+1;for(e=0;e<aPlayers.length;e++)aPlaces[e+strPlayer.length]=e+1;clGlobalVars=void 0;var t=!(clRuleVars={});aScores.length=aPlaces.length;for(e=0;e<aScores.length;e++)0!==aScores[e]&&(t=!0,aScores[e]=0);return t}function continuer(){document.getElementById("infos0").style.border=0,document.getElementById("infos0").style.top=10*iScreenScale+10+"px",document.getElementById("infos0").style.left=Math.round(20*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.background="transparent",document.getElementById("infos0").style.fontSize=4*iScreenScale+"pt",document.getElementById("infos0").innerHTML='<tr><td id="continuer"></td></tr><tr><td'+("CM"!=course?' style="font-size: '+3*iScreenScale+'px;">&nbsp;</td></tr>':' id="enregistrer"></td></tr><tr><td id="revoir"></td></tr><tr><td id="classement"></td></tr><tr><td id="changercircuit">')+'</td></tr><tr><td><input type="button" id="quitter" value="'+toLanguage("QUIT","QUITTER")+'" style="font-size: '+3*iScreenScale+'pt; width: 100%;" /></td></tr>';var oTeamTable=document.getElementById("team-table");oTeamTable&&$mkScreen.removeChild(oTeamTable);var oContinue=document.createElement("input"),forceClic3,oQuit,oSave,oReplay,oChangeRace,oClassement;function nextRace(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,distribution:itemDistribution,difficulty:iDificulty,cl:clSelected},"GP"==course&&(fInfos.map=oMap.ref+1),($mkScreen.style.opacity=1)==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)}oContinue.type="button",oContinue.style.fontSize=3*iScreenScale+"pt",oContinue.style.width="100%","CM"!=course?oMap.ref%4||"GP"!=course?(isSingle&&!isOnline?oContinue.value="        "+toLanguage("  REPLAY","REJOUER")+"        ":"BB"==course?oContinue.value=toLanguage("      NEXT BATTLE\t   ","BATAILLE SUIVANTE"):oContinue.value=toLanguage("       NEXT RACE\t   ","COURSE SUIVANTE"),forceClic3=!0,oContinue.onclick=function(){forceClic3=!1,nextRace()},isOnline&&setTimeout(function(){forceClic3&&nextRace()},5e3)):(oContinue.value=toLanguage("           NEXT           ","         SUIVANT          "),oContinue.onclick=function(){$mkScreen=document.body,interruptGame();var posX=[29,22,36],posY=[15,17,19],oPlace;document.body.innerHTML=toLanguage("You are","Vous &ecirc;tes")+' <span id="position"></span> !<br /><a href="javascript:location.reload()" style="color: white;">'+toLanguage("Back","Retour")+'</a><img alt="." src="images/podium.gif" style="position: absolute; left: '+20*iScreenScale+"px; top: "+20*iScreenScale+"px; width: "+24*iScreenScale+'px;" />';for(var placement=new Array,i=1;i<=aKarts.length;i++)for(var j=0;j<aKarts.length;j++)if(aKarts[j].place==i){placement.push(aKarts[j].personnage);break}document.body.style.fontSize=2*iScreenScale+"pt";for(var i=0,saveUrl,saveParams;i<placement.length;i++)if(placement[i]==strPlayer&&(oPlace=i+1),i<3)document.body.innerHTML+='<img alt="." src="'+getWinnerSrc(placement[i])+'" style="width: '+4*iScreenScale+"px; position: absolute; left: "+iScreenScale*posX[i]+"px; top: "+iScreenScale*(posY[i]+(isCustomPerso(placement[i])?6:0))+"px;"+(isCustomPerso(placement[i])?"transform:translateY(-100%);-webkit-transform:translateY(-100%);-moz-transform:translateY(-100%);-o-transform:translateY(-100%);-ms-transform:translateY(-100%);":"")+'" />';else if(oPlace)break;document.getElementById("position").innerHTML=toPlace(oPlace),oPlace<=3?(document.body.innerHTML+='<img alt="." src="images/cups/cup'+oPlace+'.png" style="width: '+3*iScreenScale+"px; position: absolute; left: "+30*iScreenScale+"px; top: "+25*iScreenScale+'px;" />',saveParams="pts="+(4-oPlace),"MK"==page?(saveUrl="saveGP.php",saveParams+="&change="+(oMap.map-4)/4):nid&&(saveUrl="cupsave.php",saveParams+=isMCups?"&cup="+cupIDs[oMap.ref/4-1]:"&cup="+nid),saveUrl&&xhr(saveUrl,saveParams,function(reponse){if(reponse){var newPerso,uwPerso,uwPerso;try{newPerso=eval(reponse)}catch(e){return!1}return newPerso&&(uwPerso=toPerso(newPerso),uwPerso=uwPerso.charAt(0).toUpperCase()+uwPerso.substring(1),document.body.innerHTML+='<div style="position: absolute; left: '+16*iScreenScale+"px; top: "+30*iScreenScale+'px; text-align: center">'+toLanguage("You can now play<br />with "+uwPerso+" !","Vous pouvez d&eacute;sormais<br />jouer avec "+uwPerso+" !")+'<br /><img src="'+getWinnerSrc(newPerso)+'" style="width: '+4*iScreenScale+'px" /></div>'),!0}return!1}),bMusic&&(endGPMusic=startMusic("musics/menu/congrats.mp3",!0,700))):bMusic&&(endGPMusic=startMusic("musics/menu/toobad.mp3",!0,700)),reinitChallengeVars(),clLocalVars.endGP=!0,challengeCheck("end_gp",["finish_gp"])}):(oQuit=document.getElementById("quitter"),oContinue.style.fontSize=oQuit.style.fontSize=3*iScreenScale+"px",oSave=oContinue.cloneNode(!1),oReplay=oContinue.cloneNode(!1),oChangeRace=oContinue.cloneNode(!1),oClassement=oContinue.cloneNode(!1),oContinue.value=gSelectedPerso?toLanguage("        FACE WITH        ","     AFFRONTER     "):toLanguage("          RETRY          ","     RESSAYER     "),oContinue.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,map:oMap.ref,difficulty:iDificulty,perso:gPersos,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,lap_times:iLapTimes,cl:clSelected},gSelectedPerso?(fInfos.player=[gSelectedPerso],fInfos.perso=[strPlayer[0]],fInfos.cpu_route=[iTrajet]):2==gOverwriteRecord&&lapTimers.length==oMap.tours&&(fInfos.cpu_route=[iTrajet],fInfos.perso=strPlayer,fInfos.lap_times=lapTimers),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)},oSave.value="   "+toLanguage("SAVE","ENREGISTRER")+"   ",oSave.onclick=function(){document.getElementById("infos0").style.display="none";var oForm=document.createElement("form");oForm.style.color="black",oForm.style.position="absolute",oForm.style.left=5*iScreenScale+10+"px",oForm.style.top=5*iScreenScale+10+"px",oForm.style.fontSize=4*iScreenScale+"pt",oForm.style.backgroundColor="#FF6",oForm.style.opacity=.8,oForm.style.border="double 4px black",oForm.style.textAlign="center",oForm.style.width=70*iScreenScale-10+"px",oForm.style.zIndex=2e4,oForm.onsubmit=function(){var nom=this.pseudo.value;if(nom){document.body.style.cursor="progress",oValide.style.visibility="hidden",aPara2.style.visibility="hidden";var params="name="+nom+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS();switch(page){case"MK":params+="&circuit="+oMap.map;break;case"CI":params+="&creation="+oMap.id;break;case"MA":params+="&map="+oMap.map}xhr("records.php",params,function(reponse){if(reponse){var enregistre;document.body.style.cursor="default";try{enregistre=eval(reponse)}catch(e){return!1}function showBackUi(e){oInput.disabled=!0,oCheckbox.disabled=!0,oValide.parentNode.removeChild(oValide),aPara2.style.fontSize=Math.round(2.5*iScreenScale)+"px",e&&(aPara2.innerHTML=toLanguage("Congratulations "+nom+", your score has been saved successfully ! You placed ","F&eacute;licitations "+nom+", votre score a bien &eacute;t&eacute; enregistr&eacute; ! Vous &ecirc;tes ")+toPlace(enregistre[0])+toLanguage(" out of "+enregistre[1]+" in this race !"," sur "+enregistre[1]+" au classement de ce circuit !"),oSave.style.display="none"),aPara2.style.visibility="",oRetour.focus()}if(Array.isArray(enregistre))if(oCheckbox.checked){oSave.style.display="none",oValide.style.display="none";var aSmall=document.createElement("span");aSmall.style.fontSize=Math.round(2.5*iScreenScale)+"px",aSmall.innerHTML=toLanguage("Saving ghost...","Enregistrement du fantme..."),aPara2.appendChild(aSmall),aPara2.style.visibility="";var oRequest="map="+oMap.map+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS()+"&times="+JSON.stringify(lapTimers);for(i=0;i<iTrajet.length;i++)oRequest+="&p"+i+"="+iTrajet[i].toString().replace(/\,/g,"_");xhr("saveghost.php",oRequest,function(e){return 1==e&&(gRecord=getActualGameTimeMS(),gOverwriteRecord=gOverwriteRecord&&2,showBackUi(!0),!0)})}else showBackUi(!0);else{switch(showBackUi(!1),enregistre){case 0:aPara2.innerHTML=toLanguage("You did a better score on this race before.<br />Your score has not been registered.","Vous avez fait un meilleur score sur ce circuit.<br />Votre temps n'a donc pas &eacute;t&eacute; enregistr&eacute;.");break;case 1:aPara2.innerHTML=toLanguage('This nick is already used, please choose another one. If it\'s you, <a href="forum.php" target="_blank" style="color: orange">log-in</a> to your account and try again.','Ce pseudo est dj utilis, veuillez en choisir un autre. S\'il s\'agit de vous, <a href="forum.php" target="_blank" style="color: orange">connectez-vous</a> et ressayez.');break;default:aPara2.innerHTML=toLanguage("An unknown error occured, please try again later","Une erreur inconnue est survenue, veuillez ressayer ultrieurement")}0!=enregistre&&(oValide.style.visibility="",oValide.style.marginRight=2*iScreenScale+"px",aPara3.insertBefore(oValide,oRetour),oCheckbox.disabled=!1,oInput.disabled=!1,oInput.select())}return!0}return!1}),recorder=nom}return!1};var aPara1=document.createElement("p");aPara1.innerHTML=toLanguage("Nick : ","Pseudo : "),aPara1.style.margin=iScreenScale+"px";var oInput=document.createElement("input");oInput.type="text",oInput.name="pseudo",oInput.value=recorder,oInput.size=15,oInput.maxlength=18,oInput.style.fontSize=3*iScreenScale+"px",oInput.onkeydown=function(e){e.stopPropagation()},oInput.onkeyup=function(e){e.stopPropagation()},aPara1.appendChild(oInput);var aPara12=aPara1.cloneNode(!1),oCheckLabel=document.createElement("label");oCheckLabel.style.display="inline-block";var oCheckbox=document.createElement("input");oCheckbox.type="checkbox",oCheckbox.name="saveghost",oCheckbox.checked=!0,oCheckbox.style.transform=oCheckbox.style.WebkitTransform=oCheckbox.style.MozTransform="scale("+(iScreenScale/6).toFixed(1)+")",oCheckLabel.appendChild(oCheckbox);var oCheckSpan=document.createElement("span");oCheckSpan.style.fontSize=2*iScreenScale+"px",oCheckSpan.innerHTML=" "+toLanguage("Save ghost","Enregistrer le fantme"),oCheckLabel.appendChild(oCheckSpan),aPara12.appendChild(oCheckLabel),("MK"!=page||gRecord<=timerMS)&&(oCheckbox.checked=!1,aPara12.style.display="none");var aPara2=aPara1.cloneNode(!1),oValide=document.createElement("input");oValide.type="submit",oValide.value="     "+toLanguage("Submit","Valider")+"     ",oValide.style.fontSize=5*iScreenScale+"px",oValide.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oRetour.style.fontSize=4*iScreenScale+"px"},aPara2.appendChild(oValide);var aPara3=aPara1.cloneNode(!1),oRetour=document.createElement("input");oRetour.type="button",oRetour.value="     "+toLanguage("Back","Retour")+"     ",oRetour.style.fontSize=4*iScreenScale+"px",oRetour.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oValide.style.fontSize=4*iScreenScale+"px"},oRetour.onclick=function(){$mkScreen.removeChild(oForm),document.getElementById("infos0").style.display="",oContinue.focus()},aPara3.appendChild(oRetour),oForm.appendChild(aPara1),oForm.appendChild(aPara12),oForm.appendChild(aPara2),oForm.appendChild(aPara3),$mkScreen.appendChild(oForm),oForm.style.height=oForm.scrollHeight+"px",oInput.select()},gSelectedPerso&&(oSave.style.display="none"),document.getElementById("enregistrer").appendChild(oSave),oReplay.value=toLanguage("REPLAY","REVOIR"),oReplay.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),null==(fInfos={player:strPlayer,distribution:itemDistribution,map:oMap.ref,my_route:iTrajet,replay:!0,perso:gPersos,selPerso:gSelectedPerso,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,record:timerMS,lap_times:iLapTimes,cl:clSelected}).record&&(fInfos.record=iRecord),null==fInfos.lap_times&&(fInfos.lap_times=lapTimers),document.getElementById("infos"+e).style.display="none";1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)},document.getElementById("revoir").appendChild(oReplay),oChangeRace.value=toLanguage("     CHANGE RACE     ","   CHANGER CIRCUIT   "),oChangeRace.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,distribution:itemDistribution,perso:new Array,cl:clSelected},gSelectedPerso&&(fInfos.player=[gSelectedPerso]),1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)},document.getElementById("changercircuit").appendChild(oChangeRace),oClassement.value="RECORDS",oClassement.onclick=function(){open(rankingsLink(oMap))},gSelectedPerso&&(oClassement.style.display="none"),document.getElementById("classement").appendChild(oClassement)),document.getElementById("continuer").appendChild(oContinue),document.getElementById("quitter").onclick=quitter,isChatting()||oContinue.focus()}function rankingColor(e){switch(e){case 0:return"#69F";case 1:return"#F96";default:return"#990"}}var iViewCanvasHeight=240,iViewCanvasWidth=600,iViewYOffset=10,oViewCanvas;function Sprite(e){for(var l=new Array,t=0;t<strPlayer.length;t++){this[t]={};var n=new Image;n.style.position="absolute",n.style.left="200px",n.alt=".",n.className="pixelated",n.src=getSpriteSrc(e);var a=document.createElement("div");a.style.width="32px",a.style.height="32px",a.style.position="absolute",a.style.overflow="hidden",a.style.zIndex=1e4,a.className="pixelated",a.style.display="none",a.appendChild(n),oContainers[t].appendChild(a),this[t].i=t,this[t].w=32,this[t].h=32,this[t].z=0,this[t].draw=function(e,t,n,a){a=a||0;var o=this.i,i=this.w*fSpriteScale*n,r=this.h*fSpriteScale*n,n=t-r*(this.z+1)+i/2;isNaN(n)||n>iHeight*iScreenScale||t+a*iScreenScale<9*iScreenScale?l[o][0].style.display="none":(l[o][0].style.display="block",l[o][0].style.left=Math.round(e-i/2)+"px",l[o][0].style.top=Math.round(n)+"px",this.h!=this.w?l[o][1].style.width=Math.round(i)*this.nbSprites+"px":l[o][1].style.width="",l[o][1].style.height=Math.round(r)+"px",l[o][0].style.width=Math.round(i)+"px",l[o][0].style.height=Math.round(r)+"px",l[o][1].style.left=-(Math.round(i)*l[o][2])+"px")},this[t].render=function(e,t){var n=t.size||1,a=t.x-e.x,o=t.y-e.y,i=e.rotation*Math.PI/180,e=a*Math.cos(i)-o*Math.sin(i),a=a*Math.sin(i)+o*Math.cos(i),o=-iCamHeight,i=iCamDist+a,t=t.z?correctCamZ(t.z,i):0,i=o/i*iCamDist+iCamHeight-iViewHeight+t,e=-e/(a+iCamDist)*iCamDist;this.div.style.zIndex=Math.round(1e4-a);e=(iWidth/2+e)*iScreenScale,i=(iHeight-i)*iScreenScale,n*=fFocal/(fFocal+a);this.draw(e,i,n,t)},this[t].setState=function(e){l[this.i][2]=e},this[t].getState=function(){return l[this.i][2]},this[t].div=a,this[t].img=n,l.push([a,n,0])}var o=this;this[0].unshow=function(){o[0].suppr(),o[0].unshown=!0},this[0].suppr=function(){if(!o[0].unshown)for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(l[e][0])},this[0].fadein=function(e){var n,a;o[0].unshown||(n=0,a=SPF/e,function e(){1<=n&&(n="");for(var t=0;t<strPlayer.length;t++)l[t][0].style.opacity=n;""!==n?(n+=a,o[0].fadeinhandler=setTimeout(e,SPF)):delete o[0].fadeinhandler}())},this[0].fadeout=function(e){var n,a;o[0].unshown||(n=1,o[0].fadeinhandler&&(clearTimeout(o[0].fadeinhandler),n=0),a=SPF/e,function e(){if((n-=a)<=0)o[0].suppr();else{for(var t=0;t<strPlayer.length;t++)l[t][0].style.opacity=n;setTimeout(e,SPF)}}())}}function BGLayer(e,n){var a=new Array,o=new Image;o.src="images/map_bg/"+e+".png",iSmooth||(o.className="pixelated");for(var t=0;t<oContainers.length;t++)a[t]=document.createElement("div"),a[t].style.height=10*iScreenScale+"px",a[t].style.width=iWidth*iScreenScale+"px",a[t].style.position="absolute",function(e){setTimeout(function(){e.style.backgroundImage="url('"+o.src+"')"},500)}(a[t]),a[t].style.backgroundSize="auto 100%",iSmooth||(a[t].className="pixelated"),oContainers[t].appendChild(a[t]);return{draw:function(e,t){o.naturalWidth&&(e=(e-360*Math.ceil(e/360))*(10*iScreenScale*o.naturalWidth/o.naturalHeight*n/360),a[t].style.backgroundPosition=Math.round(e)+"px 0")},suppr:function(){for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(a[e])}}}function GIF(){var n,t,a,o,d,i,h,r=[0,4,2,1],l=[8,8,4,2],s={GCExt:249,COMMENT:254,APPExt:255,UNKNOWN:1,IMAGE:44,EOF:59,EXT:33},c=function(e){this.data=new Uint8ClampedArray(e),this.pos=0;var a=this.data.length;this.getString=function(e){for(var t="";e--;)t+=String.fromCharCode(this.data[this.pos++]);return t},this.readSubBlocks=function(){var e,t,n="";do{for(t=e=this.data[this.pos++];t--;)n+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<a);return n},this.readSubBlocksB=function(){var e,t,n=[];do{for(t=e=this.data[this.pos++];t--;)n.push(this.data[this.pos++])}while(0!==e&&this.pos<a);return n}};function p(e){for(var t=[],n=0;n<e;n++)t.push([a.data[a.pos++],a.data[a.pos++],a.data[a.pos++]]);return t}function u(){var e,t=function(e){var t,n=i/e,a=0;for(o!==i&&(d=new Uint8Array(i),o=i),t=0;t<4;t++)for(toLine=r[t];toLine<n;toLine+=l[t])d.set(h.subArray(a,a+e),toLine*e),a+=e},n={};M.frames.push(n),n.disposalMethod=M.disposalMethod,n.time=M.length,n.delay=10*M.delayTime,M.length+=n.delay,M.transparencyGiven?n.transparencyIndex=M.transparencyIndex:n.transparencyIndex=void 0,n.leftPos=a.data[a.pos++]+(a.data[a.pos++]<<8),n.topPos=a.data[a.pos++]+(a.data[a.pos++]<<8),n.width=a.data[a.pos++]+(a.data[a.pos++]<<8),n.height=a.data[a.pos++]+(a.data[a.pos++]<<8),e=a.data[a.pos++],n.localColourTableFlag=!!(128&e),n.localColourTableFlag&&(n.localColourTable=p(1<<1+(7&e))),i!==n.width*n.height&&(h=new Uint8Array(n.width*n.height),i=n.width*n.height),function(e,t){for(var n,a,o,i,r,l,s=a=0,c=[],p=1<<e,u=1+p,d=e+1,m=!1;!m;){for(i=o,n=o=0;n<d;n++)t[s>>3]&1<<(7&s)&&(o|=1<<n),s++;if(o===p){for(c=[],d=e+1,n=0;n<p;n++)c[n]=[n];c[p]=[],c[u]=null}else{if(o===u)return m=!0;for(o>=c.length?c.push(c[i].concat(c[i][0])):i!==p&&c.push(c[i].concat(c[o][0])),l=(r=c[o]).length,n=0;n<l;n++)h[a++]=r[n];c.length===1<<d&&d<12&&d++}}}(a.data[a.pos++],a.readSubBlocksB()),64&e?(n.interlaced=!0,t(n.width)):n.interlaced=!1,function(e){var t,n,a,o,i,r,l,s,c,p,u;for(e.image=document.createElement("canvas"),e.image.width=M.width,e.image.height=M.height,e.image.ctx=e.image.getContext("2d"),t=e.localColourTableFlag?e.localColourTable:M.globalColourTable,null===M.lastFrame&&(M.lastFrame=e),(r=2===M.lastFrame.disposalMethod||3===M.lastFrame.disposalMethod)||e.image.ctx.drawImage(M.lastFrame.image,0,0,M.width,M.height),n=e.image.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),u=e.transparencyIndex,a=n.data,c=e.interlaced?d:h,o=c.length,l=i=0;l<o;l++)s=c[l],p=t[s],u!==s?(a[i++]=p[0],a[i++]=p[1],a[i++]=p[2],a[i++]=255):(r&&(a[i+3]=0),i+=4);e.image.ctx.putImageData(n,e.leftPos,e.topPos),M.lastFrame=e,M.waitTillDone||"function"!=typeof M.onload||S()}(n)}function m(){M.loading=!1,M.frameCount=M.frames.length,M.lastFrame=null,a=void 0,M.complete=!0,M.disposalMethod=void 0,M.transparencyGiven=void 0,M.delayTime=void 0,M.transparencyIndex=void 0,M.waitTillDone=void 0,d=i=d=h=void 0,(M.currentFrame=0)<M.frames.length&&(M.image=M.frames[0].image,"function"==typeof M.onloadone&&(M.onloadone.bind(M)({type:"load",path:[M]}),delete M.onloadone)),S(),"function"==typeof M.onloadall&&M.onloadall.bind(M)({type:"loadall",path:[M]}),M.playOnLoad&&M.play()}function y(){var e,t=a.data[a.pos++];t===s.GCExt?(a.pos++,e=a.data[a.pos++],M.disposalMethod=(28&e)>>2,M.transparencyGiven=!!(1&e),M.delayTime=a.data[a.pos++]+(a.data[a.pos++]<<8),M.transparencyIndex=a.data[a.pos++],a.pos++):t===s.COMMENT?M.comment+=a.readSubBlocks():t===s.APPExt?(a.pos+=1,"NETSCAPE"===a.getString(8)?a.pos+=8:(a.pos+=3,a.readSubBlocks())):(t===s.UNKNOWN&&(a.pos+=13),a.readSubBlocks())}function g(){if(void 0!==M.cancel&&!0===M.cancel)return m(),void("function"==typeof M.cancelCallback&&M.cancelCallback.bind(M)({type:"canceled",path:[M]}));var e=a.data[a.pos++];if(e===s.IMAGE){if(u(),M.firstFrameOnly)return void m()}else{if(e===s.EOF)return void m();y()}M.frames.length&&"function"==typeof M.onloadone&&(M.image=M.frames[0].image,M.onloadone.bind(M)({type:"load",path:[M]}),delete M.onloadone),"function"==typeof M.onprogress&&M.onprogress({bytesRead:a.pos,totalBytes:a.data.length,frame:M.frames.length}),t=setTimeout(g,0)}function f(e){"function"==typeof M.onerror&&M.onerror.bind(this)({type:e,path:[this]}),M.onload=M.onerror=void 0,M.loading=!1}function S(){M.currentFrame=0,M.nextFrameAt=M.lastFrameAt=(new Date).valueOf(),"function"==typeof M.onload&&M.onload.bind(M)({type:"load",path:[M]}),M.onerror=M.onload=void 0}function v(e){(a=new c(e)).pos+=6,M.width=a.data[a.pos++]+(a.data[a.pos++]<<8),M.height=a.data[a.pos++]+(a.data[a.pos++]<<8),e=a.data[a.pos++],M.colorRes=(112&e)>>4,M.globalColourCount=1<<1+(7&e),M.bgColourIndex=a.data[a.pos++],a.pos++,128&e&&(M.globalColourTable=p(M.globalColourCount)),t=setTimeout(g,0)}function b(){var e;0===M.playSpeed?M.pause():(e=M.playSpeed<0?(--M.currentFrame,M.currentFrame<0&&(M.currentFrame=M.frames.length-1),e=M.currentFrame,--e<0&&(e=M.frames.length-1),-M.frames[e].delay/M.playSpeed):(M.currentFrame+=1,M.currentFrame%=M.frames.length,+M.frames[M.currentFrame].delay/M.playSpeed),M.image=M.frames[M.currentFrame].image,n=setTimeout(b,e))}var M={onload:null,onerror:null,onprogress:null,onloadall:null,paused:!1,playing:!1,waitTillDone:!0,loading:!1,firstFrameOnly:!1,width:null,height:null,frames:[],comment:"",length:0,currentFrame:0,frameCount:0,playSpeed:1,lastFrame:null,image:null,playOnLoad:!0,load:function(e){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.onload=function(e){404===e.target.status?f("File not found"):200<=e.target.status&&e.target.status<300?v(t.response):f("Loading error : "+e.target.status)},t.open("GET",e,!0),t.send(),t.onerror=function(e){f("File error")},this.src=e,this.loading=!0},cancel:function(e){return!M.complete&&(M.cancelCallback=e,M.cancel=!0)},play:function(){M.playing||(M.paused=!1,M.playing=!0,b())},pause:function(){M.paused=!0,M.playing=!1,clearTimeout(n)},seek:function(e){clearTimeout(n),e<0&&(e=0),e*=1e3,e%=M.length;for(var t=0;e>M.frames[t].time+M.frames[t].delay&&t<M.frames.length;)t+=1;M.currentFrame=t,M.playing?b():M.image=M.frames[M.currentFrame].image},seekFrame:function(e){clearTimeout(n),M.currentFrame=e%M.frames.length,M.playing?b():M.image=M.frames[M.currentFrame].image},togglePlay:function(){M.paused||!M.playing?M.play():M.pause()},clear:function(){clearTimeout(n),clearTimeout(t),M.frames.length=0}};return M}function createMarker(r){for(var e={div:new Array},t=0;t<strPlayer.length;t++){var n=document.createElement("div");n.style.display="none",n.style.position="absolute",n.style.opacity=.7;var a=-1==r.team?"#EEE":1==r.team?"red":"blue",o=12*iScreenScale,i=3*iScreenScale,l=Math.PI/4,s=Math.round(iScreenScale/4),c=Math.cos(l),p=Math.sin(l),u=document.createElement("div");u.style.position="absolute",u.style.width=s+"px",u.style.height=i+"px",u.style.backgroundColor=a,u.style.left="0px",u.style.bottom="0px",u.style.transform=u.style.WebkitTransform=u.style.MozTransform="rotate("+Math.round(180*l/Math.PI)+"deg)",u.style.transformOrigin=u.style.WebkitTransformOrigin=u.style.MozTransformOrigin="bottom left",n.appendChild(u);u=document.createElement("div");u.style.position="absolute",u.style.width=o+"px",u.style.height=s+"px",u.style.backgroundColor=a,u.style.left=Math.round(i*Math.sin(l))+"px",u.style.bottom=Math.round(i*c-s*p)+"px",n.appendChild(u);s=document.createElement("div");s.style.color=-1==r.team?"#555":a,s.style.whiteSpace="nowrap";u=-1==r.team?"#EEE":1==r.team?"#fcc":"#ccf",a=Math.ceil(iScreenScale/4)+"px";s.style.textShadow="-"+a+" 0 "+u+", 0 "+a+" "+u+", "+a+" 0 "+u+", 0 -"+a+" "+u,r.nick?s.innerHTML=r.nick:(s.style.textTransform="capitalize",s.innerHTML=toPerso(r.personnage)),s.style.position="absolute",s.style.left=Math.round(i*p)+"px",s.style.bottom=Math.round(i*c)+"px",s.style.width=Math.round(o-.5*iScreenScale)+"px",s.style.overflow="hidden",s.style.fontSize=Math.round(1.5*iScreenScale)+"px",s.style.textAlign="right",n.appendChild(s),e.div.push(n),oContainers[t].appendChild(n)}return e.draw=function(e,t,n,a,o){o=o||0;var i=this.div[e];n>iHeight*iScreenScale||n+o*iScreenScale<12*iScreenScale?i.style.display="none":(i.style.display="block",a=Math.round(r.sprite[e].h*fSpriteScale*a),i.style.left=Math.round(t)+"px",i.style.top=Math.round(n-a/2)+"px")},e.render=function(e,t,n){var a=n.size||1,o=n.x-t.x,i=n.y-t.y,r=t.rotation*Math.PI/180,t=o*Math.cos(r)-i*Math.sin(r),o=o*Math.sin(r)+i*Math.cos(r),i=-iCamHeight,r=iCamDist+o,n=correctCamZ(n.z,r),r=i/r*iCamDist+iCamHeight-iViewHeight+n,t=-t/(o+iCamDist)*iCamDist;this.div[e].style.zIndex=Math.round(1e4-o);t=(iWidth/2+t)*iScreenScale,r=(iHeight-r)*iScreenScale,a*=fFocal/(fFocal+o);this.draw(e,t,r,a,n)},e}function redrawCanvas(e,t){var n=oViewCanvas.getContext("2d");n.fillStyle="rgb("+oMap.bgcolor+")",n.fillRect(0,0,oViewCanvas.width,oViewCanvas.height),n.save(),n.translate(iViewCanvasWidth/2,iViewCanvasHeight-iViewYOffset),n.rotate((180+t.rotation)*Math.PI/180);var a=t.x,o=t.y;oMapImg.image?n.drawImage(oMapImg.image,-a,-o):n.drawImage(oMapImg,-a,-o);for(var i=0;i<oMap.assets.length;i++){var r=oMap.assets[i];n.drawImage(r.canvas,r.x-a,r.y-o)}oMap.sea&&oMap.sea.render(n,[a,o],1),n.restore(),oScreens[e].getContext("2d").imageSmoothingEnabled=iSmooth;for(var l=oScreens[e].getContext("2d"),s=1/fLineScale,c=iViewCanvasHeight-iViewYOffset-1,p=iWidth*s,i=0;i<aStrips.length;i++){var u=aStrips[i];try{l.drawImage(oViewCanvas,(iViewCanvasWidth-u.stripwidth)/2,c-u.mapz,u.stripwidth,u.mapzspan,0,(iHeight-u.viewy)*s,p,1)}catch(e){}}}function byteType(e){return{key:e,type:"byte"}}function shortType(e){return{key:e,type:"short"}}function floatType(e){return{key:e,type:"float"}}function intType(e){return{key:e,type:"int"}}for(var itemBehaviors={banane:{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z")],fadedelay:100},fauxobjet:{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z")],fadedelay:100},poison:{size:.54,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z")],fadedelay:100},champi:{size:.54,sync:[floatType("x"),floatType("y"),floatType("z")],fadedelay:100},eclair:{size:1,sync:[intType("owner")],fadedelay:0,sprite:!1,onlineResync:!1,move:function(t){if(void 0===t.countdown){t.countdown=20;var e=aKarts.find(function(e){return e.id==t.owner});if(e){!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/lightning.mp3"),$mkScreen.style.opacity=.7;for(var n=0;n<aKarts.length;n++){var a=aKarts[n];friendlyFire(a,e)||(a.protect?a.megachampi=a.megachampi<8||a.etoile?a.megachampi:8:(isOnline&&n&&a.controller!=identifiant||(a.size=.6),a.mini=Math.round(Math.max(a.mini,120-40*(a.place-1)/(aKarts.length-1))),updateDriftSize(n),loseUsingItems(a),a.champi=0,a.spin(20),stopDrifting(n),dropCurrentItem(a)))}}}isOnline&&!t.id||(t.countdown--,t.countdown<=0&&(t.countdown<-50?detruit(t):t.disabled||(t.disabled=!0,$mkScreen.style.opacity=1)))},del:function(e){e.disabled||($mkScreen.style.opacity=1)}},bloops:{size:1,sync:[intType("owner")],fadedelay:0,sprite:!1,countdowns:[5,5,15,3,2,3,3,2,2,13,7,5,5,100,15],onlineResync:!1,move:function(t){if(!t.sprites){if(1<items.bloops.length)return void detruit(t);if(t.countdown=0,t.countstate=0,!(p=aKarts.find(function(e){return e.id==t.owner})))return!1;t.sprites=new Array(oPlayers.length);for(var e=0;e<aKarts.length;e++){var n,a=aKarts[e];a!==p&&(friendlyFire(a,p)||a.protect)||(e<oPlayers.length&&((s=(n={bloops:{elt:document.createElement("img"),mine:a===p}}).bloops.elt).src="images/sprites/sprite_blooper.png",s.className="pixelated",s.style.position="absolute",s.style.width=7*iScreenScale+"px",n.bloops.x=36,n.bloops.y=n.bloops.mine?18:12,s.style.zIndex=19001,s.style.opacity=n.bloops.mine?1:0,oContainers[e].appendChild(s),t.sprites[e]=n),a.bloops=t)}t.effective=function(e){return 13==this.countstate&&!e.unbloop&&this.owner!==e.id}}var o=itemBehaviors.bloops,i=o.countdowns[t.countstate],r=t.countdown/i;t.countdown++;for(var l=t.countdown/i,e=0;e<t.sprites.length;e++){var s,c=t.sprites[e],p=aKarts[e];if(c)if(s=c.bloops){switch(t.countstate){case 0:s.mine&&(s.y-=2,r||!iSfx||finishing||playSoundEffect("musics/events/bloops0.mp3"));break;case 1:s.mine&&(s.y-=.5*Math.cos(Math.PI*r/2),s.elt.style.opacity=1-l,t.countdown==i&&(oContainers[e].removeChild(s.elt),delete c.bloops));break;case 3:s.elt.style.opacity=l;break;case 4:r||!iSfx||finishing||e||playSoundEffect("musics/events/bloops.mp3"),s.y+=2;break;case 5:s.y-=2*Math.cos(Math.PI*r/2);break;case 6:s.x+=2,s.y-=2*Math.cos(Math.PI*(.2+r)/1.2);break;case 7:case 8:s.x+=2,s.y+=2;break;case 9:var u=Math.pow(Math.cos(Math.PI*r*.45),1.2);s.x-=6*Math.sin(1.5*Math.PI*r)*u,s.y-=4*Math.cos(1.5*Math.PI*r)*u;break;case 10:s.x+=2,s.y-=2.5*Math.cos(Math.PI*r);break;case 11:s.x-=Math.sin(Math.PI*l/2),--s.y;break;case 12:if(s.elt.style.opacity=1-l,!c.ink){for(var d=[],m=3e3;0<m;){var h=100+400*Math.random();m<h&&(h=m)<100&&(h=100),d.push(h),m-=h}c.ink=[];var u=iWidth/iHeight,y=Math.sqrt(d.length*u),u=y/u,g=Math.ceil(u),f=iWidth/y,S=iHeight/g,v=y*g/d.length;function b(e){return Math.random()-e}for(var M=0;M<d.length;M++){var x=(M+.5)*v,C=x/y,P=x%y*f,k=(Math.floor(C)+.5)*S,w=.5+((w=C%1)-.5)/2,x=.5+((x=(Math.floor(C)+.5)/g)-.5)/2,C=Math.sqrt(d[M]);(I={x:P+.6*C*b(w),y:k+.5*C*b(x),theta:360*Math.random(),w:C*(1+.1*b(.5)),h:C*(1+.1*b(.5))}).y-=1075/(I.w*I.h),c.ink.push(I)}for(M=0;M<c.ink.length;M++){var I=c.ink[M];(T=document.createElement("img")).src="images/sprites/sprite_ink.png",T.style.position="absolute",T.style.transform=T.style.WebkitTransform=T.style.MozTransform="rotate("+Math.round(I.theta)+"deg)",T.className="pixelated",T.style.zIndex=19e3,T.style.opacity=.95,oContainers[e].appendChild(T),I.elt=T}}for(M=0;M<c.ink.length;M++)(T=(I=c.ink[M]).elt).style.left=Math.round((I.x-I.w*l/2)*iScreenScale)+"px",T.style.top=Math.round((I.y-I.h*l/2)*iScreenScale)+"px",T.style.width=Math.round(I.w*l*iScreenScale)+"px",T.style.height=Math.round(I.h*l*iScreenScale)+"px";break;case 13:for(M=0;M<c.ink.length;M++){var T=(I=c.ink[M]).elt;I.y+=20/(I.w*I.h),T.style.top=Math.round((I.y-I.h/2)*iScreenScale)+"px"}break;case 14:for(M=0;M<c.ink.length;M++){T=(I=c.ink[M]).elt;I.y+=10/(I.w*I.h),T.style.top=Math.round((I.y-I.h/2)*iScreenScale)+"px",p.unbloop||(T.style.opacity=.95*(1-r))}}s.elt.style.left=iScreenScale*s.x+"px",s.elt.style.top=iScreenScale*s.y+"px"}}if(12<=t.countstate)for(e=0;e<aKarts.length;e++){p=aKarts[e];if(!p.unbloop&&(p.protect||p.champi||p.tombe)&&(p.unbloop=12==t.countstate&&p.protect?5:1),p.unbloop&&p.unbloop<=5){var E=p.unbloop/5;if(p.bloops===t&&t.owner!==p.id)for(M=0;M<oPlayers.length;M++)p.sprite[M].img.style.filter="brightness("+(.15+.85*E)+")";if((c=t.sprites[e])&&c.ink)for(M=0;M<c.ink.length;M++)(T=(I=c.ink[M]).elt).style.opacity=.95*(1-E);p.unbloop++}}switch(t.countstate){case 12:for(e=0;e<aKarts.length;e++)if(!(p=aKarts[e]).unbloop&&p.bloops===t&&t.owner!==p.id)for(M=0;M<oPlayers.length;M++)p.sprite[M].img.style.filter="brightness("+(1-.85*l)+")";break;case 14:for(e=0;e<aKarts.length;e++)if(!(p=aKarts[e]).unbloop&&p.bloops===t&&t.owner!==p.id)for(M=0;M<oPlayers.length;M++)p.sprite[M].img.style.filter="brightness("+(.15+.85*l)+")"}t.countdown>=i&&(t.countstate++,t.countdown=0,t.countstate>=o.countdowns.length&&detruit(t))},del:function(e){if(e.sprites){for(var t=0;t<e.sprites.length;t++){var n=e.sprites[t];if(n){n.bloops&&oContainers[t].removeChild(n.bloops.elt);var a=n.ink;if(a)for(var o=0;o<a.length;o++)oContainers[t].removeChild(a[o].elt)}}for(t=0;t<aKarts.length;t++)if(aKarts[t].bloops===e){for(o=0;o<oPlayers.length;o++)aKarts[t].sprite[o].img.style.filter="";delete aKarts[t].bloops,delete aKarts[t].unbloop}}}},carapace:{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("vx"),floatType("vy"),intType("owner"),byteType("lives")],fadedelay:300,move:function(e){var t=e.vx,n=e.vy;if(t||n){o=e.x+t,i=e.y+n;for(var a=0;a<oPlayers.length;a++)e.sprite[a].setState(1-e.sprite[a].getState())}else o=e.x,i=e.y;var o,i,r=e.x,l=e.y,s=o,c=i;-1!=e.owner&&tombe(r,l)||touche_banane(r,l)||touche_banane(s,c)||touche_crouge(r,l)||touche_crouge(s,c)||touche_cverte(r,l,[e])||touche_cverte(s,c,[e])?detruit(e,!0):-1==e.owner||canMoveTo(e.x,e.y,0,t,n)?(e.x=o,e.y=i,tendsToSpeed(e,8,.1)):(e.lives--,0<e.lives?(o=getHorizontality(e.x,e.y,t,n),i=Math.hypot(o[0],o[1]),i=t*(t=o[0]/i)+n*(o=o[1]/i),e.vx=2*i*t-e.vx,e.vy=2*i*o-e.vy):detruit(e))}},bobomb:{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown"),byteType("cooldown")],fadedelay:0,move:function(e){var t,n,a;-1!=e.theta&&(t=0,e.countdown?(e.countdown--,n=15*direction(0,e.theta),a=15*direction(1,e.theta),n=e.x+n,a=e.y+a,e.x=n,e.y=a,t=e.countdown):(tombe(e.x,e.y)&&detruit(e),30==--e.cooldown&&(e.cooldown-=12),e.cooldown<-10&&detruit(e)),e.z=2*(8-Math.abs(t-8)))},render:function(e,t){if(e.cooldown<=0){if(!t&&1==e.size){for(var n,a=0;a<strPlayer.length;a++)makeSpriteExplode(e,"explosion",a),"block"==e.sprite[a].div.style.display&&(n=a);isOnline||null==n?(e.size=6,playDistSound({x:e.x,y:e.y},"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,reprendre(!(e.size=6)),playDistSound({x:e.x,y:e.y},"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=1+e.cooldown/10}},drop:function(e,t){e.theta=t.rotation+180,e.cooldown=60,e.countdown=1}},"carapace-rouge":{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),intType("owner"),shortType("aipoint"),byteType("aimap"),intType("target")],fadedelay:300,move:function(t){for(var e=0;e<2;e++){if(-1!=t.owner){if(!e)for(var n=0;n<oPlayers.length;n++)t.sprite[n].setState(1-t.sprite[n].getState());if(0<=t.target){var a=aKarts.find(function(e){return e.id==t.target});if((S=Math.pow(a.x-t.x,2)+Math.pow(a.y-t.y,2))<500){if(s=a.x,c=a.y,a.using.length&&"fauxobjet"!=a.using[0].type){for(var o=Math.atan2(t.y-c,t.x-s)-(90-a.rotation)*Math.PI/180,i=2*Math.PI;o<0;)o+=i;for(;i<o;)o-=i;if(o>Math.PI&&(o=i-o),2.5<Math.abs(o))return s=a.using[0].x,c=a.using[0].y,t.x=s,t.y=c,detruit(t),void detruit(a.using[0],!0);a.using[0].x-=2*direction(0,a.rotation),a.using[0].y-=2*direction(1,a.rotation)}e=1}else{S=Math.sqrt(S);var r=5*(a.x-t.x)/S,l=5*(a.y-t.y)/S,s=t.x+r,c=t.y+l}}else{if(0<=t.aipoint){(h=(r=(m=(y=oMap.aipoints[t.aimap])[t.aipoint])[0]-t.x)*r+(l=m[1]-t.y)*l)<100&&(t.aipoint<y.length-1?t.aipoint++:t.aipoint=0);var p=Math.sqrt(r*r+l*l)/5;r/=p,l/=p}else if(-1==t.aipoint){if("BB"!=course)for(var u=1250,d=0;d<oMap.aipoints.length;d++)for(var m,h,y=oMap.aipoints[d],n=0;n<y.length;n++)(h=((m=y[n])[0]-t.x)*(m[0]-t.x)+(m[1]-t.y)*(m[1]-t.y))<u&&(t.aimap=d,t.aipoint=n+1,t.aipoint==y.length&&(t.aipoint=0),u=h);r=5*direction(0,t.theta),l=5*direction(1,t.theta)}else r=2.5*direction(0,t.theta),l=2.5*direction(1,t.theta);if(s=t.x+r,c=t.y+l,-2!=t.aipoint){for(var g=4e3,n=0;n<aKarts.length;n++){var f,S,v,b=aKarts[n];b.id==t.owner||sameTeam(t.team,b.team)||b.tombe||b.loose||(f=b.x-s,v=b.y-c,(S=Math.pow(f,2)+Math.pow(v,2))<g&&(v=r*f+l*v,.4<(v/=Math.sqrt(S*(r*r+l*l)))&&(g=S,a=b)))}a&&(t.target=a.id,oPlayers[0],isOnline&&(a.id==identifiant||a.controller==identifiant||isControlledByPlayer(t.owner))&&syncItems.push(t))}}}else s=t.x,c=t.y;r=s-t.x,l=c-t.y;if(-1!=t.owner&&(tombe(s,c)||!canMoveTo(t.x,t.y,0,r,l))||touche_banane(s,c)||touche_banane(t.x,t.y)||touche_crouge(s,c,[t])||touche_crouge(t.x,t.y,[t])||touche_cverte(s,c)||touche_cverte(t.x,t.y))return void detruit(t);t.x=s,t.y=c}}},"carapace-bleue":{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),intType("target"),byteType("cooldown"),shortType("aipoint"),byteType("aimap")],fadedelay:0,cooldown0:15,cooldown1:2,move:function(e){var t=-1;if(-1!=e.target)for(var t=-1,n=0;n<aKarts.length;n++)if(aKarts[n].id==e.target){t=n;break}if(-1==e.aipoint)if(0<e.cooldown){var a=aKarts[t],o=e.x-a.x,i=e.y-a.y,r=o*o+i*i,l=itemBehaviors["carapace-bleue"];if(e.cooldown==l.cooldown0)if(100<r){o/=c=Math.sqrt(r)/10,i/=c;for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(1-e.sprite[n].getState())}else e.cooldown--;else{e.cooldown<5&&(s=32,0<a.champi?a.champi<(a.champior?8:16)&&(s=200):a.turbodrift&&(s=64),s<r&&(o/=c=Math.sqrt(r/s),i/=c));r=(e.cooldown-l.cooldown1)/(l.cooldown0-l.cooldown1);r<0&&(r=0);var s=8*r,c=8*r,l=2*Math.PI*r,r=a.rotation*Math.PI/180;e.z=23-c*Math.cos(l),o-=s*Math.sin(l)*Math.cos(r),i+=s*Math.sin(l)*Math.sin(r);for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(Math.round(Math.random()));if(e.cooldown--,!e.cooldown)for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(0)}e.x-=o,e.y-=i}else{e.z=0,isOnline&&isControlledByPlayer(e.target)&&e.cooldown<-10&&(e.cooldown=0),e.cooldown--;var p=isOnline&&!isControlledByPlayer(e.target)?-70:-10;e.cooldown<p&&detruit(e)}else{i="BB"==course;if(!i)for(var u=oMap.aipoints[e.aimap],d=12,m=e.x,h=e.y;0<d;){var y=u[e.aipoint],g=Math.hypot(y[0]-e.x,y[1]-e.y);d<g?(e.x+=(y[0]-e.x)*d/g,e.y+=(y[1]-e.y)*d/g,d=0):(d-=g,e.x=y[0],e.y=y[1],e.aipoint++,e.aipoint===u.length&&(e.aipoint=0))}if(-1==t){t=aKarts.length-1;for(var f=1;f<=aKarts.length;f++)for(n=0;n<aKarts.length;n++)if(aKarts[n].place==f){(aKarts[n].tours<=oMap.tours||"BB"==course)&&!sameTeam(e.team,aKarts[n].team)&&(t=n,f=aKarts.length);break}}p=((a=aKarts[t]).x-e.x)*(a.x-e.x)+(a.y-e.y)*(a.y-e.y);(p<2e4||i)&&((-1!=e.target||isOnline&&a.id!=identifiant&&a.controller!=identifiant)&&!i||(e.target=a.id,isOnline&&syncItems.push(e)),-1!=e.target&&(h=(a.x-m)*(a.x-m)+(a.y-h)*(a.y-h),(p<5e3||h<p||i)&&(e.aipoint=-1)));for(n=0;n<oPlayers.length;n++)e.sprite[n].setState(1-e.sprite[n].getState())}},render:function(e,t){if(e.cooldown<=0){if(!t&&1==e.size){for(var n,a=0;a<strPlayer.length;a++)makeSpriteExplode(e,"explosionB",a),"block"==e.sprite[a].div.style.display&&(n=a);for(var o=-1,a=0;a<aKarts.length;a++)if(aKarts[a].id==e.target){o=a;break}isOnline||null==n?(e.size=8,playDistSound(aKarts[o],"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,reprendre(!(e.size=8)),playDistSound(aKarts[o],"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=Math.max(1+e.cooldown/10,0)}}}},itemTypes=["banane","fauxobjet","carapace","bobomb","poison","carapace-rouge","carapace-bleue","eclair","bloops","champi"],items={},i=0;i<itemTypes.length;i++)items[itemTypes[i]]=[];var decorBehaviors={taupe:{spin:20,init:function(e,t,n){3<e.length||(e[3]=0,e[4]=n%2?9:0)},move:function(e){if(e[4]++,0<=e[4])if(e[4]){if(e[3]+=e[4]<4?2:-1,10==e[4]){e[4]=-20,e[3]=10;for(var t=0;t<oPlayers.length;t++)e[2][t].img.style.display="none"}}else{for(t=0;t<oPlayers.length;t++)e[2][t].img.style.display="block";e[3]=0}}},poisson:{spin:20,movable:!0,preinit:function(e){this.scope={limite:new Array};for(var t=0;t<e.length;t++)this.scope.limite[t]=[0,0]},init:function(e,t,n){3<e.length||(e[3]=[3,0][n%2],e[4]=[-1,1][n%2])},move:function(e,t){if(e[3]+=e[4],e[3]){if(3==e[3]){e[4]=-1;for(var n=0;n<2;n++){var a=Math.floor(9*Math.random())-4;10<Math.abs(this.scope.limite[t][n]+a)&&(a=-a),this.scope.limite[t][n]+=a,e[n]+=a}}}else e[4]=1}},cheepcheep:{spin:20,movable:!0,preinit:function(e){this.preinit=decorBehaviors.poisson.preinit.bind(this),this.init=decorBehaviors.poisson.init.bind(this),this.move_=decorBehaviors.poisson.move.bind(this),this.preinit(e)},move:function(e,t,n){if(this.move_(e,t,n),e[3]%3==0)for(var a=0;a<oPlayers.length;a++)e[2][a].setState(e[3]?1:0)}},plante:{spin:20,init:function(e,t,n){3<e.length||(e[3]=void 0,e[4]=(1+2*n)%8)},move:function(e){if(e[4]++,4==e[4])for(var t=0;t<oPlayers.length;t++)e[2][t].setState(1);else if(8==e[4]){for(t=0;t<oPlayers.length;t++)e[2][t].setState(0);e[4]=0}}},thwomp:{spin:20,init:function(e,t,n){3<e.length||(e[3]=[20,0][n%2],e[4]=[0,10][n%2])},move:function(e){e[4]<0?(e[4]++,e[4]||(e[4]=-1,e[3]<20?e[3]+=2:e[4]=20)):e[4]?e[4]--:(e[3]-=8,e[3]<0&&(e[3]=0,e[4]=-15))}},spectre:{spin:20,init:function(e,t,n){decorBehaviors.thwomp.init(e,t,n)},move:function(e){decorBehaviors.thwomp.move(e)}},tree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=50,e[2][t].h=100,e[2][t].z=.12}},crabe:{spin:20,movable:!0,transparent:!0,preinit:function(e){"BB"==course&&(this.dodgable=!0)},init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=3,e[2][a].h=30,e[2][a].w=16*e[2][a].h/17;null==e[4]&&(e[4]=1e4*Math.sin(n+1)%Math.PI);var o=e[5];for(null==o&&(o=137*n%400),e[5]=0;e[5]!=o;)this.move(e)},hSpeed:.7,handleState:function(e,t){if(0==(t%=16))for(var n=0;n<strPlayer.length;n++)e[2][n].setState(0);else if(4==t||12==t)for(n=0;n<strPlayer.length;n++)e[2][n].setState(1);else if(8==t)for(n=0;n<strPlayer.length;n++)e[2][n].setState(2)},move:function(e){var t,n,a=e[5]+50,o=Math.min(a%100,99-a%100);5<=o&&(t=this.hSpeed*Math.cos(e[4]),n=this.hSpeed*Math.sin(e[4]),o<8&&(t*=.5,n*=.5),this.handleState(e,a),a%200<100?(e[0]+=t,e[1]+=n):(e[0]-=t,e[1]-=n)),e[5]++,400<=e[5]&&(e[5]=0)}},goomba:{spin:20,movable:!0,transparent:!0,dodgable:!0,preinit:function(e){this.init_=decorBehaviors.crabe.init.bind(this),this.move=decorBehaviors.crabe.move.bind(this)},init:function(e,t,n){this.init_(e,t,n);for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=2,e[2][a].w=32,e[2][a].h=36},handleState:function(e,t){if(0==(t%=8))for(var n=0;n<strPlayer.length;n++)e[2][n].setState(0);else if(4==t)for(n=0;n<strPlayer.length;n++)e[2][n].setState(1)},hSpeed:.3},firesnake:{spin:42,minSpeedToSpin:3.2,unbreaking:!0,movable:!0,transparent:!0,dodgable:!0,hitbox:6,hitboxH:7,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=3,e[2][a].img.style.display="none";e[3]=10,e[4]||(e[4]=(1+50*n)%280),e[5]||(e[5]=0),e[6]||(e[6]=0),e[7]=[e[0],e[1]],e[8]=[e[0],e[1]],e[9]=[e[0],e[1]],e[0]=-10,e[1]=-10},move:function(e,t,n){var a=timer+n;switch(oPlayers[0].cpu&&(a=1e4*Math.random()),e[5]){case 0:if(e[4]--,e[4]<=0){for(var o=0;o<strPlayer.length;o++)e[2][o].img.style.display="block";e[0]=e[7][0]+10*Math.sin(a),e[1]=e[7][1]+10*Math.sin(a+1),e[8][0]=e[0],e[8][1]=e[1],e[9][0]=e[0]+10*Math.sin(a+2),e[9][1]=e[1]+10*Math.sin(a+3),e[3]=50,e[5]=1}break;case 1:if(e[3]-=4,e[3]<=0){e[3]=0,e[4]=20,e[5]=2,e[6]=5;for(o=0;o<strPlayer.length;o++)e[2][o].setState(1)}var i=e[3]/40;e[9][0]+=i*(e[8][0]-e[9][0]),e[9][1]+=i*(e[8][1]-e[9][1]),e[0]=e[9][0],e[1]=e[9][1];break;case 2:var r=(18-e[4])/18;if(0<=r){var l=n%2?1:-1;if(e[0]=e[9][0]-4*r*l*Math.cos(4*r)+r*Math.sin(a),e[1]=e[9][1]-4*r*l*Math.sin(4*r)+r*Math.sin(a+1),e[3]=Math.max(1.2*Math.sin(4*r)+.3*r*Math.sin(a+1),0),e[4]%6==3)for(o=0;o<strPlayer.length;o++)e[2][o].setState(3-e[2][o].getState())}e[4]--,e[4]<=0&&(e[5]=3,e[8][0]=e[0],e[8][1]=e[1],e[4]=0,e[9][0]=e[7][0]+10*Math.sin(a),e[9][1]=e[7][1]+10*Math.sin(a+1));break;case 3:e[4]++;i=Math.min(e[4]/20,1);e[0]=e[8][0]+i*(e[9][0]-e[8][0]),e[1]=e[8][1]+i*(e[9][1]-e[8][1]),e[3]=30*i*(1-i),1==i&&(e[6]--,e[6]<=0?(e[5]=4,e[4]=1):(e[5]=2,e[4]=20,e[5]=2));break;case 4:if(e[4]-=.2,e[4]<0){for(o=0;o<strPlayer.length;o++)e[2][o].img.style.display="none",e[2][o].img.style.opacity=1,e[2][o].setState(0);e[0]=-10,e[1]=-10,e[4]=50,e[5]=0,e[6]=0}else for(o=0;o<strPlayer.length;o++)e[2][o].img.style.opacity=e[4]}}},fireplant:{hitbox:7,unbreaking:!0,preinit:function(){oMap.decor.fireball?this.fireball0=oMap.decor.fireball.length:(this.fireball0=0,oMap.decor.fireball=new Array);for(var e=0;e<oMap.decor[this.type].length;e++)oMap.decor.fireball.push([-10,-10])},init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=4,e[2][a].w=54,e[2][a].h=40*e[2][a].w/24,e[2][a].z=.16;null==e[4]&&(e[4]=1e4*Math.sin(n+1)%(2*Math.PI)),null==e[5]&&(e[5]=17*n%65),e[6]=e[4],e[7]=0},move:function(e,t){if(e[5]--,e[4]=e[6]+.5*Math.sin(e[7]),e[7]+=.05,e[7]%=2*Math.PI,-1==e[5])for(var n=0;n<strPlayer.length;n++)e[2][n].setState(e[2][n].getState()+1);else if(-7==e[5]){var a=oMap.decor.fireball[this.fireball0+t];a[0]=e[0],a[1]=e[1];for(n=0;n<strPlayer.length;n++)a[2][n].img.style.display="block",a[2][n].setState(0);a[3]=10,a[4]=e[4],a[5]=0,a[6]=35}else if(-9==e[5]){for(n=0;n<strPlayer.length;n++)e[2][n].setState((e[2][n].getState()+1)%4);e[5]=Math.round(60+10*Math.sin(e[7]))}}},fireball:{spin:42,unbreaking:!0,movable:!0,transparent:!0,hitboxH:6,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=4,e[2][n].img.style.display="none"},move:function(e){if(0<=e[6])if(e[0]+=7*Math.cos(e[4]),e[1]+=7*Math.sin(e[4]),e[3]+=e[5],e[3]<0&&(e[3]=0,e[5]=5),e[5]-=3,e[6]--,e[6]<0){e[0]=-10,e[1]=-10;for(var t=0;t<strPlayer.length;t++)e[2][t].img.style.display="none"}else if(e[6]%2==0)for(t=0;t<strPlayer.length;t++)e[2][t].setState((e[2][t].getState()+3)%4)}},piranhaplant:{spin:20,preinit:function(e){this.init_=decorBehaviors.plante.init.bind(this),this.move=decorBehaviors.plante.move.bind(this)},init:function(e,t,n){this.init_(e,t,n);for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=2,e[2][a].w=32,e[2][a].h=48,e[2][a].z=.1}},firebar:{spin:42,transparent:!0,unbreaking:!0,movable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].w=32,e[2][a].h=192,e[2][a].z=.035;null==e[4]&&(e[4]=[[e[0],e[1],0,40],[e[0],e[1],20,40]]),null==e[5]&&(e[5]=Math.round(1e4*Math.abs(Math.sin(n+3)))%e[4].length),null==e[6]&&(e[6]=2*Math.round(1e4*Math.abs(Math.sin(n+2))%1)-1),null==e[7]&&(e[7]=Math.round(1e4*Math.abs(Math.sin(n+1)))%40)},move:function(e,t){if(e[7])e[7]--;else{var n=e[4][e[5]],a=n[0]-e[0],o=n[1]-e[1],i=n[2]-e[3],r=0<i?4:8,l=Math.hypot(a,o),s=!0;.88<l?(e[0]+=.88*a/l,e[1]+=.88*o/l,s=!1):(e[0]=n[0],e[1]=n[1]);l=e[3];if(r<Math.abs(i)?(e[3]+=Math.sign(i)*r,s=!1):e[3]=n[2],l!=e[3])for(var c=Math.max(0,1-e[3]/20),p=0;p<strPlayer.length;p++){var u=e[2][p].img;u.style.transform=u.style.WebkitTransform=u.style.MozTransform="scale("+c+")"}s&&(e[7]=n[3],e[5]+=e[6],e[5]<0?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1))}}},fire3star:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){oMap.decor.fireballs||(oMap.decor.fireballs=new Array);for(var t=0;t<e.length;t++){var n,a=e[t];null==a[3]&&(a[3]=18),null==a[4]?(n=getDecorParams(this,t),a[4]=Math.PI/2+n.dir,isNaN(a[4])&&(a[4]=1e4*Math.sin(t+2)%Math.PI),a[5]=.1):null==a[5]&&(a[5]=.1*(t%2?1:-1)),null==a[6]&&(a[6]=1e4*Math.sin(t+1)%Math.PI);for(var o=[],i=0;i<3;i++){for(var r=[],l=0;l<2;l++){var s=[a[0],a[1],void 0,a[3]];oMap.decor.fireballs.push(s),r.push(s)}o.push(r)}s=[a[0],a[1],void 0,correctZInv(a[3])];oMap.decor.fireballs.push(s),o.push([s]),a[7]=o}},init:function(e,t,n){this.move(e,t,n)},move:function(e,t){for(var n=e[0],a=e[1],o=e[3],i=e[4],r=e[5],l=e[6],s=Math.cos(i),c=Math.sin(i),p=e[7],u=0;u<3;u++)for(var d=l+2*u*Math.PI/3,m=Math.cos(d),h=Math.sin(d),y=p[u],g=0;g<2;g++){var f=y[g],S=7.5*(g+1);f[0]=n+S*s*m,f[1]=a-S*c*m,f[3]=correctZInv(o+S*h)}e[6]+=r,e[6]%=2*Math.PI}},firering:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){oMap.decor.fireballs||(oMap.decor.fireballs=new Array);for(var t=0;t<e.length;t++){var n,a=e[t];null==a[3]&&(a[3]=18),null==a[4]?(n=getDecorParams(this,t),a[4]=Math.PI/2+n.dir,isNaN(a[4])&&(a[4]=1e4*Math.sin(t+2)%Math.PI),a[5]=.1):null==a[5]&&(a[5]=.1*(t%2?1:-1)),null==a[6]&&(a[6]=1e4*Math.sin(t+1)%Math.PI);for(var o=[],i=0;i<5;i++){var r=[a[0],a[1],void 0,a[3]];oMap.decor.fireballs.push(r),o.push(r)}a[7]=o}},init:function(e,t,n){this.move(e,t,n)},move:function(e,t){for(var n=e[0],a=e[1],o=e[3],i=e[4],r=e[5],l=e[6],s=Math.cos(i),c=Math.sin(i),p=e[7],u=0;u<p.length;u++){var d=l+2*u*Math.PI/5,m=Math.cos(d),h=Math.sin(d),d=p[u];d[0]=n+15*s*m,d[1]=a-15*c*m,d[3]=correctZInv(o+15*h)}e[6]+=r,e[6]%=2*Math.PI}},fireballs:{unbreaking:!0,transparent:!0,spin:42,movable:!0,hitboxH:6,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=1,e[2][n].w=24,e[2][n].h=e[2][n].w}},billball:{hitbox:10,unbreaking:!0,transparent:!0,spin:42,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0;t<e.length;t++){var n=getDecorParams(this,t);null==(i=e[t])[3]&&(i[3]=3),null==i[4]&&(i[4]=90+180*n.dir/Math.PI,isNaN(i[4])&&(i[4]=180))}for(t=1;t<4;t++){var a=oMap.decor["billball"+t];if(a){for(var o=0;o<a.length;o++){var i=a[o];e.push([i[0],i[1],null,null,180-90*t])}a.length=0}}var r=getDecorExtra(this,!0),l=0;if(r.nb)for(t=l=e.length;t<r.nb;t++)e.push(e[t%l].slice(0));else l=Math.round(4*e.length/5);for(t=0;t<e.length;t++){n=getDecorParams(this,t);(i=e[t])[6]=[i[0],i[1],i[3],i[4],n.length||460]}this.initPos=[];for(t=0;t<l;t++){var s=e[t][6].slice();s.push(0),this.initPos.push(s)}},init:function(e,t){this.easeInOut=decorBehaviors.truck.easeInOut,null==e[5]&&(e[5]=1+20*t);for(var n=0;n<strPlayer.length;n++)e[2][n].w=80,e[2][n].h=80,e[5]&&(e[0]=-10,e[1]=-10,e[2][n].img.style.display="none")},move:function(e,t){if(!t)for(var n=0;n<this.initPos.length;n++)(o=this.initPos[n])[o.length-1]&&o[o.length-1]--;if(0<e[5]){if(e[5]--,e[5]<=0){e[5]=0,e[0]=e[6][0],e[1]=e[6][1];for(n=0;n<strPlayer.length;n++)e[2][n].img.style.display="block"}}else if(e[5]<0){if(e[5]<=-10){for(var a=1,n=e[5]=0;n<100;n++){var o,i=oPlayers[0].cpu?Math.floor(Math.random()*this.initPos.length):Math.round(1e4*Math.abs(Math.sin(timer+n)))%this.initPos.length;if(!(o=this.initPos[i])[o.length-1])break}var r=this.initPos[i];r[r.length-1]=20;for(n=0;n<5;n++)e[6][n]=this.initPos[i][n];e[0]=e[6][0],e[1]=e[6][1],e[3]=e[6][2],e[4]=e[6][3]}else a=1-e[5]/-10,e[3]=e[6][2]*Math.sqrt(a),e[5]--;for(n=0;n<oPlayers.length;n++)e[2][n].img.style.opacity=a}else{t=(180-e[4])*Math.PI/180,r=e[6][4];e[0]+=5*Math.cos(t),e[1]+=5*Math.sin(t),(e[0]-e[6][0])*(e[0]-e[6][0])+(e[1]-e[6][1])*(e[1]-e[6][1])>r*r&&(e[5]=-1)}for(n=0;n<oPlayers.length;n++){var l=(s=nearestAngle(getApparentRotation(oPlayers[n])+90-e[4],180,360))%180/180,l=this.easeInOut(l),s=180*Math.floor(s/180)+180*l,s=Math.round(11*s/180)%22;21<s&&(s-=22),e[2][n].setState(s)}}},tortitaupe:{spin:20,preinit:function(e){this.init_=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)},init:function(e,t,n){this.init_(e,t,n);for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=1,e[2][a].w=24,e[2][a].h=36}},topitaupe:{spin:20,preinit:function(e){this.init=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)}},coconut:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.36}},palm:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.38}},mountaintree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=64*e[2][t].h/126,e[2][t].z=.15}},mariotree:{hidable:!0,hitbox:3,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=104,e[2][t].w=e[2][t].h/2,e[2][t].z=.12}},fir:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=e[2][t].h,e[2][t].z=.38}},movingtree:{hitbox:11.5,movable:!0,unbreaking:!0,init:function(e,t,n){for(var a,o=0;o<strPlayer.length;o++)e[2][o].nbSprites=1,e[2][o].w=85,e[2][o].h=139*e[2][o].w/115,e[2][o].z=.12,e[3]=0,e[4]||(a=n%2?1:-1,e[4]=[[e[0]+25*a,e[1]],[e[0],e[1]-25*a],[e[0]-25*a,e[1]],[e[0],e[1]+25*a]]),null==e[5]&&(e[5]=n%e[4].length),null==e[6]&&(e[6]=0)},move:function(e){var t,n,a;e[6]?e[6]--:(t=(a=e[4][e[5]])[0]-e[0])*t+(n=a[1]-e[1])*n<1?(e[5]=(e[5]+1)%e[4].length,e[6]=10):(a=Math.hypot(t,n),e[0]+=1.1*t/a,e[1]+=1.1*n/a)}},sinistertree:{hidable:!0,hitbox:9,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=117,e[2][t].h=126,e[2][t].z=.37}},pokey:{spin:42,movable:!0,dodgable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=5,e[2][a].h=82,e[2][a].w=23*e[2][a].h/45,e[2][a].z=.1;e[3]=0,null==e[4]&&(e[4]=[15,15]),2==e[4].length&&e[4].unshift(e[0],e[1]),null==e[5]&&(e[5]=[1e4*Math.sin(n+1)%Math.PI,.025*Math.sign(Math.sin(1+100*n))]),null==e[6]&&(e[6]=Math.floor(1e4*Math.pow(Math.sin(n+1),2))%16),this.repos(e)},repos:function(e){var t=e[5][0],n=e[4];e[0]=n[0]+n[2]*Math.cos(t),e[1]=n[1]+n[3]*Math.sin(t)},move:function(e){e[5][0]=(e[5][0]+e[5][1])%(2*Math.PI),e[6]++;if(e[6]%2==0){var t=e[6]/2,n=[0,1,2,1,0,3,4,3];n.length<=t&&(t=0,e[6]=0);for(var a=0;a<strPlayer.length;a++)e[2][a].setState(n[t])}this.repos(e)}},falltree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=72,e[2][t].h=150*e[2][t].w/100,e[2][t].z=.24}},peachtree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=27,e[2][t].h=4*e[2][t].w,e[2][t].z=.01}},box:{breaking:!0,bonus:!0},snowman:{breaking:!0,spin:42},snowball:{hitbox:7,spin:42,unbreaking:!0,movable:!0,defaultspeed:3.5,boostspeed:8,jumpspeed:function(e){return+e+4},jumpheight:32,spritesize:56,ondie:function(e){return-100<e?"wait":"respawn"},preinit:function(e){e.length&&null==e[0][4]&&(this.init=decorBehaviors.cannonball.init.bind(this),this.move_=decorBehaviors.cannonball.move.bind(this),this.move=function(e,t,n){for(var a=0;a<oPlayers.length;a++)e[2][a].setState((e[2][a].getState()+1)%3);this.move_(e,t,n)},this.setdir=decorBehaviors.cannonball.setdir.bind(this),this.autojump=decorBehaviors.cannonball.autojump.bind(this))},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=3,e[2][t].w=56,e[2][t].h=56,e[2][t].z=.28;e[3]=0,e[4].unshift([e[0],e[1]]),e[5]=[1,0]},move:function(e){for(var t=3.5,n=0;n<oPlayers.length;n++)e[2][n].setState((e[2][n].getState()+1)%3);for(;0<t;)if(e[5][0]<e[4].length){var a=e[4][e[5][0]];a[2]&&3.5==t&&(t=a[2]);var o=a[0],i=a[1],r=o-e[0],l=i-e[1],s=Math.hypot(r,l);e[3]=0,s<t?(e[0]=o,e[1]=i,e[5][0]++,t-=s):(e[0]+=r*t/s,e[1]+=l*t/s,t=0,a[3]&&(l=e[4][e[5][0]-1],(l=(1-s/Math.hypot(o-l[0],i-l[1]))/a[3][1])<1&&(e[3]=4*a[3][0]*l*(1-l))))}else if(t=0,e[5][1]++,e[5][1]<10)for(var c=0;c<oPlayers.length;c++)e[2][c].img.style.opacity=1-e[5][1]/10;else if(10==e[5][1]){e[3]=10,e[0]=-100,e[1]=-100;for(c=0;c<oPlayers.length;c++)e[2][c].img.style.opacity="",e[2][c].img.style.display="none"}else if(104<=e[5][1]){e[5][0]=1,e[5][1]=0,e[0]=e[4][0][0],e[1]=e[4][0][1];for(c=0;c<oPlayers.length;c++)e[2][c].img.style.display="block";e[3]=0}}},cannonball:{hitbox:8,spin:42,unbreaking:!0,movable:!0,defaultspeed:5,jumpspeed:function(e){return 6+1.5*e},jumpheight:48,boostspeed:11,spritesize:60,ondie:function(){return"suppr"},setdir:function(e,t,n,a){a=a||e;var o=oMap.w+oMap.h;e[4][0][0]=a[0]+o*t,e[4][0][1]=a[1]+o*n,e[4][1][0]=a[0]-o*t,e[4][1][1]=a[1]-o*n},autojump:function(e,t,n,a){e[6][4]&&a<this.boostspeed&&(t*=this.boostspeed/a,n*=this.boostspeed/a,a=this.boostspeed);var o=Math.hypot(t,n);e[4][2]=[e[0]+t,e[1]+n],e[5][2]={jump:1,loop:[0]},e[6][0]=2,e[6][2]=a,e[6][3]=o,this.setdir(e,t/o,n/o,e[4][2])},init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites||(e[2][a].nbSprites=1,e[2][a].w=this.spritesize,e[2][a].h=this.spritesize,e[2][a].z=.33);e[3]=0,e[4]||(e[4]=[[],[]],t=getDecorParams(this,t).dir,isNaN(t)&&(t=1e4*Math.sin(n+2)%Math.PI),this.setdir(e,Math.sin(t),Math.cos(t)),e[5]||(e[5]={0:{autoDir:!0,pos0:[e[0],e[1]]},1:{autoDir:!0,loop:[0]}})),e[5]||(e[5]={}),e[6]=[0,0,5]},move:function(e,t,n){var a=e[6][2];for(e[6][4]&&(a=Math.max(this.boostspeed,a),e[6][4]--);0<a;){var o,i=e[4][e[6][0]],r=i[0],l=i[1],s=r-e[0],c=l-e[1],p=Math.hypot(s,c),i=e[5][e[6][0]];if(p<a)e[0]=r,e[1]=l,i&&i.loop?(o=i.loop[0],e[6][1]?(e[6][1]--,e[6][1]||(o=e[6][0]+1)):i.loop[1]&&(e[6][1]=i.loop[1]),e[6][0]=o):e[6][0]++,i&&i.speed?e[6][2]=i.speed:e[6][2]=this.defaultspeed,i&&i.jump?(o=e[4][e[6][0]],e[6][3]=Math.hypot(o[0]-r,o[1]-l)):e[6][3]=0,e[3]=0,a-=p;else{r=s*a/p,l=c*a/p;if(i)if(isNaN(i.flipper)||((M=oMap.flippers[i.flipper])[3][0]||(M[3][1]=Math.max(0,Math.floor(p/a)-2))),i.autoDir)if(e[6][1]<0){for(var u=Math.max(0,1+e[6][1]/10),d=0;d<oPlayers.length;d++)e[2][d].img.style.opacity=u;if(u)e[6][1]--;else switch(this.ondie(e[6][1])){case"wait":e[0]=3*oMap.w,e[1]=3*oMap.h,e[6][1]--;break;case"suppr":oMap.decor[this.type][t][2][0].suppr(),oMap.decor[this.type].splice(t,1);break;case"respawn":for(d=0;d<oPlayers.length;d++)e[2][d].img.style.opacity="";e[0]=e[5][0].pos0[0],e[1]=e[5][0].pos0[1],e[4]=null,e[5]=null,this.init(e,t,n)}l=r=0}else{var m,h,y,g,f,S,v,b,M=inCannon(e[0],e[1]);M&&(m=17,this.autojump(e,M[0],M[1],m)),i.jump||(e[3]=0,e[6][3]=0),e[3]||(M=oMap.decor[this.type],oMap.decor[this.type]=[],(i=sauts(e[0],e[1],r,l))?(m=this.jumpspeed(i),S=s*(h=32*i)/p,v=c*h/p,this.autojump(e,S,v,m)):canMoveTo(e[0],e[1],0,r,l)?(i=touche_asset(e[0],e[1],e[0]+r,e[1]+l))?"bumpers"===i[0]&&(g=r,f=l,c=i[1],h=e[0]+g,y=e[1]+f,b=c[1][0],i=c[1][1],c=e[0]-b,b=e[1]-i,c=h-(i=g*(c=c/(i=Math.hypot(c,b)))+f*(b=b/i))*c,b=y-i*b,g=e[0]+2*(c-e[0])-h,f=e[1]+2*(b-e[1])-y,b=Math.hypot(g,f),this.setdir(e,g/b,f/b),l=r=0):tombe(e[0]+r,e[1]+l)?e[6][1]=-1:accelere(e[0],e[1],r,l)&&(e[6][4]=20):(y=getHorizontality(e[0],e[1],r,l),b=Math.hypot(y[0],y[1]),S=2*(b=r*(g=y[0]/b)+l*(f=y[1]/b))*g-r,v=2*b*f-l,b=Math.hypot(S,v),this.setdir(e,S/b,v/b),l=r=0),oMap.decor[this.type]=M)}e[0]+=r,e[1]+=l,e[6][3]&&(p=(p-a)/e[6][3],p=Math.max(Math.min(p,1),0),e[3]=this.jumpheight*p*(1-p)),a=0}}}},truck:{hitbox:8,spin:42,unbreaking:!0,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0;t<e.length;t++){var n,a=e[t];null==a[5]&&(n=getDecorParams(this,t),a[5]=n.traject)}},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=22,e[2][t].w=118,e[2][t].h=56*e[2][t].w/111,e[2][t].z=.72;var n=getDecorExtra(this,!0);if(n.path||(n.path=oMap.aipoints),!e[6]){var a=1/0,o=null!=e[5];o||(e[5]=0);for(var i=e[6]=0;i<n.path.length;i++)if(!o||i==e[5])for(var r=n.path[i],t=0;t<r.length;t++){var l=((s=r[t])[0]-e[0])*(s[0]-e[0])+(s[1]-e[1])*(s[1]-e[1]);l<a&&(a=l,e[5]=i,e[6]=t)}}(r=n.path[e[5]]).length<2&&(r.length||(r=[[e[0],e[1]]]),r.push([r[0][0]+.001,r[0][1]+.001]),n.path[e[5]]=r);var s=r[e[6]],c=(e[6]+1)%r.length,p=r[c];(s[0]-e[0])*(p[0]-s[0])+(s[1]-e[1])*(p[1]-s[1])<0&&(e[6]=c,s=p);p=s[0]-e[0];aimY=s[1]-e[1],e[4]=180*Math.atan2(p,aimY)/Math.PI},move:function(e){var t=4,n=e[0],a=e[1],o=getDecorExtra(this,!0);o.path||(o.path=oMap.aipoints);var i=o.path[e[5]];do{var r=i[e[6]],l=r[0]-n,s=r[1]-a,r=Math.hypot(l,s)}while(r<t?(n+=l,a+=s,t-=r,++e[6]>=i.length&&(e[6]=0)):(n+=l*t/r,a+=s*t/r,t=0),0<t);e[0]=n,e[1]=a,(l||s)&&(o=nearestAngle(180*Math.atan2(l,s)/Math.PI,e[4],360),e[4]<o-8?e[4]+=8:e[4]>o+8?e[4]-=8:e[4]=o);for(var c=0;c<oPlayers.length;c++){var p=nearestAngle(getApparentRotation(oPlayers[c])-e[4],180,360),n=p%180/180;n=this.easeInOut(n),p=180*Math.floor(p/180)+180*n;p=Math.round(11*p/180)%22;21<p&&(p-=22),e[2][c].setState(p)}},easeInOut:function(e){return(e*=2)<1?e*e/2:-(--e*(e-2)-1)/2}},movingthwomp:{spin:20,hitbox:8,movable:!0,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].w=48,e[2][n].h=64;if(null==e[4]){e[4]=[[e[0],e[1],0,20,20],[e[0],e[1],20,5,30],[e[0],e[1],20,30,5],[e[0],e[1],0,20,20]];var a=getDecorParams(this,t);if(!isNaN(a.dir))for(var o=a.length*Math.sin(a.dir),i=a.length*Math.cos(a.dir),t=2;t<4;t++)e[4][t][0]+=o,e[4][t][1]+=i}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=1),null==e[7]&&(e[7]=0)},move:function(e,t){if(e[7]){if(e[7]--,!e[7])if((p=e[4][e[5]])[2]!=e[3]&&(c=1),null!=c)for(var n=0;n<strPlayer.length;n++)e[2][n].setState(c)}else{var a=(p=e[4][e[5]])[0]-e[0],o=p[1]-e[1],i=p[2]-e[3],r=0<i?2:8,l=Math.hypot(a,o),s=!0;if(2<l?(e[0]+=2*a/l,e[1]+=2*o/l,s=!1):(e[0]=p[0],e[1]=p[1]),r<Math.abs(i)?(e[3]+=Math.sign(i)*r,s=!1):e[3]=p[2],s){e[7]=p[0<e[6]?3:4],e[5]+=e[6],e[5]<0?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1);var c,p=e[4][e[5]];c=!i||0<e[3]?0:2;for(n=0;n<strPlayer.length;n++)e[2][n].setState(c)}}}},chomp:{hitbox:9,spin:42,unbreaking:!0,movable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=8,e[2][a].w=92,e[2][a].h=60*e[2][a].w/70,e[2][a].z=.33;if(null==e[3]&&(e[3]=1e4*Math.abs(Math.sin(n+1))%3),null==e[4]){e[4]=[];for(var o=1e4*Math.sin(n+2)%Math.PI,i=2*Math.PI/6*Math.sign(Math.sin(1+80*n)),a=0;a<6;a++){var r=o+a*i;e[4].push([e[0]+40*Math.cos(r),e[1]+40*Math.sin(r)])}}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=n%2?1:-1)},move:function(e,t){e[3]+=e[6],e[3]<0&&(e[3]=0,e[6]=1.5),e[6]-=.5;for(var n=2.5;0<n;){var a=(s=e[4][e[5]])[0],o=s[1],i=a-e[0],r=o-e[1],l=Math.hypot(i,r);l<n?(e[0]=a,e[1]=o,e[5]++,e[5]>=e[4].length&&(e[5]=0),n-=l):(e[0]+=i*n/l,e[1]+=r*n/l,n=0)}var s=e[4][e[5]],c=e[4][(e[5]||e[4].length)-1],p=180*Math.atan2(s[0]-c[0],s[1]-c[1])/Math.PI;if(!isNaN(p))for(var u=0;u<oPlayers.length;u++){var d=nearestAngle(getApparentRotation(oPlayers[u])-p,180,360),d=Math.round(8*d/360)%8;e[2][u].setState(d)}},easeInOut:function(e){return(e*=2)<1?e*e/2:-(--e*(e-2)-1)/2}},pendulum:{hitbox:8,spin:42,unbreaking:!0,movable:!0,init:function(e,t,n){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=1,e[2][a].w=60,e[2][a].h=3*e[2][a].w,e[2][a].z=.1,e[2][a].div.style.transformOrigin=e[2][a].div.style.WebkitTransformOrigin=e[2][a].div.style.MozTransformOrigin="50% 83%";e[5]=[e[0],e[1],0,-1],null==e[4]&&(e[4]=1e4*Math.sin(n+1)%(Math.PI/3),t=getDecorParams(this,t).dir,isNaN(t)?(e[5][2]=1e4*Math.sin(n+1)%Math.PI,e[5][3]=0<Math.sin(1200*(n+1)+1)?1:-1):(e[5][2]=t,e[5][3]=1))},move:function(e){var t=Math.PI/3,n=e[4],a=e[5][2],o=.99*t;Math.abs(n)>o&&(n=o*Math.sign(n),e[5][3]=-e[5][3]),n+=Math.sqrt(2*(Math.cos(n)-Math.cos(t)))/16*e[5][3],e[4]=n;e[0]=e[5][0]+30*Math.sin(n)*Math.sin(a),e[1]=e[5][1]+30*Math.sin(n)*Math.cos(a);for(var i=-6*(1-Math.cos(n)),r=0;r<strPlayer.length;r++){var l=getApparentRotation(oPlayers[r]),l=-n/5*Math.sin(l*Math.PI/180-a);e[2][r].div.style.transform=e[2][r].div.style.WebkitTransform=e[2][r].div.style.MozTransform="translateY("+i+"%) rotate("+Math.round(180*l/Math.PI)+"deg)"}}}},DEFAULT_DECOR_HITBOX=5,DEFAULT_DECOR_HITBOX_H=4,type,lastState;for(type in decorBehaviors)decorBehaviors[type].type=type;function getDecorParams(e,t){e=e.type;return oMap.decorparams&&oMap.decorparams[e]&&oMap.decorparams[e][t]?oMap.decorparams[e][t]:{}}function getDecorExtra(e,t){var n=e.type,e={};return oMap.decorparams&&oMap.decorparams.extra&&oMap.decorparams.extra[n]&&(e=oMap.decorparams.extra[n],t&&e.custom&&(e=getDecorExtra(decorBehaviors[e.custom.type]))),e}function getDecorActualType(e){var t=getDecorExtra(decorBehaviors[e.type]);return(t.custom||e).type}function getApparentRotation(e){var t=e.rotation,e=e.changeView;return e&&(t+=t<360-e?e:e-360),t}function getLastObj(e,t,n){if(e[t]&&e[t].ref===n.ref)return e[t];for(var a=0;a<e.length;a++)if(e[a].ref===n.ref)return e[a];return n}function interpolateState(e,t,n){return e*(1-n)+t*n}function interpolateStateAngle(e,t,n){return interpolateState(e=nearestAngle(e,t,360),t,n)}function interpolateStateRound(e,t,n){return Math.round(interpolateState(e,t,n))}function render(){for(var e,P={karts:[],decor:{},items:{}},t=0;t<aKarts.length;t++){var n=aKarts[t];P.karts.push({ref:n,x:n.x,y:n.y,z:n.z,rotation:n.rotation,changeView:n.changeView||0,size:n.size,tourne:n.tourne,figstate:n.figstate||0,time:n.time,roulette:n.roulette,tombe:n.tombe})}if(oMap.decor)for(var a in oMap.decor){P.decor[a]=[];for(t=0;t<oMap.decor[a].length;t++){var o=oMap.decor[a][t];P.decor[a].push({ref:o,x:o[0],y:o[1],z:o[3]})}}for(e in items){P.items[e]=[];for(t=0;t<items[e].length;t++){var i=items[e][t];P.items[e].push({ref:i,x:i.x,y:i.y,z:i.z,size:i.size})}}lastState=lastState||P;function r(e){var t,n=+e,a=1==n;(t=P).players=[],a&&(lastState=P);for(var o=0;o<oPlayers.length;o++)t.players.push(t.karts[o]);for(o=0;o<t.players.length;o++){var i=t.players[o],r=i.x,l=i.y,s=getApparentRotation(i);i.tombe&&(10<i.tombe&&(s=(20!=i.tombe||a?(r=i.ref.aX,l=i.ref.aY,i.rotation=i.ref.aRotation):(r=interpolateState(lastState.karts[o].x,i.ref.aX,n),l=interpolateState(lastState.karts[o].y,i.ref.aY,n),i.x=r,i.y=l,i.z=0,i.rotation=i.ref.aRotation,i.ref.sprite[o].img.style.opacity=1-n),getApparentRotation(i))),oContainers[o].style.opacity=Math.abs(i.tombe-10)/10);var c,p={x:r,y:l,rotation:s};redrawCanvas(o,p),i.time&&(document.getElementById("lakitu"+o).style.left=Math.round(iScreenScale*(20-i.time/5))+"px",document.getElementById("lakitu"+o).style.top=Math.round((18-Math.abs(i.time-20))*(iScreenScale-2))+"px"),i.roulette&&i.roulette<25&&(r=+(c=document.getElementById("scroller"+o).getElementsByTagName("div")[0]).dataset.h,l=+c.dataset.s,0<(i=parseInt(c.style.top)+Math.round(2*iScreenScale))&&(i+=l-r),c.style.top=i+"px");for(var u=0;u<t.karts.length;u++){for(var d=s-(M=t.karts[u]).rotation;d<0;)d+=360;for(;360<d;)d-=360;var m=Math.round(11*d/180)+M.tourne%21;if(21<m&&(m-=22),M.changeView||(M.figstate?m=(m+21-M.figstate)%21:M.ref.driftinc?m=0<M.ref.driftinc?18:4:M==t.players[o]&&(M.ref.rotincdir&&!M.tourne?m=0<M.ref.rotincdir?23:22:M.tourne||(m=0))),M.ref.sprite[o].setState(m),M.ref.sprite[o].render(p,M),"BB"==course){var h=M.ref.ballons.length,y=M.size/2,g=correctZInv(correctZ(M.z)+2*y*(6+(M.ref.sprite[o].h-32)/5));for(k=0;k<h;k++)M.ref.ballons[k][o].render(p,{x:M.x-2.5*(k+.75-h/2)*M.size*direction(1,s),y:M.y+2.5*(k+.75-h/2)*M.size*direction(0,s),z:g,size:y})}M!=t.players[o]&&(!M.ref.marker||M.ref.loose||M.ref.tombe||M.ref.marker.render(o,p,M))}for(var f,S,u=0;u<oMap.arme.length;u++)M=oMap.arme[u],isNaN(M[2])?M[2][o].render(p,{x:M[0],y:M[1]}):!o&&a&&(M[2]?M[2]--:M[2]=new Sprite("item"));if(oMap.coins)for(u=0;u<oMap.coins.length;u++){M=oMap.coins[u];var v=p.rotation*Math.PI/180,v=Math.abs(Math.cos(M.theta-v));M.sprite[o].w=24*v,M.sprite[o].z=.5*(v-1),M.sprite[o].render(p,{x:M.x,y:M.y})}for(f in t.decor)for(u=0;u<t.decor[f].length;u++)(M=t.decor[f][u]).ref[2][0].unshown||M.ref[2][o].render(p,{x:M.x,y:M.y,z:M.z,size:1.2});for(S in t.items)for(u=0;u<t.items[S].length;u++){var b,M=t.items[S][u];!a||(b=itemBehaviors[S]).render&&b.render(M.ref,o),M.ref.sprite&&M.ref.sprite[o].render(p,M)}if(a)for(u=0;u<aKarts.length;u++){var x=aKarts[u],C=x.sprite[o];0<x.figstate&&x.figuring?C.div.hallowed||(C.div.hallowed=!0,C.div.style.backgroundImage="url('images/halo.png')",C.div.style.backgroundRepeat="no-repeat",C.div.style.backgroundSize="contain",C.img.style.opacity=.7):C.div.hallowed&&(C.div.hallowed=!1,C.div.style.backgroundImage="",C.div.style.backgroundRepeat="",C.div.style.backgroundSize="",C.img.style.opacity=1)}for(u=0;u<oBgLayers.length;u++)oBgLayers[u].draw(s,o);1!=strPlayer.length||gameSettings.nomap||setPlanPos()}}r(1);for(t=1;t<1;t++)!function(e){setTimeout(function(){r(e+1)},SPF*e)}(t)}function makeSpriteExplode(e,t,n){switch(e[2]){case 0:t="explosionB";break;case 1:t="explosionR"}e.sprite[n].img.src="images/sprites/sprite_"+t+".png";var a=e.sprite[n].div.getElementsByClassName("sprite-hallow");a.length&&e.sprite[n].div.removeChild(a[0])}function correctZ(e){return 7*Math.pow(e/7,.7)}function correctZInv(e){return 7*Math.pow(e/7,1/.7)}function correctCamZ(e,t){return correctZ(e)*iCamDist/t}function direction(e,t){return Math[["sin","cos"][e]](t*Math.PI/180)}function getItemDistributionRange(e){var t=(e.place-1)/aKarts.length,n=e.place/aKarts.length;if("BB"!=course){s=1==e.place?(a=-distanceToSecond(e),l=0,.18*Math.exp(a/150)):(o=distanceToFirst(e),l=Math.pow(o/metaItemRange,.75),.07);var a=Math.min(1,l),o=Math.min(1,l+s),t=getItemAvgRange(a,t),n=getItemAvgRange(o,n)}else{for(var i=0,r=0;r<aKarts.length;r++)i=Math.max(i,aKarts[r].ballons.length+aKarts[r].reserve);var l,s,o=(l=(i-(e.ballons.length+e.reserve))/2.5)+(s=.07);t=getItemAvgRange(a=l,t),n=getItemAvgRange(o,n)}return[t*itemDistribution.length,n*itemDistribution.length]}function getItemAvgRange(e,t){return Math.min(.99999,Math.pow(e,1-metaItemPosition)*Math.pow(t,metaItemPosition))}function randObj(e){var t=getItemDistributionRange(e),e=t[0],t=t[1],e=Math.floor(e+(t-e)*Math.random()),n=itemDistribution[e],a=0;for(o in n)a+=n[o];var o,i=Math.floor(Math.random()*a),a=0;for(o in n)if(i<(a+=n[o]))return o}function possibleObjs(e,t){var n=getItemDistributionRange(e),e=Math.floor(n[0]+.005),a=Math.ceil(n[1]-.005),o={};e>=itemDistribution.length&&(e=itemDistribution.length-1,a=itemDistribution.length);for(var i,r=e;r<a;r++)for(i in itemDistribution[r])t[i]||(o[i]=!0);return o}function otherObjects(e,t){t=possibleObjs(e,t);return 0<Object.getOwnPropertyNames(t).length}function friendlyFire(e,t){return e==t||iTeamPlay&&e.team==t.team}function sameTeam(e,t){return-1!=e&&e==t}function addNewBalloon(e,t){e.ballons.push(createBalloonSprite(e,t))}function createBalloonSprite(e,t){return void 0===t&&(t=e.team),new Sprite(1==t?"ballonR":"ballon")}function balloonSrc(e){return"images/sprites/sprite_"+(1==e?"ballonR":"ballon")+".png"}function updateBalloonHud(e,t){var n=balloonSrc(t.team);e.innerHTML="";for(var a=0;a<t.reserve;a++)e.innerHTML+='<img src="'+n+'" style="width:'+3*iScreenScale+"px;margin:0 "+Math.round(.5*iScreenScale)+"px 0 "+Math.round(.2*iScreenScale)+'px" />'}var syncItems=[],touchedObject;function detruit(e,t){isOnline&&((e=getItemToDestroy(e)).deleted=1,syncItems.push(e)),supprime(e,t)}function supprime(e,t){var n=e.type,a=items[n].indexOf(e);if(-1!=a){var o=itemBehaviors[n];if(e.sprite){for(var i=0;i<oPlayers.length;i++){var r=oPlayers[i];r.tombe||(r={x:r.x,y:r.y,rotation:getApparentRotation(r)},e.sprite[i].render(r,e))}e.sprite[0].fadeout(o.fadedelay)}o.del&&o.del(e);for(i=0;i<aKarts.length;i++){var l=aKarts[i].using.indexOf(e);if(-1!=l){aKarts[i].using.splice(l,1),t&&playIfShould(aKarts[i],"musics/events/hit.mp3")&&(t=!1);break}}"object"==typeof t&&playDistSound(t,"musics/events/hit.mp3",80),!clLocalVars.myItems||-1!=(o=clLocalVars.myItems.indexOf(e))&&clLocalVars.myItems.splice(o,1),items[n].splice(a,1)}}function getItemToDestroy(e){for(var t=0;t<aKarts.length;t++)if(-1!=aKarts[t].using.indexOf(e)){var n=aKarts[t].using[0];return n.type===e.type?n:e}return e}function supprArme(e){var t=aKarts[e];t.arme=!1,t.roulette=0,kartIsPlayer(t)&&(document.getElementById("roulette"+e).innerHTML="",document.getElementById("scroller"+e).style.visibility="hidden",removeIfExists(t.rouletteSound))}function loseUsingItems(e){if(e.using.length){for(var t=0;t<e.using.length;t++){var n=e.using[t];n.z&&(n.z=0);var a=itemBehaviors[n.type];a.drop&&a.drop(n,e),isOnline&&syncItems.push(n)}e.using.length=0}}function loseUsingItem(e){void 0===e.rotitem&&loseUsingItems(e)}function dropCurrentItem(e){var t=e.arme;if(t){var n=e.roulette;if(supprArme(aKarts.indexOf(e)),!(n<25||isOnline&&e.id!=identifiant&&e.controller!=identifiant)){var a,o=1,n=t.match(/^(.+)X(\d+)$/);switch(n&&(t=n[1],o=+n[2]),t){case"champi":case"banane":case"carapace":case"poison":a=t;break;case"carapacerouge":a="carapace-rouge"}if(a)for(var i=0;i<o;i++){var r=e.rotation*Math.PI/180+.9*(Math.random()-.5)*Math.PI,l=9+6*Math.random(),s={type:a,team:e.team,x:e.x-l*Math.sin(r),y:e.y-l*Math.cos(r),z:0};switch(t){case"carapace":s.vx=0,s.vy=0,s.owner=-1,s.lives=10;break;case"carapacerouge":s.theta=-1,s.owner=-1,s.aipoint=-2,s.aimap=-1,s.target=-1}addNewItem(e,s),s.sprite[0].fadein(200)}}}}function deleteUsingItems(e){for(var t=e.using.length-1;0<=t;t--)detruit(e.using[t])}function stopDrifting(e){var t=aKarts[e];kartIsPlayer(t)&&(aKarts[e].driftinc=0,aKarts[e].driftcpt=0,aKarts[e].turbodrift=0,getDriftImg(e).src="images/drift.png",document.getElementById("drift"+e).style.display="none",t.driftSound&&(t.driftSound.pause(),t.driftSound=void 0),t.sparkSound&&(t.sparkSound.pause(),t.sparkSound=void 0))}function showRearView(e){var t=oPlayers[e],n=180-t.changeView;t.changeView=n,t.sprite[0].setState(11),!bCounting||(e=document.getElementById("oCounts"+e))&&(e.style.visibility=t.changeView?"hidden":"visible")}function resetSpriteHeight(e){e.lastW=e.w,e.lastH=e.h,e.w=32,e.h=32}function resumeSpriteSize(e){e.lastW&&(e.w=e.lastW,delete e.lastW),e.lastH&&(e.h=e.lastH,delete e.lastH)}function updateProtectFlag(e){e.protect=e.etoile||e.megachampi||e.billball||e.cannon}function colKart(e){for(var t=aKarts[e],n=0;n<e;n++){var a,o,i,r,l,s,c,p,u,d=aKarts[n],m=t.protect?t.etoile||t.billball?2:1:0,h=d.protect?d.etoile||d.billball?2:1:0,y="BB"==course&&!t.champi!=!d.champi;t.cpu&&d.cpu&&m==h&&!y||!friendlyFire(t,d)&&("BB"!=course||t.ballons.length&&d.ballons.length)&&Math.pow(t.x-d.x,2)+Math.pow(t.y-d.y,2)<1e3&&(t.z<=1.175||t.billball)&&(d.z<=1.175||d.billball)&&!t.tourne&&!d.tourne&&(a=kartInstantSpeed(t),i=[(o=kartInstantSpeed(d))[0]-a[0],o[1]-a[1]],u=[t.x-d.x,t.y-d.y],p=5*(d.size+t.size)*(d.size+t.size),(r=projete(0,0,u[0],u[1],u[0]-i[0],u[1]-i[1]))<0&&(r=0),1<r&&(r=1),(r=(r=[u[0]-r*i[0],u[1]-r*i[1]])[0]*r[0]+r[1]*r[1])<=p&&(m||h?m!=h&&r<p/2&&((l=m<h?t:d).loose||l.cannon||l.frminv||(s=m<h?d:t,c=aKarts.indexOf(l),handleHit2(s,l),loseBall(c),stopDrifting(c),l.spin(62),loseUsingItems(l),dropCurrentItem(l))):(y&&((l=t.champi?d:t).loose||l.cannon||l.frminv||(s=t.champi?t:d,c=aKarts.indexOf(l),handleHit2(s,l),loseBall(c),stopDrifting(c),s.ballons.length<3&&addNewBalloon(s,l.team),l.spin(62))),p<u[0]*u[0]+u[1]*u[1]&&(t.cpu&&d.cpu||(y=(h=[u[1],-u[0]])[0]*u[1]-u[0]*h[1])&&(p=(h[0]*i[1]-h[1]*i[0])/y,y=(u[1]*i[0]-u[0]*i[1])/y,u[0]*=p,u[1]*=p,h[0]*=y,h[1]*=y,y=d.stats.mass*d.size/(t.stats.mass*t.size),u=[u[0]*y,u[1]*y],(!t.pushVector||t.pushVector[0]*t.pushVector[0]+t.pushVector[1]*t.pushVector[1]<u[0]*u[0]+u[1]*u[1])&&(t.pushVector=u),u=[(h[0]+a[0]-o[0])/y,(h[1]+a[1]-o[1])/y],(!d.pushVector||d.pushVector[0]*d.pushVector[0]+d.pushVector[1]*d.pushVector[1]<u[0]*u[0]+u[1]*u[1])&&(d.pushVector=u),d.cpu||d.colSound||(d.colSound=playIfShould(d,"musics/events/colkart.mp3"),d.colSound&&function(e){e.colSound.onended=function(){e.colSound=void 0,document.body.removeChild(this)}}(d)))))))}}function pointInRectangle(e,t,n){return e>n[0]&&e<=n[0]+n[2]&&t>n[1]&&t<=n[1]+n[3]}function pointInPolygon(e,t,n){for(var a=!1,o=0,i=n.length-1;o<n.length;i=o++){var r=n[o][0],l=n[o][1],s=n[i][0],c=n[i][1];t<l!=t<c&&e<(s-r)*(t-l)/(c-l)+r&&(a=!a)}return a}function canMoveTo(e,t,n,a,o,i){var r=e+a,l=t+o;if(oMap.decor)for(var s in oMap.decor)for(var c=decorBehaviors[s],p=c.hitbox||DEFAULT_DECOR_HITBOX,u=c.hitboxH||DEFAULT_DECOR_HITBOX_H,d=0;d<oMap.decor[s].length;d++){var m=oMap.decor[s][d];if(r>m[0]-p&&r<m[0]+p&&l>m[1]-p&&l<m[1]+p&&Math.abs((m[3]||0)-n)<u&&!(null==m[3]&&e>m[0]-p&&e<m[0]+p&&t>m[1]-p&&t<m[1]+p)){if(!i||c.unbreaking){if(collisionDecor=s,collisionTest==COL_KART&&(c.breaking&&4<collisionPlayer.speed&&(oMap.decor[s][d][2][0].suppr(),oMap.decor[s].splice(d,1),collisionPlayer.turbodrift&&(collisionPlayer.turbodrift=0),c.bonus&&(isOnline&&collisionPlayer!=oPlayers[0]||addNewItem(collisionPlayer,{type:Math.random()<.5?"banane":"champi",team:collisionPlayer.team,x:r+2.5*a,y:l+2.5*o,z:0}))),c.transparent))break;return}oMap.decor[s][d][2][0].suppr(),oMap.decor[s].splice(d,1);break}}if(1.175<n)return 1;if(!oMap.collision)return 1;if(!isCup)if("BB"==course||oMap.map<=20){if(e>oMap.w-5||t>oMap.h-5||e<4||t<4)return 1}else if(e>=oMap.w||t>=oMap.h||e<0||t<0)return 1;for(var h=oMap.collision.rectangle,d=0;d<h.length;d++)if(pointInRectangle(e,t,h[d]))return 1;for(var y=oMap.collision.polygon,d=0;d<y.length;d++)if(pointInPolygon(e,t,y[d]))return 1;if(!isCup)if("BB"==course||oMap.map<=20){if(r>oMap.w-5||l>oMap.h-5||r<4||l<4)return}else if(r>=oMap.w||l>=oMap.h||r<0||l<0)return;for(var g=[e,t],f=[a,o],S=[0<a,0<o],d=0;d<h.length;d++)for(var m=h[d],v=0;v<2;v++){var b=S[v];if(b?g[v]<=m[v]&&g[v]+f[v]>=m[v]:g[v]>=m[v]+m[v+2]&&g[v]+f[v]<=m[v]+m[v+2]){var M=1-v,b=g[M]+((b?m[v]:m[v]+m[v+2])-g[v])*f[M]/f[v];if(b>=m[M]&&b<=m[M]+m[2+M])return}}for(d=0;d<y.length;d++)for(var x=y[d],v=0;v<x.length;v++){var C=x[v],P=x[(v+1)%x.length];if(secants(e,t,r,l,C[0],C[1],P[0],P[1]))return}return 1}function getLineHorizontality(e,t,n,a,o){for(var i=null,r=1,l=0;l<o.length;l++){var s=o[l],c=secants(e,t,n,a,s.x1,s.y1,s.x2,s.y2);c&&c[0]<r&&(r=c[0],i={dir:[s.x2-s.x1,s.y2-s.y1],t:r})}return i}function secants(e,t,n,a,o,i,r,l){var s=-n*l+n*i+e*l-e*i+r*a-r*t-o*a+o*t,l=(-r*t+o*t-e*i+e*l+r*i-o*l)/s;if(0<=l&&l<=1){s=(e*a-n*t+n*i-e*i-o*a+o*t)/s;if(0<=s&&s<=1)return[l,s]}return null}function intersectionLineLine(e,t,n,a,o,i,r,l){return 1}function projete(e,t,n,a,o,i){var r=(o-n)*(o-n)+(i-a)*(i-a);return r?(-n*o+n*n+e*o-e*n-a*i+a*a+t*i-t*a)/r:1}function intersectionLineCircle(e,t,n,a,o,i,r){var l=n*n,s=i*i,n=r*r,l=-s*(o*o)+2*s*t*o+2*i*r*a*o-2*i*r*e*o-s*(t*t)-2*i*r*a*t+2*i*r*e*t-n*(a*a)+2*n*e*a-n*(e*e)+l*n+l*s;if(0<=l){n=s+n,e=r*o-r*t+i*a-i*e;return(Math.sqrt(l)-e)/n}return NaN}function followCircleWithAngle(e,t,n,a,o,i){var r=Math.hypot(o,i),l=Math.hypot(n-e,a-t),e=Math.atan2(i,o)-Math.atan2(a-t,n-e),e=Math.sin(e);if(r&&e){e=l/(2*e);return[n-i*e/r,a+o*e/r,e]}return[n,a,l]}function nextAiStop(e,t,n,a,o,i,r,l,s){var c=Math.hypot(n,a),p=Math.hypot(r,l),u=r*a-n*l;if(c&&p&&u)for(var d=-1;d<2;d+=2)for(var m=-1;m<2;m+=2){var h=(n*(-s*m*p+r*(i-t)-l*o)+r*s*d*c+a*r*e)/u,y=(a*(-s*m*p+r*i+l*(e-o))+l*s*d*c-n*l*t)/u,g=l*s*-m/p,f=m*(r*s)/p,S=projete(h+a*s*-d/c,y+d*(n*s)/c,e,t,e+n,t+a),f=projete(h+g,y+f,o,i,o+r,i+l);if(S<=1&&0<=f)return S}return 0<n*r+a*l?1:0}function aiMarginLimitSpeed(e,t,n,a,o,i,r,l,s,c){for(var p=Math.hypot(r,l),u=1/0,d=-1;d<2;d+=2){var m=aiMarginLimitRadius(e,t,n,a,o+d*l*s/p,i-d*r*s/p,r,l);m<u&&(u=m)}return 2*u*c}function aiMarginLimitRadius(e,t,n,a,o,i,r,l){var s=o-e,c=i-t,p=n*n*l*l-2*n*a*r*l+a*a*r*r,u=n*n*(l*l*l*l+r*r*l*l)+n*a*r*l*(-2*l*l-2*r*r)+a*a*r*r*(l*l+r*r);if(p&&u)for(var d=-1;d<2;d+=2){var m=Math.hypot(n,a),h=Math.hypot(r,l),y=(a*(-d*s*m*l*h+d*c*m*r*h+n*(s*r*l-c*r*r))+a*a*(s*l*l-c*r*l))/p,g=-(n*(d*c*m*r*h-d*s*m*l*h)+n*a*(s*l*l-c*r*l)+n*n*(s*r*l-c*r*r))/p,f=(a*l*l*(d*c*m*r*h-d*s*m*l*h)+n*r*l*(d*c*m*r*h-d*s*m*l*h)+a*a*l*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r)+n*n*l*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r))/u,h=-(a*r*l*(d*c*m*r*h-d*s*m*l*h)+n*r*r*(d*c*m*r*h-d*s*m*l*h)+a*a*r*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r)+n*n*(s*r*l*l*l-c*r*r*l*l+s*r*r*r*l-c*r*r*r*r))/u,f=rotateVector(n,a,Math.atan2(h,f)-Math.atan2(g,y));if(0<=f[0]*r-f[1]*l)return Math.hypot(y,g)}return 1/0}function rotateVector(e,t,n){var a=Math.cos(n),n=Math.sin(n);return[e*a-t*n,e*n+t*a]}function getHorizontality(e,t,n,a){var o={t:1},i=e+n,r=t+a;if(isCup||("BB"==course||oMap.map<=20?((i>oMap.w-5||i<4)&&(o.dir=[0,oMap.h]),(r>oMap.h-5||r<4)&&(o.dir=[oMap.w,0])):((i>=oMap.w||i<0)&&(o.dir=[0,oMap.h]),(r>=oMap.h||r<0)&&(o.dir=[oMap.w,0]))),oMap.decor)for(var l in oMap.decor)for(var s=0;s<oMap.decor[l].length;s++){var c=oMap.decor[l][s],p=decorBehaviors[l].hitbox||DEFAULT_DECOR_HITBOX;(m=getLineHorizontality(e,t,i,r,h=[{x1:c[0]-p,y1:c[1]-p,x2:c[0]+p,y2:c[1]-p},{x1:c[0]-p,y1:c[1]-p,x2:c[0]-p,y2:c[1]+p},{x1:c[0]-p,y1:c[1]+p,x2:c[0]+p,y2:c[1]+p},{x1:c[0]+p,y1:c[1]-p,x2:c[0]+p,y2:c[1]+p}]))&&m.t<o.t&&(o=m)}if(oMap.collision){for(var u=oMap.collision.rectangle,s=0;s<u.length;s++)(m=getLineHorizontality(e,t,i,r,h=[{x1:(c=u[s])[0],y1:c[1],x2:c[0]+c[2],y2:c[1]},{x1:c[0],y1:c[1],x2:c[0],y2:c[1]+c[3]},{x1:c[0]+c[2],y1:c[1],x2:c[0]+c[2],y2:c[1]+c[3]},{x1:c[0],y1:c[1]+c[3],x2:c[0]+c[2],y2:c[1]+c[3]}]))&&m.t<o.t&&(o=m);for(var d=oMap.collision.polygon,s=0;s<d.length;s++){for(var m,h=[],y=d[s],g=0;g<y.length;g++){var f=y[g],S=y[(g+1)%y.length];h.push({x1:f[0],y1:f[1],x2:S[0],y2:S[1]})}(m=getLineHorizontality(e,t,i,r,h))&&m.t<o.t&&(o=m)}}return o.dir?(a=Math.hypot(o.dir[0],o.dir[1]),o.dir[0]/=a,o.dir[1]/=a):o.dir=[.7,.7],o.dir}function normalizeAngle(e,t){return e-t*Math.round(e/t)}function nearestAngle(e,t,n){return e+n*Math.round((t-e)/n)}function getNearestHoleDist(e,t,n){var a=n||1/0;if(!oMap.trous)return a;for(var o=0;o<4;o++){for(var i=oMap.trous[o].rectangle,r=0;r<i.length;r++){a=getHoleSegmentDist(a,e,t,(s=i[r][0])[0],s[1],s[2],0);if(a=getHoleSegmentDist(a,e,t,s[0],s[1],0,s[3]),a=getHoleSegmentDist(a,e,t,s[0],s[1]+s[3],s[2],0),(a=getHoleSegmentDist(a,e,t,s[0]+s[2],s[1],0,s[3]))<n)return a}for(var l=oMap.trous[o].polygon,r=0;r<l.length;r++){for(var s=l[r][0],c=0;c<s.length;c++){var p=(c+1)%s.length;a=getHoleSegmentDist(a,e,t,s[c][0],s[c][1],s[p][0],s[p][1])}if(a<n)return a}}return a}function getHoleSegmentDist(e,t,n,a,o,i,r){var l=projete(t,n,a,o,a+i,o+r);l<0&&(l=0),1<l&&(l=1);i=a+l*i-t,l=o+l*r-n,r=i*i+l*l;return!(e<r)&&canMoveTo(t,n,i,l)?r:e}function objet(e,t){for(var n=0;n<oMap.arme.length;n++){var a=oMap.arme[n];if(e>a[0]-7&&e<a[0]+7&&t>a[1]-7&&t<a[1]+7&&isNaN(a[2])){for(var o=0;o<strPlayer.length;o++)a[2][o].div.style.display="none";return a[2]=20,touchedObject=n,1}}}function touche_piece(e,t){if(oMap.coins)for(var n=0;n<oMap.coins.length;n++){var a=oMap.coins[n];if(e>a.x-5&&e<a.x+5&&t>a.y-5&&t<a.y+5)return a.sprite[0].suppr(),oMap.coins.splice(n,1),1}}function sauts(e,t,n,a){if(!oMap.sauts)return!1;for(var o=[e,t],i=[n,a],r=[0<n,0<a],l=0;l<oMap.sauts.length;l++){var s=oMap.sauts[l];if(pointInRectangle(e,t,s))return s[4];for(var c=0;c<2;c++){var p=r[c];if(p?o[c]<=s[c]&&o[c]+i[c]>=s[c]:o[c]>=s[c]+s[c+2]&&o[c]+i[c]<=s[c]+s[c+2]){var u=1-c,p=o[u]+((p?s[c]:s[c]+s[c+2])-o[c])*i[u]/i[c];if(p>=s[u]&&p<=s[u]+s[2+u])return s[4]}}}return!1}function ralenti(e,t){for(var n in oMap.horspistes){for(var a=oMap.horspistes[n],o=a.rectangle,i=0;i<o.length;i++)if(pointInRectangle(e,t,o[i]))return n;for(var r=a.polygon,i=0;i<r.length;i++)if(pointInPolygon(e,t,r[i]))return n}return!1}function getOffroadProps(e,t){switch(t){case"herbe":return{speed:1.9+e.speedinc/2};case"glace":return{speed:2.8+e.speedinc/2,sliding:8};case"eau":return{speed:2.7,sliding:5};case"choco":return{speed:2.1,sliding:4}}}function accelere(e,t,n,a){if(oMap.accelerateurs)for(var o=e+n,i=t+a,r=[e,t],l=[n,a],s=[0<n,0<a],c=0;c<oMap.accelerateurs.length;c++){var p=oMap.accelerateurs[c];if(pointInRectangle(o,i,p))return 1;for(var u=0;u<2;u++){var d=s[u];if(d?r[u]<=p[u]&&r[u]+l[u]>=p[u]:r[u]>=p[u]+p[u+2]&&r[u]+l[u]<=p[u]+p[u+2]){var m=1-u,d=r[m]+((d?p[u]:p[u]+p[u+2])-r[u])*l[m]/l[u];if(d>=p[m]&&d<=p[m]+p[2+m])return 1}}}}function flowShift(e,t,n){if(oMap.flows){for(var a=oMap.flows.rectangle,o=0;o<a.length;o++)if(pointInRectangle(e,t,(i=a[o])[0])&&(!n||i[2]))return[i[1][0],i[1][1],0];for(var i,r=oMap.flows.polygon,o=0;o<r.length;o++)if(pointInPolygon(e,t,(i=r[o])[0])&&(!n||i[2]))return[i[1][0],i[1][1],0]}if(oMap.spinners)for(var l=oMap.spinners,o=0;o<l.length;o++){var s=l[o],c=e-s[0],p=t-s[1];if(c*c+p*p<s[2]*s[2])return[p*s[3],-c*s[3],s[3]]}return[0,0,0]}function tombe(e,t,n){var a;if(e>oMap.w?(e=oMap.w-.5,c=!0):e<=0&&(e=.5,c=!0),t>oMap.h?(t=oMap.h-.5,c=!0):t<=0&&(t=.5,c=!0),oMap.trous)for(var o=0;o<4;o++){for(var i=oMap.trous[o].rectangle,r=0;r<i.length;r++)if(pointInRectangle(e,t,(l=i[r])[0])){if(null==n)return!0;if(a=[l[1][0],l[1][1],o],o%2-n)return a}for(var l,s=oMap.trous[o].polygon,r=0;r<s.length;r++)if(pointInPolygon(e,t,(l=s[r])[0])){if(null==n)return!0;if(a=[l[1][0],l[1][1],o],o%2-n)return a}}if(a)return a;if(c){var c=null!=oMap.startposition[2]?oMap.startposition[2]:null!=oMap.startrotation?oMap.startrotation/90:2;return"BB"==course||[oMap.startposition[0],oMap.startposition[1],c]}return!1}function inCannon(e,t){if(!oMap.cannons)return!1;for(var n=oMap.cannons.rectangle,a=0;a<n.length;a++)if(pointInRectangle(e,t,(o=n[a])[0]))return o[1];for(var o,i=oMap.cannons.polygon,a=0;a<i.length;a++)if(pointInPolygon(e,t,(o=i[a])[0]))return o[1];return!1}function getActualGameTimeMS(){return null!=timerMS?timerMS:(timer-1)*SPF}function getActualGameTime(){return getActualGameTimeMS()/1e3}var lambdaReturnsTrue=function(e){return!0};function addChallengeHud(e,t){var n;clHud[e]||((n=document.createElement("div")).innerHTML="<span>"+t.title+":</span> <span>"+t.value+"</span>"+(null!=t.out_of?"/<span>"+t.out_of+"</span>":""),t=n.getElementsByTagName("span"),oChallengeCpts.appendChild(n),clHud[e]={$cpt:n,$label:t[0],$value:t[1],$outOf:t[2]})}function updateChallengeHud(e,t){clHud[e]&&(clHud[e].$value.innerText=t)}var challengeRules={finish_circuit:{verify:"end_game",reset_on_fail:!0,success:lambdaReturnsTrue},finish_circuit_first:{verify:"end_game",reset_on_fail:!0,success:function(e){return 1==oPlayers[0].place}},finish_circuit_time:{verify:"end_game",reset_on_fail:!0,success:function(e){return getActualGameTime()<=e.value}},finish_arena:{verify:"end_game",reset_on_fail:!0,success:lambdaReturnsTrue},finish_arena_first:{verify:"end_game",reset_on_fail:!0,success:function(e){return 1==oPlayers[0].place}},hit:{verify:"each_hit",initLocalVars:function(e){clLocalVars.myItems=[],clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("hits",{title:toLanguage("Hits","Touchs"),value:clLocalVars.nbHits,out_of:e.value})},success:function(e){if(clLocalVars.nbHits>=e.value)return!0}},eliminate:{verify:"each_kill",initLocalVars:function(e){clLocalVars.myItems=[],clLocalVars.killed=[],clLocalVars.nbKills=0,clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("kills",{title:toLanguage("Defeated","Elimins"),value:clLocalVars.nbKills,out_of:e.value})},success:function(e){if(clLocalVars.nbKills>=e.value)return!0}},survive:{verify:"each_frame",success:function(e){if(getActualGameTime()>=e.value)return!0}},reach_zone:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value))},success:function(e){for(var e=e.zones,t=oPlayers[0].x,n=oPlayers[0].y,a=e.rectangle,o=0;o<a.length;o++)if(pointInRectangle(t,n,a[o]))return!0;for(var i=e.polygon,o=0;o<i.length;o++)if(pointInPolygon(t,n,i[o]))return!0}},reach_zones:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value)),clLocalVars.reached=[],clLocalVars.reached.length=e.value.length;for(var t=0;t<clLocalVars.reached.length;t++)clLocalVars.reached[t]=!1;clLocalVars.nbPass=0},initSelected:function(e){addChallengeHud("zones",{title:toLanguage("Zones","Zones"),value:clLocalVars.nbPass,out_of:e.value.length})},success:function(e){for(var t=e.zones,n=e.value,a=oPlayers[0].x,o=oPlayers[0].y,i=t.rectangle,r=[],l=0;l<i.length;l++)pointInRectangle(a,o,i[l])&&r.push(n.indexOf(i[l]));for(var s=t.polygon,l=0;l<s.length;l++)pointInPolygon(a,o,s[l])&&r.push(n.indexOf(s[l]));r.sort();for(l=0;l<r.length;l++){var c=r[l];if(!clLocalVars.reached[c]){if(e.ordered&&c&&!clLocalVars.reached[c-1])break;if(clLocalVars.reached[c]=!0,clLocalVars.nbPass++,iSfx&&playSoundEffect("musics/events/clpass.mp3"),updateChallengeHud("zones",clLocalVars.nbPass),clLocalVars.nbPass>=n.length)return!0}}}},hit_items:{verify:"each_item",initLocalVars:function(e){clLocalVars.nbItems=0,clLocalVars.itemsHit=[],clLocalVars.itemsHit.length=oMap.arme.length},initSelected:function(e){addChallengeHud("items",{title:toLanguage("Items","Objets"),value:clLocalVars.nbItems,out_of:oMap.arme.length})},success:function(e){if(clLocalVars.nbItems>=oMap.arme.length)return!0}},collect_coins:{verify:"each_coin",initLocalVars:function(e){clLocalVars.nbCoins=0,e.nb||(e.nb=e.value.length)},initSelected:function(e){if(!oMap.coins){oMap.coins=[];for(var t=0;t<e.value.length;t++){for(var n=e.value[t],a={x:n[0],y:n[1],theta:2*Math.PI*Math.random(),sprite:new Sprite("coin")},o=0;o<oPlayers.length;o++)a.sprite[o].img.style.width="100%",a.sprite[o].w=24,a.sprite[o].h=24;oMap.coins.push(a)}}addChallengeHud("coins",{title:toLanguage("Coins","Pices"),value:clLocalVars.nbCoins,out_of:e.nb})},success:function(e){if(clLocalVars.nbCoins>=e.nb)return!0}},gold_cup:{verify:"end_gp",initRuleVars:function(){return{nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},next_circuit:function(e){e.nbcircuits++}},gold_cups:{verify:"end_gp",initRuleVars:function(e){return{challenge:e,nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits){if(1!=oPlayers[0].place)return!1;var n=(n=sessionStorage.getItem("cl"+t.challenge.id+".gold_cups"))||"{}";if(n=JSON.parse(n),!t.challenge.data.constraints.length)for(var a=0;a<ptsGP.length;a++)3==ptsGP.charAt(a)&&(n[cupIDs[a]]=!0);for(var o=n[cupIDs[oMap.ref/4-1]]=!0,a=0;a<cupIDs.length;a++)if(!n[cupIDs[a]]){o=!1;break}return o?(sessionStorage.removeItem("cl"+t.challenge.id+".gold_cups"),!0):void 0}},next_circuit:function(e){e.nbcircuits++},finish_gp:function(e){if(4==e.nbcircuits){var t=(t=sessionStorage.getItem("cl"+e.challenge.id+".gold_cups"))||"{}";(t=JSON.parse(t))[cupIDs[oMap.ref/4-1]]=!0,sessionStorage.setItem("cl"+e.challenge.id+".gold_cups",JSON.stringify(t));var n=!e.challenge.data.constraints.length;if(n)for(var a=0;a<ptsGP.length;a++)3==ptsGP.charAt(a)&&(t[cupIDs[a]]=!0);showChallengePartialSuccess(e.challenge,{nb:Object.keys(t).length,total:cupIDs.length,warning:!n})}}},finish_circuits_first:{verify:"end_game",initRuleVars:function(){return{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){return 1==oPlayers[0].place&&(t.nbcircuits>=e.value||void 0)},next_circuit:function(e){e.nbcircuits++}},pts_greater:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1,initialscore:0}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]>=e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},pts_equals:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]==e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},game_mode:{success:function(e){return course==["VS","CM"][e.value]}},game_mode_cup:{success:function(e){return course==["GP","VS"][e.value]}},difficulty:{success:function(e){return iDificulty==4+.5*(2-e.value)}},no_teams:{success:function(e){return!iTeamPlay}},participants:{success:function(e){return aKarts.length==e.value}},balloons:{success:function(e){return(!oPlayers[0].lost||clLocalVars.gagnant==oPlayers[0])&&oPlayers[0].ballons.length+oPlayers[0].reserve>=e.value}},balloons_lost:{initSelected:function(e,t){addChallengeHud("balloons",{title:toLanguage("Balloons","Ballons"),value:clLocalVars.lostBalloons,out_of:e.value})},success:function(e){return(!oPlayers[0].loose||clLocalVars.gagnant==oPlayers[0])&&clLocalVars.lostBalloons<=e.value}},no_drift:{success:function(e){return!clLocalVars.drifted}},avoid_items:{success:function(e){return!clLocalVars.itemsGot}},no_item:{success:function(e){return!clLocalVars.itemsUsed}},avoid_decors:{initLocalVars:function(e){clLocalVars.decorsHit||(clLocalVars.decorsHit={})},success:function(e){for(var t in e.value)if(clLocalVars.decorsHit[t])return!1;return!0}},character:{success:function(e){return oPlayers[0].personnage==e.value}},falls:{initRuleVars:function(){return{falls:0}},initSelected:function(e,t){t&&addChallengeHud("falls",{title:toLanguage("Falls","Chutes"),value:clLocalVars.falls+t.falls,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.falls+t.falls<=e.value},next_circuit:function(e){e&&(e.falls+=clLocalVars.falls)}},no_stunt:{success:function(e){return!clLocalVars.stunted}},backwards:{initSelected:function(e){clLocalVars.backwardsStart=!0},success:function(e){return!clLocalVars.forwards}},time:{success:function(e){return getActualGameTime()<=e.value}},time_delay:{initSelected:function(e){clLocalVars.delayedStart=e.value},success:function(e){return!clLocalVars.startedAt||(clLocalVars.startedAt-1)*SPF/1e3>=e.value}},mini_turbo:{initRuleVars:function(){return{miniTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("miniTurbo",{title:"Mini Turbos",value:clLocalVars.miniTurbo+t.miniTurbo,out_of:e.value})},success:function(e,t){if(t&&t.miniTurbo+clLocalVars.miniTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.miniTurbo+=clLocalVars.miniTurbo)}},super_turbo:{initRuleVars:function(){return{superTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("superTurbo",{title:"Super Turbos",value:clLocalVars.superTurbo+t.superTurbo,out_of:e.value})},success:function(e,t){if(t&&t.superTurbo+clLocalVars.superTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.superTurbo+=clLocalVars.superTurbo)}},stunts:{initRuleVars:function(){return{stunts:0}},initSelected:function(e,t){t&&addChallengeHud("stunts",{title:toLanguage("Stunts","Figures"),value:clLocalVars.stunts+t.stunts,out_of:e.value})},success:function(e,t){if(t&&t.stunts+clLocalVars.stunts>=e.value)return!0},next_circuit:function(e){e&&(e.stunts+=clLocalVars.stunts)}},position:{success:function(e){if(oPlayers[0].place==e.value)return!0}},with_pts:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{firstAttempt:!0}},success:function(e,t){if(t.firstAttempt&&aScores[0]>=e.value)return!0}},different_circuits:{initRuleVars:function(){return{played_circuits:{}}},success:function(e,t){return!t.played_circuits[oMap.ref]},next_circuit:function(e){e.played_circuits[oMap.ref]=!0}}};function addCreationChallenges(e,t){t=challenges[e][t];if(t)for(var n=t.list,a=0;a<n.length;a++){var o=n[a];if(!o.succeeded||o===clSelected){var i=o.data,r=challengeRules[i.goal.type].verify;challengesForCircuit[r].push(o);for(var l=listChallengeRules(i),s=0;s<l.length;s++)initChallengeRule(o,l[s])}}}function listChallengeRules(e){var t=e.constraints.slice(0);return t.unshift(e.goal),t}function initChallengeRule(e,t){challengeRules[t.type].initRuleVars&&(clRuleVars[e.id]||(clRuleVars[e.id]={}),clRuleVars[e.id][t.type]||(clRuleVars[e.id][t.type]=challengeRules[t.type].initRuleVars(e)))}function reinitChallengeVars(){for(var e in challengesForCircuit)for(var t=challengesForCircuit[e],n=0;n<t.length;n++)for(var a=t[n],o=listChallengeRules(a.data),i=0;i<o.length;i++)initChallengeRule(a,o[i]);reinitLocalVars()}function isSameDistrib(e,t){if(e.length===t.length){for(var n=0;n<e.length;n++){var a,o=e[n],i=t[n];for(a in o)if(o[a]!==i[a])return;for(a in i)if(o[a]!==i[a])return}return 1}}function reinitLocalVars(){if(clLocalVars={drifted:!1,stunted:!1,itemsGot:!1,itemsUsed:!1,falls:0,miniTurbo:0,superTurbo:0,stunts:0,lostBalloons:0,cheated:!1},itemDistribution){for(var e=itemDistributions[getItemMode()],t=!1,n=0;n<2;n++)if(isSameDistrib(itemDistribution,e[n].value)){t=!0;break}t||(clLocalVars.cheated=!0)}for(var a in clHud={},challengesForCircuit)for(var o=challengesForCircuit[a],n=0;n<o.length;n++)for(var i=o[n],r=listChallengeRules(i.data),l=0;l<r.length;l++){var s,c=r[l];challengeRules[c.type].initLocalVars&&challengeRules[c.type].initLocalVars(c),clSelected===i&&challengeRules[c.type].initSelected&&(s=clRuleVars[i.id]?clRuleVars[i.id][c.type]:void 0,challengeRules[c.type].initSelected(c,s))}}function challengeCheck(e,t){if(!(clLocalVars.cheated||1<strPlayer.length))for(var n=challengesForCircuit[e],a=0;a<n.length;a++){var o=n[a],i=listChallengeRules(o.data),r=challengeRulesSatisfied(o,i);!0===r?(challengeSucceeded(o),n.splice(a,1),a--):!1===r||challengeRules[i[0].type].reset_on_fail?delete clRuleVars[o.id]:challengeHandleEvents(o,t)}}function challengeHandleEvents(e,t){if(t){var n=clRuleVars[e.id];if(n)for(var a=listChallengeRules(e.data),o=0;o<t.length;o++)for(var i=t[o],r=0;r<a.length;r++){var l=a[r];challengeRules[l.type][i]&&challengeRules[l.type][i](n[l.type])}}}var clSelectionFail=!1;function challengeHandleFail(){clSelectionFail||(clSelectionFail=!0,clHud={},oChallengeCpts.innerHTML="",1<timer&&showClFailedPopup())}function challengeRulesSatisfied(e,t){for(var n=!0,a=0;a<t.length;a++){var o=challengeRuleSatisfied(e,t[a]);if(!1===o)return!1;!0!==o&&(n=!1)}return!!n||null}function challengeRuleSatisfied(e,t){e=clRuleVars[e.id]?clRuleVars[e.id][t.type]:void 0;return challengeRules[t.type].success(t,e)}function challengeSucceeded(i){var e;i.succeeded&&i!==clSelected||(e=i.succeeded,i.succeeded=!0,clSelected==i&&(clSelected=void 0,clHud={}),"pending_completion"===i.status&&(i.status="pending_publication"),delete clRuleVars[i.id],e?setTimeout(function(){showChallengePopup(i,{})},1):xhr("challengeSucceeded.php","id="+i.id,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}if(showChallengePopup(i,t),t.rewards)for(var n=0;n<t.rewards.length;n++)for(var a=t.rewards[n].id,o=0;o<clRewards.length;o++)if(clRewards[o].id==a){clRewards[o].unlocked=1;break}return!0}))}function showChallengePartialSuccess(e,t){var n,a,o,i,r,l,s;document.getElementById("challenge-popup-"+e.id)||((n=document.createElement("div")).id="challenge-popup-"+e.id,n.className="challenge-popup challenge-popup-partial",n.style.width=56*iScreenScale+"px",n.style.left=12*iScreenScale+"px",n.style.top=Math.round(4.5*iScreenScale)+"px",n.style.padding=Math.round(1.5*iScreenScale)+"px",n.style.paddingBottom=5*iScreenScale+"px",n.style.border="inset "+Math.round(.5*iScreenScale)+"px #07B",n.style.fontSize=2*iScreenScale+"px",n.style.opacity=0,a=language?"Challenge being completed":"Dfi en cours de russite",o=e.description.main,i=language?"Cups completed: "+t.nb+"/"+t.total:"Coupes russies: "+t.nb+"/"+t.total,r=language?"Caution, progress will be lost when you close the browser":"Attention, toute progression sera perdue  la fermeture du navigateur.",l=language?"Close":"Fermer",n.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup2.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+a+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+o+'</div><div class="challenge-popup-award" style="margin:'+iScreenScale+'px 0">'+i+"</div>"+(t.warning?'<div class="challenge-popup-disclaimer" style="margin:'+iScreenScale+'px 0">'+r+"</div>":"")+'<div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup('+e.id+');">'+l+"</a></div>",(l=document.getElementsByClassName("challenge-popup")).length?$mkScreen.insertBefore(n,l[0]):$mkScreen.appendChild(n),s=0,function e(){s<1?(n.style.opacity=s,s+=.2,setTimeout(e,40)):n.style.opacity=1}(),focusOnChallengeClose())}function showChallengePopup(t,n){if(!document.getElementById("challenge-popup-"+t.id)){var e=n.pts,a=document.createElement("div");a.id="challenge-popup-"+t.id,a.className="challenge-popup",a.style.width=56*iScreenScale+"px",a.style.left=12*iScreenScale+"px",a.style.top=Math.round(4.5*iScreenScale)+"px",a.style.padding=Math.round(1.5*iScreenScale)+"px",a.style.paddingBottom=5*iScreenScale+"px",a.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",a.style.fontSize=2*iScreenScale+"px",a.style.opacity=0;var o=language?"Challenge completed!":"Dfi russi !",i=t.description.main,r=language?"You receive a reward of <strong>"+e+" pt"+(2<=e?"s":"")+"</strong>.":"Vous recevez <strong>"+e+" pt"+(2<=e?"s":"")+"</strong> en rcompense.",l=language?"Your challenge points goes from <strong>"+n.pts_before+"</strong> to <strong>"+n.pts_after+"</strong>!":"Vos points dfis passent de <strong>"+n.pts_before+"</strong>  <strong>"+n.pts_after+"</strong> !",s=language?"Close":"Fermer";if(a.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup1.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+o+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+i+"</div>"+(e?'<div class="challenge-popup-award" style="margin:'+iScreenScale+'px 0">'+r+"<br />"+l+"</div>":"")+(0<=n.rating?'<div class="challenge-rating" style="margin-left:'+Math.round(3.5*iScreenScale)+"px;font-size:"+Math.round(2.5*iScreenScale)+'px">'+toLanguage("Rate this challenge:","Notez ce dfi :")+'<div class="challenge-rating-stars"></div><div class="challenge-rated">'+toLanguage("Thanks","Merci")+"</div></div>":"")+(n.publish?'<div class="challenge-publish" style="margin:'+iScreenScale+'px 0">'+toLanguage("You can now","Vous pouvez maintenant")+' <a href="javascript:publishChallenge('+t.id+')">'+toLanguage("publish challenge","publier le dfi")+"</a>.</div>":"")+'<div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup('+t.id+');">'+s+"</a></div>",0<=n.rating){var c=a.getElementsByClassName("challenge-rating-stars");(c=c[0]).style.position="relative",c.style.marginLeft=Math.round(.4*iScreenScale)+"px",c.style.marginRight=Math.round(.4*iScreenScale)+"px",c.style.top=Math.round(.4*iScreenScale)+"px";function p(){for(var e=+this.rating,t=0;t<e;t++)h[t].src="images/star1.png";for(t=e;t<5;t++)h[t].src="images/star0.png"}function u(){for(var e=0;e<n.rating;e++)h[e].src="images/star1.png";for(e=n.rating;e<5;e++)h[e].src="images/star0.png"}function d(){var e=+this.rating;n.rating=n.rating==e?0:e,u(),m.style.visibility="hidden",xhr("challengeRate.php","challenge="+t.id+"&rating="+n.rating,function(e){return 1==e&&(m.style.visibility="visible",!0)})}for(var m=(m=a.getElementsByClassName("challenge-rated"))[0],h=[],y=0;y<5;y++){var g=document.createElement("img");g.alt="S",g.src="images/star0.png",g.style.width=3*iScreenScale+"px",g.style.marginLeft=Math.round(.4*iScreenScale)+"px",g.style.marginRight=Math.round(.4*iScreenScale)+"px",g.rating=y+1,g.onmouseover=p,g.onmouseout=u,g.onclick=d,h[y]=g,c.appendChild(g)}u()}s=document.getElementsByClassName("challenge-popup");s.length?$mkScreen.insertBefore(a,s[0]):$mkScreen.appendChild(a);var f=0;if(!function e(){f<1?(a.style.opacity=f,f+=.2,setTimeout(e,40)):a.style.opacity=1}(),!pause&&document.onkeydown&&(clLocalVars.forcePause=!0,document.onkeydown({keyCode:findKeyCode("pause")}),delete clLocalVars.forcePause),(bMusic||iSfx)&&(challengeMusic||((challengeMusic=playSoundEffect("musics/events/challenge.mp3")).className="",endGPMusic?(pauseMusic(endGPMusic),challengeMusic.onended=function(){unpauseMusic(endGPMusic),challengeMusic=null}):willPlayEndMusic?(willPlayEndMusic=!1,challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):isEndMusicPlayed?(pauseMusic(endingMusic),challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):challengeMusic.onended=function(){challengeMusic=null})),n.unlocked)for(y=0;y<n.unlocked.length;y++)showChallengeRewardPopup(n.unlocked[y]);focusOnChallengeClose()}}function showChallengeRewardPopup(e){var t,n,a,o,i,r;document.getElementById("challenge-popup-reward-"+e.id)||((t=document.createElement("div")).id="challenge-popup-reward-"+e.id,t.className="challenge-popup",t.style.width=56*iScreenScale+"px",t.style.left=12*iScreenScale+"px",t.style.top=Math.round(4.5*iScreenScale)+"px",t.style.padding=Math.round(1.5*iScreenScale)+"px",t.style.paddingBottom=5*iScreenScale+"px",t.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",t.style.fontSize=2*iScreenScale+"px",t.style.opacity=0,n=language?"New character unlocked!":"Nouveau perso dbloqu !",a=language?"You can now play with <strong>"+e.name+"</strong>!":"Vous pouvez dsormais jouer avec <strong>"+e.name+"</strong> !",(i=document.createElement("img")).src=getSpriteSrc(e.sprites),i.alt=e.name,i.className="pixelated",i.style.visibility="hidden",o=language?"Close":"Fermer",t.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup1.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+n+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+a+'</div><div class="challenge-popup-reward-ch"></div><div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup(&quot;reward-'+e.id+'&quot;);">'+o+"</a></div>",t.getElementsByClassName("challenge-popup-reward-ch")[0].appendChild(i),i.onload=function(){var e=this.parentNode,t=iScreenScale/8,n=Math.round(t*this.naturalWidth/24),t=Math.round(t*this.naturalHeight);e.style.width=n+"px",e.style.height=t+"px",this.style.width=24*n+"px",this.style.height=t+"px",this.style.visibility=""},(i=document.getElementsByClassName("challenge-popup")).length?$mkScreen.insertBefore(t,i[0]):$mkScreen.appendChild(t),r=0,function e(){r<1?(t.style.opacity=r,r+=.2,setTimeout(e,40)):t.style.opacity=1}())}function focusOnChallengeClose(){var e=document.querySelectorAll(".challenge-popup .challenge-popup-close a");e.length?e[e.length-1].focus():(e=document.getElementById("reprendre"))?e.focus():(e=document.getElementById("octn"))&&e.focus()}function showClSelectedPopup(){var t=document.createElement("div");t.style.fontSize=2*iScreenScale+"px",t.className="clselected-popup",t.style.left=27*iScreenScale+"px",t.style.top=iHeight*iScreenScale+"px",t.innerHTML='<div class="clselected-close"><a href="#null">&times;</a></div><div class="clselected-ctn"><div></div><div><strong>'+toLanguage("Challenge selected :","Dfi slectionn:")+"</strong> "+(clSelected.name||clSelected.description.main)+"</div></div>",t.querySelector(".clselected-close a").onclick=function(){return document.body.removeChild(t),!1},document.body.appendChild(t);var n=1;setTimeout(function e(){0<n?(t.style.opacity=n,n-=.04,setTimeout(e,40)):document.body.removeChild(t)},1500)}function showClFailedPopup(){var e=document.createElement("div");e.style.position="absolute",e.style.color="#C00",e.style.right=Math.round(iScreenScale/2)+"px",e.style.top=Math.round(2.5*iScreenScale)+"px",e.style.fontSize=Math.round(1.8*iScreenScale)+"px",e.style.display="flex",e.style.alignItems="center",e.style.fontFamily="Courier New",e.innerHTML='<strong style="color:#800;font-size:1.8em">&times;</strong>&nbsp;'+(language?"Challenge failed...":"Dfi chou..."),oChallengeCpts.parentNode.appendChild(e),!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/clfail.mp3")}window.closeChallengePopup=function(e){var t,n=document.getElementById("challenge-popup-"+e);n&&(clHud&&0===Object.keys(clHud).length&&oChallengeCpts.firstChild&&(oChallengeCpts.innerHTML=""),t=1,function e(){0<t?(n.style.opacity=t,t-=.2,setTimeout(e,40)):($mkScreen.removeChild(n),focusOnChallengeClose())}())},window.publishChallenge=function(e){for(var t in challenges)for(var n in challenges[t])for(var a=challenges[t][n],o=a.list,i=0;i<o.length;i++)o[i].id==e&&(a.main?openChallengeEditor():document.location.href="challenges.php?cl="+a.id)};var isMetaItem=0,metaItemPosition=.5,metaItemRange=1e3,itemDistributions={BB:[{name:toLanguage("Standard","Classique"),value:[{fauxobjet:4,banane:5,carapacerouge:1,carapace:4},{carapace:4,carapacerouge:7,bobomb:2,bananeX3:1},{carapace:4,bobomb:2,carapaceX3:2,banane:1,fauxobjet:1,carapacerouge:4},{carapacebleue:0,carapacerougeX3:1,carapacerouge:2,megachampi:3,etoile:3,champi:3,champior:1,champiX3:1,bloops:1}]},{name:toLanguage("Explosive mode","Mode explosif"),value:[{fauxobjet:1,banane:3,carapacerouge:3,carapace:5},{bananeX3:1,carapacerouge:12,carapace:6,bobomb:4},{carapacerouge:8,carapace:5,bobomb:4,carapaceX3:3},{carapacerouge:7,carapacebleue:4,carapacerougeX3:3,megachampi:5,etoile:5,champi:1,champior:1,champiX3:1,bloops:1}]},{name:toLanguage("Shells","Carapaces"),value:[{carapacerouge:1,carapace:4},{carapacerouge:7,carapace:4},{carapacerouge:4,carapace:4,carapaceX3:2},{carapacerouge:6,carapacebleue:1,carapacerougeX3:3}]},{name:toLanguage("Bob-ombs","Bob-ombs"),value:[{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1}]},{name:toLanguage("Mushrooms","Champis"),value:[{champi:1,poison:1},{megachampi:1,champi:3,champiX3:1},{megachampi:2,champi:2,champior:1,champiX3:2},{megachampi:1,champior:1,champiX3:1}]}],VS:[{name:toLanguage("Standard","Classique"),value:[{fauxobjet:10,banane:6,carapace:6,bananeX3:2,carapacerouge:2},{carapace:8,bananeX3:4,carapacerouge:5,champi:3},{carapaceX3:7,carapacerouge:7,poison:5,champi:5,bobomb:3,bloops:3},{champi:6,poison:4,carapaceX3:6,carapacerouge:5,bobomb:3,bloops:2},{champi:8,carapacerouge:6,bobomb:3,champiX3:2},{bobomb:4,champi:5,carapacerouge:4,champiX3:3,carapacerougeX3:3},{champi:8,carapacerougeX3:7,champiX3:6,megachampi:3},{champiX3:8,carapacerougeX3:8,megachampi:6,etoile:4,champior:2,carapacebleue:5},{megachampi:7,champiX3:6,etoile:5,champior:3,carapacebleue:5},{megachampi:8,champiX3:6,etoile:6,billball:3,champior:3,carapacebleue:5},{etoile:6,megachampi:6,billball:5,champior:4,eclair:5},{billball:4,etoile:3,eclair:6,champior:5}]},{name:toLanguage("Aggressive mode","Mode explosif"),value:[{fauxobjet:5,banane:2,carapace:10,bananeX3:1,carapacerouge:3},{carapace:10,bananeX3:4,carapacerouge:15,carapaceX3:4,champi:1},{carapacerouge:10,carapaceX3:10,champi:2,poison:5,bobomb:10,bloops:3},{carapacerouge:10,carapaceX3:12,champi:3,poison:4,bobomb:8,bloops:2},{carapacerouge:12,champi:4,bobomb:8},{carapacerouge:8,champi:5,bobomb:6,champiX3:1,carapacerougeX3:6},{champi:4,champiX3:3,carapacerougeX3:10,megachampi:3},{champiX3:4,carapacerougeX3:10,megachampi:6,etoile:4,carapacebleue:12},{champiX3:3,megachampi:7,etoile:5,champior:1,carapacebleue:10},{champiX3:3,megachampi:8,etoile:6,champior:1,carapacebleue:10,billball:5},{megachampi:6,etoile:6,champior:1,billball:5,eclair:8},{etoile:3,champior:2,billball:6,eclair:8}]},{name:toLanguage("Shells","Carapaces"),value:[{carapace:6},{carapace:8,carapacerouge:8},{carapace:6,carapacerouge:5},{carapace:6,carapacerouge:7},{carapace:4,carapacerouge:5},{carapace:4,carapacerouge:6,carapaceX3:2,carapacerougeX3:2},{carapace:2,carapacerouge:4,carapaceX3:2,carapacerougeX3:2,carapacebleue:4},{carapace:2,carapacerouge:2,carapaceX3:4,carapacerougeX3:4,carapacebleue:6},{carapacerouge:2,carapaceX3:4,carapacerougeX3:4,carapacebleue:6},{carapaceX3:6,carapacerougeX3:6,carapacebleue:4},{carapaceX3:6,carapacerougeX3:6},{carapaceX3:8,carapacerougeX3:8}]},{name:toLanguage("Bob-ombs","Bob-ombs"),value:[{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1}]},{name:toLanguage("Mushrooms","Champis"),value:[{champi:1},{champi:1,poison:1},{champi:4,poison:1,megachampi:1},{champi:3,poison:1,megachampi:1},{champi:3,poison:1,champiX3:1,megachampi:2},{champi:2,champiX3:1,megachampi:2},{champi:1,champiX3:2,megachampi:3},{champiX3:2,megachampi:2,champior:1},{champiX3:1,megachampi:1,champior:1},{champiX3:1,champior:1},{champiX3:1,champior:2},{champior:1}]},{name:toLanguage("None","Aucun"),value:[]}]},customItemDistrib=localStorage.getItem("itemsets");function getItemMode(){return"BB"==course?"BB":"VS"}customItemDistrib=customItemDistrib?JSON.parse(customItemDistrib):{VS:[],BB:[]};var COL_KART=0,COL_OBJ=1,collisionTest,collisionPlayer,collisionTeam,collisionDecor,clLocalVars,clHud,clSelected;function isHitSound(e){return collisionTest==COL_OBJ||collisionTeam==e.team&&{x:e.x,y:e.y}}function handleHit(e){clLocalVars.myItems&&clLocalVars.currentKart&&clLocalVars.currentKart!=oPlayers[0]&&!clLocalVars.currentKart.tourne&&-1!=clLocalVars.myItems.indexOf(e)&&incChallengeHits(clLocalVars.currentKart)}function handleHit2(e,t){e==oPlayers[0]&&t!=oPlayers[0]&&incChallengeHits(t)}function incChallengeHits(e){clLocalVars.nbHits++,updateChallengeHud("hits",clLocalVars.nbHits),"BB"==course&&1==e.ballons.length&&clLocalVars.killed&&-1==clLocalVars.killed.indexOf(e)&&(clLocalVars.killed.push(e),clLocalVars.nbKills++,updateChallengeHud("kills",clLocalVars.nbKills)),challengeCheck("each_hit")}function touche_banane(e,t,n){n=n||[];for(var a=0;a<items.banane.length;a++){var o=items.banane[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_poison(e,t,n){n=n||[];for(var a=0;a<items.poison.length;a++){var o=items.poison[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_champi(e,t){for(var n=0;n<items.champi.length;n++){var a=items.champi[n];if(e>a.x-4&&e<a.x+4&&t>a.y-4&&t<a.y+4)return detruit(a),1}}function touche_fauxobjet(e,t,n){n=n||[];for(var a=0;a<items.fauxobjet.length;a++){var o=items.fauxobjet[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_cverte(e,t,n){n=n||[];for(var a=0;a<items.carapace.length;a++){var o=items.carapace[a];if(-1==n.indexOf(o)&&!o.z&&e>o.x-5&&e<o.x+5&&t>o.y-5&&t<o.y+5)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_crouge(e,t,n){n=n||[];for(var a=0;a<items["carapace-rouge"].length;a++){var o=items["carapace-rouge"][a];if(-1==n.indexOf(o)&&!o.z)if(-1==o.owner||-2==o.aipoint?e>o.x-5&&e<o.x+5&&t>o.y-5&&t<o.y+5:e==o.x&&t==o.y)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team}}function touche_bobomb(e,t,n){n=n||[];for(var a=0;a<items.bobomb.length;a++){var o=items.bobomb[a];if(!o.z&&-1==n.indexOf(o))if(-1!=o.theta){var i=18;if(38<=o.cooldown?i=0:30<=o.cooldown&&(i=5),!o.countdown&&(o.x-e)*(o.x-e)+(o.y-t)*(o.y-t)<i*i){if(o.cooldown<=0){i=collisionTeam!=o.team&&(o.cooldown<-5?42:84);return i&&handleHit(o),i}o.cooldown=1,isOnline&&syncItems.push(o)}}else if(e>o.x-5&&e<o.x+5&&t>o.y-5&&t<o.y+5)for(j=0;j<aKarts.length;j++){var r=aKarts[j].using.indexOf(o);if(-1!=r){throwItem(aKarts[j],{theta:1,countdown:0,cooldown:1},r);break}}}return!1}function touche_cbleue(e,t){for(var n=0;n<items["carapace-bleue"].length;n++){var a=items["carapace-bleue"][n];if(a.cooldown<=0&&-10<=a.cooldown)if(!a.countdown&&(a.x-e)*(a.x-e)+(a.y-t)*(a.y-t)<576){var o=collisionTeam!=a.team&&(a.cooldown<-5?42:84);return o&&handleHit(a),o}}return!1}function touche_asset(e,t,n,a){for(var o,i=["pointers","flippers"],r=0;r<i.length;r++)if(oMap[o=i[r]])for(var l=2*Math.PI,r=0;r<oMap[o].length;r++){var s=(e-(m=(g=oMap[o][r])[1][0]))*(e-m)+(t-(h=g[1][1]))*(t-h);if(s<(y=g[1][2]*(1-g[2][0]))*y){var c=g[2][2],p=Math.atan2(t-h,e-m),u=g[2][3];(n-m)*(n-m)+(a-h)*(a-h)<y*y&&(d=Math.atan2(a-h,n-m),u-=(d-=l*Math.round((d-p)/l))-p);var d=Math.sqrt(s),s=d/y,d=g[1][3]*(g[1][4]*(1-s)+g[1][5]*s)/d,p=0<u?(p-=l*Math.floor((p-c)/l))<c+u+d:c+u-d<(p-=l*Math.ceil((p-c)/l));if(p)return[o,g]}}if(oMap[o="bumpers"])for(r=0;r<oMap[o].length;r++)if((n-(m=(g=oMap[o][r])[1][0]))*(n-m)+(a-(h=g[1][1]))*(a-h)<(y=g[1][2]/2)*y)return[o,g];if(oMap[o="oils"])for(r=0;r<oMap[o].length;r++){var m=(g=oMap[o][r])[1][0],h=g[1][1],y=4;if(Math.abs(n-m)<y&&Math.abs(a-h)<y)return[o,g]}if(oMap[o="flowers"])for(r=0;r<oMap[o].length;r++){var g,f=(g=oMap[o][r])[1],S=f[0],v=f[1],b=Math.round(f[2]/2);if(pointInRectangle(n,a,[S-b,v-b,2*b,2*Math.round(f[3]/2)]))return[o,g]}return!1}function distKart(e){for(var t=1/0,n=0;n<oPlayers.length;n++){var a=oPlayers[n];!kartIsPlayer(a)||finishing||(a=Math.hypot(e.x-a.x,e.y-a.y))<t&&(t=a)}return t}function stuntKart(e){e.figstate=21,e.z+=1,e.heightinc+=.5,e==oPlayers[0]&&(clLocalVars.stunted=!0),playIfShould(e,"musics/events/stunt.mp3")}function places(e,t){for(var n=aKarts[e],a=!t,o=0;o<strPlayer.length;o++)oPlayers[o].cpu||oPlayers[o].loose||(a=!1);if(!a){var i=1;if("BB"!=course){if(n.tours>oMap.tours||!oMap.checkpoint.length)return;(s=n.demitours+1)>=oMap.checkpoint.length&&(s=0);for(var r=oMap.checkpoint[s][3],l=n.tours*oMap.checkpoint.length+getCpScore(n)-Math.abs(n[r?"y":"x"]-oMap.checkpoint[s][r])/1e4,o=0;o<aKarts.length;o++){var s,c=aKarts[o];(s=c.demitours+1)>=oMap.checkpoint.length&&(s=0),r=oMap.checkpoint[s][3],c!=n&&c.tours*oMap.checkpoint.length+getCpScore(c)-Math.abs(c[r?"y":"x"]-oMap.checkpoint[s][r])/1e4>l&&i++}}else for(o=0;o<aKarts.length;o++){var p=n.ballons.length?n.ballons.length+n.reserve:0,u=aKarts[o].ballons.length?aKarts[o].ballons.length+aKarts[o].reserve:0;(aKarts[o]!=n&&p<u||p==u&&n.initialPlace>aKarts[o].initialPlace)&&i++}n.loose||(n.place=i),e<strPlayer.length&&(document.getElementById("infoPlace"+e).innerHTML=i)}}function getLastCp(e){return oMap.sections?1<e.tours&&e.tours<=oMap.tours?oMap.sections[e.tours-2]:oMap.checkpoint.length-1:0}function getNextCp(e){return oMap.sections?e.tours<=oMap.sections.length?oMap.sections[e.tours-1]:oMap.checkpoint.length-1:0}function getCpDiff(e){var t=getLastCp(e),t=getNextCp(e)-t;return t<=0&&(t+=oMap.checkpoint.length),t}function getCpScore(e){var t=getLastCp(e),t=e.demitours-t;return t<0&&(t+=oMap.checkpoint.length),t}function distanceToFirst(e){for(var t,n=1/0,a=0;a<aKarts.length;a++)aKarts[a].place<n&&(n=(t=aKarts[a]).place);return distanceToKart(e,t)}function distanceToSecond(e){for(var t,n=1/0,a=0;a<aKarts.length;a++)aKarts[a]!=e&&aKarts[a].place<n&&(n=(t=aKarts[a]).place);return distanceToKart(t,e)}function distanceToKart(e,t){var n=0,a=e.x,o=e.y,i=e.tours,r=e.demitours;for(oMap.sections&&(i=t.tours);i<t.tours||i==t.tours&&r<t.demitours;){++r>=oMap.checkpoint.length&&(r=0,i++);var l=oMap.checkpoint[r],s=l[0]+(l[3]?Math.round(l[2]/2):8),l=l[1]+(l[3]?8:Math.round(l[2]/2));n+=Math.hypot(s-a,l-o),a=s,o=l}return n+=Math.hypot(t.x-a,t.y-o)}function checkpoint(e,t,n){var a,o,i=[e.x-t,e.y-n],r=[t,n],l=[0<t,0<n],s=200<t*t+n*n,c=e.demitours;simplified||(o=((a=getNextCp(e))||oMap.checkpoint.length)-1);for(var p=0;p<oMap.checkpoint.length;p++){var u=oMap.checkpoint[p],d=[u[0],u[1],15,15];d[3-u[3]]=u[2];var m,h,y=pointInRectangle(e.x,e.y,d);if(!y&&s&&(!((m=l[h=u[3]])?i[h]<=u[h]&&i[h]+r[h]>=u[h]:i[h]>=u[h]+u[h+2]&&i[h]+r[h]<=u[h]+u[h+2])||(h=i[d=1-h]+((m?u[h]:u[h]+u[h+2])-i[h])*r[d]/r[h])>=u[d]&&h<=u[d]+u[2+d]&&(y=!0)),y)if(simplified){if(0==p&&oMap.checkpoint.length-c<5)return 1;if(c==p-1||c&&Math.abs(c-p)<5)return void(e.demitours=p)}else{if(p==a&&c==o)return 1;if(c==p-1||c==p+1)return void(e.demitours=p);if(0==p&&c==oMap.checkpoint.length-1)return void(e.demitours=p)}}}function int8ToHexString(e){return[].slice.call(e).map(function(e){return e.toString(16).padStart(2,"0")}).join("")}function hexStringToInt8(e){return new Uint8Array(e.match(/../g).map(function(e){return parseInt(e,16)})).buffer}function itemDataToHex(e,t){switch(e){case"double":return int8ToHexString(new Uint8Array(new Float64Array([t]).buffer,0,8));case"float":return int8ToHexString(new Uint8Array(new Float32Array([t]).buffer,0,4));case"int":return int8ToHexString(new Uint8Array(new Int32Array([t]).buffer,0,4));case"short":return int8ToHexString(new Uint8Array(new Int16Array([t]).buffer,0,2));case"byte":return int8ToHexString(new Uint8Array(new Int8Array([t]).buffer,0,1))}}function hexToItemData(e,t){switch(e){case"double":return new Float64Array(hexStringToInt8(t))[0];case"float":return new Float32Array(hexStringToInt8(t))[0];case"int":return new Int32Array(hexStringToInt8(t))[0];case"short":return new Int16Array(hexStringToInt8(t))[0];case"byte":return new Int8Array(hexStringToInt8(t))[0]}}function itemDataLength(e){switch(e){case"double":return 16;case"float":case"int":return 8;case"short":return 4;case"byte":return 2}}function resetDatas(){for(var e=oPlayers[0],V="BB"!=course?["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","size","tourne","tombe","arme","tours","demitours","champi","etoile","megachampi","billball","place"]:["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","size","tourne","tombe","arme","ballons","reserve","champi","etoile","megachampi"],F=V.concat("aipoint"),t={player:[],item:[],lastcon:connecte},n=[{params:t.player,mapping:V,kart:e}],a=0;a<aKarts.length;a++)(l=aKarts[a]).controller==identifiant&&(t.cpu||(t.cpu={}),t.cpu[l.id]=[],n.push({params:t.cpu[l.id],mapping:F,kart:l}));for(var o=0;o<n.length;o++){var i=n[o],r=i.params,l=i.kart,s=i.mapping;r.length=s.length;for(var c,a=0;a<s.length;a++){switch(s[a]){case"demitours":"BB"!=course&&(c=getCpScore(l));break;case"ballons":"BB"==course&&(c=l.ballons.length);break;default:c=l[s[a]]}r[a]=c}}for(var p=Array.from(new Set(syncItems)),j=[],a=0;a<p.length;a++){var u=p[a],d="";if(u.deleted){if(!u.id)continue}else for(var m=itemBehaviors[u.type],o=0;o<m.sync.length;o++){var h=m.sync[o];d+=itemDataToHex(h.type,u[h.key])}for(var y={data:d},o=0;o<n.length;o++)if(-1!==(l=n[o].kart).using.indexOf(u)){y.holder=l.id;break}u.id?y.id=u.id:(y.type=itemTypes.indexOf(u.type),j.push(u)),t.item.push(y)}syncItems.length=0,"BB"==course?t.battle=1:3!=oMap.tours&&(t.laps=oMap.tours),fetch("reload.php",{method:"post",body:JSON.stringify(t)}).then(function(e){return e.json()}).then(function(h){if(-1!=h){refreshDatas=!0;for(var e=h[1],t=e[0],n=e[1],l=0;l<t.length;l++){var a=t[l];j[l]&&(j[l].id=a)}for(var o=[],l=0;l<n.length;l++){var i=n[l],r=i[0],s=itemTypes[i[1]],c=i[2];if(s){var p=i[3],u=i[4],i=!1;if((M=items[s].find(function(e){return e.id==r}))?u||(supprime(M,!1),c=0):u&&(M={id:r,type:s},i=!0),u){for(var d=0,m=itemBehaviors[s],y=0;y<m.sync.length;y++){var g=m.sync[y],f=itemDataLength(g.type),S=u.substr(d,f);S.length==f&&(M[g.key]=hexToItemData(g.type,S)),d+=f}i&&addNewItem(null,M)}for(y=0;y<aKarts.length;y++){var v=(N=aKarts[y]).using.indexOf(M);N.id==c?-1==v&&(N.using.push(M),1<N.using.length&&!N.rotitem&&(N.rotitem=0)):-1!=v&&N.using.splice(v,1)}u&&o.push({item:M,start:p,end:h[2]})}}for(l=0;l<o.length;l++){var b=o[l],M=b.item,x=itemBehaviors[s].move;if(x&&!1!==itemBehaviors[s].onlineResync)for(var C=b.start;C<b.end&&!M.deleted;C++)x(M)}for(var P=h[0],l=0;l<P.length;l++)for(var k=P[l],w=k[0][0],y=0;y<aKarts.length;y++)if((N=aKarts[y]).id==w){if(k[2]){var I=k[2];if(I.controller&&(N.controller=I.controller,N.controller==identifiant))break}for(var T=k[1],E=N.etoile,L=N.billball,I=N.tombe,B=(N.aipoint,N.controller?F:V),C=0;C<B.length;C++){var z=B[C],D=T[C];switch(z){case"demitours":N.demitours=(getLastCp(N)+D)%oMap.checkpoint.length;break;case"ballons":if("BB"==course){for(;N.ballons.length<D;)N.ballons.length||(N.sprite[0].div.style.opacity=1,N.sprite[0].img.style.display="",oPlanCharacters[y].style.display="block",oPlanCharacters2[y].style.display="block",N.loose=!1),addNewBalloon(N);for(;N.ballons.length>D;){var H=N.ballons.length-1;N.ballons[H][0].suppr(),N.ballons.pop()}}break;default:N[B[C]]=D}}if(25<=N.billball&&!L?(N.sprite[0].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(N.sprite[0]),N.aipoint=void 0):50<=N.etoile&&!E?N.sprite[0].img.src=getStarSrc(N.personnage):(E&&!N.etoile||L&&!N.billball)&&(N.sprite[0].img.src=getSpriteSrc(N.personnage),resumeSpriteSize(N.sprite[0])),updateProtectFlag(N),I&&!N.tombe&&(N.sprite[0].img.style.display="block","BB"==course))for(C=0;C<N.ballons.length;C++)N.ballons[C][0].img.style.display="block";if(!I&&N.tombe&&(N.sprite[0].img.style.display="none",N.frminv=10,2<N.tombe)){if("BB"==course)for(C=0;C<N.ballons.length;C++)N.ballons[C][0].img.style.display="none";N.marker&&(N.marker.div[0].style.display="none")}!N.turnSound&&N.tourne&&(N.turnSound=playDistSound(N,"musics/events/spin.mp3","BB"==course?80:50),N.frminv||(N.frminv=10)),N.turnSound&&!N.tourne&&(N.turnSound=void 0);for(C=k[0][1];C<h[2];C++)move(y,!0);break}if(connecte=h[2],h[3]){function O(){var e=oPlayers[0];"BB"==course&&(e.arme=!1,supprArme(e.speed=0)),e.speedinc=0,e.rotinc=0,e.rotincdir=0,e.sprite[0].setState(0),stopDrifting(0);var p=document.getElementById("infos0");p.innerHTML="",p.style.border="solid 1px black",p.style.opacity=.7,p.style.fontSize=Math.round(1.5*iScreenScale+4)+"pt",p.style.fontFamily="Courier",p.style.top=3*iScreenScale+"px",p.style.left=Math.round(25*iScreenScale+10)+"px",p.style.backgroundColor=iTeamPlay?"blue":"#063",p.style.color=primaryColor;var u=new Array,d=new Array;for(l=0;l<h[3].length;l++){var t=h[3][l],n=document.createElement("tr");d[l]=new Array,t[0]==identifiant?(n.style.backgroundColor=rankingColor(oPlayers[0].team),document.getElementById("infoPlace0").innerHTML=l+1,document.getElementById("infoPlace0").style.visibility="visible"):1==t[4]&&(n.style.backgroundColor="red"),(o=document.createElement("td")).innerHTML=toPlace(l+1),d[l][0]=document.createElement("td"),d[l][0].innerHTML=t[1],d[l][1]=document.createElement("td"),d[l][1].innerHTML=t[2];var a=document.createElement("small");a.innerHTML=(t[3]<0?"":"+")+t[3],n.appendChild(o),n.appendChild(d[l][0]),d[l][1].appendChild(a),n.appendChild(d[l][1]),p.appendChild(n),u[l]=n}var o,n=document.createElement("tr");(o=document.createElement("td")).setAttribute("colspan",3);var m=document.createElement("input");m.type="button",m.value=toLanguage("CONTINUE","CONTINUER"),m.style.width="100%",m.style.height="100%",m.style.fontSize=3*iScreenScale+"pt";var i=!0;function r(){p.style.display="none";for(var e=0;e<h[3].length;e++)h[3][e][2]+=h[3][e][3];var t,n=h[3].length-1;for(e=0;e<n;e++){for(var a=0,o=0,i=e;i<h[3].length;i++)h[3][i][2]>=a&&(a=h[3][i][2],o=i);var r=h[3][e];h[3][e]=h[3][o],h[3][o]=r}for(e=0;e<d.length;e++){var l=h[3][e];d[e][0].innerHTML=toPerso(l[1]),d[e][1].innerHTML=l[2],l[0]==identifiant?u[e].style.backgroundColor=rankingColor(oPlayers[0].team):1==l[4]?u[e].style.backgroundColor="red":u[e].style.backgroundColor=""}if(iTeamPlay&&shareLink.options&&shareLink.options.localScore){for(var s=[0,0],e=0;e<h[3].length;e++)s[h[3][e][4]]+=h[3][e][2];t=createTeamTable(s)}var c=!0;setTimeout(function(){p.style.display="",t&&(t.style.visibility="visible"),isChatting()||m.focus()},500),setTimeout(function(){c&&continuer()},5e3),m.onclick=function(){c=!1,continuer()}}m.onclick=function(){i=!1,r()},setTimeout(function(){i&&r()},5e3),o.appendChild(m),n.appendChild(o),p.appendChild(n),p.style.display="",isChatting()||m.focus(),document.onkeydown=void 0,document.onkeyup=void 0,document.onmousedown=void 0,window.onbeforeunload=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,supprArme(0),(bMusic||iSfx)&&startEndMusic(),finishing=!0,document.getElementById("racecountdown").innerHTML=h[4]-("BB"==course?6:5),document.getElementById("waitrace").style.visibility="visible",dRest(),document.getElementById("compteur0").innerHTML="",document.getElementById("roulette0").innerHTML="",document.getElementById("scroller0").style.visibility="hidden";e=document.getElementById("lakitu0");e&&(e.style.display="none")}if(refreshDatas=!1,"BB"==course){for(var A=h[3][0][0],R=h[3][0][4],l=0;l<aKarts.length;l++){var N=aKarts[l];if(iTeamPlay?N.team!=R:N.id!=A){if(N.ballons.length&&!N.tourne){do{H=N.ballons.length-1}while(N.ballons[H][0].suppr(),N.ballons.pop(),N.ballons.length);N.spin(20),N!=oPlayers[0]&&playDistSound(N,"musics/events/spin.mp3","BB"==course?80:50)}}else N!=oPlayers[0]&&(N.loose=!0)}setTimeout(O,1e3)}else O()}}else iDeco(),interruptGame()}).catch(function(e){if(console.error(e),!refreshDatas){refreshDatas=!0;for(var t=p.length-1;0<=t;t--)syncItems.unshift(p[t])}}),refreshDatas=!1}function resetFall(e){delete e.aX,delete e.aY,delete e.aRotation;for(var t=0;t<oPlayers.length;t++)e==oPlayers[t]&&(oContainers[t].style.opacity=1),e.sprite[t].img.style.display="block"}function loseBall(e){var t;"BB"==course&&(t=aKarts[e].ballons.length-1,!aKarts[e].tourne&&aKarts[e].ballons[t]&&(aKarts[e].ballons[t][0].suppr(),aKarts[e].ballons.pop(),aKarts[e].cpu||(clLocalVars.lostBalloons++,updateChallengeHud("balloons",clLocalVars.lostBalloons)),!isOnline||e||aKarts[e].ballons.length||(supprArme(e),document.getElementById("infoPlace0").style.visibility="hidden")))}function showTimer(e){for(var t=timeStr(e),n=0;n<strPlayer.length;n++)document.getElementById("temps"+n).innerHTML=t}function move(e,t){var n=aKarts[e];collisionTest=COL_KART,collisionTeam=-1==(collisionPlayer=n).team?void 0:n.team,clLocalVars.currentKart=n;n=aKarts[e];if(e<strPlayer.length&&(n.cpu||finishing?n.tours==oMap.tours+1&&(n.changeView||(n.changeView=0),n.changeView<180&&(n.changeView+=15),n.progressiveView=!0):(showTimer(timer*SPF),e||timer++,n.time&&(n.time--,n.time&&!oPlayers[e].changeView?document.getElementById("lakitu"+e).style.display="block":document.getElementById("lakitu"+e).style.display="none",oLapTimeDiv&&n.time<25&&(n.time<5?(oContainers[0].removeChild(oLapTimeDiv),oLapTimeDiv=void 0):oLapTimeDiv.style.visibility=n.time%6<4?"visible":"hidden")))),n.tombe){if(n.tombe--,updateDriftSize(e),n.size=1,n.mini=0,19==n.tombe){for(var a=0;a<strPlayer.length;a++){if(n.sprite[a].img.style.display="none",n.sprite[a].img.style.opacity="",n.sprite[a].div.style.backgroundImage="","BB"==course)for(var o=0;o<n.ballons.length;o++)n.ballons[o][a].img.style.display="none";n.marker&&(n.marker.div[a].style.display="none")}playIfShould(n,"musics/events/rescue.mp3")}else if(2==n.tombe){if("BB"==course)for(a=0;a<strPlayer.length;a++)for(o=0;o<n.ballons.length;o++)n.ballons[o][a].img.style.display="block"}else if(!n.tombe&&(resetFall(n),loseBall(e),"BB"==course)){if(n.cpu&&1==n.ballons.length&&(!isOnline||n.controller==identifiant)){var i=1+Math.round(Math.random());for(a=0;a<i&&n.reserve;a++)addNewBalloon(n),n.reserve--}if(!n.ballons.length&&!n.loose)for(a=0;a<strPlayer.length;a++)n.sprite[a].div.style.opacity=1}}else{if(n.rotincdir?(n.rotinc+=2*n.rotincdir,n.driftinc&&0<n.driftinc!=0<n.rotincdir&&(u=Math.max(1.1,1.6-Math.max(0,(n.driftcpt-20)/80)),0<n.driftinc?n.rotinc=Math.max(n.rotinc,-u):n.rotinc=Math.min(n.rotinc,u))):n.rotinc<0?n.rotinc=Math.min(0,n.rotinc+1):0<n.rotinc&&(n.rotinc=Math.max(0,n.rotinc-1)),handleDriftCpt(e),n.cpu?(n.rotinc=Math.min(n.rotinc,fMaxRotInCp),n.rotinc=Math.max(n.rotinc,-fMaxRotInCp)):(n.rotinc=Math.min(n.rotinc,fMaxRotInc),n.rotinc=Math.max(n.rotinc,-fMaxRotInc)),n.shift&&(n.rotation+=180*n.shift[2]/Math.PI),n.tourne){if(n.figuring=!1,n.figstate=0,n.z||(n.speed=(n.speed-Math.max(0,n.speedinc+.1))/1.5),n.tourne-=2,!n.tourne&&"BB"==course){if(n.cpu&&1==n.ballons.length&&(!isOnline||n.controller==identifiant)){i=1+Math.round(Math.random());for(a=0;a<i&&n.reserve;a++)addNewBalloon(n),n.reserve--}if(!n.ballons.length&&!n.loose)for(a=0;a<strPlayer.length;a++)n.sprite[a].div.style.opacity=1}}else n.figstate?(n.figstate-=1+Math.round(.5*(11-Math.abs(11-n.figstate))),n.figstate<0&&(n.figstate=0),!n.figuring&&n.figstate<8&&(n.figuring=!0,n==oPlayers[0]&&(clLocalVars.stunts++,clSelected&&clRuleVars[clSelected.id]&&(j=clRuleVars[clSelected.id].stunts)&&updateChallengeHud("stunts",j.stunts+clLocalVars.stunts)))):!n.speed||n.billball||n.cannon||(n.rotation+=(n.rotinc+1.5*(n.driftinc||0))*(n.speedinc<0||0==n.speedinc&&n.speed<0?-1:1)*Math.abs(Math.cos(angleDrift(n)*Math.PI/180))),n.frminv&&n.frminv--;n.rotation<0&&(n.rotation+=360),360<n.rotation&&(n.rotation-=360),kartIsPlayer(n)&&(!clLocalVars.startedAt&&1<n.speed&&(clLocalVars.startedAt=timer),clLocalVars.forwards||0<n.speed&&(0<n.speedinc||n.turbodrift)&&(clLocalVars.forwards=!0));var r=n.maxspeed*n.size;n.speed>r&&(n.speed=r),n.speed<-r/4&&(n.speed=-r/4);var l,s,c,p,u=kartInstantSpeed(n),d=u[0],m=u[1],r=n.x+d,u=n.y+m,h=n.x,y=n.y;if(n.z||n.heightinc?(n.z+=.7*n.heightinc*Math.abs(n.heightinc),n.heightinc-=.5,n.z<=0&&(n.heightinc=0,n.z=0,delete n.jumped,kartIsPlayer(n)&&n.driftinc&&(document.getElementById("drift"+e).style.display="block",carDrift&&!n.driftSound&&(carDrift.currentTime=0,carDrift.play(),n.driftSound=carDrift))),n.driftinc&&(document.getElementById("drift"+e).style.top=Math.round(iScreenScale*(32-correctZ(n.z))+(n.sprite[e].h-32)*fSpriteScale*.15)+"px")):(n.speed+=n.speedinc,(isCup&&22!=oMap.skin&&30!=oMap.skin||!isCup&&oMap.smartjump)&&n.cpu&&(tombe(r,u)&&!sauts(h,y,d,m)||(R=ralenti(r,u))&&(V=getOffroadProps(n,R))&&n.speed-1.01*n.speedinc>V.speed&&!n.protect&&!n.champi)&&(n.z=1,n.heightinc=.5,n.jumped=!0)),(!e||!isOnline||n.controller==identifiant||finishing)&&!n.loose){var g=n.using;if(n.tourne){g=[];for(a=0;a<aKarts.length;a++)g=g.concat(aKarts[a].using)}var f=touche_bobomb(r,u,g)+touche_cbleue(r,u);if(!f||n.tourne||n.protect||n.fell){if(n.z<5){if(!(touche_fauxobjet(r,u,g)||touche_cverte(r,u,g)||touche_cverte(n.x,n.y,g)||touche_crouge(n.x,n.y,g))||n.protect||n.frminv)if(!touche_banane(r,u,g)||n.protect||n.frminv)if(!touche_poison(r,u,g)||n.protect||n.frminv){if(touche_champi(r,u)&&!n.tourne)n.champi=20,n.maxspeed=11,n.speed=11,playIfShould(n,"musics/events/boost.mp3");else if(!n.tourne&&n.z<1.2){var S=!n.protect&&!n.frminv,v=touche_asset(h,y,r,u),b=!0,M=!1;if(v){var x=v[1][0].src;switch(v[0]){case"oils":S&&.5<Math.abs(n.speed)&&!n.tourne&&(stopDrifting(e),loseBall(e),n.spin(20)),b=!1;break;case"pointers":x="assets/pivothand",S?(stopDrifting(e),loseBall(e),n.spin(42),n.cpu&&(n.frminv=16)):b=!1;break;case"flippers":S&&(stopDrifting(e),loseBall(e),n.spin(42)),n.speed*=-1;var C=8;switch(v[1][3][0]){case 1:C=12;break;case 2:C=4}n.shift=[-C*direction(0,n.rotation),-C*direction(1,n.rotation),0];break;case"bumpers":S=!1,n.speed*=-1;var C=8,P=d,k=m,w=v[1];w[3]&&(P+=w[3][0]*Math.sin(w[3][1])*w[2][5],k-=w[3][0]*Math.cos(w[3][1])*w[2][5]);var I=h+P,T=y+k,E=h-w[1][0],L=y-w[1][1],w=Math.hypot(E,L),E=E/w,L=L/w,w=P*E+k*L,P=h+2*(I-w*E-h)-I,k=y+2*(T-w*L-y)-T,L=Math.hypot(P,k);n.shift=L?[C*P/L,C*k/L,0]:[-C*direction(0,rotation),-C*direction(1,rotation),0],n.cpu&&(n.bounced=!0,n.bouncedsince=0);break;case"flowers":M=!(S=b=!1)}b&&(M=!0,stopDrifting(e),r=h,u=y,n.collideSound||(n.collideSound=playIfShould(n,"musics/events/collide.mp3"),n.collideSound&&(n.collideSound.onended=function(){n.collideSound=void 0,document.body.removeChild(this)}))),S&&(M=!0,loseUsingItem(n)),M&&clLocalVars.decorsHit&&!n.cpu&&(clLocalVars.decorsHit[x]=!0)}}}else loseBall(e),stopDrifting(e),n.spin(20),loseUsingItems(n),n.size=.6,n.mini=Math.max(n.mini,60),updateDriftSize(e);else loseBall(e),stopDrifting(e),n.spin(20),loseUsingItem(n);else loseBall(e),stopDrifting(e),n.spin(42),loseUsingItem(n);if(!n.cpu)for(;touche_piece(n.x,n.y);)clLocalVars.nbCoins++,updateChallengeHud("coins",clLocalVars.nbCoins),challengeCheck("each_coin"),playIfShould(n,"musics/events/coin.mp3")}}else loseBall(e),n.spin(f),loseUsingItems(n),stopDrifting(e),84<=f&&(n.champi=0,n.speed=0,n.heightinc=3,supprArme(aKarts.indexOf(n)))}if(objet(r,u)){if(n.destroySound||(n.destroySound=playDistSound(n,"musics/events/item_destroy.mp3",80),n.destroySound&&(n.destroySound.onended=function(){n.destroySound=void 0,document.body.removeChild(this)})),!n.arme&&(n.tours<=oMap.tours||"BB"==course)&&!n.billball&&!finishing){if("BB"!=course){l=randObj(n);var B={};1==n.tours&&getCpScore(n)<=getCpDiff(n)/2&&(B.carapacebleue=1,B.eclair=1,B.bloops=1,B.carapaceX3=1,B.carapacerougeX3=1),1==n.place&&(B.carapacebleue=1);for(var z={carapacebleue:1,eclair:1,bloops:1,bananeX3:1},a=0;a<aKarts.length;a++)z[aKarts[a].arme]&&(B[aKarts[a].arme]=1);if(items["carapace-bleue"].length&&(B.carapacebleue=1),(n.place<aKarts.length||items.eclair.length)&&(B.eclair=1),items.bloops.length&&(B.bloops=1),B[l]&&otherObjects(n,B))for(;l=randObj(n),B[l];);}else l=n.ballons.length?randObj(n):(s=["fauxobjet","banane","carapace","bobomb"])[Math.floor(Math.random()*s.length)];n.arme=l,shouldPlaySound(n)&&(n.rouletteSound=playSoundEffect("musics/events/roulette.mp3")),kartIsPlayer(n)&&(H=(f=document.getElementById("scroller"+e).getElementsByTagName("div")[0]).offsetHeight,s=7*iScreenScale,f.dataset||(f.dataset={}),f.dataset.h=H,f.dataset.s=s,document.getElementById("scroller"+e).getElementsByTagName("div")[0].style.top=-Math.floor(Math.random()*H)+"px",document.getElementById("scroller"+e).style.visibility="visible",clLocalVars.itemsGot=!0)}clLocalVars.itemsHit&&!n.cpu&&(clLocalVars.itemsHit[touchedObject]||(clLocalVars.itemsHit[touchedObject]=!0,clLocalVars.nbItems++,updateChallengeHud("items",clLocalVars.nbItems),challengeCheck("each_item")))}if(n.arme&&25!=n.roulette&&(n.roulette++,25<=n.roulette&&(n.roulette=25,kartIsPlayer(n)&&(updateObjHud(e),n.rouletteSound&&(removeIfExists(n.rouletteSound),playSoundEffect("musics/events/gotitem.mp3"),n.rouletteSound=void 0)))),collisionDecor=null,n.cannon||canMoveTo(h,y,n.z,d,m,n.protect))n.x=r,n.y=u,n.cpu&&delete n.collided;else{n.collideSound||(n.collideSound=playIfShould(n,"musics/events/collide.mp3"),n.collideSound&&(n.collideSound.onended=function(){n.collideSound=void 0,document.body.removeChild(this)}));var D=getHorizontality(h,y,d,m);n.cpu&&(n.collided=!0,n.horizontality=D);var H=r-n.x,O=u-n.y,A=H*D[0]+O*D[1];n.speed>n.speedinc&&(n.speed=Math.min(.75*n.speed,n.speed+.5-n.speedinc)),!collisionDecor&&3<n.speed&&5<=n.driftcpt&&n.driftcpt<fTurboDriftCpt2&&(n.driftcpt<fTurboDriftCpt||n.driftcpt>=fTurboDriftCpt+5)&&(n.driftcpt-=5);for(a=5;0<a&&(n.x+=D[0]*A*a/5,n.y+=D[1]*A*a/5,!canMoveTo(h,y,n.z,n.x-h,n.y-y,n.protect));a--)n.x=h,n.y=y;n.speedinc<=0&&(n.speed=Math.hypot(n.x-h,n.y-y))}if(collisionDecor&&(clLocalVars.decorsHit&&!n.cpu&&(clLocalVars.decorsHit[collisionDecor]=!0),!(F=decorBehaviors[collisionDecor].spin)||n.tourne||n.protect||n.frminv||(O=decorBehaviors[collisionDecor].minSpeedToSpin||2.5,Math.abs(n.speed)>O&&(loseBall(e),stopDrifting(e),n.spin(F),n.frminv=24,n.speed=2.5*Math.sign(n.speed),loseUsingItems(n)))),n.speedinc||(n.speed*=n.sliding?.95:.9),n.sliding=void 0,!n.z){n.heightinc||(n.ctrled=!1,n.fell=!1),n.figuring&&(n.turbodrift=15,n.turbodrift0=n.turbodrift,n.driftcpt=0);var R,N,V,F=sauts(h,y,d,m);if(F&&!n.tourne)n.heightinc=1.5*F,n.speed=11,n.figuring=!1,n.figstate=0,n.bounceSound||(n.bounceSound=playIfShould(n,"musics/events/jump.mp3"),n.bounceSound&&(n.bounceSound.onended=function(){n.bounceSound=void 0,document.body.removeChild(this)}));else{if(isOnline&&e&&n.controller!=identifiant||(N=tombe(n.x,n.y,oMap.checkpoint&&n.demitours?oMap.checkpoint[n.demitours+1!=oMap.checkpoint.length?n.demitours+1:0][3]:0)),N){1==N?isBattle&&simplified?(N=[n.x,n.y,n.rotation],n.x>oMap.w-1?(N[0]=oMap.w-50,n.y>oMap.h-1?(N[1]=oMap.h-50,N[2]=225):n.y<0?(N[1]=50,N[2]=315):(N[1]=n.y-n.y%100+50,N[2]=270)):n.y>oMap.h-1?(N[1]=oMap.h-50,n.x<0?(N[0]=50,N[2]=135):(N[0]=n.x-n.x%100+50,N[2]=180)):n.x<0?(N[0]=50,n.y<0?(N[1]=50,N[2]=45):(N[1]=n.y-n.y%100+50,N[2]=90)):(N[1]=50,N[0]=n.x-n.x%100+50,N[2]=0)):N=oMap.startposition[0]:isNaN(N[0])&&(N=oMap.startposition[(n.initialPlace-1)%oMap.startposition.length]),n.aX=n.x,n.aY=n.y,n.aRotation=n.rotation,n.x=N[0],n.y=N[1],n.rotation=90*N[2],n.speed=0,n.protect=!1,n.figuring=!1,n.figstate=0,n.fell=!0,n.champi=0,n.cpu&&(n.aipoint=void 0),n.tombe=20,n.frminv=10,n.ctrled=!0,n.z=10,n.tourne=0,stopDrifting(e),supprArme(e),deleteUsingItems(n);for(var j,a=0;a<oPlayers.length;a++)n.sprite[a].img.style.display="none",n.sprite[a].div.style.backgroundImage="",n.etoile&&(n.sprite[a].img.src=getSpriteSrc(n.personnage));resetPowerup(n),n.cpu||(clLocalVars.falls++,clSelected&&clRuleVars[clSelected.id]&&(j=clRuleVars[clSelected.id].falls)&&updateChallengeHud("falls",clLocalVars.falls+j.falls)),playIfShould(n,"musics/events/fall.mp3")}else n.protect||n.champi||n.figuring||!(1.5<n.speed)||n.turbodrift>.8*n.turbodrift0||!(R=ralenti(r,u))||((V=getOffroadProps(n,R)).sliding&&(n.sliding=V.sliding),n.speed>V.speed&&(n.speed=V.speed),stopDrifting(e)),n.tourne||(c=flowShift(r,u,n.protect)),c&&n.cpu&&100<=c[0]*c[0]+c[1]*c[1]&&(d+c[0])*d+(m+c[1])*m<0&&(n.collided=!0,n.horizontality=[c[1],-c[0]]);n.figuring=!1,n.figstate=0}if(c){n.shift||(n.shift=[0,0,0]);for(a=0;a<3;a++)n.shift[a]=.7*n.shift[a]+.3*c[a];n.shift[0]*n.shift[0]+n.shift[1]*n.shift[1]+300*n.shift[2]*n.shift[2]<.01&&delete n.shift}else delete n.shift}if(n.cannon||($=inCannon(n.x,n.y))&&($[0]||$[1])&&(stopDrifting(e),n.cannon=[n.x+$[0],n.y+$[1],n.x,n.y],n.protect=!0,n.jumped=!0,n.tourne&&(n.tourne=2),delete n.shift,n.boostSound||(n.boostSound=playIfShould(n,"musics/events/boost.mp3"),n.boostSound&&(n.boostSound.onended=function(){n.boostSound=void 0,document.body.removeChild(this)}))),n.using.length){var _=0,W=5,K=360/n.using.length,G="banane"===n.using[0].type;void 0!==n.rotitem&&(_=n.rotitem,W=G?4:4.5,t||(n.rotitem-=30));for(a=0;a<n.using.length;a++){var q=n.using[a];G?(q.x=n.x-W*(.7+.35*(n.using.length-a))*direction(0,n.rotation),q.y=n.y-W*(.7+.35*(n.using.length-a))*direction(1,n.rotation)):(q.x=n.x-W*direction(0,n.rotation+_+a*K),q.y=n.y-W*direction(1,n.rotation+_+a*K)),q.z=n.z}}else delete n.rotitem;if("BB"!=course){if(checkpoint(n,d,m)){var U=aKarts.length;n.demitours=getNextCp(n),n.tours++;var $=oMap.checkpoint[0];oMap.sections&&($=oMap.checkpoint[oMap.checkpoint.length-1]),t=$[3]?(J=y<$[1]?$[1]-y:y-$[1]-15,m):(J=h<$[0]?$[0]-h:h-$[0]-15,d);$=J/Math.abs(t),$=Math.max(0,Math.min($,1));isNaN($-$)&&($=.5);var J=Math.round((timer+$-1)*SPF);if(n==oPlayers[0]&&!n.cpu){for(var X=0,a=0;a<lapTimers.length;a++)X+=lapTimers[a];lapTimers.push(J-X)}if(n.tours==oMap.tours+1){for(a=n.place=0;a<U;a++)aKarts[a].tours>oMap.tours&&n.place++;if(kartIsPlayer(n)&&!finishing){for(showTimer(timerMS=J),"CM"!=course&&(document.getElementById("infoPlace"+e).innerHTML=n.place);n.using.length;){var Y=bMusic,Q=iSfx;iSfx=bMusic=!1,arme(e),bMusic=Y,iSfx=Q}if(n.arme=!1,stopDrifting(e),supprArme(e),n.cpu=!0,n.aipoint=0,n.lastAItime=0,n.maxspeed=5.7,!oPlayers[1-e]||oPlayers[1-e].cpu){if(isOnline){var Z=document.getElementById("infos0");Z.style.left=15*iScreenScale+"px",Z.innerHTML="";t=document.createElement("tr"),$=document.createElement("td");$.style.fontSize=8*iScreenScale+"px",$.style.color="#F80",$.innerHTML=toLanguage("&nbsp; &nbsp; FINISH !","TERMIN&Eacute; !"),t.appendChild($);J=document.createElement("tr"),$=document.createElement("td");$.style.fontSize=Math.round(4.5*iScreenScale+10)+"px",$.style.color="#FF0",$.innerHTML=toLanguage("&nbsp; &nbsp; &nbsp; Please wait...","Veuillez patienter..."),J.appendChild($),Z.appendChild(t),Z.appendChild(J),Z.style.display="",document.getElementById("infoPlace0").style.visibility="hidden",finishing=!0}else{if("CM"!=course){for(a=0;a<U;a++)places(a,!0);var ee=aKarts.slice(0);ee.sort(function(e,t){return e.place-t.place});for(a=0;a<U;a++)ee[a].place=a+1;aPlaces=new Array;for(a=0;a<U;a++)aPlaces[a]=aKarts[a].place;for(var te='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",ne=Math.round(1.25*aKarts.length),a=0;a<U;a++)for(o=0;o<U;o++){var ae,oe=aKarts[o].personnage;aKarts[o].place==a+1&&(ve=1==aKarts[o].team?1:0,ae=(aKarts.length-a-1)/(aKarts.length-1),be=Math.round(ne*(Math.exp(ae)-1)/(Math.E-1)),12==aKarts.length&&(be=[15,12,10,8,7,6,5,4,3,2,1,0][a]),te+='<tr id="fJ'+a+'" style="background-color: '+(o<strPlayer.length?o?ve?"brown":"navy":rankingColor(aKarts[o].team):ve?"red":"transparent")+'"><td>'+toPlace(a+1)+' </td><td class="maj" id="j'+a+'">'+toPerso(oe)+'</td><td id="pts'+a+'">'+aScores[o]+"<small>+"+be+"</small></td></tr>",aScores[o]+=be,o=U)}te+='<tr><td colspan="3" id="continuer"></td></tr>',document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color=primaryColor,document.getElementById("infos0").innerHTML=te,(ge=document.createElement("input")).type="button",ge.id="octn",ge.value=toLanguage("CONTINUE","CONTINUER"),ge.style.width="100%",ge.style.height="100%",ge.style.fontSize=3*iScreenScale+"pt",ge.onclick=classement,document.getElementById("continuer").appendChild(ge),document.getElementById("infos0").style.display="";var ie=document.body.scrollTop;ge.focus(),document.body.scrollTop=ie}else{document.getElementById("infos0").style.fontSize=5*iScreenScale+"px",document.getElementById("infos0").style.fontWeight="bold",document.getElementById("infos0").style.color="white";var re=Math.ceil(iScreenScale/4)+"px";sShadow="-"+re+" 0 "+(me="black")+", 0 "+re+" "+me+", "+re+" 0 "+me+", 0 -"+re+" "+me;for(var le="",se=lapTimers[0],a=1;a<lapTimers.length;a++)se=Math.min(se,lapTimers[a]);for(a=0;a<lapTimers.length;a++){var ce="-"+(re=Math.ceil(iScreenScale/8)+"px")+" 0 "+(me=lapTimers[a]==se?"#e99c00":"black")+", 0 "+re+" "+me+", "+re+" 0 "+me+", 0 -"+re+" "+me;le+='<div style="color:'+(lapTimers[a]==se?"#fffdbe":"#DDD")+";text-shadow:"+ce+'">'+(a+1)+". "+timeStr(lapTimers[a])+"</div>"}document.getElementById("infos0").style.top=7*iScreenScale+10+"px",document.getElementById("infos0").innerHTML='<tr><td style="text-decoration: blink;font-family:Courier New;font-size:'+Math.round(4*iScreenScale)+"px;text-shadow:"+sShadow+'">'+document.getElementById("temps0").innerHTML+'</td></tr><tr><td id="continuer"></td></tr><tr><td style="padding-top:'+iScreenScale+";font-size:"+Math.round(2.5*iScreenScale)+'px">'+le+"</td></tr>",document.getElementById("infos0").style.display="",(ge=document.createElement("input")).type="button",ge.id="octn",ge.value=toLanguage("CONTINUE","CONTINUER"),ge.style.width="100%",ge.style.height="100%",ge.style.fontSize=3*iScreenScale+"pt",ge.onclick=function(){document.getElementById("infos0").style.display="none";var e=document.createElement("div");e.style.color="black",e.style.position="absolute",e.style.left=5*iScreenScale+10+"px",e.style.top=5*iScreenScale+10+"px",e.style.fontSize=4*iScreenScale+"pt",e.style.backgroundColor="#FF6",e.style.opacity=.8,e.style.border="double 4px black",e.style.textAlign="center",e.style.width=70*iScreenScale-10+"px",e.style.height=25*iScreenScale-10+"px",e.style.zIndex=2e4;var t=document.createElement("p");t.innerHTML=toLanguage('Save the time to the <a href="classement.php" target="_blank" style="color: orange">record list</a> ?','Enregistrer le temps dans la <a href="'+rankingsLink(oMap)+'" target="_blank" style="color: orange">liste des records</a> ?'),t.style.margin=iScreenScale+"px";var n=t.cloneNode(!1),a=document.createElement("input");a.type="button",a.value="  "+toLanguage("Yes","Oui")+"  ",a.style.marginRight=iScreenScale+"px",a.style.fontSize=4*iScreenScale+"px",a.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",o.style.fontSize=4*iScreenScale+"px"},a.onclick=function(){$mkScreen.removeChild(e),continuer(),document.getElementById("enregistrer").getElementsByTagName("input")[0].onclick()},n.appendChild(a);var o=document.createElement("input");o.type="button",o.value="  "+toLanguage("No","Non")+"  ",o.style.fontSize=4*iScreenScale+"px",o.style.marginLeft=iScreenScale+"px",o.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",a.style.fontSize=4*iScreenScale+"px"},o.onclick=function(){$mkScreen.removeChild(e),document.getElementById("infos0").style.display="",continuer()},n.appendChild(o),e.appendChild(t),e.appendChild(n),$mkScreen.appendChild(e),("MK"==page&&gRecord<=timerMS?o:a).focus()},document.getElementById("continuer").appendChild(ge),document.getElementById("infos0").style.display="",ge.focus()}handleEndRace()}document.onkeydown=void 0,document.onkeyup=void 0,document.onmousedown=void 0,window.onbeforeunload=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0}}oMap.sections&&1<n.billball&&(n.billball=1)}else if(!(isOnline?e||finishing:n.cpu)){for(var pe=document.querySelectorAll("#compteur"+e+" .tour"),a=0;a<pe.length;a++)pe[a].innerHTML=n.tours;if(document.getElementById("lakitu"+e).getElementsByTagName("div")[0].innerHTML=(oMap.sections?"Sec":toLanguage("Lap","Tour"))+"<small>&nbsp;</small>"+n.tours,n.time=40,bMusic||iSfx)if(n.tours==oMap.tours){for(var ue,de=!0,a=0;a<oPlayers.length;a++)if(oPlayers[a]!=n&&3<=oPlayers[a].tours){de=!1;break}de&&(ue=postStartMusic("musics/events/lastlap.mp3"),iSfx&&(fadeOutMusic(carEngine,1,.6,-1),fadeOutMusic(carEngine2,1,.6,-1)),ue.removeAttribute("loop"),setTimeout(function(){bMusic&&(document.body.contains(ue)?(document.body.removeChild(ue),startMapMusic(!0)):fastenMusic(mapMusic)),iSfx&&(carEngine.volume=1,carEngine2.volume=1)},2700))}else iSfx&&playSoundEffect("musics/events/nextlap.mp3");if("CM"==course){oLapTimeDiv&&oContainers[0].removeChild(oLapTimeDiv),(oLapTimeDiv=document.createElement("div")).style.position="absolute",oLapTimeDiv.style.zIndex=2e4,oLapTimeDiv.style.left=Math.round(iScreenScale*iWidth/2)+"px",oLapTimeDiv.style.top=Math.round(iScreenScale*iHeight/2)+"px",oLapTimeDiv.style.textAlign="center",oLapTimeDiv.style.transform=oLapTimeDiv.style.WebkitTransform=oLapTimeDiv.style.MozTransform="translate(-50%, -100%)";Z=document.createElement("div");Z.className="lap-time",Z.innerHTML=timeStr(lapTimers[lapTimers.length-1]),Z.style.fontSize=4*iScreenScale+"px",Z.style.fontFamily="Courier New",Z.style.color="#DDD";var re=Math.ceil(iScreenScale/4)+"px",me="black";if(Z.style.textShadow="-"+re+" 0 "+me+", 0 "+re+" "+me+", "+re+" 0 "+me+", 0 -"+re+" "+me,oLapTimeDiv.appendChild(Z),iLapTimes){for(var he=0,a=0;a<lapTimers.length;a++)he+=lapTimers[a]-iLapTimes[a];Z=document.createElement("div");Z.innerHTML=(0<=he?"+":"-")+" "+timeStr(Math.abs(he)),Z.style.fontSize=Math.round(2.5*iScreenScale)+"px",Z.style.fontFamily="Courier New",Z.style.color=0<=he?"#FDD":"#DFD",re=Math.ceil(iScreenScale/8)+"px",me=0<=he?"#C00":"#0A0",Z.style.textShadow="-"+re+" 0 "+me+", 0 "+re+" "+me+", "+re+" 0 "+me+", 0 -"+re+" "+me,oLapTimeDiv.appendChild(Z)}oContainers[0].appendChild(oLapTimeDiv)}}}}else if(!isOnline){if(!oPlayers[0].loose||oPlayers[1]&&!oPlayers[1].loose)if(iTeamPlay){var ye=[!1,!1];for(a=0;a<aKarts.length;a++)aKarts[a].loose||(aKarts[a].cpu||(p=aKarts[a]),ye[aKarts[a].team]=!0);ye[0]&&ye[1]&&(p=void 0)}else{ye=!1;for(a=0;a<aKarts.length;a++)aKarts[a].loose||(ye?(p=void 0,a=aKarts[a].length):(ye=!0,p=aKarts[a]))}else{for(;p=aKarts[Math.floor(Math.random()*(aKarts.length-strPlayer.length))+strPlayer.length],p.loose;);for(a=strPlayer.length;a<aKarts.length;a++)aKarts[a].loose=!0}if(p){for(clLocalVars.gagnant=p,a=0;a<strPlayer.length;a++)stopDrifting(a),supprArme(a);for(var ge,te='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",fe="",Se=1,a=0;a<aKarts.length;a++){var ve=1==aKarts[a].team?1:0,be=aKarts[a]==p,oe=aKarts[a].personnage,Me=be?0:Se,Me='<tr id="fJ'+Me+'" style="background-color:'+(a<strPlayer.length?a?ve?"brown":"navy":rankingColor(aKarts[a].team):ve?"red":"transparent")+'"><td>'+toPlace(Me+1)+' </td><td class="maj" id="j'+Me+'">'+toPerso(oe)+'</td><td id="pts'+Me+'">'+aScores[a]+(be?"<small>+1</small>":"")+"</td></tr>";be?fe=Me+fe:(fe+=Me,Se++),aScores[a]+=be}te+=fe,te+='<tr><td colspan="3" id="continuer"></td></tr>',document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color=primaryColor,document.getElementById("infos0").innerHTML=te,(ge=document.createElement("input")).type="button",ge.id="octn",ge.value=toLanguage("CONTINUE","CONTINUER"),ge.style.width="100%",ge.style.height="100%",ge.style.fontSize=3*iScreenScale+"pt",ge.onclick=classement,document.getElementById("continuer").appendChild(ge),document.getElementById("infos0").style.display="";ie=document.body.scrollTop;for(ge.focus(),document.body.scrollTop=ie,a=0;a<aKarts.length;a++)aKarts[a].loose=!0;handleEndRace(),document.onkeydown=void 0,document.onkeyup=void 0,document.onmousedown=void 0,window.onbeforeunload=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0}}if(n.cpu)if("BB"==course)n.maxspeed=5.7;else{var xe=oPlayers[0].place,Ce=oPlayers.length,Pe=aKarts.length-1-Ce,ke=e-Ce,we=aKarts[Ce];if(isOnline){Pe=-1,we=null;for(a=ke=Ce=0;a<aKarts.length;a++)aKarts[a].controller?(a<e&&ke++,we=we||aKarts[a],Pe++):(Ce++,aKarts[a].place<xe&&(xe=aKarts[a].place))}var ie=iDificulty,Ie=1;0<Pe&&(we.place<n.place&&we.place<xe?((Te=n.distToFirstCache)?(n.distToFirstTtl--,n.distToFirstTtl<=0&&(n.distToFirstCache=0)):(Te=distanceToKart(n,we),n.distToFirstCache=Te,n.distToFirstTtl=15+Math.floor(15*Math.random())),ke=1/(1+Te/(42*Pe))*(1+ke)-1):n.distToFirstCache=0,Ie=Math.pow(.96,6*(ke/Pe-.5))),ie*=Ie*iDificulty/5;var Te=1.25;4.75<iDificulty&&8<aKarts.length&&(Te*=Math.log(1+100*aKarts.length/8)/5.5),n.maxspeed>ie*Te?n.maxspeed=ie*Te:n.maxspeed<ie&&(n.maxspeed=ie),n.place<=xe?n.maxspeed-=(n.maxspeed*Ie-ie*n.size)/100:n.maxspeed+=(ie*Te*1.12*n.size-n.maxspeed*Ie)/100}else n.maxspeed=5.4*n.stats.speed;if(n.turbodrift&&(Ie=8,15<n.turbodrift&&(Ie+=Math.pow(2*(n.turbodrift-15)/15,2),n.turbodrift--,n.turbodrift0--),n.speed>-Ie&&(n.maxspeed=Ie,n.speed=Math.max(Ie,n.speed)),n.turbodrift--),n.champi&&(n.maxspeed=11,n.champi--),n.billball){if(n.z=2,n.heightinc=0,n.speed=11,null!=n.aipoint)(Le=n.aipoints[n.aipoint][0]-n.x)*Le+(Be=n.aipoints[n.aipoint][1]-n.y)*Be<1600&&(n.aipoint++,n.aipoint>=n.aipoints.length&&(n.aipoint=0));else{var Ee=n.demitours+1;Ee>=oMap.checkpoint.length&&(Ee=0);for(var Le=(ze=oMap.checkpoint[Ee])[0]+(ze[3]?Math.round(ze[2]/2):8)-n.x,Be=ze[1]+(ze[3]?8:Math.round(ze[2]/2))-n.y,a=0;a<n.aipoints.length;a++){var ze=n.aipoints[a];if(n.x>ze[0]-35&&n.x<ze[0]+35&&n.y>ze[1]-35&&n.y<ze[1]+35){var De=a+1;De==n.aipoints.length&&(De=0);var I=n.aipoints[De][0],T=n.aipoints[De][1],He=n.rotation*Math.PI/180,Oe=Math.abs(normalizeAngle(Math.atan2(I-n.x,T-n.y)-He,2*Math.PI)),He=Math.abs(normalizeAngle(Math.atan2(Le,Be)-He,2*Math.PI));if(Oe<Math.max(He,Math.PI/4)){n.aipoint=De,Le=I-n.x,Be=T-n.y;break}}}}var Ae=Le*direction(1,n.rotation)-Be*direction(0,n.rotation),Re=Le*direction(0,n.rotation)+Be*direction(1,n.rotation),Ee=Math.atan2(Ae,Re)/Math.PI*180;if(10<Math.abs(Ee)&&(Ee=60<Math.abs(Ee)?(n.speed=1,0<Ee?30:-30):0<Ee?15:-15),n.rotation+=Ee,n.rotation=n.rotation%360,n.billball--,n.billball)!n.billjump&&n.billball<12&&(d=n.speed*direction(0,n.rotation),m=n.speed*direction(1,n.rotation),sauts(n.x,n.y,d,m)&&(n.billball=12,n.billjump=!0));else{for(a=0;a<strPlayer.length;a++)n.sprite[a].img.src=getSpriteSrc(n.personnage),resumeSpriteSize(n.sprite[a]);n.size=1,n.mini=0,n.z=0,updateDriftSize(e),n.jumped=!1,delete n.billjump,updateProtectFlag(n),n.cpu||delete n.aipoint}}if(n.champior&&(n.champior--,n.champior<=0&&(delete n.champior,supprArme(e))),n.etoile&&(n.maxspeed*=1.35,n.etoile--,n.etoile<15)){for(var Ne,a=0;a<strPlayer.length;a++)n.sprite[a].img.src=(n.etoile%2?getStarSrc:getSpriteSrc)(n.personnage);n.etoile||(updateProtectFlag(n),Ne=n.cpu?1:n.stats.acceleration*n.size,n.speedinc=Math.min(n.speedinc,Ne),stopStarMusic(n))}if(n.megachampi&&(n.megachampi--,71<n.megachampi?n.size*=1.05:n.megachampi<8&&(n.size/=1.05,n.megachampi||(updateProtectFlag(n),stopMegaMusic(n))),updateDriftSize(e)),n.mini&&(n.mini--,n.mini<1&&(n.mini=0,isOnline&&e&&n.controller!=identifiant||(n.size=1),updateDriftSize(aKarts.indexOf(n)))),n.cannon&&(n.speed=(3*n.speed+20)/4,n.billball&&(n.speed=20),n.maxspeed=n.speed/n.size,n.speedinc||(n.speedinc=.01),n.z=(3*n.z+4)/4,n.heightinc=0,n.rotinc=0,Ae=n.cannon[2]-n.x,Re=n.cannon[3]-n.y,Ee=n.cannon[0]-n.cannon[2],Ne=n.cannon[1]-n.cannon[3],Ne=Math.hypot(Ee,Ne),(W=Math.hypot(Ae,Re)/Ne)<.2?(Ae=n.cannon[0]-n.x,Re=n.cannon[1]-n.y,n.rotation=nearestAngle(180*Math.atan2(Ae,Re)/Math.PI,n.rotation,360)):Ne-40<=W*Ne&&(Math.abs(n.speedinc)<=.01&&(n.speedinc=0),delete n.cannon,n.fell=!0,updateProtectFlag(n))),!n.z&&accelere(h,y,d,m)&&(n.champi=20,n.maxspeed=11,n.speed=11,n.boostSound||(n.boostSound=playIfShould(n,"musics/events/boost.mp3"),n.boostSound&&(n.boostSound.onended=function(){n.boostSound=void 0,document.body.removeChild(this)}))),!iSfx||n!=oPlayers[0]||finishing||n.cpu||n.loose&&!isOnline||(bMusic&&(n.etoile||n.megachampi)||n.tombe||n.turbodrift||n.turboSound?(updateEngineSound(),n.turbodrift==n.turbodrift0-1&&(carEngine3.currentTime=0,carEngine3.volume=1,carEngine3.play(),n.turboSound=carEngine3,clearTimeout(n.turboHandler),n.turboHandler=setTimeout(function(){n.turboSound&&(n.turboSound.pause(),n.turboSound=void 0)},2e3),n.sparkSound&&(fadeOutMusic(n.sparkSound,1,.8,!1),n.sparkSound=void 0)),bMusic&&n.protect&&n.turboSound&&(n.turboSound.volume=0)):updateEngineSound(3<n.speed?carEngine2:carEngine)),"BB"==course&&!n.ballons.length&&!n.tourne&&!n.loose){for(var Ve=n.sprite[0].div.style.opacity-.1,a=0;a<strPlayer.length;a++)n.sprite[a].div.style.opacity=Ve;if(Ve<(isOnline&&n==oPlayers[0]?.4:.01)){if(!isOnline||n!=oPlayers[0])for(a=0;a<strPlayer.length;a++)n.sprite[a].img.style.display="none",n.marker&&(n.marker.div[a].style.display="none");n.loose=!0,challengeCheck("each_kill")}}}}function kartIsPlayer(e){return isOnline?e==oPlayers[0]:!e.cpu}function isControlledByPlayer(t){var e=aKarts.find(function(e){return e.id==t});return e&&(e.id==identifiant||e.controller==identifiant)}function handleDriftCpt(e){var t,n=aKarts[e];n.driftinc?(n.rotincdir&&(0<n.rotincdir==0<n.driftinc?(n.drift+=n.driftinc,0<n.driftinc?6<n.drift?n.drift=6:n.drift<0&&(n.drift=Math.ceil(n.drift/2)):n.drift<-6?n.drift=-6:0<n.drift&&(n.drift=Math.floor(n.drift/2))):0<n.rotincdir?(n.drift++,0<n.drift&&(n.drift=0)):(n.drift--,n.drift<0&&(n.drift=0))),n.driftcpt<fTurboDriftCpt2&&(t=n.driftcpt,n.rotincdir?0<n.rotincdir==0<n.driftinc?n.driftcpt+=6*Math.max(.7,Math.pow(Math.abs(n.rotincdir)/.6,.8)):n.driftcpt++:n.driftcpt+=2,n.driftcpt>=fTurboDriftCpt2?(getDriftImg(e).src="images/turbo-drift-2.png",carSpark&&n!=oPlayers[1]&&(carSpark.currentTime=0,carSpark.volume=1,carSpark.play(),n.sparkSound=carSpark)):t<fTurboDriftCpt&&n.driftcpt>=fTurboDriftCpt&&(getDriftImg(e).src="images/turbo-drift.png",carSpark&&n!=oPlayers[1]&&(carSpark.currentTime=0,carSpark.volume=.7,carSpark.play(),n.sparkSound=carSpark)))):n.drift&&(n.drift<0?n.drift=Math.min(0,n.drift+1):0<n.drift&&(n.drift=Math.max(0,n.drift-1)))}function angleDrift(e){return kartIsPlayer(e)?e.sliding?e.rotinc*e.sliding:6*e.drift:0}function angleShoot(e,t){e=e.rotation;return t&&(e+=180),e}function dirShoot(e,t,n){var a=t?[0,0]:kartInstantSpeed(e),t=angleShoot(e,t);return a[0]+=n*direction(0,t),a[1]+=n*direction(1,t),a}function tendsToSpeed(e,t,n){var a=Math.hypot(e.vx,e.vy);a&&(n=a*(1-n)+t*n,e.vx*=n/a,e.vy*=n/a)}function kartInstantSpeed(e){var t=e.rotation-angleDrift(e),n=e.speed*direction(0,t),t=e.speed*direction(1,t);return e.shift&&(n+=e.shift[0],t+=e.shift[1]),[n,t]}function updateDriftSize(e){var t;kartIsPlayer(aKarts[e])&&(t=aKarts[e].size-1,getDriftImg(e).style.left=-Math.round(2*iScreenScale*t)+"px",getDriftImg(e).style.top=Math.round(2*iScreenScale*t)+"px",getDriftImg(e).style.width=Math.round(8*iScreenScale+4*iScreenScale*t)+"px")}function getDriftImg(e){return document.getElementById("drift"+e).getElementsByClassName("driftimg")[0]}function updateObjHud(e){document.getElementById("scroller"+e).style.visibility="hidden";var t=aKarts[e].arme;document.getElementById("roulette"+e).innerHTML='<img alt="'+t+'" class="pixelated" src="images/items/'+t+'.png" style="height: '+Math.round(4*iScreenScale)+'px;" />'}function timeStr(e){var t=Math.floor(e/6e4);e-=6e4*t,t+="";var n=Math.floor(e/1e3);for(e-=1e3*n,(n+="").length<2&&(n="0"+n),e+="";e.length<3;)e="0"+e;return t+"'"+n+"&quot;"+e}function openCheats(){var e=prompt("MKPC Console command");e&&(processCode(e)?(clLocalVars.cheated=!0,clSelected&&challengeHandleFail()):alert("Invalid command"))}function processCode(e){if("/"==e.charAt(0)){e=e.substring(1);var t=oPlayers[0],n=/^give (\w+)$/g.exec(e);if(n){for(var a=n[1],o=!1,i=0;i<itemDistribution.length;i++)if(itemDistribution[i][a]){o=!0;break}return o?(t.arme=a,t.roulette=25,updateObjHud(0),1):void 0}n=/^tp ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e);if(n=n||/^tp ([\d\-+\.]+) ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e)){var r=parseFloat(n[1]),l=parseFloat(n[2]);if(isNaN(r)||isNaN(l))return;var s=parseFloat(n[3]);return t.x=r,t.y=l,isNaN(s)||(t.rotation=s),1}r=/^lap(?: ([1-3]|c))?(?: (\d+|c))?$/g.exec(e);if(r){l=parseInt(r[1]),s=parseInt(r[2]);if("c"==r[1]&&(l=t.tours),r[1]||(l=oMap.tours,s=oMap.checkpoint.length-1),"c"==r[2]&&(s=t.demitours),r[2]||(s=oMap.checkpoint.length-1),isNaN(l)||isNaN(s))return;t.tours=l,t.demitours=s;for(var c=document.querySelectorAll("#compteur0 .tour"),i=0;i<c.length;i++)c[i].innerHTML=t.tours;return 1}if("pos"==e)return alert("x: "+Math.round(t.x)+"\ny: "+Math.round(t.y)+"\ntheta: "+Math.round(t.rotation)),1;if("xs"==e)return t.size=.6,t.mini=0,1;if("md"==e)return t.size=1,t.mini=0,1;if("xl"==e)return t.size=Math.pow(1.05,8),t.mini=0,1;if("BB"==course){"balloon"==e&&(e+=" 1");e=/^balloon (\d+)$/g.exec(e);if(e){e=parseInt(e[1]);if(e)return t.reserve+=e,updateBalloonHud(document.getElementById("compteur0"),t),1}}}}function distToAiPoints(e,t,n){for(var a=1/0,o=0;o<n.length;o++){var i=(o+1)%n.length,r=n[o][0],l=n[o][1],s=n[i][0],c=n[i][1],i=projete(e,t,r,l,s,c);i<0&&(i=0),1<i&&(i=1);r=r+(s-r)*i,i=l+(c-l)*i,a=Math.min(a,(r-e)*(r-e)+(i-t)*(i-t))}return a}Math.hypot||(Math.hypot=function(e,t){return Math.sqrt(e*e+t*t)});var fMaxRotInCp=10,cycleHandler;function ai(u){var e=isBattle&&simplified,t=isBattle&&complete,n=!isBattle&&complete;if(null==u.aipoint)if("BB"!=course)for(var a=1/0,o=0;o<u.aipoints.length;o++){var i=(x=u.aipoints[o])[0]-u.x,r=x[1]-u.y;(M=2*(b=Math.sqrt(i*i+r*r))+b*Math.abs(nearestAngle(Math.atan2(i,r)-u.rotation*Math.PI/180,0,2*Math.PI)))<a&&(u.aipoint=o,u.lastAItime=0,a=M)}else e&&(u.aipoint=Math.floor(u.x/100)+6*Math.floor(u.y/100),u.lastAItime=0,u.lastAI=-1);if(!u.billball&&!u.tombe){if(oMap.sections&&u.tours>oMap.tours||u.ballons&&!u.ballons.length&&!u.loose)return u.speedinc=0,u.rotinc=0,void(u.rotincdir=0);if(u.tourne)return u.speedinc=!u.z&&1<u.speed?1:0,u.rotinc=0,void(u.rotincdir=0);if(u.aipoints.length){for(var l=0,s=2*Math.PI,c=0,p=0;p<u.aipoints.length;p++){var d,m,h,y=u.aipoint;if("BB"!=course){var g=y-1;g<0&&(g+=u.aipoints.length);var f=y+1;f>=u.aipoints.length&&(f=0),d=u.aipoints[g],m=u.aipoints[y],h=u.aipoints[f]}else if(e){d=[u.lastAI%6*100+50,100*Math.floor(u.lastAI/6)+50],m=[u.aipoint%6*100+50,100*Math.floor(u.aipoint/6)+50],h=[d[0]+2*(m[0]-d[0]),d[1]+2*(m[1]-d[1])];var S=Math.floor(u.x/100)+6*Math.floor(u.y/100);if(S!=u.lastAI){if(27!=oMap.skin||(m[0]-u.x)*(m[0]-u.x)+(m[1]-u.y)*(m[1]-u.y)<1500||u.speed<0||u.tombe){(C=u.aipoints[S])&&C.length||(C=[],S%6&&C.push(S-1),S%6<5&&C.push(S+1),6<=S&&C.push(S-6),S<30&&C.push(S+6),-1!=(I=C.indexOf(u.lastAI))&&C.splice(I,1));var v=u.lastAI;for(u.lastAI=S;u.aipoint=C[Math.floor(Math.random()*C.length)],v==u.aipoint&&1<C.length;);}u.nextAiStop=void 0,u.randShift=void 0}}else{if(null==u.aipoint){u.lastAI=void 0,u.nextAI=void 0;for(var b,M,a=1/0,o=0;o<u.aipoints.length;o++)o!=u.lastAI&&0==(x=u.aipoints[o])[0]&&(i=x[1]-u.x,r=x[2]-u.y,(M=2*(b=Math.sqrt(i*i+r*r))+b*Math.abs(nearestAngle(Math.atan2(i,r)-u.rotation*Math.PI/180,0,2*Math.PI)))<a&&(u.aipoint=o,u.lastAItime=0,a=M))}if(m=u.aipoints[u.aipoint].slice(1),d=u.lastAI?u.aipoints[u.lastAI].slice(1):(u.lastAIpt||(u.lastAIpt=[u.x,u.y]),u.lastAIpt),!u.nextAI){for(var x,C=new Array,o=0;o<u.aipoints.length;o++)1==(x=u.aipoints[o])[0]&&(x[1]==u.aipoint?C.push(x[2]):x[2]==u.aipoint&&C.push(x[1]));if(C.length)for(;u.nextAI=C[Math.floor(Math.random()*C.length)],u.lastAI==u.nextAI&&1<C.length;);else u.nextAI=-1}h=-1!=u.nextAI?u.aipoints[u.nextAI].slice(1):d}u.speedinc=1,u.lastAItime++;var P=m[0]-d[0],k=m[1]-d[1],w=Math.hypot(P,k),g=h[0]-m[0],y=h[1]-m[1],f=fMaxRotInCp*Math.PI/180,I=t?15:20;u.nextAiStop||(u.nextAiStop=nextAiStop(d[0],d[1],P,k,m[0],m[1],g,y,u.maxspeed/f),T=1-50/w,u.nextAiStop<T&&(u.nextAiStop=T)),u.randShift||(u.randShift=10*Math.random()-5,null!=oMap.randshift&&(u.randShift*=oMap.randshift),t?u.randShift/=1.5:n&&(D=w/10,Math.abs(u.randShift)>D&&(u.randShift=D*Math.sign(u.randShift))));var S=projete(u.x,u.y,d[0],d[1],m[0],m[1]),g=d[0]+S*(m[0]-d[0]),y=d[1]+S*(m[1]-d[1]),T=Math.hypot(u.x-g,u.y-y);if(P||k||(T=0,u.nextAiStop=0,S=1),!(S>=u.nextAiStop&&T<I)||e){var E,L,B,z,D=!1;if(u.bounced)u.bouncedsince?u.rotinc=0:u.rotinc=fMaxRotInCp*Math.random(),u.bouncedsince++,10==u.bouncedsince&&(delete u.bouncedsince,delete u.bounced),D=!0;else if(u.collided)delete u.recovering,delete u.minDecor,u.recovertime||(u.recovertime=21+Math.floor(10*Math.random())),u.collidesince?u.collidesince>u.recovertime&&(u.randShift=Math.random()*u.recovertime/2-u.recovertime/4,u.recovertime+=30,u.decision=-u.decision,u.collidesince=1,e&&(u.lastAI=u.aipoint)):(u.collidesince=1,u.decision||(E=direction(0,u.rotation),L=direction(1,u.rotation),B=u.horizontality[0],z=u.horizontality[1],u.decision=0<E*B+L*z!=0<E*z-L*B?1:-1)),u.collidesince++,u.horizontality?(E=direction(0,u.rotation),L=direction(1,u.rotation),B=u.horizontality[0],z=u.horizontality[1],(.1<Math.abs(E*z-L*B)||150<u.lastAItime)&&(u.rotinc=u.decision*fMaxRotInCp)):u.rotinc=u.decision*fMaxRotInCp,D=!0;else{var H,O,l=(u.nextAiStop-S)*w;u.collidesince&&(u.recovering||(u.recovering=1),u.recovering++,D=!0,20<=u.recovering&&(delete u.recovering,delete u.recovertime,delete u.decision,delete u.collidesince)),ie=T<I?(H=m[0]+u.randShift*k/w,O=m[1]-u.randShift*P/w,Math.atan2(H-u.x,O-u.y)):(_=followCircleWithAngle(u.x,u.y,m[0],m[1],P,k),R=d[0]+(u.x-g)*I/T,N=d[1]+(u.y-y)*I/T,H=R+(ie=intersectionLineCircle(_[0],_[1],_[2],R,N,P,k))*P,O=N+ie*k,R=_[1]-u.y,N=u.x-_[0],R*(g-u.x)+N*(y-u.y)<0&&(R=-R,N=-N),Math.atan2(R,N));var A,R,N,V,F=u.x,j=u.y,_=H,g=O,y=Math.hypot(_-F,g-j),W=(_-F)*u.speed/y,K=(g-j)*u.speed/y,G=1;if(!isCup)for(var q in decorPos){var U=decorBehaviors[q].hitbox||DEFAULT_DECOR_HITBOX;U*=1.1;for(o=0;o<decorPos[q].length;o++)for(var $=decorPos[q][o],J=[[$.x-U,$.y-U,2*U,0],[$.x-U,$.y-U,0,2*U],[$.x-U,$.y+U,2*U,0],[$.x+U,$.y-U,0,2*U]],X=W-$.vX,Y=K-$.vY,Q=0;Q<J.length;Q++){var Z=J[Q],ee=secants(F,j,F+16*X,j+16*Y,Z[0],Z[1],Z[0]+Z[2],Z[1]+Z[3]);ee&&ee[0]<G&&(A={type:q,i:o,line:Z,inter:ee,box:[Z[0]+16*$.vX*ee[1],Z[1]+16*$.vY*ee[1],Z[2],Z[3]]},G=ee[0])}}A?(R=A.box[0],N=A.box[1],_=A.box[0]+A.box[2],V=A.box[1]+A.box[3],g=distToAiPoints(R,N,u.aipoints),y=distToAiPoints(_,V,u.aipoints),R-=A.box[2]/1.5,N-=A.box[3]/1.5,_+=A.box[2]/1.5,V+=A.box[3]/1.5,O=g<y?(H=R,N):(H=_,V),ie=Math.atan2(H-u.x,O-u.y),u.minDecor={x:H,y:O,t:10}):u.minDecor&&(ae=u.minDecor.x,te=u.minDecor.y,u.minDecor.t--,u.minDecor.t<0||(u.x-ae)*(u.x-ae)+(u.y-te)*(u.y-te)<300?delete u.minDecor:(V=direction(0,u.rotation),ne=direction(1,u.rotation),(ae-u.x)*V+(te-u.y)*ne<0&&delete u.minDecor),u.minDecor&&(H=ae,O=te));var te,ne=u.rotation,ae=u.speed;!u.shift||isCup||(oe=flowShift(u.x,u.y,u.protect))&&(te=kartInstantSpeed(u),oe[2]?ae=Math.min(ae,Math.hypot(te[0],te[1])):(ne=180*Math.atan2(te[0],te[1])/Math.PI,10<=oe[0]*oe[0]+oe[1]*oe[1]&&(ne+=.15*(ne-u.rotation))),isNaN(ne)&&(ne=u.rotation)),ie=nearestAngle(180*ie/Math.PI,ne,360),isNaN(ie)&&(ie=ne),isNaN(H)&&(H=m[0]),isNaN(O)&&(O=m[1]);var oe=ie-ne;u.rotinc=Math.max(Math.min(oe,fMaxRotInCp),-fMaxRotInCp);var ie=Math.abs(oe),s=ie;isBattle&&(ie*=Math.pow(ie/10,1.5)),l=Math.hypot(H-u.x,O-u.y);var re,ne=Math.atan2(H-d[0],O-d[1])-u.rotation,oe=(Math.abs(Math.sin(ne))+ie*Math.PI/180/2)/f,c=l/oe;"BB"!=course||(ne=Math.max(5,oe/1.57))<oe&&(c=getNearestHoleDist(u.x,u.y,1600)<1600?l/Math.pow(ne*Math.tan(oe/ne),1.5):l/Math.pow(oe,1.2)),fMaxRotInCp<ie&&(T<I&&((re=aiMarginLimitSpeed(u.x,u.y,direction(0,u.rotation),direction(1,u.rotation),m[0],m[1],P,k,2*I,f))<c&&(c=re)),re=c,u.bloops&&u.bloops.effective(u)&&(re=Math.min(re,3)),re=(re/=.9)||.01,32==oMap.skin&&6<ae&&re<ae-1?(u.speed=Math.max(re,u.speed-2),u.speedinc=0):u.speedinc=Math.max(Math.min(re-ae,1),-1),u.speedinc<0&&(u.rotinc=-u.rotinc))}D&&u.lastAItime>250+50*Math.random()&&!e&&(u.aipoint=void 0);break}"BB"!=course?(u.aipoint++,u.aipoint>=u.aipoints.length&&(u.aipoint=0)):(u.lastAI=u.aipoint,delete u.lastAIpt,-1!=u.nextAI?u.aipoint=u.nextAI:u.aipoint=void 0,u.nextAI=void 0),u.nextAiStop=void 0,u.randShift=void 0,u.lastAItime=0}if((25==u.roulette||u.using[0])&&!u.tourne&&!u.cannon){var le,se=!1;function ce(e,t,n,a,o){for(var i=e*e,r=t*t,l=(isOnline?aKarts:strPlayer).length,s=0;s<l;s++){var c=aKarts[s];if(!c.loose&&!c.protect&&!c.cpu){var p=(c.x-u.x)*(c.x-u.x)+(c.y-u.y)*(c.y-u.y);if(i<=p&&p<r){c=180*Math.atan2(c.x-u.x,c.y-u.y)/Math.PI;o&&(c+=180);c=Math.abs(nearestAngle(c-u.rotation,0,360));if(n<=c&&c<a)return 1}}}}if(!isOnline||u.controller==identifiant)if(u.using.length)switch(u.using[0].type){case"carapace-rouge":"BB"==course&&u.using.length<2?ce(15,100,0,30)&&arme(aKarts.indexOf(u)):se=!0;break;case"carapace":"BB"==course&&u.using.length<2?((ce(0,20,0,30)||ce(0,150,0,15))&&arme(aKarts.indexOf(u)),(ce(0,20,0,30,!0)||ce(0,80,0,15,!0))&&arme(aKarts.indexOf(u),!0)):se=!0;break;default:se=!0}else switch(u.arme){case"megachampi":case"etoile":11<=c&&100<=l&&s<=10&&arme(aKarts.indexOf(u));break;case"champi":case"champiX2":case"champiX3":!u.champi&&11<=c&&100<=l&&s<=10&&arme(aKarts.indexOf(u));break;case"champior":u.champior?(8<=c||5<=c-u.speed)&&s<=10&&arme(aKarts.indexOf(u)):11<=c&&100<=l&&s<=10&&arme(aKarts.indexOf(u));break;default:se=!0}se&&.98<Math.random()&&(le=(u.place<oPlayers[0].place||"BB"==course)&&.5<Math.random(),arme(aKarts.indexOf(u),le))}oMap.jumpable&&4<iDificulty&&(!u.z||u.jumped||u.billball||u.figstate||u.figuring||u.tourne||!(0<u.heightinc)||8<=c&&(oMap.jumpexc&&-1!=oMap.jumpexc.indexOf(u.aipoint)||(u.figstate=21)))}}}function moveItems(){for(var e in collisionTest=COL_OBJ,collisionTeam=void 0,clLocalVars.currentKart=void 0,itemBehaviors){var t=itemBehaviors[e].move;if(t)for(var n=items[e],a=n.length-1;0<=a;a--)n[a]&&t(n[a])}}function moveDecor(){for(var e in decorPos={},oMap.decor)if(decorBehaviors[e].dodgable){decorPos[e]=[];for(var t=oMap.decor[e],n=0;n<t.length;n++)decorPos[e].push({aX:t[n][0],aY:t[n][1],x:t[n][0],y:t[n][1],vX:0,vY:0})}var a={};for(e in oMap.decor){var t=oMap.decor[e],o=decorBehaviors[e];if(o.move){var i=getDecorActualType(o),r=0;a[i]?r=a[i]:a[i]=0;for(n=0;n<t.length;n++)o.move(t[n],n,n+r);a[i]+=t.length}}var l=2*Math.PI;for(e in decorPos)for(t=oMap.decor[e],n=0;n<t.length;n++)decorPos[e][n].x=t[n][0],decorPos[e][n].y=t[n][1],decorPos[e][n].vX=decorPos[e][n].x-decorPos[e][n].aX,decorPos[e][n].vY=decorPos[e][n].y-decorPos[e][n].aY;if(oMap.pointers)for(n=0;n<oMap.pointers.length;n++){var s=oMap.pointers[n];s[2][2]+=s[2][3],s[2][2]%=l,s[0].redraw(s)}if(oMap.flippers)for(n=0;n<oMap.flippers.length;n++){var c=oMap.flippers[n],p=c[3][0];switch(p){case 0:--c[3][1]<=0&&(c[3][0]=1,c[3][1]=c[2][2],c[2][3]=.13*c[2][4]);break;case 1:case 2:var u=1==p?c[3][1]+c[2][4]:c[3][1];c[2][2]+=c[2][3],c[2][2]*c[2][3]>=u*c[2][3]&&(c[2][2]=u,1==p?(c[3][0]=2,c[2][3]=-c[2][3]):(c[3][0]=0,c[2][3]=0,c[3][1]=1+Math.floor(50*Math.random())))}p&&c[0].redraw(c)}if(oMap.bumpers)for(n=0;n<oMap.bumpers.length;n++){var d,m,h=oMap.bumpers[n];h[2][5]&&(h[3]||(d=Math.hypot(h[1][0]-h[2][3],h[1][1]-h[2][4]),m=Math.atan2(h[1][1]-h[2][4],h[1][0]-h[2][3]),h[3]=[d,m]),h[3][1]+=h[2][5],h[3][1]%=l,h[1][0]=h[2][3]+h[3][0]*Math.cos(h[3][1]),h[1][1]=h[2][4]+h[3][0]*Math.sin(h[3][1]),h[0].redraw(h))}if(oMap.sea){var y=oMap.sea,g=y.progress,f=120,S=(timer+60)%300;if(y.progress=S<f?1:S<150?.5-.5*Math.sin(Math.PI*((S-f)/30-.5)):S<270?0:.5+.5*Math.sin(Math.PI*((S-f-120-30)/30-.5)),y.progress!==g&&(oMap.horspistes.eau={rectangle:[],polygon:y.offroad0.slice()},y.progress))for(var v=.99*y.progress,n=0;n<y.waves.length;n++)oMap.horspistes.eau.polygon.push(y.polygon(n,0,v))}if(oMap.coins)for(n=0;n<oMap.coins.length;n++){var b=oMap.coins[n];b.theta+=.25,b.theta>=l&&(b.theta-=l)}}function cycle(){cycleHandler=setInterval(runOneFrame,SPF),runOneFrame()}var decorPos={};function runOneFrame(){if("CM"!=course)for(var e=0;e<aKarts.length;e++)colKart(e);for(var t,e=0;e<aKarts.length;e++)(n=aKarts[e]).pushVector&&(36<(t=n.pushVector[0]*n.pushVector[0]+n.pushVector[1]*n.pushVector[1])&&(t=Math.sqrt(t),n.pushVector[0]*=6/t,n.pushVector[1]*=6/t),n.shift||(n.shift=[0,0,0]),n.shift[0]+=n.pushVector[0],n.shift[1]+=n.pushVector[1],delete n.pushVector);for(e=0;e<aKarts.length;e++){var n=aKarts[e];if(e&&"CM"==course&&!n.cpu){var a=jTrajets[e-1];if(timer<=a.length){var o=a[timer-1];n.tombe&&(n.tombe--,n.tombe||resetFall(n));var a=n.x,i=n.y,r=n.rotation;n.x=o[0],n.y=o[1],n.z=o[2],n.rotation=o[3],o[4]&&"1"==o[4][0]&&(n.tombe=20,n.aX=a,n.aY=i,n.aRotation=r,n.sprite[0].img.style.display="none");continue}n.cpu=!0,n.aipoint=0,n.lastAItime=0,n.arme=!1}n.loose&&(!isOnline||finishing)||(n.cpu&&ai(n),move(e),"CM"!=course||n.cpu||(i=[Math.round(n.x),Math.round(n.y),n.z,Math.round(n.rotation)],r="0000".split(""),20==n.tombe&&(r[0]="1"),n.ctrl&&(r[1]="1",0<n.rotincdir?r[2]="1":n.rotincdir<0&&(r[3]="1")),-1!=r.indexOf("1")&&i.push(r.join("")),iTrajet.push(i)))}if("CM"!=course)for(e=0;e<aKarts.length;e++)places(e);moveItems(),moveDecor(),oPlayers[0].cpu||(clSelected&&!clSelectionFail&&!1===challengeRulesSatisfied(clSelected,clSelected.data.constraints)&&challengeHandleFail(),challengeCheck("each_frame")),refreshDatas&&resetDatas(),render()}var gameControls={};document.onkeydown=function(e){e=gameControls[e.keyCode];switch(e){case"up":return(oPlayers[0].speedinc=1)<document.getElementById("decompte0").innerHTML&&updateEngineSound(carEngine2),!1;case"left":return!(oPlayers[0].rotincdir=1);case"right":return!(oPlayers[0].rotincdir=-1)}if(oPlayers[1])switch(e){case"up_p2":oPlayers[1].speedinc=1;break;case"left_p2":oPlayers[1].rotincdir=1;break;case"right_p2":oPlayers[1].rotincdir=-1}},document.onkeyup=function(e){e=gameControls[e.keyCode];switch(e){case"up":oPlayers[0].speedinc=0,updateEngineSound(carEngine);break;case"left":case"right":oPlayers[0].rotincdir=0}if(oPlayers[1])switch(e){case"up_p2":oPlayers[1].speedinc=0;break;case"left_p2":oPlayers[1].rotincdir=0;break;case"right_p2":oPlayers[1].rotincdir=0}};var virtualButtonW=60,virtualButtonH=50,myPersosCache;function addButton(e,t,n,a,o,i,r){o=(o||1)*virtualButtonW,i=(i||1)*virtualButtonH;var l=document.createElement("button");return l.style.position="absolute",l.style.left=Math.round(n*virtualButtonW*1.2)+"px",l.style.top=Math.round(a*virtualButtonH*1.3)+"px",l.style.width=o+"px",l.style.height=i+"px",l.style.textAlign="center",l.style.padding="0px",r&&(l.style.fontSize=r+"px"),l.innerHTML=e,l.dataset.key=t,l.ontouchstart=onButtonTouch,l.ontouchend=onButtonPress,document.getElementById("virtualkeyboard").appendChild(l),l}function isCustomPerso(n){var e;return n.startsWith("cp-")&&(customPersos[n]||(cp[n]=[.5,.5,.5,.5],e=PERSOS_DIR+n+"-ld.png",customPersos[n]={name:language?"Deleted character":"Perso supprim",map:e,podium:e,music:"mario"},xhr("getCP.php","perso="+n,function(e){if(-1==e)return!0;if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return cp[n][0]=t.acceleration,cp[n][1]=t.speed,cp[n][2]=t.handling,cp[n][3]=t.mass,customPersos[n]=t,!0})),1)}function getWinnerSrc(e){return isCustomPerso(e)?customPersos[e].podium:"images/winners/w_"+e+".png"}function getEndingSrc(e){return isCustomPerso(e)&&(e=customPersos[e].music),baseCp[e]?"musics/endings/ending_"+e+".mp3":e}function getStarSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+"-star.png":"images/star/star_"+e+".png"}function getSpriteSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+".png":"images/sprites/sprite_"+e+".png"}function getCustomDecorData(e,t){var o=e.id,i=e.type,e=!1;if(customDecorData[o]){if(void 0!==customDecorData[o].data)return void t(customDecorData[o].data);e=!0}else customDecorData[o]={callbacks:[]};customDecorData[o].callbacks.push(t),e||xhr("getDecorData.php?id="+o+"&full",null,function(e){var t;try{t=JSON.parse(e)}catch(e){t={id:o,hd:"images/sprites/sprite_"+i+".png",map:"images/map_icons/"+i+".png",size:{hd:{w:32,h:32}},original_size:{hd:{w:32,h:32}}}}customDecorData[o].data=t;for(var n=customDecorData[o].callbacks,a=0;a<n.length;a++)customDecorData[o].callbacks[a](t);return!(n.length=0)})}function getMapIcSrc(e){return isCustomPerso(e)?customPersos[e].map:"images/map_icons/"+e+".png"}function getMapSelectorSrc(e){return isCup?complete?"trackicon.php?id="+oMaps[aAvailableMaps[e]].map+"&type="+("BB"==course?2:1):"trackicon.php?id="+oMaps[aAvailableMaps[e]].id+"&type=0":"images/selectors/select_"+aAvailableMaps[e]+".png"}function getMapId(e){e=isBattle?nid:simplified?e.id:e.map;return null==e&&(e=-1),e}function privateGame(t){var e=document.createElement("div"),n=e.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",e.appendChild(toTitle(toLanguage("Private game","Partie prive"),0));n=document.createElement("div");n.style.position="absolute",n.style.left=6*iScreenScale+"px",n.style.top=12*iScreenScale+"px",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.color="#DFC",n.innerHTML=language?"The &quot;private game&quot; option allows you to play only with people you want.<br />The principle is simple: a private link is generated, you send this link to the concerned members, and you can start playing.":"L'option &quot;partie prive&quot; vous permet de jouer uniquement avec les personnes de votre choix.<br />Le principe est simple : un lien priv est gnr, vous envoyez ce lien aux membres concerns, et vous pouvez commencer  jouer.",e.appendChild(n);n=document.createElement("input");n.type="button",n.value=toLanguage("Generate private link","Gnrer un lien priv"),n.style.fontSize=3*iScreenScale+"px",n.style.position="absolute",n.style.width=35*iScreenScale+"px",n.style.left=23*iScreenScale+"px",n.style.top=28*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateLink(t)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),shareLink.options=null,selectPlayerScreen(0)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("Private game options...","Options de la partie prive..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=52*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateGameOptions(shareLink.options,function(e){e&&(shareLink.options=e,t=e),privateGame(t)})},e.appendChild(n),oContainers[0].appendChild(e)}function privateGameOptions(e,d){var m=document.createElement("div"),t=m.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",(S=toTitle(isOnline?toLanguage("Private game options","Options partie prive"):toLanguage("Online game options","Options mode en ligne"),0)).style.fontSize=7*iScreenScale+"px",m.appendChild(S);var n=document.createElement("form");n.style.position="absolute",n.style.left="0px",n.style.top=8*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px",n.onsubmit=function(e){e.preventDefault();var t=this.elements["option-teams"].checked?1:0,n=this.elements["option-manualTeams"].checked?1:0;t||(n=0);var a=this.elements["option-friendly"].checked?1:0,o=+this.elements["option-localScore"].checked?1:0;a||(o=0);var i=+this.elements["option-minPlayers"].value,r=+this.elements["option-maxPlayers"].value,l=JSON.parse(this.elements["option-itemDistrib"].value),s=this.elements["option-cpu"].checked?1:0,c=+this.elements["option-cpuCount"].value,p=+this.elements["option-cpuLevel"].value,u=(u=this.elements["option-cpuNames"].dataset.value)&&JSON.parse(u),e=(e=this.elements["option-cpuChars"].dataset.value)&&JSON.parse(e);s||(c=defaultGameOptions.cpuCount,p=defaultGameOptions.cpuLevel,u=defaultGameOptions.cpuNames,e=defaultGameOptions.cpuChars),d({team:t,manualTeams:n,friendly:a,localScore:o,minPlayers:i,maxPlayers:r,itemDistrib:l,cpu:s,cpuCount:c,cpuLevel:p,cpuNames:u,cpuChars:e}),m.innerHTML="",oContainers[0].removeChild(m)};var a=document.createElement("div");a.style.height=(isOnline?24:20)*iScreenScale+"px",a.style.overflow="auto";var o=document.createElement("table");o.style.marginLeft="auto",o.style.marginRight="auto";var i=document.createElement("tr");(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px";var r=document.createElement("input");r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-teams",r.name="option-teams",r.type="checkbox",e&&e.team&&(r.checked=!0),r.onchange=function(){this.checked?document.getElementById("option-manualTeams-ctn").style.display="":document.getElementById("option-manualTeams-ctn").style.display="none"},l.appendChild(r),i.appendChild(l);var l=document.createElement("td"),s=document.createElement("label");s.style.cursor="pointer",s.setAttribute("for","option-teams");var c=document.createElement("h1");c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Team games","Parties par quipe"),s.appendChild(c);var p=document.createElement("div");p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, 2 teams are selected in each game. You object: defeat the opposing team.","Si activ, 2 quipes sont slectionnes  chaque partie. Votre objectif : vaincre l'quipe adverse."),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-manualTeams-ctn",e&&e.team||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.position="relative",r.style.left=Math.round(1.5*iScreenScale)+"px",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-manualTeams",r.name="option-manualTeams",r.type="checkbox",e&&e.team&&e.manualTeams&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.style.display="inline-block",s.setAttribute("for","option-manualTeams"),(c=document.createElement("h1")).style.marginTop=0,c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Manual selection","Slection manuelle"),s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, teams are selected manually at each game.","Si activ, les quipes sont slectionnes manuellement  chaque partie. Sinon, les quipes sont formes automatiquement en fonction du niveau de chaque joueur."),s.appendChild(p),l.appendChild(s),l.style.paddingBottom=Math.round(1.5*iScreenScale)+"px",i.appendChild(l),o.appendChild(i);i=document.createElement("tr");(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).id="option-friendly",r.name="option-friendly",r.type="checkbox",e&&e.friendly&&(r.checked=!0),r.onchange=function(){this.checked&&isOnline?document.getElementById("option-localScore-ctn").style.display="":document.getElementById("option-localScore-ctn").style.display="none"},r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-friendly"),l.appendChild(s),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Friendly game","Matchs amicaux"),c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, games won't make you win or lose points in the online mode.","Si activ, les parties ne vous feront pas gagner ou perdre de points dans le mode en ligne."),s.appendChild(p),l.appendChild(s),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-localScore-ctn",e&&e.friendly||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.position="relative",r.style.left=Math.round(1.5*iScreenScale)+"px",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-localScore",r.name="option-localScore",r.type="checkbox",e&&e.friendly&&e.localScore&&isOnline&&(r.checked=!0),l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.style.display="inline-block",s.setAttribute("for","option-localScore"),(c=document.createElement("h1")).style.marginTop=0,c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Local scoring","Classement local"),s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, an ranking internal to this room will be calculated instead of the classic online mode ranking.","Si activ, un classement interne  la partie prive sera calcul  la place du classement en ligne classique."),s.appendChild(p),l.appendChild(s),l.style.paddingBottom=Math.round(1.5*iScreenScale)+"px",i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2);var u=document.createElement("div");u.style.display="flex",u.style.flexDirection="row",u.style.alignItems="center";var h=document.createElement("div");h.style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-minPlayers"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Minimum number of players","Nombre de joueurs minimum"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("Minimum number of players before the game begins.","Nombre minimum de joueurs pour que la partie commence"),s.appendChild(p),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block";t=document.createElement("input");t.id="option-minPlayers",t.name="option-minPlayers",t.type="number",t.setAttribute("min",2),t.setAttribute("max",99),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.minPlayers?t.value=e.minPlayers:t.value=defaultGameOptions.minPlayers,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",h.appendChild(t),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(u=document.createElement("div")).style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-maxPlayers"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Maximum number of players","Nombre de joueurs maximum"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("Maximum number of players that can join the game.","Nombre maximum de joueurs qui peuvent rejoindre la partie"),s.appendChild(p),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(t=document.createElement("input")).id="option-maxPlayers",t.name="option-maxPlayers",t.type="number",t.setAttribute("min",2),t.setAttribute("max",99),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.maxPlayers?t.value=e.maxPlayers:t.value=defaultGameOptions.maxPlayers,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",h.appendChild(t),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(u=document.createElement("div")).style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-itemDistrib"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Item distribution","Distribution des objets"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block";var y=document.createElement("select");y.id="option-itemDistrib",y.name="option-itemDistrib",y.style.backgroundColor="black",y.style.width=24*iScreenScale+"px",y.style.fontSize=Math.round(2.5*iScreenScale)+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var g=getItemMode(),f=0;f<itemDistributions[g].length;f++)(v=document.createElement("option")).value=f,v.innerHTML=itemDistributions[g][f].name,y.appendChild(v);for(var S,f=0;f<customItemDistrib[g].length;f++)(v=document.createElement("option")).value=JSON.stringify(customItemDistrib[g][f].value),v.innerHTML=customItemDistrib[g][f].name,y.appendChild(v);e&&e.itemDistrib&&(S=JSON.stringify(e.itemDistrib),y.value=S,y.value!==S&&((v=document.createElement("option")).value=S,v.innerHTML=toLanguage("Custom","Personnalis"),y.insertBefore(v,y.firstChild),y.selectedIndex=0)),(v=document.createElement("option")).value=-1,v.innerHTML=toLanguage("Custom...","Personnalis..."),y.appendChild(v),y.currentValue=y.value,y.onchange=function(){var n;-1==this.value?(this.value=this.currentValue,selectedItemDistrib=isNaN(this.currentValue)?JSON.parse(this.currentValue):itemDistributions[g][this.currentValue],n=this,selectItemScreen(m,function(e){var t=n.querySelector("option");isNaN(t.value)||((t=document.createElement("option")).innerHTML=toLanguage("Custom","Personnalis"),n.insertBefore(t,n.firstChild)),t.value=JSON.stringify(e.value),n.selectedIndex=0,n.currentValue=n.value},{untitled:!0})):this.currentValue=this.value},h.appendChild(y),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i);i=document.createElement("tr");isOnline||(i.style.display="none"),(l=document.createElement("td")).style.textAlign="center",l.style.width=8*iScreenScale+"px",(r=document.createElement("input")).style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",r.id="option-cpu",r.name="option-cpu",r.type="checkbox",e&&e.cpu&&(r.checked=!0),r.onchange=function(){var e;this.checked?(document.getElementById("option-cpuCount-ctn").style.display="",isBattle||(document.getElementById("option-cpuLevel-ctn").style.display=""),document.getElementById("option-cpuNames-ctn").style.display="",document.getElementById("option-cpuChars-ctn").style.display="",(e=document.getElementById("option-cpuCount")).value=Math.max(e.value,3),setTimeout(function(){e.select(),a.scrollTop+=13*iScreenScale},1)):(document.getElementById("option-cpuCount-ctn").style.display="none",document.getElementById("option-cpuLevel-ctn").style.display="none",document.getElementById("option-cpuNames-ctn").style.display="none",document.getElementById("option-cpuChars-ctn").style.display="none")},l.appendChild(r),i.appendChild(l);l=document.createElement("td");(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpu"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Add CPUs","Ajouter des ordis"),s.appendChild(c),(p=document.createElement("div")).style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If enabled, bots will be added to the game if there is not enough players","Si activ, des bots seront ajouts  la partie s'il n'y a pas assez de joueurs"),s.appendChild(p),l.appendChild(s),l.style.padding=Math.round(1.5*iScreenScale)+"px 0",i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuCount-ctn",e&&e.cpu||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(u=document.createElement("div")).style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuCount"),(c=document.createElement("h1")).style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Total number of participants","Nombre total de participants"),c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),(p=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",p.style.fontSize=2*iScreenScale+"px",p.style.color="white",p.innerHTML=toLanguage("If there isn't enough players, bots will be added to match the specified number of participants","S'il n'y a pas assez de joueurs, des bots seront ajouts pour matcher le nombre de participants spcifi"),s.appendChild(p),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block",h.style.marginRight=3*iScreenScale+"px",(t=document.createElement("input")).id="option-cpuCount",t.name="option-cpuCount",t.type="number",t.setAttribute("min",2),t.setAttribute("max",12),t.setAttribute("step",1),t.setAttribute("required",!0),t.style.backgroundColor="#F6F6F6",t.style.width=6*iScreenScale+"px",e&&e.cpuCount?t.value=e.cpuCount:t.value=defaultGameOptions.cpuCount,t.style.fontSize=3*iScreenScale+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",h.appendChild(t),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuLevel-ctn",e&&e.cpu&&!isBattle||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(u=document.createElement("div")).style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuLevel"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("CPU difficulty","Difficult des ordis"),c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(y=document.createElement("select")).id="option-cpuLevel",y.name="option-cpuLevel",y.style.backgroundColor="black",y.style.width=14*iScreenScale+"px",y.style.fontSize=Math.round(2.5*iScreenScale)+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var v,b=[toLanguage("Difficult","Difficile"),toLanguage("Medium","Moyen"),toLanguage("Easy","Facile")],f=0;f<b.length;f++)(v=document.createElement("option")).value=f,v.innerHTML=b[f],y.appendChild(v);e&&e.cpuLevel&&(y.selectedIndex=e.cpuLevel),h.appendChild(y),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuNames-ctn",e&&e.cpu&&!isBattle||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(u=document.createElement("div")).style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuNames"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("CPU names","Noms des ordis"),c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block";t=document.createElement("input");t.type="button",t.id="option-cpuNames",t.name="option-cpuNames",t.value=toLanguage("Set...","Spcifier..."),t.style.backgroundColor="black",t.style.width=14*iScreenScale+"px",t.style.padding=Math.round(.2*iScreenScale)+"px "+Math.round(+iScreenScale)+"px",t.style.fontSize=Math.round(2*iScreenScale)+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",e&&e.cpuNames&&(t.dataset.value=JSON.stringify(e.cpuNames)),t.onclick=function(){var t,e,n=+this.form.elements["option-cpuCount"].value;2<n&&(e=(t=this).dataset.value?JSON.parse(this.dataset.value):[],selectCpuNamesScreen(m,function(e){t.dataset.value=JSON.stringify(e)},{names:e,count:n-2}))},h.appendChild(t),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i),(i=document.createElement("tr")).id="option-cpuChars-ctn",e&&e.cpu&&!isBattle||(i.style.display="none"),(l=document.createElement("td")).setAttribute("colspan",2),(u=document.createElement("div")).style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",(h=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",h.style.paddingRight=3*iScreenScale+"px",(s=document.createElement("label")).style.cursor="pointer",s.setAttribute("for","option-cpuChars"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("CPU characters","Persos des ordis"),c.style.marginLeft=Math.round(1.5*iScreenScale)+"px",c.style.marginTop=iScreenScale+"px",c.style.marginBottom="0px",s.appendChild(c),h.appendChild(s),u.appendChild(h),(h=document.createElement("div")).style.display="inline-block",(t=document.createElement("input")).type="button",t.id="option-cpuChars",t.name="option-cpuChars",t.value=toLanguage("Set...","Spcifier..."),t.style.backgroundColor="black",t.style.width=14*iScreenScale+"px",t.style.padding=Math.round(.2*iScreenScale)+"px "+Math.round(+iScreenScale)+"px",t.style.fontSize=Math.round(2*iScreenScale)+"px",t.style.marginTop=Math.round(1.5*iScreenScale)+"px",e&&e.cpuChars&&(t.dataset.value=JSON.stringify(e.cpuChars)),t.loadCpuChars=function(e){e&&(this.dataset.value=JSON.stringify(e)),m.style.visibility=""},t.onclick=function(){var e=+this.form.elements["option-cpuCount"].value;2<e&&(this.dataset.cpuChars=1,selectPlayerScreen(2,!(m.style.visibility="hidden"),e))},h.appendChild(t),u.appendChild(h),l.appendChild(u),i.appendChild(l),o.appendChild(i),a.appendChild(o),n.appendChild(a),(p=document.createElement("div")).style.textAlign="center",p.style.marginTop=2*iScreenScale+"px";o=document.createElement("input");o.type="submit",o.value=toLanguage("Validate","Valider"),o.style.fontSize=3*iScreenScale+"px",o.style.width=18*iScreenScale+"px",p.appendChild(o),n.appendChild(p),m.appendChild(n);n=document.createElement("input");n.type="button",n.value=toLanguage("Cancel","Annuler"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){m.innerHTML="",oContainers[0].removeChild(m),d(null)},m.appendChild(n),oContainers[0].appendChild(m)}function privateLink(e){var a=document.createElement("div"),t=a.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",a.appendChild(toTitle(toLanguage("Private game","Partie prive"),0)),xhr("privateGame.php",isCustomOptions(e)?"options="+encodeURIComponent(JSON.stringify(e)):null,function(e){if(e){var t=shareLink.url,n=shareLink.params.slice(0);n.push("key="+e);t=t+"?"+n.join("&"),n=document.createElement("div");return n.style.position="absolute",n.style.left="0px",n.style.top=13*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px",n.style.textAlign="center",n.style.fontSize=3*iScreenScale+"px",n.style.color="#CFC",n.innerHTML=language?'The following private link has been generated:<br /><a href="'+t+'" style="color:AAF">'+t+"</a><br /><br />Enjoy game :)":'Le lien priv suivant a t gnr :<br /><a href="'+t+'" style="color:AAF">'+t+"</a><br /><br />Bonne partie :)",a.appendChild(n),!0}return!1}),oContainers[0].appendChild(a)}function selectTypeScreen(){var e=document.createElement("div"),t=e.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black";var n=new Image;if(n.src="images/mariokart.png",n.style.position="absolute",n.style.width=Math.round(42.5*iScreenScale)+"px",n.style.height=5*iScreenScale+"px",n.style.left=Math.round((iWidth-42.5)/2*iScreenScale)+"px",n.style.top=2*iScreenScale+"px",e.appendChild(n),(t=e.style).width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",oContainers[0].appendChild(e),"MK"==page){var a=11;(r=document.createElement("input")).type="button",r.value="Grand Prix",r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=10*iScreenScale+"px",r.style.top=a*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="GP",e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Time trial","Contre-la-montre"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=41*iScreenScale+"px",r.style.top=a*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="CM",e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("VS","Course VS"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=iScreenScale+"px",r.style.top=(a+8)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="VS",e.innerHTML="",oContainers[0].removeChild(e),selectNbJoueurs()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Battle","Bataille"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=50*iScreenScale+"px",r.style.top=(a+8)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="BB",e.innerHTML="",oContainers[0].removeChild(e),selectNbJoueurs()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Track builder","diteur de circuit"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=10*iScreenScale+"px",r.style.top=(a+16)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeCreate()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Online race","Course en ligne"),r.style.fontSize=3*iScreenScale+"px",r.style.position="absolute",r.style.left=41*iScreenScale+"px",r.style.top=(a+16)*iScreenScale+"px",r.style.width=29*iScreenScale+"px",r.onclick=function(){course="VS",e.innerHTML="",oContainers[0].removeChild(e),selectOnlineScreen()},e.appendChild(r),(r=document.createElement("input")).type="button",r.value=toLanguage("Home","Accueil"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=35*iScreenScale+2+"px",r.onclick=function(){document.location.href="index.php"},e.appendChild(r)}else{var o,r,a=12,l=[toLanguage("VS","Course VS")],s=["VS"];for(isSingle||(l.unshift("Grand Prix"),s.unshift("GP")),(hasChallenges()||myCircuit)&&(l.push(toLanguage("Challenges","Dfis")),s.push("CH")),!nid&&isSingle||(l.push(toLanguage("Time Trial","Contre-la-montre")),s.push("CM")),!nid||isSingle&&complete&&!cShared||(l.push(toLanguage("Online race","Course en ligne")),s.push("CL")),!isSingle&&cupScore&&((p=new Image).src="images/cups/cup"+(4-cupScore)+".png",p.style.width=Math.round(4*iScreenScale)+"px",p.style.height=Math.round(4*iScreenScale)+"px",p.style.position="absolute",l.length<5?(p.style.left=3*iScreenScale+"px",p.style.top=Math.round((a+4)*iScreenScale)+"px"):(p.style.left=5*iScreenScale+"px",p.style.top=Math.round(a*iScreenScale)+"px"),p.className="pixelated",e.appendChild(p)),i=0;i<l.length;i++)(r=document.createElement("input")).type="button",r.value=l[i],r.style.position="absolute",l.length<4?(n.style.top=3*iScreenScale+"px",r.style.left=20*iScreenScale+"px",r.style.top=Math.round((a+6.5*i)*iScreenScale)+"px",r.style.width=38*iScreenScale+"px",r.style.fontSize=Math.round(3.5*iScreenScale)+"px"):4==l.length?(n.style.top=4*iScreenScale+"px",r.style.left=(8+i%2*36)*iScreenScale+"px",r.style.top=(a+4+8*Math.floor(i/2))*iScreenScale+"px",r.style.width=28*iScreenScale+"px",r.style.fontSize=3*iScreenScale+"px"):(o=[[10,a-1],[40,a-1],[25,a+7],[10,a+15],[40,a+15]][i],r.style.left=o[0]*iScreenScale+"px",r.style.top=o[1]*iScreenScale+"px",r.style.fontSize=3*iScreenScale+"px",r.style.width=29*iScreenScale+"px"),r.dataset||(r.dataset={}),r.dataset.course=s[i],r.onclick=function(){course=this.dataset.course,"CL"==course?document.location.href="online.php?"+(isMCups?"mid="+nid:(isSingle?complete?"i":"id":complete?"cid":"sid")+"="+nid):(e.innerHTML="",oContainers[0].removeChild(e),"VS"==course?selectNbJoueurs():"CH"==course?selectChallengesScreen():selectPlayerScreen(0))},e.appendChild(r);(r=document.createElement("input")).type="button",r.value=toLanguage("Back","Retour"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=35*iScreenScale+"px",r.onclick=function(){exitCircuit()},e.appendChild(r)}var c=document.createElement("img");c.src="images/english.png",c.alt="En",c.style.position="absolute",c.style.left=68*iScreenScale+"px",c.style.top=35*iScreenScale+"px",c.style.width=4*iScreenScale+"px",c.style.height=Math.round(8*iScreenScale/3)+"px";t=document.createElement("img");t.src="images/french.png",c.alt="Fr",t.style.position="absolute",t.style.left=74*iScreenScale+"px",t.style.top=35*iScreenScale+"px",t.style.width=4*iScreenScale+"px",t.style.height=Math.round(8*iScreenScale/3)+"px";var p=language?c:t,u=language?t:c;p.style.border="solid 1px "+primaryColor,u.style.border="solid 1px transparent",u.style.cursor="pointer",u.onmouseover=function(){u.style.border="solid 1px "+primaryColor},u.onmouseout=function(){u.style.border="solid 1px transparent"},u.onclick=function(){language=!language,xhr("setLanguage.php","nLanguage="+ +language,function(e){return 1==e&&(location.reload(),!0)})},e.appendChild(c),e.appendChild(t),updateMenuMusic(0)}function selectMainPage(){switch(page){case"OL":mId?selectPlayerScreen(0):connexion();break;case"MK":selectTypeScreen();break;case"CI":case"MA":nid?selectTypeScreen():(course="VS",selectNbJoueurs());break;case"BA":case"AR":course="BB",selectNbJoueurs()}}function selectNbJoueurs(e){if(!clSelected||e){var t=document.createElement("div"),e=t.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",t.appendChild(toTitle(toLanguage("Number of players","Nombre de joueurs"),.5));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){isBattle||isCup&&!nid?exitCircuit():(t.innerHTML="",oContainers[0].removeChild(t),selectTypeScreen())},t.appendChild(n);var a=isBattle&&cShared;for(i=1;i<=2;i++)(n=document.createElement("input")).type="button",n.id="select-nbj-"+i,n.value=i+(i<2?"  ":" ")+toLanguage("player","joueur")+(i<2?" ":"s"),n.style.fontSize=4*iScreenScale+"px",n.style.position="absolute",n.style.left=(a?26:27)*iScreenScale+"px",n.style.top=((a?7:10)+i*(a?7:8))*iScreenScale+"px",a&&(n.style.paddingLeft=2*iScreenScale+"px",n.style.paddingRight=2*iScreenScale+"px"),n.onclick=function(){var e;t.innerHTML="",oContainers[0].removeChild(t),"2"==this.value.charAt(0)&&(clSelected=null,(e=oContainers[0].cloneNode(!1)).style.left=12+iWidth*iScreenScale+"px",oContainers.push(e)),selectPlayerScreen(0)},t.appendChild(n);a&&((n=document.createElement("input")).type="button",n.value=toLanguage("Online mode","Mode en ligne"),n.style.fontSize=3*iScreenScale+"px",n.style.position="absolute",n.style.left=26*iScreenScale+"px",n.style.top=30*iScreenScale+"px",n.style.paddingTop=Math.round(.5*iScreenScale)+"px",n.style.paddingBottom=Math.round(.5*iScreenScale)+"px",n.onclick=function(){document.location.href="online.php?"+(complete?"i":"id")+"="+nid+"&battle"},t.appendChild(n)),oContainers[0].appendChild(t),!myCircuit&&!hasChallenges()||nid&&!isBattle||((n=document.createElement("input")).type="button",n.value=toLanguage("Challenges...","Dfis..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.right=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectChallengesScreen()},t.appendChild(n)),updateMenuMusic(0)}else selectPlayerScreen(0)}function selectOnlineScreen(t){var e=document.createElement("div"),n=e.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",e.appendChild(toTitle(toLanguage("Online mode","Mode en ligne"),2));n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeScreen()},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("More options...","Plus d'options..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=60*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateGameOptions(t,function(e){e&&(isCustomOptions(t=e)||(t=null)),selectOnlineScreen(t)})},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=language?"VS mode":"Course VS",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=17*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),openOnlineMode(!1,t)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=language?"Battle mode":"Bataille de ballons",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=25*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),openOnlineMode(!0,t)},e.appendChild(n),oContainers[0].appendChild(e),updateMenuMusic(0)}function openOnlineMode(t,e){e?xhr("onlineOptions.php","options="+encodeURIComponent(JSON.stringify(e)),function(e){return!!e&&(document.location.href="online.php?"+(t?"battle&":"")+"key="+e,!0)}):document.location.href="online.php"+(t?"?battle":"")}function openChallengeEditor(){clId&&!edittingCircuit?document.location.href="challenges.php?cl="+clId:document.location.href=document.location.href.replace(/\/(\w+)\.php\?(.+)$/g,"/challenges.php?page=$1&$2")}function selectTypeCreate(){var i=document.createElement("div"),e=i.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",i.appendChild(toTitle(toLanguage("Track builder","diteur de circuit"),.5));var t=document.createElement("div");t.style.color="white",t.style.fontWeight="normal",t.style.position="absolute",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.left=2*iScreenScale+"px",t.style.top=Math.round(14.5*iScreenScale)+"px",t.style.width=20*iScreenScale+"px",t.style.textAlign="right",t.innerHTML=toLanguage("Quick mode :","Mode simplifi :"),i.appendChild(t);e=document.createElement("input");e.type="button",e.value="Circuit",e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=24*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=10*iScreenScale+"px",e.onclick=function(){document.location.href="create.php"},i.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Arena","Arne"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=36*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=10*iScreenScale+"px",e.onclick=function(){document.location.href="arene.php"},i.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Cup","Coupe"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=48*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=10*iScreenScale+"px",e.onclick=function(){document.location.href="simplecup.php"},i.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Multi Cup","Multicoupe"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=60*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=16*iScreenScale+"px",e.onclick=function(){document.location.href="simplecups.php"},i.appendChild(e),(t=document.createElement("div")).style.position="absolute",t.style.color="white",t.style.fontWeight="normal",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.left=2*iScreenScale+"px",t.style.top=Math.round(21.5*iScreenScale)+"px",t.style.width=20*iScreenScale+"px",t.style.textAlign="right",t.innerHTML=toLanguage("Complete mode :","Mode complet :"),i.appendChild(t),(e=document.createElement("input")).type="button",e.value="Circuit",e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=24*iScreenScale+"px",e.style.top=Math.round(21*iScreenScale)+"px",e.style.width=10*iScreenScale+"px",e.onclick=function(){document.location.href="draw.php"},i.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Arena","Arne"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=36*iScreenScale+"px",e.style.top=Math.round(21*iScreenScale)+"px",e.style.width=10*iScreenScale+"px",e.onclick=function(){document.location.href="course.php"},i.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Cup","Coupe"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=48*iScreenScale+"px",e.style.top=Math.round(21*iScreenScale)+"px",e.style.width=10*iScreenScale+"px",e.onclick=function(){document.location.href="completecup.php"},i.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Multi Cup","Multicoupe"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=60*iScreenScale+"px",e.style.top=Math.round(21*iScreenScale)+"px",e.style.width=16*iScreenScale+"px",e.onclick=function(){document.location.href="completecups.php"},i.appendChild(e);t=document.createElement("a");t.style.color="#CCF",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.position="absolute",t.style.left=24*iScreenScale+"px",t.style.top=Math.round(29.5*iScreenScale)+"px",t.href="#null",t.innerHTML=toLanguage("Help","Aide"),t.onclick=function(){var t=document.createElement("div");t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.width=iScreenScale*iWidth+"px",t.style.height=iScreenScale*iHeight+"px",t.style.backgroundColor="rgba(0,0,0,0.7)",t.style.fontWeight="normal";var e=document.createElement("table");e.style.position="absolute",e.style.left=30*iScreenScale+"px",e.style.width=50*iScreenScale+"px",e.style.top=2*-iScreenScale+"px",e.style.color="#333",e.style.opacity=.93,e.style.textAlign="center",e.style.borderSpacing="0 "+5*iScreenScale+"px",e.style.fontSize=2*iScreenScale+"px";var n=document.createElement("tr");n.style.backgroundColor="#CCC";var a=document.createElement("td");language?a.innerHTML="<strong>Quick mode:</strong> create a track in a few clics thanks to ready-made pieces":a.innerHTML="<strong>Mode simplifi :</strong> crez un circuit en quelques clics grce  des pices toutes faites",a.style.padding=2*iScreenScale+"px "+3*iScreenScale+"px",n.appendChild(a),(a=document.createElement("td")).style.width=10*iScreenScale+"px",a.style.height=14*iScreenScale+"px",a.innerHTML='<img src="images/help/mode-simple.png" style="height: 100%" alt="Simplify" />',n.appendChild(a),e.appendChild(n),(n=document.createElement("tr")).style.backgroundColor="#CCC";a=document.createElement("td");language?a.innerHTML="<strong>Complete mode:</strong> create entierely the track from an image you draw yourself":a.innerHTML="<strong>Mode complet :</strong> crez entirement le circuit  partir d'une image dessine par vous-mme",a.style.padding=2*iScreenScale+"px "+3*iScreenScale+"px",n.appendChild(a),(a=document.createElement("td")).style.width=10*iScreenScale+"px",a.style.height=14*iScreenScale+"px",a.innerHTML='<img src="images/help/mode-complete.png" style="height: 100%" alt="Complify" />',n.appendChild(a),e.appendChild(n),t.appendChild(e);var o=document.createElement("div");o.style.color="white",o.style.position="absolute",o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.right=(iWidth-22.9)*iScreenScale+"px",o.style.top=Math.round(14*iScreenScale)+"px",o.style.textAlign="right",o.style.border="solid "+Math.round(.4*iScreenScale)+"px #99C",o.style.padding=Math.round(.1*iScreenScale)+"px "+Math.round(.5*iScreenScale)+"px",o.innerHTML=toLanguage("Quick mode :","Mode simplifi :"),t.appendChild(o);a=.3*Math.PI,n=document.createElement("div");n.style.position="absolute",n.style.left=21*iScreenScale+"px",n.style.top=Math.round(11.15*iScreenScale)+"px",n.style.width=Math.round(.5*iScreenScale)+"px",n.style.height=Math.round(3/Math.cos(a)*iScreenScale)+"px",n.style.backgroundColor="#99C",n.style.transform=n.style.WebkitTransform=n.style.MozTransform="rotate("+Math.round(180*a/Math.PI)+"deg)",n.style.transformOrigin=n.style.WebkitTransformOrigin=n.style.MozTransformOrigin="top center",t.appendChild(n);e=document.createElement("div");e.style.position="absolute",e.style.left=21*iScreenScale+"px",e.style.top=Math.round(11.05*iScreenScale)+"px",e.style.width=Math.round(9*iScreenScale)+"px",e.style.height=Math.round(.4*iScreenScale)+"px",e.style.backgroundColor="#99C",t.appendChild(e);o=document.createElement("div");o.style.color="white",o.style.position="absolute",o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.right=(iWidth-22.9)*iScreenScale+"px",o.style.top=Math.round(21*iScreenScale)+"px",o.style.textAlign="right",o.style.border="solid "+Math.round(.4*iScreenScale)+"px #99C",o.style.padding=Math.round(.1*iScreenScale)+"px "+Math.round(.5*iScreenScale)+"px",o.innerHTML=toLanguage("Complete mode :","Mode complet :"),t.appendChild(o);a=.3*Math.PI;(n=document.createElement("div")).style.position="absolute",n.style.left=21*iScreenScale+"px",n.style.top=Math.round(22.35*iScreenScale)+"px",n.style.width=Math.round(.5*iScreenScale)+"px",n.style.height=Math.round(3/Math.cos(a)*iScreenScale)+"px",n.style.backgroundColor="#99C",n.style.transform=n.style.WebkitTransform=n.style.MozTransform="rotate("+Math.round(180*-a/Math.PI)+"deg)",n.style.transformOrigin=n.style.WebkitTransformOrigin=n.style.MozTransformOrigin="bottom center",t.appendChild(n),(e=document.createElement("div")).style.position="absolute",e.style.left=21*iScreenScale+"px",e.style.top=Math.round(27.3*iScreenScale)+"px",e.style.width=Math.round(9*iScreenScale)+"px",e.style.height=Math.round(.4*iScreenScale)+"px",e.style.backgroundColor="#99C",t.appendChild(e);e=document.createElement("input");return e.type="button",e.style.position="absolute",e.style.left=8*iScreenScale+"px",e.style.bottom=5*iScreenScale+"px",e.style.fontSize=3*iScreenScale+"px",e.value="Ok ",e.onclick=function(){for(;t.childNodes.length;)t.removeChild(t.firstChild);var e=document.createElement("div");e.style.position="absolute",e.style.left=29*iScreenScale+"px",e.style.top=12*iScreenScale+"px",e.style.width=Math.round(.5*iScreenScale)+"px",e.style.height=3*iScreenScale+"px",e.style.backgroundColor="#99C",t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=41*iScreenScale+"px",e.style.top=17*iScreenScale+"px",e.style.width=Math.round(.5*iScreenScale)+"px",e.style.height=3*iScreenScale+"px",e.style.backgroundColor="#99C",t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=53*iScreenScale+"px",e.style.top=12*iScreenScale+"px",e.style.width=Math.round(.5*iScreenScale)+"px",e.style.height=3*iScreenScale+"px",e.style.backgroundColor="#99C",t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=68*iScreenScale+"px",e.style.top=17*iScreenScale+"px",e.style.width=Math.round(.5*iScreenScale)+"px",e.style.height=3*iScreenScale+"px",e.style.backgroundColor="#99C",t.appendChild(e);e=document.createElement("input");e.type="button",e.value="Circuit",e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=24*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=10*iScreenScale+"px",e.style.backgroundColor="#372F1A",e.style.color="#F6DA14",t.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Arena","Arne"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=36*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=10*iScreenScale+"px",e.style.backgroundColor="#372F1A",e.style.color="#F6DA14",t.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Cup","Coupe"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=48*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=10*iScreenScale+"px",e.style.backgroundColor="#372F1A",e.style.color="#F6DA14",t.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Multi Cup","Multicoupe"),e.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.style.position="absolute",e.style.left=60*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=16*iScreenScale+"px",e.style.backgroundColor="#372F1A",e.style.color="#F6DA14",t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=24*iScreenScale+"px",e.style.top=14*iScreenScale+"px",e.style.width=52*iScreenScale+"px",e.style.height=4*iScreenScale+"px",t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=12*iScreenScale+"px",e.style.bottom=(iHeight-12)*iScreenScale+"px",e.style.width=20*iScreenScale+"px",e.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",e.style.backgroundColor="#CCC",e.style.color="#333",e.style.fontSize=2*iScreenScale+"px",language?e.innerHTML='<strong>Circuit:</strong> Create a track and play against your opponents in <strong style="color:#393">VS mode</strong>':e.innerHTML='<strong>Circuit :</strong> Crez une piste et affrontez vos adversaires en <strong style="color:#393">course VS</strong>',t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=28*iScreenScale+"px",e.style.top=20*iScreenScale+"px",e.style.width=20*iScreenScale+"px",e.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",e.style.backgroundColor="#CCC",e.style.color="#333",e.style.fontSize=2*iScreenScale+"px",language?e.innerHTML='<strong>Arena:</strong> Create a battle course and play in mode <strong style="color:#393">Balloon battle</strong>':e.innerHTML='<strong>Arne :</strong> Crez une zone de combat et jouez en mode <strong style="color:#393">bataille de ballons</strong>',t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=44*iScreenScale+"px",e.style.bottom=(iHeight-12)*iScreenScale+"px",e.style.width=20*iScreenScale+"px",e.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",e.style.backgroundColor="#CCC",e.style.color="#333",e.style.fontSize=2*iScreenScale+"px",language?e.innerHTML='<strong>Cup:</strong> Create a <strong style="color:#393">Grand Prix</strong> cup from 4 of your circuits':e.innerHTML='<strong>Coupe :</strong> Crer une coupe <strong style="color:#393">Grand Prix</strong>  partir de 4 de vos circuits',t.appendChild(e);e=document.createElement("div");e.style.position="absolute",e.style.left=58*iScreenScale+"px",e.style.top=20*iScreenScale+"px",e.style.width=20*iScreenScale+"px",e.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",e.style.backgroundColor="#CCC",e.style.color="#333",e.style.fontSize=2*iScreenScale+"px",language?e.innerHTML='<strong>Multicup:</strong> Merge <strong style="color:#393">several cups</strong> in a same page to form a series!':e.innerHTML='<strong>Multicoupe :</strong> Runissez <strong style="color:#393">plusieurs coupes</strong> sur une seule page pour former une srie !',t.appendChild(e);e=document.createElement("input");e.type="button",e.style.position="absolute",e.style.left=8*iScreenScale+"px",e.style.bottom=5*iScreenScale+"px",e.style.fontSize=3*iScreenScale+"px",e.value="Ok ",e.onclick=function(){i.removeChild(t)},t.appendChild(e)},t.appendChild(e),i.appendChild(t),!1},i.appendChild(t),(t=document.createElement("a")).style.color="#CCF",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.position="absolute",t.style.left=34*iScreenScale+"px",t.style.top=Math.round(29.5*iScreenScale)+"px",t.href="creations.php",t.innerHTML=toLanguage("List of creations","Liste des crations"),i.appendChild(t),oContainers[0].appendChild(i),(e=document.createElement("input")).type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=35*iScreenScale+"px",e.onclick=function(){i.innerHTML="",oContainers[0].removeChild(i),selectTypeScreen()},i.appendChild(e),updateMenuMusic(0)}function selectPlayerScreen(IdJ,newP,nbSels){var isCustomSel=void 0!==nbSels,force=-1===IdJ;if(force&&(IdJ=0),!IdJ){for(joueurs in strPlayer=[],aPlayers=[],cp)aPlayers.push(joueurs);updateCommandSheet()}var itemMode=getItemMode(),modeItemDistributions=itemDistributions[itemMode].concat(customItemDistrib[itemMode]);fInfos=fInfos||{};var oScr=document.createElement("div");newP&&(oScr.style.visibility="hidden");var oStyle=oScr.style;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black";var shrinkAll=!(isOnline||"VS"!=course&&"BB"!=course||clSelected),oTitle,oMsg,oMsg,oTitle;isCustomSel?(oMsg=isOnline?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ-1):IdJ>=oContainers.length?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ+1-oContainers.length):1==oContainers.length?toLanguage("Choose player","Choisissez joueur"):toLanguage("Choose player ","Choisissez joueur ")+(IdJ+1),oTitle=toTitle(oMsg,-1),oTitle.style.color="#F90"):oTitle=toTitle(toLanguage("Choose a player","Choisissez un joueur"),-1),shrinkAll&&(oTitle.style.fontSize=Math.round(7.5*iScreenScale)+"px"),oScr.appendChild(oTitle);var baseY=shrinkAll?8:10,cTable=document.createElement("table");cTable.style.display="none",cTable.style.position="absolute",cTable.style.zIndex=2,cTable.style.top=36*iScreenScale+16+"px",cTable.style.left=25*iScreenScale-60+"px",cTable.style.textAlign="left",cTable.style.fontSize=2*iScreenScale+"px",cTable.style.color="white",cTable.style.backgroundColor="black",cTable.style.backgroundColor="rgba(0,0,0, 0.8)",cTable.setAttribute("cellpadding",2),cTable.setAttribute("cellspacing",2),document.body.appendChild(cTable);var hTr=document.createElement("tr"),hTd1=document.createElement("td");hTd1.innerHTML="&nbsp;",hTr.appendChild(hTd1);var hTd2=document.createElement("td");hTd2.className="maj",hTd2.innerHTML="&nbsp;",hTd2.style.fontWeight="bold",hTr.appendChild(hTd2),cTable.appendChild(hTr);for(var sCaracteristiques=[toLanguage("Acceleration","Acclration"),toLanguage("Max speed","Vitesse max"),toLanguage("Handling","Maniabilit"),toLanguage("Weight","Poids")],dCaracteristiques=new Array,i=0,rotateHandler;i<sCaracteristiques.length;i++){var oTr=document.createElement("tr"),oTd1=document.createElement("td");oTd1.className="rgt",oTd1.innerHTML=sCaracteristiques[i]+" :",oTr.appendChild(oTd1);var oTd2=document.createElement("td");dCaracteristiques[i]=document.createElement("div"),dCaracteristiques[i].style.backgroundColor="#838057",dCaracteristiques[i].style.border="solid 1px silver",dCaracteristiques[i].style.height=2*iScreenScale+"px",dCaracteristiques[i].innerHTML="&nbsp;",oTd2.appendChild(dCaracteristiques[i]),oTr.appendChild(oTd2),cTable.appendChild(oTr)}var jScreenScale=iScreenScale,oItemSelect;function tourner(e){var t=Math.round(5*jScreenScale*(e.naturalWidth/768)),n=parseFloat(e.style.left);-21*t<n?e.style.left=n-t+"px":e.naturalWidth?(t=Math.min(5*e.naturalWidth/768,5.8),e.style.left=-Math.round(jScreenScale*(5*e.naturalWidth/768-t)/2)+"px"):e.style.left="0px",rotateHandler=setTimeout(function(){tourner(e)},100)}function createPersoSelector(e){var t=document.createElement("div");t.style.backgroundColor="#78D0F8",t.style.position="absolute",t.style.width=5*jScreenScale+"px",t.style.height=5*jScreenScale+"px",t.style.borderTop="double 4px black",t.style.borderLeft="double 4px #F8F8F8",t.style.borderRight="double 4px #F8F8F8",t.style.borderBottom="solid 5px #00B800";var p=document.createElement("div");p.style.position="absolute",p.style.display="inline-block",p.style.width=5*jScreenScale+"px",p.style.height=5*jScreenScale+"px",p.style.overflow="hidden";var n=new Image;if(n.style.height=5*jScreenScale+"px",n.style.position="absolute",n.className="pixelated",pUnlocked[e]){for(var a=!0,o=aPlayers[e],i=0;i<strPlayer.length;i++)if(strPlayer[i]==o){a=!1;break}n.src=(a?getSpriteSrc:getStarSrc)(o),n.alt=aPlayers[e],n.nb=e,n.style.left=-30*jScreenScale+"px",n.style.cursor="pointer",n.id="perso-selector-"+o,n.j=IdJ,n.onload=function(){var e=Math.min(5*this.naturalWidth/768,5.8),t=Math.min(5*this.naturalHeight/32,5.8);p.style.width=Math.round(e*jScreenScale)+"px",p.style.height=Math.round(t*jScreenScale)+"px",this.style.width=24*Math.round(5*this.naturalWidth/768*jScreenScale)+"px",this.style.height=Math.round(5*this.naturalHeight/32*jScreenScale)+"px",this.style.left=-Math.round(6*Math.round(5*jScreenScale*this.naturalWidth/768)+jScreenScale*(5*this.naturalWidth/768-e)/2)+"px",this.style.top=Math.round((t-5*this.naturalHeight/32)*jScreenScale/2)+"px",p.style.left=Math.round((5-e)/2*jScreenScale)+"px",p.style.top=Math.round(1+(5-t)/2*jScreenScale)+"px"},p.onmouseover=function(){cTable.style.display="block";var e=p.firstChild;hTd2.innerHTML=toPerso(e.alt);for(var t=0;t<dCaracteristiques.length;t++)dCaracteristiques[t].style.width=5*iScreenScale*(8*cp[e.alt][t]+1)+"px";clearTimeout(rotateHandler),tourner(e)},p.onmouseout=function(){cTable.style.display="none";var e,t=p.firstChild;t.naturalWidth?(e=Math.min(5*t.naturalWidth/768,5.8),t.style.left=-Math.round(6*Math.round(5*jScreenScale*t.naturalWidth/768)+jScreenScale*(5*t.naturalWidth/768-e)/2)+"px"):t.style.left=-30*jScreenScale+"px",clearTimeout(rotateHandler)},p.onclick=function(){clearTimeout(rotateHandler);var e=p.firstChild;strPlayer[e.j]=e.alt;var t="";if(isOnline||(t="VS"==course?(iDificulty=4+.5*selectedDifficulty,"difficulty="+selectedDifficulty+"&players="+fInfos.nbPlayers+"&team="+fInfos.teams):"players="+fInfos.nbPlayers+"&team="+fInfos.teams),oScr.innerHTML="",e.j++,oContainers[0].removeChild(oScr),document.body.removeChild(cTable),addMyPersos=function(){},oItemSelect?(selectedItemDistrib=modeItemDistributions[oItemSelect.value].value,localStorage.setItem("itemset."+itemMode,+oItemSelect.value)):selectedItemDistrib=modeItemDistributions[0].value,e.j==(isCustomSel?nbSels:oContainers.length)){if(isOnline){if(isCustomSel){var n=document.querySelector("[data-cpu-chars]");return strPlayer.splice(0,2),n.loadCpuChars(strPlayer),void(strPlayer.length=0)}aPlayers=[strPlayer[0]]}else if("CM"==course)aPlayers=[];else{if(aPlayers=[],isCustomSel){for(var a=strPlayer.length-1;a>=oContainers.length;a--)aPlayers.push(strPlayer[a]);strPlayer.splice(oContainers.length)}else{a=0;for(joueurs in cp)pUnlocked[a]&&(aPlayers.push(joueurs),a++);if(aPlayers.sort(function(){return.5-Math.random()}),aPlayers.length<fInfos.nbPlayers){var o=aPlayers.length;aPlayers.length=aPlayers.length*Math.ceil(fInfos.nbPlayers/aPlayers.length);for(a=o;a<aPlayers.length;a++)aPlayers[a]=aPlayers[a%o]}else for(a=0;a<aPlayers.length;a++)for(var i=aPlayers[a],r=0;r<strPlayer.length;r++)if(strPlayer[r]==i){aPlayers.splice(a,1),a--;break}n="GP"!=course?aPlayers.length-fInfos.nbPlayers+strPlayer.length:aPlayers.length-7;aPlayers.splice(0,n)}aPlaces=[],resetScores(),"GP"!=course&&(selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,xhr("updateCourseOptions.php",t,function(e){return 1==e}))}if(isOnline){var l,s={},c={minPlayers:1,maxPlayers:1,localScore:1,friendly:1,cpu:1,cpuLevel:1,cpuNames:1,cpuChars:1};for(l in shareLink.options)c[l]||(s[l]=shareLink.options[l]);(isCustomOptions(s)&&!shareLink.accepted&&shareLink.player!=identifiant?acceptRulesScreen:searchCourse)()}else isTeamPlay()?selectTeamScreen(0):selectTrackScreen()}else selectPlayerScreen(e.j,void 0,nbSels);e=/^cp-\w+-(\d+)$/g.exec(e.alt);e&&xhr("selectPerso.php","id="+e[1],function(){return!0})}}else n.src="images/kart_locked.png";return p.appendChild(n),t.appendChild(p),t}for(var i=0;i<nBasePersos;i++){var oDiv=createPersoSelector(i);oDiv.style.left=Math.round((i%8*7.2+8)*iScreenScale)+"px",oDiv.style.top=(baseY+7*Math.floor(i/8))*iScreenScale-8+"px",oScr.appendChild(oDiv)}var pDiv=document.createElement("div");pDiv.style.backgroundColor="#78D0F8",pDiv.style.position="absolute",pDiv.style.width=5*iScreenScale+"px",pDiv.style.height=5*iScreenScale+"px",pDiv.style.left=67*iScreenScale+"px",pDiv.style.top=(baseY+14)*iScreenScale-8+"px",pDiv.style.borderTop="double 4px black",pDiv.style.borderLeft="double 4px #F8F8F8",pDiv.style.borderRight="double 4px #F8F8F8",pDiv.style.borderBottom="solid 5px #00B800",pDiv.style.overflow="hidden";var pPImg=new Image,aDeconnexion,eClassement,oPInput,oPInput,oClassement,oStepCtn,oStepBack,progress,lastProgress,oStepValue;if(pPImg.style.height=5*iScreenScale+"px",pPImg.style.position="absolute",pPImg.src="images/kart_persos.png",pPImg.style.cursor="pointer",pPImg.title=language?"Character editor":"diteur de personnages",pPImg.className="pixelated",pPImg.onclick=function(){window.open("choosePerso.php","chose","scrollbars=1, resizable=1, width=500, height=500")},pDiv.appendChild(pPImg),oScr.appendChild(pDiv),oContainers[0].appendChild(oScr),isOnline&&(isCustomSel||(aDeconnexion=document.createElement("a"),aDeconnexion.style.color="white",aDeconnexion.style.fontSize=2*iScreenScale+"px",aDeconnexion.style.position="absolute",aDeconnexion.style.left=24*iScreenScale+"px",aDeconnexion.style.top=34*iScreenScale+"px",aDeconnexion.innerHTML=toLanguage("Deconnection","Dconnexion"),aDeconnexion.href="#null",aDeconnexion.onclick=function(){return oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),displayCommands(),mPseudo="",mCode="",connexion(),xhr("deco.php",null,function(){return!0}),!1},oScr.appendChild(aDeconnexion),eClassement=document.createElement("a"),eClassement.style.fontSize=2*iScreenScale+"px",eClassement.style.position="absolute",eClassement.style.left=41*iScreenScale+"px",eClassement.style.top=34*iScreenScale+"px",eClassement.innerHTML=toLanguage("Ranking","Classement"),shareLink.options&&shareLink.options.localScore?(eClassement.title=toLanguage("Private game ranking","Classement partie prive"),eClassement.style.color="#CF8",eClassement.setAttribute("href","localscores.php"+window.location.search)):(eClassement.style.color="white",eClassement.setAttribute("href","bestscores.php"+("BB"==course?"?battle":""))),oScr.appendChild(eClassement),shareLink.key?shareLink.player==identifiant&&(oPInput=document.createElement("input"),oPInput.type="button",oPInput.value=toLanguage("Private game options...","Options partie prive..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=56*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGameOptions(shareLink.options,function(t){t&&(isCustomOptions(t)||isCustomOptions(shareLink.options))?xhr("privateGameOptions.php","key="+shareLink.key+"&options="+encodeURIComponent(JSON.stringify(t)),function(e){return 1==e&&(shareLink.options||(shareLink.options={}),shareLink.options.team=t.team,shareLink.options.manualTeams=t.manualTeams,shareLink.options.localScore=t.localScore,shareLink.options.friendly=t.friendly,shareLink.options.minPlayers=t.minPlayers,shareLink.options.maxPlayers=t.maxPlayers,shareLink.options.itemDistrib=t.itemDistrib,shareLink.options.cpu=t.cpu,shareLink.options.cpuCount=t.cpuCount,shareLink.options.cpuLevel=t.cpuLevel,shareLink.options.cpuNames=t.cpuNames,shareLink.options.cpuChars=t.cpuChars,selectedTeams=t.team,selectPlayerScreen(0),!0)}):selectPlayerScreen(0)})},oScr.appendChild(oPInput)):(oPInput=document.createElement("input"),oPInput.type="button",oPInput.value=toLanguage("Private game...","Partie prive..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=62*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGame()},oScr.appendChild(oPInput)))),isOnline||"VS"!=course&&"BB"!=course){"CM"==course&&isSingle&&(oClassement=document.createElement("input"),oClassement.type="button",oClassement.value=toLanguage("Rankings","Classement"),oClassement.style.position="absolute",oClassement.style.fontSize=3*iScreenScale+"px",oClassement.style.position="absolute",oClassement.style.left=30*iScreenScale-10+"px",oClassement.style.top=32*iScreenScale+"px",oClassement.style.width=20*iScreenScale+"px",oClassement.onclick=openRankings,oScr.appendChild(oClassement))}else{var oForm=document.createElement("form");if(oForm.onsubmit=function(){return!1},oForm.style.position="absolute",oForm.style.top=(baseY+21)*iScreenScale-5+"px",oForm.style.left=18*iScreenScale+"px",oForm.style.fontSize=2*iScreenScale+"px",oForm.style.zIndex=2,IdJ||newP||(iDificulty=selectedDifficulty,fInfos.nbPlayers=selectedPlayers,fInfos.teams=selectedTeams),"VS"==course){oForm.appendChild(document.createTextNode(toLanguage("Difficulty: ","Difficult : ")));var iDifficulties=[toLanguage("Easy","Facile"),toLanguage("Medium","Moyen"),toLanguage("Difficult","Difficile")],oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width="auto",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.style.marginRight="10px",oSelect.onchange=function(){selectedDifficulty=this.selectedIndex};for(var i=0;i<iDifficulties.length;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=iDifficulties[i],selectedDifficulty==i&&(oOption.selected="selected"),oSelect.appendChild(oOption)}oForm.appendChild(oSelect)}else iDificulty=4.5;oForm.appendChild(document.createTextNode(toLanguage("Teams: ","quipes : ")));var oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width=15*iScreenScale+15+"px",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.onchange=function(){fInfos.teams=this.selectedIndex};for(var iTeams=[toLanguage("No teams","Chacun pour soi"),toLanguage("Team Game","Match par quipes")],i=0;i<iTeams.length;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=iTeams[i],selectedTeams==i&&(oOption.selected="selected"),oSelect.appendChild(oOption)}oForm.appendChild(oSelect),oForm.appendChild(document.createElement("br")),oForm.appendChild(document.createTextNode(toLanguage("Number of participants","Nombre de participants ")+": "));var oSelect=document.createElement("select");function setCustomValue(e,t){for(var n=e.getElementsByTagName("option"),a=0;a<n.length;a++){var o=+n[a].value;if(o==t){e.selectedIndex=a;break}if(-1==o||t<o){o=document.createElement("option");o.value=t,o.innerHTML=t,e.insertBefore(o,n[a]),e.selectedIndex=a;break}}e.value=t}oSelect.name="nbj",oSelect.style.width=3*iScreenScale+20+"px",oSelect.style.fontSize=2*iScreenScale+"px";for(var i=2;i<=8;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=i,oSelect.appendChild(oOption)}var oOption=document.createElement("option");oOption.value=-1,oOption.innerHTML=toLanguage("More...","Plus..."),oSelect.appendChild(oOption),setCustomValue(oSelect,fInfos.nbPlayers),oSelect.onchange=function(){var e;-1==this.value&&(e=parseInt(prompt(toLanguage("Enter number","Nombre de joueurs :"))),!isNaN(e)&&1<e?setCustomValue(this,Math.min(e,999)):(isNaN(e)||alert(toLanguage("Invalid value","Valeur invalide")),setCustomValue(this,fInfos.nbPlayers))),fInfos.nbPlayers=parseInt(this.value)},oForm.appendChild(oSelect);var oChoosePerso=document.createElement("a");if(oChoosePerso.innerHTML=toLanguage("Choose characters...","Choix des persos..."),oChoosePerso.href="#null",oChoosePerso.style.display="inline-block",oChoosePerso.style.marginLeft=2*iScreenScale+"px",oChoosePerso.style.color="white",oChoosePerso.onclick=function(){return iDificulty=selectedDifficulty,selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,oItemSelect&&localStorage.setItem("itemset."+itemMode,+oItemSelect.value),clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,!1,fInfos.nbPlayers),!1},oForm.appendChild(oChoosePerso),!clSelected){oForm.appendChild(document.createElement("br")),oForm.appendChild(document.createTextNode(toLanguage("Items","Objets ")+": ")),oItemSelect=document.createElement("select"),oItemSelect.name="item",oItemSelect.style.width=16*iScreenScale+"px",oItemSelect.style.fontSize=2*iScreenScale+"px";for(var i=0;i<modeItemDistributions.length;i++){var oItemOption=document.createElement("option");oItemOption.value=i,oItemOption.innerHTML=modeItemDistributions[i].name,oItemSelect.appendChild(oItemOption)}var oItemOption=document.createElement("option");oItemOption.value=-1,oItemOption.innerHTML=toLanguage("Custom...","Personnalis..."),oItemSelect.appendChild(oItemOption),oItemSelect.currentValue=oItemSelect.value,oItemSelect.onchange=function(){-1==this.value?(this.value=this.currentValue,selectedItemDistrib=modeItemDistributions[this.currentValue].value,selectItemScreen(oScr,function(e){customItemDistrib[itemMode].push(e),localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,modeItemDistributions.length),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels)})):(this.currentValue=this.value,selectedItemDistrib=modeItemDistributions[this.value].value,oItemCustomActions.style.display=this.value>=itemDistributions[itemMode].length?"inline-block":"none")},oForm.appendChild(oItemSelect);var oItemCustomActions=document.createElement("div");oItemCustomActions.style.display="none",oItemCustomActions.style.marginLeft=+iScreenScale+"px";var oItemCustomEdit=document.createElement("input");oItemCustomEdit.type="button",oItemCustomEdit.style.backgroundColor="rgb(51, 160, 51)",oItemCustomEdit.style.color="white",oItemCustomEdit.style.fontSize=2*iScreenScale+"px",oItemCustomEdit.value="",oItemCustomEdit.onclick=function(){selectItemScreen(oScr,function(e){customItemDistrib[itemMode][oItemSelect.value-itemDistributions[itemMode].length]=e,localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,+oItemSelect.value),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels)},modeItemDistributions[oItemSelect.value])},oItemCustomActions.appendChild(oItemCustomEdit);var oItemCustomDel=document.createElement("input");oItemCustomDel.type="button",oItemCustomDel.style.marginLeft=Math.round(.5*iScreenScale)+"px",oItemCustomDel.style.backgroundColor="rgb(204, 51, 51)",oItemCustomDel.style.color="white",oItemCustomDel.value="",oItemCustomDel.style.fontSize=2*iScreenScale+"px",oItemCustomDel.onclick=function(){var e=modeItemDistributions[oItemSelect.value].name;confirm(toLanguage('Delete item set "'+e+'"?','Supprimer le set "'+e+'" ?'))&&(customItemDistrib[itemMode].splice(oItemSelect.value-itemDistributions[itemMode].length,1),localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,0),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels))},oItemCustomActions.appendChild(oItemCustomDel),oForm.appendChild(oItemCustomActions);var selectedItemSetId=localStorage.getItem("itemset."+itemMode);selectedItemSetId&&(oItemSelect.selectedIndex=selectedItemSetId,oItemSelect.onchange())}oScr.appendChild(oForm),isCustomSel&&(oForm.style.display="none")}isCustomSel&&(oStepCtn=document.createElement("div"),oStepCtn.style.position="absolute",oStepCtn.style.left="0px",oStepCtn.style.width=iWidth*iScreenScale+"px",oStepCtn.style.textAlign="center",oStepCtn.style.top=(baseY+22)*iScreenScale+"px",oStepBack=document.createElement("input"),oStepBack.type="button",oStepBack.style.fontSize=3*iScreenScale+"px",progress=IdJ,lastProgress=nbSels,isOnline&&(progress-=2,lastProgress-=2),progress?(oStepBack.value="",oStepBack.style.marginRight=3*iScreenScale+"px"):(oStepBack.style.width="0px",oStepBack.value="",oStepBack.style.visibility="hidden"),oStepBack.onclick=function(){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),strPlayer.pop(),selectPlayerScreen(IdJ-1,!1,nbSels)},oStepCtn.appendChild(oStepBack),oStepValue=document.createElement("span"),oStepValue.style.fontSize=3*iScreenScale+"px",oStepValue.innerHTML=toLanguage("Character","Perso")+" "+(progress+1)+"/"+lastProgress,oStepCtn.appendChild(oStepValue),oStepBack.style.color=oStepValue.style.color="#F90",oScr.appendChild(oStepCtn));var oPInput=document.createElement("input");if(oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=35*iScreenScale+"px",isOnline&&(oPInput.style.top=34*iScreenScale+"px"),oPInput.onclick=function(){if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),isCustomSel)isOnline?(strPlayer.length=0,document.querySelector("[data-cpu-chars]").loadCpuChars(null)):selectPlayerScreen(0);else if(displayCommands(),isOnline)quitter();else if("VS"==course||"BB"==course){for(var e=1;e<oContainers.length;e++)oContainers.splice(e,1);selectNbJoueurs(!0)}else selectTypeScreen()},isCustomSel&&(oPInput.style.color="#F90"),oScr.appendChild(oPInput),clSelected&&clSelected.autoset&&clSelected.autoset.selectedPerso&&!force){var persoSelector=document.getElementById("perso-selector-"+clSelected.autoset.selectedPerso);if(persoSelector&&persoSelector.parentNode&&persoSelector.parentNode.onclick)return void persoSelector.parentNode.onclick()}function addMyPersos(e){var t=cp;for(n in cp={},baseCp)cp[n]=baseCp[n];customPersos={};for(var n,a=0;a<e.length;a++){var o=e[a];cp[o.sprites]=[o.acceleration,o.speed,o.handling,o.mass],customPersos[o.sprites]=o}for(n in aPlayers=[],cp)aPlayers.push(n);for(n in t)cp[n]||(cp[n]=t[n]);for(a=0;a<e.length;a++){var i=nBasePersos+a;pUnlocked[i]=1;i=createPersoSelector(i);if(newP&&!a&&i.firstChild.onclick)return void i.firstChild.onclick();i.style.left=67*iScreenScale+"px",i.style.top=(baseY+7*a)*iScreenScale-8+"px",oScr.insertBefore(i,pDiv)}oScr.style.visibility="visible"}newP&&(myPersosCache=void 0),myPersosCache?addMyPersos(myPersosCache):xhr("myPersos.php",null,function(res){var newPersos=[];try{newPersos=eval(res)}catch(e){}return newPersos.length?(addMyPersos(newPersos),myPersosCache=newPersos,!0):(oScr.style.visibility="visible",!0)}),selectPerso=function(e){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),xhr("selectPerso.php","id="+e,function(e){return selectPlayerScreen(IdJ,!0,nbSels),!0})},updateMenuMusic(isOnline?0:1)}function selectItemScreen(t,n,e){e=e||{};var a=document.createElement("div");a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.left="0px",a.style.top="0px",a.style.zIndex=2,a.style.backgroundColor="#000";var c=document.createElement("table");c.style.color="white",c.style.textAlign="center",c.style.position="absolute",c.style.left=5*iScreenScale+"px",c.setAttribute("cellpadding",0),c.setAttribute("cellspacing",0);for(var o=getItemMode(),i=itemDistributions[o][0].value,p={},r=0;r<i.length;r++)for(var l in i[r])p[l]=1;var u=selectedItemDistrib;u.length||(u=i),p=Object.keys(p),(d=document.createElement("tr")).appendChild(document.createElement("td"));for(r=0;r<p.length;r++){(y=document.createElement("td")).style.paddingBottom=Math.round(iScreenScale/2)+"px";var s=document.createElement("img");s.src="images/items/"+p[r]+".png",s.alt=p[r],s.style.width=2*iScreenScale+"px",y.appendChild(s),d.appendChild(y)}c.appendChild(d);for(r=0;r<u.length;r++){var d=document.createElement("tr");(y=document.createElement("td")).style.paddingRight=iScreenScale+"px",y.style.fontSize=2*iScreenScale+"px",y.innerHTML="#"+(r+1),d.appendChild(y);for(var m=u[r],h=0;h<p.length;h++){var y,g=p[h];(y=document.createElement("td")).style.padding="0px";var f=document.createElement("input");f.type="number",f.value=m[g]||"",f.style.width=Math.round(3.5*iScreenScale)+"px",f.className="noarrow",f.style.backgroundColor="black",f.style.color="white",f.style.textAlign="center",f.style.border="solid 1px white",f.style.fontSize=Math.round(1.8*iScreenScale)+"px",f.style.maxHeight=Math.round(2.5*iScreenScale+1)+"px",f.setAttribute("min",0),f.setAttribute("max",99),f.setAttribute("step",1),f.setAttribute("form","iten-distribution-form"),f.disabled=e.readOnly,y.style.padding="0px",y.appendChild(f),d.appendChild(y)}c.appendChild(d)}a.appendChild(c);var S=document.createElement("input");function v(e){for(var t=[],n=c.getElementsByTagName("input"),a=0,o=0;o<u.length;o++){for(var i={},r=!1,l=0;l<p.length;l++){var s=n[a];0<s.value&&(i[p[l]]=+s.value,r=!0),a++}if(e&&!r)return alert(toLanguage("You must enter at least 1 item for rank #"+(o+1),"Vous devez spcifier au moins 1 objet pour la position #"+(o+1))),null;t.push(i)}return t}S.type="button",S.value=toLanguage("Back","Retour"),S.style.position="absolute",S.style.left=2*iScreenScale+"px",S.style.top=36*iScreenScale+"px",S.style.fontSize=2*iScreenScale+"px",S.onclick=function(){t.removeChild(a)},a.appendChild(S);S=document.createElement("form");S.style.position="absolute",S.id="iten-distribution-form",S.style.right=5*iScreenScale+"px",S.style.top=35*iScreenScale+4+"px",S.style.fontSize=Math.round(2.5*iScreenScale)+"px",e.untitled||(S.innerHTML=toLanguage("Set name:&nbsp;","Nom du set :&nbsp;")),S.onsubmit=function(){var e={name:b.value,value:v(!0)};if(!e.value)return!1;t.removeChild(a);try{n(e)}catch(e){console.error(e)}return!1};var b=document.createElement("input");if(b.style.width=15*iScreenScale+"px",b.style.backgroundColor="black",b.style.color="white",b.style.border="solid 1px white",b.type="text",b.setAttribute("required",!0),b.style.fontSize=2*iScreenScale+"px",e.name)b.value=e.name;else{for(var M,x={},C=customItemDistrib[o],r=0;r<C.length;r++)x[C[r].name]=1;for(M=1;x["Distribution "+M];M++);b.value="Distribution "+M}e.untitled&&(b.style.display="none"),S.appendChild(b);o=document.createElement("input");o.type="submit",o.style.fontSize=2*iScreenScale+"px",o.value=toLanguage("Validate!","Valider !"),o.style.marginLeft=iScreenScale+"px",S.appendChild(o);o=document.createElement("a");o.href="#null",o.style.color="#CCF",o.innerHTML=toLanguage("Export/Import...","Exporter/importer"),o.style.fontSize=Math.round(1.4*iScreenScale)+"px",o.style.marginLeft=2*iScreenScale+"px",o.style.position="relative",o.style.top=-Math.round(iScreenScale/2)+"px",o.onclick=function(e){e.preventDefault();var e=JSON.stringify(v()),t=prompt(toLanguage("Export: copy this text to share this distribution with other players.\nImport: paste a new text to import other's distribution.","Exporter : copiez ce texte pour partager cette distribution avec d'autres joueurs.\nImporter : collez un nouveau texte pour importer la distribution d'un autre."),e);if(t&&t!==e){t=JSON.parse(t);for(var n=c.getElementsByTagName("input"),a=0,o=0;o<t.length;o++)for(var i=t[o],r=0;r<p.length;r++){var l=p[r];n[a].value=i[l]||"",a++}}},S.appendChild(o),a.appendChild(S),e.readOnly&&(S.style.display="none"),t.appendChild(a)}function selectCpuNamesScreen(a,o,e){e=e||{};var i=document.createElement("div");i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.left="0px",i.style.top="0px",i.style.zIndex=2,i.style.backgroundColor="#000";var t=document.createElement("form");t.style.height=35*iScreenScale+"px",t.style.overflowX="hidden",t.style.overflowY="auto",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.textAlign="center",t.onsubmit=function(){a.removeChild(i);var e=this.elements["cpu[]"];e.length||(e=[e]);for(var t=[],n=0;n<e.length;n++)t.push(e[n].value);return o(t),!1};var n=document.createElement("div");n.style.display="table",n.style.marginTop=Math.round(.5*iScreenScale)+"px",n.style.marginBottom=Math.round(.5*iScreenScale)+"px",n.style.marginLeft=n.style.marginRight="auto",n.style.borderSpacing=iScreenScale+"px";for(var r=0;r<e.count;r++){var l=document.createElement("label");l.style.display="table-row";var s=document.createElement("div");s.innerHTML=toLanguage("CPU "+(r+1)+" name","Nom ordi "+(r+1)),s.style.display="table-cell",s.style.verticalAlign="middle",s.style.textAlign="right",l.appendChild(s);var c=document.createElement("div");c.style.display="table-cell",c.style.verticalAlign="middle";s=document.createElement("input");s.style.fontSize=2*iScreenScale+"px",s.name="cpu[]",s.type="text",s.setAttribute("size",10),s.setAttribute("maxlength",30),null!=e.names[r]?s.value=e.names[r]:s.value="CPU "+(r+1),s.setAttribute("required","required"),c.appendChild(s),l.appendChild(c),n.appendChild(l)}t.appendChild(n);var p=document.createElement("input");p.type="submit",p.style.fontSize=3*iScreenScale+"px",p.value=toLanguage("Validate","Valider"),t.appendChild(p),i.appendChild(t);p=document.createElement("input");p.type="button",p.value=toLanguage("Back","Retour"),p.style.fontSize=2*iScreenScale+"px",p.style.position="absolute",p.style.left=2*iScreenScale+"px",p.style.top=35*iScreenScale+"px",p.onclick=function(){a.removeChild(i)},i.appendChild(p),a.appendChild(i),t.querySelector('[name="cpu[]"]').select()}String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t});var defaultGameOptions={team:!1,manualTeams:!1,localScore:!1,friendly:!1,minPlayers:2,maxPlayers:12,itemDistrib:0,cpu:!1,cpuCount:2,cpuLevel:0,cpuNames:null,cpuChars:null},startMusicHandler;function isCustomOptions(e){if(e)for(var t in defaultGameOptions)if(void 0!==e[t]&&e[t]!=defaultGameOptions[t])return 1}function hasChallenges(){for(var e in challenges)for(var t in challenges[e])return!0}function isTeamPlay(){switch(course){case"BB":case"VS":return selectedTeams}return 0}function selectTeamScreen(n){n||(aTeams.length=0);var a=document.createElement("div"),e=a.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";e=toLanguage("Select team","Slectionner quipe");1<strPlayer.length&&(e+=" ("+toLanguage("P","J")+(n+1)+")");e=toTitle(e,.5);1<strPlayer.length&&(e.style.fontSize=Math.round(7*iScreenScale)+"px"),a.appendChild(e);var t=document.createElement("input");for(t.type="button",t.value=toLanguage("Back","Retour"),t.style.fontSize=2*iScreenScale+"px",t.style.position="absolute",t.style.left=2*iScreenScale+"px",t.style.top=35*iScreenScale+"px",t.onclick=function(){a.innerHTML="",oContainers[0].removeChild(a),selectPlayerScreen(-1)},a.appendChild(t),i=0;i<2;i++)(t=document.createElement("input")).type="button",t.value=i?toLanguage("Red team","quipe rouge"):toLanguage("Blue team","quipe bleue"),t.i=i,t.style.fontSize=4*iScreenScale+"px",t.style.position="absolute",t.style.left=25*iScreenScale+"px",t.style.top=(16+9*i)*iScreenScale+"px",t.style.width=30*iScreenScale+"px",t.onclick=function(){a.innerHTML="",oContainers[0].removeChild(a);var e=+this.i;if(aTeams.push(e),aTeams.length>=strPlayer.length){for(var t=0;t<strPlayer.length;t++)aTeams.push(1-aTeams[t]);for(t=strPlayer.length;t<aPlayers.length;t++)aTeams.push((t+e+aPlayers.length)%2);selectTrackScreen()}else selectTeamScreen(n+1)},a.appendChild(t);oContainers[0].appendChild(a),updateMenuMusic(1)}function selectTrackScreen(){"BB"!=course||"MK"==page?selectMapScreen():selectRaceScreen(0)}function selectGamersScreen(){!isOnline&&isTeamPlay()?selectTeamScreen(0):selectPlayerScreen(-1)}function acceptRulesScreen(){var e=document.createElement("div"),t=e.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",(c=shareLink.options.public?toTitle(toLanguage("Game rules","Rgles parties"),0):toTitle(toLanguage("Private game rules","Rgles partie prive"),0)).style.fontSize=7*iScreenScale+"px",e.appendChild(c);var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=9*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px";var a=document.createElement("div");a.style.maxHeight=24*iScreenScale+"px",a.style.overflow="auto";t=document.createElement("div");t.style.textAlign="center",t.style.color="#F90",t.style.fontSize=2*iScreenScale+"px",t.style.lineHeight=3*iScreenScale+"px",shareLink.options.public?t.innerHTML=" "+toLanguage("Games from this mode have special rules","Les parties de ce mode utilisent des rgles spcifiques"):t.innerHTML=" "+toLanguage("Games from this private link have special rules","Les parties de ce lien priv utilisent des rgles spcifiques"),a.appendChild(t);var o,i,r,l,s,c=document.createElement("table");c.style.marginLeft="auto",c.style.marginRight="auto",shareLink.options.team&&(i=document.createElement("tr"),r=document.createElement("td"),(l=document.createElement("label")).setAttribute("for","option-teams"),(s=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",s.style.marginTop="0px",s.style.marginBottom="0px",s.innerHTML=toLanguage("Team games","Parties par quipe"),l.appendChild(s),(t=document.createElement("div")).style.fontSize=2*iScreenScale+"px",t.style.color="white",t.innerHTML=toLanguage("2 teams are selected in each game. You object: defeat the opposing team.","2 quipes sont slectionnes  chaque partie. Votre objectif : vaincre l'quipe adverse."),l.appendChild(t),r.appendChild(l),i.appendChild(r),c.appendChild(i)),shareLink.options.manualTeams&&(i=document.createElement("tr"),r=document.createElement("td"),l=document.createElement("label"),r.appendChild(l),(s=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",s.innerHTML=toLanguage("Manual selection","Slection manuelle"),s.style.marginBottom="0px",l.appendChild(s),(t=document.createElement("div")).style.fontSize=2*iScreenScale+"px",t.style.color="white",t.innerHTML=toLanguage("Teams are selected manually by one of the players.","Les quipes sont slectionnes manuellement par l'un des joueurs."),l.appendChild(t),r.appendChild(l),i.appendChild(r),c.appendChild(i)),shareLink.options.itemDistrib&&(i=document.createElement("tr"),r=document.createElement("td"),l=document.createElement("label"),r.appendChild(l),(s=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",s.innerHTML=toLanguage("Item distribution","Distribution des objets"),s.style.marginBottom="0px",l.appendChild(s),(t=document.createElement("div")).style.fontSize=2*iScreenScale+"px",t.style.color="white",isNaN(shareLink.options.itemDistrib)?(t.innerHTML=toLanguage('Custom distribution <a href="#null">[Show]</a>','Distribution personnalise <a href="#null">[Voir]</a>'),(o=t.querySelector("a")).style.color="#CCF",o.onclick=function(){return selectedItemDistrib=shareLink.options.itemDistrib,selectItemScreen(e,function(){},{readOnly:!0}),!1}):(o=getItemMode(),(o=itemDistributions[o][shareLink.options.itemDistrib]).value.length?t.innerHTML=o.name:t.innerHTML=toLanguage("No item","Aucun objet")),l.appendChild(t),r.appendChild(l),i.appendChild(r),c.appendChild(i)),shareLink.options.cpuCount&&(i=document.createElement("tr"),r=document.createElement("td"),l=document.createElement("label"),r.appendChild(l),(s=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",s.innerHTML=toLanguage("Possible addition of bots","Ajout possible de bots"),s.style.marginBottom="0px",l.appendChild(s),(t=document.createElement("div")).style.fontSize=2*iScreenScale+"px",t.style.color="white",t.innerHTML=toLanguage("If there are not enough players, some bots will be added to the game so that there are at least <strong>"+shareLink.options.cpuCount+"</strong> participants.","S'il n'y a pas assez de joueurs, des bots seront ajouts  la partie pour qu'il y ait au minimum <strong>"+shareLink.options.cpuCount+"</strong> participants"),l.appendChild(t),r.appendChild(l),i.appendChild(r),c.appendChild(i)),a.appendChild(c),n.appendChild(a),(t=document.createElement("div")).style.textAlign="center",t.style.marginTop=2*iScreenScale+"px";a=document.createElement("input");a.type="button",a.value=toLanguage("Accept and play","Accepter et jouer"),a.style.fontSize=3*iScreenScale+"px",a.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),shareLink.accepted=!0,searchCourse()},t.appendChild(a),n.appendChild(t),e.appendChild(n);n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(n),oContainers[0].appendChild(e)}function selectChallengesScreen(){var a=document.createElement("div"),e=a.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=toTitle(toLanguage("Challenges","Dfis"),0);t.style.fontSize=7*iScreenScale+"px",a.appendChild(t);var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=9*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px";var o,e=document.createElement("div");e.style.maxHeight=24*iScreenScale+"px",e.style.overflowX="hidden",e.style.overflowY="auto";t=hasChallenges();if(t){document.getElementById("comment-connect")&&((P=document.createElement("div")).style.width=(iWidth-5)*iScreenScale+"px",P.style.marginLeft="auto",P.style.marginRight="auto",P.style.marginBottom=Math.round(1.5*iScreenScale)+"px",P.style.textAlign="center",P.innerHTML=language?'You are not connected. The challenges you complete will not be saved. <a href="forum.php" target="_blank" style="color:white">Click here</a> to log in or register.':'Vous n\'tes pas connect. Les dfis russis ne seront pas sauvegards. <a href="forum.php" target="_blank" style="color:white">Cliquez ici</a> pour vous connecter ou vous inscrire.',P.style.fontSize=Math.round(1.8*iScreenScale)+"px",e.appendChild(P));var i,r=document.createElement("table");for(i in r.style.width=(iWidth-3)*iScreenScale+"px",r.style.marginLeft="auto",r.style.marginRight="auto",r.style.borderCollapse="collapse",challenges)for(var l in challenges[i]){var s=challenges[i][l];if(s.main)o=s.id;else{(m=document.createElement("tr")).style.border="solid 1px white",(f=document.createElement("td")).setAttribute("colspan",2);var c=document.createElement("h1"),p="";switch(i){case"mcup":p=toLanguage("Multicup","Multicoupe");break;case"cup":p=toLanguage("Cup","Coupe");break;case"track":p=toLanguage("Track","Circuit")}c.innerHTML=p+' <span style="color:#FDB">'+s.name+"</span>",c.style.textAlign="center",c.style.margin="0px",c.style.fontSize=Math.round(4*iScreenScale)+"px",c.style.paddingTop=Math.round(.5*iScreenScale)+"px",c.style.paddingBottom=Math.round(.5*iScreenScale)+"px",c.style.backgroundColor="#fa7c1b",c.style.color="white",f.appendChild(c),m.appendChild(f),r.appendChild(m)}for(var u=s.list,d=0;d<u.length;d++){var m,h=u[d],y="active"==h.status&&h.succeeded,g=y?"#9E9":"white";(m=document.createElement("tr")).style.border="solid 1px "+g,y&&(m.style.backgroundColor="#031"),(f=document.createElement("td")).style.padding=iScreenScale+" "+iScreenScale+"px",h.name&&((c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginTop="0px",c.style.marginBottom="0px",c.innerText=h.name,f.appendChild(c));var f,S=document.createElement("div");if(h.name||h.description.extra?S.style.fontSize=2*iScreenScale+"px":S.style.fontSize=Math.round(2.5*iScreenScale)+"px",S.style.color=g,S.style.fontWeight="bold",S.innerHTML=h.description.main,f.appendChild(S),h.description.extra&&((S=document.createElement("div")).style.fontSize=Math.round(1.6*iScreenScale)+"px",S.style.color=g,S.innerHTML=h.description.extra,f.appendChild(S)),"active"!=h.status){switch((S=document.createElement("div")).style.fontSize=Math.round(1.6*iScreenScale)+"px",S.style.color="#FC0",h.status){case"pending_completion":S.innerHTML=toLanguage("This challenge is pending completion. Succeed it to publish it.","Ce dfi est en attente de russite. Russissez-le pour le publier.");break;case"pending_publication":S.innerHTML=toLanguage("This challenge is pending publication. Click on &quot;Manage challenges&quot; to publish it.","Ce dfi est en attente de publication. Cliquez sur &quot;Grer les dfis&quot; pour le publier.");break;case"pending_moderation":S.innerHTML=toLanguage("This challenge is pending moderation. It will be published once a validator validates it.","Ce dfi est en attente de modration. Il sera publi ds qu'un modrateur l'aura valid.")}S.style.fontWeight="bold",f.appendChild(S)}m.appendChild(f),(f=document.createElement("td")).style.padding=iScreenScale+" "+iScreenScale+"px",f.style.width=12*iScreenScale+"px",f.style.textAlign="center",h.succeeded&&((b=document.createElement("div")).innerHTML='<span style="color:#CFC;display:inline-block;margin-right:2px"></span>'+toLanguage("Completed","Russi"),b.style.whiteSpace="nowrap",b.style.fontSize=Math.round(iScreenScale*(language?2:2.2))+"px",b.style.backgroundColor="#33A033",b.style.display="inline-block",b.style.padding="0px "+Math.round(.8*iScreenScale)+"px",b.style.borderRadius=Math.round(.6*iScreenScale)+"px",b.style.color="white",b.style.marginBottom=Math.round(.5*iScreenScale)+"px",b.style.marginTop=Math.round(.5*iScreenScale)+"px",f.appendChild(b));var v,y=document.createElement("div"),g=document.createElement("img");if(g.src="images/challenges/difficulty"+h.difficulty.level+".png",g.alt="D",g.style.width=2*iScreenScale+"px",y.appendChild(g),(b=document.createElement("span")).style.color=h.difficulty.color,b.style.fontSize=Math.round(1.7*iScreenScale)+"px",b.style.position="relative",b.style.top="-1px",b.innerHTML=" "+h.difficulty.name,y.appendChild(b),f.appendChild(y),h.winners.length){(y=document.createElement("div")).style.cursor="help";var b,g=document.createElement("img");h.succeeded||(y.style.marginBottom=Math.round(.5*iScreenScale)+"px"),g.src="images/cups/cup1.png",g.alt="W",g.style.width=2*iScreenScale+"px",y.appendChild(g),(b=document.createElement("span")).style.color="white",b.style.fontSize=Math.round(1.7*iScreenScale)+"px",b.style.position="relative",b.style.top="-2px",b.innerHTML=" "+h.winners.length;for(var M='<small style="color:#CFC">'+toLanguage("Succeeded by:","Russi par :")+"</small>",x=0;x<h.winners.length;x++)M+='<br /><span style="color:#CFC;display:inline-block;margin-right:2px"></span>'+h.winners[x].nick;y.dataset||(y.dataset={}),y.dataset.title=M,y.appendChild(b),y.onmouseover=function(e){var t;I||((I=document.createElement("div")).className="ranking_activeplayertitle",I.innerHTML=this.dataset.title,I.style.position="fixed",I.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",I.style.borderRadius=iScreenScale+"px",I.style.zIndex=10,I.style.backgroundColor="rgba(51,160,51, 0.95)",I.style.color="white",I.style.fontSize=Math.round(1.8*iScreenScale)+"px",I.style.lineHeight=Math.round(2*iScreenScale)+"px",I.style.visibility="hidden",$mkScreen.appendChild(I),t=this.getBoundingClientRect(),I.style.left=Math.round(t.left+(this.scrollWidth-I.scrollWidth)/2)+"px",I.style.top=t.top+this.scrollHeight+5+"px",I.style.visibility="visible")},y.onmouseout=function(e){I&&($mkScreen.removeChild(I),I=void 0)},f.appendChild(y)}function C(e,t,n){a.innerHTML="",oContainers[0].removeChild(a),(clSelected=e).trackId=t,clSelected.trackType=n,localStorage.removeItem("itemset."+getItemMode()),xhr("challengeTry.php","challenge="+e.id,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}for(var t in clSelected.autoset=e,course="",e)window[t]=e[t];return course?selectPlayerScreen(0):selectMainPage(),delete window.selectedPerso,showClSelectedPopup(),!0})}h.succeeded?((k=document.createElement("a")).href="#null",k.innerHTML=toLanguage("Replay","Rejouer"),k.style.color="white",k.style.fontSize=Math.round(1.7*iScreenScale)+"px",function(e,t,n){k.onclick=function(){return C(e,t,n),!1}}(h,l,i),f.appendChild(k)):((v=document.createElement("input")).type="button",v.value=toLanguage("Take up","Relever"),v.style.width=11*iScreenScale+"px",v.style.fontSize=Math.round(2.4*iScreenScale)+"px",function(e,t,n){v.onclick=function(){C(e,t,n)}}(h,l,i),f.appendChild(v)),m.appendChild(f),r.appendChild(m)}}e.appendChild(r)}else{e.style.textAlign="center",(S=document.createElement("div")).style.fontSize=3*iScreenScale+"px",S.style.marginTop=3*iScreenScale+"px",S.style.marginBottom=2*iScreenScale+"px",S.style.marginLeft="auto",S.style.marginRight="auto",S.style.width=60*iScreenScale,S.style.color="white",S.innerHTML=toLanguage("This circuit has no challenges. Create some right now, it's fast and easy!","Ce circuit ne comporte aucun dfi. Crez-en ds maintenant, c'est facile et rapide !"),e.appendChild(S);var P=document.createElement("input");P.type="button",P.style.fontSize=3*iScreenScale+"px",P.style.paddingLeft=2*iScreenScale+"px",P.style.paddingRight=2*iScreenScale+"px",P.value=toLanguage("Go to challenge editor","Accder  l'diteur de dfis"),P.onclick=function(){openChallengeEditor()},e.appendChild(P)}n.appendChild(e),a.appendChild(n);var k,n=document.createElement("input");if((n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){a.innerHTML="",oContainers[0].removeChild(a),selectMainPage()},a.appendChild(n),t)&&(myCircuit&&((n=document.createElement("input")).type="button",n.value=toLanguage("Edit challenges...","Grer les dfis..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.right=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){openChallengeEditor()},a.appendChild(n)),clRewards.length)){(k=document.createElement("a")).href="persoLocked.php?cl="+o,k.target="_blank",k.style.color="white",k.style.textDecoration="none",k.onclick=function(){return window.open(this.href,"persoLock","scrollbars=1, resizable=1, width=500, height=500"),!1};t=document.createElement("img");t.src="images/challenges/unlocking.png",t.alt=toLanguage("Unlocking characters","Persos  dbloquer"),t.style.height=2*iScreenScale+"px",t.style.marginRight=Math.round(.55*iScreenScale)+"px",t.style.position="relative",t.style.top=Math.round(.2*iScreenScale)+"px",k.appendChild(t);var w=0;if(myCircuit)k.innerHTML+=clRewards.length;else{for(d=0;d<clRewards.length;d++)clRewards[d].unlocked&&w++;k.innerHTML+=w+"/"+clRewards.length}k.style.fontSize=2*iScreenScale+"px",k.style.position="absolute",k.style.right=(myCircuit?22:2)*iScreenScale+"px",k.style.top=35*iScreenScale+"px",k.dataset||(k.dataset={});var I,n=clRewards.length-w,t=1<n?"s":"";n<=0?(k.dataset.title=toLanguage("All characters unlocked,<br />congratulations!","Tous les persos ont t<br />dbloqus, flicitations !"),k.style.color="#0F8",k.style.fontWeight="bold"):k.dataset.title=w?toLanguage(n,"Plus que "+n)+" "+toLanguage("character"+t+" left to unlock","perso"+t+"  dbloquer"):n+" "+toLanguage("character"+t+" to unlock","perso"+t+"  dbloquer"),k.onmouseover=function(){var e;this.style.opacity=.7,I||((I=document.createElement("div")).className="ranking_activeplayertitle",I.style.textAlign="center",I.innerHTML=this.dataset.title,I.style.position="fixed",I.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",I.style.borderRadius=iScreenScale+"px",I.style.zIndex=10,I.style.backgroundColor="rgba(102,153,160, 0.95)",I.style.color="white",I.style.fontSize=Math.round(1.8*iScreenScale)+"px",I.style.lineHeight=Math.round(2*iScreenScale)+"px",I.style.visibility="hidden",$mkScreen.appendChild(I),e=this.getBoundingClientRect(),I.style.left=Math.round(e.left+(this.scrollWidth-I.scrollWidth)/2)+"px",I.style.top=e.top-I.scrollHeight-5+"px",I.style.visibility="visible")},k.onmouseout=function(){this.style.opacity="",I&&($mkScreen.removeChild(I),I=void 0)},a.appendChild(k)}oContainers[0].appendChild(a)}function searchCourse(){var a=document.createElement("div"),e=a.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=document.createElement("div");t.style.position="absolute",t.style.left="0px",t.style.top=4*iScreenScale+"px",t.style.width=iScreenScale*iWidth+"px",t.style.fontSize=4*iScreenScale+"",t.style.textAlign="center",t.innerHTML=toLanguage("Searching for other players<br />Please wait...","Recherche d'autres joueurs<br />Veuillez patienter..."),a.appendChild(t);e=document.createElement("label");e.style.position="absolute",e.style.left="0px",e.style.top=15*iScreenScale-9+"px",e.style.width=iScreenScale*iWidth+"px",e.style.textAlign="center";var o=document.createElement("input");o.type="checkbox",o.id="iAlert",o.style.transform=o.style.WebkitTransform=o.style.MozTransform="scale("+iScreenScale/6+") translateY(8%)",o.style.transformOrigin=o.style.WebkitTransformOrigin=o.style.MozTransformOrigin="bottom right",e.appendChild(o);t=document.createElement("span");t.setAttribute("for","iAlert"),t.style.fontSize=2*iScreenScale+"pt",t.style.marginLeft="5px",t.innerHTML=toLanguage("Notify me when opponents have been found","M'alerter lorsque des adversaires ont t trouvs"),e.appendChild(t),a.appendChild(e);var n=0,i=document.createElement("div");i.style.position="absolute",i.style.left="0px",i.style.top=21*iScreenScale+"px",i.style.width=41*iScreenScale*2+"px",i.style.height=Math.round(8.5*iScreenScale)+"px",i.style.overflow="hidden";for(var r=0;r<41;r++){var l=document.createElement("img");l.src="images/cLoading.png",l.className="pixelated",l.style.width=2*iScreenScale+"px",l.style.position="absolute",l.style.left=r*iScreenScale*2+"px",l.style.top="0px",i.appendChild(l)}a.appendChild(i);var s=document.createElement("div");s.style.position="absolute",s.style.left="0px",s.style.top=Math.round(17.5*iScreenScale)+"px",s.style.width=iScreenScale*iWidth+"px",s.style.textAlign="center",s.style.fontSize=2*iScreenScale+"px",s.style.color="#0B0",s.style.display="none",s.style.backgroundColor="rgba(0,0,0, 0.7)",s.innerHTML=toLanguage('<span id="nb-active-players" style="color:#0E0"></span> currently online. You\'ll join them as soon as they finish their '+(isBattle?"battle":"race"),'<span id="nb-active-players" style="color:#0E0"></span> actuellement en ligne. Vous les rejoindrez une fois leur partie termine'),a.appendChild(s);var c=document.createElement("div");c.style.position="absolute",c.style.left="0px",c.style.top=Math.round(17.5*iScreenScale)+"px",c.style.width=iScreenScale*iWidth+"px",c.style.textAlign="center",c.style.fontSize=2*iScreenScale+"px",c.style.color="#0B0",c.style.display="none",c.style.backgroundColor="rgba(0,0,0, 0.7)",c.innerHTML=toLanguage('<span id="nb-pending-players" style="color:#0E0"></span> currently waiting, <span id="nb-missing-players" style="color:#0E0"></span> left before the game begins...','<span id="nb-pending-players" style="color:#0E0"></span> actuellement en attente. Plus que <span id="nb-missing-players" style="color:#0E0"></span> pour que la partie commence'),a.appendChild(c);var p=1,u=iScreenScale/2,d="";function m(){p&&(--p||xhr("getCourse.php",d,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}var t,n;return e.found?(t=o.checked,a.innerHTML="",oContainers[0].removeChild(a),t&&((n=document.createElement("embed")).src="musics/mkalert.wav",n.setAttribute("loop",!1),n.setAttribute("autostart",!0),n.style.position="absolute",n.style.left="-1000px",n.style.top="-1000px",document.body.appendChild(n),t=(new Date).getTime(),alert(toLanguage("Opponents have been found !\nGood luck !","Des adversaires ont t trouvs !\nBonne chance !")),e.time-=Math.round(((new Date).getTime()-t)/1e3),document.body.removeChild(n)),e.time<1&&(e.time=1),document.getElementById("racecountdown").innerHTML=e.time-5,selectMapScreen(),dRest(),setTimeout(setChat,1e3)):(p=10,e.nb_players?(e.nb_players<2&&(e.nb_players=2),document.getElementById("nb-active-players").innerHTML=e.nb_players+" "+toLanguage("players","joueurs"),c.style.display="none",s.style.display="block"):e.pending_players?(document.getElementById("nb-pending-players").innerHTML=e.pending_players+" "+toLanguage("player","joueur")+(1<e.pending_players?"s":""),(n=e.min_players-e.pending_players)<1&&(n=1),document.getElementById("nb-missing-players").innerHTML=n+" "+toLanguage("player","joueur")+(1<n?"s":""),s.style.display="none",c.style.display="block"):(s.style.display="none",c.style.display="none")),!0})),--n<=-4&&(n=0),i.style.left=Math.round(n*u)+"px",setTimeout(m,100)}isCup?isMCups?d+="mid="+nid:isSingle?d+=(complete?"i":"id")+"="+nid+(isBattle?"&battle":""):d+=(complete?"c":"s")+"id="+nid:isBattle?d+="battle":noDS&&(d+="nods"),shareLink.key&&(d+=(d?"&":"")+"key="+shareLink.key),m(),shareLink.key||xhr("sendCourseNotifs.php",null,function(e){return!0});e=document.createElement("input");e.type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=35*iScreenScale+"px",e.onclick=function(){m=function(){},a.innerHTML="",oContainers[0].removeChild(a),selectPlayerScreen(0)},a.appendChild(e),oContainers[0].appendChild(a),updateMenuMusic(0)}function chooseRandMap(){"MK"==page?"BB"!=course?choose(Math.ceil(Math.random()*NBCIRCUITS)):choose(NBCIRCUITS+Math.ceil(12*Math.random())):isSingle?choose(1):isBattle?choose(NBCIRCUITS+Math.ceil(12*Math.random()),!0):choose(Math.ceil(Math.random()*NBCIRCUITS),!0)}function selectMapScreen(e){if(isOnline&&(setSRest(),document.getElementById("waitrace").style.visibility="visible"),isCup&&!isMCups||isBattle&&isCup)selectRaceScreen(0);else{if(clSelected&&!e)switch(clSelected.trackType){case"cup":if(-1!==(n=cupIDs.indexOf(clSelected.trackId)))return void selectRaceScreen(4*n);break;case"track":var t=aAvailableMaps.find(function(e){e=oMaps[e];return("CI"===page?e.id:e.map)==clSelected.trackId});if(t){var n,t=oMaps[t];return void selectRaceScreen(4*(n=Math.floor((t.ref-1)/4)))}}var a=document.createElement("div"),e=a.style,o=!0;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black","BB"!=course?a.appendChild(toTitle(toLanguage("Choose cup","Choisissez la coupe"),.5)):a.appendChild(toTitle(toLanguage("Choose stage","Choisissez une arne"),.5));e=document.createElement("input");e.type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",e.onclick=function(){pause&&!isOnline?(removeMenuMusic(!1),quitter()):(o=!1,a.innerHTML="",oContainers[0].removeChild(a),isOnline&&(document.getElementById("waitrace").style.visibility="hidden"),chatting=!1,selectGamersScreen())};var i=document.createElement("div");i.style.position="absolute",i.style.zIndex=10,i.style.top=Math.round(35.5*iScreenScale-6)+"px",i.style.left=25*iScreenScale-5+"px",i.style.width=25*iScreenScale+6+"px",i.style.height=Math.round(3.9*iScreenScale)+"px",i.style.border="solid 1px white",i.style.color="white",i.style.backgroundColor="black",i.style.borderBottom="none",i.style.textAlign="center",i.style.display="none",i.style.flexDirection="column",i.style.justifyContent="center";var r=document.createElement("div");r.style.maxHeight=Math.round(3.9*iScreenScale)+"px",r.style.overflow="hidden",i.appendChild(r),a.appendChild(i),a.appendChild(e),"GP"!=course&&oContainers[0].appendChild(a),document.getElementById("dMaps").style.top=40*iScreenScale+"px",document.getElementById("dMaps").style.left=7+25*iScreenScale+"px",document.getElementById("dMaps").style.width=25*iScreenScale+"px",document.getElementById("dMaps").style.height=10*iScreenScale+"px";var l,s=["champi","etoile","carapace","carapacebleue","speciale","carapacerouge","banane","feuille","megachampi","eclair","upchampi","fireflower","bobomb","minichampi","egg","iceflower","plume","cloudchampi"],c=NBCIRCUITS/4;"BB"==course&&(s=["snes","gba","ds"],c=3);var p=Math.ceil(c/6);cupOpts.lines&&(p=cupOpts.lines.length);var u=l=Math.ceil(c/p);if(cupOpts.lines)for(var d=u=0;d<cupOpts.lines.length;d++)u=Math.max(u,cupOpts.lines[d]);var m=Math.min(Math.round(10.5/Math.pow(Math.max(c/5,p,.5),.6)),16/p,60/u),h=Math.min(4,20/u),y=4/p,g=38;"BB"==course&&(m=Math.round(1.5*m),h=Math.round(2*h),g-=3);for(var f,S,v,b=0,M=0,d=0;d<c;d++){cupOpts.lines?(v=cupOpts.lines[M],f=b,S=M,++b>=cupOpts.lines[M]&&(b=0,M++)):(v=Math.min(l,c-(d-d%l)),f=d%l,S=Math.floor(d/l));var x=document.createElement("img");x.className="pixelated",x.style.width=m*iScreenScale+"px",x.style.height=m*iScreenScale+"px",x.style.cursor="pointer",x.style.position="absolute";var C=(iWidth+h+1)/2+(f-v/2)*(m+h),P=(y+g)/2+(S-p/2)*(m+y);x.style.left=Math.round(C*iScreenScale)+"px",x.style.top=Math.round(P*iScreenScale)+"px",cupOpts.icons?"number"==typeof cupOpts.icons[d]?x.src="images/cups/"+s[cupOpts.icons[d]]+".gif":function(e,t){x.onload=function(){this.naturalWidth>this.naturalHeight?(this.style.width=m*iScreenScale+"px",this.style.top=Math.round((t+m*(1-this.naturalHeight/this.naturalWidth)/2)*iScreenScale)+"px",this.style.height="auto"):(this.style.width="auto",this.style.height=m*iScreenScale+"px",this.style.left=Math.round((e+m*(1-this.naturalWidth/this.naturalHeight)/2)*iScreenScale)+"px")},x.src=cupOpts.icons[d]}(C,P):x.src="images/cups/"+s[d]+".gif","BB"==course?x.alt=d+NBCIRCUITS/4:x.alt=d;var k,w,I,T=iScreenScale;x.onmouseover=function(){var e=new Image;e.src=getMapSelectorSrc(d),e.alt=4*this.alt+4,e.style.border="double 4px white",e.style.width="100%",e.style.height="100%",e.id="maps",document.getElementById("dMaps").appendChild(e);e=mapNameOf(T,4*this.alt);e.id="oMapName",document.getElementById("dMaps").appendChild(e),document.getElementById("dMaps").style.display="block",function e(t){document.getElementById("maps")&&document.getElementById("maps").alt==t&&(t%4!=0?t++:t-=3,document.getElementById("oMapName").innerHTML=lCircuits[t-1],document.getElementById("maps").alt=t,document.getElementById("maps").src=getMapSelectorSrc(t-1),setTimeout(function(){e(t)},1e3))}(4*this.alt+4),cupNames[this.alt]&&(r.innerHTML=cupNames[this.alt],e=Math.min(Math.max(8/Math.sqrt(stripSpecialChars(cupNames[this.alt]).length),1.45),3),i.style.fontSize=Math.round(e*iScreenScale)+"px",i.style.display="flex")},x.onmouseout=function(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",i.style.display="none"},x.onclick=function(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",a.innerHTML="",oContainers[0].removeChild(a),selectRaceScreen(4*this.alt)},"BB"==course&&(k=[toLanguage("SNES Stages","Arnes SNES"),toLanguage("GBA Stages","Arnes GBA"),toLanguage("DS Stages","Arnes DS")],(w=document.createElement("div")).style.position="absolute",w.style.left=Math.round((C-h/2)*iScreenScale)+"px",w.style.top=Math.round((P+.9*m)*iScreenScale)+"px",w.style.width=(m+h)*iScreenScale+"px",w.style.fontSize=3*iScreenScale+"px",w.style.color="white",w.style.textAlign="center",w.innerHTML=k[d],a.appendChild(w)),a.appendChild(x),"GP"==course?(w=+ptsGP.charAt(d))&&((I=new Image).src="images/cups/cup"+(4-w)+".png",I.style.width=Math.round(4*iScreenScale*m/7)+"px",I.style.height=Math.round(4*iScreenScale*m/7)+"px",I.style.position="absolute",I.style.left=Math.round((C+4*m/7)*iScreenScale)+"px",I.style.top=Math.round((P+4*m/7)*iScreenScale)+"px",I.className="pixelated",a.appendChild(I)):isMCups&&!isOnline&&((I=document.createElement("a")).style.position="absolute",I.style.left=Math.round((C+5*m/7)*iScreenScale)+"px",I.style.top=Math.round((P+5*m/7)*iScreenScale)+"px",I.style.backgroundColor="rgba(0,50,128, 0.5)",I.style.padding="4px",I.style.borderRadius="50%",I.href="?cid="+cupIDs[d],I.title=toLanguage("Link to this cup","Lien vers cette coupe"),I.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},I.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},(P=document.createElement("img")).src="images/clink.png",P.style.width=Math.round(m*iScreenScale*2/7)+"px",I.appendChild(P),a.appendChild(I))}"VS"==course||"BB"==course?((e=document.createElement("input")).type="button",e.value=toLanguage("Random","Alatoire"),e.style.fontSize=3*iScreenScale+"px",e.style.position="absolute",e.style.left=34*iScreenScale-10+"px",e.style.top=30*iScreenScale+"px",e.onclick=function(){o=!1,a.innerHTML="",oContainers[0].removeChild(a),chooseRandMap()},a.appendChild(e)):"GP"==course?oContainers[0].appendChild(a):"CM"==course&&((e=document.createElement("input")).type="button",e.value=toLanguage("Ranking","Classement"),e.style.fontSize=3*iScreenScale+"px",e.style.position="absolute",e.style.left=33*iScreenScale-10+"px",e.style.top=30*iScreenScale+"px",e.onclick=openRankings,a.appendChild(e)),isOnline&&setTimeout(function(){o&&(document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",a.innerHTML="",oContainers[0].removeChild(a),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML),updateMenuMusic(1)}}function setMapSrc(e,t,n,a){isCup?setTimeout(function(){e.src=a},100*(n-t)):e.src=a}function rankingsLink(e){switch(page){case"MK":return"classement.php?map="+e.map;case"CI":return"classement.php?circuit="+e.id;case"MA":return"classement.php?draw="+e.map}}function openRankings(){if(isMCups)open("classement.php?mcup="+nid);else switch(page){case"MK":open("classement.php");break;case"CI":open("classement.php"+(isSingle?"?circuit="+nid:"?scup="+nid));break;case"MA":open("classement.php"+(isSingle?"?draw="+nid:"?ccup="+nid))}}function exitCircuit(){var e=document.getElementById("changeRace"),t=document.getElementById("supprRace");e&&!t?e.click():document.location.href="index.php"}function appendContainers(){for(var e=1;e<oContainers.length;e++)$mkScreen.appendChild(oContainers[e])}function selectRaceScreen(cup){var cupNb;if(!isOnline&&(isSingle||"GP"==course))return"GP"==course&&(iDificulty="MK"!=page?5:(cupNb=Math.floor(cup/4)%5,cup<40?Math.min(4.5+cupNb/7,5):Math.min(4.6+cupNb/7,5))),cup++,strMap="map"+cup,appendContainers(),void resetGame(strMap);var oScr=document.createElement("div"),oStyle=oScr.style,forceClic4=!0;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black",oContainers[0].appendChild(oScr),"BB"!=course?oScr.appendChild(toTitle(toLanguage("Choose track","Choisissez un circuit"),isSingle?2.5:.5)):oScr.appendChild(toTitle(toLanguage("Choose stage","Choisissez une arne"),isSingle?2.5:.5));var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",oPInput.onclick=function(){forceClic4=!1,oScr.innerHTML="",oContainers[0].removeChild(oScr),isOnline&&isCup&&!isMCups?(document.getElementById("waitrace").style.visibility="hidden",chatting=!1,selectPlayerScreen(0)):"BB"!=course?isCup&&!isMCups?pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():selectMapScreen(!0):isCup?pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():selectMapScreen(!0)},oScr.appendChild(oPInput);for(var mScreenScale=iScreenScale,trackSelected=clSelected&&"track"===clSelected.trackType?clSelected.trackId:null,divSelected,lCup=isSingle?cup+1:cup+4,i=cup,oPInput;i<lCup;i++){var mDiv=document.createElement("div");mDiv.style.width=25*iScreenScale+"px",mDiv.style.height=10*iScreenScale+"px",mDiv.style.cursor="pointer",mDiv.style.position="absolute";var j=i-cup;isSingle?(mDiv.style.left=27*iScreenScale+"px",mDiv.style.top=15*iScreenScale+"px"):(mDiv.style.left=((iWidth-113)/2+25*(j-2*Math.floor(j/2))+(j-2*Math.floor(j/2)))*iScreenScale+30*iScreenScale+"px",mDiv.style.top=10*iScreenScale+11*iScreenScale*Math.floor(j/2)+"px"),mDiv.map=aAvailableMaps[i],mDiv.ref=i+1;var oPImg=new Image,mLink,iMap,iLink;setMapSrc(oPImg,cup,i,getMapSelectorSrc(i)),oPImg.style.width="100%",oPImg.style.height="100%",oPImg.style.border="double 4px silver",oPImg.className="pixelated",mDiv.appendChild(oPImg),mDiv.appendChild(mapNameOf(mScreenScale,i)),isCup&&!isOnline&&(mLink=document.createElement("a"),mLink.style.position="absolute",mLink.style.right="-3px",mLink.style.top="5px",mLink.style.backgroundColor="rgba(0,50,128, 0.5)",mLink.style.padding="4px",mLink.style.borderRadius="50%",iMap=oMaps[aAvailableMaps[i]],mLink.href="MA"==page?"?i="+iMap.map:"?id="+iMap.id,mLink.title=toLanguage("Link to this circuit","Lien vers ce circuit"),mLink.onclick=function(e){e.stopPropagation()},mLink.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},mLink.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},iLink=document.createElement("img"),iLink.src="images/clink.png",iLink.style.width=2*iScreenScale+"px",mLink.appendChild(iLink),mDiv.appendChild(mLink)),mDiv.onclick=function(){var tMap,iMap;forceClic4=!1,oScr.innerHTML="",oContainers[0].removeChild(oScr),isOnline?choose(this.ref):"CM"!=course?(appendContainers(),resetGame(this.map)):"MK"!=page?(gPersos.length=0,resetGame(this.map)):(document.body.style.cursor="progress",tMap=this.map,iMap=tMap.replace(/^[a-zA-Z]+([0-9]+)$/,"$1"),xhr("ghostsave.php","map="+iMap,function(reponse){var ghostSaves;try{ghostSaves=eval(reponse)}catch(e){return!1}return selectFantomeScreen(ghostSaves||void 0,iMap-1),!0}))};var oMap=oMaps[mDiv.map],mId="CI"===page?oMap.id:oMap.map;mId==trackSelected&&(divSelected=mDiv),oScr.appendChild(mDiv)}(!isCup||isSingle||isMCups||(oPInput=document.createElement("input"),oPInput.type="button","CM"!=course?oPInput.value=toLanguage("Random","Alatoire"):oPInput.value=toLanguage("Rankings","Classement"),oPInput.style.position="absolute",isOnline?(oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.left=67*iScreenScale+"px",oPInput.style.top=30*iScreenScale+"px"):(oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.left=34*iScreenScale-10+"px",oPInput.style.top=34*iScreenScale+"px"),oPInput.onclick=function(){"CM"!=course?(forceClic4=!1,oScr.innerHTML="",oContainers[0].removeChild(oScr),chooseRandMap()):openRankings()},oScr.appendChild(oPInput)),isOnline&&(setSRest(),setTimeout(function(){forceClic4&&(oScr.innerHTML="",oContainers[0].removeChild(oScr),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)),divSelected)?divSelected.click():updateMenuMusic(1)}function choose(map,rand){if(!isOnline)return appendContainers(),void resetGame("map"+map);var choixJoueurs=[],oTable=document.createElement("table");oTable.border=1,oTable.setAttribute("cellspacing",2),oTable.setAttribute("cellpadding",2),oTable.style.position="absolute",oTable.style.fontSize=2*iScreenScale+"pt",oTable.style.textAlign="center",oTable.style.left=25*iScreenScale+"px",oTable.style.top=2*iScreenScale+"px",oTable.style.width=30*iScreenScale+"px";var oTBody=document.createElement("tbody");function refreshTab(reponse){if(reponse){if(-1!=reponse){var rCode;try{rCode=eval(reponse)}catch(e){return!1}choixJoueurs=rCode[0];for(var trs=oTBody.getElementsByTagName("tr");trs.length;)oTBody.removeChild(trs[0]);var nbChoices=0,oTr,oTd,isChoix,isRandom,cpuLevel,cpuLevel,itemMode;for(i=0;i<choixJoueurs.length;i++){choixJoueurs[i][7]||(oTr=document.createElement("tr"),oTd=document.createElement("td"),isChoix=choixJoueurs[i][2],isRandom=choixJoueurs[i][3],oTd.innerHTML=isChoix?isRandom?"???":lCircuits[isChoix-1]:toLanguage("Not chosen","Non choisi"),oTr.appendChild(oTd),oTBody.appendChild(oTr),nbChoices++)}if(-1==rCode[1])setTimeout(waitForChoice,1e3);else if(choixJoueurs.length>=rCode[4].minPlayers&&1<nbChoices){for(aPlayers=new Array,aIDs=new Array,aPlaces=new Array,aPseudos=new Array,aControllers=new Array,shareLink.options&&shareLink.options.cpu&&(cpuLevel=shareLink.options.cpuLevel||0,cpuLevel=2-cpuLevel,iDificulty=4+.5*cpuLevel),aTeams=new Array,i=0;i<choixJoueurs.length;i++){var aID=choixJoueurs[i][0];aID!=identifiant?(aIDs.push(aID),aPlayers.push(choixJoueurs[i][1]),isCustomPerso(choixJoueurs[i][1]),aPlaces.push(choixJoueurs[i][4]),aPseudos.push(choixJoueurs[i][5]),aTeams.push(choixJoueurs[i][6]),aControllers.push(choixJoueurs[i][7])):(aPlaces.unshift(choixJoueurs[i][4]),aPseudos.unshift(choixJoueurs[i][5]),aTeams.unshift(choixJoueurs[i][6]))}selectedTeams=-1==aTeams.indexOf(-1),selectedTeams||(aTeams.length=0),shareLink.options&&shareLink.options.itemDistrib&&(selectedItemDistrib=isNaN(shareLink.options.itemDistrib)?shareLink.options.itemDistrib:(itemMode=getItemMode(),itemDistributions[itemMode][shareLink.options.itemDistrib].value));var tNow=(new Date).getTime();tnCourse=tNow+rCode[2],isSingle?rCode[2]=0:rCode[4].manualTeams?playerIsSelecter()?rCode[2]=0:rCode[2]-=12e3:tnCourse+=5e3;var tThen=tNow+rCode[2];connecte=rCode[3]+1;var cCursor=0,cTime=50;function moveCursor(){var e=!0;if(cCursor==rCode[1]){for(var t=0,n=cTime,a=0;a<nbChoices;a++)t+=n=Math.round(1.05*n);t>=tThen-(new Date).getTime()&&(e=!1)}e?(trs[cCursor].style.backgroundColor="",trs[cCursor].style.color="",++cCursor==nbChoices&&(cCursor=0),trs[cCursor].style.backgroundColor="#F80",trs[cCursor].style.color="white",cTime=Math.round(1.05*cTime),setTimeout(moveCursor,cTime)):clignote(0)}function clignote(e){trs[cCursor].style.backgroundColor=e%2?"":"#F80",trs[cCursor].style.color=e%2?"":"white",e<4?setTimeout(function(){clignote(e+1)},100):setTimeout(function(){$mkScreen.removeChild(oTable),proceedOnlineRaceSelection(rCode)},500),1==e&&(trs[cCursor].getElementsByTagName("td")[0].innerHTML=lCircuits[choixJoueurs[cCursor][2]-1])}moveCursor(),oMap=oMaps[aAvailableMaps[choixJoueurs[rCode[1]][2]-1]]}else{var oDiv=document.createElement("div");oDiv.style.position="absolute",oDiv.style.left=10*iScreenScale+10+"px",oDiv.style.top=20*iScreenScale+10+"px",oDiv.style.fontSize=2*iScreenScale+"pt",oDiv.innerHTML=1<nbChoices?toLanguage("Sorry, there are not enough players to begin the race...","D&eacute;sol&eacute;, il n'y a pas assez de joueurs pour commencer la course..."):toLanguage("Sorry, all your opponents have left the race...","D&eacute;sol&eacute;, tous vos adversaires ont quitt&eacute; la course..."),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),nSearch.setAttribute("href","#null"),nSearch.onclick=function(){return $mkScreen.removeChild(oTable),$mkScreen.removeChild(oDiv),removeMenuMusic(),removeGameMusics(),formulaire.screenscale.disabled=!1,formulaire.quality.disabled=!1,formulaire.music.disabled=!1,formulaire.sfx.disabled=!1,chatting=!1,searchCourse(),!1},oDiv.appendChild(nSearch),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Back to Mario Kart PC","Retour  Mario Kart PC"),nSearch.setAttribute("href","index.php"),oDiv.appendChild(nSearch),$mkScreen.appendChild(oDiv),choixJoueurs.length<=1&&(chatting=!1),clearInterval(startMusicHandler)}}else iDeco();return!0}return!1}function playerIsSelecter(){for(var e,t=0;t<choixJoueurs.length;t++)if(choixJoueurs[t][0]==shareLink.player){e=choixJoueurs[t];break}return(e=e||choixJoueurs[0])[0]==identifiant}function proceedOnlineRaceSelection(e){var t=e[4],e=aAvailableMaps[choixJoueurs[e[1]][2]-1];t.manualTeams?selectOnlineTeams(e,choixJoueurs,playerIsSelecter()):resetGame(e)}function waitForChoice(){xhr("getMap.php","BB"==course?"battle":"",refreshTab)}xhr("chooseMap.php","joueur="+strPlayer+"&map="+map+("BB"==course?"&battle":"")+(rand?"&rand":""),refreshTab),oTable.appendChild(oTBody),$mkScreen.appendChild(oTable),document.getElementById("waitrace").style.visibility="hidden",updateMenuMusic(1),formulaire.screenscale.disabled=!0,formulaire.quality.disabled=!0,formulaire.music.disabled=!0,formulaire.sfx.disabled=!0,bMusic&&(startMusicHandler=setInterval(function(){oMapImg&&(loadMapMusic(),clearInterval(startMusicHandler))},500))}function selectOnlineTeams(l,e,t){var h=document.createElement("div"),n=h.style;n.width=iWidth*iScreenScale+"px",n.height=iHeight*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black";n=toTitle(toLanguage("Team selection","Slection des quipes"),.5);n.style.fontSize=Math.round(7*iScreenScale)+"px",h.appendChild(n);var s=document.createElement("div");s.style.display="none",s.style.position="absolute",s.style.zIndex=5e4,s.style.left=iScreenScale+"px",s.style.top=10*iScreenScale+"px",s.style.width=(iWidth-2)*iScreenScale+"px",s.style.height=iScreenScale*(iHeight-10)+"px",s.style.overflowY="auto",s.style.textAlign="center";var y=document.createElement("table");y.style.marginLeft="auto",y.style.marginRight="auto",y.style.fontSize=Math.round(2.4*iScreenScale)+"px";var c=document.createElement("div");c.style.zIndex=50002,c.style.display="none",c.style.position="absolute",c.style.right=3*iScreenScale+"px",c.style.bottom=5*iScreenScale+"px";n=document.createElement("input");n.type="button",n.style.display="block",n.style.marginTop=Math.round(iScreenScale/2)+"px",n.value=toLanguage("No teams","Chacun pour soi"),n.style.fontSize=2*iScreenScale+"px",n.style.width=18*iScreenScale+"px",n.style.textAlign="center",n.onclick=function(){a(toLanguage("No teams?","Jouer sans quipes ?"),toLanguage("Please confirm that you want to play without teams","Confirmez que vous souhaitez jouer en mode <em>chacun pour soi</em>."),function(){clearTimeout(d);var e="noteams";isBattle&&(e+="&battle"),isSingle&&(e+="&single"),r(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return o(t),!0})})},c.appendChild(n);n=document.createElement("input");function a(e,t,n){var a=document.createElement("div");a.id="online-teams-confirm",a.style.position="absolute",a.style.left=0,a.style.top=0,a.style.width=iWidth*iScreenScale+"px",a.style.height=iHeight*iScreenScale+"px",a.style.backgroundColor="rgba(0,0,0, 0.5)",a.style.zIndex=6e4;var o=document.createElement("div");o.style.position="absolute",o.style.zIndex=6e4,o.style.left=Math.round(iScreenScale*iWidth/2)+"px",o.style.top=Math.round(iScreenScale*iHeight/2)+"px",o.style.width=40*iScreenScale+"px",o.style.transform=o.style.WebkitTransform=o.style.MozTransform="translate(-50%, -50%)",o.style.backgroundColor="gray",o.style.border="solid 1px silver",o.onclick=function(e){e.stopPropagation()};var i=document.createElement("div");i.style.marginTop=iScreenScale+"px",i.style.marginBottom=Math.round(iScreenScale/2)+"px",i.style.fontSize=Math.round(2.5*iScreenScale)+"px",i.style.textAlign="center",i.style.marginLeft=2*iScreenScale+"px",i.style.marginRight=2*iScreenScale+"px",i.style.color="#FE9",i.innerHTML=e,o.appendChild(i);i=document.createElement("div");i.style.marginBottom=iScreenScale+"px",i.style.textAlign="center",i.style.marginLeft=Math.round(1.5*iScreenScale)+"px",i.style.marginRight=Math.round(1.5*iScreenScale)+"px",i.style.fontSize=Math.round(1.8*iScreenScale)+"px",i.style.color="white",i.innerHTML=t,o.appendChild(i);t=document.createElement("div");t.style.textAlign="center",t.style.marginBottom=iScreenScale+"px";var r=document.createElement("input");r.type="button",r.style.marginRight=Math.round(iScreenScale/2)+"px",r.value="Ok",r.style.fontSize=Math.round(2*iScreenScale)+"px",r.onclick=function(){return h.removeChild(a),n(),!1},t.appendChild(r);i=document.createElement("input");return i.type="button",i.value=toLanguage("Cancel","Annuler"),i.style.marginLeft=Math.round(iScreenScale/2)+"px",i.style.fontSize=Math.round(2*iScreenScale)+"px",i.onclick=a.onclick=function(){return h.removeChild(a),!1},t.appendChild(i),o.appendChild(t),a.appendChild(o),h.appendChild(a),setTimeout(function(){r.focus()},1),a}function g(e){y.innerHTML="";for(var t=Math.max(f[0].length,f[1].length),n=0;n<t;n++){for(var a=document.createElement("tr"),o=0;o<2;o++){var i,r=document.createElement("td"),l=f[o][n];l?(selectedTeams?(r.style.backgroundColor=o?"#fba":"#abf",r.style.color=o?"red":"blue"):(r.style.backgroundColor="#ccc",r.style.color="#222"),r.style.position="relative",r.style.textAlign="center",r.style.userSelect="none",(i=document.createElement("span")).style.display="block",i.style.top="1px",i.style.position="relative",i.innerHTML=l[5],i.style.whiteSpace="nowrap",i.style.textOverflow="ellipsis",i.style.overflow="hidden",i.style.width=16*iScreenScale+"px",r.appendChild(i),e&&((i=document.createElement("span")).innerHTML=o?"":"",i.style.position="absolute",o?(i.style.left="0px",r.style.paddingLeft=3*iScreenScale+"px",r.style.paddingRight=iScreenScale+"px"):(i.style.right="0px",r.style.paddingRight=3*iScreenScale+"px",r.style.paddingLeft=iScreenScale+"px"),i.style.top="48%",i.style.color="#F80",i.style.padding=Math.round(iScreenScale/2)+"px",i.style.transform=i.style.WebkitTransform=i.style.MozTransform="translateY(-50%)",i.style.cursor="pointer",i.style.opacity=.9,i.onmouseover=function(){this.style.opacity=.45},i.onmouseout=function(){this.style.opacity=.9},i.dataset||(i.dataset={}),i.dataset.i=n,i.dataset.j=o,i.onclick=p,r.appendChild(i))):(r.innerHTML="&nbsp;",r.style.width=20*iScreenScale+"px"),a.appendChild(r)}y.appendChild(a)}f[0].length&&f[1].length?(m.style.opacity=1,m.disabled=!1,m.style.cursor=""):(m.style.opacity=.4,m.disabled=!0,m.style.cursor="not-allowed")}function p(){var p=document.createElement("div");p.style.position="absolute",p.style.left="0px",p.style.top="0px",p.style.width=iScreenScale*iWidth+"px",p.style.height=iScreenScale*iWidth+"px",p.style.zIndex=5e4,h.appendChild(p);var u=+this.dataset.i,d=+this.dataset.j,e=f[d][u];f[d].splice(u,1),f[1-d].splice(Math.min(u,f[1-d].length),0,e);var m=this.parentNode;m.style.backgroundColor="#ccc",function e(t,n,a){var o=t;if(n<(t+=a))h.removeChild(p),g(!0);else{m.style.left=Math.round(20*iScreenScale*t/n*(d?-1:1))+"px";var i=n/2;o<i&&i<=t&&(m.style.backgroundColor=d?"#abf":"#fba",m.style.color=d?"blue":"red");for(var r=y.getElementsByTagName("tr"),l=0;l<2;l++)for(var s=l==d,c=s?u+1:u;c<r.length;c++)r[c].getElementsByTagName("td")[l].style.top=Math.round(3*iScreenScale*t/n*(s?-1:1))+"px";S=setTimeout(function(){e(t,n,a)},a)}}(0,150,20)}function o(e){tnCourse=(new Date).getTime()+e.time;for(var t=e.teams,n={},a=0;a<2;a++)for(var o=0;o<f[a].length;o++)n[f[a][o][0]]=f[a][o];for(a=0;a<t.length;a++)n[t[a].id][6]=t[a].team;for(a=0;a<strPlayer.length;a++)aTeams[a]=n[identifiant][6];for(a=0;a<aPlayers.length;a++){var i=aIDs[a],r=a+strPlayer.length;aTeams[r]=n[i][6]}if(selectedTeams=-1==aTeams.indexOf(-1),f[0].length=0,f[1].length=0,selectedTeams)for(a=0;a<t.length;a++)f[t[a].team].push(n[t[a].id]);else for(a=0;a<t.length;a++)f[a%2].push(n[t[a].id]);g(!1),s.removeChild(m),h.removeChild(c);e=document.createElement("div");e.style.textAlign="center",e.style.fontSize=3*iScreenScale+"px",e.style.marginTop=iScreenScale+"px",e.style.color="#DFC",e.innerHTML=selectedTeams?toLanguage("Teams have been selected !","Les quipes ont t slectionnes !"):toLanguage("Mode &quot;no teams&quot; selected. In this game, you're playing for yourself!","Mode &quot;Chacun pour soi&quot; slectionn. Cette partie se droulera sans quipes"),s.appendChild(e),s.style.display="block";e=tnCourse-(new Date).getTime();setTimeout(function(){h.innerHTML="",oContainers[0].removeChild(h),resetGame(l)},Math.min(2e3,e-1e3))}function i(){oContainers[0].removeChild(h),h.innerHTML="";var e=document.createElement("div");e.style.position="absolute",e.style.left=10*iScreenScale+10+"px",e.style.top=15*iScreenScale+10+"px",e.style.fontSize=2*iScreenScale+"pt",e.innerHTML=toLanguage("The game has been cancelled by the teams selector.","Partie annule par le slectionneur des quipes."),e.appendChild(document.createElement("br"));var t=document.createElement("a");t.style.color="white",t.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),t.setAttribute("href","#null"),t.onclick=function(){return $mkScreen.removeChild(e),removeMenuMusic(),removeGameMusics(),formulaire.screenscale.disabled=!1,formulaire.quality.disabled=!1,formulaire.music.disabled=!1,formulaire.sfx.disabled=!1,chatting=!1,searchCourse(),!1},e.appendChild(t),e.appendChild(document.createElement("br")),(t=document.createElement("a")).style.color="white",t.innerHTML=toLanguage("Back to Mario Kart PC","Retour  Mario Kart PC"),t.setAttribute("href","index.php"),e.appendChild(t),$mkScreen.appendChild(e),clearInterval(startMusicHandler)}function r(){s.style.display="none",c.style.display="none";var e=document.getElementById("online-teams-confirm");e&&h.removeChild(e),document.getElementById("waitteam").style.visibility="hidden"}n.type="button",n.style.display="block",n.style.marginTop=Math.round(iScreenScale/2)+"px",n.value=toLanguage("Cancel game","Annuler la partie"),n.style.fontSize=2*iScreenScale+"px",n.style.width=18*iScreenScale+"px",n.style.color="#F60",n.style.textAlign="center",n.onclick=function(){a(toLanguage("Cancel game?","Annuler la partie ?"),toLanguage("Caution, you're about to cancel the game <strong style=\"color:#FEB\">for all players</strong>. Use this option if you're waiting for more players for example.",'Attention, vous tes sur le point d\'annuler la partie <strong style="color:#FEB">pour tous les joueurs</strong>. Utilisez cette option si vous attendez plus de joueurs par exemple.'),function(){clearTimeout(d);var e="cancel";isBattle&&(e+="&battle"),r(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;try{JSON.parse(e)}catch(e){return!1}return i(),!0})})},c.appendChild(n),h.appendChild(c);for(var f=[[],[]],u=0;u<e.length;u++)f[e[u][6]].push(e[u]);var d,S,m=document.createElement("input");m.type="button",m.style.fontSize=3*iScreenScale+"px",m.style.marginTop=iScreenScale+"px",m.value=toLanguage("Validate","Valider"),m.onclick=function(){clearTimeout(d);for(var e="",t=0,n=0;n<2;n++)for(var a=0;a<f[n].length;a++)t&&(e+="&"),e+="j"+f[n][a][0]+"="+n,t++;isBattle&&(e+="&battle"),isSingle&&(e+="&single"),r(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return o(t),!0})},s.appendChild(y),s.appendChild(m),h.appendChild(s);var v=(new Date).getTime(),b=tnCourse-v-2e3;if(t)document.getElementById("teamcountdown").innerHTML=Math.round(b/1e3),setSRest("team"),document.getElementById("waitteam").style.visibility="visible",dRest("team"),d=setTimeout(function(){clearTimeout(S);var e="";isBattle&&(e="battle"),r(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return o(t),!0})},1e3*document.getElementById("teamcountdown").innerHTML),g(!0),s.style.display="block",c.style.display="block";else{h.style.visibility="hidden";var M=document.createElement("div");M.style.position="absolute",M.style.left=6*iScreenScale+"px",M.style.top=12*iScreenScale+"px",M.style.fontSize=Math.round(2.5*iScreenScale)+"px",M.style.color="#DFC",M.innerHTML=language?"Teams are being selected... Please don't exit game":"Les quipes sont cours de slection... Ne pas quitter la partie.",h.appendChild(M);var x=41,C=document.createElement("div");C.style.position="absolute",C.style.left="0px",C.style.top=19*iScreenScale+"px",C.style.width=iScreenScale*x*2+"px",C.style.height=Math.round(8.5*iScreenScale)+"px",C.style.overflow="hidden";for(u=0;u<x;u++){var P=document.createElement("img");P.src="images/cLoading.png",P.className="pixelated",P.style.width=2*iScreenScale+"px",P.style.position="absolute",P.style.left=u*iScreenScale*2+"px",P.style.top="0px",P.style.opacity=.5,C.appendChild(P)}h.appendChild(C);var k=0;function w(){xhr("getTeams.php","",function(e){if(h.style.visibility="",!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}switch(t.state){case"selecting_teams":!function(){for(var e=C.getElementsByTagName("img"),t=(new Date).getTime(),n=Math.round(x*Math.min((t-v)/b,1));k<n;)e[k].style.opacity=1,k++}(),setTimeout(w,1e3);break;case"teams_selected":h.removeChild(M),h.removeChild(C),o(t);break;default:h.removeChild(M),h.removeChild(C),i()}return!0})}w()}oContainers[0].appendChild(h)}function iDeco(){var e=document.createElement("div");e.style.position="absolute",e.style.left=15*iScreenScale+"px",e.style.top=8*iScreenScale+"px",e.style.width=50*iScreenScale+"px",e.style.height=15*iScreenScale+"px",e.style.fontSize=3*iScreenScale+"px",e.style.backgroundColor="gray",e.style.color="white",e.style.border="solid 1px silver",e.style.fontWeight="bold",e.style.textAlign="center",e.style.paddingTop=5*iScreenScale+"px",e.style.zIndex=2e4,e.innerHTML=toLanguage("You have been disconnected","Vous avez &eacute;t&eacute; d&eacute;connect&eacute;");for(var t=0;t<2;t++)e.appendChild(document.createElement("br"));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=3*iScreenScale+"px",n.onclick=function(){location.reload()},e.appendChild(n),$mkScreen.appendChild(e),chatting=!1,window.onbeforeunload=void 0}var dRestHandlers={},driftButton,$commandes,$commandes;function dRest(e){if(e=e||"race",isOnline){var t=document.getElementById(e+"countdown").innerHTML-1;if((document.getElementById(e+"countdown").innerHTML=t)&&"visible"==document.getElementById("wait"+e).style.visibility)return void(dRestHandlers[e]||(dRestHandlers[e]=setInterval(function(){dRest(e)},1e3)))}dRestHandlers[e]&&(clearTimeout(dRestHandlers[e]),delete dRestHandlers[e])}function setSRest(e){e=e||"race",isOnline&&(document.getElementById("wait"+e).style.left=2*iScreenScale+10+"px",document.getElementById("wait"+e).style.top=35*iScreenScale+10+"px",document.getElementById("wait"+e).style.minWidth=iScreenScale*(iWidth-4)+"px",document.getElementById("wait"+e).style.fontSize=3*iScreenScale+"px")}function connexion(){var t,n=document.createElement("div"),e=n.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",n.appendChild(toTitle(toLanguage("Connection","Connexion"),-.5));var a=document.createElement("form");a.style.position="absolute",a.style.left=16*iScreenScale+"px",a.style.top=10*iScreenScale+"px",a.onsubmit=function(){return p.style.visibility="hidden",t.disabled=!0,xhr("testcode.php","pseudo="+s.value+"&code="+c.value,function(e){if(!e||isNaN(e))return!1;e=+e;return e?(mId=identifiant=e,mPseudo=s.value,mCode=c.value,n.innerHTML="",oContainers[0].removeChild(n),selectPlayerScreen(0)):(p.style.visibility="visible",t.disabled=!1),!0}),!1};var o=document.createElement("table");o.border=2,o.setAttribute("cellpadding",1),o.setAttribute("cellspacing",2);var i=document.createElement("tr"),r=document.createElement("td");r.style.textAlign="right";var l=document.createElement("label");l.style.fontSize=3*iScreenScale+"px",l.setAttribute("for","iPseudo"),l.innerHTML=toLanguage(" &nbsp; &nbsp; Nick :","Pseudo :"),r.appendChild(l);var s,e=document.createElement("td");(s=document.createElement("input")).type="text",s.name="iPseudo",s.id="iPseudo",s.value=mPseudo,s.style.fontSize=3*iScreenScale+"px",s.style.backgroundColor="#FE7",e.appendChild(s),i.appendChild(r),i.appendChild(e);l=document.createElement("tr"),r=document.createElement("td");r.style.textAlign="right";e=document.createElement("label");e.style.fontSize=3*iScreenScale+"px",e.setAttribute("for","iCode"),e.innerHTML="Code :",r.appendChild(e);var c,e=document.createElement("td");(c=document.createElement("input")).type="password",c.name="iCode",c.id="iCode",c.value=mCode,c.style.fontSize=3*iScreenScale+"px",c.style.backgroundColor="#FE7",e.appendChild(c),l.appendChild(r),l.appendChild(e);r=document.createElement("tr"),e=document.createElement("td");e.setAttribute("colspan",2),e.style.textAlign="center",(t=document.createElement("input")).type="submit",t.style.fontSize=4*iScreenScale+"px",t.value=toLanguage("Submit","Valider"),e.appendChild(t),r.appendChild(e),o.appendChild(i),o.appendChild(l),o.appendChild(r),a.appendChild(o),n.appendChild(a);var p=document.createElement("div");p.style.color="red",p.style.fontSize=2*iScreenScale+"pt",p.style.position="absolute",p.style.left=21*iScreenScale+"px",p.style.top=31*iScreenScale+"px",p.innerHTML=toLanguage("Incorrect nick or password","Pseudo ou mot de passe incorrect"),p.style.visibility="hidden",n.appendChild(p);a=document.createElement("a");a.style.color="white",a.style.fontSize=2*iScreenScale+"pt",a.style.position="absolute",a.style.left=20*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.innerHTML=toLanguage("Register","Inscription"),a.setAttribute("href","inscription.php"+("BB"==course?"?battle":"")),n.appendChild(a);a=document.createElement("a");a.style.color="white",a.style.fontSize=2*iScreenScale+"pt",a.style.position="absolute",a.style.left=45*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.innerHTML=toLanguage("Ranking","Classement"),a.setAttribute("href","bestscores.php"+("BB"==course?"?battle":"")),n.appendChild(a);a=document.createElement("input");a.type="button",a.value=toLanguage("Back","Retour"),a.style.fontSize=2*iScreenScale+"px",a.style.position="absolute",a.style.left=2*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.onclick=quitter,n.appendChild(a),oContainers[0].appendChild(n),updateMenuMusic(0)}function selectFantomeScreen(ghostsData,map,otherGhostsData){var oScr=document.createElement("div"),oStyle=oScr.style;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black",oScr.appendChild(toTitle(lCircuits[map],.4));var oTable=document.createElement("table");oTable.setAttribute("border","4px"),oTable.style.borderStyle="double",oTable.style.borderColor="gray",oTable.style.height=8*iScreenScale+"px",oTable.style.position="absolute",oTable.style.left=22*iScreenScale+"px",oTable.style.top=10*iScreenScale+"px",oTable.style.width=35*iScreenScale+"px";var oGhost=document.createElement("tr"),oPersoImage=document.createElement("td");oPersoImage.style.width=5*iScreenScale+"px",oPersoImage.style.paddingRight="6px";var cDiv=document.createElement("div");cDiv.style.textAlign="center";var oDiv=document.createElement("div");oDiv.style.position="relative",oDiv.style.width=5*iScreenScale+"px",oDiv.style.height=5*iScreenScale+"px",oDiv.style.marginLeft="auto",oDiv.style.marginRight="auto",oDiv.style.overflow="hidden";var oPImg=new Image;oPImg.style.height=5*iScreenScale+"px",oPImg.style.position="absolute",oPImg.className="pixelated",ghostsData&&(oPImg.alt=ghostsData[0]),oPImg.nb=i,oPImg.style.left=-30*iScreenScale+"px",oPImg.style.top="0px",oDiv.appendChild(oPImg),cDiv.appendChild(oDiv);var oSpan=document.createElement("span");oSpan.style.display="inline-block",oSpan.style.color="white",oSpan.style.maxWidth=15*iScreenScale+"px",oSpan.style.fontSize=2*iScreenScale+"px",oSpan.style.overflow="hidden",oSpan.style.textOverflow="ellipsis",oSpan.style.whiteSpace="nowrap",cDiv.appendChild(oSpan),oPersoImage.appendChild(cDiv),oGhost.appendChild(oPersoImage);var oTimeTd=document.createElement("td");oTimeTd.style.textAlign="center";var oPersoTime=document.createElement("span");oPersoTime.style.fontSize=Math.round(5.5*iScreenScale)+"px",oPersoTime.style.color="white",oPersoTime.style.marginLeft=2*iScreenScale+"px",oTimeTd.appendChild(oPersoTime);var oPersoLapTimes=document.createElement("img"),$fancyTitle,gTimes;function writeTime(e,t,n,a,o,i){if(i=i||oPersoTime,(o=o||oPImg).src=getSpriteSrc(e),i.innerHTML=timeStr(n),oSpan.innerText=t,oSpan.title=t,oTable.style.left=Math.round((iScreenScale*iWidth+20-oTable.offsetWidth)/2)+"px",oTable.style.top=Math.round((28*iScreenScale-oTable.offsetHeight)/2)+"px",i==oPersoTime){for(var r='<small style="color:#CCF">'+toLanguage("Lap times:","Temps au tour :")+"</small>",l=0;l<a.length;l++)r+='<br /><span style="color:#CCF;display:inline-block">'+(l+1)+".</span> "+timeStr(a[l]);oPersoLapTimes.dataset.title=r}}function multiGhosts(a){oScr.innerHTML="";var e=gID-3,t=gID+4;e<0?t-=e:t>a.length&&(e-=t-a.length),e=Math.max(e,0),t=Math.min(t,a.length),(gIDs=new Array).length=t-e;for(var n=0,o=e;o<t;o++){gIDs[n]=o;var i=document.createElement("div");i.style.position="absolute",i.style.left=o==t-1?20*iScreenScale+"px":n%2*iScreenScale*40+"px",i.style.top=(1+8*Math.floor(n/2))*iScreenScale+"px",i.style.width=40*iScreenScale+"px";var r=document.createElement("table");r.setAttribute("border","2px"),r.style.marginLeft="auto",r.style.marginRight="auto",r.style.borderStyle="double",r.style.borderColor="gray",r.style.width=24*iScreenScale+"px",r.style.height=4*iScreenScale+"px";var l=document.createElement("tr"),s=document.createElement("td");s.style.width=3*iScreenScale+"px",s.style.paddingRight="5px";var c=document.createElement("div");c.style.position="relative",c.style.width=3*iScreenScale+"px",c.style.height=3*iScreenScale+"px",c.style.overflow="hidden";var p=new Image;p.style.height=3*iScreenScale+"px",p.style.position="absolute",p.className="pixelated",ghostsData&&(p.alt=ghostsData[0]),p.nb=o,p.style.left=-18*iScreenScale+"px",p.style.top="0px",c.appendChild(p),s.appendChild(c),l.appendChild(s);s=document.createElement("td");s.style.textAlign="center",s.style.fontSize=Math.round(3.5*iScreenScale)+"px",s.style.color="white",writeTime(a[gIDs[n]][1],a[gIDs[n]][2],a[gIDs[n]][3],a[gIDs[n]][4],p,s);var u=document.createElement("input");u.type="button",u.value="",u.style.fontSize=4*iScreenScale+"px",u.style.position="absolute",u.style.left=iScreenScale+"px",u.style.top=Math.round(.5*iScreenScale)+"px",function(e,t,n){u.onclick=function(){gIDs[e]--,gIDs[e]<0&&(gIDs[e]=a.length-1),writeTime(a[gIDs[e]][1],a[gIDs[e]][2],a[gIDs[e]][3],a[gIDs[e]][4],t,n)}}(n,p,s),i.appendChild(u);var d=document.createElement("input");d.type="button",d.value="",d.style.fontSize=4*iScreenScale+"px",d.style.position="absolute",d.style.left=32.5*iScreenScale+"px",d.style.top=Math.round(.5*iScreenScale)+"px",function(e,t,n){d.onclick=function(){gIDs[e]++,gIDs[e]>=a.length&&(gIDs[e]=0),writeTime(a[gIDs[e]][1],a[gIDs[e]][2],a[gIDs[e]][3],a[gIDs[e]][4],t,n)}}(n,p,s),i.appendChild(d),l.appendChild(s),r.appendChild(l),i.appendChild(r),oScr.appendChild(i),n++}e=document.createElement("input");e.type="button",e.value=toLanguage("Back","Retour"),e.style.fontSize=2*iScreenScale+"px",e.style.position="absolute",e.style.left=2*iScreenScale+"px",e.style.top=36*iScreenScale+"px",e.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),selectFantomeScreen(ghostsData,map,{times:a,id:gID})},oScr.appendChild(e),(e=document.createElement("input")).type="button",e.value=toLanguage("Let's go","Commencer"),e.style.fontSize=3*iScreenScale+"px",e.style.position="absolute",e.style.left=52*iScreenScale-10+"px",e.style.top=34*iScreenScale+"px",e.onclick=function(){seeGhost(!1)},oScr.appendChild(e)}function showGhosts(){if(gTimes.length){for(i=0;i<gTimes.length-1;i++){var e=i;for(j=i+1;j<gTimes.length;j++)gTimes[j][3]<gTimes[e][3]&&(e=j);var t=gTimes[e];gTimes[e]=gTimes[i],gTimes[i]=t}if(-1==gID)if(ghostsData)for(gID=gTimes.length-1;gID&&gTimes[gID][3]>=ghostsData[2];)gID--;else gID=0;var n=document.createElement("input");n.id="fGauche",n.type="button",n.value="",n.style.fontSize=6*iScreenScale+"px",n.style.position="absolute",n.style.left=10*iScreenScale+"px",n.style.top=Math.round(10.5*iScreenScale)+"px",n.onclick=function(){--gID<0&&(gID=gTimes.length-1),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(n);var a,n=document.createElement("input");n.id="fDroite",n.type="button",n.value="",n.style.fontSize=6*iScreenScale+"px",n.style.position="absolute",n.style.left=65*iScreenScale+"px",n.style.top=Math.round(10.5*iScreenScale)+"px",n.onclick=function(){++gID>=gTimes.length&&(gID=0),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(n),ghostsData?oScr.style.visibility="visible":oContainers[0].appendChild(oScr),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4]),OPFace&&(OPFace.style.display="none"),document.body.style.cursor="default",(OPFace7=document.createElement("input")).type="button",OPFace7.value=toLanguage("7 ghosts...","7 fantmes..."),OPFace7.style.fontSize=2*iScreenScale+"px",OPFace7.style.position="absolute",OPFace7.style.right=2*iScreenScale+"px",OPFace7.style.top=36*iScreenScale+"px",OPFace7.onmouseover=function(){a||((a=document.createElement("div")).style.position="absolute",a.style.textAlign="center",a.style.fontSize=2*iScreenScale+"px",a.style.width=30*iScreenScale+"px",a.style.right=2*iScreenScale+"px",a.style.bottom=4*iScreenScale+"px",a.style.backgroundColor="rgba(204,192,178,0.95)",a.style.padding=Math.round(iScreenScale/2)+" "+iScreenScale+"px",a.style.color="#363330",a.innerHTML=toLanguage("Play with 7 ghosts with the same level as the ghost above","Affronter 7 fantmes du mme niveau que le fantme ci-dessus"),a.style.borderBottomLeftRadius=iScreenScale+"px",a.style.borderTopRightRadius=iScreenScale+"px",oScr.appendChild(a))},OPFace7.onmouseout=function(){a&&(oScr.removeChild(a),a=null)},OPFace7.onclick=function(){a&&(oScr.removeChild(a),a=null),multiGhosts(gTimes)},oScr.appendChild(OPFace7)}else if(ghostsData){try{alert(language?"No other record for this circuit yet":"Aucun autre record pour ce circuit")}catch(e){}oScr.style.visibility="visible",gID=-1,document.body.style.cursor="default"}else{oScr.innerHTML="";try{oContainers[0].removeChild(oScr)}catch(e){}document.body.style.cursor="default",gPersos.length=0,resetGame(aAvailableMaps[map])}}function otherGhosts(){document.body.style.cursor="progress",ghostsData&&(oScr.style.visibility="hidden"),xhr("otherghosts.php","map="+(map+1),function(reponse){if(reponse){try{gTimes=eval(reponse)}catch(e){return!1}return showGhosts(),!0}return!1})}function seeGhost(replay){if(replay&&(pause=!0,fInfos.replay=!0,gSelectedPerso=strPlayer[0]),-1==gID)oScr.innerHTML="",oContainers[0].removeChild(oScr),gOverwriteRecord=1,replay?(strPlayer[0]=ghostsData[0],iRecord=ghostsData[2],iLapTimes=ghostsData[3],iTrajet=ghostsData[4]):(gPersos=[ghostsData[0]],iLapTimes=ghostsData[3],jTrajets=[ghostsData[4]]),resetGame(aAvailableMaps[map]);else{var xhrUrl,xhrData;if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.style.cursor="progress",gIDs){xhrUrl="ghostsrace.php",xhrData="";for(var i=0;i<gIDs.length;i++)i&&(xhrData+="&"),xhrData+="id"+i+"="+gTimes[gIDs[i]][0]}else xhrUrl="ghostrace.php",xhrData="id="+gTimes[gID][0];xhr(xhrUrl,xhrData,function(reponse){if(reponse){var gCourse;try{gCourse=eval(reponse)}catch(e){return!1}if(replay)strPlayer[0]=gTimes[gID][1],iRecord=gTimes[gID][3],iLapTimes=gTimes[gID][4],iTrajet=gCourse;else if(gIDs){gPersos=[];for(var i=0;i<gIDs.length;i++)gPersos.push(gTimes[gIDs[i]][1]);jTrajets=gCourse}else gPersos=[gTimes[gID][1]],iLapTimes=gTimes[gID][4],jTrajets=[gCourse];return resetGame(aAvailableMaps[map]),!0}return!1})}}oPersoLapTimes.src="images/about.png",oPersoLapTimes.style.position="relative",oPersoLapTimes.style.top=-Math.round(.5*iScreenScale)+"px",oPersoLapTimes.style.width=Math.round(2.5*iScreenScale)+"px",oPersoLapTimes.style.marginLeft=iScreenScale+"px",oPersoLapTimes.style.marginRight=2*iScreenScale+"px",oPersoLapTimes.dataset||(oPersoLapTimes.dataset={}),oTimeTd.appendChild(oPersoLapTimes),oPersoLapTimes.onmouseover=function(e){var t;$fancyTitle||(($fancyTitle=document.createElement("div")).className="ranking_activeplayertitle",$fancyTitle.innerHTML=this.dataset.title,$fancyTitle.style.position="absolute",$fancyTitle.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",$fancyTitle.style.borderRadius=iScreenScale+"px",$fancyTitle.style.zIndex=10,$fancyTitle.style.backgroundColor="rgba(60,109,165, 0.95)",$fancyTitle.style.color="white",$fancyTitle.style.fontSize=Math.round(1.8*iScreenScale)+"px",$fancyTitle.style.lineHeight=Math.round(2*iScreenScale)+"px",$fancyTitle.style.visibility="hidden",$mkScreen.appendChild($fancyTitle),t=this.getBoundingClientRect(),$fancyTitle.style.left=Math.round(t.left+(this.scrollWidth-$fancyTitle.scrollWidth)/2)+"px",$fancyTitle.style.top=t.top+this.scrollHeight+5+"px",$fancyTitle.style.visibility="visible")},oPersoLapTimes.onmouseout=function(e){$fancyTitle&&($mkScreen.removeChild($fancyTitle),$fancyTitle=void 0)},gRecord=ghostsData?ghostsData[2]:void 0;var gID=-1,gIDs;oGhost.appendChild(oTimeTd),oTable.appendChild(oGhost),oScr.appendChild(oTable);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Face with this ghost","Affronter ce fantme"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=20*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!1)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("See race","Voir la course"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=25*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!0)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Play alone","Jouer seul"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=30*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),gPersos.length=0,resetGame(aAvailableMaps[map])},oScr.appendChild(oPInput);var oPInput=document.createElement("input"),OPFace,OPFace7,OPFace;oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=36*iScreenScale+"px",oPInput.onclick=function(){-1!=gID&&ghostsData?(writeTime(ghostsData[0],ghostsData[1],ghostsData[2],ghostsData[3]),oScr.removeChild(document.getElementById("fGauche")),oScr.removeChild(document.getElementById("fDroite")),oScr.removeChild(OPFace7),OPFace.style.display="",gID=-1):(oScr.innerHTML="",oContainers[0].removeChild(oScr),selectRaceScreen(map-map%4))},oScr.appendChild(oPInput),ghostsData?(OPFace=document.createElement("input"),OPFace.type="button",OPFace.value=toLanguage("Face with another player...","Affronter un autre joueur..."),OPFace.style.fontSize=2*iScreenScale+"px",OPFace.style.position="absolute",OPFace.style.right=2*iScreenScale+"px",OPFace.style.top=36*iScreenScale+"px",OPFace.onclick=otherGhosts,oScr.appendChild(OPFace),oContainers[0].appendChild(oScr),ghostsData&&writeTime(ghostsData[0],ghostsData[1],ghostsData[2],ghostsData[3]),document.body.style.cursor="default",otherGhostsData&&(gID=otherGhostsData.id,gTimes=otherGhostsData.times,showGhosts())):otherGhosts(),updateMenuMusic(1)}function stripSpecialChars(e){return e.replace(/&[#\w]+;/g,"_")}function mapNameOf(e,t){var n=lCircuits[t],a=document.createElement("div"),t=isCup?Math.min(Math.max(9/Math.sqrt(stripSpecialChars(n).length),1.4),4):2.1;return a.style.fontSize=Math.round(e*t)+"px",a.style.width=26*e+"px",a.style.bottom=-Math.round(e/2)+"px",a.className="mapname",a.style.textAlign="center",a.innerHTML=n,a}function addOption(e,t,n,a,o,i){document.getElementById(e).innerHTML=t.replace(/ /g,"&nbsp;"),document.getElementById(n).innerHTML="";var r,l=document.createElement("select");l.name=a;for(var s=0;s<o.length;s++){var c=document.createElement("option"),p=o[s][0];c.value=p,c.innerHTML=o[s][1],p==i&&(r=s),l.appendChild(c)}l.selectedIndex=r,document.getElementById(n).appendChild(l)}function optionOf(e){return formulaire?+formulaire.elements[e].value:baseOptions[e]}function displayCommands(e){var t,n=document.getElementById("commandes");n&&(t=!e,n.innerHTML=(e||"")+'<img src="images/edit-controls.png" alt="Edit" id="commandes-edit"'+(t?' class="nocommand"':"")+' title="'+toLanguage("More settings","Plus de paramtres")+'" />',document.getElementById("commandes-edit").onclick=function(){editCommands()})}function updateCommandSheet(){var n=getCommands(),a=0<=navigator.platform.toUpperCase().indexOf("MAC");function e(e,t){var n=language?"P":"J";return 1==oContainers.length?e:n+"1 : "+e+"; "+n+"2 : "+t}function t(e){var t=n[e],e=t[0];return t[1]&&a&&(e=t[1]),getKeyName(e)}displayCommands("<strong>"+toLanguage("Move","Se diriger")+"</strong> : "+e(t("up")+t("left")+t("down")+t("right"),"ESDF")+"<br /><strong>"+toLanguage("Use item","Utiliser un objet")+"</strong> : "+e(t("item"),toLanguage("A","Q"))+"<br /><strong>"+toLanguage("Item backwards","Objet en arrire")+"</strong> : "+e(t("item_back"),toLanguage("W","A"))+"<br /><strong>"+toLanguage("Jump/drift","Sauter/draper")+"</strong> : "+e(t("jump"),"G")+("BB"==course?"<br /><strong>"+toLanguage("Inflate a balloon","Gonfler un ballon")+"</strong> : "+e(t("balloon"),"R"):"")+"<br /><strong>"+toLanguage("Rear/Front view","Vue arri&egrave;re/avant")+"</strong> : "+e(t("rear"),toLanguage("W","Z"))+"<br /><strong>"+toLanguage("Pause","Mettre en pause")+"</strong> : "+t("pause")+"<br /><strong>"+toLanguage("Quit","Quitter")+"</strong> : "+t("quit"))}function editCommands(e,n){n=n||0;var t=document.getElementById("control-editor-mask");if(!t||(document.body.removeChild(t),e)){(t=document.createElement("div")).id="control-editor-mask",t.onclick=function(){editCommands()};var a=document.createElement("div");a.className="control-editor",a.onclick=function(e){e.stopPropagation()};var o=document.createElement("div");o.className="control-header";var i=document.createElement("div");i.innerHTML=toLanguage("Game settings","Paramtres du jeu"),o.appendChild(i);var r=document.createElement("button");r.className="control-close",r.innerHTML="&times;",r.onclick=function(){editCommands()},o.appendChild(r),a.appendChild(o);var l=document.createElement("div");l.className="control-tabs";for(var s=[toLanguage("Edit controls","Modifier les contrles"),toLanguage("Advanced settings","Paramtres avancs")],c=0;c<s.length;c++)!function(e){var t=document.createElement("div");e||(t.className="control-tab-active"),t.innerHTML=s[e],t.onclick=function(){document.querySelector(".control-tabs .control-tab-active").classList.remove("control-tab-active"),this.classList.add("control-tab-active"),document.querySelector(".control-window .control-window-active").classList.remove("control-window-active"),document.querySelectorAll(".control-window > div")[e].classList.add("control-window-active"),n=e},l.appendChild(t)}(c);a.appendChild(l);e=document.createElement("div");e.className="control-window";i=document.createElement("div");i.className="control-window-active";var p=[{name:toLanguage("Move forward","Avancer"),key:"up"},{name:toLanguage("Move back","Reculer"),key:"down"},{name:toLanguage("Turn left","Tourner  gauche"),key:"left"},{name:toLanguage("Turn right","Tourner  droite"),key:"right"},{name:toLanguage("Use item","Utiliser un objet"),key:"item"},{name:toLanguage("Item backwards","Objet en arrire"),key:"item_back"},{name:toLanguage("Jump/drift","Sauter/draper"),key:"jump"},{name:toLanguage("Inflate balloon","Gonfler un ballon"),key:"balloon"},{name:toLanguage("Rear view","Vue arrire"),key:"rear"},{name:toLanguage("Pause","Pause"),key:"pause"},{name:toLanguage("Quit","Quitter"),key:"quit"}],u=getCommands(),d=JSON.parse(localStorage.getItem("controls")||"{}"),m=0<=navigator.platform.toUpperCase().indexOf("MAC"),h=document.createElement("div");h.className="control-editor-grid";for(c=0;c<p.length;c++)!function(t){var e=u[t.key],n=e[0];e[1]&&m&&(n=e[1]);var a=document.createElement("div");(e=document.createElement("div")).className="control-label",e.innerHTML=t.name,a.appendChild(e),(e=document.createElement("button")).className="control-input",e.innerHTML=getKeyName(n),e.onfocus=function(){this.innerHTML="..."},e.onblur=function(){this.innerHTML=getKeyName(n)},e.onclick=function(){this.focus()},e.onkeydown=function(e){e.preventDefault(),e.stopPropagation(),n=e.keyCode,d[t.key]=n,localStorage.setItem("controls",JSON.stringify(d)),gameControls=gameControls&&getGameControls(),this.blur()},a.appendChild(e),h.appendChild(a)}(p[c]);i.appendChild(h);r=document.createElement("div");r.className="control-reset";o=document.createElement("a");o.href="#null",o.innerHTML=toLanguage("Reset controls","Rtablir les contrles par dfaut"),o.onclick=function(){return confirm(toLanguage("Reset to default controls?","Confirmer la rinitialisation des contrles ?"))&&(localStorage.removeItem("controls"),gameControls=gameControls&&getGameControls(),editCommands(!0,n)),!1},r.appendChild(o),i.appendChild(r),e.appendChild(i);var y=document.createElement("div");y.className="control-settings";i=document.createElement("div");i.className="control-settings-info",i.innerHTML=toLanguage("These settings allow you to disable some graphic elements from the game. Use them if you experience some lag for example.","Ces paramtres vous permettent de dsactiver certains lments graphiques du jeu. Utilisez-les si vous avez des problmes de lags par exemple."),y.appendChild(i);var g,f={ld:toLanguage("Don't display heavy elements (trees, decors)","Dsactiver l'affichage des lments lourds (arbres, dcors)"),nogif:toLanguage("Disable animation in gif-format tracks","Dsactiver les animations des circuits au format gif"),nomap:toLanguage("Disable mini-map display","Dsactiver l'affichage de la mini-map")},S=(S=localStorage.getItem("settings"))?JSON.parse(S):{};for(g in f)!function(e){var t=document.createElement("label"),n=document.createElement("input");n.type="checkbox",n.checked=!!S[e],t.appendChild(n);var a=document.createElement("span");a.innerHTML=f[e],t.appendChild(a),n.onclick=function(){this.checked?S[e]=1:delete S[e],localStorage.setItem("settings",JSON.stringify(S))},y.appendChild(t)}(g);(r=document.createElement("div")).className="control-reset",(o=document.createElement("a")).href="#null",o.innerHTML=toLanguage("Reset settings","Rtablir les paramtres par dfaut"),o.onclick=function(){return confirm(toLanguage("Reset settings to default?","Rinitiliser les paramtres  ceux par dfaut ?"))&&(localStorage.removeItem("settings"),editCommands(!0,n)),!1},r.appendChild(o),y.appendChild(r),e.appendChild(y),a.appendChild(e),t.appendChild(a),document.body.appendChild(t),e.style.width=e.scrollWidth+"px",e.style.height=e.scrollHeight+"px",n&&document.querySelectorAll(".control-tabs > div")[n].click()}else document.querySelector("#commandes strong")&&updateCommandSheet()}function getKeyName(e){return this.keyMatching||(this.keyMatching=["","","","Break","","","","","Backspace","Tab","","","Clear","Enter","","","Shift","Ctrl","Alt","Pause","CapsLock","Hangul","","","","Hanja","",toLanguage("Escape","chap"),"Conversion","Non-conversion","","",toLanguage("Spacebar","Espace"),"PageUp","PageDown","End","Home","&larr;","&uarr;","&rarr;","&darr;","Select","Print","Execute",toLanguage("Print Screen","ImpEcr"),"Inser",toLanguage("Delete","Suppr"),"Help","0","1","2","3","4","5","6","7","8","9",":","=","&lt;","=","","SS","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Meta","Meta","Meta","","Sleep","0","1","2","3","4","5","6","7","8","9","&times;","+",".","-",".","/","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NumLock","ScrollLock","","","","","","","","","","","","","","","^","!","","#","$","","PageDown","PageUp","Refresh",")","*","~","Home","-","Vol. down","Vol. up","Next","Previous","Stop","Play/pause","@","Mute","Vol. down","Vol. up","","","","=",",","#",".","/","%","",",","","","","","","","","","","","","","","","","","","","","","","","","","{","\\","}","'","`","Meta","AltGr","&lt;","","","","Compose","","","Forward","Back","Non-conversion","","","","","Alphanumeric","","Hiragana","Half-width","Kanji","","","","","","","Unlock Trackpad","","","","Toggle Touchpad"]),this.keyMatching[e]||"#"+e}function getCommands(){var e={up:[38],down:[40],left:[37],right:[39],item:[32],item_back:[67],jump:[17,18],balloon:[16],rear:[88],pause:[80],quit:[27],cheat:[120,33,57,105]};1<strPlayer.length&&(e.up_p2=[69],e.down_p2=[68],e.left_p2=[83],e.right_p2=[70],e.item_p2=[toLanguage(65,81)],e.item_back_p2=[toLanguage(87,65)],e.jump_p2=[71],e.balloon_p2=[82],e.rear_p2=[toLanguage(87,90)]);var t=e,n=localStorage.getItem("controls");if(n)for(var a in n=JSON.parse(n))t[a]=[n[a]];return t}function getGameControls(){var e,t={},n=getCommands();for(e in n)for(var a=0;a<n[e].length;a++){var o=n[e][a];t[o]||(t[o]=e)}return t}function findKeyCode(e){for(var t in gameControls)if(gameControls[t]==e)return t;return""}function toLanguage(e,t){return language?e:t}function toPlace(e){var t;if(language)switch(e){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th"}else t=1!=e?"e":"er";return e+"<sup>"+t+"</sup>"}function toTitle(e,t){var n=document.createElement("div");return n.style.width=iWidth*iScreenScale+"px",n.style.fontSize=Math.round(8*iScreenScale)+"px",n.style.fontWeight="normal",n.style.position="absolute",n.style.left="0px",n.style.top=Math.round(t*iScreenScale)+"px",n.style.textAlign="center",n.style.color=primaryColor,n.innerHTML=e,n.style.fontFamily="Tahoma",n}function toPerso(e){if(isCustomPerso(e))return customPersos[e].name;if(language){if("maskass"==e)return"shy guy";if("skelerex"==e)return"dry bones";if("harmonie"==e)return"rosalina";if("roi_boo"==e)return"king boo";if("frere_marto"==e)return"hammer bro";if("bowser_skelet"==e)return"dry bowser";if("flora_piranha"==e)return"petey piranha"}else if("frere_marto"==e)return"frre marto";return e=e.replace(/_/g," ")}function isMobile(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)}function isChatting(){return isOnline&&document.activeElement==document.forms[1].elements.rMessage}function applyButtonCode(e,t){for(var n=t.split(","),a=0;a<n.length;a++)document[e]({keyCode:parseInt(n[a])})}function onButtonTouch(e){return e.preventDefault(),this.style.backgroundColor="#603",navigator.vibrate(30),applyButtonCode("onkeydown",this.dataset.key),!1}function onButtonPress(e){this.style.backgroundColor="",applyButtonCode("onkeyup",this.dataset.key)}function setChat(){chatting=!0;var oChat=document.createElement("div");oChat.className="online-chat",oChat.style.position="absolute",oChat.style.zIndex=3,oChat.style.backgroundColor="black",oChat.style.right="10px",oChat.style.top="5%",oChat.style.width="350px",oChat.style.height="90%",oChat.style.border="double 4px silver";var oConnectes=document.createElement("p");oConnectes.style.paddingBottom="2px",oConnectes.style.borderBottom="solid 1px silver";var iConnectes=document.createElement("span");iConnectes.innerHTML=toLanguage("Online opponent(s) : ","Adversaire(s) en ligne : "),oConnectes.appendChild(iConnectes);var jConnectes=document.createElement("span");jConnectes.style.color="white",oConnectes.appendChild(jConnectes);var bConnectes=document.createElement("a"),oBlockDialog;function removeBlockDialog(){return oBlockDialog&&(oChat.removeChild(oBlockDialog),oBlockDialog=null,1)}bConnectes.href="#null",bConnectes.style.textDecoration="none",bConnectes.title=language?"Ignore player":"Ignorer un joueur",bConnectes.style.marginLeft="10px",bConnectes.style.opacity=.7,oConnectes.onmouseover=function(){bConnectes.style.opacity=1},oConnectes.onmouseout=function(){bConnectes.style.opacity=.7},bConnectes.style.position="relative",bConnectes.style.top="2px",bConnectes.onmouseover=function(){biConnectes.src="images/ic_block_h.png"},bConnectes.onmouseout=function(){biConnectes.src="images/ic_block.png"},bConnectes.onclick=function(){if(removeBlockDialog())return!1;oBlockDialog=document.createElement("div"),oBlockDialog.style.position="absolute",oBlockDialog.style.left="85px",oBlockDialog.style.top="8%",oBlockDialog.style.width="200px",oBlockDialog.style.border="double 4px silver",oBlockDialog.style.backgroundColor="#222";var oBlockTitle=document.createElement("h1");oBlockTitle.style.fontSize="1.1em",oBlockTitle.style.marginTop="24px",oBlockTitle.style.marginBottom="2px",oBlockTitle.style.textAlign="center",oBlockTitle.innerHTML=language?"Ignore member":"Ignorer un membre",oBlockTitle.style.color="white",oBlockTitle.style.textDecoration="underline",oBlockDialog.appendChild(oBlockTitle);var oBlockClose=document.createElement("input");oBlockClose.type="button",oBlockClose.onclick=function(){removeBlockDialog()},oBlockClose.style.position="absolute",oBlockClose.style.right="5px",oBlockClose.style.top="5px",oBlockClose.value="",oBlockDialog.appendChild(oBlockClose);var oBlockMembers=document.createElement("div");return oBlockMembers.style.margin="3px 4px",xhr("listCoursePlayers.php","",function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(e){return!1}function stylishMember(e){e.dataset.blocked?(e.style.color="red",e.style.textDecoration="line-through",e.style.opacity=.8):(e.style.color="#F90",e.style.textDecoration="",e.style.opacity=1)}for(var i=0;i<rCode.length;i++){var memberId=rCode[i][0],memberPseudo=rCode[i][1],memberBlocked=rCode[i][2],oBlockMember=document.createElement("div");oBlockMember.dataset||(oBlockMember.dataset={}),oBlockMember.dataset.id=memberId,oBlockMember.dataset.blocked=memberBlocked?"1":"",oBlockMember.innerHTML=memberPseudo,oBlockMember.style.padding="2px 5px",oBlockMember.style.cursor="pointer",oBlockMember.style.margin="1px",oBlockMember.style.backgroundColor="#666",oBlockMember.style.color=oBlockMember.dataset.blocked?"red":"#F90",oBlockMember.onmouseover=function(){this.style.backgroundColor="#777",this.style.color="#FC0"},oBlockMember.onmouseout=function(){this.style.backgroundColor="#666",this.style.color=this.dataset.blocked?"red":"#F90"},stylishMember(oBlockMember),oBlockMember.onclick=function(){this.dataset.blocked=this.dataset.blocked?"":"1";var t=this;xhr(this.dataset.blocked?"ignore.php":"unignore.php","member="+this.dataset.id,function(e){return 1==e&&(stylishMember(t),!0)})},oBlockMembers.appendChild(oBlockMember)}return!0}return!1}),oBlockDialog.appendChild(oBlockMembers),oChat.appendChild(oBlockDialog),!1};var biConnectes=document.createElement("img");biConnectes.alt="Block",biConnectes.src="images/ic_block.png",biConnectes.style.height="16px",bConnectes.appendChild(biConnectes),oConnectes.appendChild(bConnectes);var oMessages=document.createElement("div");oMessages.style.paddingTop="2px";var oRepondre=document.createElement("form");oRepondre.style.position="absolute",oRepondre.style.bottom="0",oRepondre.style.left="10px";var rP=document.createElement("p");rP.style.textAlign="center";var rMessage=document.createElement("input");rMessage.setAttribute("size",35),rMessage.type="text",rMessage.name="rMessage",rMessage.onkeydown=function(e){38==e.keyCode?this.blur():e.stopPropagation()},rMessage.onkeyup=function(e){e.stopPropagation()},rMessage.style.backgroundColor="#FE7";var rEnvoi=document.createElement("input");function refreshChat(){chatting?xhr("chat.php","",function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(e){return!1}if(-1!=rCode){for(var noms=rCode[0],sNoms="",i=0;i<noms.length;i++)sNoms+=(i?", ":"")+noms[i];jConnectes.innerHTML=sNoms;for(var messages=rCode[1],pMessages=oMessages.getElementsByTagName("p");pMessages.length;)oMessages.removeChild(pMessages[0]);for(var i=0;i<messages.length;i++){var oP=document.createElement("p"),sPseudo=document.createElement("span");sPseudo.innerHTML=messages[i][0]+" : ",oP.appendChild(sPseudo);var sMessage=document.createElement("span");sMessage.style.color="white",sMessage.style.fontWeight="normal",sMessage.innerHTML=messages[i][1],oP.appendChild(sMessage),oMessages.appendChild(oP)}setTimeout(refreshChat,1e3)}else chatting=!1;return!0}return!1}):document.body.removeChild(oChat)}rEnvoi.type="submit",rEnvoi.value=toLanguage("Send","Envoyer"),rP.appendChild(rMessage),rP.appendChild(rEnvoi),oRepondre.onsubmit=function(){return rMessage.value&&(xhr("parler.php","msg="+encodeURIComponent(rMessage.value).replace(/\+/g,"%2B"),function(e){return"1"==e}),rMessage.value=""),!1},oRepondre.appendChild(rP),oChat.appendChild(oConnectes),oChat.appendChild(oMessages),oChat.appendChild(oRepondre),refreshChat(),document.body.appendChild(oChat)}formulaire=document.forms.modes,pause?(formulaire.screenscale.disabled=!1,formulaire.quality.disabled=!1,formulaire.music.disabled=!1,formulaire.sfx.disabled=!1,isSingle&&!isOnline?choose(1):null!=fInfos.map?loadMap(fInfos.map):"VS"==course?selectMapScreen():"BB"==course?isCup?selectRaceScreen(NBCIRCUITS):selectMapScreen():fInfos.player&&selectMapScreen()):(addOption("pQuality",toLanguage("Quality","Qualit&eacute;"),"vQuality","quality",[[5,toLanguage("Pixelated","Pixelis")],[4,toLanguage("Low","Inf&eacute;rieure")],[2,toLanguage("Medium","Moyenne")],[1,toLanguage("High","Sup&eacute;rieure")]],iRendering),addOption("pSize",toLanguage("Screen Size","Taille de l'&eacute;cran"),"vSize","screenscale",[[4,toLanguage("Very small","Tr&egrave;s petite")],[6,toLanguage("Small","Petite")],[8,toLanguage("Medium","Moyenne")],[10,toLanguage("Large","Large")],[12,toLanguage("Very large","Tr&egrave;s large")],[-1,toLanguage("Full (F11)","Plein (F11)")]],+$mkScreen.dataset.lastsc||iScreenScale),addOption("pMusic",toLanguage("Music","Musique"),"vMusic","music",[[0,toLanguage("Off","D&eacute;sactiv&eacute;e")],[1,toLanguage("On","Activ&eacute;e")]],bMusic),addOption("pSfx",toLanguage("Sound effects","Bruitages"),"vSfx","sfx",[[0,toLanguage("Off","D&eacute;sactiv&eacute;s")],[1,toLanguage("On","Activ&eacute;s")]],iSfx),selectMainPage(),window.turnEvents||(isMobile()&&(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||function(){},addButton(' <span style="position:absolute;left:8px;top:-5px"></span><span style="position:absolute;right:6px;bottom:8px;font-size:10px;text-align:right">'+(language?"+ Jump<br/>Drift":"+ Saut<br/>Drapage")+"</span>",[38,17],0,0),addButton("  ",38,1,0),addButton("Obj",32,2,0,null,null,25),addButton("",80,3,0,null,null,25),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),driftButton=addButton(language?"Jump<br/>Drift":"Saut<br/>Drapage",17,0,1,null,null,11),addButton("  ",40,1,1),addButton("  ",37,2,1),addButton("  ",39,3,1),reposKeyboard(),document.getElementById("virtualkeyboard").ontouchstart=function(e){return e.preventDefault(),!1},document.getElementById("virtualkeyboard").style.display="block",$commandes=document.getElementById("commandes"),$commandes&&($commandes.style.display="none")),window.turnEvents=!0),formulaire.quality.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setQuality(e)},formulaire.screenscale.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setScreenScale(e)},formulaire.music.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setMusic(e)},formulaire.sfx.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setSfx(e)},window.fsevent||(window.fsevent=function(e){if(122==e.keyCode){e.preventDefault();e=iScreenScale;return iScreenScale=+formulaire.screenscale.value,formulaire.screenscale.value=-1,formulaire.screenscale.onchange(),formulaire.screenscale.disabled&&(iScreenScale=e),!1}},window.addEventListener("keydown",window.fsevent)),"undefined"==typeof course&&(course=""),$commandes=document.getElementById("commandes"),$commandes&&$commandes.innerHTML.length<10&&displayCommands(),isFirstLoad&&(isFirstLoad=!1,hasChallenges()&&xhr("getClSelected.php",null,function(e){if(!e)return!0;try{e=JSON.parse(e)}catch(e){return!0}if(e.id)for(var t in challenges)for(var n in challenges[t])for(var a=challenges[t][n].list,o=0;o<a.length;o++){var i=a[o];if(i.id==e.id)return clSelected||i.succeeded||((clSelected=i).trackType=t,clSelected.trackId=n,clSelected.autoset=e.autoset,localStorage.removeItem("itemset."+getItemMode()),course||!clSelected.autoset.course||(i=oContainers[0].childNodes[0])&&(i.innerHTML="",oContainers[0].removeChild(i),course=clSelected.autoset.course,selectPlayerScreen(0)),showClSelectedPopup()),!0}return!0}))),window.MarioKartControl={setQuality:function(e){setQuality(e)},setScreenScale:function(e){setScreenScale(e)},setMusic:function(e){setMusic(e)},setSfx:function(e){setSfx(e)}}}void 0===selectedTeams&&(selectedTeams=0),void 0===challenges&&(challenges={mcup:[],cup:[],track:[]},clRewards=[]),void 0===cupNames&&(cupNames=[]);var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);